

# ğŸ§° Atelier 1 â€“ Explorer et comprendre le contenu de `/boot`

## ğŸ”– Informations gÃ©nÃ©rales

- **Niveau** : intermÃ©diaire

- **SystÃ¨me ciblÃ©** : Debian 12 / Debian 13 uniquement

- **Objectif global** : explorer le rÃ©pertoire `/boot`, comprendre ses composants, et apprendre Ã  prÃ©venir ou rÃ©parer les pannes liÃ©es au dÃ©marrage.

- **PrÃ©requis** :
  
  - Machine Debian avec `sudo`.
  
  - Aucun autre systÃ¨me requis.

## 1ï¸âƒ£ Contexte & objectif

Sur Debian, `/boot` contient les fichiers critiques nÃ©cessaires avant le montage de la racine `/`.  
Le moindre incident (UUID, espace plein, noyau manquant, grub.cfg corrompu) peut rendre le systÃ¨me **inaccessible au dÃ©marrage**.

> ğŸ¯ Ã€ la fin de cet atelier, vous saurez :
> 
> - Identifier les fichiers essentiels (`vmlinuz`, `initrd`, `grub.cfg`).
> 
> - Comprendre le rÃ´le de `/boot` dans la chaÃ®ne BIOS/UEFI â†’ GRUB â†’ noyau.
> 
> - Sauvegarder, vÃ©rifier et dÃ©panner `/boot` en toute sÃ©curitÃ©.

---

## 2ï¸âƒ£ Sauvegarde prÃ©ventive avant exploration

```bash
sudo mkdir -p /root/boot_backup_$(date +%F)
sudo cp -a /boot/* /root/boot_backup_$(date +%F)/
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ” **Pourquoi faire cette sauvegarde ?**  
  Avant toute manipulation dans `/boot`, on crÃ©e une **copie de secours**. Si vous supprimez ou modifiez un fichier critique par erreur, vous pourrez revenir en arriÃ¨re.

- ğŸ“… **Utilisation de `$(date +%F)`**  
  La commande insÃ¨re automatiquement la **date du jour** (format `YYYY-MM-DD`) dans le nom du dossier. Cela vous permet de garder plusieurs sauvegardes horodatÃ©es.

- ğŸ“ **Option `-a` de `cp`**  
  `cp -a` copie **en prÃ©servant les permissions, liens, timestamps**â€¦ indispensable pour un contenu systÃ¨me comme `/boot`.

- ğŸ§¹ **Bon rÃ©flexe dâ€™admin**  
  Faites cette sauvegarde **avant une mise Ã  jour de noyau** importante, ou avant un atelier pÃ©dagogique oÃ¹ vous allez manipuler GRUB.

---

âœ… Vous pouvez restaurer avec :

```bash
sudo cp -a /root/boot_backup_YYYY-MM-DD/* /boot/
sudo update-grub
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ¯ **Remplacer `YYYY-MM-DD`**  
  Remplacez par la date exacte de votre sauvegarde (visible avec `ls /root/boot_backup_*`), sinon la commande Ã©chouera.

- ğŸ” **Restauration complÃ¨te du contenu**  
  La commande recopie tous les fichiers sauvegardÃ©s **par-dessus** le contenu actuel de `/boot`. Câ€™est une restauration â€œbruteâ€.

- ğŸ”„ **Pourquoi `sudo update-grub` aprÃ¨s ?**  
  MÃªme si les fichiers sont restaurÃ©s, il est prudent de demander Ã  Debian de **regÃ©nÃ©rer la configuration GRUB** pour sâ€™assurer que tous les chemins et noyaux sont bien pris en compte.

- âš ï¸ **Attention Ã  la version du noyau**  
  Si vous avez installÃ© ou supprimÃ© des noyaux entre temps, la restauration peut ramener un Ã©tat **plus ancien**. VÃ©rifiez toujours avec `uname -r` aprÃ¨s redÃ©marrage.

---

## 3ï¸âƒ£ Exploration et comprÃ©hension du contenu

### ğŸ§© Exercice 1 â€“ Lister le contenu

```bash
ls -lh /boot
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ” **Objectif de cette commande**  
  Voir rapidement **ce qui se trouve dans `/boot`**, avec la taille et la date de modification de chaque fichier.

- ğŸ“ **Option `-lh`**  
  `-l` = format dÃ©taillÃ© (permissions, propriÃ©taire, taille, date).  
  `-h` = taille â€œhumaineâ€ (Ko, Mo, Go) au lieu de bytes.

- ğŸ‘€ **Ce quâ€™il faut observer**
  
  - La prÃ©sence de fichiers comme `vmlinuz-*`, `initrd.img-*`, `config-*`, `System.map-*`.
  
  - La taille de chaque noyau : plusieurs vieux noyaux peuvent **saturer la partition `/boot`**.

- ğŸ§  **RÃ©flexe pÃ©dagogique**  
  Notez la diffÃ©rence entre **fichiers** (noyau, initrd, etc.) et **rÃ©pertoires** (`grub/`, Ã©ventuellement `efi/`).

| Fichier        | RÃ´le                                  |
| -------------- | ------------------------------------- |
| `vmlinuz-*`    | noyau Linux compressÃ©                 |
| `initrd.img-*` | image initramfs pour monter `/`       |
| `config-*`     | configuration de compilation du noyau |
| `System.map-*` | symboles mÃ©moire du noyau             |
| `grub/`        | rÃ©pertoire du chargeur GRUB           |

---

### ğŸ§© Exercice 2 â€“ Identifier le noyau actif

```bash
uname -r
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ¯ **But**  
  Savoir **quel noyau est rÃ©ellement utilisÃ© en ce moment** par le systÃ¨me, pas seulement ce qui est prÃ©sent dans `/boot`.

- ğŸ” **Lien avec `/boot`**  
  Comparez le rÃ©sultat de `uname -r` avec les noms de fichiers `vmlinuz-*` et `initrd.img-*` listÃ©s dans `/boot` pour identifier le **couple noyau/initrd actif**.

- ğŸ§ª **Cas pÃ©dagogique**  
  AprÃ¨s une mise Ã  jour noyau, si vous redÃ©marrez, refaites `uname -r` pour vÃ©rifier que vous bootez bien sur la **nouvelle version**.

- ğŸ› ï¸ **DÃ©pannage**  
  En cas de problÃ¨me de dÃ©marrage, savoir â€œquel noyau fonctionnait avantâ€ est prÃ©cieux pour revenir Ã  une version stable.

---

### ğŸ§© Exercice 3 â€“ Examiner GRUB

```bash
sudo grep "menuentry" /boot/grub/grub.cfg
sudo less /boot/grub/grub.cfg
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ” **`grep "menuentry"`**  
  Permet de lister rapidement les **entrÃ©es de menu** GRUB (Linux, mode de secours, autres OSâ€¦). IdÃ©al pour un premier aperÃ§u.

- ğŸ“– **`less /boot/grub/grub.cfg`**  
  `less` est un **pager** : vous pouvez faire `/mot` pour rechercher, `q` pour quitter. TrÃ¨s pratique pour analyser un fichier long.

- âš ï¸ **Ne pas Ã©diter ce fichier Ã  la main**  
  `grub.cfg` est **gÃ©nÃ©rÃ© automatiquement** par `update-grub` Ã  partir de scripts dans `/etc/grub.d` et `/etc/default/grub`. On lâ€™observe, mais on ne le modifie pas directement.

- ğŸ§© **RepÃ¨res Ã  chercher**
  
  - Les chemins vers les fichiers `vmlinuz-â€¦` et `initrd.img-â€¦`.
  
  - Les UUID de partitions, utiles pour diagnostiquer un problÃ¨me de disque ou de partition.

---

### ğŸ§© Exercice 4 â€“ VÃ©rifier le mode de dÃ©marrage

```bash
[ -d /sys/firmware/efi ] && echo "UEFI mode" || echo "Legacy BIOS mode"
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ¯ **But de la commande**  
  Savoir si votre machine dÃ©marre en **UEFI** ou en **BIOS Legacy**, ce qui va influencer la maniÃ¨re de rÃ©parer ou rÃ©installer GRUB.

- ğŸ§  **Principe**  
  Sous Linux, la prÃ©sence du rÃ©pertoire `/sys/firmware/efi` indique un **dÃ©marrage UEFI**. Sinon, on est en mode BIOS classique.

- ğŸ” **Impact pratique**
  
  - En UEFI, il existe souvent une partition spÃ©ciale **EFI System Partition (ESP)**, gÃ©nÃ©ralement montÃ©e sur `/boot/efi`.
  
  - En BIOS, GRUB est installÃ© dans le **MBR** ou le secteur de boot du disque.

- ğŸ§ª **Conseil pÃ©dagogique**  
  Notez le mode (UEFI / Legacy) dans vos comptes-rendus dâ€™atelier, car les **procÃ©dures de dÃ©pannage** ne sont pas exactement les mÃªmes.

---

### ğŸ§© Exercice 5 â€“ Analyser le type de table de partitions

```bash
sudo parted -l | grep "Partition Table"
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ¯ **But**  
  Identifier si le disque utilise une table de partitions **MBR (msdos)** ou **GPT**.

- ğŸ§© **Lien avec `/boot` et GRUB**
  
  - Sur un disque GPT avec BIOS ancien, il faut parfois une petite partition spÃ©ciale â€œbios_grubâ€.
  
  - Certaines configurations UEFI + GPT + Secure Boot imposent des contraintes spÃ©cifiques.

- ğŸ“š **Lecture du rÃ©sultat**  
  Vous verrez une ligne du type : `Partition Table: gpt` ou `Partition Table: msdos`.

- ğŸ§  **Bonne habitude**  
  Toujours connaÃ®tre le type de table de partitions avant de faire des modifications profondes (redimensionnement, ajout de partition `/boot` sÃ©parÃ©e, etc.).

---

### ğŸ§© Exercice 6 â€“ VÃ©rifier lâ€™espace disponible

```bash
df -h /boot
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ¯ **But**  
  VÃ©rifier si la partition `/boot` nâ€™est pas **pleine** ou presque pleine, ce qui peut empÃªcher lâ€™installation de nouveaux noyaux.

- ğŸ“ **`-h` = human-readable**  
  Affiche lâ€™espace total, utilisÃ©, et disponible en unitÃ©s lisibles (M, G).

- âš ï¸ **SymptÃ´me classique**  
  Si `/boot` est plein, les commandes de mise Ã  jour (`apt upgrade`) peuvent Ã©chouer avec des messages du type â€œno space left on deviceâ€ lors de lâ€™installation dâ€™un nouveau noyau.

- âœ… **Bonne pratique**  
  Garder **au moins 100 Ã  200 Mo** libres pour permettre lâ€™installation de plusieurs noyaux en parallÃ¨le.

---

### ğŸ§© Exercice 7 â€“ Afficher les noyaux installÃ©s

```bash
dpkg --list | grep linux-image
sudo apt remove --purge linux-image-OLDVERSION
sudo update-grub
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ” **Lister les noyaux**  
  `dpkg --list | grep linux-image` vous montre **tous les paquets de noyaux** installÃ©s sur le systÃ¨me.

- ğŸ§¹ **Nettoyer les vieux noyaux**  
  Vous pouvez dÃ©sinstaller les noyaux trop anciens avec :  
  `sudo apt remove --purge linux-image-5.10.0-XX-amd64`  
  (en remplaÃ§ant `OLDVERSION` par la version Ã  supprimer).

- âš ï¸ **Grosse mise en garde**  
  Ne supprimez **jamais** le noyau actuellement utilisÃ© (`uname -r`), ni le tout dernier noyau stable. Gardez au moins **2 versions fonctionnelles**.

- ğŸ”„ **Pourquoi `update-grub` ensuite ?**  
  Pour que GRUB **mette Ã  jour son menu** et supprime les entrÃ©es pointant vers les noyaux effacÃ©s.

---

## 4ï¸âƒ£ Cas particuliers : `/boot` avancÃ©

| Situation                | DÃ©tails Debian                                                                            |
| ------------------------ | ----------------------------------------------------------------------------------------- |
| `/boot` sur **LVM**      | GRUB peut lire LVM, mais Ã©viter sur anciens BIOS.                                         |
| `/boot` chiffrÃ© (LUKS)** | GRUB2 â‰¥ 2.06 supporte le chiffrement, mais la clÃ© doit Ãªtre saisie au dÃ©marrage.          |
| **Secure Boot activÃ©**   | Les binaires GRUB et noyaux signÃ©s (shim, mokutil). VÃ©rifiez avec : `mokutil --sb-state`. |

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ§± **`/boot` sur LVM**  
  Fonctionnel sur les systÃ¨mes rÃ©cents, mais peut poser problÃ¨me sur du matÃ©riel trÃ¨s ancien. Pour un environnement de formation ou de prod sensible, prÃ©fÃ©rez souvent **`/boot` sur une partition simple**.

- ğŸ” **Chiffrement LUKS**  
  `/boot` peut Ãªtre chiffrÃ©, mais cela ajoute une **saisie de passphrase tÃ´t dans le boot**. Ã€ rÃ©server pour des contextes de sÃ©curitÃ© Ã©levÃ©s et aprÃ¨s tests.

- ğŸ” **Secure Boot**  
  Si Secure Boot est activÃ©, certaines manipulations manuelles de noyau ou de GRUB peuvent ne plus fonctionner tant que le binaire nâ€™est pas **signÃ©**.  
  `mokutil --sb-state` permet de vÃ©rifier lâ€™Ã©tat de Secure Boot.

- ğŸ“ **Conseil pÃ©dagogie / formation**  
  Pour un atelier pÃ©dagogique, commencez **sans Secure Boot** et **sans chiffrement**, puis introduisez ces variantes dans un **atelier avancÃ©**.

---

## 5ï¸âƒ£ Simulation dâ€™un incident GRUB et dÃ©pannage

```bash
sudo mv /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
sudo update-grub
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- âš ï¸ **Exercice Ã  faire avec prudence**  
  Ne faites ce test **que si vous avez une console root et un accÃ¨s physique/virtuel** Ã  la machine (ou au moins une sauvegarde bonne).

- ğŸ§ª **But pÃ©dagogique**  
  Simuler la disparition de `grub.cfg` et observer comment `update-grub` est capable de **reconstruire un fichier propre** Ã  partir de la configuration systÃ¨me.

- ğŸ“ **Renommer au lieu de supprimer**  
  On utilise `mv` pour renommer en `.bak` plutÃ´t que de supprimer â€“ cela permet toujours un **retour arriÃ¨re** rapide.

- ğŸ§  **Ã€ retenir**  
  Si `grub.cfg` est corrompu, souvent **un simple `update-grub`** suffit Ã  remettre de lâ€™ordre.

---

En cas de vraie panne :

```bash
sudo mount /dev/sda2 /mnt
sudo mount /dev/sda1 /mnt/boot
sudo grub-install --root-directory=/mnt /dev/sda
sudo update-grub
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ§­ **HypothÃ¨se de lâ€™exemple**
  
  - `/dev/sda2` : partition racine `/`.
  
  - `/dev/sda1` : partition `/boot`.  
    Adaptez ces valeurs en fonction de **votre propre table de partitions** (via `lsblk`, `fdisk -l`, `parted -l`).

- ğŸ•ï¸ **Montage dans `/mnt`**  
  On reconstruit un environnement systÃ¨me minimal sous `/mnt` qui ressemble au systÃ¨me normal, pour que `grub-install` puisse travailler dessus.

- ğŸ”§ **`grub-install --root-directory=/mnt /dev/sda`**  
  RÃ©installe GRUB dans le disque `/dev/sda` en prenant `/mnt` comme racine du systÃ¨me. TrÃ¨s utile aprÃ¨s un GRUB Ã©crasÃ© lors dâ€™une installation dâ€™un autre OS.

- ğŸ”„ **`update-grub` aprÃ¨s chroot (ou Ã©quivalent)**  
  Selon les procÃ©dures, on fait souvent un `chroot /mnt` puis `update-grub`. Lâ€™idÃ©e reste la mÃªme : **regÃ©nÃ©rer la configuration** Ã  partir du systÃ¨me montÃ©.

---

## 6ï¸âƒ£ VÃ©rifications et sÃ©curitÃ©

| VÃ©rification   | Commande             | Attendu                          |
| -------------- | -------------------- | -------------------------------- |
| Partition boot | `lsblk -f`           | `/boot` montÃ©e ou intÃ©grÃ©e Ã  `/` |
| Fichiers clÃ©s  | `ls /boot`           | vmlinuz, initrd, grub/           |
| Noyau actif    | `uname -r`           | correspondance OK                |
| Espace libre   | `df -h /boot`        | > 100 Mo                         |
| Secure Boot    | `mokutil --sb-state` | SecureBoot enabled/disabled      |

ğŸ’¬ **Bulles dâ€™explications / astuces**

- âœ… **Checklist post-intervention**  
  Passez systÃ©matiquement par ce tableau aprÃ¨s vos manipulations sur `/boot` ou GRUB.

- ğŸ§© **CohÃ©rence noyau / fichiers**  
  VÃ©rifiez que la version de `uname -r` correspond bien Ã  un `vmlinuz-*` et `initrd.img-*` prÃ©sents dans `/boot`.

- ğŸ“¦ **Espace libre**  
  Si vous tombez sous ~100 Mo libres, prÃ©voyez un **nettoyage de vieux noyaux**.

- ğŸ” **Secure Boot**  
  ConnaÃ®tre son Ã©tat vous Ã©vite de perdre du temps Ã  essayer dâ€™amorcer un noyau **non signÃ©** sur un systÃ¨me oÃ¹ Secure Boot est activÃ©.

---

## 7ï¸âƒ£ Nettoyage et restauration

```bash
sudo apt autoremove --purge
sudo cp -a /root/boot_backup_YYYY-MM-DD/* /boot/
sudo update-grub
```

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ§¹ **`apt autoremove --purge`**  
  Supprime les paquets devenus inutiles (dont parfois des vieux noyaux) et leurs fichiers de configuration. Utile aprÃ¨s une longue sÃ©rie de mises Ã  jour.

- â™»ï¸ **Restauration ciblÃ©e**  
  Nâ€™utilisez la restauration depuis `/root/boot_backup_YYYY-MM-DD` que si vous avez constatÃ© un **comportement anormal** aprÃ¨s modification de `/boot`.

- ğŸ§ª **Bonne pratique de test**
  
  - Faites vos modifications.
  
  - RedÃ©marrez.
  
  - Si problÃ¨me â†’ dÃ©marrez en mode rescue / live, remontez la partition et rÃ©appliquez la copie de la sauvegarde.

- ğŸ““ **Journaliser vos actions**  
  Notez dans un fichier texte (journal dâ€™atelier ou journal dâ€™admin) **quand** vous avez fait la sauvegarde, quelles manipulations ont suivi, et quand vous avez restaurÃ©.

---

## 8ï¸âƒ£ Astuces & bonnes pratiques Debian

| Cas                             | Commande utile                            |
| ------------------------------- | ----------------------------------------- |
| RÃ©installer GRUB                | `sudo grub-install /dev/sda`              |
| RecrÃ©er initramfs               | `sudo update-initramfs -u`                |
| Forcer la dÃ©tection des disques | `sudo update-grub`                        |
| VÃ©rifier EFI BootOrder          | `sudo efibootmgr -v`                      |
| Boot rapide sans menu           | `GRUB_TIMEOUT=0` dans `/etc/default/grub` |

ğŸ’¬ **Bulles dâ€™explications / astuces**

- ğŸ§± **RÃ©installer GRUB proprement**  
  Quand le bootloader est corrompu ou Ã©crasÃ© par un autre OS, `grub-install` sur le bon disque permet de **remettre Debian en premier** dans la sÃ©quence de dÃ©marrage.

- ğŸ§Š **`update-initramfs -u`**  
  Ã€ utiliser si vous modifiez des modules critiques (drivers disque, etc.) ou certains paramÃ¨tres noyau qui dÃ©pendent de lâ€™initramfs.

- ğŸ”„ **`update-grub` = rÃ©flexe**  
  AprÃ¨s ajout/suppression de noyau, changement de disque, modification de `/etc/default/grub`â€¦ pensez Ã  le relancer.

- ğŸ“œ **`efibootmgr -v`**  
  TrÃ¨s utile en UEFI pour voir lâ€™ordre de boot et le modifier si nÃ©cessaire. Peut Ã©viter de passer dans le BIOS/UEFI graphique.

- âš¡ **Boot sans menu GRUB**  
  Mettre `GRUB_TIMEOUT=0` est confortable sur un poste perso, mais en formation ou en environnement Ã  risque, prÃ©fÃ©rez garder un **dÃ©lai de quelques secondes** pour pouvoir choisir un noyau de secours.

---

## 9ï¸âƒ£ RÃ©sumÃ© final

1. `/boot` hÃ©berge le noyau, initramfs et GRUB.

2. Il peut Ãªtre une partition sÃ©parÃ©e.

3. Sauvegardez-le avant toute mise Ã  jour noyau.

4. Surveillez son espace libre.

5. En cas de corruption : `update-grub` ou rÃ©installation depuis live.

6. Taille recommandÃ©e Debian : **512 Mo Ã  1 Go**.

7. Compatible LVM/chiffrement, mais Ã  gÃ©rer prudemment.

ğŸ’¬ **Bulles de conclusion / conseils pÃ©dagogiques**

- ğŸ“ Transformez chaque commande vue dans cet atelier en **fiche mÃ©mo**, avec : but, contexte dâ€™utilisation, piÃ¨ges possibles.

- ğŸ§ª Rejouez ces commandes dans une **VM dÃ©diÃ©e aux tests** avant de les appliquer en production.
  
  
