# ğŸ§° Atelier 3 â€“ RÃ©parer GRUB depuis un Live CD Debian (version enrichie)

> Atelier enrichi avec commentaires dans les scripts + bulles dâ€™explications, dâ€™astuces et de conseils sous chaque bloc de commandes.

---

## ğŸ”– Informations gÃ©nÃ©rales

- **Niveau** : intermÃ©diaire Ã  avancÃ©

- **Objectif global** : restaurer un systÃ¨me Debian non bootable en rÃ©parant GRUB depuis un Live CD.

- **PrÃ©requis** :
  
  - Image **Debian Live** (clÃ© USB ou ISO montÃ©e).
  
  - Droits administrateur (`sudo`).
  
  - Connaissances de base sur `/boot`, les partitions, les UUID et la diffÃ©rence BIOS/UEFI.

---

## 1ï¸âƒ£ Contexte & scÃ©nario de panne

Au dÃ©marrage, lâ€™administrateur Debian voit un Ã©cran noir avec, par exemple :

```text
grub rescue> error: unknown filesystem
```

ou

```text
grub> no such partition
```

Ces messages indiquent que :

- GRUB est endommagÃ© ou absent du MBR/EFI,

- ou que la partition qui contient `/boot` nâ€™est plus accessible (supprimÃ©e, dÃ©placÃ©e, UUID modifiÃ©, disque clonÃ©, etc.).

ğŸ¯ **Objectif** : redÃ©marrer un systÃ¨me fonctionnel **sans rÃ©installer Debian**.

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Ces erreurs arrivent souvent aprÃ¨s un **redimensionnement de partition**, un **changement de disque** ou un **dual-boot mal configurÃ©**.

- ğŸ”¹ Tant que les donnÃ©es de la partition racine (`/`) sont intactes, on peut souvent tout rÃ©cupÃ©rer **en rÃ©parant seulement GRUB**.

- ğŸ”¹ Lâ€™usage dâ€™un **Live CD/USB Debian** permet de travailler â€œdepuis lâ€™extÃ©rieurâ€ sans abÃ®mer davantage le systÃ¨me installÃ©.

---

## 2ï¸âƒ£ Simulation de panne (optionnelle)

> Ã€ utiliser uniquement dans un environnement de labo / VM. Ne JAMAIS faire Ã§a sur une machine de production.

```bash
# On renomme le fichier de configuration de GRUB pour simuler une configuration manquante
sudo mv /boot/grub/grub.cfg /boot/grub/grub.cfg.bak

# On tente une (rÃ©)installation forcÃ©e de GRUB sur /dev/sda, ce qui peut crÃ©er une situation incohÃ©rente
sudo grub-install --force /dev/sda

# On redÃ©marre la machine pour constater la panne au boot
sudo reboot
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Le renommage de `grub.cfg` simule un **GRUB sans configuration**, ce qui provoque souvent un prompt `grub>` ou `grub rescue>`.

- ğŸ”¹ Lâ€™option `--force` sur `grub-install` est volontairement agressive : en vrai, on Ã©vite de lâ€™utiliser sans raison prÃ©cise.

- ğŸ”¹ Ã€ faire **strictement** sur une VM de test : cet atelier sert Ã  apprendre Ã  rÃ©parer, pas Ã  casser une machine rÃ©elle.

---

## 3ï¸âƒ£ Sauvegarde prÃ©ventive avant toute manipulation

> DÃ¨s que le systÃ¨me est accessible (via Live CD), on commence par sauvegarder ce qui reste de `/boot`.

```bash
# CrÃ©ation d'un point de montage temporaire pour la partition /boot
sudo mkdir -p /mnt/boot_backup

# Montage de la partition /boot (ici supposÃ©e Ãªtre /dev/sda1)
sudo mount /dev/sda1 /mnt/boot_backup

# Sauvegarde complÃ¨te de /boot dans /root avec un timestamp dans le nom
sudo cp -a /mnt/boot_backup /root/boot_backup_before_fix_$(date +%F)
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Toujours **sauvegarder avant de â€œrÃ©parerâ€** : mÃªme un `/boot` abÃ®mÃ© peut contenir des infos utiles (anciens noyaux, configuration, modulesâ€¦).

- ğŸ”¹ Le `-a` de `cp -a` conserve les **permissions, liens, timestamps**, ce qui est important pour une Ã©ventuelle restauration.

- ğŸ”¹ Adaptez `/dev/sda1` Ã  votre cas rÃ©el (utiliser `lsblk` et `blkid` pour confirmer).

- ğŸ”¹ La sauvegarde dans `/root/boot_backup_before_fix_YYYY-MM-DD` vous permet de revenir en arriÃ¨re en cas de mauvaise manipulation.

---

## 4ï¸âƒ£ Identification du systÃ¨me Ã  rÃ©parer

> Objectif : identifier prÃ©cisÃ©ment **quelle partition contient quoi** (/, /boot, /boot/efi, etc.).

```bash
# Affiche les disques/partitions, leur type de systÃ¨me de fichiers, la taille et le point de montage
lsblk -o NAME,FSTYPE,SIZE,MOUNTPOINT

# Affiche les UUID et le type de systÃ¨me de fichiers de chaque partition
sudo blkid

# Une fois la racine montÃ©e sur /mnt, ce fichier permet de vÃ©rifier la cohÃ©rence des UUID/partitions
cat /mnt/etc/fstab
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ `lsblk` donne une **vue globale** des disques, trÃ¨s utile pour repÃ©rer les partitions Linux (`ext4`, `xfs`, etc.) et la partition EFI (`vfat`).

- ğŸ”¹ `blkid` est la rÃ©fÃ©rence pour retrouver les **UUID** actuels, Ã  comparer avec ceux de `/etc/fstab`.

- ğŸ”¹ Si un UUID dans `/etc/fstab` ne correspond plus Ã  celui de `blkid`, câ€™est souvent la cause du **â€œno such partitionâ€** ou partition non trouvÃ©e.

- ğŸ”¹ Toujours identifier :
  
  - la partition racine (`/`, ex : `/dev/sda2`),
  
  - la partition `/boot` (si sÃ©parÃ©e),
  
  - la partition `/boot/efi` (en UEFI).

---

## 5ï¸âƒ£ RÃ©paration Ã©tape par Ã©tape

### 5.1 Monter les partitions Debian

> On monte dâ€™abord la racine, puis Ã©ventuellement `/boot` et `/boot/efi`, puis on prÃ©pare le chroot.

```bash
# Montage de la partition racine de Debian sur /mnt
sudo mount /dev/sda2 /mnt

# Si /boot est sur une partition dÃ©diÃ©e (sinon, ignorez cette ligne)
sudo mount /dev/sda1 /mnt/boot

# (En UEFI) si vous avez une partition EFI, par exemple /dev/sda1 ou /dev/sda3, montez-la sous /mnt/boot/efi
# sudo mount /dev/sda1 /mnt/boot/efi

# PrÃ©paration du chroot : on "reflÃ¨te" /dev, /proc et /sys dans le systÃ¨me montÃ©
sudo mount --bind /dev /mnt/dev
sudo mount --bind /proc /mnt/proc
sudo mount --bind /sys /mnt/sys
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Remplacez `/dev/sda2` et `/dev/sda1` par les valeurs adaptÃ©es Ã  votre machine (cf. `lsblk`).

- ğŸ”¹ Sans montage correct de `/boot` (et de `/boot/efi` en UEFI), GRUB ne trouvera pas ses fichiers au moment du `grub-install`.

- ğŸ”¹ Les `--bind` permettent au chroot dâ€™avoir accÃ¨s aux **pÃ©riphÃ©riques, processus et infos systÃ¨me** comme si on Ã©tait sur le systÃ¨me rÃ©el.

---

### 5.2 Si systÃ¨me chiffrÃ© (LUKS)

> Cas particulier si votre partition racine est chiffrÃ©e.

```bash
# Ouverture du volume chiffrÃ© LUKS en lui donnant un nom (ici debian_root)
sudo cryptsetup luksOpen /dev/sda2 debian_root

# Montage du volume dÃ©chiffrÃ© sur /mnt
sudo mount /dev/mapper/debian_root /mnt
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ AprÃ¨s `luksOpen`, la partition chiffrÃ©e apparaÃ®t comme `/dev/mapper/debian_root`.

- ğŸ”¹ Ne pas oublier de monter Ã©galement `/boot` (non chiffrÃ© en gÃ©nÃ©ral) sur `/mnt/boot`.

- ğŸ”¹ VÃ©rifiez vos UUID et les entrÃ©es de `/etc/crypttab` et `/etc/fstab` si des erreurs persistent aprÃ¨s rÃ©paration.

---

### 5.3 AccÃ©der au systÃ¨me via chroot

> On se â€œtÃ©lÃ©porteâ€ dans le systÃ¨me Debian montÃ© pour lancer les commandes comme si on y Ã©tait connectÃ© normalement.

```bash
# Entrer dans le systÃ¨me montÃ© comme si c'Ã©tait la vraie racine /
sudo chroot /mnt
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Une fois dans le chroot, le prompt change : vous Ãªtes dans un shell oÃ¹ `/` = lâ€™ancienne `/` de votre Debian.

- ğŸ”¹ LÃ , vous pouvez utiliser `apt`, `update-grub`, `grub-install`, etc. comme si vous aviez dÃ©marrÃ© la machine normalement.

- ğŸ”¹ Attention : tant que vous Ãªtes en chroot, vous travaillez sur le **systÃ¨me installÃ©**, pas sur le Live CD.

---

### 5.4 RÃ©installation de GRUB (mode BIOS / MBR)

> Cas des machines en mode **Legacy BIOS** (sans UEFI).

```bash
# VÃ©rification des disques disponibles (pour confirmer le bon disque de boot)
lsblk -o NAME,SIZE,MOUNTPOINT

# Installation de GRUB dans le MBR du disque principal (ex : /dev/sda)
grub-install /dev/sda

# RegÃ©nÃ©ration du fichier de configuration /boot/grub/grub.cfg
update-grub
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Toujours viser le **disque** (`/dev/sda`), pas une partition (`/dev/sda1`) pour une installation MBR classique.

- ğŸ”¹ `update-grub` scanne les noyaux prÃ©sents, les autres systÃ¨mes dâ€™exploitation et regÃ©nÃ¨re `grub.cfg`.

- ğŸ”¹ Si `grub-install` Ã©choue, notez bien le message dâ€™erreur : souvent, cela indique un problÃ¨me de montage de `/boot` ou un disque incorrect.

---

### 5.5 RÃ©installation de GRUB (mode UEFI)

> Cas des machines rÃ©centes en **UEFI**, avec partition EFI (FAT32).

```bash
# Installation de GRUB pour une machine x86_64 en mode UEFI
grub-install --target=x86_64-efi \
             --efi-directory=/boot/efi \
             --bootloader-id=debian

# RegÃ©nÃ©ration du fichier de configuration de GRUB
update-grub
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Le `--efi-directory` doit pointer vers le **point de montage de la partition EFI** (typiquement `/boot/efi`).

- ğŸ”¹ `--bootloader-id=debian` dÃ©finit le nom qui apparaÃ®tra dans le menu de boot UEFI.

- ğŸ”¹ VÃ©rifiez que `/boot/efi` est bien une partition **FAT32 (vfat)** et non une partition ext4.

---

### 5.6 Explication rapide dâ€™`efibootmgr`

| Option     | Signification                     |
| ---------- | --------------------------------- |
| `--create` | CrÃ©e une nouvelle entrÃ©e UEFI     |
| `--disk`   | Disque contenant la partition EFI |
| `--part`   | NumÃ©ro de la partition EFI        |
| `--label`  | Nom affichÃ© dans le BIOS/UEFI     |
| `--loader` | Chemin du binaire `.efi`          |

Exemple dâ€™utilisation :

```bash
# CrÃ©ation manuelle d'une entrÃ©e de boot UEFI pour Debian
efibootmgr --create \
  --disk /dev/sda \
  --part 1 \
  --label "Debian" \
  --loader "\EFI\debian\grubx64.efi"
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Utile si lâ€™entrÃ©e â€œDebianâ€ a disparu du firmware aprÃ¨s un reset BIOS/UEFI ou un changement de disque.

- ğŸ”¹ Le chemin `\EFI\debian\grubx64.efi` est relatif Ã  la partition EFI (telle quâ€™elle est vue par le firmware).

- ğŸ”¹ Vous pouvez lister les entrÃ©es actuelles avec :
  
  ```bash
  efibootmgr -v
  ```

---

### 5.7 RÃ©gÃ©nÃ©ration des fichiers initramfs

> Utile si des modules ou des paramÃ¨tres liÃ©s au boot ont changÃ©.

```bash
# Mise Ã  jour de l'image initramfs pour le noyau courant
update-initramfs -u
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Ã€ utiliser aprÃ¨s des modifications dans `/etc/initramfs-tools/` ou aprÃ¨s ajout/retrait de modules critiques.

- ğŸ”¹ Si plusieurs noyaux sont installÃ©s, vous pouvez cibler un noyau prÃ©cis avec `-k <version>`.

- ğŸ”¹ Un initramfs corrompu ou incomplet peut provoquer des erreurs trÃ¨s tÃ´t au boot (avant mÃªme lâ€™accÃ¨s Ã  root).

---

### 5.8 Validation avant redÃ©marrage

> Avant de redÃ©marrer, on vÃ©rifie la cohÃ©rence de GRUB et de `/boot`.

```bash
# VÃ©rifie que /boot est bien reconnu par GRUB
grub-probe /boot

# VÃ©rifie la nature des fichiers core de GRUB
file /boot/grub/*core.img
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ `grub-probe /boot` doit retourner un type de systÃ¨me de fichiers cohÃ©rent (ex : ext2, ext4â€¦).

- ğŸ”¹ La commande `file` doit indiquer des binaires valides (ELF ou similaires) pour les `core.img`.

- ğŸ”¹ Si ces vÃ©rifications Ã©chouent, revÃ©rifiez vos montages et lâ€™installation de GRUB avant de prendre le risque de redÃ©marrer.

---

## 6ï¸âƒ£ Sortie propre et redÃ©marrage

> Une fois la rÃ©paration terminÃ©e dans le chroot, on en sort proprement.

```bash
# Sortie du chroot pour revenir au shell du Live CD
exit

# DÃ©montage rÃ©cursif de tout ce qui a Ã©tÃ© montÃ© sous /mnt
sudo umount -R /mnt

# RedÃ©marrage de la machine pour tester le boot
sudo reboot
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Si `umount -R /mnt` Ã©choue en disant que le systÃ¨me de fichiers est occupÃ©, vÃ©rifiez que vous nâ€™Ãªtes plus dans un sous-rÃ©pertoire de `/mnt` dans un autre terminal.

- ğŸ”¹ Sur certaines machines, retirer la clÃ© USB Live juste aprÃ¨s le redÃ©marrage permet de vÃ©rifier que le **boot se fait bien sur le disque interne**.

- ğŸ”¹ Gardez le Live USB Ã  portÃ©e de main pour refaire une intervention si nÃ©cessaire.

---

## 7ï¸âƒ£ VÃ©rifications post-dÃ©marrage

> Une fois la machine dÃ©marrÃ©e sur Debian, on confirme que tout est propre.

```bash
# VÃ©rifier les entrÃ©es de menu dans la configuration GRUB
sudo grep menuentry /boot/grub/grub.cfg

# VÃ©rifier la prÃ©sence des fichiers EFI de Debian
sudo ls /boot/efi/EFI/debian/

# Lister les entrÃ©es de boot UEFI
sudo efibootmgr -v
```

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ `grep menuentry` permet de vÃ©rifier que les noyaux et les systÃ¨mes sont bien listÃ©s dans le menu GRUB.

- ğŸ”¹ Le dossier `/boot/efi/EFI/debian/` doit contenir au moins un fichier comme `grubx64.efi`.

- ğŸ”¹ Avec `efibootmgr -v`, vÃ©rifiez que lâ€™entrÃ©e Debian est prÃ©sente et quâ€™elle pointe vers le bon disque/chemin.

---

## 8ï¸âƒ£ Cas spÃ©ciaux et dÃ©pannage

| Situation              | Diagnostic                         | Solution recommandÃ©e                                                             |
| ---------------------- | ---------------------------------- | -------------------------------------------------------------------------------- |
| `grub rescue>` au boot | `grub.cfg` manquant/corrompu       | Entrer en chroot, puis `update-grub`                                             |
| UUID changÃ©            | clonage, resize, nouveau disque    | Mettre Ã  jour `/etc/fstab` avec les UUID actuels, puis `update-grub`             |
| `/boot` plein          | trop dâ€™anciens noyaux              | `apt autoremove --purge` pour nettoyer les vieux noyaux                          |
| EFI absent             | partition EFI supprimÃ©e / formatÃ©e | RecrÃ©er la partition EFI (FAT32), la monter sur `/boot/efi`, puis `grub-install` |
| GRUB chiffrÃ©           | root sur LUKS                      | DÃ©verrouiller LUKS, monter `/dev/mapper/...`, puis chroot + `update-grub`        |

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ **Clonage de disque** : toujours revÃ©rifier les UUID aprÃ¨s clonage, surtout si vous gardez lâ€™ancien disque connectÃ©.

- ğŸ”¹ Si `/boot` est plein, Ã©vitez de supprimer Ã  la main au hasard : utilisez `apt autoremove` pour garder un systÃ¨me cohÃ©rent.

- ğŸ”¹ Une partition EFI doit Ãªtre en **FAT32** avec le drapeau `boot, esp` (visible dans `gdisk`, `parted`, `gparted`â€¦).

- ğŸ”¹ En cas de doute :
  
  - Re-prendre la sÃ©quence : **montage â†’ chroot â†’ grub-install â†’ update-grub â†’ vÃ©rification â†’ reboot**.

---

## 9ï¸âƒ£ Validation de rÃ©ussite

| VÃ©rification     | Commande                             | RÃ©sultat attendu                        |
| ---------------- | ------------------------------------ | --------------------------------------- |
| Mode dÃ©marrage   | `[ -d /sys/firmware/efi ]`           | Si le dossier existe â†’ â€œUEFI modeâ€      |
| DÃ©tection noyaux | `grep menuentry /boot/grub/grub.cfg` | EntrÃ©es Debian visibles dans le menu    |
| Fichiers GRUB    | `file /boot/grub/*core.img`          | Fichiers binaires GRUB valides          |
| EFI actif        | `efibootmgr -v`                      | EntrÃ©e â€œDebianâ€ prÃ©sente et prioritaire |

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ La prÃ©sence de `/sys/firmware/efi` confirme que vous avez bien dÃ©marrÃ© en **UEFI** (sinon, vous Ãªtes en BIOS/Legacy).

- ğŸ”¹ Si plusieurs disques ont des entrÃ©es UEFI, assurez-vous que la prioritÃ© de boot est correctement rÃ©glÃ©e dans le BIOS/UEFI.

- ğŸ”¹ En cas de doute, documentez vos actions (captures dâ€™Ã©cran, commandes utilisÃ©es) pour pouvoir reproduire la procÃ©dure plus tard ou lâ€™enseigner.

---

## ğŸ”Ÿ Bonnes pratiques Debian pour Ã©viter les pannes de boot

1. Toujours sauvegarder `/boot` avant les mises Ã  jour noyau majeures.

2. VÃ©rifier les UUID avec `blkid` et les comparer avec `/etc/fstab` **avant** un redÃ©marrage aprÃ¨s manipulations de partitions.

3. Bien vÃ©rifier le disque cible pour `grub-install` (ex : `/dev/sda` vs `/dev/sdb`).

4. Monter systÃ©matiquement `/boot/efi` avant dâ€™installer/rÃ©installer GRUB en UEFI.

5. AprÃ¨s modifications des modules noyau ou de la configuration de boot, penser Ã  `update-initramfs -u`.

6. Tester la validitÃ© du boot tant quâ€™on est encore dans lâ€™environnement de rescue :
   
   ```bash
   grub-probe /boot && echo "Boot OK"
   ```

7. Documenter chaque intervention : date, commandes, rÃ©sultats â†’ trÃ¨s utile en contexte pro / formation.

ğŸ’¬ **Bulles dâ€™explication / astuces**

- ğŸ”¹ Une **bonne hygiÃ¨ne des partitions /boot et /boot/efi** Ã©vite une grande partie des incidents.

- ğŸ”¹ Ayez toujours un **Live USB Debian** ou Rescatux/SystemRescue Ã  portÃ©e de main pour ce type de dÃ©pannage.

- ğŸ”¹ Cet atelier est idÃ©al pour un **TP en binÃ´me** : lâ€™un â€œcasseâ€ la machine en suivant la simulation, lâ€™autre la rÃ©pare, puis vous inversez les rÃ´les.
