# üß∞ Atelier 3 ‚Äì R√©parer GRUB depuis un Live CD Debian
*(Version 2 finale ‚Äì am√©lior√©e et enrichie)*

## üîñ Informations g√©n√©rales
- **Niveau** : interm√©diaire √† avanc√©  
- **Objectif global** : restaurer un syst√®me Debian non bootable en r√©parant GRUB depuis un Live CD.  
- **Pr√©requis** :
  - Image **Debian Live** (cl√© USB ou ISO mont√©e).  
  - Droits administrateur (`sudo`).  
  - Connaissances de base sur `/boot`, partitions et UUID.

## 1Ô∏è‚É£ Contexte & sc√©nario de panne
Un administrateur Debian constate au d√©marrage :
```
grub rescue> error: unknown filesystem
```
ou  
```
grub> no such partition
```
Ces messages indiquent que GRUB est endommag√© ou absent du MBR/EFI, ou que `/boot` est corrompu.

> üéØ Objectif : red√©marrer un syst√®me fonctionnel **sans r√©installation**.

## 2Ô∏è‚É£ Simulation de panne (optionnelle)
```bash
sudo mv /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
sudo grub-install --force /dev/sda
sudo reboot
```

## 3Ô∏è‚É£ Sauvegarde pr√©ventive avant toute manipulation
```bash
sudo mkdir -p /mnt/boot_backup
sudo mount /dev/sda1 /mnt/boot_backup
sudo cp -a /mnt/boot_backup /root/boot_backup_before_fix_$(date +%F)
```

## 4Ô∏è‚É£ Identification du syst√®me √† r√©parer
```bash
lsblk -o NAME,FSTYPE,SIZE,MOUNTPOINT
sudo blkid
cat /mnt/etc/fstab
```

## 5Ô∏è‚É£ R√©paration √©tape par √©tape

### Monter les partitions Debian
```bash
sudo mount /dev/sda2 /mnt
sudo mount /dev/sda1 /mnt/boot
sudo mount --bind /dev /mnt/dev
sudo mount --bind /proc /mnt/proc
sudo mount --bind /sys /mnt/sys
```

### Si syst√®me chiffr√© (LUKS)
```bash
sudo cryptsetup luksOpen /dev/sda2 debian_root
sudo mount /dev/mapper/debian_root /mnt
```

### Acc√©der au syst√®me via chroot
```bash
sudo chroot /mnt
```

### R√©installation de GRUB (MBR)
```bash
lsblk -o NAME,SIZE,MOUNTPOINT
grub-install /dev/sda
update-grub
```

### R√©installation de GRUB (UEFI)
```bash
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=debian
update-grub
```

### Explication rapide d‚Äô`efibootmgr`
| Option | Signification |
|:--|:--|
| `--create` | cr√©e une nouvelle entr√©e UEFI |
| `--disk` | disque contenant la partition EFI |
| `--part` | num√©ro de partition EFI |
| `--label` | nom affich√© dans le BIOS |
| `--loader` | chemin du binaire `.efi` |

Exemple :
```bash
efibootmgr --create --disk /dev/sda --part 1 --label "Debian" --loader "\EFI\debian\grubx64.efi"
```

### R√©g√©n√©ration des fichiers initramfs
```bash
update-initramfs -u
```

### Validation avant red√©marrage
```bash
grub-probe /boot
file /boot/grub/*core.img
```

## 6Ô∏è‚É£ Sortie propre et red√©marrage
```bash
exit
sudo umount -R /mnt
sudo reboot
```

## 7Ô∏è‚É£ V√©rifications post-d√©marrage
```bash
sudo grep menuentry /boot/grub/grub.cfg
sudo ls /boot/efi/EFI/debian/
sudo efibootmgr -v
```

## 8Ô∏è‚É£ Cas sp√©ciaux et d√©pannage
| Situation | Diagnostic | Solution |
|:--|:--|:--|
| `grub rescue>` au boot | grub.cfg manquant | `update-grub` dans chroot |
| UUID chang√© | clonage ou resize | Mettre √† jour `/etc/fstab` puis `update-grub` |
| `/boot` plein | anciens noyaux | `apt autoremove --purge` |
| EFI absent | partition supprim√©e | recr√©er `/boot/efi`, `mkfs.vfat -F32 /dev/sda1`, puis `grub-install` |
| GRUB chiffr√© | LUKS actif | monter `/dev/mapper/root` avant chroot |

## 9Ô∏è‚É£ Validation de r√©ussite
| V√©rification | Commande | R√©sultat |
|:--|:--|:--|
| Mode d√©marrage | `[ -d /sys/firmware/efi ]` | ‚ÄúUEFI mode‚Äù ou ‚ÄúLegacy BIOS mode‚Äù |
| D√©tection noyaux | `grep menuentry /boot/grub/grub.cfg` | Entr√©e Debian list√©e |
| Fichiers GRUB | `file /boot/grub/*core.img` | Fichier binaire ELF d√©tect√© |
| EFI actif | `efibootmgr -v` | Entr√©e ‚ÄúDebian‚Äù pr√©sente |

## 10Ô∏è‚É£ Bonnes pratiques Debian
1. Sauvegarder `/boot` avant toute mise √† jour noyau.  
2. V√©rifier les UUID (`blkid`, `/etc/fstab`) avant red√©marrage.  
3. Confirmer le disque cible avant `grub-install`.  
4. Monter **/boot/efi** avant installation sur UEFI.  
5. Utiliser `update-initramfs -u` apr√®s modification des modules.  
6. Tester la validit√© du boot :  
```bash
grub-probe /boot && echo "Boot OK"
```
