# ğŸ§° Atelier 1 â€“ DÃ©couverte du disque et de ses partitions *(Version 3 enrichie)*

### ğŸ”– Informations gÃ©nÃ©rales

- **DurÃ©e estimÃ©e** : 40 Ã  60 minutes

- **Niveau** : dÃ©butant Ã  intermÃ©diaire

- **Objectif global** : comprendre la structure et la composition des disques sous Linux Debian, identifier les partitions, leur type, leur systÃ¨me de fichiers et leur point de montage.

- **PrÃ©requis** :
  
  - machine Debian 12/13 avec droits `sudo`
  
  - si possible, un second disque virtuel (`sdb` dâ€™environ 2 Go)

---

## 1ï¸âƒ£ Contexte et objectif

Un administrateur systÃ¨me vient de recevoir une machine Debian fraÃ®chement installÃ©e.  
Avant de configurer des services ou dâ€™ajouter de nouveaux volumes, il doit **dresser un inventaire complet du stockage** : disques, partitions, systÃ¨mes de fichiers et points de montage.

> ğŸ¯ Ã€ la fin de lâ€™atelier, vous saurez :
> 
> - Identifier les disques visibles par le systÃ¨me.
> 
> - Lire une table de partitions (MBR/GPT).
> 
> - Associer chaque partition Ã  son systÃ¨me de fichiers et Ã  son point de montage.
> 
> - Produire un inventaire synthÃ©tique exportable.

---

## 2ï¸âƒ£ PrÃ©paration de lâ€™environnement

### Ã‰tape 1 : VÃ©rifier la prÃ©sence des disques

```bash
sudo ls /dev/sd*
```

**Explications, astuces & conseils :**

- Le dossier `/dev` contient les **fichiers spÃ©ciaux** qui reprÃ©sentent les pÃ©riphÃ©riques (disques, partitions, etc.).

- Le motif `sd*` signifie : *tout ce qui commence par `sd`* (`sda`, `sda1`, `sdb`, `sdb1`, â€¦).

- Sur une VM simple, vous verrez gÃ©nÃ©ralement :
  
  - `sda` â†’ disque principal
  
  - `sda1`, `sda2`, â€¦ â†’ partitions de `sda`
  
  - `sdb` â†’ deuxiÃ¨me disque si vous lâ€™avez ajoutÃ©

- Si **aucun rÃ©sultat nâ€™apparaÃ®t**, vÃ©rifiez :
  
  - que la VM est bien allumÃ©e,
  
  - que le second disque a bien Ã©tÃ© ajoutÃ© dans VirtualBox / hyperviseur,
  
  - que vous nâ€™Ãªtes pas sur un systÃ¨me qui utilise des noms de type `vda` ou `nvme0n1`.

---

- Si vous voyez `/dev/sda` et `/dev/sdb`, câ€™est parfait.

- Si vous Ãªtes dans un environnement cloud, les noms peuvent Ãªtre diffÃ©rents :
  
  - `/dev/vda` (VirtIO)
  
  - `/dev/nvme0n1` (disque NVMe)

> ğŸ’¡ **Conseil pratique :**  
> Notez toujours quelque part la **correspondance** entre le disque vu par la plateforme (ex : *Disque 1 â€“ 20 Go*) et le disque vu sous Linux (`/dev/sda`). Cela Ã©vite dâ€™effacer le mauvais disque lors des manipulations futures.

---

### Ã‰tape 2 : Nettoyer les montages rÃ©siduels

```bash
sudo umount -a 2>/dev/null || true
```

**Explications, astuces & conseils :**

- `umount -a` tente de **dÃ©monter tous les systÃ¨mes de fichiers** dÃ©crits dans `/etc/mtab` (ou `/proc/self/mounts`).

- `2>/dev/null` redirige les **messages dâ€™erreur** vers `/dev/null` (ignorÃ©s).

- `|| true` garantit que la commande globale est considÃ©rÃ©e comme rÃ©ussie mÃªme si certains dÃ©montages Ã©chouent (utile dans les scripts).

- Cette Ã©tape permet dâ€™Ã©viter que des partitions de tests prÃ©cÃ©dents restent montÃ©es et faussent vos observations.

> âš ï¸ **Attention :**
> 
> - Ne faites pas cette commande sur une machine de production sans comprendre lâ€™impact : vous pourriez dÃ©monter des systÃ¨mes de fichiers nÃ©cessaires Ã  des services.
> 
> - Dans un atelier, câ€™est acceptable, mais en rÃ©el, privilÃ©giez un dÃ©montage ciblÃ© :  
>   `sudo umount /chemin/de/montage`

---

> ğŸ’¡ **Astuce :** Si vous venez dâ€™ajouter un disque virtuel dans VirtualBox, exÃ©cutez :

```bash
sudo partprobe
```

**Explications, astuces & conseils :**

- `partprobe` demande au noyau de **relire la table de partition** des disques.

- Cela Ã©vite un **redÃ©marrage** juste pour que Linux dÃ©tecte un nouveau disque ou une nouvelle partition.

- Si le disque nâ€™apparaÃ®t toujours pas :
  
  - vÃ©rifiez cÃ´tÃ© VirtualBox (ou cloud),
  
  - vÃ©rifiez les logs via `dmesg | tail`.

---

## 3ï¸âƒ£ Ã‰tapes pas Ã  pas

### ğŸ”¹ Ã‰tape 1 â€“ Inspection du disque principal

```bash
lsblk
```

**Explications, astuces & conseils :**

- `lsblk` (= *list block devices*) montre les **pÃ©riphÃ©riques de stockage** sous forme dâ€™arborescence.

- Colonnes importantes :
  
  - `NAME` â†’ nom du pÃ©riphÃ©rique (`sda`, `sda1`â€¦)
  
  - `SIZE` â†’ taille
  
  - `TYPE` â†’ `disk` (disque), `part` (partition), `rom` (CD/DVDâ€¦)
  
  - `MOUNTPOINTS` â†’ emplacement(s) oÃ¹ la partition est montÃ©e

- Câ€™est souvent **la premiÃ¨re commande Ã  lancer** quand on veut comprendre lâ€™Ã©tat du stockage.

**RÃ©sultat attendu typique :**

```
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sda      8:0    0   20G  0 disk 
â”œâ”€sda1   8:1    0   19G  0 part /
â””â”€sda2   8:2    0    1G  0 part [SWAP]
sdb      8:16   0    2G  0 disk
```

**InterprÃ©tation :**

- `TYPE=disk` â†’ disque complet (`/dev/sda`, `/dev/sdb`)

- `TYPE=part` â†’ partition (`/dev/sda1`, `/dev/sda2`)

- `MOUNTPOINTS` indique **oÃ¹** la partition est utilisÃ©e :
  
  - `/` â†’ racine du systÃ¨me
  
  - `[SWAP]` â†’ espace dâ€™Ã©change (mÃ©moire virtuelle)

> âœ… **Bon rÃ©flexe :**  
> Avant toute action sur un disque (partitionnement, formatage, LVM, etc.), faites un **`lsblk` + capture** (copier-coller ou capture dâ€™Ã©cran). Cela vous donne un point de rÃ©fÃ©rence pour comparer avant/aprÃ¨s.

> ğŸ§  **Remarque :** les noms changent selon le type de disque (`sda`, `vda`, `nvme0n1`), mais la logique reste identique.

---

### ğŸ”¹ Ã‰tape 2 â€“ Lecture de la table de partition

```bash
sudo fdisk -l
```

**Explications, astuces & conseils :**

- `fdisk -l` (*list*) affiche la **table de partitions** de tous les disques dÃ©tectÃ©s.

- Câ€™est une vue plus dÃ©taillÃ©e que `lsblk` :
  
  - type de table (MBR ou GPT),
  
  - position des partitions (en secteurs),
  
  - tailles prÃ©cises.

- Ã€ utiliser lorsque vous avez besoin dâ€™une **vue â€œbas niveauâ€** du partitionnement.

**Exemple :**

```
Disk /dev/sda: 20 GiB, 21474836480 bytes, 41943040 sectors
Disklabel type: gpt
Device       Start      End  Sectors  Size Type
/dev/sda1     2048 39843839 39841792   19G Linux filesystem
/dev/sda2  39843840 41940991  2097152    1G Linux swap
```

**Analyse :**

- `Disklabel type: gpt` â†’ la machine utilise une table **GPT** (plus moderne, supporte > 2 To).

- `Start`, `End`, `Sectors` â†’ positions des partitions sur le disque.

- `Type` â†’ indique le **rÃ´le** de la partition (filesystem Linux, swap, EFI, etc.).

> ğŸ’¡ **Astuce pÃ©dagogique :**
> 
> - Comparez les infos de `fdisk -l` avec `lsblk`.
> 
> - `fdisk` vous donne la structure bas niveau, `lsblk` vous donne la vue arborescente logique.

> âš ï¸ **Attention :**
> 
> - `fdisk` est interactif quand on omet `-l` (câ€™est lâ€™outil de modification).
> 
> - Ne validez rien sans Ãªtre sÃ»r : une mauvaise manipulation peut dÃ©truire une table de partition.

---

### ğŸ”¹ Ã‰tape 3 â€“ VÃ©rification via parted

```bash
sudo parted -l
```

**Explications, astuces & conseils :**

- `parted` est un autre outil de gestion de partitions, plus adaptÃ© aux disques GPT et trÃ¨s gros volumes.

- Lâ€™option `-l` liste tous les disques et leurs partitions.

- Il affiche souvent des infos supplÃ©mentaires :
  
  - `Partition Table: gpt`
  
  - `File system`
  
  - `Flags` (boot, esp, lvm, etc.)

**Extrait attendu :**

```
Model: ATA VBOX HARDDISK (scsi)
Disk /dev/sda: 21.5GB
Partition Table: gpt
Number  Start   End     Size    File system  Name  Flags
 1      1049kB  20.4GB  20.4GB  ext4
 2      20.4GB  21.5GB  1074MB  linux-swap
```

**IntÃ©rÃªt :**

- `parted` gÃ¨re mieux les disques GPT et affiche la table dans un format souvent plus lisible pour les dÃ©butants.

- Il est trÃ¨s utilisÃ© sur les serveurs rÃ©cents (cloud, disques > 2 To, etc.).

> ğŸ’¡ **Conseil :**  
> Si vous Ãªtes amenÃ© Ã  **modifier** des partitions avec `parted`, travaillez toujours en deux temps :
> 
> 1. `parted -l` pour **observer**
> 
> 2. `parted /dev/sdX` pour **modifier**, mais seulement aprÃ¨s avoir fait un schÃ©ma sur papier.

---

### ğŸ”¹ Ã‰tape 4 â€“ Identifier les systÃ¨mes de fichiers

Un **UUID** en Linux est un **identifiant unique universel** utilisÃ© pour reconnaÃ®tre de maniÃ¨re **fiable et permanente** un Ã©lÃ©ment systÃ¨me, en gÃ©nÃ©ral :

- un **disque** ou une **partition**

- un **systÃ¨me de fichiers**

- parfois un **pÃ©riphÃ©rique rÃ©seau** ou une **machine virtuelle**

### Pourquoi on lâ€™utilise ?

Parce quâ€™un UUID **ne change jamais**, contrairement aux noms `/dev/sda1`, `/dev/nvme0n1p1` qui peuvent varier selon lâ€™ordre de dÃ©tection du matÃ©riel.

### OÃ¹ on le voit ?

- Dans `/etc/fstab` pour monter automatiquement les partitions

- Dans `lsblk -f`, `blkid`

- Dans GRUB pour identifier la partition boot

### Exemple rapide

```bash
sudo blkid
```

**Explications, astuces & conseils :**

- `blkid` permet dâ€™identifier les **systÃ¨mes de fichiers** prÃ©sents sur les partitions.

- Pour chaque partition, on obtient :
  
  - `UUID` â†’ identifiant unique
  
  - `TYPE` â†’ type de FS (`ext4`, `xfs`, `vfat`, `swap`, â€¦)
  
  - Ã©ventuellement un `LABEL`.

**Exemple :**

```
/dev/sda1: UUID="32a7...bcd" TYPE="ext4" PARTLABEL="root"
/dev/sda2: UUID="9f3e...21b" TYPE="swap"
```

> `UUID` = identifiant unique du systÃ¨me de fichiers.  
> `TYPE` = nature du FS (ext4, xfs, swap, etc.).

> ğŸ§© **Lien avec la configuration systÃ¨me :**
> 
> - Dans `/etc/fstab`, on utilise souvent les `UUID` pour dÃ©finir les montages.
> 
> - Avantage : si lâ€™ordre des disques change (`sda` â†’ `sdb`), le montage reste correct car il repose sur lâ€™UUID.

> âš ï¸ **PiÃ¨ge frÃ©quent :**  
> Si `blkid` ne renvoie rien pour une partition, câ€™est soit :
> 
> - quâ€™elle nâ€™est **pas encore formatÃ©e** (ce sera traitÃ© dans un atelier suivant),
> 
> - soit quâ€™elle est **endommagÃ©e**.

---

### ğŸ”¹ Ã‰tape 5 â€“ Confirmer les points de montage

```bash
df -Th
```

**Explications, astuces & conseils :**

- `df` (*disk free*) affiche lâ€™utilisation de lâ€™espace disque.

- Option `-T` â†’ montre le **type** de systÃ¨me de fichiers.

- Option `-h` â†’ affiche les tailles de maniÃ¨re lisible (K/M/G).

**Exemple :**

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda1      ext4   19G  4.0G   15G  22% /
tmpfs          tmpfs 1.9G     0  1.9G   0% /dev/shm
```

**InterprÃ©tation :**

- `Filesystem` â†’ pÃ©riphÃ©rique ou pseudo-FS (`tmpfs`, `devtmpfs`, â€¦).

- `Mounted on` â†’ point de montage.

- `Use%` â†’ taux dâ€™occupation (critique si > 90%).

> ğŸ’¡ **Astuce dâ€™admin :**  
> Sur un serveur en production, gardez toujours un Å“il sur `df -Th`.  
> Un disque Ã  100 % peut bloquer des services, empÃªcher les logs dâ€™Ãªtre Ã©crits, voire rendre le systÃ¨me instable.

---

### ğŸ”¹ Ã‰tape 6 â€“ Lecture bas niveau du noyau

```bash
cat /proc/partitions
```

**Explications, astuces & conseils :**

- `/proc` est un pseudo-systÃ¨me de fichiers qui expose des informations du noyau.

- `/proc/partitions` contient la **vision brute** du noyau sur les disques et partitions.

- Colonnes :
  
  - `major` / `minor` â†’ identifiants internes des pilotes de pÃ©riphÃ©riques
  
  - `#blocks` â†’ taille en blocs
  
  - `name` â†’ nom (`sda`, `sda1`, â€¦)

**Extrait :**

```
major minor  #blocks  name
   8        0   20971520 sda
   8        1   19920896 sda1
   8        2    1048576 sda2
```

> ğŸ§  **Quand lâ€™utiliser ?**
> 
> - Pour diagnostiquer des cas oÃ¹ `lsblk` ou `fdisk` ne semblent pas cohÃ©rents.
> 
> - Pour des scripts bas niveau ou des outils de monitoring faits maison.

---

### ğŸ”¹ Ã‰tape 7 â€“ DÃ©tection de type brut du contenu

```bash
sudo file -s /dev/sda1
```

**Explications, astuces & conseils :**

- La commande `file` sert normalement Ã  dÃ©tecter le type dâ€™un fichier.

- Avec lâ€™option `-s`, elle lit aussi les **fichiers spÃ©ciaux** (comme les pÃ©riphÃ©riques de blocs).

- Sur une partition, elle est capable de reconnaÃ®tre :
  
  - le type de systÃ¨me de fichiers (`ext4`, `xfs`, â€¦),
  
  - parfois des signatures spÃ©cifiques (ex : LVM, RAIDâ€¦).

**Exemple :**

```
/dev/sda1: Linux rev 1.0 ext4 filesystem data, UUID=32a7bcd1..., volume name "rootfs"
```

> ğŸ’¡ **Cas dâ€™usage intÃ©ressant :**
> 
> - Quand vous ne savez pas si une partition contient un FS, un LVM, un RAID, ou autre chose.
> 
> - `file -s /dev/sdX` permet de lever le doute rapidement.

> âš ï¸ **Attention Ã  ne pas confondre :**  
> `file` **ne rÃ©pare rien** et nâ€™Ã©crit rien, il ne fait que lire.  
> Câ€™est un outil de **diagnostic**, sans impact sur le contenu.

---

### ğŸ”¹ Ã‰tape 8 â€“ RÃ©sumÃ© global et export

```bash
lsblk -f
```

**Explications, astuces & conseils :**

- `lsblk -f` affiche les informations de faÃ§on **orientÃ©e systÃ¨mes de fichiers** :
  
  - `FSTYPE` â†’ type de FS
  
  - `LABEL` â†’ Ã©tiquette
  
  - `UUID` â†’ identifiant unique
  
  - `MOUNTPOINTS` â†’ oÃ¹ câ€™est montÃ©

- Câ€™est une synthÃ¨se idÃ©ale pour un **inventaire global** de la machine.

**RÃ©sultat :**

```
NAME   FSTYPE LABEL UUID                                 MOUNTPOINTS
sda                                                          
â”œâ”€sda1 ext4         32a7bcd1-...                            /
â””â”€sda2 swap         9f3e21b-...                             [SWAP]
sdb
```

---

Exporter le rapport :

```bash
lsblk -f > /tmp/inventaire_disques.txt
cat /tmp/inventaire_disques.txt
```

**Explications, astuces & conseils :**

- `>` redirige la sortie de `lsblk -f` vers le fichier `/tmp/inventaire_disques.txt`.

- `cat` permet de vÃ©rifier le contenu du fichier crÃ©Ã©.

- Le rÃ©pertoire `/tmp` est parfait pour les fichiers temporaires dâ€™atelier.

> ğŸ’¼ **Bonne pratique pro :**
> 
> - Conservez ces inventaires dans un dossier type `/root/docs_inventaires/` sur les serveurs.
> 
> - Ajoutez la date dans le nom, par exemple :  
>   `lsblk -f > /root/docs_inventaires/inventaire_disques_$(date +%F).txt`

---

## 4ï¸âƒ£ VÃ©rification & mini-exercice de synthÃ¨se

ğŸ‘‰ **TÃ¢che :**  
CrÃ©ez un petit tableau (papier ou Ã©diteur de texte) rÃ©capitulant vos observations :

| Nom du pÃ©riphÃ©rique | Taille | Type | SystÃ¨me de fichiers | Point de montage |
| ------------------- | ------ | ---- | ------------------- | ---------------- |
| `/dev/sda1`         | 19G    | part | ext4                | `/`              |
| `/dev/sda2`         | 1G     | part | swap                | `[SWAP]`         |
| `/dev/sdb`          | 2G     | disk | â€”                   | â€”                |

> ğŸ’¡ **Conseils pÃ©dagogiques :**
> 
> - Faites ce tableau **vous-mÃªme**, ne vous contentez pas de lâ€™exemple : câ€™est Ã§a qui ancre la comprÃ©hension.
> 
> - Comparez rÃ©guliÃ¨rement avec les commandes vues :
>   
>   - `lsblk` pour la structure
>   
>   - `blkid` pour les FS
>   
>   - `df -Th` pour lâ€™utilisation

---

## 5ï¸âƒ£ Nettoyage / Rollback

Aucune dÃ©sinstallation nÃ©cessaire.

Si vous aviez ajoutÃ© un disque virtuel `sdb` uniquement pour lâ€™atelier :

1. Ã‰teignez la VM.

2. Retirez le disque depuis VirtualBox ou votre console cloud.

Optionnel : supprimer le fichier dâ€™inventaire.

```bash
rm /tmp/inventaire_disques.txt
```

**Explications, astuces & conseils :**

- `rm` supprime le fichier indiquÃ© sans confirmation (sauf si alias ou options).

- Sur un vrai serveur, privilÃ©giez la **conservation** de ce type de fichiers, au moins quelques semaines ou mois.

- Dans un contexte de formation, câ€™est un bon rÃ©flexe de **nettoyer** pour repartir sur une base saine au prochain atelier.

---

## 6ï¸âƒ£ Astuces & piÃ¨ges courants

| ProblÃ¨me                        | Cause probable                   | Solution                                           |
| ------------------------------- | -------------------------------- | -------------------------------------------------- |
| Le disque ajoutÃ© nâ€™apparaÃ®t pas | Le noyau nâ€™a pas relu la table   | `sudo partprobe` puis `lsblk`                      |
| Les noms `/dev/sda` changent    | Ordre de dÃ©tection du contrÃ´leur | Identifier via `lsblk -S`                          |
| Pas de FS dÃ©tectÃ©               | Partition non formatÃ©e           | Ã€ traiter dans Atelier 2 (crÃ©ation de FS)          |
| UUID manquant                   | FS corrompu ou inexistant        | RecrÃ©er avec `mkfs.ext4 -U random` (avec prudence) |
| Affichage tronquÃ©               | Terminal trop Ã©troit             | Utiliser `lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINTS`   |

> ğŸ’¡ **Conseil gÃ©nÃ©ral :**
> 
> - Toujours **observer** avant dâ€™**agir** :  
>   `lsblk` â†’ `fdisk -l` â†’ `blkid` â†’ `df -Th`
> 
> - Ne formatez jamais un disque sans avoir vÃ©rifiÃ© **au moins deux fois** que câ€™est bien le bon.

---

## 7ï¸âƒ£ Visualisation hiÃ©rarchique

ReprÃ©sentation simplifiÃ©e dâ€™un disque avec ses partitions :

+-------------------------------------------------+  
| DISQUE /dev/sda |  
+-------------------+-----------------------------+  
| /dev/sda1 | /dev/sda2 |  
| ext4 | swap |  
| / | mÃ©moire swap |  
+-------------------+-----------------------------+

> ğŸ’¡ **Exercice mental :**
> 
> - Redessinez ce schÃ©ma avec vos **propres valeurs** (tailles, noms, type de FS) en fonction de votre machine.
> 
> - Cela vous entraÃ®ne Ã  traduire la sortie des commandes en **schÃ©ma mental clair**.

---

## 8ï¸âƒ£ Transition vers lâ€™atelier suivant

> ğŸ”œ **Atelier 2 : CrÃ©ation et formatage dâ€™une nouvelle partition**
> 
> Vous apprendrez Ã  :
> 
> - crÃ©er une partition sur le disque `sdb`,
> 
> - la formater en `ext4`,
> 
> - la monter sur `/data`,
> 
> - et prÃ©parer son montage automatique au dÃ©marrage via `/etc/fstab`.
