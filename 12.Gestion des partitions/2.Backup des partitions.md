# Atlier 3: Backup des partitions

## ğŸ“š Sommaire

1. Contexte & objectif

2. PrÃ©paration de lâ€™environnement *(10 min)*

3. Exercices + solutions pas Ã  pas *(40 min)*

4. VÃ©rifications et rÃ©sultats attendus *(5 min)*

5. Nettoyage / rollback *(5 min)*

6. Astuces & piÃ¨ges *(5 min)*

7. Bonus : alternatives et tests avancÃ©s *(10 min)*

8. SchÃ©ma visuel

9. RÃ©fÃ©rences

---

## 1ï¸âƒ£ Contexte & objectif

Un administrateur doit effectuer une **sauvegarde complÃ¨te de la partition `/home`** avant une mise Ã  jour systÃ¨me critique.  
Lâ€™objectif est dâ€™obtenir une image fiable quâ€™il pourra **restaurer intÃ©gralement** en cas de problÃ¨me.

> ğŸ¯ Ã€ la fin de cet atelier, vous saurez :
> 
> - Sauvegarder une partition avec `dd` (mÃ©thode brute).
> 
> - Sauvegarder plus efficacement avec `partclone`.
> 
> - Sauvegarder la table de partitions (`sfdisk`).
> 
> - Restaurer et vÃ©rifier lâ€™intÃ©gritÃ©.
> 
> - Tester le backup dans un environnement isolÃ©.

âš ï¸ **SÃ©curitÃ© absolue** :

> - Ne jamais exÃ©cuter ces commandes sur la partition systÃ¨me `/`.
> 
> - Travailler sur une **VM de test** ou un **disque clone**.
> 
> - Toujours vÃ©rifier la destination avant dâ€™Ã©crire avec `dd`.

---

## 2ï¸âƒ£ PrÃ©paration de lâ€™environnement (â‰ˆ 10 min)

### ğŸ’¾ Ã‰tape 1 â€“ Identifier la partition

```bash
lsblk -f
```

**Exemple :**

```
NAME   FSTYPE LABEL UUID                                 MOUNTPOINTS
sda
â”œâ”€sda1 ext4         84d7-25f1                             /
â”œâ”€sda2 ext4         a9f2-99b3                             /home
â””â”€sda3 swap         5a4f-ef11                             [SWAP]
sdb
```

ğŸ‘‰ Nous allons sauvegarder `/dev/sda2` vers `/dev/sdb`.

### ğŸ’¡ Simulation (mode loop file)

Si vous ne disposez pas dâ€™un second disque, crÃ©ez un **fichier simulant une partition** :

```bash
dd if=/dev/zero of=/tmp/loop_test.img bs=1M count=1024
mkfs.ext4 /tmp/loop_test.img
sudo mkdir /mnt/loop_test
sudo mount -o loop /tmp/loop_test.img /mnt/loop_test
```

---

## 3ï¸âƒ£ Exercices et solutions pas Ã  pas (â‰ˆ 40 min)

---

### ğŸ§© Exercice 1 â€“ Sauvegarder la table de partitions

> Sauvegardez la structure du disque `/dev/sda` pour pouvoir la restaurer en cas de corruption.

#### âœ… Solution

```bash
sudo sfdisk -d /dev/sda > /mnt/backup/sda_table_backup.sfdisk
ls -l /mnt/backup/sda_table_backup.sfdisk
```

ğŸ’¡ Restauration possible :

```bash
sudo sfdisk /dev/sda < /mnt/backup/sda_table_backup.sfdisk
```

---

### ğŸ§© Exercice 2 â€“ Sauvegarde brute avec `dd`

> CrÃ©ez une image complÃ¨te bit-Ã -bit de la partition `/dev/sda2`.

#### âœ… Solution

```bash
sudo dd if=/dev/sda2 of=/mnt/backup/sda2_backup.img bs=4M status=progress conv=fsync
```

**Explications :**  
`if` = source, `of` = destination, `bs` = taille bloc, `fsync` = Ã©crit sur disque avant fin.

**Sortie typique :**

```
2147483648 bytes (2.1 GB) copied, 35 s, 61 MB/s
```

---

### ğŸ§© Exercice 3 â€“ Sauvegarde optimisÃ©e avec `partclone`

> Ã‰vitez de copier les blocs vides pour gagner temps et espace.

#### âœ… Solution

Installation :

```bash
sudo apt install -y partclone
```

Sauvegarde :

```bash
sudo partclone.ext4 -c -s /dev/sda2 -o /mnt/backup/sda2_partclone.img
```

**Sortie :**

```
Partclone v0.3.23  EXTFS
Reading block 0...100% (OK)
Completed: 100.00%
```

ğŸ’¡ **Comparatif :**  
`ls -lh /mnt/backup/sda2_*.img`  
â†’ `partclone` rÃ©duit souvent la taille de 60 % par rapport Ã  `dd`.

---

### ğŸ§© Exercice 4 â€“ VÃ©rification dâ€™intÃ©gritÃ©

> Comparez la source et lâ€™image sauvegardÃ©e.

#### âœ… Solution

```bash
sudo md5sum /dev/sda2 | cut -d' ' -f1
sudo md5sum /mnt/backup/sda2_backup.img | cut -d' ' -f1
```

Les deux hash doivent Ãªtre identiques.  
ğŸ’¡ Autre mÃ©thode :

```bash
sudo cmp -n 1048576 /dev/sda2 /mnt/backup/sda2_backup.img
```

â†’ Aucune sortie = aucune diffÃ©rence dÃ©tectÃ©e.

---

### ğŸ§© Exercice 5 â€“ Monter une image sauvegardÃ©e pour inspection

> Montez lâ€™image pour vÃ©rifier le contenu sans restauration.

#### âœ… Solution

```bash
sudo mkdir -p /mnt/test_img
sudo mount -o loop /mnt/backup/sda2_backup.img /mnt/test_img
ls /mnt/test_img
```

âœ… Vous accÃ©dez au contenu sauvegardÃ©.  
DÃ©montez ensuite :

```bash
sudo umount /mnt/test_img
```

---

### ğŸ§© Exercice 6 â€“ Restauration dâ€™une partition (mÃ©thode 1 : `dd`)

> Simulez une panne et restaurez `/dev/sda2` depuis le backup.

#### âœ… Solution

```bash
sudo dd if=/mnt/backup/sda2_backup.img of=/dev/sda2 bs=4M status=progress conv=fsync
sudo sfdisk /dev/sda < /mnt/backup/sda_table_backup.sfdisk
sudo partprobe
```

âš ï¸ Ã‰crase complÃ¨tement la partition existante : ne jamais exÃ©cuter en production.

---

### ğŸ§© Exercice 7 â€“ Restauration (mÃ©thode 2 : `partclone`)

> Restaurer plus rapidement la mÃªme partition.

#### âœ… Solution

```bash
sudo partclone.ext4 -r -s /mnt/backup/sda2_partclone.img -o /dev/sda2
```

`-r` = *restore mode*.  
Beaucoup plus rapide que `dd` et copie uniquement les blocs utiles.

---

### ğŸ§© Exercice 8 â€“ Validation finale

> Montez la partition restaurÃ©e et vÃ©rifiez le contenu.

#### âœ… Solution

```bash
sudo mkdir -p /mnt/restore_test
sudo mount /dev/sda2 /mnt/restore_test
ls /mnt/restore_test
sudo umount /mnt/restore_test
```

âœ… Les donnÃ©es dâ€™origine sont restaurÃ©es intactes.

---

## 4ï¸âƒ£ VÃ©rifications et rÃ©sultats attendus (â‰ˆ 5 min)

| Ã‰tape             | Commande                                | RÃ©sultat           |
| ----------------- | --------------------------------------- | ------------------ |
| Table sauvegardÃ©e | `ls /mnt/backup/*.sfdisk`               | PrÃ©sente           |
| Image brute       | `ls -lh /mnt/backup/sda2_backup.img`    | Taille â‰ˆ partition |
| Image optimisÃ©e   | `ls -lh /mnt/backup/sda2_partclone.img` | Taille rÃ©duite     |
| IntÃ©gritÃ©         | `md5sum`                                | Hash identiques    |
| Restauration      | `mount /dev/sda2 /mnt/restore_test`     | DonnÃ©es retrouvÃ©es |

---

## 5ï¸âƒ£ Nettoyage / rollback (â‰ˆ 5 min)

```bash
sudo umount /mnt/backup /mnt/restore_test 2>/dev/null || true
sudo rm -f /mnt/backup/sda2_backup.img /mnt/backup/sda2_partclone.img /mnt/backup/sda_table_backup.sfdisk
sudo rm -rf /mnt/test_img /mnt/restore_test
```

---

## 6ï¸âƒ£ Astuces & piÃ¨ges (â‰ˆ 5 min)

| ProblÃ¨me                  | Cause                    | Solution                                    |
| ------------------------- | ------------------------ | ------------------------------------------- |
| `dd` trop lent            | Petit `bs`               | Utiliser `bs=4M` ou `8M`                    |
| Image trop volumineuse    | Copie bloc Ã  bloc        | Utiliser `partclone`                        |
| Partition montÃ©e          | Risque dâ€™incohÃ©rence     | Lancer `sync` ou travailler depuis Live CD  |
| Espace disque insuffisant | Destination trop petite  | VÃ©rifier avec `df -h`                       |
| Mauvais pÃ©riphÃ©rique      | Erreur dâ€™Ã©criture fatale | Toujours confirmer avec `lsblk` avant `of=` |

---

## 7ï¸âƒ£ Bonus : alternatives & tests avancÃ©s (â‰ˆ 10 min)

### ğŸ”¸ Sauvegarde logique (alternative)

```bash
sudo rsync -aAXv /home/ /mnt/backup/home_rsync/
```

Copie fichier par fichier (permissions, ACL, liens) â€” utile pour restauration sÃ©lective.

### ğŸ”¸ Backup dâ€™une partition LUKS (avancÃ©)

```bash
sudo cryptsetup luksOpen /dev/sda4 securedata
sudo partclone.ext4 -c -s /dev/mapper/securedata -o /mnt/backup/securedata.img
sudo cryptsetup luksClose securedata
```

### ğŸ”¸ Montage dâ€™une image loop

```bash
sudo mount -o loop,ro /mnt/backup/sda2_backup.img /mnt/test_img
```

Permet de **naviguer dans le backup** sans altÃ©rer les donnÃ©es.

---

## 8ï¸âƒ£ SchÃ©ma visuel du processus

```mermaid
graph TD
A[Partition source /dev/sda2]:::blue -->|Sauvegarde brute| B[sda2_backup.img]:::gray
A -->|Sauvegarde optimisÃ©e| C[sda2_partclone.img]:::green
B -->|Restauration dd| D[/dev/sda2 restaurÃ©e]:::green
C -->|Restauration partclone -r| D
E[sfdisk table]:::orange -->|Structure restaurÃ©e| D
classDef blue fill:#cce5ff,stroke:#004085;
classDef green fill:#d4edda,stroke:#155724;
classDef gray fill:#e2e3e5,stroke:#383d41;
classDef orange fill:#fff3cd,stroke:#856404;
```

**Flux** : Source â†’ Image â†’ Restauration.

---

## 9ï¸âƒ£ RÃ©fÃ©rences

- `man dd`

- `man partclone`

- `man sfdisk`

- [Debian Wiki â€“ BackupAndRecovery](https://wiki.debian.org/BackupAndRecovery)
