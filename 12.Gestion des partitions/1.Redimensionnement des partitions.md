

# 🧰 Atelier 5 – Redimensionner une partition sans perte de données



## 🔖 Informations générales

- **Durée estimée** : ~50 minutes

- **Niveau** : intermédiaire

- **Objectif global** : agrandir une partition `ext4` déjà montée (ex. `/home`) sans perte de données ni reformatage.

- **Pré-requis** :
  
  - Machine Debian 12/13 avec `sudo`.
  
  - Une sauvegarde préalable des données utilisateur.
  
  - Idéalement une VM clone pour l’expérimentation.
  
  - Disque virtuel extensible ou second disque disponible.

---

## 1️⃣ Contexte et objectif

Un administrateur doit **augmenter l’espace de `/home`** après saturation du disque utilisateur.  
Il veut :

- Étendre la partition sans effacer les fichiers.

- Vérifier la cohérence du système de fichiers avant et après.

- Apprendre à travailler proprement avec `fdisk`, `resize2fs` et `partprobe`.

> 🧠 **À retenir :**  
> Supprimer une partition dans `fdisk` ne détruit **pas** les données tant que l’on **ne reformate pas** et que l’on **recrée à l’identique le même point de départ**.

---

## 2️⃣ Préparation de l’environnement

### 💾 Étape 1 – Vérifier les disques disponibles

```bash
lsblk -f
```

**Exemple :**

```
NAME   FSTYPE LABEL UUID                                 MOUNTPOINTS
sda
├─sda1 ext4         84d7-25f1                             /
├─sda2 ext4         a9f2-99b3                             /home
└─sda3 swap         5a4f-ef11                             [SWAP]
```

### 🧩 Étape 2 – Agrandir le disque virtuel

- **VirtualBox :**
  
  ```bash
  VBoxManage modifyhd ~/VirtualBox\ VMs/Debian/Debian.vdi --resize 25600
  ```

- **QEMU/KVM :**
  
  ```bash
  qemu-img resize debian-disk.qcow2 +5G
  ```

- **Cloud (AWS/GCP)** : utiliser l’outil `growpart /dev/sda 2`.

---

## 3️⃣ Étapes pratiques — Exercices + solutions

---

### 🧩 Exercice 1 – Identifier la partition à agrandir

> Trouvez la partition contenant `/home` et notez sa taille actuelle.

#### ✅ Solution

```bash
df -hT /home
```

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4  4.8G  2.0G  2.6G  44% /home
```

👉 `/dev/sda2` sera notre partition cible.

---

### 🧩 Exercice 2 – Sauvegarder la table de partitions

> Sauvegardez la table avant toute modification.

#### ✅ Solution

```bash
sudo sfdisk -d /dev/sda > sauvegarde_sda.sfdisk
head sauvegarde_sda.sfdisk
```

✅ Si besoin, restauration :

```bash
sudo sfdisk /dev/sda < sauvegarde_sda.sfdisk
```

---

### 🧩 Exercice 3 – Analyser la table actuelle

> Visualisez les positions et tailles exactes des partitions.

#### ✅ Solution

```bash
sudo fdisk -l /dev/sda
```

```
Device     Start      End  Sectors  Size Type
/dev/sda1   2048 10487807 10485760    5G Linux filesystem
/dev/sda2 10487808 20973567 10485760    5G Linux filesystem
/dev/sda3 20973568 23068671  2095104    1G Linux swap
```

💡 L’espace libre supplémentaire suit la dernière partition.

---

### 🧩 Exercice 4 – Supprimer puis recréer la partition étendue

> Dans `fdisk`, supprimez `/dev/sda2` puis recréez-la à partir du même **secteur de départ** en étendant la fin.

#### ✅ Solution

```bash
sudo fdisk /dev/sda
```

```
Command (m for help): p
Command (m for help): d
Partition number (1-3): 2
Command (m for help): n
Partition type p
Partition number (2)
First sector (press Enter to keep old value)
Last sector (press Enter to use full disk)
Command (m for help): w
```

⚠️ **Sécurité :** Vous ne formatez pas ; vous réécrivez uniquement la géométrie.

---

### 🧩 Exercice 5 – Forcer la prise en compte de la nouvelle table

> Mettez à jour la table de partitions sans redémarrer.

#### ✅ Solution

```bash
sudo partprobe /dev/sda
lsblk
```

```
sda
├─sda1   5G /
├─sda2  14G /home
└─sda3   1G [SWAP]
```

---

### 🧩 Exercice 6 – Vérifier et étendre le système de fichiers

> Vérifiez l’intégrité avant extension, puis redimensionnez.

#### ✅ Solution

```bash
sudo e2fsck -f /dev/sda2
sudo tune2fs -l /dev/sda2 | grep "Block count"
sudo resize2fs /dev/sda2
sudo tune2fs -l /dev/sda2 | grep "Block count"
```

**Sortie :**

```
Filesystem on /dev/sda2 is mounted on /home; on-line resizing required.
The filesystem on /dev/sda2 is now 3670016 blocks long.
```

---

### 🧩 Exercice 7 – Vérification finale

> Confirmez la nouvelle taille et l’état du montage.

#### ✅ Solution

```bash
df -hT /home
```

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4   14G  2.0G   12G  15% /home
```

🎉 Partition agrandie, fichiers intacts, UUID inchangé.

---

### 🧩 Exercice 8 – Simulation d’erreur courante

> Essayez d’exécuter `resize2fs` avant `fdisk`.  
> Observez le message d’erreur.

#### ✅ Résultat attendu

```
resize2fs: Device or resource busy while trying to open /dev/sda2
```

💡 **Cause :** la partition ne disposait pas encore d’espace supplémentaire.  
**Remède :** toujours agrandir la partition d’abord, puis le système de fichiers.

---

## 4️⃣ Vérifications & résultats attendus

| Commande              | Objectif            | Résultat                        |
| --------------------- | ------------------- | ------------------------------- |
| `fdisk -l /dev/sda`   | Nouvelle taille     | `/dev/sda2` plus grande         |
| `tune2fs -l /dev/sda2 | grep "Block count"` | Vérif. interne FS               |
| `lsblk -f`            | Cohérence globale   | UUID identique, taille modifiée |

---

## 5️⃣ Nettoyage / Rollback

Si tout est validé :

```bash
rm sauvegarde_sda.sfdisk
```

Pour revenir en arrière :

```bash
sudo sfdisk /dev/sda < sauvegarde_sda.sfdisk
sudo partprobe
sudo resize2fs /dev/sda2
```

---

## 6️⃣ Astuces & plans de secours

| Situation                      | Solution                                                        |
| ------------------------------ | --------------------------------------------------------------- |
| Perte de table                 | Restaurer depuis `sfdisk` ou utiliser `testdisk`.               |
| FS non ext4                    | Utiliser `xfs_growfs /home`.                                    |
| VM Cloud                       | Utiliser `growpart /dev/sda 2` au lieu de `fdisk`.              |
| Impossible de démonter `/home` | Passer en mode single-user (`systemctl isolate rescue.target`). |

---

## 7️⃣ Visualisation de l’opération

```mermaid
graph TD
subgraph Etat_initial
A[/dev/sda1 5 Go /]:::blue
B[/dev/sda2 5 Go /home]:::blue
C[/dev/sda3 1 Go swap]:::blue
end
subgraph Espace_libre
D[15 Go non alloué]:::gray
end
subgraph Etat_final
E[/dev/sda2 14 Go /home étendu]:::green
F[Filesystem ajusté par resize2fs]:::green
end
classDef blue fill:#cce5ff,stroke:#004085;
classDef green fill:#d4edda,stroke:#155724;
classDef gray fill:#e2e3e5,stroke:#383d41;
```

**Légende :**  
🔵 Blocs bleus = état initial 🟢 verts = état final ⚪ gris = espace libre avant extension

---

## 8️⃣ Résumé des bonnes pratiques

1. **Sauvegarder avant d’agir** (`sfdisk`, snapshot VM).

2. **Toujours vérifier l’intégrité** avec `e2fsck`.

3. **Étendre partition → puis système de fichiers**.

4. **Vérifier le résultat** (`df -hT`, `tune2fs`).

5. **Nettoyer les sauvegardes** après validation.

---

Souhaites-tu que je continue avec le même niveau de détail pour l’**Atelier 6 – Créer une partition LUKS chiffrée** ou préfères-tu qu’on traite d’abord un autre atelier de la même série ?
