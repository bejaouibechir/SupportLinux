

# ğŸ§° Atelier 5 â€“ Redimensionner une partition sans perte de donnÃ©es



## ğŸ”– Informations gÃ©nÃ©rales

- **DurÃ©e estimÃ©e** : ~50 minutes

- **Niveau** : intermÃ©diaire

- **Objectif global** : agrandir une partition `ext4` dÃ©jÃ  montÃ©e (ex. `/home`) sans perte de donnÃ©es ni reformatage.

- **PrÃ©-requis** :
  
  - Machine Debian 12/13 avec `sudo`.
  
  - Une sauvegarde prÃ©alable des donnÃ©es utilisateur.
  
  - IdÃ©alement une VM clone pour lâ€™expÃ©rimentation.
  
  - Disque virtuel extensible ou second disque disponible.

---

## 1ï¸âƒ£ Contexte et objectif

Un administrateur doit **augmenter lâ€™espace de `/home`** aprÃ¨s saturation du disque utilisateur.  
Il veut :

- Ã‰tendre la partition sans effacer les fichiers.

- VÃ©rifier la cohÃ©rence du systÃ¨me de fichiers avant et aprÃ¨s.

- Apprendre Ã  travailler proprement avec `fdisk`, `resize2fs` et `partprobe`.

> ğŸ§  **Ã€ retenir :**  
> Supprimer une partition dans `fdisk` ne dÃ©truit **pas** les donnÃ©es tant que lâ€™on **ne reformate pas** et que lâ€™on **recrÃ©e Ã  lâ€™identique le mÃªme point de dÃ©part**.

---

## 2ï¸âƒ£ PrÃ©paration de lâ€™environnement

### ğŸ’¾ Ã‰tape 1 â€“ VÃ©rifier les disques disponibles

```bash
lsblk -f
```

**Exemple :**

```
NAME   FSTYPE LABEL UUID                                 MOUNTPOINTS
sda
â”œâ”€sda1 ext4         84d7-25f1                             /
â”œâ”€sda2 ext4         a9f2-99b3                             /home
â””â”€sda3 swap         5a4f-ef11                             [SWAP]
```

### ğŸ§© Ã‰tape 2 â€“ Agrandir le disque virtuel

- **VirtualBox :**
  
  ```bash
  VBoxManage modifyhd ~/VirtualBox\ VMs/Debian/Debian.vdi --resize 25600
  ```

- **QEMU/KVM :**
  
  ```bash
  qemu-img resize debian-disk.qcow2 +5G
  ```

- **Cloud (AWS/GCP)** : utiliser lâ€™outil `growpart /dev/sda 2`.

---

## 3ï¸âƒ£ Ã‰tapes pratiques â€” Exercices + solutions

---

### ğŸ§© Exercice 1 â€“ Identifier la partition Ã  agrandir

> Trouvez la partition contenant `/home` et notez sa taille actuelle.

#### âœ… Solution

```bash
df -hT /home
```

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4  4.8G  2.0G  2.6G  44% /home
```

ğŸ‘‰ `/dev/sda2` sera notre partition cible.

---

### ğŸ§© Exercice 2 â€“ Sauvegarder la table de partitions

> Sauvegardez la table avant toute modification.

#### âœ… Solution

```bash
sudo sfdisk -d /dev/sda > sauvegarde_sda.sfdisk
head sauvegarde_sda.sfdisk
```

âœ… Si besoin, restauration :

```bash
sudo sfdisk /dev/sda < sauvegarde_sda.sfdisk
```

---

### ğŸ§© Exercice 3 â€“ Analyser la table actuelle

> Visualisez les positions et tailles exactes des partitions.

#### âœ… Solution

```bash
sudo fdisk -l /dev/sda
```

```
Device     Start      End  Sectors  Size Type
/dev/sda1   2048 10487807 10485760    5G Linux filesystem
/dev/sda2 10487808 20973567 10485760    5G Linux filesystem
/dev/sda3 20973568 23068671  2095104    1G Linux swap
```

ğŸ’¡ Lâ€™espace libre supplÃ©mentaire suit la derniÃ¨re partition.

---

### ğŸ§© Exercice 4 â€“ Supprimer puis recrÃ©er la partition Ã©tendue

> Dans `fdisk`, supprimez `/dev/sda2` puis recrÃ©ez-la Ã  partir du mÃªme **secteur de dÃ©part** en Ã©tendant la fin.

#### âœ… Solution

```bash
sudo fdisk /dev/sda
```

```
Command (m for help): p
Command (m for help): d
Partition number (1-3): 2
Command (m for help): n
Partition type p
Partition number (2)
First sector (press Enter to keep old value)
Last sector (press Enter to use full disk)
Command (m for help): w
```

âš ï¸ **SÃ©curitÃ© :** Vous ne formatez pas ; vous rÃ©Ã©crivez uniquement la gÃ©omÃ©trie.

---

### ğŸ§© Exercice 5 â€“ Forcer la prise en compte de la nouvelle table

> Mettez Ã  jour la table de partitions sans redÃ©marrer.

#### âœ… Solution

```bash
sudo partprobe /dev/sda
lsblk
```

```
sda
â”œâ”€sda1   5G /
â”œâ”€sda2  14G /home
â””â”€sda3   1G [SWAP]
```

---

### ğŸ§© Exercice 6 â€“ VÃ©rifier et Ã©tendre le systÃ¨me de fichiers

> VÃ©rifiez lâ€™intÃ©gritÃ© avant extension, puis redimensionnez.

#### âœ… Solution

```bash
sudo e2fsck -f /dev/sda2
sudo tune2fs -l /dev/sda2 | grep "Block count"
sudo resize2fs /dev/sda2
sudo tune2fs -l /dev/sda2 | grep "Block count"
```

**Sortie :**

```
Filesystem on /dev/sda2 is mounted on /home; on-line resizing required.
The filesystem on /dev/sda2 is now 3670016 blocks long.
```

---

### ğŸ§© Exercice 7 â€“ VÃ©rification finale

> Confirmez la nouvelle taille et lâ€™Ã©tat du montage.

#### âœ… Solution

```bash
df -hT /home
```

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4   14G  2.0G   12G  15% /home
```

ğŸ‰ Partition agrandie, fichiers intacts, UUID inchangÃ©.

---

### ğŸ§© Exercice 8 â€“ Simulation dâ€™erreur courante

> Essayez dâ€™exÃ©cuter `resize2fs` avant `fdisk`.  
> Observez le message dâ€™erreur.

#### âœ… RÃ©sultat attendu

```
resize2fs: Device or resource busy while trying to open /dev/sda2
```

ğŸ’¡ **Cause :** la partition ne disposait pas encore dâ€™espace supplÃ©mentaire.  
**RemÃ¨de :** toujours agrandir la partition dâ€™abord, puis le systÃ¨me de fichiers.

---

## 4ï¸âƒ£ VÃ©rifications & rÃ©sultats attendus

| Commande              | Objectif            | RÃ©sultat                        |
| --------------------- | ------------------- | ------------------------------- |
| `fdisk -l /dev/sda`   | Nouvelle taille     | `/dev/sda2` plus grande         |
| `tune2fs -l /dev/sda2 | grep "Block count"` | VÃ©rif. interne FS               |
| `lsblk -f`            | CohÃ©rence globale   | UUID identique, taille modifiÃ©e |

---

## 5ï¸âƒ£ Nettoyage / Rollback

Si tout est validÃ© :

```bash
rm sauvegarde_sda.sfdisk
```

Pour revenir en arriÃ¨re :

```bash
sudo sfdisk /dev/sda < sauvegarde_sda.sfdisk
sudo partprobe
sudo resize2fs /dev/sda2
```

---

## 6ï¸âƒ£ Astuces & plans de secours

| Situation                      | Solution                                                        |
| ------------------------------ | --------------------------------------------------------------- |
| Perte de table                 | Restaurer depuis `sfdisk` ou utiliser `testdisk`.               |
| FS non ext4                    | Utiliser `xfs_growfs /home`.                                    |
| VM Cloud                       | Utiliser `growpart /dev/sda 2` au lieu de `fdisk`.              |
| Impossible de dÃ©monter `/home` | Passer en mode single-user (`systemctl isolate rescue.target`). |

---

## 7ï¸âƒ£ Visualisation de lâ€™opÃ©ration

```mermaid
graph TD
subgraph Etat_initial
A[/dev/sda1 5 Go /]:::blue
B[/dev/sda2 5 Go /home]:::blue
C[/dev/sda3 1 Go swap]:::blue
end
subgraph Espace_libre
D[15 Go non allouÃ©]:::gray
end
subgraph Etat_final
E[/dev/sda2 14 Go /home Ã©tendu]:::green
F[Filesystem ajustÃ© par resize2fs]:::green
end
classDef blue fill:#cce5ff,stroke:#004085;
classDef green fill:#d4edda,stroke:#155724;
classDef gray fill:#e2e3e5,stroke:#383d41;
```

**LÃ©gende :**  
ğŸ”µ Blocs bleus = Ã©tat initialâ€ƒğŸŸ¢ verts = Ã©tat finalâ€ƒâšª gris = espace libre avant extension

---

## 8ï¸âƒ£ RÃ©sumÃ© des bonnes pratiques

1. **Sauvegarder avant dâ€™agir** (`sfdisk`, snapshot VM).

2. **Toujours vÃ©rifier lâ€™intÃ©gritÃ©** avec `e2fsck`.

3. **Ã‰tendre partition â†’ puis systÃ¨me de fichiers**.

4. **VÃ©rifier le rÃ©sultat** (`df -hT`, `tune2fs`).

5. **Nettoyer les sauvegardes** aprÃ¨s validation.

---

Souhaites-tu que je continue avec le mÃªme niveau de dÃ©tail pour lâ€™**Atelier 6 â€“ CrÃ©er une partition LUKS chiffrÃ©e** ou prÃ©fÃ¨res-tu quâ€™on traite dâ€™abord un autre atelier de la mÃªme sÃ©rie ?
