# ğŸ§° Atelier 5 â€“ Redimensionner une partition sans perte de donnÃ©es

## ğŸ”– Informations gÃ©nÃ©rales

- **DurÃ©e estimÃ©e** : ~50 minutes

- **Niveau** : intermÃ©diaire

- **Objectif global** : agrandir une partition `ext4` dÃ©jÃ  montÃ©e (ex. `/home`) sans perte de donnÃ©es ni reformatage.

- **PrÃ©-requis** :
  
  - Machine Debian 12/13 avec `sudo`.
  
  - Une sauvegarde prÃ©alable des donnÃ©es utilisateur.
  
  - IdÃ©alement une VM clone pour lâ€™expÃ©rimentation.
  
  - Disque virtuel extensible ou second disque disponible.

---

## 1ï¸âƒ£ Contexte et objectif

Un administrateur doit **augmenter lâ€™espace de `/home`** aprÃ¨s saturation du disque utilisateur.  
Il veut :

- Ã‰tendre la partition sans effacer les fichiers.

- VÃ©rifier la cohÃ©rence du systÃ¨me de fichiers avant et aprÃ¨s.

- Apprendre Ã  travailler proprement avec `fdisk`, `resize2fs` et `partprobe`.

> ğŸ§  **Ã€ retenir :**  
> Supprimer une partition dans `fdisk` ne dÃ©truit **pas** les donnÃ©es tant que lâ€™on **ne reformate pas** et que lâ€™on **recrÃ©e Ã  lâ€™identique le mÃªme point de dÃ©part**.

ğŸ’¡ **Conseil pÃ©dagogique :**  
Sur une machine de production, cette opÃ©ration doit toujours Ãªtre faite en dehors des heures de pointe, avec une **vraie sauvegarde testÃ©e** (pas seulement un `cp` ou un `tar` non vÃ©rifiÃ©). Sur une VM de labo, nâ€™hÃ©sitez pas Ã  casser, restaurer, recommencer : câ€™est comme Ã§a quâ€™on ancre les rÃ©flexes.

---

## 2ï¸âƒ£ PrÃ©paration de lâ€™environnement

### ğŸ’¾ Ã‰tape 1 â€“ VÃ©rifier les disques disponibles

```bash
lsblk -f
```

**Exemple :**

```
NAME   FSTYPE LABEL UUID                                 MOUNTPOINTS
sda
â”œâ”€sda1 ext4         84d7-25f1                             /
â”œâ”€sda2 ext4         a9f2-99b3                             /home
â””â”€sda3 swap         5a4f-ef11                             [SWAP]
```

ğŸ’¬ **Explications & conseils :**

- `lsblk -f` affiche **la hiÃ©rarchie des disques** (sda, sdb, etc.), les partitions (sda1, sda2â€¦) et les **systÃ¨mes de fichiers** (`FSTYPE`) avec leurs **points de montage** (`MOUNTPOINTS`).

- VÃ©rifiez toujours que **la partition ciblÃ©e est bien celle qui contient le rÃ©pertoire visÃ©** (`/home` dans cet exemple).

- Notez **le nom du pÃ©riphÃ©rique** (`/dev/sda2`), mais aussi lâ€™Ã©ventuelle prÃ©sence de **LVM** ou dâ€™un RAID â€” dans ce cas la dÃ©marche change et il faut adapter (ici, on reste sur du simple `ext4` direct).

- Astuce : conservez la sortie de `lsblk -f` dans un fichier (`lsblk -f > avant_lsblk.txt`) pour comparer avant / aprÃ¨s.

---

### ğŸ§© Ã‰tape 2 â€“ Agrandir le disque virtuel

- **VirtualBox :**
  
  ```bash
  VBoxManage modifyhd ~/VirtualBox\ VMs/Debian/Debian.vdi --resize 25600
  ```

- **QEMU/KVM :**
  
  ```bash
  qemu-img resize debian-disk.qcow2 +5G
  ```

- **Cloud (AWS/GCP)** : utiliser lâ€™outil `growpart /dev/sda 2`.

ğŸ’¬ **Explications & conseils :**

- Ces commandes **ne touchent pas encore aux partitions** : elles agrandissent uniquement le **support virtuel** (le fichier `.vdi` ou `.qcow2`).

- Sous VirtualBox, la valeur `25600` correspond Ã  la **taille totale** du disque en Mo (ici â‰ˆ 25 Go). Sous QEMU, `+5G` ajoute **5 Go** Ã  la taille actuelle.

- Sur le Cloud, les providers disposent souvent dâ€™un **outil maison** (`growpart`, console webâ€¦) qui gÃ¨re la partie â€œdisque virtuelâ€ pour vous; ensuite, Ã  lâ€™intÃ©rieur de la VM, vous retrouvez **exactement** les mÃªmes Ã©tapes Linux que dans cet atelier.

- Toujours vÃ©rifier aprÃ¨s cette Ã©tape avec `lsblk` ou `fdisk -l` : vous ne verrez pas encore lâ€™espace libre dans les partitions, mais vous devrez voir un disque plus grand.

---

## 3ï¸âƒ£ Ã‰tapes pratiques â€” Exercices + solutions

---

### ğŸ§© Exercice 1 â€“ Identifier la partition Ã  agrandir

> Trouvez la partition contenant `/home` et notez sa taille actuelle.

#### âœ… Solution

```bash
df -hT /home
```

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4  4.8G  2.0G  2.6G  44% /home
```

ğŸ‘‰ `/dev/sda2` sera notre partition cible.

ğŸ’¬ **Explications & conseils :**

- `df -hT /home` affiche **uniquement** la ligne correspondant au systÃ¨me de fichiers qui supporte `/home`.

- Lâ€™option `-h` (human) rend les tailles lisibles (`G`, `M`), et `-T` ajoute le type (`ext4`, `xfs`, etc.).

- Notez bien :
  
  - Le **device** (`/dev/sda2`),
  
  - La **taille totale** (`Size`),
  
  - Lâ€™espace **utilisÃ©** et **disponible**.

- Avant de manipuler, vÃ©rifiez que lâ€™utilisation (`Use%`) nâ€™est pas Ã  100%. Si `/home` est totalement plein, pensez Ã  dÃ©placer temporairement des fichiers lourds (ISO, archivesâ€¦) vers un autre disque/stockage.

---

### ğŸ§© Exercice 2 â€“ Sauvegarder la table de partitions

> Sauvegardez la table avant toute modification.

#### âœ… Solution

```bash
sudo sfdisk -d /dev/sda > sauvegarde_sda.sfdisk
head sauvegarde_sda.sfdisk
```

âœ… Si besoin, restauration :

```bash
sudo sfdisk /dev/sda < sauvegarde_sda.sfdisk
```

ğŸ’¬ **Explications & conseils :**

- `sfdisk -d` â€œ**dump**â€ la table de partitions sous forme de texte, ce qui permet de la **restaurer** en cas dâ€™erreur.

- Câ€™est lâ€™Ã©quivalent dâ€™une **photo de la structure du disque**, indÃ©pendante des donnÃ©es. Si vous cassez la gÃ©omÃ©trie, vous pouvez revenir Ã  cette photo.

- `head` permet de vÃ©rifier rapidement que le fichier nâ€™est pas vide et a une tÃªte cohÃ©rente.

- **Bon rÃ©flexe** : stockez `sauvegarde_sda.sfdisk` **hors du disque** que vous manipulez (ex : disque secondaire, partage rÃ©seau) si câ€™est une machine critique.

---

### ğŸ§© Exercice 3 â€“ Analyser la table actuelle

> Visualisez les positions et tailles exactes des partitions.

#### âœ… Solution

```bash
sudo fdisk -l /dev/sda
```

```
Device     Start      End  Sectors  Size Type
/dev/sda1   2048 10487807 10485760    5G Linux filesystem
/dev/sda2 10487808 20973567 10485760    5G Linux filesystem
/dev/sda3 20973568 23068671  2095104    1G Linux swap
```

ğŸ’¡ Lâ€™espace libre supplÃ©mentaire suit la derniÃ¨re partition.

ğŸ’¬ **Explications & conseils :**

- `fdisk -l /dev/sda` donne la **position exacte** des partitions en nombre de **secteurs** (`Start`, `End`).

- Ce qui nous intÃ©resse surtout :
  
  - Le **secteur de dÃ©part** de `/dev/sda2` (ici `10487808`),
  
  - Le fait quâ€™il y ait de lâ€™**espace libre** aprÃ¨s les partitions existantes (aprÃ¨s `sda3` dans lâ€™exemple ou aprÃ¨s `sda2` selon votre cas rÃ©el).

- Avant de continuer, notez **clairement** le secteur de dÃ©part de la partition que vous allez modifier : câ€™est le point dâ€™ancrage qui garantit quâ€™on retombe sur le mÃªme systÃ¨me de fichiers.

- Astuce : gardez cette sortie dans un fichier (`fdisk -l /dev/sda > fdisk_avant.txt`) pour comparaison Ã  la fin.

---

### ğŸ§© Exercice 4 â€“ Supprimer puis recrÃ©er la partition Ã©tendue

> Dans `fdisk`, supprimez `/dev/sda2` puis recrÃ©ez-la Ã  partir du mÃªme **secteur de dÃ©part** en Ã©tendant la fin.

#### âœ… Solution

```bash
sudo fdisk /dev/sda
```

```
Command (m for help): p
Command (m for help): d
Partition number (1-3): 2
Command (m for help): n
Partition type p
Partition number (2)
First sector (press Enter to keep old value)
Last sector (press Enter to use full disk)
Command (m for help): w
```

âš ï¸ **SÃ©curitÃ© :** Vous ne formatez pas ; vous rÃ©Ã©crivez uniquement la gÃ©omÃ©trie.

ğŸ’¬ **Explications & conseils :**

- La sÃ©quence logique dans `fdisk` :
  
  1. `p` : afficher la table (toujours vÃ©rifier avant dâ€™agir).
  
  2. `d` : supprimer **uniquement** la partition cible (ici `2`).
  
  3. `n` : crÃ©er une **nouvelle partition** au mÃªme emplacement.
  
  4. Au moment du **First sector**, **appuyez sur EntrÃ©e** pour conserver **exactement** lâ€™ancien secteur de dÃ©part (sinon, systÃ¨me de fichiers perdu).
  
  5. Au **Last sector**, laissez `fdisk` utiliser la valeur par dÃ©faut pour occuper tout le nouvel espace.
  
  6. `w` : Ã©crire la nouvelle table sur le disque.

- Tant que vous nâ€™avez pas tapÃ© `w`, rien nâ€™est appliquÃ©. Si un doute surgit, quittez avec `q`.

- Pour sâ€™entraÃ®ner, vous pouvez faire exactement la mÃªme chose sur un **disque de test vide**, pour apprivoiser les commandes sans stress.

---

### ğŸ§© Exercice 5 â€“ Forcer la prise en compte de la nouvelle table

> Mettez Ã  jour la table de partitions sans redÃ©marrer.

#### âœ… Solution

```bash
sudo partprobe /dev/sda
lsblk
```

```
sda
â”œâ”€sda1   5G /
â”œâ”€sda2  14G /home
â””â”€sda3   1G [SWAP]
```

ğŸ’¬ **Explications & conseils :**

- `partprobe` demande au noyau de **relire la table des partitions**. Sans Ã§a, le noyau peut encore â€œvoirâ€ lâ€™ancienne gÃ©omÃ©trie.

- Si `partprobe` ne suffit pas ou renvoie un message du type â€œdevice busyâ€, dans certains cas un **redÃ©marrage** peut Ãªtre nÃ©cessaire (mais on essaie dâ€™Ã©viter sur une prod).

- `lsblk` permet de vÃ©rifier immÃ©diatement que `/dev/sda2` affiche dÃ©sormais une **taille plus grande** (ici `14G`).

- Astuce : en cas dâ€™erreur Ã©trange, vÃ©rifiez les logs via `dmesg | tail` aprÃ¨s `partprobe` pour voir ce que le noyau a rÃ©ellement compris.

---

### ğŸ§© Exercice 6 â€“ VÃ©rifier et Ã©tendre le systÃ¨me de fichiers

> VÃ©rifiez lâ€™intÃ©gritÃ© avant extension, puis redimensionnez.

#### âœ… Solution

```bash
sudo e2fsck -f /dev/sda2
sudo tune2fs -l /dev/sda2 | grep "Block count"
sudo resize2fs /dev/sda2
sudo tune2fs -l /dev/sda2 | grep "Block count"
```

**Sortie :**

```
Filesystem on /dev/sda2 is mounted on /home; on-line resizing required.
The filesystem on /dev/sda2 is now 3670016 blocks long.
```

ğŸ’¬ **Explications & conseils :**

- `e2fsck -f` force une **vÃ©rification complÃ¨te** du systÃ¨me de fichiers `ext4`.
  
  - Ã€ faire **avant** la modification, pour Ãªtre sÃ»r quâ€™on nâ€™agrandit pas un FS dÃ©jÃ  corrompu.

- `tune2fs -l` permet dâ€™inspecter **les paramÃ¨tres internes** du systÃ¨me de fichiers, dont le nombre de blocs (`Block count`).
  
  - En le lanÃ§ant avant et aprÃ¨s, vous voyez concrÃ¨tement lâ€™augmentation de taille.

- `resize2fs /dev/sda2` :
  
  - Si la partition est montÃ©e et que `ext4` le supporte, lâ€™outil tente un **redimensionnement Ã  chaud** (â€œon-line resizingâ€).
  
  - Sur une ancienne version ou un autre FS, il pourrait exiger un **dÃ©montage** (`umount`) et un passage en mode `single-user`.

- Astuce pratique : sur un environnement sensible, faites au moins un test complet sur une VM de labo avec **exactement la mÃªme version** de Debian / noyau, pour Ã©viter les surprises.

---

### ğŸ§© Exercice 7 â€“ VÃ©rification finale

> Confirmez la nouvelle taille et lâ€™Ã©tat du montage.

#### âœ… Solution

```bash
df -hT /home
```

```
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda2      ext4   14G  2.0G   12G  15% /home
```

ğŸ‰ Partition agrandie, fichiers intacts, UUID inchangÃ©.

ğŸ’¬ **Explications & conseils :**

- On vÃ©rifie ici :
  
  - La **nouvelle taille** (`14G`),
  
  - Le **type** de FS (toujours `ext4`),
  
  - Le **point de montage** (`/home`) inchangÃ©.

- Si lâ€™espace disponible semble identique Ã  lâ€™ancien :
  
  - VÃ©rifiez que vous avez bien appelÃ© `resize2fs`.
  
  - VÃ©rifiez que vous nâ€™avez pas agrandi la **mauvaise partition**.

- Bonne pratique : testez lâ€™Ã©criture de fichiers (ex : crÃ©er un gros fichier via `fallocate -l 1G test.img`) pour Ãªtre sÃ»r que tout fonctionne bien.

---

### ğŸ§© Exercice 8 â€“ Simulation dâ€™erreur courante

> Essayez dâ€™exÃ©cuter `resize2fs` avant `fdisk`.  
> Observez le message dâ€™erreur.

#### âœ… RÃ©sultat attendu

```
resize2fs: Device or resource busy while trying to open /dev/sda2
```

ğŸ’¡ **Cause :** la partition ne disposait pas encore dâ€™espace supplÃ©mentaire.  
**RemÃ¨de :** toujours agrandir la partition dâ€™abord, puis le systÃ¨me de fichiers.

ğŸ’¬ **Explications & conseils :**

- Cette erreur est **trÃ¨s frÃ©quente** chez les dÃ©butants : on tente dâ€™agrandir directement le systÃ¨me de fichiers sans avoir **augmentÃ© la partition**.

- Lâ€™ordre correct est toujours :
  
  1. Agrandir le **disque virtuel** (VirtualBox / Cloud / hyperviseur),
  
  2. Modifier la **table de partitions** (`fdisk` / `parted`, etc.),
  
  3. RafraÃ®chir la vision du noyau (`partprobe`, redÃ©marrage si besoin),
  
  4. Puis **agrandir le systÃ¨me de fichiers** (`resize2fs`, `xfs_growfs`, etc.).

- Astuce pÃ©dagogique : gardez cette erreur comme **test de comprÃ©hension** Ã  donner aux stagiaires : â€œPourquoi `resize2fs` se plaint-il ? Quâ€™avez-vous oubliÃ© ?â€

---

## 4ï¸âƒ£ VÃ©rifications & rÃ©sultats attendus

| Commande              | Objectif            | RÃ©sultat                        |
| --------------------- | ------------------- | ------------------------------- |
| `fdisk -l /dev/sda`   | Nouvelle taille     | `/dev/sda2` plus grande         |
| `tune2fs -l /dev/sda2 | grep "Block count"` | VÃ©rif. interne FS               |
| `lsblk -f`            | CohÃ©rence globale   | UUID identique, taille modifiÃ©e |

ğŸ’¬ **Explications & conseils :**

- Ces commandes servent de **checklist de validation** :
  
  - `fdisk -l` : confirme la **gÃ©omÃ©trie**.
  
  - `tune2fs` : confirme lâ€™**ajustement interne** du FS.
  
  - `lsblk -f` : permet de vÃ©rifier que lâ€™UUID nâ€™a pas changÃ© (important si vous utilisez `/etc/fstab` basÃ© sur UUID).

- Prenez lâ€™habitude de **documenter** ces sorties dans un petit rapport (copier/coller dans un fichier texte) aprÃ¨s chaque opÃ©ration sensible. Cela fera une **trace** en cas de problÃ¨me ultÃ©rieur.

---

## 5ï¸âƒ£ Nettoyage / Rollback

Si tout est validÃ© :

```bash
rm sauvegarde_sda.sfdisk
```

Pour revenir en arriÃ¨re :

```bash
sudo sfdisk /dev/sda < sauvegarde_sda.sfdisk
sudo partprobe
sudo resize2fs /dev/sda2
```

ğŸ’¬ **Explications & conseils :**

- Supprimer `sauvegarde_sda.sfdisk` nâ€™est Ã  faire **que lorsque vous Ãªtes sÃ»r** dâ€™Ãªtre satisfait du nouvel Ã©tat. Sur un environnement de prod, vous pouvez garder cette sauvegarde quelque temps.

- La restauration avec `sfdisk /dev/sda < sauvegarde_sda.sfdisk` rÃ©Ã©crit **lâ€™ancienne table de partitions** :
  
  - Cela peut rÃ©trÃ©cir ou modifier des partitions â†’ soyez conscient du risque sur les donnÃ©es si vous lâ€™utilisez aprÃ¨s dâ€™autres manipulations.

- AprÃ¨s restauration :
  
  - `partprobe` informe le noyau des changements.
  
  - `resize2fs` peut Ãªtre nÃ©cessaire pour **rÃ©adapter le systÃ¨me de fichiers** Ã  la taille restaurÃ©e (suivant vos manipulations).

- Astuce : testez la sÃ©quence **â€œcasser â†’ rollbackâ€** sur une VM de labo. Câ€™est un excellent exercice rÃ©el de â€œplan de secoursâ€.

---

## 6ï¸âƒ£ Astuces & plans de secours

| Situation                      | Solution                                                        |
| ------------------------------ | --------------------------------------------------------------- |
| Perte de table                 | Restaurer depuis `sfdisk` ou utiliser `testdisk`.               |
| FS non ext4                    | Utiliser `xfs_growfs /home`.                                    |
| VM Cloud                       | Utiliser `growpart /dev/sda 2` au lieu de `fdisk`.              |
| Impossible de dÃ©monter `/home` | Passer en mode single-user (`systemctl isolate rescue.target`). |

ğŸ’¬ **Explications & conseils supplÃ©mentaires :**

- **`testdisk`** est un outil puissant pour **reconstruire une table de partitions perdue**, mais il demande un peu de pratique : Ã  garder pour les cas de crise.

- Pour `xfs`, le principe est similaire, mais on utilise `xfs_growfs` et **on ne peut agrandir que des systÃ¨mes montÃ©s** (et pas les rÃ©duire).

- `rescue.target` :
  
  - Permet de passer en mode â€œmono-utilisateurâ€ avec un minimum de services, ce qui facilite le dÃ©montage des systÃ¨mes de fichiers.
  
  - Toujours prÃ©venir les utilisateurs avant, car cela impacte la disponibilitÃ© du serveur.

- Sur le Cloud, regardez toujours la **documentation spÃ©cifique du provider** : certains ajoutent des Ã©tapes automatiques ou des restrictions (temps minimal entre deux agrandissements, etc.).

---

## 7ï¸âƒ£ Visualisation de lâ€™opÃ©ration

```mermaid
graph TD
subgraph Etat_initial
A[/dev/sda1 5 Go /]:::blue
B[/dev/sda2 5 Go /home]:::blue
C[/dev/sda3 1 Go swap]:::blue
end
subgraph Espace_libre
D[15 Go non allouÃ©]:::gray
end
subgraph Etat_final
E[/dev/sda2 14 Go /home Ã©tendu]:::green
F[Filesystem ajustÃ© par resize2fs]:::green
end
classDef blue fill:#cce5ff,stroke:#004085;
classDef green fill:#d4edda,stroke:#155724;
classDef gray fill:#e2e3e5,stroke:#383d41;
```

**LÃ©gende :**  
ğŸ”µ Blocs bleus = Ã©tat initialâ€ƒğŸŸ¢ verts = Ã©tat finalâ€ƒâšª gris = espace libre avant extension

ğŸ’¬ **Explications & conseils :**

- Cette vue simplifiÃ©e vous aide Ã  **raconter lâ€™histoire** de lâ€™opÃ©ration Ã  un stagiaire ou Ã  un collÃ¨gue :
  
  - On part dâ€™un disque partagÃ© en petites tranches,
  
  - On ajoute de lâ€™espace libre,
  
  - On â€œÃ©tireâ€ la partition `/home` dans cet espace,
  
  - Puis on agrandit le systÃ¨me de fichiers lui-mÃªme.

- Utilisez ce type de schÃ©ma dans vos supports de formation pour aider les dÃ©butants Ã  comprendre ce qui est purement **logique** (table de partitions) et ce qui est **liÃ© aux fichiers** (systÃ¨me de fichiers).

---

## 8ï¸âƒ£ RÃ©sumÃ© des bonnes pratiques

1. **Sauvegarder avant dâ€™agir** (`sfdisk`, snapshot VM).

2. **Toujours vÃ©rifier lâ€™intÃ©gritÃ©** avec `e2fsck`.

3. **Ã‰tendre partition â†’ puis systÃ¨me de fichiers**.

4. **VÃ©rifier le rÃ©sultat** (`df -hT`, `tune2fs`).

5. **Nettoyer les sauvegardes** aprÃ¨s validation.

ğŸ’¬ **Conseils finaux :**

- EntraÃ®nez-vous au moins **2 ou 3 fois** sur des VM jetables avant de faire la manipulation sur un vrai serveur.

- Documentez chaque opÃ©ration dans un **journal dâ€™admin** (date, commandes, rÃ©sultats) : cela vous sert de support de cours et de trace en prod.

- Faites toujours relire votre plan Ã  un collÃ¨gue ou Ã  un stagiaire avancÃ© : câ€™est un bon prÃ©texte pour expliquer la logique et vÃ©rifier que vous maÃ®trisez chaque Ã©tape.
