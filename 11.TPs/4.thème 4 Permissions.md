\# 🛡️ Thème 4 — Permissions (Partie A : 30 exercices pratiques)



---



\### Exercice 1 — Vérifier et comprendre les permissions d’un fichier



\*\*Énoncé :\*\* Inspectez `/etc/passwd` et expliquez chaque champ de `ls -l` (rwxr-xr-x) pour ce fichier.

\*\*Démarche :\*\*



```bash

ls -l /etc/passwd

stat /etc/passwd

```



\*\*Résultat attendu :\*\* Compréhension de `rwx` pour owner, group, others ; owner (root), group (root).

\*\*Conseils :\*\*



\* Utilisez `stat` pour obtenir UID/GID et timestamps.

\* Apprenez la correspondance symbolique ↔ octale (r=4, w=2, x=1).

&nbsp; \*\*Astuces :\*\*

\* `namei -l /chemin/fichier` décompose le chemin et affiche perms chaque segment.

\* `getfacl` montre ACL éventuelles.

&nbsp; \*\*Pièges à éviter :\*\*

\* Ne pas modifier `/etc/passwd` sans sauvegarde.

\* Confondre perm de répertoire et perm de fichier (x pour traverser).



---



\### Exercice 2 — Conversion symbolique ↔ octale



\*\*Énoncé :\*\* Convertissez `chmod u=rw,g=r,o=` en mode octal et appliquez sur un fichier de test.

\*\*Démarche :\*\*



```bash

touch test\_perm \&\& chmod u=rw,g=r,o= test\_perm

stat -c '%A %a %n' test\_perm

```



\*\*Résultat attendu :\*\* Permissions `rw-r-----` = octal `640`.

\*\*Conseils :\*\*



\* Mémorisez petites tables : r=4,w=2,x=1.

&nbsp; \*\*Astuces :\*\*

\* `chmod 640 file` équivaut à `chmod u=rw,g=r,o= file`.

&nbsp; \*\*Pièges :\*\*

\* Utiliser `chmod 0640` vs `chmod 640` : souvent identiques, mais octal à 4 chiffres inclut setuid/setgid/sticky.



---



\### Exercice 3 — Changer propriétaire et groupe avec sécurité



\*\*Énoncé :\*\* Changez owner de `/tmp/projet` vers `deploy`, groupe `web`, en testant d’abord les effets.

\*\*Démarche :\*\*



```bash

sudo mkdir -p /tmp/projet

sudo useradd -M deploy  # si nécessaire en test

sudo groupadd web       # si nécessaire en test

sudo chown deploy:web /tmp/projet

ls -ld /tmp/projet

```



\*\*Résultat attendu :\*\* owner `deploy`, group `web`.

\*\*Conseils :\*\*



\* Toujours vérifier avec `ls -ld` avant et après.

&nbsp; \*\*Astuces :\*\*

\* `chown --from=olduser:oldgroup newuser:newgroup file` pour sécurité.

&nbsp; \*\*Pièges :\*\*

\* `chown -R` sur `/` ou sur des dossiers système = catastrophe.



---



\### Exercice 4 — SetUID (suid) concret et dangereux



\*\*Énoncé :\*\* Étudiez un binaire setuid (ex: `/usr/bin/passwd`) et testez comportement en test avec un binaire simulé C (setuid root).

\*\*Démarche (simulation en VM safe) :\*\*



```bash

\# C: small suid demo (ne faites PAS sur prod)

cat > demo\_suid.c <<'C' 

\#include <stdio.h>

\#include <stdlib.h>

\#include <unistd.h>

int main(){ setuid(0); system("/bin/sh"); return 0; }

C

gcc demo\_suid.c -o demo\_suid

sudo chown root:root demo\_suid

sudo chmod 4755 demo\_suid

./demo\_suid

```



\*\*Résultat attendu :\*\* remarque sur élévation si binaire vulnérable.

\*\*Conseils :\*\*



\* Ne jamais placer scripts interprétés en setuid (bash, python) — système les ignore ou les rend dangereux.

&nbsp; \*\*Astuces :\*\*

\* `find / -perm -4000 -type f 2>/dev/null` liste setuid existants.

&nbsp; \*\*Pièges :\*\*

\* Ne pas rendre des programmes écrits par vous-mêmes setuid root si non audités — backdoor potentiel.



---



\### Exercice 5 — SetGID sur répertoire pour partage collaboratif



\*\*Énoncé :\*\* Configurez `/srv/projet` pour que les fichiers créés héritent du groupe `projet`.

\*\*Démarche :\*\*



```bash

sudo groupadd projet

sudo mkdir -p /srv/projet

sudo chown :projet /srv/projet

sudo chmod 2775 /srv/projet   # setgid bit = leading 2

```



\*\*Résultat attendu :\*\* fichiers créés auront GID `projet`.

\*\*Conseils :\*\*



\* Combinez avec `umask` recommandé (e.g., 002) pour que groupe ait write.

&nbsp; \*\*Astuces :\*\*

\* `stat -c '%A %g %G' /srv/projet` pour vérifier.

&nbsp; \*\*Pièges :\*\*

\* Oublier `2` (setgid) et constater que les fichiers prennent le groupe primaire de l’utilisateur.



---



\### Exercice 6 — Sticky bit sur /tmp et dossiers partagés



\*\*Énoncé :\*\* Expliquez pourquoi `/tmp` a sticky bit et appliquez sticky sur `/srv/shared`. Testez suppression par autre utilisateur.

\*\*Démarche :\*\*



```bash

sudo mkdir -p /tmp/testshared

sudo chmod 1777 /tmp/testshared

\# as user1 create file; as user2 try rm -> fails

```



\*\*Résultat attendu :\*\* seul owner peut supprimer son fichier.

\*\*Conseils :\*\*



\* Sticky bit = 1xxx en octal ; protège fichiers dans dir world-writable.

&nbsp; \*\*Astuces :\*\*

\* `ls -ld /tmp` pour voir `drwxrwxrwt`.

&nbsp; \*\*Pièges :\*\*

\* Penser que sticky bit protège le contenu des fichiers (non) — il empêche seulement suppression par autres.



---



\### Exercice 7 — umask per-user et par service



\*\*Énoncé :\*\* Comparez umask d’un utilisateur normal, d’un service systemd et d’un cron job.

\*\*Démarche :\*\*



```bash

\# utilisateur

umask

\# cron (dans crontab): \* \* \* \* \* umask 027; echo $(umask) > /tmp/cron\_umask.txt

\# systemd: systemctl cat monservice | grep -i Umask

```



\*\*Résultat attendu :\*\* compréhension que umask peut être différent selon contexte.

\*\*Conseils :\*\*



\* Fixez umask global dans `/etc/profile` ou par service unit.

&nbsp; \*\*Astuces :\*\*

\* systemd units acceptent `UMask=` directive.

&nbsp; \*\*Pièges :\*\*

\* Croire que umask system-wide s’applique aux services gérés par systemd (par défaut non).



---



\### Exercice 8 — Détecter fichiers world-writable dangereux



\*\*Énoncé :\*\* Trouvez tous les fichiers world-writable sous `/var/www` et listez propriétaires.

\*\*Démarche :\*\*



```bash

sudo find /var/www -type f -perm -002 -ls

```



\*\*Résultat attendu :\*\* liste des fichiers avec `-rw-rw-rw-`.

\*\*Conseils :\*\*



\* Corriger en `chmod o-w` sur fichiers sensibles.

&nbsp; \*\*Astuces :\*\*

\* `-perm -o=w` équivalent.

&nbsp; \*\*Pièges :\*\*

\* Ignorer répertoires qui doivent rester world-writable (ex: /tmp) ; vérifier contexte.



---



\### Exercice 9 — Utiliser find + exec pour corriger permissions en masse (sûrement)



\*\*Énoncé :\*\* Remettez à 644 tous les .php dans un site, et 755 pour répertoires, sans casser liens ni fichiers spéciaux.

\*\*Démarche :\*\*



```bash

sudo find /var/www/site -type f -name "\*.php" -exec chmod 644 {} +

sudo find /var/www/site -type d -exec chmod 755 {} +

```



\*\*Résultat attendu :\*\* fichiers PHP lisibles, dirs traversables.

\*\*Conseils :\*\*



\* Testez d’abord avec `-print` avant `-exec`.

&nbsp; \*\*Astuces :\*\*

\* Utiliser `-maxdepth` pour limiter portée pendant tests.

&nbsp; \*\*Pièges :\*\*

\* `chmod -R` imprudent : peut modifier permissions binaires.



---



\### Exercice 10 — Permissions étendues : POSIX ACLs (setfacl/getfacl) basiques



\*\*Énoncé :\*\* Donnez à l’utilisateur `dev1` accès en écriture sur `/srv/projet` sans changer le groupe.

\*\*Démarche :\*\*



```bash

sudo setfacl -m u:dev1:rwx /srv/projet

getfacl /srv/projet

```



\*\*Résultat attendu :\*\* `user:dev1:rwx` visible.

\*\*Conseils :\*\*



\* Vérifiez que FS supporte ACL (`tune2fs -l` ou mount options).

&nbsp; \*\*Astuces :\*\*

\* `setfacl -R -m ...` pour propager.

&nbsp; \*\*Pièges :\*\*

\* Ne pas oublier `setfacl -b` pour nettoyer si vous avez fait des erreurs.



---



\### Exercice 11 — ACLs par défaut pour hériter sur nouveaux fichiers



\*\*Énoncé :\*\* Configurez une ACL par défaut pour que tous les nouveaux fichiers du dossier héritent d’un droit pour `devgroup`.

\*\*Démarche :\*\*



```bash

sudo setfacl -d -m g:devgroup:rwx /srv/projet

getfacl /srv/projet

```



\*\*Résultat attendu :\*\* `default:group:devgroup:rwx`.

\*\*Conseils :\*\*



\* Mélanger setgid+default ACL pour comportement stable.

&nbsp; \*\*Astuces :\*\*

\* `getfacl -R` pour vérifier récursivement.

&nbsp; \*\*Pièges :\*\*

\* Confusion entre ACLs effectives et ACLs par défaut.



---



\### Exercice 12 — Retirer ACLs et restaurer permissions de base



\*\*Énoncé :\*\* Nettoyez les ACLs d’un répertoire et restaurez les perms à `rwxr-x---`.

\*\*Démarche :\*\*



```bash

sudo setfacl -bR /srv/projet

sudo chmod -R 750 /srv/projet

```



\*\*Résultat attendu :\*\* ACLs effacées et perms appliquées.

\*\*Conseils :\*\*



\* Faire une sauvegarde avant (`getfacl -R > acl\_backup.txt`).

&nbsp; \*\*Astuces :\*\*

\* Restaurer par parsing du backup si besoin.

&nbsp; \*\*Pièges :\*\*

\* Perdre ACL utiles en nettoyant brutalement.



---



\### Exercice 13 — chattr et attribut immutable (+i)



\*\*Énoncé :\*\* Protégez un fichier de configuration critique (`/etc/myapp.conf`) pour empêcher toute modification, même par root (sauf via chattr).

\*\*Démarche :\*\*



```bash

sudo touch /etc/myapp.conf

sudo chattr +i /etc/myapp.conf

lsattr /etc/myapp.conf

\# Pour modifier ensuite: sudo chattr -i /etc/myapp.conf

```



\*\*Résultat attendu :\*\* `i` présent dans `lsattr`.

\*\*Conseils :\*\*



\* Utilisez avec parcimonie ; `+i` bloque même `rm`.

&nbsp; \*\*Astuces :\*\*

\* `chattr` nécessite système de fichiers ext\\\*.

&nbsp; \*\*Pièges :\*\*

\* Oublier qu’on a mis +i et s’étonner que config n’applique pas les changements.



---



\### Exercice 14 — chattr +a (append-only) pour logs



\*\*Énoncé :\*\* Configurez un fichier de log pour n’accepter que des append (utile pour journaux immuables).

\*\*Démarche :\*\*



```bash

sudo touch /var/log/secure\_append.log

sudo chattr +a /var/log/secure\_append.log

lsattr /var/log/secure\_append.log

```



\*\*Résultat attendu :\*\* `a` visible ; fichiers ne peuvent être écrasés.

\*\*Conseils :\*\*



\* Combinez append-only avec rotation contrôlée.

&nbsp; \*\*Astuces :\*\*

\* `logrotate` doit être configuré pour manipuler ces fichiers (stop/start ou chattr -a).

&nbsp; \*\*Pièges :\*\*

\* Rotation automatique échouera si vous n’enlevez pas `a`.



---



\### Exercice 15 — Capabilités POSIX (setcap) pour binaire non-root



\*\*Énoncé :\*\* Donnez au binaire `tcpdump` la capacité de capturer sans rendre le binaire setuid root.

\*\*Démarche :\*\*



```bash

sudo setcap cap\_net\_raw,cap\_net\_admin+ep /usr/sbin/tcpdump

getcap /usr/sbin/tcpdump

```



\*\*Résultat attendu :\*\* `cap\_net\_raw,cap\_net\_admin+ep`.

\*\*Conseils :\*\*



\* Préferez capabilities aux setuid quand possible.

&nbsp; \*\*Astuces :\*\*

\* `getpcaps <pid>` montre capabilities en runtime.

&nbsp; \*\*Pièges :\*\*

\* Capabilities mal posées = failles potentielles.



---



\### Exercice 16 — Réparer permissions après copie depuis Windows/ZIP



\*\*Énoncé :\*\* Vous avez extrait un ZIP sur serveur et tout est `-rwxrwxrwx`. Réparez en appliquant 755 pour répertoires, 644 pour fichiers.

\*\*Démarche :\*\*



```bash

sudo find /srv/app -type d -exec chmod 755 {} +

sudo find /srv/app -type f -exec chmod 644 {} +

```



\*\*Résultat attendu :\*\* perms raisonnables.

\*\*Conseils :\*\*



\* Toujours tester sur subset d’abord.

&nbsp; \*\*Astuces :\*\*

\* `file` détecte binaires ; pour binaires appliquez 755.

&nbsp; \*\*Pièges :\*\*

\* rater les fichiers exécutables nécessaires (scripts) si on force 644 partout.



---



\### Exercice 17 — SFTP vs FTP : permissions et umask côté serveur



\*\*Énoncé :\*\* Configurez un utilisateur SFTP chrooté et assurez-vous que permissions du chroot respectent sécurité.

\*\*Démarche (résumé) :\*\*



\* Dans `/etc/ssh/sshd\_config` : `Match Group sftpusers` → `ChrootDirectory /srv/sftp/%u` etc.

\* Le chroot dir \*\*doit\*\* être owned by root\\:root et non writable by others.

&nbsp; \*\*Résultat attendu :\*\* utilisateur peut sftp mais pas écrire dans chroot racine ; écriture possible dans `uploads/` si chown correct.

&nbsp; \*\*Conseils :\*\*

\* Placez uploads dans sous-dossier owned by user.

&nbsp; \*\*Astuces :\*\*

\* `chmod 755 /srv/sftp` ; `mkdir /srv/sftp/user/uploads \&\& chown user:user /srv/sftp/user/uploads`.

&nbsp; \*\*Pièges :\*\*

\* Mettre chroot owned by user → SSHD refuse la connexion.



---



\### Exercice 18 — Samba \& permissions Windows ↔ Linux



\*\*Énoncé :\*\* Configurez partage Samba pour que les utilisateurs Windows créent des fichiers qui conservent groupe `smbgroup` et perms 770.

\*\*Démarche (smb.conf snippet) :\*\*



```ini

\[projet]

&nbsp;path = /srv/projet

&nbsp;create mask = 0770

&nbsp;directory mask = 2770

&nbsp;force group = smbgroup

```



\*\*Résultat attendu :\*\* fichiers créés via SMB appartiennent au groupe forcé.

\*\*Conseils :\*\*



\* Mettez `force user` si besoin.

&nbsp; \*\*Astuces :\*\*

\* Combinez avec setgid sur le répertoire.

&nbsp; \*\*Pièges :\*\*

\* Confondre masks samba et chmod locaux — testez.



---



\### Exercice 19 — NFS mount \& root\\\_squash / no\\\_root\\\_squash



\*\*Énoncé :\*\* Montez un export NFS et testez `root\_squash` vs `no\_root\_squash`.

\*\*Démarche :\*\*



\* Exporter `/export` avec `rw,sync,root\_squash` dans `/etc/exports`.

\* Sur client, vérifier UID 0 maps to `nobody` (squashed).

&nbsp; \*\*Résultat attendu :\*\* root sur client n’a pas root droit si `root\_squash`.

&nbsp; \*\*Conseils :\*\*

\* Préférer `root\_squash` pour sécurité.

&nbsp; \*\*Astuces :\*\*

\* `showmount -e server` liste exports.

&nbsp; \*\*Pièges :\*\*

\* `no\_root\_squash` sur shares sensibles = risque d’escalade.



---



\### Exercice 20 — Restaurer permissions depuis backup tar avec sauvegarde des ownerships



\*\*Énoncé :\*\* Déployez un tar contenant propriétaires et perms et restaurez-le correctement.

\*\*Démarche :\*\*



```bash

sudo tar -xpvf backup.tar -C /srv/restore

\# options: p = preserve perms, v verbose

```



\*\*Résultat attendu :\*\* owners et perms préservés.

\*\*Conseils :\*\*



\* Utiliser `--numeric-owner` si les UIDs ne correspondent pas entre systèmes.

&nbsp; \*\*Astuces :\*\*

\* `tar --same-owner` si root.

&nbsp; \*\*Pièges :\*\*

\* Restaurer un tar d’un autre host sans vérifier UIDs → ownership incorrect.



---



\### Exercice 21 — Detecter trous de permission avec audit



\*\*Énoncé :\*\* Créez une règle auditd pour surveiller changements sur `/etc/sudoers` et `/etc/sudoers.d`.

\*\*Démarche (exemple) :\*\*



```bash

sudo auditctl -w /etc/sudoers -p wa -k sudoers\_changes

sudo ausearch -k sudoers\_changes

```



\*\*Résultat attendu :\*\* logs d’écriture/attributs modifiés.

\*\*Conseils :\*\*



\* Configurez `auditd` pour production.

&nbsp; \*\*Astuces :\*\*

\* `ausearch` / `aureport` pour rapports.

&nbsp; \*\*Pièges :\*\*

\* Trop de rules peut générer du bruit ; ciblez précisément.



---



\### Exercice 22 — Fichiers setgid vs setuid : audit et listage



\*\*Énoncé :\*\* Lister tous fichiers setgid et expliquer risques.

\*\*Démarche :\*\*



```bash

sudo find / -perm -2000 -type f -ls 2>/dev/null  # setgid

sudo find / -perm -4000 -type f -ls 2>/dev/null  # setuid

```



\*\*Résultat attendu :\*\* inventaire setuid/setgid.

\*\*Conseils :\*\*



\* Vérifiez chaque binaire pour vulnérabilité exploitables.

&nbsp; \*\*Astuces :\*\*

\* Gérer liste via CM (Ansible) en prod.

&nbsp; \*\*Pièges :\*\*

\* Ignorer scripts setuid (souvent non supportés) mais présents.



---



\### Exercice 23 — Permissions pour scripts cron



\*\*Énoncé :\*\* Assurez-vous que les scripts exécutés par cron ne sont pas world-writable et appartiennent au bon owner.

\*\*Démarche :\*\*



```bash

ls -l /etc/cron.\* /var/spool/cron/crontabs

\# Corriger

sudo chmod 700 /etc/cron.daily/monscript

sudo chown root:root /etc/cron.daily/monscript

```



\*\*Résultat attendu :\*\* scripts sécurisés.

\*\*Conseils :\*\*



\* Cron ignore certains scripts non-exécutables.

&nbsp; \*\*Astuces :\*\*

\* `run-parts` n’exécute que fichiers sans extension sur Debian.

&nbsp; \*\*Pièges :\*\*

\* Déployer scripts via SFTP avec perms incorrects → cron n’exécute pas.



---



\### Exercice 24 — Debug permission denied pour service systemd



\*\*Énoncé :\*\* Un service ne démarre pas : `Permission denied` sur /var/run/my.sock. Diagnostiquez.

\*\*Démarche :\*\*



\* `journalctl -u myservice`

\* `ls -l /var/run/my.sock`

\* Vérifier owner/groupe, umask du service unit (`UMask=`), `ProtectSystem=` ou `ReadOnlyPaths=` directives.

&nbsp; \*\*Résultat attendu :\*\* réparer owner/group et redémarrer.

&nbsp; \*\*Conseils :\*\*

\* Préférer `RuntimeDirectory=` in unit file pour créer dir avec bon owner.

&nbsp; \*\*Astuces :\*\*

\* `systemd-analyze verify` pour erreurs unit.

&nbsp; \*\*Pièges :\*\*

\* Penser que c’est une bug app alors que c’est juste un mauvais owner.



---



\### Exercice 25 — Permissions sur exécutables scripts vs binaire



\*\*Énoncé :\*\* Pourquoi rendre un script exécutable n’est pas la même chose que rendre un binaire exécutable ? Démonstration.

\*\*Démarche :\*\*



```bash

echo -e '#!/bin/bash\\necho hello' > s.sh

chmod 755 s.sh

./s.sh   # fonctionne

\# mettre setuid sur script = non recommandé et souvent ignoré

sudo chmod 4755 s.sh

ls -l s.sh

```



\*\*Résultat attendu :\*\* setuid souvent ignoré sur scripts ; danger s’il était appliqué.

\*\*Conseils :\*\*



\* Eviter setuid sur scripts ; wrapper binaire possible si nécessaire.

&nbsp; \*\*Astuces :\*\*

\* Utiliser `sudo` configuré ou capabilities.

&nbsp; \*\*Pièges :\*\*

\* Penser qu’un script setuid élèvera privilèges — souvent non.



---



\### Exercice 26 — Droits sur devices (/dev) et udev



\*\*Énoncé :\*\* Ajoutez un utilisateur au groupe `dialout` pour accéder à `/dev/ttyUSB0` et testez.

\*\*Démarche :\*\*



```bash

sudo usermod -aG dialout developer

ls -l /dev/ttyUSB0

```



\*\*Résultat attendu :\*\* user in `dialout` peut accéder au device après reconnect/login.

\*\*Conseils :\*\*



\* udev gère perms ; privilégiez group mapping.

&nbsp; \*\*Astuces :\*\*

\* `udevadm info -a -n /dev/ttyUSB0` pour règles.

&nbsp; \*\*Pièges :\*\*

\* Oublier de se relogger pour que group membership prenne effet.



---



\### Exercice 27 — Contrôle d’accès via PAM (ex: restrict home dirs)



\*\*Énoncé :\*\* Interdire connexion SSH si home est world-writable (sécurité). Vérifiez `sshd` configuration et test.

\*\*Démarche :\*\*



\* `sshd` impose souvent checks sur `/etc/ssh/sshd\_config` StrictModes yes.

\* Rendre home world-writable et tester login.

&nbsp; \*\*Résultat attendu :\*\* sshd refuse la connexion si StrictModes active.

&nbsp; \*\*Conseils :\*\*

\* Gardez `chmod 700 /home/user`.

&nbsp; \*\*Astuces :\*\*

\* `ssh -vvv` pour debugging.

&nbsp; \*\*Pièges :\*\*

\* Changer StrictModes sans savoir cause problème.



---



\### Exercice 28 — Exporter \& documenter permissions d’un projet (audit)



\*\*Énoncé :\*\* Produisez un rapport CSV des fichiers avec owner, group, perms pour `/srv/projet`.

\*\*Démarche :\*\*



```bash

sudo find /srv/projet -printf '%p,%u,%g,%m\\n' > /tmp/perms\_report.csv

```



\*\*Résultat attendu :\*\* CSV listable dans spreadsheet.

\*\*Conseils :\*\*



\* Ajoutez checksums (md5) si besoin pour intégrité.

&nbsp; \*\*Astuces :\*\*

\* Utilisez `awk`/`python` pour analyser.

&nbsp; \*\*Pièges :\*\*

\* Omettre fichiers cachés si scripts mal faits.



---



\### Exercice 29 — Migration de permissions entre deux serveurs (UID mapping)



\*\*Énoncé :\*\* Vous migrez /home d’un serveur A à B où UIDs diffèrent. Comment préserver/ajuster owners ?

\*\*Démarche :\*\*



\* Exporter `getent passwd` pour mapping, ou utiliser `rsync -a --numeric-ids`.



```bash

sudo rsync -aHAX --numeric-ids /source/ user@target:/dest/

```



\*\*Résultat attendu :\*\* owners préservés si numeric-ids ; sinon reconstruire mapping.

\*\*Conseils :\*\*



\* Préparez mapping user ↔ UID avant migration.

&nbsp; \*\*Astuces :\*\*

\* `tar --numeric-owner` pour tar.

&nbsp; \*\*Pièges :\*\*

\* Perdre ownership ou attribuer files à wrong users.



---



\### Exercice 30 — Défi final (cluster) : cohérence permissions entre nodes



\*\*Énoncé :\*\* Dans un cluster de 3 serveurs partageant NFS, garantissez que `/srv/app` a même owners and ACLs sur tous les nodes ; automatisez vérif.

\*\*Démarche (préconisée) :\*\*



\* Centraliser users via LDAP/AD (UIDs identiques).

\* Déployer script d’audit :



```bash

for host in node1 node2 node3; do ssh $host "getfacl -R /srv/app" > /tmp/acl\_$host.txt; done

\# compare via diff

```



\*\*Résultat attendu :\*\* matching ACL/owners across nodes.

\*\*Conseils :\*\*



\* Utiliser CM (Ansible) pour ensure idempotence.

&nbsp; \*\*Astuces :\*\*

\* `rsync -a` pour synchroniser si nécessaire.

&nbsp; \*\*Pièges :\*\*

\* UID mismatch sans directory service provoque désastre.



---



\# 🔐 Thème 4 — Partie B : 10 exercices dédiés \*\*au fichier sudoers\*\* (utilisateurs \& groupes)



> Ces 10 exercices approfondissent \*\*les paramètres du sudoers\*\* qui affectent les permissions des \*utilisateurs\* et des \*groupes\* : `User\_Alias`, `Runas\_Alias`, `Host\_Alias`, `Cmnd\_Alias`, NOPASSWD, !authenticate, `Defaults` liés aux groupes/users, `sudoers.d` includes, et pièges de sécurité.



---



\### Sudoers Exercice 1 — Lire sudoers en toute sécurité



\*\*Énoncé :\*\* Ouvrez et inspectez `/etc/sudoers` \*uniquement\* avec `visudo`. Expliquez pourquoi.

\*\*Démarche :\*\*



```bash

sudo visudo

\# ou sudo visudo -f /etc/sudoers.d/custom

```



\*\*Résultat attendu :\*\* Compréhension de syntactic checks.

\*\*Conseils :\*\*



\* Toujours modifier avec `visudo` pour éviter syntax error bloquant sudo.

&nbsp; \*\*Astuces :\*\*

\* visudo vérifie la syntaxe et verrouille le fichier.

&nbsp; \*\*Pièges :\*\*

\* Éditer /etc/sudoers directement peut vous verrouiller hors sudo.



---



\### Sudoers Exercice 2 — User\\\_Alias \& Cmnd\\\_Alias pratique



\*\*Énoncé :\*\* Créez alias pour administrateurs et ensemble de commandes courantes, puis autorisez alias.

\*\*Démarche (visudo):\*\*



```

User\_Alias ADMINS = alice, bob

Cmnd\_Alias      SYS = /bin/systemctl, /bin/journalctl

ADMINS ALL = (root) SYS

```



\*\*Résultat attendu :\*\* alice/bob peuvent exécuter SYS cmds avec sudo.

\*\*Conseils :\*\*



\* Groupez commandes répétitives pour lisibilité.

&nbsp; \*\*Astuces :\*\*

\* Testez `sudo -l -U alice`.

&nbsp; \*\*Pièges :\*\*

\* Ne pas restreindre arguments (`/bin/systemctl \*` peut être dangereuse).



---



\### Sudoers Exercice 3 — NOPASSWD usage et risques



\*\*Énoncé :\*\* Ajoutez un utilisateur `deploy` qui peut redémarrer `nginx` sans mot de passe. Évaluez le risque.

\*\*Démarche (visudo):\*\*



```

deploy ALL=(root) NOPASSWD: /bin/systemctl restart nginx

```



\*\*Résultat attendu :\*\* deploy peut redémarrer nginx sans password.

\*\*Conseils :\*\*



\* Restreindre commandes précises ; documenter pourquoi NOPASSWD est nécessaire.

&nbsp; \*\*Astuces :\*\*

\* Utilisez `sudo -l -U deploy` to inspect allowed commands.

&nbsp; \*\*Pièges :\*\*

\* Autoriser scripts shell via NOPASSWD peut être exploité (`/bin/sh` wrapper).



---



\### Sudoers Exercice 4 — Runas\\\_Alias et principe least-privilege



\*\*Énoncé :\*\* Autorisez un service account à exécuter commandes en tant qu’un autre utilisateur non-root (e.g., deployer run as appuser).

\*\*Démarche (visudo):\*\*



```

Runas\_Alias APP = appuser

deploy ALL=(APP) /usr/bin/rsync

```



\*\*Résultat attendu :\*\* deploy peut rsync en tant que appuser, pas root.

\*\*Conseils :\*\*



\* Limitez le Runas à comptes non-privilegés si possible.

&nbsp; \*\*Astuces :\*\*

\* `sudo -u appuser command` simule.

&nbsp; \*\*Pièges :\*\*

\* Autoriser `ALL` dans runas revient à élévation root potentielle.



---



\### Sudoers Exercice 5 — Defaults pour utilisateurs \& groupes



\*\*Énoncé :\*\* Ajoutez un `Defaults` qui enregistre timestamp\\\_timeout=0 pour `interns` group (forcer mot de passe chaque commande).

\*\*Démarche (visudo):\*\*



```

Defaults:%interns timestamp\_timeout=0

```



\*\*Résultat attendu :\*\* membres du group interns doivent saisir passwd à chaque sudo.

\*\*Conseils :\*\*



\* Utiliser Defaults pour renforcer sécurité pour groupes à risque.

&nbsp; \*\*Astuces :\*\*

\* Combinez with `lecture` et `logfile`.

&nbsp; \*\*Pièges :\*\*

\* Defaults mal placés peuvent provoquer erreurs de parsing.



---



\### Sudoers Exercice 6 — Inclus dans /etc/sudoers.d et principe d’ordre



\*\*Énoncé :\*\* Créez `/etc/sudoers.d/deploy` avec règles et vérifiez que `visudo -c` valide. Expliquez ordre d’évaluation.

\*\*Démarche :\*\*



```bash

echo "deploy ALL=(root) /usr/bin/systemctl restart nginx" | sudo tee /etc/sudoers.d/deploy

sudo visudo -c

```



\*\*Résultat attendu :\*\* fichier valide ; règles appliquées.

\*\*Conseils :\*\*



\* Nommez fichiers avec descriptif (`10-deploy`, `90-admin`) si besoin.

&nbsp; \*\*Astuces :\*\*

\* `visudo -cf /etc/sudoers.d/deploy` pour check single file.

&nbsp; \*\*Pièges :\*\*

\* Droits de /etc/sudoers.d doivent être 0440 ; sinon ignored or insecure.



---



\### Sudoers Exercice 7 — Interdire environnement dangereux (env\\\_keep)



\*\*Énoncé :\*\* Testez comment `env\_reset` et `env\_keep` affectent variables (PATH, LD\\\_PRELOAD). Configurez pour bloquer LD\\\_PRELOAD.

\*\*Démarche (visudo):\*\*



```

Defaults env\_reset

Defaults env\_keep += "HOME"

```



\*\*Résultat attendu :\*\* LD\\\_PRELOAD n’est pas conservée — protège contre injection.

\*\*Conseils :\*\*



\* Ne garder que ce qui est nécessaire via env\\\_keep.

&nbsp; \*\*Astuces :\*\*

\* `sudo -E` behavior depends on Defaults.

&nbsp; \*\*Pièges :\*\*

\* Garder PATH utilisateur peut être risqué (path injection).



---



\### Sudoers Exercice 8 — Commandes avec arguments sûrs (CMND\\\_Alias \& sudoers)



\*\*Énoncé :\*\* Autorisez `backup` à exécuter `/usr/bin/rsync` uniquement avec un jeu d’arguments prédéfini.

\\\*\\\*Démarche (visudo):



```

Cmnd\_Alias BACKUP = /usr/bin/rsync -av --delete /srv/data /backup/

backup ALL=(root) NOPASSWD: BACKUP

```



\*\*Résultat attendu :\*\* backup ne peut pas lancer rsync arbitrary args.

\*\*Conseils :\*\*



\* Short-circuit : si l’admin peut modifier script cible, il peut échapper la restriction.

&nbsp; \*\*Astuces :\*\*

\* Wrappez la commande dans un script contrôlé, et autorisez uniquement ce script.

&nbsp; \*\*Pièges :\*\*

\* Autoriser `rsync` sans args = potentiel d’abus.



---



\### Sudoers Exercice 9 — Audit des permissions sudo et remediation



\*\*Énoncé :\*\* Générer rapport des NOPASSWD entries et proposez remédiations.

\*\*Démarche :\*\*



```bash

sudo grep -R "NOPASSWD" /etc/sudoers /etc/sudoers.d || true

```



\*\*Résultat attendu :\*\* liste des occurrences.

\*\*Conseils :\*\*



\* Documenter raison business pour chaque NOPASSWD ; évaluer risques.

&nbsp; \*\*Astuces :\*\*

\* Automatiser revue via script et envoyer rapport aux owners.

&nbsp; \*\*Pièges :\*\*

\* Laisser NOPASSWD en prod sans justification.



---



\### Sudoers Exercice 10 — Défi sécurité : fermer élévation via sudo pour un groupe



\*\*Énoncé :\*\* Le groupe `contractors` a trop de privilèges. Créez règle `Defaults:%contractors !authenticate` → inversez pour forcer authentication et limitez commandes. Testez et proposez rollback.

\*\*Démarche (visudo):\*\*



```

\# retirer !authenticate si présent, forcer auth:

Defaults:%contractors authenticate

\# restreindre commandes:

%contractors ALL=(root) /usr/bin/systemctl status, /usr/bin/journalctl -n 200

```



\*\*Résultat attendu :\*\* contractors doivent s’authentifier et only allowed cmds.

\*\*Conseils :\*\*



\* Toujours tester via `sudo -l -U user`.

&nbsp; \*\*Astuces :\*\*

\* Prévoir un bouton rollback (commenter règle) via orchestrator.

&nbsp; \*\*Pièges :\*\*

\* Mal écrire `%contractor` vs `%contractors` provoque règle inopérante.



---



✅ Voilà les \*\*40 exercices\*\* (30 sur permissions génériques + 10 centrés sudoers). Chaque exercice est conçu pour être \*\*exécuté en environnement de test\*\* et est orienté « cas réel » (déploiement, partage, services, NFS, samba, SFTP, audit).



Si vous voulez, je peux maintenant :



1\. \*\*Générer des scripts prêts\*\* (Ansible/ bash) pour automatiser plusieurs de ces tâches (par exemple la création du répertoire partagé setgid + ACLs + users), ou

2\. \*\*Transformer ces exercices en ateliers pas-à-pas prêt à l’instant (avec validations automatiques)\*\* pour vos sessions de formation (ex : checks `OK/KO` pour chaque étape), ou

3\. \*\*Passer au Thème 5 (Scripts shell)\*\* et produire 20 exercices semblablement détaillés.



