\## ðŸŸ¢ Labo 1 : Service `simple`



Un service `simple` = le processus lancÃ© est celui du service, systemd ne cherche pas de fork.

Exemple : un script qui Ã©crit la date dans un log.



---



\### Ã‰tape 1 : Service simple minimal



\*\*DÃ©marche :\*\*



1\. CrÃ©ez un script `/usr/local/bin/date-writer.sh` :



```bash

\#!/usr/bin/env bash

while true; do

&nbsp; date >> /var/log/date-writer.log

&nbsp; sleep 5

done

```



```bash

sudo chmod +x /usr/local/bin/date-writer.sh

```



2\. CrÃ©ez lâ€™unitÃ© `/etc/systemd/system/date-writer.service` :



```ini

\[Unit]

Description=Service simple qui Ã©crit la date



\[Service]

ExecStart=/usr/local/bin/date-writer.sh

```



3\. Activez \& dÃ©marrez :



```bash

sudo systemctl daemon-reload

sudo systemctl enable --now date-writer.service

```



\*\*Validation :\*\*



```bash

tail -f /var/log/date-writer.log

```



\*\*Astuce :\*\* utilisez `journalctl -u date-writer` pour debug.

\*\*Conseil :\*\* testez le service avant de lâ€™activer au boot.

\*\*PiÃ¨ge :\*\* oublier `daemon-reload` â†’ systemd nâ€™applique pas la nouvelle unit.



---



\### Ã‰tape 2 : ArrÃªt propre



Ajoutons une gestion de `stop`.



\*\*DÃ©marche :\*\*



1\. Ajoutez `ExecStop` :



```ini

\[Service]

ExecStart=/usr/local/bin/date-writer.sh

ExecStop=/bin/kill -TERM $MAINPID

```



2\. Rechargez :



```bash

sudo systemctl daemon-reload

sudo systemctl restart date-writer

```



3\. Testez lâ€™arrÃªt :



```bash

sudo systemctl stop date-writer

```



\*\*Astuce :\*\* `$MAINPID` est automatiquement remplacÃ© par systemd.

\*\*Conseil :\*\* toujours documenter vos `ExecStop`.

\*\*PiÃ¨ge :\*\* sans `ExecStop`, systemd tue le process par dÃ©faut au SIGTERM, mais vos ressources (fichiers, sockets) peuvent rester ouvertes.



---



\### Ã‰tape 3 : RedÃ©marrage automatique



\*\*DÃ©marche :\*\*



```ini

Restart=always

RestartSec=3

```



Ajoutez Ã§a dans `\[Service]`.

Puis :



```bash

sudo systemctl daemon-reload

sudo systemctl restart date-writer

```



\*\*Validation :\*\* `pkill date-writer.sh` â†’ systemd le relance.

\*\*Astuce :\*\* `on-failure` pour ne redÃ©marrer quâ€™en cas dâ€™Ã©chec.

\*\*Conseil :\*\* ajustez `RestartSec` pour Ã©viter un redÃ©marrage en boucle rapide.

\*\*PiÃ¨ge :\*\* oublier de gÃ©rer logs â†’ `/var/log/date-writer.log` peut exploser.



---



\### Ã‰tape 4 : Reload propre



\*\*DÃ©marche :\*\*



1\. Modifiez le script pour Ã©couter `SIGHUP` et recharger une config :



```bash

trap 'echo "Reload config" >> /var/log/date-writer.log' HUP

```



2\. Ajoutez dans lâ€™unitÃ© :



```ini

ExecReload=/bin/kill -HUP $MAINPID

```



\*\*Validation :\*\*



```bash

sudo systemctl reload date-writer

```



Log doit contenir â€œReload configâ€.



\*\*Astuce :\*\* utilisez `trap` pour signaux.

\*\*Conseil :\*\* rÃ©servez `SIGHUP` au rechargement de config.

\*\*PiÃ¨ge :\*\* confondre reload et restart â†’ reload ne doit pas couper le service.



---



\### Ã‰tape 5 : Externaliser la configuration



\*\*DÃ©marche :\*\*



1\. CrÃ©ez `/etc/date-writer.conf` :



```ini

SLEEP=10

```



2\. Modifiez le script :



```bash

\#!/usr/bin/env bash

. /etc/date-writer.conf

while true; do

&nbsp; date >> /var/log/date-writer.log

&nbsp; sleep "$SLEEP"

done

```



\*\*Validation :\*\*



\* Modifiez `SLEEP=2`, puis `systemctl restart date-writer`.



\*\*Astuce :\*\* sÃ©parez toujours code \& config.

\*\*Conseil :\*\* mettez vos confs dans `/etc/monservice/`.

\*\*PiÃ¨ge :\*\* oublier les droits â†’ conf lisible par tout le monde.



---



\### Ã‰tape 6 : Surcharge via `systemctl edit`



\*\*DÃ©marche :\*\*



```bash

sudo systemctl edit date-writer

```



Ajoutez :



```ini

\[Service]

Environment=SLEEP=1

```



Puis `systemctl restart date-writer`.



\*\*Validation :\*\* le log doit dÃ©filer plus vite.

\*\*Astuce :\*\* `systemctl cat` pour voir les unitÃ©s + overrides.

\*\*Conseil :\*\* utilisez overrides plutÃ´t que dâ€™Ã©diter `/etc/systemd/system`.

\*\*PiÃ¨ge :\*\* oublier de supprimer lâ€™override â†’ comportements inattendus.



---



\### Ã‰tape 7 : Packaging et dÃ©ploiement



\*\*DÃ©marche :\*\*



1\. Placez script + conf dans `/usr/local/src/date-writer/`.

2\. CrÃ©ez un paquet `.deb` (via `fpm` par ex.) incluant :



&nbsp;  \* `/usr/local/bin/date-writer.sh`

&nbsp;  \* `/etc/systemd/system/date-writer.service`

&nbsp;  \* `/etc/date-writer.conf`

3\. Installez via `dpkg -i`.



\*\*Astuce :\*\* utilisez `fpm -s dir -t deb ...` pour packager vite.

\*\*Conseil :\*\* versionnez vos services.

\*\*PiÃ¨ge :\*\* copier manuellement sur chaque serveur = chaos â†’ utilisez un outil (Ansible, Puppet).



---



ðŸ‘‰ On peut appliquer \*\*exactement la mÃªme logique Ã©volutive\*\* pour :



\* `oneshot` â†’ script ponctuel (backup, config init), puis enrichi avec `RemainAfterExit`, hooks, packaging.

\* `forking` â†’ dÃ©mon classique (Apache, MySQL), gÃ©rer PIDFile, stop, reload, config, overrides, dÃ©ploiement.

\* `notify` â†’ service qui envoie `READY=1` via `sd\_notify`.

\* `target` â†’ regrouper plusieurs services (`multi-user.target`, custom target).

\* `timer` â†’ remplacer cron (`OnCalendar=...`, `Persistent=true`, logs, random delay).


