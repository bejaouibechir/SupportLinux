\## 🟢 Labo 1 : Service `simple`



Un service `simple` = le processus lancé est celui du service, systemd ne cherche pas de fork.

Exemple : un script qui écrit la date dans un log.



---



\### Étape 1 : Service simple minimal



\*\*Démarche :\*\*



1\. Créez un script `/usr/local/bin/date-writer.sh` :



```bash

\#!/usr/bin/env bash

while true; do

&nbsp; date >> /var/log/date-writer.log

&nbsp; sleep 5

done

```



```bash

sudo chmod +x /usr/local/bin/date-writer.sh

```



2\. Créez l’unité `/etc/systemd/system/date-writer.service` :



```ini

\[Unit]

Description=Service simple qui écrit la date



\[Service]

ExecStart=/usr/local/bin/date-writer.sh

```



3\. Activez \& démarrez :



```bash

sudo systemctl daemon-reload

sudo systemctl enable --now date-writer.service

```



\*\*Validation :\*\*



```bash

tail -f /var/log/date-writer.log

```



\*\*Astuce :\*\* utilisez `journalctl -u date-writer` pour debug.

\*\*Conseil :\*\* testez le service avant de l’activer au boot.

\*\*Piège :\*\* oublier `daemon-reload` → systemd n’applique pas la nouvelle unit.



---



\### Étape 2 : Arrêt propre



Ajoutons une gestion de `stop`.



\*\*Démarche :\*\*



1\. Ajoutez `ExecStop` :



```ini

\[Service]

ExecStart=/usr/local/bin/date-writer.sh

ExecStop=/bin/kill -TERM $MAINPID

```



2\. Rechargez :



```bash

sudo systemctl daemon-reload

sudo systemctl restart date-writer

```



3\. Testez l’arrêt :



```bash

sudo systemctl stop date-writer

```



\*\*Astuce :\*\* `$MAINPID` est automatiquement remplacé par systemd.

\*\*Conseil :\*\* toujours documenter vos `ExecStop`.

\*\*Piège :\*\* sans `ExecStop`, systemd tue le process par défaut au SIGTERM, mais vos ressources (fichiers, sockets) peuvent rester ouvertes.



---



\### Étape 3 : Redémarrage automatique



\*\*Démarche :\*\*



```ini

Restart=always

RestartSec=3

```



Ajoutez ça dans `\[Service]`.

Puis :



```bash

sudo systemctl daemon-reload

sudo systemctl restart date-writer

```



\*\*Validation :\*\* `pkill date-writer.sh` → systemd le relance.

\*\*Astuce :\*\* `on-failure` pour ne redémarrer qu’en cas d’échec.

\*\*Conseil :\*\* ajustez `RestartSec` pour éviter un redémarrage en boucle rapide.

\*\*Piège :\*\* oublier de gérer logs → `/var/log/date-writer.log` peut exploser.



---



\### Étape 4 : Reload propre



\*\*Démarche :\*\*



1\. Modifiez le script pour écouter `SIGHUP` et recharger une config :



```bash

trap 'echo "Reload config" >> /var/log/date-writer.log' HUP

```



2\. Ajoutez dans l’unité :



```ini

ExecReload=/bin/kill -HUP $MAINPID

```



\*\*Validation :\*\*



```bash

sudo systemctl reload date-writer

```



Log doit contenir “Reload config”.



\*\*Astuce :\*\* utilisez `trap` pour signaux.

\*\*Conseil :\*\* réservez `SIGHUP` au rechargement de config.

\*\*Piège :\*\* confondre reload et restart → reload ne doit pas couper le service.



---



\### Étape 5 : Externaliser la configuration



\*\*Démarche :\*\*



1\. Créez `/etc/date-writer.conf` :



```ini

SLEEP=10

```



2\. Modifiez le script :



```bash

\#!/usr/bin/env bash

. /etc/date-writer.conf

while true; do

&nbsp; date >> /var/log/date-writer.log

&nbsp; sleep "$SLEEP"

done

```



\*\*Validation :\*\*



\* Modifiez `SLEEP=2`, puis `systemctl restart date-writer`.



\*\*Astuce :\*\* séparez toujours code \& config.

\*\*Conseil :\*\* mettez vos confs dans `/etc/monservice/`.

\*\*Piège :\*\* oublier les droits → conf lisible par tout le monde.



---



\### Étape 6 : Surcharge via `systemctl edit`



\*\*Démarche :\*\*



```bash

sudo systemctl edit date-writer

```



Ajoutez :



```ini

\[Service]

Environment=SLEEP=1

```



Puis `systemctl restart date-writer`.



\*\*Validation :\*\* le log doit défiler plus vite.

\*\*Astuce :\*\* `systemctl cat` pour voir les unités + overrides.

\*\*Conseil :\*\* utilisez overrides plutôt que d’éditer `/etc/systemd/system`.

\*\*Piège :\*\* oublier de supprimer l’override → comportements inattendus.



---



\### Étape 7 : Packaging et déploiement



\*\*Démarche :\*\*



1\. Placez script + conf dans `/usr/local/src/date-writer/`.

2\. Créez un paquet `.deb` (via `fpm` par ex.) incluant :



&nbsp;  \* `/usr/local/bin/date-writer.sh`

&nbsp;  \* `/etc/systemd/system/date-writer.service`

&nbsp;  \* `/etc/date-writer.conf`

3\. Installez via `dpkg -i`.



\*\*Astuce :\*\* utilisez `fpm -s dir -t deb ...` pour packager vite.

\*\*Conseil :\*\* versionnez vos services.

\*\*Piège :\*\* copier manuellement sur chaque serveur = chaos → utilisez un outil (Ansible, Puppet).



---



👉 On peut appliquer \*\*exactement la même logique évolutive\*\* pour :



\* `oneshot` → script ponctuel (backup, config init), puis enrichi avec `RemainAfterExit`, hooks, packaging.

\* `forking` → démon classique (Apache, MySQL), gérer PIDFile, stop, reload, config, overrides, déploiement.

\* `notify` → service qui envoie `READY=1` via `sd\_notify`.

\* `target` → regrouper plusieurs services (`multi-user.target`, custom target).

\* `timer` → remplacer cron (`OnCalendar=...`, `Persistent=true`, logs, random delay).


