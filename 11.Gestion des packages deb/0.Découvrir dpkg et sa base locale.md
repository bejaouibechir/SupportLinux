Très bien 👨‍🏫  
Voici l’**Atelier 1 – Découvrir `dpkg` et sa base locale**, rédigé intégralement au **format “recette pédagogique complète”** selon votre protocole.  
L’ensemble est exécutable directement sur une **machine Debian ou Ubuntu Server minimale** sans dépendance préalable.

---

# 🧩 Atelier 1 — Découvrir `dpkg` et sa base locale

---

## 🎯 1. Contexte & Objectif

L’objectif de cet atelier est de **comprendre les fondations du gestionnaire de paquets `dpkg`**, utilisé par `apt` et `apt-get`.  
À la fin de l’exercice, le participant saura :

- interroger la base locale de `dpkg`,

- distinguer les fichiers `status`, `available`, `info/`,

- identifier les états d’un paquet (`ii`, `rc`, `un`, etc.),

- et réparer un état incohérent simulé.

---

## 🧰 2. Préparation de l’environnement

Toutes les manipulations se font **sur une machine Debian ou Ubuntu** avec un accès `sudo`.  
Aucune installation supplémentaire n’est requise.

Vérification initiale :

```bash
lsb_release -a
which dpkg
dpkg --version
```

Si la commande `dpkg` n’est pas trouvée, exécutez :

```bash
sudo apt update && sudo apt install dpkg -y
```

---

## 🪜 3. Étapes pas à pas

### 🧾 Étape 1 — Explorer la base locale de `dpkg`

Afficher la liste complète des paquets installés :

```bash
dpkg -l | less
```

> ✅ Résultat attendu : liste des paquets avec 5 colonnes (état, nom, version, architecture, description).

Lister uniquement les premiers 10 paquets :

```bash
dpkg -l | head -n 10
```

---

### 📂 Étape 2 — Observer la structure interne de `/var/lib/dpkg/`

Explorer les fichiers critiques :

```bash
cd /var/lib/dpkg
ls -l
```

> Vous devez voir :  
> `status`, `available`, `lock`, et le dossier `info/`.

Analyser la taille du fichier `status` :

```bash
sudo du -h status
```

---

### 🧩 Étape 3 — Identifier les fichiers associés à un paquet

Exemple avec le paquet `bash` :

```bash
dpkg -L bash
```

> ✅ Résultat attendu : liste complète des fichiers installés par le paquet `bash`.

Découvrir à quel paquet appartient un fichier système :

```bash
dpkg -S /bin/bash
```

---

### ⚙️ Étape 4 — Lire les métadonnées d’un paquet

Afficher les métadonnées :

```bash
dpkg -s bash
```

> Examinez les champs : *Package, Status, Maintainer, Architecture, Description.*

---

### 🧨 Étape 5 — Simuler une incohérence et la réparer

On va **simuler une corruption du fichier `status`** (exercice de diagnostic).

Sauvegarder le fichier :

```bash
sudo cp /var/lib/dpkg/status /var/lib/dpkg/status.bak
```

Simuler une erreur :

```bash
sudo sed -i '1s/^/#CASSÉ /' /var/lib/dpkg/status
```

Essayer d’exécuter :

```bash
dpkg -l
```

> ⚠️ Vous devriez obtenir une erreur du type :
> 
> ```
> dpkg: error: parsing file '/var/lib/dpkg/status' near line 1
> ```

Restaurer et vérifier :

```bash
sudo mv /var/lib/dpkg/status.bak /var/lib/dpkg/status
dpkg -l | head -n 5
```

> ✅ Le problème est corrigé. C’est ainsi que se répare une base corrompue.

---

### 🧠 Étape 6 — Comprendre les états des paquets

Lister tous les états :

```bash
dpkg -l | awk '{print $1}' | sort | uniq -c
```

> Les codes les plus fréquents :
> 
> - `ii` → installé,
> 
> - `rc` → supprimé mais configuration présente,
> 
> - `un` → jamais installé.

---

## 🔍 4. Vérification / Résultats attendus

1. `dpkg -l` fonctionne sans erreur.

2. `dpkg -s bash` retourne les métadonnées du paquet.

3. Le fichier `/var/lib/dpkg/status` a été restauré.

4. Vous êtes capable d’expliquer la signification des codes d’état.

---

## 🧹 5. Nettoyage / Restauration

Rien à désinstaller, mais on s’assure d’avoir un état sain :

```bash
sudo dpkg --audit
sudo dpkg --configure -a
sudo apt update
```

---

## 💡 6. Astuces & Pièges

| Type      | Description                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------- |
| 💡 Astuce | Vous pouvez afficher uniquement les paquets “cassés” avec `dpkg --audit`.                               |
| 💡 Astuce | Le fichier `/var/lib/dpkg/info/` contient un fichier `.list` et un fichier `.md5sums` par paquet.       |
| ⚠️ Piège  | Ne jamais supprimer manuellement le fichier `status`, le système ne pourra plus gérer ses paquets.      |
| ⚠️ Piège  | `dpkg` ne télécharge **jamais** les dépendances — il faut passer par `apt -f install` après une erreur. |

---

## 📈 7. Durée estimée (réaliste terrain)

🕒 **30 minutes** (manipulations incluses)

- 10 min : exploration et explications

- 10 min : tests `dpkg -l`, `dpkg -s`, `dpkg -L`

- 10 min : simulation et réparation d’erreur

---

Souhaitez-vous que je poursuive avec **Atelier 2 — Installation manuelle d’un paquet `.deb`** dans le même format “recette complète” ?


