# üß© Atelier 1 ‚Äî D√©couvrir `dpkg` et sa base locale

---

## üéØ 1. Contexte \& Objectif

`dpkg` est le **c≈ìur du syst√®me de gestion de paquets sous Debian**.

Il agit comme le moteur interne sur lequel `apt` s‚Äôappuie.

Avant d‚Äôutiliser `apt`, il faut comprendre ce que fait r√©ellement `dpkg`.

**Objectif de l‚Äôatelier :**

Apprendre √† :

* Explorer la base locale de `dpkg`,

* Lister, rechercher et inspecter les paquets install√©s,

* Diagnostiquer un probl√®me mineur dans la base `dpkg` et le corriger.

Cet atelier est purement **diagnostic et exploratoire**, sans installation ni suppression de paquets.

---

## üß∞ 2. Pr√©paration de l‚Äôenvironnement

### ‚öôÔ∏è Syst√®me requis

* Debian 12 / Ubuntu 22.04+

* Acc√®s `sudo`

* Connexion Internet non obligatoire

### üîç V√©rifications initiales

```bash
which dpkg

dpkg --version
```

> ‚úÖ Si aucune sortie n‚Äôappara√Æt, installez :

> 

> ```bash
> 
> ```

> sudo apt update \&\& sudo apt install dpkg -y

> ```
> 
> ```

### üß† Observation initiale

`dpkg` fonctionne sans d√©mon ; il lit directement des fichiers dans `/var/lib/dpkg/`.

Nous allons y jeter un ≈ìil, mais **sans modifier quoi que ce soit** au d√©but.

---

## ü™ú 3. √âtapes pas √† pas

---

### üßæ √âtape 1 : Examiner la base locale de dpkg

#### üé¨ Action

```bash
cd /var/lib/dpkg

ls -l
```

#### üß† Explication

Ce r√©pertoire contient la base de donn√©es interne :

* `status` ‚Üí √©tat des paquets install√©s

* `available` ‚Üí ancienne base des paquets disponibles

* `info/` ‚Üí fichiers individuels d√©crivant chaque paquet (`.list`, `.md5sums`, etc.)

#### üß™ Test

Afficher les dix premi√®res lignes du fichier `status` :

```bash
head -n 10 status
```

> Observation : chaque bloc commence par `Package:` et se termine par une ligne vide.

> Ce sont les enregistrements de tous les paquets connus de dpkg.

---

### üìã √âtape 2 : Lister les paquets install√©s

#### üé¨ Action

```bash
dpkg -l | head -n 10
```

#### üß† Explication

* `dpkg -l` affiche la liste compl√®te avec un **code d‚Äô√©tat √† deux lettres** :

&nbsp; * `ii` = install√©,

&nbsp; * `rc` = supprim√© mais fichiers de config pr√©sents,

&nbsp; * `un` = jamais install√©.

#### üí° Variante utile

Rechercher uniquement un paquet :

```bash
dpkg -l | grep bash
```

> Cela permet d‚Äôobserver les informations cibl√©es d‚Äôun paquet.

---

### üîç √âtape 3 : Rechercher √† quel paquet appartient un fichier

#### üé¨ Sc√©nario

Un administrateur trouve un binaire inconnu et veut savoir √† quel paquet il appartient.

#### üíª Commande

```bash
dpkg -S /bin/bash
```

#### üß† Explication

L‚Äôoption `-S` (Search) recherche le propri√©taire d‚Äôun fichier d√©j√† install√©.

> ‚úÖ R√©sultat attendu :

> `/bin/bash: bash`

---

### üìÇ √âtape 4 : Afficher les fichiers install√©s par un paquet

#### üé¨ Action

```bash
dpkg -L bash
```

#### üß† Explication

`-L` (List files) montre tous les fichiers install√©s par le paquet.

> Cela aide √† v√©rifier o√π sont plac√©s les ex√©cutables, manuels et configurations.

#### üß† Observation

Tous les paquets install√©s poss√®dent un fichier `.list` sous `/var/lib/dpkg/info/` :

```bash
ls /var/lib/dpkg/info/bash.list
```

---

### üß© √âtape 5 : Inspecter les m√©tadonn√©es d‚Äôun paquet

#### üé¨ Action

```bash
dpkg -s bash
```

#### üß† Explication

`-s` (Status) lit directement le fichier de m√©tadonn√©es du paquet.

Les champs les plus importants :

* `Package:` nom,

* `Status:` √©tat dans le syst√®me,

* `Maintainer:` auteur,

* `Description:` courte description.

#### üß™ Test compl√©mentaire

Essayez un paquet inexistant :

```bash
dpkg -s paquet-inexistant
```

> ‚úÖ R√©sultat attendu :

> `dpkg-query: package 'paquet-inexistant' is not installed and no information is available`

Ce test d√©montre que `dpkg` ne consulte **que sa base locale**, sans Internet.

---

### ‚ö†Ô∏è √âtape 6 : Simuler une erreur et la r√©parer

#### üé¨ Sc√©nario

Un administrateur a interrompu `dpkg` pendant une mise √† jour.

Nous allons simuler une erreur dans le fichier `status` pour comprendre l‚Äôeffet.

#### üíª Commandes

Sauvegarde :

```bash
sudo cp /var/lib/dpkg/status /var/lib/dpkg/status.bak
```

Simuler une corruption :

```bash
sudo sed -i '1s/^/#CORRUPT-LINE /' /var/lib/dpkg/status
```

Tester :

```bash
dpkg -l
```

> ‚ö†Ô∏è Attendu :

> 

> ```
> 
> ```

> dpkg: error: parsing file '/var/lib/dpkg/status' near line 1

> ```
> 
> ```

#### üß† R√©paration

Restaurer le fichier :

```bash
sudo mv /var/lib/dpkg/status.bak /var/lib/dpkg/status
```

V√©rifier :

```bash
dpkg -l | head
```

> ‚úÖ Sortie √† nouveau fonctionnelle.

#### üîç Validation finale

```bash
sudo dpkg --audit
```

> R√©sultat attendu : ‚ÄúNo packages found matching...‚Äù

---

### üß† √âtape 7 : Visualiser les informations individuelles

Lister les fichiers d‚Äôun paquet directement depuis `info/` :

```bash
ls /var/lib/dpkg/info/ | grep bash
```

Lire le fichier `.list` :

```bash
head -n 5 /var/lib/dpkg/info/bash.list
```

> Observation : ces fichiers constituent les enregistrements de chaque paquet dans la base `dpkg`.

---

## ‚úÖ 4. V√©rification des acquis

* `dpkg -l` fonctionne sans erreur.

* Vous pouvez expliquer les √©tats `ii`, `rc`, `un`.

* Vous savez localiser les fichiers `.list` et comprendre leur r√¥le.

* Vous savez restaurer une base `dpkg` corrompue.

---

## üßπ 5. Nettoyage / Restauration

```bash
sudo rm -f /var/lib/dpkg/status.bak

sudo dpkg --configure -a

sudo dpkg --audit
```

> V√©rifiez qu‚Äôaucune erreur ne subsiste.

---

## üí° 6. Astuces \& Pi√®ges p√©dagogiques

| Type      | Description                                                                                                           |                                                             |

| --------- | --------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- |

| üí° Astuce | `dpkg --get-selections                                                                                                | grep ii` liste uniquement les paquets r√©ellement install√©s. |

| üí° Astuce | `dpkg-query -Wf='${Package} ${Status}\\n'` permet de personnaliser l‚Äôaffichage.                                        |                                                             |

| ‚ö†Ô∏è Pi√®ge  | Ne jamais √©diter `status` avec un √©diteur graphique (risque d‚Äôencodage erron√©).                                       |                                                             |

| ‚ö†Ô∏è Pi√®ge  | Si `/var/lib/dpkg/lock` existe, aucune commande `dpkg` ne fonctionnera. V√©rifiez avec `sudo lsof /var/lib/dpkg/lock`. |                                                             |

---
