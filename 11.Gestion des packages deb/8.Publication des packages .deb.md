# üß± Atelier 7 ‚Äì Publication des paquets `.deb`

## Partie I : d√©p√¥t web interne (HTTP)

---

## üéØ Objectif

Mettre √† disposition le paquet `logpinger` sur un petit d√©p√¥t APT interne accessible via HTTP afin que d‚Äôautres machines du r√©seau puissent l‚Äôinstaller directement avec :

```bash
sudo apt update
sudo apt install logpinger
```

---

## üß∞ Pr√©-requis

- Une machine Debian/Ubuntu (serveur de publication)

- Paquet `nginx` ou `apache2` install√©

- Paquet `.deb` g√©n√©r√© √† l‚Äôatelier pr√©c√©dent : `logpinger_pkg.deb`

---

## ü™ú √âtapes

### 1Ô∏è‚É£ Cr√©er la structure du d√©p√¥t

```bash
sudo mkdir -p /srv/deb-repo
sudo cp ~/lab_logpinger/logpinger_pkg.deb /srv/deb-repo/
cd /srv/deb-repo
```

---

### 2Ô∏è‚É£ G√©n√©rer l‚Äôindex du d√©p√¥t

Le fichier **Packages** est indispensable pour que `apt` reconnaisse le d√©p√¥t.

```bash
sudo apt install dpkg-dev -y
cd /srv/deb-repo
dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
```

Vous devriez obtenir :

```
Packages.gz
logpinger_pkg.deb
```

---

### 3Ô∏è‚É£ Servir le d√©p√¥t via HTTP

Installer un serveur web l√©ger :

```bash
sudo apt install nginx -y
```

Configurer Nginx pour exposer le r√©pertoire du d√©p√¥t.  
Cr√©er le fichier **`/etc/nginx/sites-available/deb-repo.conf`** :

```bash
server {
    listen 80;
    server_name _;

    root /srv/deb-repo;
    autoindex on;
}
```

Activer et red√©marrer le site :

```bash
sudo ln -s /etc/nginx/sites-available/deb-repo.conf /etc/nginx/sites-enabled/
sudo systemctl restart nginx
```

V√©rifier dans un navigateur ou avec `curl` :

```bash
curl http://<IP_SERVEUR>/Packages.gz
```

---

### 4Ô∏è‚É£ Ajouter le d√©p√¥t sur le client

Sur la machine cliente (ou la m√™me si mono-poste) :

Cr√©er le fichier **`/etc/apt/sources.list.d/localrepo.list`** :

```bash
deb [trusted=yes] http://<IP_SERVEUR>/ ./
```

Mettre √† jour la base :

```bash
sudo apt update
```

---

### 5Ô∏è‚É£ Installation du paquet

#### üÖ∞Ô∏è M√©thode 1 : installation directe (locale)

```bash
sudo dpkg -i ~/lab_logpinger/logpinger_pkg.deb
```

#### üÖ±Ô∏è M√©thode 2 : installation via d√©p√¥t APT

```bash
sudo apt update
sudo apt install logpinger
```

R√©sultat attendu :

```
Setting up logpinger (1.0) ...
```

---

### 6Ô∏è‚É£ V√©rification

```bash
logpinger.py      # ou systemctl start logpinger.service
dpkg -l | grep logpinger
```

---

### 7Ô∏è‚É£ Nettoyage (facultatif)

```bash
sudo rm /etc/apt/sources.list.d/localrepo.list
sudo systemctl stop nginx
sudo apt remove --purge nginx -y
sudo rm -rf /srv/deb-repo
```

## Partie II : publication dans **Nexus Repository**

---

## üéØ Objectif

Mettre en place un d√©p√¥t APT h√©berg√© sur **Nexus Repository OSS** pour y publier le paquet `logpinger`.  
Les participants apprendront √† :

- installer et d√©marrer Nexus OSS,

- cr√©er un d√©p√¥t **APT (Debian)**,

- t√©l√©verser leur paquet `.deb`,

- l‚Äôinstaller via `apt install logpinger`,

- et enfin **nettoyer compl√®tement** l‚Äôenvironnement.

---

## üß∞ Pr√©-requis

- Machine Debian 12 / Ubuntu 22.04 avec acc√®s sudo

- Paquet `logpinger_pkg.deb` d√©j√† disponible (issu de l‚Äôatelier 6)

- Ports 8081 ou 8082 libres

- Paquets `openjdk-17-jre`, `wget`, `nginx` installables

---

## ü™ú √âtapes pas √† pas

---

### 1Ô∏è‚É£ Installation de Nexus Repository OSS

#### a) Installer Java 17 (obligatoire)

```bash
sudo apt update
sudo apt install -y openjdk-17-jre
```

#### b) Cr√©er un utilisateur d√©di√©

```bash
sudo useradd -M -r -d /opt/nexus -s /bin/bash nexus
sudo mkdir -p /opt/nexus
sudo chown nexus:nexus /opt/nexus
```

#### c) T√©l√©charger et extraire Nexus OSS

```bash
cd /opt
sudo wget https://download.sonatype.com/nexus/3/latest-unix.tar.gz -O nexus.tar.gz
sudo tar -xzf nexus.tar.gz
sudo mv nexus-3* nexus
sudo chown -R nexus:nexus nexus
```

#### d) Cr√©er le service systemd

Cr√©er le fichier **`/etc/systemd/system/nexus.service`** :

```bash
[Unit]
Description=Nexus Repository OSS
After=network.target

[Service]
Type=forking
User=nexus
Group=nexus
ExecStart=/opt/nexus/bin/nexus start
ExecStop=/opt/nexus/bin/nexus stop
Restart=on-abort
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

Activer et d√©marrer le service :

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now nexus
```

#### e) V√©rifier le service

```bash
sudo systemctl status nexus --no-pager
```

> Si tout va bien, acc√©dez √† : **[http://localhost:8081](http://localhost:8081)**

---

### 2Ô∏è‚É£ Connexion initiale √† l‚Äôinterface Web

1. Ouvrir un navigateur sur  
   üëâ `http://<IP_serveur>:8081`

2. R√©cup√©rer le mot de passe d‚Äôadministration :
   
   ```bash
   sudo cat /opt/nexus/sonatype-work/nexus3/admin.password
   ```

3. Connectez-vous avec :
   
   - **Login :** `admin`
   
   - **Mot de passe :** (ce contenu du fichier ci-dessus)

4. Changez le mot de passe et **d√©sactivez l‚Äôanonymat** si demand√©.

---

### 3Ô∏è‚É£ Cr√©er un d√©p√¥t APT (Debian) dans nexus

1. Dans l‚Äôinterface : *Repositories ‚Üí Create repository ‚Üí apt (hosted)*

2. Donnez un nom, par exemple : **debian-local**

3. Laissez le format en *APT* et *Hosted*

4. Choisissez :
   
   - Deployment policy : **Allow redeploy** (pour tests)
   
   - Distribution : **stable**
   
   - Components : **main**

5. Cliquez sur **Create repository**

---

### 4Ô∏è‚É£ T√©l√©verser le paquet `.deb`

#### Option 1 : via l‚Äôinterface web

- Ouvrir le d√©p√¥t **debian-local**, onglet **Upload**

- S√©lectionner :
  
  - **Asset type** : *Debian package (.deb)*
  
  - **Component** : `main`
  
  - **Distribution** : `stable`

- Choisir le fichier `logpinger_pkg.deb`

- Cliquer sur **Upload**

#### Option 2 : via curl (alternative)

```bash
curl -u admin:<motdepasse> \
  --upload-file logpinger_pkg.deb \
  http://<IP_serveur>:8081/repository/debian-local/
```

---

### 5Ô∏è‚É£ Tester l‚Äôinstallation depuis un client

Sur la machine cliente (ou la m√™me) :

Cr√©er le fichier **`/etc/apt/sources.list.d/nexus.list`** :

```bash
deb [trusted=yes] http://<IP_serveur>:8081/repository/debian-local/ stable main
```

Mettre √† jour et installer :

```bash
sudo apt update
sudo apt install logpinger
```

> ‚úÖ R√©sultat attendu :
> 
> ```
> Setting up logpinger (1.0) ...
> ```

---

### 6Ô∏è‚É£ V√©rification

```bash
dpkg -l | grep logpinger
logpinger.py
```

ou encore :

```bash
sudo systemctl list-timers | grep logpinger
```

---

### 7Ô∏è‚É£ D√©sinstallation et nettoyage complet

#### a) Supprimer le paquet

```bash
sudo apt remove --purge logpinger -y
```

#### b) D√©sactiver le d√©p√¥t Nexus c√¥t√© client

```bash
sudo rm /etc/apt/sources.list.d/nexus.list
sudo apt update
```

#### c) Arr√™ter et supprimer Nexus c√¥t√© serveur

```bash
sudo systemctl disable --now nexus
sudo rm -rf /opt/nexus /etc/systemd/system/nexus.service
sudo apt remove --purge openjdk-17-jre -y
```

#### d) Nettoyage optionnel des caches APT

```bash
sudo apt autoremove -y && sudo apt clean
```

---

parfait üëå nous abordons maintenant la **Partie III : Publication sur Launchpad PPA**, qui correspond √† un **d√©p√¥t Debian/Ubuntu authentifi√© par cl√© GPG**.  
objectif : publier officiellement (ou semi-officiellement) notre paquet `logpinger.deb` pour qu‚Äôil soit installable par :

```bash
sudo add-apt-repository ppa:moncompte/logpinger
sudo apt update
sudo apt install logpinger
```

## Partie III : Publication sur **Launchpad PPA** (d√©p√¥t sign√© GPG)

---

## üéØ Objectif

D√©couvrir comment transformer notre paquet `logpinger.deb` en **paquet public sign√©**, publi√© sur un **PPA (Private Package Archive)** h√©berg√© par Launchpad (plateforme officielle Ubuntu).

Le participant apprendra √† :

- cr√©er un compte Launchpad et une cl√© GPG,

- associer cette cl√© au compte,

- pr√©parer le paquet au format source,

- l‚Äôenvoyer sur le PPA (`dput`),

- puis tester l‚Äôinstallation via `apt install logpinger`.

---

## üß∞ Pr√©-requis

- Machine Ubuntu (22.04+ recommand√©)

- Compte Launchpad cr√©√© sur [https://launchpad.net/](https://launchpad.net/)

- Paquet binaire `logpinger_pkg.deb` d√©j√† fonctionnel

- Paquets requis : `gnupg`, `dput`, `devscripts`, `dh-make`

---

## ü™ú √âtapes

---

### 1Ô∏è‚É£ Cr√©er et configurer une cl√© GPG

```bash
sudo apt install -y gnupg
gpg --full-generate-key
```

> Type : RSA & RSA  
> Taille : 4096  
> Validit√© : 0 = illimit√©e  
> Nom + email = m√™me adresse que ton compte Launchpad.

Lister l‚Äôempreinte :

```bash
gpg --list-keys
```

Copier la ligne `pub rsa4096/XXXXXXXX` ‚Üí garder `XXXXXXXX` (8 caract√®res).  
Exporter la cl√© publique :

```bash
gpg --armor --export you@example.com > mykey.pub
```

---

### 2Ô∏è‚É£ Enregistrer la cl√© sur Launchpad

1. Connecte-toi √† https://launchpad.net/people/+me

2. Onglet **‚ÄúGPG Keys‚Äù ‚Üí Import a key**

3. Copie le contenu du fichier `mykey.pub`

4. Launchpad enverra un email pour v√©rifier la cl√© ;  
   clique le lien de confirmation.

---

### 3Ô∏è‚É£ Pr√©parer le paquet source pour le PPA

Les PPAs acceptent des **sources**, pas des `.deb` binaires.  
On doit donc convertir notre paquet LogPinger en source Debian.

```bash
sudo apt install -y devscripts dh-make
mkdir ~/ppa_logpinger && cd ~/ppa_logpinger
cp ~/lab_logpinger/logpinger_pkg.deb ./
```

#### a) D√©compresser et structurer

```bash
mkdir logpinger-1.0 && cd logpinger-1.0
dpkg-deb -x ../logpinger_pkg.deb .
dpkg-deb -e ../logpinger_pkg.deb DEBIAN
mv DEBIAN debian
```

#### b) Adapter les fichiers de packaging

Cr√©er le fichier **`debian/changelog`** :

```bash
logpinger (1.0-1) jammy; urgency=medium

  * Initial release (LogPinger package for PPA)

 -- Formateur <formateur@lab>  Thu, 09 Oct 2025 21:00:00 +0200
```

Cr√©er le fichier **`debian/source/format`** :

```bash
3.0 (quilt)
```

Cr√©er le fichier **`debian/control`** :

```bash
Source: logpinger
Section: admin
Priority: optional
Maintainer: Formateur <formateur@lab>
Build-Depends: debhelper-compat (= 13)
Standards-Version: 4.6.0
Homepage: https://launchpad.net/logpinger

Package: logpinger
Architecture: all
Description: Outil Python simple de supervision r√©seau (ping) pour d√©mo PPA.
```

Cr√©er le fichier **`debian/rules`** :

```bash
#!/usr/bin/make -f
%:
    dh $@
```

Rendre ex√©cutable :

```bash
chmod +x debian/rules
```

---

### 4Ô∏è‚É£ Construire le paquet source

```bash
cd ~/ppa_logpinger/logpinger-1.0
debuild -S -sa
```

> R√©sultat :  
> `../logpinger_1.0-1_source.changes`  
> `../logpinger_1.0-1_source.upload`  
> `../logpinger_1.0.orig.tar.gz`

---

### 5Ô∏è‚É£ Configurer `dput` et envoyer sur Launchpad

Cr√©er le fichier **`~/.dput.cf`** :

```bash
[ppa-logpinger]
fqdn = ppa.launchpad.net
method = ftp
incoming = ~<ton_nom_launchpad>/ubuntu/
login = anonymous
allow_unsigned_uploads = 0
```

Envoyer le paquet :

```bash
cd ~/ppa_logpinger
dput ppa-logpinger logpinger_1.0-1_source.changes
```

V√©rifier dans Launchpad ‚Üí `https://launchpad.net/~<nom>/+archive/ubuntu/logpinger`

> Le build d√©marre automatiquement (environ 5‚Äì10 min).

---

### 6Ô∏è‚É£ Installation depuis le PPA

Sur n‚Äôimporte quelle machine Ubuntu :

```bash
sudo add-apt-repository ppa:<nom>/logpinger
sudo apt update
sudo apt install logpinger
```

> ‚úÖ Le paquet provient d√©sormais d‚Äôun d√©p√¥t sign√© GPG h√©berg√© par Launchpad.

---

### 7Ô∏è‚É£ Nettoyage (local)

```bash
sudo rm -rf ~/ppa_logpinger
sudo rm mykey.pub
sudo apt autoremove -y && sudo apt clean
```
