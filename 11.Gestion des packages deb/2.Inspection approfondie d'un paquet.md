# 🧩 Atelier 3 — Inspection approfondie d’un paquet `.deb` (version améliorée)

---

## 🎯 1. Contexte \& Objectif

Avant toute installation, un administrateur système doit **auditer un paquet `.deb` inconnu ou téléchargé manuellement** pour vérifier :

* sa structure interne,

* ses dépendances et scripts,

* son intégrité et son innocuité.

**Objectif de l’atelier :**

* Comprendre la structure d’un paquet `.deb` (control/data).

* Lire et interpréter ses métadonnées.

* Identifier ses fichiers réels et scripts internes.

* Détecter une anomalie ou une corruption avant installation.

---

## 🧰 2. Préparation de l’environnement

### ⚙️ Conditions minimales

* Debian 12 / Ubuntu 22.04

* Accès `sudo`

* Aucun paquet n’a besoin d’être installé

* Dossier de travail isolé :

&nbsp; ```bash

&nbsp; mkdir -p ~/lab\_dpkg\_inspect \&\& cd ~/lab\_dpkg\_inspect

&nbsp; ```

### 📦 Téléchargement d’un paquet pour audit

```bash
sudo apt update

apt download nano
```

> ✅ Vous obtenez un fichier du type `nano\_7.2-1\_amd64.deb`.

---

## 🪜 3. Étapes pas à pas

---

### 🔍 Étape 1 : Identifier le type et la structure du paquet

#### 💻 Action

```bash
file nano\_*.deb
```

#### 🧠 Observation

> `Debian binary package (format 2.0)`

Les paquets `.deb` sont des **archives ar** contenant :

1\. `debian-binary` – version du format

2\. `control.tar.xz` – métadonnées et scripts

3\. `data.tar.xz` – fichiers à installer

#### 💡 Vérification

```bash
ar t nano\_*.deb
```

> ✅ Résultat attendu :

> 

> ```
> 
> ```

> debian-binary

> control.tar.xz

> data.tar.xz

> ```
> 
> ```

#### 🧩 Interprétation

Cette commande prouve que le `.deb` est complet.

S’il manque l’un de ces trois fichiers, l’installation échouera.

---

### 📂 Étape 2 : Extraction et exploration interne

#### 💻 Actions

```bash
mkdir extrait \&\& cd extrait

ar x ../nano\_*.deb

ls -1
```

> Observation : vous voyez les trois composants.

#### 🧠 Explication

`ar` extrait mais ne décompresse pas ; il faut ensuite ouvrir `control.tar.xz` et `data.tar.xz`.

---

### 🧾 Étape 3 : Lecture détaillée du fichier `control`

#### 💻 Extraction

```bash
mkdir control \&\& tar -xf control.tar.* -C control

ls control
```

> ✅ Résultat typique : `control`, `md5sums`, `postinst`, `prerm`, `triggers`.

#### 💻 Lecture du fichier de contrôle

```bash
cat control/control
```

#### 🧠 Analyse du contenu

* `Package:` nom du paquet

* `Version:` numéro complet

* `Architecture:` type du binaire

* `Depends:` dépendances minimales

* `Description:` texte explicatif

#### 💡 Observation

Repérez par exemple :

```
Depends: libc6 (>=2.34), libncursesw6 (>=6)
```

Cela indique que `nano` ne peut être installé sans ces bibliothèques.

---

### 🔐 Étape 4 : Vérifier les sommes et fichiers internes

#### 💻 Actions

```bash
cat control/md5sums | head -n 5
```

#### 🧠 Explication

Chaque ligne contient une somme MD5 et le chemin du fichier dans `data.tar.xz`.

Cela permet à `dpkg` de vérifier l’intégrité après installation.

💡 **Exercice express** :

Comparer une somme :

```bash
grep bin/nano control/md5sums
```

> Cela montre la signature du binaire principal.

---

### 🧩 Étape 5 : Explorer les fichiers installables (`data.tar.xz`)

#### 💻 Action

```bash
mkdir data \&\& tar -xf data.tar.* -C data

tree -L 2 data
```

#### 🧠 Observation

Vous verrez typiquement :

```
data/

├── etc/

│   └── nanorc

├── usr/

│   ├── bin/nano

│   ├── share/

│   └── man/
```

#### 💡 Mini-scenario pratique

Vérifiez la présence du fichier de configuration :

```bash
ls data/etc/nanorc
```

> ✅ Ce fichier sera copié vers `/etc/nanorc` lors de l’installation.

---

### ⚙️ Étape 6 : Lire et interpréter les scripts internes

#### 💻 Action

```bash
cat control/postinst | head -n 10
```

#### 🧠 Observation

Souvent : mise à jour du cache man-page ou création d’un lien symbolique.

#### 💬 Interprétation

Repérez toute commande risquée (`rm`, `chown`, `chmod`) :

> Ce sont des **indicateurs de script potentiellement dangereux**.

---

### 📊 Étape 7 : Utiliser `dpkg-deb` pour audit rapide

#### 💻 Commandes

```bash
cd ..

dpkg-deb --info nano\_*.deb
```

> ✅ Sortie :

> 

> ```
> 
> ```

> new debian package, version 2.0

> Package: nano

> Version: 7.2-1

> Architecture: amd64

> Depends: libc6, libncursesw6

> ```
> 
> ```

```bash
dpkg-deb --contents nano\_*.deb | head -n 5
```

> Liste abrégée des fichiers embarqués.

#### 🔍 Observation

`dpkg-deb` offre le même résultat que l’extraction manuelle — mais plus rapidement.

Comparer avec votre répertoire `data/` pour valider la cohérence.

---

### 🧨 Étape 8 : Simuler une corruption et la détecter

#### 🎬 Scénario

Le fichier `.deb` a été interrompu pendant un transfert.

#### 💻 Commandes

```bash
cp nano\_*.deb test\_corrupt.deb

truncate -s 50k test\_corrupt.deb

dpkg-deb --info test\_corrupt.deb
```

> ⚠️ Erreur attendue :

> 

> ```
> 
> ```

> dpkg-deb: error: archive 'test\_corrupt.deb' has premature member 'control.tar.xz' before 'debian-binary'

> ```
> 
> ```

#### 🧩 Analyse

Ce message confirme une incohérence du format : `debian-binary` n’est pas trouvé au bon emplacement.

💡 Vérifiez avant l’erreur :

```bash
ar p test\_corrupt.deb debian-binary | cat
```

> Vous verrez une lecture tronquée — preuve de corruption réelle.

---

### 🧾 Étape 9 : Vérification d’intégrité complète

#### 💻 Action

```bash
dpkg-deb --showformat='${Package} ${Version} ${Installed-Size}\\n' --show nano\_*.deb
```

> Observation : cette commande montre un résumé formaté.

> Ajoutez un contrôle de taille :

```bash
stat -c%s nano\_*.deb
```

Comparez la taille annoncée et réelle.

---

### 🧠 Étape 10 : Synthèse visuelle de la structure

Réaffichez l’arborescence finale :

```bash
tree -L 1 extrait
```

> ✅ Résumé clair :

> 

> * `control/` → métadonnées + scripts

> * `data/` → fichiers installés

> * `debian-binary` → version du format

---

##✅ 4. Vérification des résultats

1\. Vous pouvez lire et interpréter le contenu d’un `.deb`.

2\. Vous savez repérer les dépendances et scripts internes.

3\. Vous avez validé la cohérence et l’intégrité du paquet.

4\. Vous savez reconnaître les signes d’un paquet corrompu.

---

## 🧹 5. Nettoyage / Restauration

```bash
cd ~

rm -rf ~/lab\_dpkg\_inspect
```

---

## 💡 6. Astuces \& Pièges pédagogiques

| Type      | Description                                                                             |

| --------- | --------------------------------------------------------------------------------------- |

| 💡 Astuce | `dpkg-deb --info` = lecture des métadonnées ; `--contents` = inventaire des fichiers.   |

| 💡 Astuce | Vérifiez les scripts (`postinst`, `prerm`) avant d’installer un paquet inconnu.         |

| 💡 Astuce | `md5sums` permet de comparer chaque fichier après extraction.                           |

| ⚠️ Piège  | Ne jamais exécuter un script extrait manuellement.                                      |

| ⚠️ Piège  | Une taille trop faible du `.deb` (quelques Ko) est souvent signe de transfert corrompu. |

| ⚠️ Piège  | Si le fichier `debian-binary` est absent, le paquet est invalide, même s’il s’extrait.  |
