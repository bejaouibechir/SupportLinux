

# 🧩 Atelier 9 — Analyse et Réparation avancée de la base `dpkg`

---

## 🎯 1. Contexte & Objectif

**Contexte métier :**  
Vous administrez une machine de test dont les installations ont été interrompues (coupure SSH ou disque plein).  
Résultat : `dpkg` ne parvient plus à configurer ni supprimer certains paquets.  
L’objectif est de **diagnostiquer**, **réparer** et **valider** la base `/var/lib/dpkg/`.

**Objectifs pédagogiques :**

- Identifier les fichiers critiques de `dpkg` : `status`, `available`, `info/*.list`, `info/*.md5sums`.

- Simuler une corruption contrôlée et la corriger.

- Utiliser `dpkg --audit`, `--configure`, `--remove`, `--force-*` et `apt-get -f install`.

- Sauvegarder et restaurer la base `dpkg`.

---

## ⚙️ 2. Préparation de l’environnement

### Conditions

- Debian 12 / Ubuntu 22.04

- Accès sudo

- Connexion Internet

### Mise en place

```bash
mkdir -p ~/lab_dpkg_repair && cd ~/lab_dpkg_repair
sudo apt update
sudo apt install -y sl
```

---

## 🪜 3. Étapes pas à pas

---

### 🧩 Étape 1 — Observer l’état normal de la base

```bash
dpkg -l | grep sl
ls /var/lib/dpkg/info | grep sl
sudo dpkg --audit
```

> Observation : aucun avertissement, le paquet `sl` est en état `ii`.

---

### 💥 Étape 2 — Simuler une corruption contrôlée

#### Action : supprimer un fichier de métadonnées

```bash
sudo rm /var/lib/dpkg/info/sl.list
```

#### Observation

```bash
sudo dpkg --verify sl
sudo apt -f install
```

> Résultat attendu :
> 
> ```
> dpkg: warning: file list file for package 'sl' missing
> ...
> Errors were encountered while processing:
> sl
> ```

---

### 🔍 Étape 3 — Analyse des symptômes

| Commande                | Rôle                                   | Résultat attendu                  |
| ----------------------- | -------------------------------------- | --------------------------------- |
| `dpkg --audit`          | signale les paquets à moitié installés | `sl: package partially installed` |
| `dpkg -C`               | idem mais plus verbeux                 | affiche les actions suggérées     |
| `apt list --upgradable` | vérifie cohérence APT                  | affiche `sl` bloqué               |

---

### 🧰 Étape 4 — Réparation manuelle de la base

#### Sauvegarder le fichier `status`

```bash
sudo cp /var/lib/dpkg/status ~/lab_dpkg_repair/status.backup
```

#### Réinstaller le paquet pour recréer les métadonnées

```bash
sudo apt --reinstall install sl
```

> ✅ `/var/lib/dpkg/info/sl.list` recréé automatiquement.

---

### ⚙️ Étape 5 — Cas d’un paquet bloqué en « half-installed »

#### Simulation

```bash
sudo dpkg -r --force-remove-reinstreq sl
```

> Observation : `dpkg` force la suppression d’un paquet cassé.

#### Réinstallation complète

```bash
sudo apt install -y sl
sudo dpkg --configure -a
```

> Retour à l’état `ii`.

---

### 🧩 Étape 6 — Forcer la configuration des paquets en attente

```bash
sudo dpkg --configure -a
```

> Configure tous les paquets non configurés (utile après coupure d’installation).

---

### 🧩 Étape 7 — Manipuler le fichier `status` (en dernier recours)

#### Visualiser le bloc concerné

```bash
grep -A6 "Package: sl" /var/lib/dpkg/status
```

#### Supprimer manuellement le bloc (cas d’un paquet fantôme)

```bash
sudo sed -i '/Package: sl/,/^$/d' /var/lib/dpkg/status
```

> ⚠️ Danger : modification directe réservée aux cas désespérés.

---

### 🧠 Étape 8 — Réparer les liens entre APT et dpkg

```bash
sudo apt-get check
sudo apt-get -f install
```

> APT reconstruit les dépendances et réinstalle les fichiers manquants.

---

### 🧩 Étape 9 — Sauvegarde et restauration préventive

#### Sauvegarde quotidienne (à automatiser plus tard)

```bash
sudo tar czf ~/lab_dpkg_repair/dpkg_backup_$(date +%F).tar.gz /var/lib/dpkg
```

#### Restauration rapide

```bash
sudo tar xzf dpkg_backup_2025-10-08.tar.gz -C /
sudo apt-get check
```

---

### ⚙️ Étape 10 — Validation finale

```bash
sudo dpkg --audit
sudo dpkg --verify sl
dpkg -l | grep sl
```

> ✅ Tous les paquets en état `ii` et aucune erreur.

---

## ✅ 4. Vérification des résultats

1. Vous savez identifier et corriger une corruption de `dpkg`.

2. Vous savez forcer la suppression ou reconfiguration d’un paquet.

3. Vous savez sauvegarder/restaurer la base de métadonnées.

4. Vous avez compris les liens entre `dpkg`, `apt`, et les fichiers `info/`.

---

## 🧹 5. Nettoyage

```bash
sudo apt remove --purge sl -y
sudo apt autoremove -y && sudo apt clean
cd ~ && rm -rf ~/lab_dpkg_repair
```

---

## 💡 6. Astuces & Pièges pédagogiques

| Type      | Description                                                                        |
| --------- | ---------------------------------------------------------------------------------- |
| 💡 Astuce | `dpkg -C` = audit complet + suggestions de réparation.                             |
| 💡 Astuce | Toujours sauvegarder `/var/lib/dpkg/status` avant édition.                         |
| 💡 Astuce | `apt --reinstall install <pkg>` reconstruit les fichiers `.info`.                  |
| ⚠️ Piège  | Modifier `status` sans sauvegarde peut rendre dpkg inopérant.                      |
| ⚠️ Piège  | Éviter `--force-all` : risque de bris de dépendances.                              |
| ⚠️ Piège  | Une coupure pendant `dpkg --configure -a` laisse le système dans un état instable. |


