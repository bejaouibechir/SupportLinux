

# ğŸ§© Atelier 9 â€” Analyse et RÃ©paration avancÃ©e de la base `dpkg`

---

## ğŸ¯ 1. Contexte & Objectif

**Contexte mÃ©tier :**  
Vous administrez une machine de test dont les installations ont Ã©tÃ© interrompues (coupure SSH ou disque plein).  
RÃ©sultat : `dpkg` ne parvient plus Ã  configurer ni supprimer certains paquets.  
Lâ€™objectif est de **diagnostiquer**, **rÃ©parer** et **valider** la base `/var/lib/dpkg/`.

**Objectifs pÃ©dagogiques :**

- Identifier les fichiers critiques de `dpkg` : `status`, `available`, `info/*.list`, `info/*.md5sums`.

- Simuler une corruption contrÃ´lÃ©e et la corriger.

- Utiliser `dpkg --audit`, `--configure`, `--remove`, `--force-*` et `apt-get -f install`.

- Sauvegarder et restaurer la base `dpkg`.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### Conditions

- Debian 12 / Ubuntu 22.04

- AccÃ¨s sudo

- Connexion Internet

### Mise en place

```bash
mkdir -p ~/lab_dpkg_repair && cd ~/lab_dpkg_repair
sudo apt update
sudo apt install -y sl
```

---

## ğŸªœ 3. Ã‰tapes pas Ã  pas

---

### ğŸ§© Ã‰tape 1 â€” Observer lâ€™Ã©tat normal de la base

```bash
dpkg -l | grep sl
ls /var/lib/dpkg/info | grep sl
sudo dpkg --audit
```

> Observation : aucun avertissement, le paquet `sl` est en Ã©tat `ii`.

---

### ğŸ’¥ Ã‰tape 2 â€” Simuler une corruption contrÃ´lÃ©e

#### Action : supprimer un fichier de mÃ©tadonnÃ©es

```bash
sudo rm /var/lib/dpkg/info/sl.list
```

#### Observation

```bash
sudo dpkg --verify sl
sudo apt -f install
```

> RÃ©sultat attendu :
> 
> ```
> dpkg: warning: file list file for package 'sl' missing
> ...
> Errors were encountered while processing:
> sl
> ```

---

### ğŸ” Ã‰tape 3 â€” Analyse des symptÃ´mes

| Commande                | RÃ´le                                   | RÃ©sultat attendu                  |
| ----------------------- | -------------------------------------- | --------------------------------- |
| `dpkg --audit`          | signale les paquets Ã  moitiÃ© installÃ©s | `sl: package partially installed` |
| `dpkg -C`               | idem mais plus verbeux                 | affiche les actions suggÃ©rÃ©es     |
| `apt list --upgradable` | vÃ©rifie cohÃ©rence APT                  | affiche `sl` bloquÃ©               |

---

### ğŸ§° Ã‰tape 4 â€” RÃ©paration manuelle de la base

#### Sauvegarder le fichier `status`

```bash
sudo cp /var/lib/dpkg/status ~/lab_dpkg_repair/status.backup
```

#### RÃ©installer le paquet pour recrÃ©er les mÃ©tadonnÃ©es

```bash
sudo apt --reinstall install sl
```

> âœ… `/var/lib/dpkg/info/sl.list` recrÃ©Ã© automatiquement.

---

### âš™ï¸ Ã‰tape 5 â€” Cas dâ€™un paquet bloquÃ© en Â« half-installed Â»

#### Simulation

```bash
sudo dpkg -r --force-remove-reinstreq sl
```

> Observation : `dpkg` force la suppression dâ€™un paquet cassÃ©.

#### RÃ©installation complÃ¨te

```bash
sudo apt install -y sl
sudo dpkg --configure -a
```

> Retour Ã  lâ€™Ã©tat `ii`.

---

### ğŸ§© Ã‰tape 6 â€” Forcer la configuration des paquets en attente

```bash
sudo dpkg --configure -a
```

> Configure tous les paquets non configurÃ©s (utile aprÃ¨s coupure dâ€™installation).

---

### ğŸ§© Ã‰tape 7 â€” Manipuler le fichier `status` (en dernier recours)

#### Visualiser le bloc concernÃ©

```bash
grep -A6 "Package: sl" /var/lib/dpkg/status
```

#### Supprimer manuellement le bloc (cas dâ€™un paquet fantÃ´me)

```bash
sudo sed -i '/Package: sl/,/^$/d' /var/lib/dpkg/status
```

> âš ï¸ Danger : modification directe rÃ©servÃ©e aux cas dÃ©sespÃ©rÃ©s.

---

### ğŸ§  Ã‰tape 8 â€” RÃ©parer les liens entre APT et dpkg

```bash
sudo apt-get check
sudo apt-get -f install
```

> APT reconstruit les dÃ©pendances et rÃ©installe les fichiers manquants.

---

### ğŸ§© Ã‰tape 9 â€” Sauvegarde et restauration prÃ©ventive

#### Sauvegarde quotidienne (Ã  automatiser plus tard)

```bash
sudo tar czf ~/lab_dpkg_repair/dpkg_backup_$(date +%F).tar.gz /var/lib/dpkg
```

#### Restauration rapide

```bash
sudo tar xzf dpkg_backup_2025-10-08.tar.gz -C /
sudo apt-get check
```

---

### âš™ï¸ Ã‰tape 10 â€” Validation finale

```bash
sudo dpkg --audit
sudo dpkg --verify sl
dpkg -l | grep sl
```

> âœ… Tous les paquets en Ã©tat `ii` et aucune erreur.

---

## âœ… 4. VÃ©rification des rÃ©sultats

1. Vous savez identifier et corriger une corruption de `dpkg`.

2. Vous savez forcer la suppression ou reconfiguration dâ€™un paquet.

3. Vous savez sauvegarder/restaurer la base de mÃ©tadonnÃ©es.

4. Vous avez compris les liens entre `dpkg`, `apt`, et les fichiers `info/`.

---

## ğŸ§¹ 5. Nettoyage

```bash
sudo apt remove --purge sl -y
sudo apt autoremove -y && sudo apt clean
cd ~ && rm -rf ~/lab_dpkg_repair
```

---

## ğŸ’¡ 6. Astuces & PiÃ¨ges pÃ©dagogiques

| Type      | Description                                                                        |
| --------- | ---------------------------------------------------------------------------------- |
| ğŸ’¡ Astuce | `dpkg -C` = audit complet + suggestions de rÃ©paration.                             |
| ğŸ’¡ Astuce | Toujours sauvegarder `/var/lib/dpkg/status` avant Ã©dition.                         |
| ğŸ’¡ Astuce | `apt --reinstall install <pkg>` reconstruit les fichiers `.info`.                  |
| âš ï¸ PiÃ¨ge  | Modifier `status` sans sauvegarde peut rendre dpkg inopÃ©rant.                      |
| âš ï¸ PiÃ¨ge  | Ã‰viter `--force-all` : risque de bris de dÃ©pendances.                              |
| âš ï¸ PiÃ¨ge  | Une coupure pendant `dpkg --configure -a` laisse le systÃ¨me dans un Ã©tat instable. |


