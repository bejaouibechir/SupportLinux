Parfait üë®‚Äçüè´  
Voici la **version enrichie compl√®te de l‚ÄôAtelier 6**, int√©grant l‚Äôensemble des **10 am√©liorations** identifi√©es pr√©c√©demment.  
L‚Äôatelier conserve la structure *recette p√©dagogique compl√®te* et introduit un sc√©nario plus r√©aliste, des visualisations concr√®tes, et des interpr√©tations d√©taill√©es des sorties `dpkg`.

---

# üßπ Atelier 6 ‚Äî Suppression, purge et v√©rification de l‚Äôint√©grit√© des paquets Debian (version enrichie et r√©aliste)

---

## üéØ 1. Contexte & Objectif

Vous g√©rez un serveur de test Debian sur lequel plusieurs outils internes sont r√©guli√®rement install√©s puis retir√©s.  
Certains laissent des **fichiers de configuration r√©siduels** ou **d√©synchronisent la base `dpkg`**.  
Votre mission : **nettoyer proprement le syst√®me** tout en apprenant √† diagnostiquer et r√©parer la base des paquets Debian.

**Objectifs p√©dagogiques :**

- Comprendre les √©tats de paquets (`ii`, `rc`, `un`, etc.)

- Diff√©rencier suppression et purge (`-r` vs `-P`)

- V√©rifier la coh√©rence du syst√®me avec `--audit` et `--verify`

- Identifier et corriger les incoh√©rences dans `/var/lib/dpkg/info/`

---

## ‚öôÔ∏è 2. Pr√©paration de l‚Äôenvironnement

### Conditions minimales

- Debian 12 ou Ubuntu 22.04

- Acc√®s `sudo`

- Connexion Internet

### Mise en place

```bash
mkdir -p ~/lab_dpkg_clean && cd ~/lab_dpkg_clean
sudo apt update
sudo apt install -y cowsay
```

> üß† Pourquoi `cowsay` ?  
> Petit programme visuel, id√©al pour observer un cycle installation/suppression sans impact syst√®me.

---

## ü™ú 3. √âtapes pas √† pas

---

### üß© √âtape 1 ‚Äî Observation de l‚Äô√©tat initial du paquet

#### üíª Commande

```bash
dpkg -l | grep cowsay
```

#### üß† Observation

```
ii  cowsay     3.03+dfsg2-8     all     configurable talking cow
```

| Code | Signification                                      |
| ---- | -------------------------------------------------- |
| `ii` | install√© et configur√© correctement                 |
| `rc` | supprim√© mais fichiers de configuration pr√©sents   |
| `un` | inconnu du syst√®me                                 |
| `iU` | install√© mais non configur√© (souvent apr√®s erreur) |

---

### üß© √âtape 2 ‚Äî Suppression simple du paquet (`-r`)

#### üé¨ Sc√©nario

Vous retirez temporairement le paquet pour lib√©rer de l‚Äôespace.

#### üíª Action

```bash
sudo dpkg -r cowsay
```

#### üß† Observation

```
Removing cowsay (3.03+dfsg2-8) ...
```

#### üí° V√©rification

```bash
dpkg -l | grep cowsay
```

> ‚úÖ R√©sultat attendu :
> 
> ```
> rc  cowsay   3.03+dfsg2-8   all   configurable talking cow
> ```

#### üìä Interpr√©tation

Le paquet est supprim√© (`r`) mais les fichiers de configuration restent (`c`).

---

### ‚öôÔ∏è √âtape 3 ‚Äî Observer les fichiers restants

#### üíª Actions

```bash
sudo find /etc -type f -iname "*cowsay*" || echo "Aucun fichier de config"
```

> Observation : parfois, aucun fichier dans `/etc`, mais les fichiers internes existent encore :

```bash
sudo ls /var/lib/dpkg/info | grep cowsay
```

> ‚úÖ R√©sultat typique :
> 
> ```
> cowsay.list
> cowsay.md5sums
> cowsay.postinst
> cowsay.prerm
> cowsay.postrm
> ```

Ces fichiers contiennent les traces de l‚Äôinstallation pr√©c√©dente.

---

### üß© √âtape 4 ‚Äî Purge compl√®te (`-P`)

#### üé¨ Sc√©nario

Vous souhaitez supprimer **toute trace** du paquet.

#### üíª Commande

```bash
sudo dpkg -P cowsay
```

#### üß† Observation

```
Purging configuration files for cowsay (3.03+dfsg2-8) ...
```

#### üí° V√©rification

```bash
dpkg -l | grep cowsay || echo "Aucune trace du paquet"
sudo ls /var/lib/dpkg/info | grep cowsay || echo "Fichiers info supprim√©s"
```

> ‚úÖ R√©sultat : le paquet et ses fichiers d‚Äô√©tat sont totalement retir√©s.

---

### üîç √âtape 5 ‚Äî Comparer suppression vs purge (visualisation)

| Action           | √âtat du paquet | Fichiers `/var/lib/dpkg/info` |
| ---------------- | -------------- | ----------------------------- |
| `dpkg -r cowsay` | `rc`           | Pr√©sents                      |
| `dpkg -P cowsay` | `un`           | Supprim√©s                     |

---

### ‚öôÔ∏è √âtape 6 ‚Äî V√©rifier la coh√©rence de la base dpkg

#### üíª Commandes

```bash
sudo dpkg --audit
sudo dpkg --verify | grep cowsay || echo "Aucune anomalie d√©tect√©e"
```

#### üß† Explication

- `--audit` : liste les paquets partiellement install√©s ou cass√©s.

- `--verify` : contr√¥le l‚Äôint√©grit√© des fichiers via les sommes MD5.

Si un fichier a √©t√© modifi√© manuellement, `dpkg --verify` renvoie une ligne telle que :

```
??5?????? /usr/games/cowsay
```

| Symbole | Signification                |
| ------- | ---------------------------- |
| `?`     | Champ non v√©rifi√©            |
| `5`     | Somme MD5 modifi√©e           |
| `S`     | Taille chang√©e               |
| `M`     | Mode (permissions) diff√©rent |
| `L`     | Lien symbolique modifi√©      |

---

### üß© √âtape 7 ‚Äî Simuler une incoh√©rence et la corriger

#### üé¨ Sc√©nario

Un fichier du paquet est supprim√© manuellement, mais `dpkg` le croit encore pr√©sent.

#### üíª Commandes

```bash
sudo apt install -y cowsay
sudo rm /usr/games/cowsay
sudo dpkg --verify cowsay
```

> ‚úÖ R√©sultat attendu :
> 
> ```
> ??5?????? /usr/games/cowsay
> ```

#### üß† Analyse

Le caract√®re `5` signale une **diff√©rence de somme de contr√¥le** : le fichier est manquant ou alt√©r√©.

#### ü©π R√©paration

```bash
sudo apt --reinstall install cowsay
sudo dpkg --verify cowsay
```

> ‚úÖ V√©rification :
> 
> ```
> sudo dpkg -s cowsay | grep Status
> Status: install ok installed
> ```

---

### üß© √âtape 8 ‚Äî Observation dans `/var/lib/dpkg/info`

#### üíª Commandes

```bash
ls -l /var/lib/dpkg/info | grep cowsay
cat /var/lib/dpkg/info/cowsay.list | head -n 3
```

#### üß† Interpr√©tation

- `.list` : fichiers install√©s.

- `.md5sums` : empreintes de v√©rification.

- `.postinst` / `.prerm` : scripts de maintenance ex√©cut√©s par `dpkg`.

---

### üß® √âtape 9 ‚Äî Simuler une erreur dans la base dpkg

#### üé¨ Sc√©nario

Un fichier de m√©tadonn√©e `info` est supprim√© manuellement.

#### üíª Action

```bash
sudo rm /var/lib/dpkg/info/cowsay.md5sums
sudo dpkg --verify cowsay
```

> ‚ö†Ô∏è R√©sultat attendu :
> 
> ```
> dpkg: warning: file list file for package 'cowsay' missing; assuming package has no files currently installed
> ```

#### ü©π R√©paration

```bash
sudo apt --reinstall install cowsay
sudo dpkg --audit
```

> ‚úÖ Retour √† un √©tat propre.

---

### ‚öôÔ∏è √âtape 10 ‚Äî Purge finale et contr√¥le terminal

#### üíª Commandes

```bash
sudo dpkg -P cowsay
dpkg --audit
dpkg -l | grep cowsay || echo "Le syst√®me est propre."
```

> ‚úÖ Sortie finale :
> 
> ```
> Aucune anomalie d√©tect√©e.
> ```

---

## ‚úÖ 4. V√©rification des r√©sultats

1. Vous comprenez le r√¥le des √©tats `ii`, `rc`, `un`.

2. Vous savez interpr√©ter les symboles `dpkg --verify`.

3. Vous pouvez r√©parer une incoh√©rence (`--audit`, r√©installation).

4. Vous savez visualiser les traces dans `/var/lib/dpkg/info/`.

---

## üßπ 5. Nettoyage complet

```bash
cd ~
sudo rm -rf ~/lab_dpkg_clean
sudo apt remove --purge cowsay -y
sudo apt autoremove -y && sudo apt clean
```

---

## üí° 6. Astuces & Pi√®ges p√©dagogiques

| Type      | Description                                                                  |
| --------- | ---------------------------------------------------------------------------- |
| üí° Astuce | `dpkg -l                                                                     |
| üí° Astuce | Sauvegardez vos paquets install√©s : `dpkg --get-selections > packages.list`. |
| üí° Astuce | `dpkg --audit` doit toujours √™tre vide apr√®s maintenance.                    |
| ‚ö†Ô∏è Pi√®ge  | Supprimer manuellement un fichier install√© d√©synchronise la base.            |
| ‚ö†Ô∏è Pi√®ge  | Un `dpkg --force-all` mal utilis√© peut casser le syst√®me.                    |
| ‚ö†Ô∏è Pi√®ge  | Ne jamais modifier ou supprimer directement `/var/lib/dpkg/status`.          |


