

# 📦 Atelier 2 — Installation manuelle d’un paquet `.deb` avec `dpkg`

---

## 🎯 1. Contexte & Objectif

`dpkg` est capable d’installer directement un paquet `.deb` sans passer par `apt`.  
Cet atelier montre **comment installer manuellement un paquet téléchargé**, **diagnostiquer une erreur de dépendance**, et **corriger l’installation** à l’aide de `dpkg` et des outils associés.

**Objectifs pédagogiques :**

- Télécharger et inspecter un fichier `.deb`.

- L’installer manuellement avec `dpkg -i`.

- Identifier et réparer une erreur de dépendances.

- Vérifier l’installation et la suppression propre.

---

## 🧰 2. Préparation de l’environnement

### ⚙️ Prérequis système

- Debian 12 / Ubuntu 22.04

- Accès `sudo`

- Connexion Internet active

### 📂 Préparation du répertoire de travail

```bash
mkdir -p ~/lab_dpkg_install && cd ~/lab_dpkg_install
```

### 🔍 Vérifier la disponibilité de `wget`

```bash
which wget || sudo apt install wget -y
```

---

## 🪜 3. Étapes pas à pas

---

### 🧩 Étape 1 — Télécharger un paquet `.deb`

#### 🎬 Scénario

Vous souhaitez installer `htop`, mais sans utiliser `apt`, uniquement avec `dpkg`.

#### 💻 Action

```bash
wget http://ftp.de.debian.org/debian/pool/main/h/htop/htop_3.2.2-2_amd64.deb
```

#### 🧠 Observation

Le fichier `.deb` est un **archive ar** contenant les données du paquet.

Vérifiez :

```bash
file htop_3.2.2-2_amd64.deb
```

> ✅ Résultat attendu : `Debian binary package (format 2.0)`

---

### 📦 Étape 2 — Installer le paquet avec `dpkg`

#### 💻 Action

```bash
sudo dpkg -i htop_3.2.2-2_amd64.deb
```

#### 🧠 Observation

Si toutes les dépendances sont présentes :

> ```
> Setting up htop (3.2.2-2) ...
> Processing triggers for man-db ...
> ```

Si des dépendances manquent :

> ⚠️ Erreur :
> 
> ```
> dpkg: dependency problems prevent configuration of htop
> ```

---

### 🩹 Étape 3 — Corriger une erreur de dépendances

#### 🎬 Scénario

L’installation a échoué car `libncursesw6` est absente (exemple simulé).  
`dpkg` ne résout pas les dépendances automatiquement.

#### 💻 Diagnostic

```bash
sudo dpkg --audit
```

> ✅ Résultat attendu : indique un paquet en état “half-installed”.

#### 💡 Solution corrective

Utilisez `apt` pour réparer les dépendances cassées :

```bash
sudo apt -f install
```

> Explication :  
> `-f` (fix) détecte les paquets partiellement installés via `dpkg` et complète les dépendances manquantes.

#### 🧪 Test

Répétez :

```bash
dpkg -l | grep htop
```

> ✅ Résultat attendu : ligne `ii htop … installed`.

---

### 🔍 Étape 4 — Vérifier l’installation réelle

#### 💻 Action

```bash
dpkg -s htop
```

> Vérifiez le champ `Status: install ok installed`.

Lister les fichiers placés par le paquet :

```bash
dpkg -L htop | head -n 10
```

#### 🧠 Explication

Cette étape confirme la présence physique des fichiers et leur intégration à la base locale de `dpkg`.

---

### 🧨 Étape 5 — Simuler une mauvaise manipulation et réparer

#### 🎬 Scénario

Supposons qu’un utilisateur supprime le binaire à la main :

```bash
sudo rm /usr/bin/htop
```

#### 💻 Diagnostic

```bash
dpkg --verify htop
```

> ✅ Résultat attendu : indique le fichier manquant.  
> Exemple :
> 
> ```
> ??5?????? /usr/bin/htop
> ```

#### 🩹 Réparation

Réinstaller proprement le paquet :

```bash
sudo dpkg -i htop_3.2.2-2_amd64.deb
```

> L’outil détecte le paquet déjà installé et répare le contenu.

---

### 🧰 Étape 6 — Désinstaller le paquet proprement

#### 💻 Action

```bash
sudo dpkg -r htop
```

> Supprime les fichiers binaires, mais garde la configuration.

Vérifier :

```bash
dpkg -l | grep htop
```

> État attendu : `rc` → removed, config-files remain.

#### 🧹 Suppression complète

```bash
sudo dpkg -P htop
```

> État attendu : plus aucune trace dans la base `dpkg`.

---

## 🔎 4. Vérification des résultats

1. Le paquet `.deb` est installé manuellement.

2. Une erreur de dépendance a été réparée.

3. Les fichiers du paquet ont été listés et vérifiés.

4. La suppression complète a été testée avec succès.

---

## 🧹 5. Nettoyage final

```bash
cd ~
rm -rf ~/lab_dpkg_install
sudo apt autoremove -y && sudo apt clean
sudo dpkg --audit
```

> Vérifiez qu’aucun paquet n’est en état “half-installed”.

---

## 💡 6. Astuces & Pièges pédagogiques

| Type      | Description                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------- |
| 💡 Astuce | `dpkg --get-selections                                                                                        |
| 💡 Astuce | `dpkg --configure -a` achève toute installation interrompue.                                                  |
| 💡 Astuce | `dpkg-deb --info *.deb` affiche les métadonnées sans installer le paquet.                                     |
| ⚠️ Piège  | Installer un `.deb` non signé peut casser la cohérence du système (éviter les paquets externes non vérifiés). |
| ⚠️ Piège  | L’option `-i` écrase sans confirmation ; toujours sauvegarder les fichiers critiques                          |


