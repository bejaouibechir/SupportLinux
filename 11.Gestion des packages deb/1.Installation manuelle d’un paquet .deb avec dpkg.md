# ğŸ“¦ Atelier 2 â€” Installation manuelle dâ€™un paquet `.deb` avec `dpkg`

---

## ğŸ¯ 1. Contexte \& Objectif

`dpkg` est capable dâ€™installer directement un paquet `.deb`, sans lâ€™aide dâ€™`apt`.

Ce mode est utile lorsquâ€™on dispose dâ€™un paquet tÃ©lÃ©chargÃ© localement (paquet interne, rÃ©seau isolÃ©, ou dÃ©pÃ´t privÃ©).

**Objectif de lâ€™atelier :**

* Installer un paquet `.deb` manuellement avec `dpkg`.

* InterprÃ©ter les messages dâ€™erreurs et les dÃ©pendances manquantes.

* RÃ©parer une installation partiellement cassÃ©e.

* VÃ©rifier la cohÃ©rence du systÃ¨me aprÃ¨s correction.

---

## ğŸ§° 2. PrÃ©paration de lâ€™environnement

### âš™ï¸ Conditions de test

* Debian 12 / Ubuntu 22.04

* AccÃ¨s `sudo`

* Connexion Internet fonctionnelle

### ğŸ“‚ PrÃ©paration du terrain

```bash
mkdir -p ~/lab\_dpkg\_install \&\& cd ~/lab\_dpkg\_install
```

### ğŸ” VÃ©rification initiale

```bash
which dpkg

dpkg --version
```

### ğŸ’¡ Remarque

Tous les tÃ©lÃ©chargements se feront via `apt download` (plus fiable que des liens directs).

---

## ğŸªœ 3. Ã‰tapes pas Ã  pas

---

### ğŸ§© Ã‰tape 1 â€” TÃ©lÃ©charger un paquet `.deb`

#### ğŸ¬ ScÃ©nario

Un administrateur souhaite installer `htop` manuellement, sans passer par `apt install`.

#### ğŸ’» Action

```bash
sudo apt update

apt download htop
```

#### ğŸ§  Observation

Un fichier `htop\_<version>\_amd64.deb` apparaÃ®t dans le dossier courant.

VÃ©rifier son type :

```bash
file htop\_*.deb
```

> âœ… RÃ©sultat attendu :

> `Debian binary package (format 2.0)`

---

### ğŸ“¦ Ã‰tape 2 â€” Installation manuelle du paquet

#### ğŸ’» Action

```bash
sudo dpkg -i htop\_*.deb
```

#### ğŸ§  Observation

Deux cas possibles :

**Cas 1 â€” Installation rÃ©ussie :**

```
Setting up htop (3.2.2-2) ...

Processing triggers for man-db ...
```

**Cas 2 â€” Ã‰chec de dÃ©pendances :**

```
dpkg: dependency problems prevent configuration of htop:

 htop depends on libncursesw6 (>=6); however:

  Package libncursesw6 is not installed.
```

#### ğŸ§© Explication

`dpkg` installe uniquement le paquet localement sans rÃ©soudre les dÃ©pendances.

Câ€™est volontaire : il agit au plus bas niveau.

---

### ğŸ§° Ã‰tape 3 â€” Diagnostiquer lâ€™Ã©chec dâ€™installation

#### ğŸ’» VÃ©rification du statut :

```bash
dpkg -l | grep htop
```

> RÃ©sultat attendu : `iU` (partially installed / unpacked but not configured)

#### ğŸ’» Analyse avec `dpkg --audit`

```bash
sudo dpkg --audit
```

> Montre un rapport sur les paquets â€œhalf-installedâ€.

#### ğŸ’» Consultation du fichier info

```bash
sudo ls /var/lib/dpkg/info/ | grep htop
```

> Observation : mÃªme en cas dâ€™Ã©chec, des fichiers `.list` et `.postinst` peuvent dÃ©jÃ  exister.

---

### ğŸ©¹ Ã‰tape 4 â€” Corriger les dÃ©pendances cassÃ©es

#### ğŸ’» Action corrective

```bash
sudo apt -f install
```

#### ğŸ§  Explication

* `apt -f install` complÃ¨te les dÃ©pendances manquantes.

* Il lit la base `dpkg` pour corriger lâ€™Ã©tat incohÃ©rent et configure les paquets.

#### ğŸ’» VÃ©rification aprÃ¨s rÃ©paration

```bash
dpkg -l | grep htop
```

> âœ… Le paquet passe Ã  lâ€™Ã©tat `ii` â†’ *installed, ok, configured.*

---

### ğŸ§¨ Ã‰tape 5 â€” ScÃ©nario de double installation et rÃ©installation

#### ğŸ¬ ScÃ©nario

Lâ€™utilisateur relance la mÃªme commande dâ€™installation par erreur.

#### ğŸ’» Action

```bash
sudo dpkg -i htop\_*.deb
```

#### ğŸ§  Observation

> Message attendu :

> 

> ```
> 
> ```

> dpkg: warning: downgrading htop from 3.2.2-2 to 3.2.2-2

> ```
> 
> ```

`dpkg` dÃ©tecte que la mÃªme version est dÃ©jÃ  installÃ©e et rÃ©Ã©crit les fichiers, sans dommage.

---

### ğŸ§© Ã‰tape 6 â€” Inspecter le paquet avant installation (prÃ©ventif)

#### ğŸ’» Commande

```bash
dpkg-deb --info htop\_*.deb
```

> Affiche les mÃ©tadonnÃ©es : version, dÃ©pendances, architecture, mainteneur.

#### ğŸ’» Inspection du contenu

```bash
dpkg-deb --contents htop\_*.deb | head -n 10
```

> Observation : permet de vÃ©rifier oÃ¹ les fichiers seront installÃ©s avant dâ€™exÃ©cuter `dpkg -i`.

#### ğŸ§  Conclusion

Ces deux options sont essentielles pour **valider un `.deb` externe** avant de lâ€™installer en production.

---

### âš™ï¸ Ã‰tape 7 â€” VÃ©rification des fichiers installÃ©s

#### ğŸ’» Commandes

```bash
dpkg -L htop | head -n 5

ls -l /var/lib/dpkg/info/ | grep htop
```

> Observation :

> 

> * `dpkg -L` liste les fichiers rÃ©ellement prÃ©sents.

> * `/var/lib/dpkg/info/` contient les fichiers de mÃ©tadonnÃ©es gÃ©nÃ©rÃ©s par `dpkg`.

---

### ğŸ§¨ Ã‰tape 8 â€” Simuler une erreur manuelle et rÃ©parer

#### ğŸ¬ ScÃ©nario

Lâ€™utilisateur supprime accidentellement le binaire principal.

#### ğŸ’» Commandes

```bash
sudo rm /usr/bin/htop

sudo dpkg --verify htop
```

> âœ… RÃ©sultat attendu :

> 

> ```
> 
> ```

> ??5?????? /usr/bin/htop

> ```
> 
> ```

> 

> Le `5` indique un problÃ¨me de somme de contrÃ´le.

#### ğŸ’¡ RÃ©paration rapide

```bash
sudo dpkg -i htop\_*.deb
```

> Observation : `dpkg` restaure le binaire sans retÃ©lÃ©charger le paquet.

---

### ğŸ§¹ Ã‰tape 9 â€” DÃ©sinstallation et nettoyage complet

#### ğŸ’» Suppression simple

```bash
sudo dpkg -r htop
```

> Ã‰tat : `rc` (removed, configuration files remain)

#### ğŸ’» Purge totale

```bash
sudo dpkg -P htop
```

> Ã‰tat : `un` (fully uninstalled)

#### ğŸ’» VÃ©rification post-nettoyage

```bash
dpkg --audit

dpkg -l | grep htop
```

> âœ… Aucune entrÃ©e restante ni anomalie dÃ©tectÃ©e.

---

## âœ… 4. VÃ©rification finale

1\. Le paquet `.deb` est installÃ©, testÃ©, rÃ©parÃ© et supprimÃ©.

2\. Toutes les dÃ©pendances ont Ã©tÃ© gÃ©rÃ©es.

3\. Le systÃ¨me est revenu Ã  un Ã©tat cohÃ©rent (`dpkg --audit` vide).

4\. Les participants comprennent les codes `ii`, `iU`, `rc`, `un`.

---

## ğŸ§¹ 5. Nettoyage final

```bash
cd ~

rm -rf ~/lab\_dpkg\_install

sudo apt autoremove -y \&\& sudo apt clean

sudo dpkg --audit
```

---

## ğŸ’¡ 6. Astuces \& PiÃ¨ges pÃ©dagogiques

| Type      | Description                                                                                                    |                                               |

| --------- | -------------------------------------------------------------------------------------------------------------- | --------------------------------------------- |

| ğŸ’¡ Astuce | `dpkg --configure -a` termine une installation interrompue.                                                    |                                               |

| ğŸ’¡ Astuce | `dpkg-query -Wf='${Package;-30}${Status}\\n'                                                                    | grep htop` permet dâ€™afficher un statut clair. |

| ğŸ’¡ Astuce | Toujours tester `dpkg-deb --info` avant dâ€™installer un paquet tÃ©lÃ©chargÃ© manuellement.                         |                                               |

| âš ï¸ PiÃ¨ge  | Ne jamais interrompre `dpkg -i` en cours â€” risque de â€œhalf-installedâ€.                                         |                                               |

| âš ï¸ PiÃ¨ge  | Les `.deb` non signÃ©s ou incompatibles peuvent casser la base locale â€” prÃ©fÃ©rer `apt download` officiel.       |                                               |

| âš ï¸ PiÃ¨ge  | Supprimer manuellement des fichiers installÃ©s par `dpkg` cause une incohÃ©rence dÃ©tectable par `dpkg --verify`. |                                               |
