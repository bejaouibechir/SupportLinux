# 📦 Atelier 2 — Installation manuelle d’un paquet `.deb` avec `dpkg`

---

## 🎯 1. Contexte \& Objectif

`dpkg` est capable d’installer directement un paquet `.deb`, sans l’aide d’`apt`.

Ce mode est utile lorsqu’on dispose d’un paquet téléchargé localement (paquet interne, réseau isolé, ou dépôt privé).

**Objectif de l’atelier :**

* Installer un paquet `.deb` manuellement avec `dpkg`.

* Interpréter les messages d’erreurs et les dépendances manquantes.

* Réparer une installation partiellement cassée.

* Vérifier la cohérence du système après correction.

---

## 🧰 2. Préparation de l’environnement

### ⚙️ Conditions de test

* Debian 12 / Ubuntu 22.04

* Accès `sudo`

* Connexion Internet fonctionnelle

### 📂 Préparation du terrain

```bash
mkdir -p ~/lab\_dpkg\_install \&\& cd ~/lab\_dpkg\_install
```

### 🔍 Vérification initiale

```bash
which dpkg

dpkg --version
```

### 💡 Remarque

Tous les téléchargements se feront via `apt download` (plus fiable que des liens directs).

---

## 🪜 3. Étapes pas à pas

---

### 🧩 Étape 1 — Télécharger un paquet `.deb`

#### 🎬 Scénario

Un administrateur souhaite installer `htop` manuellement, sans passer par `apt install`.

#### 💻 Action

```bash
sudo apt update

apt download htop
```

#### 🧠 Observation

Un fichier `htop\_<version>\_amd64.deb` apparaît dans le dossier courant.

Vérifier son type :

```bash
file htop\_*.deb
```

> ✅ Résultat attendu :

> `Debian binary package (format 2.0)`

---

### 📦 Étape 2 — Installation manuelle du paquet

#### 💻 Action

```bash
sudo dpkg -i htop\_*.deb
```

#### 🧠 Observation

Deux cas possibles :

**Cas 1 — Installation réussie :**

```
Setting up htop (3.2.2-2) ...

Processing triggers for man-db ...
```

**Cas 2 — Échec de dépendances :**

```
dpkg: dependency problems prevent configuration of htop:

 htop depends on libncursesw6 (>=6); however:

  Package libncursesw6 is not installed.
```

#### 🧩 Explication

`dpkg` installe uniquement le paquet localement sans résoudre les dépendances.

C’est volontaire : il agit au plus bas niveau.

---

### 🧰 Étape 3 — Diagnostiquer l’échec d’installation

#### 💻 Vérification du statut :

```bash
dpkg -l | grep htop
```

> Résultat attendu : `iU` (partially installed / unpacked but not configured)

#### 💻 Analyse avec `dpkg --audit`

```bash
sudo dpkg --audit
```

> Montre un rapport sur les paquets “half-installed”.

#### 💻 Consultation du fichier info

```bash
sudo ls /var/lib/dpkg/info/ | grep htop
```

> Observation : même en cas d’échec, des fichiers `.list` et `.postinst` peuvent déjà exister.

---

### 🩹 Étape 4 — Corriger les dépendances cassées

#### 💻 Action corrective

```bash
sudo apt -f install
```

#### 🧠 Explication

* `apt -f install` complète les dépendances manquantes.

* Il lit la base `dpkg` pour corriger l’état incohérent et configure les paquets.

#### 💻 Vérification après réparation

```bash
dpkg -l | grep htop
```

> ✅ Le paquet passe à l’état `ii` → *installed, ok, configured.*

---

### 🧨 Étape 5 — Scénario de double installation et réinstallation

#### 🎬 Scénario

L’utilisateur relance la même commande d’installation par erreur.

#### 💻 Action

```bash
sudo dpkg -i htop\_*.deb
```

#### 🧠 Observation

> Message attendu :

> 

> ```
> 
> ```

> dpkg: warning: downgrading htop from 3.2.2-2 to 3.2.2-2

> ```
> 
> ```

`dpkg` détecte que la même version est déjà installée et réécrit les fichiers, sans dommage.

---

### 🧩 Étape 6 — Inspecter le paquet avant installation (préventif)

#### 💻 Commande

```bash
dpkg-deb --info htop\_*.deb
```

> Affiche les métadonnées : version, dépendances, architecture, mainteneur.

#### 💻 Inspection du contenu

```bash
dpkg-deb --contents htop\_*.deb | head -n 10
```

> Observation : permet de vérifier où les fichiers seront installés avant d’exécuter `dpkg -i`.

#### 🧠 Conclusion

Ces deux options sont essentielles pour **valider un `.deb` externe** avant de l’installer en production.

---

### ⚙️ Étape 7 — Vérification des fichiers installés

#### 💻 Commandes

```bash
dpkg -L htop | head -n 5

ls -l /var/lib/dpkg/info/ | grep htop
```

> Observation :

> 

> * `dpkg -L` liste les fichiers réellement présents.

> * `/var/lib/dpkg/info/` contient les fichiers de métadonnées générés par `dpkg`.

---

### 🧨 Étape 8 — Simuler une erreur manuelle et réparer

#### 🎬 Scénario

L’utilisateur supprime accidentellement le binaire principal.

#### 💻 Commandes

```bash
sudo rm /usr/bin/htop

sudo dpkg --verify htop
```

> ✅ Résultat attendu :

> 

> ```
> 
> ```

> ??5?????? /usr/bin/htop

> ```
> 
> ```

> 

> Le `5` indique un problème de somme de contrôle.

#### 💡 Réparation rapide

```bash
sudo dpkg -i htop\_*.deb
```

> Observation : `dpkg` restaure le binaire sans retélécharger le paquet.

---

### 🧹 Étape 9 — Désinstallation et nettoyage complet

#### 💻 Suppression simple

```bash
sudo dpkg -r htop
```

> État : `rc` (removed, configuration files remain)

#### 💻 Purge totale

```bash
sudo dpkg -P htop
```

> État : `un` (fully uninstalled)

#### 💻 Vérification post-nettoyage

```bash
dpkg --audit

dpkg -l | grep htop
```

> ✅ Aucune entrée restante ni anomalie détectée.

---

## ✅ 4. Vérification finale

1\. Le paquet `.deb` est installé, testé, réparé et supprimé.

2\. Toutes les dépendances ont été gérées.

3\. Le système est revenu à un état cohérent (`dpkg --audit` vide).

4\. Les participants comprennent les codes `ii`, `iU`, `rc`, `un`.

---

## 🧹 5. Nettoyage final

```bash
cd ~

rm -rf ~/lab\_dpkg\_install

sudo apt autoremove -y \&\& sudo apt clean

sudo dpkg --audit
```

---

## 💡 6. Astuces \& Pièges pédagogiques

| Type      | Description                                                                                                    |                                               |

| --------- | -------------------------------------------------------------------------------------------------------------- | --------------------------------------------- |

| 💡 Astuce | `dpkg --configure -a` termine une installation interrompue.                                                    |                                               |

| 💡 Astuce | `dpkg-query -Wf='${Package;-30}${Status}\\n'                                                                    | grep htop` permet d’afficher un statut clair. |

| 💡 Astuce | Toujours tester `dpkg-deb --info` avant d’installer un paquet téléchargé manuellement.                         |                                               |

| ⚠️ Piège  | Ne jamais interrompre `dpkg -i` en cours — risque de “half-installed”.                                         |                                               |

| ⚠️ Piège  | Les `.deb` non signés ou incompatibles peuvent casser la base locale — préférer `apt download` officiel.       |                                               |

| ⚠️ Piège  | Supprimer manuellement des fichiers installés par `dpkg` cause une incohérence détectable par `dpkg --verify`. |                                               |
