

# üß© Atelier 7 ‚Äî Gestion des d√©pendances et r√©solution de conflits avec `dpkg`

---

## üéØ 1. Contexte & Objectif

Dans un environnement Debian, les d√©pendances entre paquets assurent la coh√©rence du syst√®me.  
Cependant, lors d‚Äô**installations manuelles ou hors d√©p√¥t**, il peut arriver que `dpkg` installe un paquet sans v√©rifier les d√©pendances, provoquant des **paquets cass√©s** ou **conflits de version**.

**Objectifs p√©dagogiques :**

- Identifier et interpr√©ter les erreurs de d√©pendances avec `dpkg`.

- R√©soudre un √©tat cass√© via `apt -f install`.

- Comprendre les champs `Depends`, `Conflicts`, `Replaces` du fichier `control`.

- Observer le comportement de `dpkg` face √† des paquets incompatibles.

---

## ‚öôÔ∏è 2. Pr√©paration de l‚Äôenvironnement

### Conditions

- Debian 12 ou Ubuntu 22.04

- Acc√®s `sudo`

- Connexion Internet

### Mise en place

```bash
mkdir -p ~/lab_dpkg_depends && cd ~/lab_dpkg_depends
sudo apt update
```

---

## ü™ú 3. √âtapes pas √† pas

---

### üß© √âtape 1 ‚Äî T√©l√©chargement manuel de paquets d√©pendants

#### üé¨ Sc√©nario

Vous souhaitez installer manuellement un programme Python (`sl` et `cowsay`) sans passer par `apt`.  
Nous allons **casser volontairement** les d√©pendances pour observer le comportement de `dpkg`.

#### üíª T√©l√©chargement

```bash
apt download cowsay
apt download fortunes
```

> Ces deux paquets sont ind√©pendants, mais nous allons **cr√©er un faux conflit** entre eux dans la suite.

---

### üß± √âtape 2 ‚Äî Extraction et modification du fichier `control`

#### üíª Extraire le contr√¥le de `cowsay`

```bash
mkdir -p cowsay_edit && dpkg-deb -x cowsay_*.deb cowsay_edit
dpkg-deb -e cowsay_*.deb cowsay_edit/DEBIAN
```

#### üíª Modifier le fichier `control`

```bash
sudo sed -i '1iConflicts: fortunes' cowsay_edit/DEBIAN/control
cat cowsay_edit/DEBIAN/control | grep Conflicts
```

> ‚úÖ Observation : le paquet `cowsay` d√©clare maintenant un conflit avec `fortunes`.

---

### üß© √âtape 3 ‚Äî Reconstruction du paquet modifi√©

```bash
dpkg-deb --build cowsay_edit
```

> ‚úÖ R√©sultat : `cowsay_edit.deb` construit avec d√©pendance forc√©e.

V√©rifiez :

```bash
dpkg-deb --info cowsay_edit.deb | grep -E 'Package|Version|Conflicts'
```

> Observation :
> 
> ```
> Package: cowsay
> Version: 3.03+dfsg2-8
> Conflicts: fortunes
> ```

---

### ‚öôÔ∏è √âtape 4 ‚Äî Installation simultan√©e et d√©tection du conflit

#### üíª Installation du premier paquet

```bash
sudo dpkg -i fortunes_*.deb
```

> ‚úÖ Installation r√©ussie.

#### üíª Tentative d‚Äôinstallation du paquet modifi√©

```bash
sudo dpkg -i cowsay_edit.deb
```

> ‚ö†Ô∏è R√©sultat attendu :
> 
> ```
> dpkg: error processing archive cowsay_edit.deb (--install):
>  cowsay conflicts with fortunes
>  fortunes (version 1:1.99.1-7) is present and installed.
> Errors were encountered while processing:
>  cowsay_edit.deb
> ```

#### üß† Explication

- `dpkg` lit le champ `Conflicts:` et bloque l‚Äôinstallation.

- Contrairement √† `apt`, il ne tente pas de r√©soudre automatiquement.

---

### üß∞ √âtape 5 ‚Äî R√©solution manuelle du conflit

#### üíª Option 1 : Supprimer le paquet conflit

```bash
sudo dpkg -r fortunes
sudo dpkg -i cowsay_edit.deb
```

> ‚úÖ Cette fois l‚Äôinstallation r√©ussit.

#### üíª Option 2 : Forcer malgr√© le conflit *(non recommand√©)*

```bash
sudo dpkg -i --force-conflicts cowsay_edit.deb
```

> ‚ö†Ô∏è R√©sultat :
> 
> ```
> dpkg: warning: overriding problem because --force enabled:
>  conflicting packages - not installing fortunes
> ```
> 
> `dpkg` installe quand m√™me `cowsay` mais le syst√®me devient incoh√©rent.

---

### üß© √âtape 6 ‚Äî V√©rification et correction avec `apt`

#### üíª Diagnostic du syst√®me

```bash
sudo apt -f install
```

> Observation :
> 
> ```
> The following packages have unmet dependencies:
>   cowsay : Conflicts: fortunes but 1:1.99.1-7 is installed
> ```
> 
> `apt` d√©tecte le probl√®me et propose une r√©paration automatique.

#### üíª Acceptation de la r√©paration

```bash
sudo apt -f install -y
```

> R√©sultat : `apt` supprime l‚Äôun des deux paquets pour restaurer la coh√©rence.

---

### üß© √âtape 7 ‚Äî Lecture et analyse des d√©pendances

#### üíª Lire les d√©pendances du paquet install√©

```bash
dpkg -s cowsay | grep -E 'Depends|Conflicts|Replaces'
```

> Exemple de sortie :
> 
> ```
> Depends: perl
> Conflicts: fortunes
> Replaces: cowsay-data
> ```

#### üß† Interpr√©tation

- `Depends` : paquet requis pour le fonctionnement.

- `Conflicts` : paquet incompatible.

- `Replaces` : indique qu‚Äôil peut remplacer certains fichiers d‚Äôun autre paquet.

---

### üß© √âtape 8 ‚Äî V√©rifier les paquets cass√©s dans la base dpkg

#### üíª Commandes

```bash
dpkg --audit
```

> ‚úÖ Doit √™tre vide apr√®s correction.

#### üíª V√©rification des d√©pendances manquantes

```bash
apt-cache depends cowsay | head
```

> Observation : liste des d√©pendances logiques selon la base APT.

---

### üß† √âtape 9 ‚Äî Cas pratique : d√©pendance manquante

#### üé¨ Sc√©nario

Cr√©ons un faux paquet qui d√©pend d‚Äôun paquet inexistant.

```bash
mkdir -p fakepkg/DEBIAN
cat > fakepkg/DEBIAN/control <<'EOF'
Package: fake-depend
Version: 1.0
Section: misc
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Depends: not-a-real-package
Description: Paquet de test avec d√©pendance fictive.
EOF

dpkg-deb --build fakepkg
sudo dpkg -i fakepkg.deb
```

> ‚ö†Ô∏è Erreur attendue :
> 
> ```
> dpkg: dependency problems prevent configuration of fake-depend:
>  fake-depend depends on not-a-real-package; however:
>  Package not-a-real-package is not installed.
> ```

#### üí° Correction

```bash
sudo apt -f install
```

> ‚úÖ R√©solution automatique : suppression du paquet invalide.

---

### ‚öôÔ∏è √âtape 10 ‚Äî Purge finale et v√©rification d‚Äôint√©grit√©

```bash
sudo dpkg -P cowsay fortunes fake-depend
sudo dpkg --audit
sudo apt autoremove -y && sudo apt clean
```

> ‚úÖ Aucune incoh√©rence d√©tect√©e.

---

## ‚úÖ 4. V√©rification des r√©sultats

1. Vous avez observ√© un conflit entre deux paquets Debian.

2. Vous savez utiliser `dpkg -i --force-conflicts` (et comprendre ses risques).

3. Vous ma√Ætrisez la r√©solution automatique via `apt -f install`.

4. Vous savez interpr√©ter les champs `Depends`, `Conflicts`, `Replaces`.

---

## üßπ 5. Nettoyage final

```bash
cd ~
sudo rm -rf ~/lab_dpkg_depends
sudo apt autoremove -y && sudo apt clean
```

---

## üí° 6. Astuces & Pi√®ges p√©dagogiques

| Type      | Description                                                                                 |
| --------- | ------------------------------------------------------------------------------------------- |
| üí° Astuce | `dpkg -s <pkg>` affiche les d√©pendances install√©es.                                         |
| üí° Astuce | `dpkg -I <file.deb>` montre le champ `Depends` d‚Äôun paquet non install√©.                    |
| üí° Astuce | `apt-cache depends <pkg>` compl√®te la vision des d√©pendances syst√®me.                       |
| ‚ö†Ô∏è Pi√®ge  | `dpkg` installe sans r√©soudre ‚Äî toujours v√©rifier avec `apt -f install`.                    |
| ‚ö†Ô∏è Pi√®ge  | Les champs `Conflicts:` et `Replaces:` sont souvent n√©glig√©s par les d√©veloppeurs internes. |
| ‚ö†Ô∏è Pi√®ge  | Ne jamais forcer une installation (`--force-all`) sur un syst√®me de production.             |


