



# ğŸ§© Atelier 7 (version enrichie) â€” Gestion des dÃ©pendances et rÃ©solution de conflits avec `dpkg`

---

## ğŸ¯ 1. Contexte mÃ©tier & Objectif

**Contexte mÃ©tier (rÃ©aliste)** : votre Ã©quipe publie deux utilitaires internes sous forme de `.deb`. Un plugin interne (ou une version diffÃ©rente dâ€™une bibliothÃ¨que) peut Ãªtre incompatible avec une application dÃ©jÃ  installÃ©e sur les serveurs de test. Vous devez diagnostiquer et rÃ©soudre ces **conflits de dÃ©pendances/version** sans casser lâ€™environnement.

**Objectifs :**

- Diagnostiquer un conflit `Conflicts` ou un conflit de version.

- Expliquer les risques de modifier directement un `control` (paquet signÃ©/integrity).

- RÃ©soudre proprement le conflit (suppression, mise Ã  jour, ou utilisation dâ€™`apt -f`).

- Valider permissions, signatures basiques et cohÃ©rence aprÃ¨s rÃ©paration.

- Fournir une interprÃ©tation phrase-par-phrase des sorties `dpkg`/`apt`.

---

## ğŸ§° 2. PrÃ©paration de lâ€™environnement

**PrÃ©requis**

- Debian 12 / Ubuntu 22.04

- AccÃ¨s `sudo`

- Connexion Internet

**CrÃ©ation du laboratoire**

```bash
mkdir -p ~/lab_dpkg_depends && cd ~/lab_dpkg_depends
sudo apt update
```

**Paquets dâ€™exemple (tÃ©lÃ©chargement sans installation immÃ©diate)**

```bash
apt download cowsay
apt download fortunes
```

> Ces paquets servent dâ€™exemples. Nous allons ensuite construire des scÃ©narios de conflit contrÃ´lÃ©.

---

## ğŸªœ 3. Ã‰tapes pas Ã  pas (scÃ©narios rÃ©alistes et enrichis)

---

### ğŸ” Ã‰tape 1 â€” Visualiser les champs dâ€™un `.deb` (audit avant modification)

#### Action

```bash
dpkg-deb --info cowsay_*.deb
dpkg-deb --info fortunes_*.deb
```

#### Observation & Explication (ligne-par-ligne)

- `Package:` â†’ nom du paquet.

- `Version:` â†’ version exacte, utilisÃ©e pour contraintes de version.

- `Depends:` â†’ paquets requis (sera vÃ©rifiÃ© par apt pour lâ€™installation).

- `Conflicts:` / `Replaces:` â†’ incompatibilitÃ©s et remplacements potentiels.

> **Note pÃ©dagogique** : lire ces champs AVANT toute modification â€” câ€™est la premiÃ¨re dÃ©fense contre des conflits.

---

### âš ï¸ Ã‰tape 2 â€” Risques & bonnes pratiques avant modifier un paquet

**Avertissement** : modifier manuellement un `control` brise la signature (si paquet signÃ©) et peut provoquer des incohÃ©rences.  
**Bonne pratique** : travailler toujours sur une copie, conserver lâ€™original, et documenter la modification.

```bash
mkdir -p cowsay_edit
dpkg-deb -x cowsay_*.deb cowsay_edit
dpkg-deb -e cowsay_*.deb cowsay_edit/DEBIAN
cp cowsay_*.deb cowsay_*.deb.orig
```

---

### ğŸ›  Ã‰tape 3 â€” CrÃ©ation dâ€™un conflit de version rÃ©el (scÃ©nario)

#### But

Montrer un conflit de **version**, pas seulement `Conflicts:`. Exemple : `pkgA` dÃ©pend de `libfoo (>= 2.0)` mais `libfoo 1.8` est installÃ©.

#### PrÃ©paration (crÃ©ation dâ€™un paquet fake qui demande une version Ã©levÃ©e dâ€™un paquet existant)

```bash
mkdir -p fakever/DEBIAN
cat > fakever/DEBIAN/control <<'EOF'
Package: fakever
Version: 1.0
Section: misc
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Depends: libc6 (>= 9999.0)   # dÃ©pendance impossible pour simuler l'erreur
Description: Paquet test requÃ©rant une version inexistante de libc6.
EOF
dpkg-deb --build fakever
sudo dpkg -i fakever.deb
```

#### Sortie attendue & interprÃ©tation

```
dpkg: dependency problems prevent configuration of fakever:
 fakever depends on libc6 (>= 9999.0); however:
  Package libc6 is not installed or is too old.
```

- InterprÃ©tation : `dpkg` installe la partie fichier si possible (unpack) mais refuse la configuration ; il signale la contrainte non satisfaite.

---

### ğŸ”§ Ã‰tape 4 â€” Modifier `control` pour ajouter `Conflicts:` (scÃ©nario contrÃ´lÃ©)

> **Rappel** : toujours travailler sur copie. Nous ajouterons `Conflicts: fortunes` pour tester.

```bash
# prÃ©parez le rÃ©pertoire d'Ã©dition si pas dÃ©jÃ  fait
dpkg-deb -x cowsay_*.deb cowsay_edit
dpkg-deb -e cowsay_*.deb cowsay_edit/DEBIAN

# ajouter Conflicts
sed -i '1iConflicts: fortunes' cowsay_edit/DEBIAN/control

# vÃ©rifier permissions (important)
chmod 755 cowsay_edit/DEBIAN
chmod 644 cowsay_edit/DEBIAN/control
ls -l cowsay_edit/DEBIAN
```

#### Explication permissions

- `DEBIAN/` doit Ãªtre lisible et les fichiers `control` en 644 ; scripts en 755 si prÃ©sents.

- Mauvaises permissions invalident la construction du `.deb`.

---

### ğŸ§± Ã‰tape 5 â€” Reconstruction et vÃ©rification (permissions & checksum)

```bash
dpkg-deb --build cowsay_edit
dpkg-deb --info cowsay_edit.deb | sed -n '1,20p'
# vÃ©rifier que Conflicts apparait bien
dpkg-deb --info cowsay_edit.deb | grep Conflicts || true
```

**VÃ©rification critique** :

- VÃ©rifiez que `DEBIAN/*` nâ€™a pas de permission `root-only` qui empÃªche dpkg de lire les scripts.

- `dpkg-deb --info` doit afficher le champ `Conflicts:`.

---

### âš”ï¸ Ã‰tape 6 â€” Installer un paquet en conflit (dÃ©tection & message dÃ©taillÃ©)

#### Action (installation sÃ©quentielle)

```bash
# installer d'abord fortunes
sudo dpkg -i fortunes_*.deb

# maintenant tenter d'installer le cowsay modifiÃ©
sudo dpkg -i cowsay_edit.deb
```

#### Sortie typique & commentaire phrase-par-phrase

```
dpkg: error processing archive cowsay_edit.deb (--install):
 cowsay conflicts with fortunes
 fortunes (version x.y) is present and installed.
Errors were encountered while processing:
 cowsay_edit.deb
```

- `dpkg:` â†’ ligne source du gestionnaire, indique lâ€™archive incriminÃ©e.

- `cowsay conflicts with fortunes` â†’ lecture directe du champ `Conflicts:` du `control`.

- `fortunes (...) is present and installed.` â†’ `dpkg` refuse dâ€™Ã©craser un paquet explicitement marquÃ© incompatible.

---

### ğŸ›  Ã‰tape 7 â€” RÃ©solution recommandÃ©e et alternatives (explicitÃ©es)

**Option A â€” Suppression du paquet conflit (propre)**

```bash
sudo dpkg -r fortunes
sudo dpkg -i cowsay_edit.deb
```

- Effet : supprime fortunes puis installe cowsay_edit.

**Option B â€” Forcer lâ€™installation (dangereux, pour dÃ©monstration seulement)**

```bash
sudo dpkg -i --force-conflicts cowsay_edit.deb
```

- Effet : dpkg installe malgrÃ© le conflit ; **risque** : systÃ¨me incohÃ©rent, fichiers partagÃ©s Ã©crasÃ©s.

**Option C â€” Utiliser apt pour analyser avant action**

```bash
sudo apt -f install
```

- `apt` proposera une stratÃ©gie (supprimer un paquet, installer dÃ©pendances manquantes, etc.). Comparez la proposition et commentez-la.

---

### ğŸ“Š Ã‰tape 8 â€” SchÃ©ma textuel (visualisation des relations)

```
[fortune (installed)]
        â†‘
   Conflicts
        â†“
[cowsay_edit (to install)]  <-- Replaces ? Depends ? Replaces
```

Ou pour dÃ©pendances de version :

```
[cowapp 1.0] --Depends: libfoo (>= 2.0)
     |
 libfoo 1.8 (installed)  <- mismatch -> failure
```

> Utilisez ces petits schÃ©mas pour expliquer clairement qui dÃ©pend de qui, qui remplace qui, et qui est incompatible.

---

### ğŸ” Ã‰tape 9 â€” Cas pratique : dÃ©pendance manquante et rÃ©paration automatique

Nous avons dÃ©jÃ  crÃ©Ã© `fakever` (demande libc6 >= 9999).  
AprÃ¨s lâ€™Ã©chec, tester la rÃ©paration :

```bash
sudo apt -f install
```

- `apt` devrait proposer de retirer `fakever` (ou ne pas pouvoir installer). Lisez la sortie et commentez : quel paquet est proposÃ© pour suppression ? Pourquoi ?

---

### âœ… Ã‰tape 10 â€” Validation post-rÃ©paration & contrÃ´les finaux

AprÃ¨s toute rÃ©paration, faites systÃ©matiquement :

```bash
# montrer l'Ã©tat des paquets testÃ©s
dpkg -l | egrep 'cowsay|fortunes|fakever' || true

# vÃ©rifier qu'il n'y a pas d'anomalie
sudo dpkg --audit
sudo dpkg --verify cowsay || true
```

InterprÃ©tez chaque ligne retournÃ©e :

- `dpkg --audit` vide â†’ OK.

- `dpkg --verify` retourne marqueurs ; dÃ©crivez chaque colonne comme vu dans lâ€™atelier 6.

---

## âœ… 4. VÃ©rification des acquis (tests to run)

1. Vous pouvez **reproduire** un conflit `Conflicts:` et lâ€™expliquer.

2. Vous savez **modifier proprement** un `control` (sur copie), reconstruire et vÃ©rifier permissions.

3. Vous savez **rÃ©soudre** le conflit proprement (prÃ©fÃ©rer suppression/purge ou mise Ã  jour, Ã©viter `--force`).

4. Vous savez **interprÃ©ter** les rÃ©ponses `dpkg` & `apt -f install` phrase-par-phrase.

5. Vous savez valider lâ€™Ã©tat final avec `dpkg --audit` et `dpkg --verify`.

---

## ğŸ§¹ 5. Nettoyage final

```bash
# purge des paquets test et suppression du labo
sudo dpkg -P cowsay fortunes fakever || true
sudo apt -f install -y || true
cd ~
sudo rm -rf ~/lab_dpkg_depends
sudo apt autoremove -y && sudo apt clean
```

---

## ğŸ’¡ 6. Astuces & PiÃ¨ges pÃ©dagogiques (complÃ©tÃ©s)

| Type      | Description                                                                                     |
| --------- | ----------------------------------------------------------------------------------------------- |
| ğŸ’¡ Astuce | Toujours travailler sur une copie dâ€™un `.deb` avant modification.                               |
| ğŸ’¡ Astuce | `dpkg -I file.deb` (alias `dpkg-deb --info`) pour vÃ©rifier le `control` sans extraire.          |
| ğŸ’¡ Astuce | VÃ©rifier permissions `chmod 755 DEBIAN` et `chmod 644 DEBIAN/control` avant build.              |
| âš ï¸ PiÃ¨ge  | Modifier un paquet signÃ© casse lâ€™intÃ©gritÃ© et empÃªche certaines vÃ©rifications APT.              |
| âš ï¸ PiÃ¨ge  | `--force-conflicts` peut rendre le systÃ¨me incohÃ©rent â€” nâ€™utilisez quâ€™en environnement de test. |
| âš ï¸ PiÃ¨ge  | Ne pas laisser de paquets de test (fakever) sur les machines de production.                     |




