



# 🧩 Atelier 7 (version enrichie) — Gestion des dépendances et résolution de conflits avec `dpkg`

---

## 🎯 1. Contexte métier & Objectif

**Contexte métier (réaliste)** : votre équipe publie deux utilitaires internes sous forme de `.deb`. Un plugin interne (ou une version différente d’une bibliothèque) peut être incompatible avec une application déjà installée sur les serveurs de test. Vous devez diagnostiquer et résoudre ces **conflits de dépendances/version** sans casser l’environnement.

**Objectifs :**

- Diagnostiquer un conflit `Conflicts` ou un conflit de version.

- Expliquer les risques de modifier directement un `control` (paquet signé/integrity).

- Résoudre proprement le conflit (suppression, mise à jour, ou utilisation d’`apt -f`).

- Valider permissions, signatures basiques et cohérence après réparation.

- Fournir une interprétation phrase-par-phrase des sorties `dpkg`/`apt`.

---

## 🧰 2. Préparation de l’environnement

**Prérequis**

- Debian 12 / Ubuntu 22.04

- Accès `sudo`

- Connexion Internet

**Création du laboratoire**

```bash
mkdir -p ~/lab_dpkg_depends && cd ~/lab_dpkg_depends
sudo apt update
```

**Paquets d’exemple (téléchargement sans installation immédiate)**

```bash
apt download cowsay
apt download fortunes
```

> Ces paquets servent d’exemples. Nous allons ensuite construire des scénarios de conflit contrôlé.

---

## 🪜 3. Étapes pas à pas (scénarios réalistes et enrichis)

---

### 🔎 Étape 1 — Visualiser les champs d’un `.deb` (audit avant modification)

#### Action

```bash
dpkg-deb --info cowsay_*.deb
dpkg-deb --info fortunes_*.deb
```

#### Observation & Explication (ligne-par-ligne)

- `Package:` → nom du paquet.

- `Version:` → version exacte, utilisée pour contraintes de version.

- `Depends:` → paquets requis (sera vérifié par apt pour l’installation).

- `Conflicts:` / `Replaces:` → incompatibilités et remplacements potentiels.

> **Note pédagogique** : lire ces champs AVANT toute modification — c’est la première défense contre des conflits.

---

### ⚠️ Étape 2 — Risques & bonnes pratiques avant modifier un paquet

**Avertissement** : modifier manuellement un `control` brise la signature (si paquet signé) et peut provoquer des incohérences.  
**Bonne pratique** : travailler toujours sur une copie, conserver l’original, et documenter la modification.

```bash
mkdir -p cowsay_edit
dpkg-deb -x cowsay_*.deb cowsay_edit
dpkg-deb -e cowsay_*.deb cowsay_edit/DEBIAN
cp cowsay_*.deb cowsay_*.deb.orig
```

---

### 🛠 Étape 3 — Création d’un conflit de version réel (scénario)

#### But

Montrer un conflit de **version**, pas seulement `Conflicts:`. Exemple : `pkgA` dépend de `libfoo (>= 2.0)` mais `libfoo 1.8` est installé.

#### Préparation (création d’un paquet fake qui demande une version élevée d’un paquet existant)

```bash
mkdir -p fakever/DEBIAN
cat > fakever/DEBIAN/control <<'EOF'
Package: fakever
Version: 1.0
Section: misc
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Depends: libc6 (>= 9999.0)   # dépendance impossible pour simuler l'erreur
Description: Paquet test requérant une version inexistante de libc6.
EOF
dpkg-deb --build fakever
sudo dpkg -i fakever.deb
```

#### Sortie attendue & interprétation

```
dpkg: dependency problems prevent configuration of fakever:
 fakever depends on libc6 (>= 9999.0); however:
  Package libc6 is not installed or is too old.
```

- Interprétation : `dpkg` installe la partie fichier si possible (unpack) mais refuse la configuration ; il signale la contrainte non satisfaite.

---

### 🔧 Étape 4 — Modifier `control` pour ajouter `Conflicts:` (scénario contrôlé)

> **Rappel** : toujours travailler sur copie. Nous ajouterons `Conflicts: fortunes` pour tester.

```bash
# préparez le répertoire d'édition si pas déjà fait
dpkg-deb -x cowsay_*.deb cowsay_edit
dpkg-deb -e cowsay_*.deb cowsay_edit/DEBIAN

# ajouter Conflicts
sed -i '1iConflicts: fortunes' cowsay_edit/DEBIAN/control

# vérifier permissions (important)
chmod 755 cowsay_edit/DEBIAN
chmod 644 cowsay_edit/DEBIAN/control
ls -l cowsay_edit/DEBIAN
```

#### Explication permissions

- `DEBIAN/` doit être lisible et les fichiers `control` en 644 ; scripts en 755 si présents.

- Mauvaises permissions invalident la construction du `.deb`.

---

### 🧱 Étape 5 — Reconstruction et vérification (permissions & checksum)

```bash
dpkg-deb --build cowsay_edit
dpkg-deb --info cowsay_edit.deb | sed -n '1,20p'
# vérifier que Conflicts apparait bien
dpkg-deb --info cowsay_edit.deb | grep Conflicts || true
```

**Vérification critique** :

- Vérifiez que `DEBIAN/*` n’a pas de permission `root-only` qui empêche dpkg de lire les scripts.

- `dpkg-deb --info` doit afficher le champ `Conflicts:`.

---

### ⚔️ Étape 6 — Installer un paquet en conflit (détection & message détaillé)

#### Action (installation séquentielle)

```bash
# installer d'abord fortunes
sudo dpkg -i fortunes_*.deb

# maintenant tenter d'installer le cowsay modifié
sudo dpkg -i cowsay_edit.deb
```

#### Sortie typique & commentaire phrase-par-phrase

```
dpkg: error processing archive cowsay_edit.deb (--install):
 cowsay conflicts with fortunes
 fortunes (version x.y) is present and installed.
Errors were encountered while processing:
 cowsay_edit.deb
```

- `dpkg:` → ligne source du gestionnaire, indique l’archive incriminée.

- `cowsay conflicts with fortunes` → lecture directe du champ `Conflicts:` du `control`.

- `fortunes (...) is present and installed.` → `dpkg` refuse d’écraser un paquet explicitement marqué incompatible.

---

### 🛠 Étape 7 — Résolution recommandée et alternatives (explicitées)

**Option A — Suppression du paquet conflit (propre)**

```bash
sudo dpkg -r fortunes
sudo dpkg -i cowsay_edit.deb
```

- Effet : supprime fortunes puis installe cowsay_edit.

**Option B — Forcer l’installation (dangereux, pour démonstration seulement)**

```bash
sudo dpkg -i --force-conflicts cowsay_edit.deb
```

- Effet : dpkg installe malgré le conflit ; **risque** : système incohérent, fichiers partagés écrasés.

**Option C — Utiliser apt pour analyser avant action**

```bash
sudo apt -f install
```

- `apt` proposera une stratégie (supprimer un paquet, installer dépendances manquantes, etc.). Comparez la proposition et commentez-la.

---

### 📊 Étape 8 — Schéma textuel (visualisation des relations)

```
[fortune (installed)]
        ↑
   Conflicts
        ↓
[cowsay_edit (to install)]  <-- Replaces ? Depends ? Replaces
```

Ou pour dépendances de version :

```
[cowapp 1.0] --Depends: libfoo (>= 2.0)
     |
 libfoo 1.8 (installed)  <- mismatch -> failure
```

> Utilisez ces petits schémas pour expliquer clairement qui dépend de qui, qui remplace qui, et qui est incompatible.

---

### 🔁 Étape 9 — Cas pratique : dépendance manquante et réparation automatique

Nous avons déjà créé `fakever` (demande libc6 >= 9999).  
Après l’échec, tester la réparation :

```bash
sudo apt -f install
```

- `apt` devrait proposer de retirer `fakever` (ou ne pas pouvoir installer). Lisez la sortie et commentez : quel paquet est proposé pour suppression ? Pourquoi ?

---

### ✅ Étape 10 — Validation post-réparation & contrôles finaux

Après toute réparation, faites systématiquement :

```bash
# montrer l'état des paquets testés
dpkg -l | egrep 'cowsay|fortunes|fakever' || true

# vérifier qu'il n'y a pas d'anomalie
sudo dpkg --audit
sudo dpkg --verify cowsay || true
```

Interprétez chaque ligne retournée :

- `dpkg --audit` vide → OK.

- `dpkg --verify` retourne marqueurs ; décrivez chaque colonne comme vu dans l’atelier 6.

---

## ✅ 4. Vérification des acquis (tests to run)

1. Vous pouvez **reproduire** un conflit `Conflicts:` et l’expliquer.

2. Vous savez **modifier proprement** un `control` (sur copie), reconstruire et vérifier permissions.

3. Vous savez **résoudre** le conflit proprement (préférer suppression/purge ou mise à jour, éviter `--force`).

4. Vous savez **interpréter** les réponses `dpkg` & `apt -f install` phrase-par-phrase.

5. Vous savez valider l’état final avec `dpkg --audit` et `dpkg --verify`.

---

## 🧹 5. Nettoyage final

```bash
# purge des paquets test et suppression du labo
sudo dpkg -P cowsay fortunes fakever || true
sudo apt -f install -y || true
cd ~
sudo rm -rf ~/lab_dpkg_depends
sudo apt autoremove -y && sudo apt clean
```

---

## 💡 6. Astuces & Pièges pédagogiques (complétés)

| Type      | Description                                                                                     |
| --------- | ----------------------------------------------------------------------------------------------- |
| 💡 Astuce | Toujours travailler sur une copie d’un `.deb` avant modification.                               |
| 💡 Astuce | `dpkg -I file.deb` (alias `dpkg-deb --info`) pour vérifier le `control` sans extraire.          |
| 💡 Astuce | Vérifier permissions `chmod 755 DEBIAN` et `chmod 644 DEBIAN/control` avant build.              |
| ⚠️ Piège  | Modifier un paquet signé casse l’intégrité et empêche certaines vérifications APT.              |
| ⚠️ Piège  | `--force-conflicts` peut rendre le système incohérent — n’utilisez qu’en environnement de test. |
| ⚠️ Piège  | Ne pas laisser de paquets de test (fakever) sur les machines de production.                     |




