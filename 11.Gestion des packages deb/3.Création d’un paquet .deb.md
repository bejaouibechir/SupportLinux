# üß± Atelier 4 ‚Äî Cr√©ation d‚Äôun paquet `.deb` r√©aliste (en deux it√©rations)

---

## üéØ 1. Contexte \& Objectif

Vous √™tes administrateur syst√®me dans une petite √©quipe DevOps.

Votre objectif : distribuer √† vos coll√®gues un **outil interne** sous forme d‚Äôun **paquet Debian installable localement**.

Dans cette s√©rie d‚Äô√©tapes, vous apprendrez √† :

* Structurer un projet simple pour qu‚Äôil soit empaquetable.

* Construire un paquet `.deb` valide avec `dpkg-deb`.

* Contr√¥ler et tester la version install√©e.

* √âtendre le packaging avec fichiers auxiliaires : configuration, logs, documentation.

---

## ‚öôÔ∏è 2. Pr√©paration de l‚Äôenvironnement

### Conditions minimales

* Debian 12 / Ubuntu 22.04

* Acc√®s `sudo`

* Aucun paquet additionnel requis

### Cr√©ation du r√©pertoire de travail

```bash
mkdir -p ~/lab\_dpkg\_build \&\& cd ~/lab\_dpkg\_build
```

---

## üöÄ **It√©ration 1 : Cr√©ation et d√©ploiement d‚Äôun logiciel simple**

---

### üß© √âtape 1 : Concevoir le programme √† empaqueter

#### üé¨ Sc√©nario

Un script Bash/Python simple qui affiche l‚Äôheure courante et le nom de l‚Äôutilisateur.

#### üíª Action

```bash
mkdir -p v1/usr/local/bin

cat > v1/usr/local/bin/hello\_time.py <<'EOF'

#!/usr/bin/env python3

import datetime, os

now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

print(f"Bonjour {os.getenv('USER')} ! Il est {now}.")

EOF



chmod +x v1/usr/local/bin/hello\_time.py
```

---

### üóÇÔ∏è √âtape 2 : Cr√©er le dossier `DEBIAN` et r√©diger le fichier `control`

#### üíª Actions

```bash
mkdir v1/DEBIAN

cat > v1/DEBIAN/control <<'EOF'

Package: hello-time

Version: 1.0

Section: utils

Priority: optional

Architecture: all

Maintainer: Formateur <formateur@lab>

Installed-Size: 5

Description: Petit utilitaire Python affichant l'heure et l'utilisateur actuel.

EOF
```

#### üí¨ Explication

* `Installed-Size` : taille estim√©e (Ko).

* `Section` et `Priority` : cat√©gories visibles dans les outils Debian.

V√©rifiez les permissions :

```bash
find v1 -type f -exec chmod 644 {} \\;

chmod 755 v1/usr/local/bin/hello\_time.py
```

---

### üß± √âtape 3 : Construire le paquet `.deb`

```bash
dpkg-deb --build v1
```

> ‚úÖ Sortie attendue :

> `dpkg-deb: building package 'hello-time' in 'v1.deb'`

Contr√¥lez le paquet :

```bash
dpkg-deb --info v1.deb

dpkg-deb --contents v1.deb
```

---

### üì¶ √âtape 4 : Installer, tester et v√©rifier

#### üíª Installation

```bash
sudo dpkg -i v1.deb
```

#### üîç Tests

```bash
hello\_time.py
```

> ‚úÖ Sortie typique :

> `Bonjour bechir ! Il est 2025-10-07 15:26:43.`

V√©rifiez l‚Äô√©tat et les fichiers :

```bash
dpkg -s hello-time

dpkg -L hello-time
```

#### üí° Observation

`dpkg -s` montre le statut ‚Äúinstall ok installed‚Äù.

`dpkg -L` liste `/usr/local/bin/hello\_time.py` et les fichiers d‚Äôinfo correspondants.

---

### ‚öôÔ∏è √âtape 5 : Observation syst√®me et nettoyage

#### üíª Commandes

```bash
ls /var/lib/dpkg/info | grep hello-time

sudo dpkg -P hello-time
```

#### üß† Interpr√©tation

* `*.list` : chemins install√©s.

* `*.md5sums` : empreintes.

* La purge supprime tout, y compris ces fichiers.

Nettoyez l‚Äôespace de travail :

```bash
rm v1.deb
```

---

## üß≠ Synth√®se de l‚Äôit√©ration 1

‚úÖ Vous avez cr√©√©, empaquet√© et install√© un **outil Python fonctionnel** sous forme de paquet Debian.

Vous ma√Ætrisez maintenant la **structure minimale** requise pour qu‚Äôun `.deb` soit valide.

---

## ‚öôÔ∏è **It√©ration 2 : Approche r√©aliste ‚Äî Version 2 avec fichiers auxiliaires**

---

### üß© √âtape 1 : Pr√©parer la nouvelle version

#### üé¨ Sc√©nario

Vous publiez une **version 2.0** plus compl√®te :

* Un ex√©cutable dans `/usr/local/bin`

* Un fichier de configuration dans `/etc/hello-time/`

* Un r√©pertoire de logs dans `/var/log/hello-time/`

* Une petite documentation dans `/usr/share/doc/hello-time/`

---

### üìÅ Arborescence du paquet

```bash
mkdir -p v2/{DEBIAN,etc/hello-time,var/log/hello-time,usr/local/bin,usr/share/doc/hello-time}
```

---

### üßæ √âtape 2 : Script principal

```bash
cat > v2/usr/local/bin/hello\_time.sh <<'EOF'

#!/bin/bash

CONFIG="/etc/hello-time/config.ini"

LOGFILE="/var/log/hello-time/run.log"



USER=$(whoami)

DATE=$(date '+%Y-%m-%d %H:%M:%S')

HOST=$(hostname)

MSG="\[$DATE] Bonjour $USER ! Vous √™tes sur $HOST."



# Lecture d‚Äôun param√®tre optionnel depuis la configuration

if \[ -f "$CONFIG" ]; then

    TIMEZONE=$(grep "timezone" "$CONFIG" | cut -d'=' -f2)

    \[ -n "$TIMEZONE" ] \&\& MSG="$MSG (Fuseau : $TIMEZONE)"

fi



echo "$MSG"

echo "$MSG" >> "$LOGFILE"

EOF



chmod +x v2/usr/local/bin/hello\_time.sh
```

---

### ‚öôÔ∏è √âtape 3 : Fichier de configuration

```bash
cat > v2/etc/hello-time/config.ini <<'EOF'

# Configuration du programme hello\_time

timezone=Europe/Paris

EOF
```

---

### üìö √âtape 4 : Documentation et journaux

```bash
cat > v2/usr/share/doc/hello-time/README.txt <<'EOF'

Hello-Time 2.0

---------------

Ce programme affiche l'heure et l'utilisateur courant, et journalise le message

dans /var/log/hello-time/run.log.

EOF

touch v2/var/log/hello-time/run.log

chmod 666 v2/var/log/hello-time/run.log
```

---

### üóÇÔ∏è √âtape 5 : Fichier `control` complet

```bash
cat > v2/DEBIAN/control <<'EOF'

Package: hello-time

Version: 2.0

Section: utils

Priority: optional

Architecture: all

Maintainer: Formateur <formateur@lab>

Installed-Size: 20

Description: Utilitaire Bash am√©lior√© affichant l'heure et journalisant l'activit√©.

EOF
```

V√©rifiez les permissions :

```bash
find v2 -type f -exec chmod 644 {} \\;

chmod 755 v2/usr/local/bin/hello\_time.sh
```

---

### üß± √âtape 6 : Construction du paquet version 2

```bash
dpkg-deb --build v2
```

> ‚úÖ R√©sultat attendu :

> `dpkg-deb: building package 'hello-time' in 'v2.deb'.`

V√©rifiez :

```bash
dpkg-deb --info v2.deb

dpkg-deb --contents v2.deb
```

---

### üì¶ √âtape 7 : Installation et test du paquet v2

#### üíª Commandes

```bash
sudo dpkg -i v2.deb

hello\_time.sh
```

> ‚úÖ Sortie attendue :

> 

> ```
> 
> ```

> \[2025-10-07 15:31:21] Bonjour bechir ! Vous √™tes sur debian-lab. (Fuseau : Europe/Paris)

> ```
> 
> ```

#### üîé V√©rifiez les journaux

```bash
cat /var/log/hello-time/run.log | tail -n 3
```

#### üíª V√©rifiez les fichiers

```bash
dpkg -L hello-time
```

> Observation : le paquet installe maintenant des fichiers sous `/etc`, `/var`, `/usr/local/bin`, `/usr/share/doc`.

---

### ‚öôÔ∏è √âtape 8 : V√©rification et d√©sinstallation

```bash
dpkg -s hello-time

sudo dpkg -r hello-time

sudo dpkg -P hello-time
```

V√©rifiez que `/var/log/hello-time/` est vide apr√®s purge :

```bash
ls /var/log/hello-time || echo "R√©pertoire supprim√©"
```

---

## ‚úÖ 4. R√©sultats attendus

* Vous avez cr√©√© deux versions fonctionnelles du m√™me outil :

&nbsp; **v1 (simple)** et **v2 (avec configuration, logs, documentation)**.

* Vous comprenez les implications des diff√©rents r√©pertoires standards Debian (`/etc`, `/var`, `/usr/share`).

* Vous ma√Ætrisez la construction et l‚Äôinstallation locale de paquets `.deb`.

---

## üßπ 5. Nettoyage final

```bash
cd ~

sudo rm -rf ~/lab\_dpkg\_build

sudo apt autoremove -y \&\& sudo apt clean
```

---

## üí° 6. Astuces \& Pi√®ges p√©dagogiques

| Type      | Description                                                                                                                       |

| --------- | --------------------------------------------------------------------------------------------------------------------------------- |

| üí° Astuce | Toujours ex√©cuter `dpkg-deb --info` avant installation d‚Äôun paquet construit manuellement.                                        |

| üí° Astuce | Les r√©pertoires `/etc`, `/var/log`, `/usr/share/doc` doivent √™tre cr√©√©s avec les permissions correctes (755 ou 644 selon le cas). |

| üí° Astuce | `Architecture: all` simplifie la distribution entre architectures.                                                                |

| ‚ö†Ô∏è Pi√®ge  | Oublier d‚Äôajouter `Installed-Size` emp√™che parfois l‚Äôinstallation via certains gestionnaires.                                     |

| ‚ö†Ô∏è Pi√®ge  | Les fichiers de log doivent exister avant installation sinon le script √©choue √† √©crire dedans.                                    |

| ‚ö†Ô∏è Pi√®ge  | √âvitez les chemins absolus lors de la cr√©ation : `mypkg/usr/local/bin/` (sans `/` initial).                                       |

---
