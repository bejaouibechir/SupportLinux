# üß± Atelier 4 ‚Äî Cr√©er un paquet `.deb` minimal √† partir d‚Äôun script

---

## üéØ 1. Contexte & Objectif

L‚Äôoutil `dpkg-deb` permet de **construire un paquet Debian** √† partir d‚Äôune simple arborescence de fichiers et d‚Äôun dossier `DEBIAN/` contenant des m√©tadonn√©es.  
Cet atelier montre comment **emballer un petit script Bash en `.deb`**, l‚Äôinstaller localement, v√©rifier sa pr√©sence dans le syst√®me, puis le d√©sinstaller proprement.

**Objectifs p√©dagogiques :**

- Cr√©er la structure minimale d‚Äôun paquet Debian.

- Comprendre le r√¥le du dossier `DEBIAN/` et du fichier `control`.

- G√©n√©rer, installer et tester un paquet `.deb` localement.

- Observer les traces laiss√©es par `dpkg`.

---

## üß∞ 2. Pr√©paration de l‚Äôenvironnement

### ‚öôÔ∏è Conditions

- Debian 12 / Ubuntu 22.04

- Acc√®s `sudo`

- Aucun paquet suppl√©mentaire requis

### üìÅ Pr√©paration du terrain

```bash
mkdir -p ~/lab_dpkg_build && cd ~/lab_dpkg_build
```

---

## ü™ú 3. √âtapes pas √† pas

---

### üß© √âtape 1 ‚Äî Cr√©er le contenu √† empaqueter

#### üé¨ Sc√©nario

Vous avez d√©velopp√© un script `hello.sh` qui affiche un message de bienvenue et souhaitez le distribuer √† vos coll√®gues sous forme de paquet Debian.

#### üíª Action

Cr√©ez l‚Äôarborescence minimale :

```bash
mkdir -p mypkg/usr/local/bin
```

Cr√©ez le script :

```bash
cat > mypkg/usr/local/bin/hello.sh <<'EOF'
#!/bin/bash
echo "Bonjour, $(whoami) ! Bienvenue sur $(hostname)."
EOF
```

Rendez-le ex√©cutable :

```bash
chmod +x mypkg/usr/local/bin/hello.sh
```

#### üß† Observation

`mypkg/usr/local/bin/hello.sh` sera install√© tel quel sur le syst√®me.

---

### üóÇÔ∏è √âtape 2 ‚Äî Cr√©er le dossier `DEBIAN` et le fichier `control`

#### üíª Actions

```bash
mkdir mypkg/DEBIAN
cat > mypkg/DEBIAN/control <<'EOF'
Package: hello-minimal
Version: 1.0
Section: base
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Description: Paquet Debian minimal affichant un message de bienvenue.
EOF
```

#### üí¨ Explication

Le fichier `control` contient les **m√©tadonn√©es fondamentales** n√©cessaires √† `dpkg`.  
Ici :

- `Architecture: all` car le script est ind√©pendant du mat√©riel.

- `Description:` doit √™tre concise et sans ligne vide.

#### üí° Test

```bash
cat mypkg/DEBIAN/control
```

> ‚úÖ V√©rifiez la pr√©sence de tous les champs.

---

### üß± √âtape 3 ‚Äî Construire le paquet `.deb`

#### üíª Commande

```bash
dpkg-deb --build mypkg
```

#### üß† Observation

> ‚úÖ R√©sultat attendu :
> 
> ```
> dpkg-deb: building package 'hello-minimal' in 'mypkg.deb'.
> ```

Listez le r√©sultat :

```bash
ls -lh
```

> Vous verrez un fichier `mypkg.deb`.

---

### üîç √âtape 4 ‚Äî V√©rifier la validit√© du paquet avant installation

#### üíª Commandes

```bash
dpkg-deb --info mypkg.deb
dpkg-deb --contents mypkg.deb
```

> Observation :
> 
> - `--info` affiche le contenu du fichier `control`.
> 
> - `--contents` montre la destination des fichiers (`usr/local/bin/hello.sh`).

---

### üì¶ √âtape 5 ‚Äî Installer et tester le paquet

#### üíª Action

```bash
sudo dpkg -i mypkg.deb
```

#### üß† Observation

> ‚úÖ Sortie typique :
> 
> ```
> Setting up hello-minimal (1.0) ...
> ```

Testez le script :

```bash
hello.sh
```

> ‚úÖ R√©sultat attendu :
> 
> ```
> Bonjour, utilisateur ! Bienvenue sur debian-lab.
> ```

---

### ‚öôÔ∏è √âtape 6 ‚Äî Observer les traces dans la base `dpkg`

#### üíª Commandes

```bash
dpkg -l | grep hello-minimal
dpkg -L hello-minimal
ls /var/lib/dpkg/info/ | grep hello-minimal
```

#### üí° Interpr√©tation

- `dpkg -l` montre l‚Äô√©tat du paquet (`ii`).

- `dpkg -L` liste les fichiers install√©s.

- Les fichiers de suivi (`.list`, `.md5sums`) se trouvent dans `/var/lib/dpkg/info/`.

---

### üß® √âtape 7 ‚Äî Simuler une erreur de m√©tadonn√©e et corriger

#### üé¨ Sc√©nario

Un coll√®gue a modifi√© le fichier `control` avant la construction et a oubli√© le champ `Version:`.

#### üíª Test

```bash
mkdir brokenpkg && cp -r mypkg/* brokenpkg/
sed -i '/Version:/d' brokenpkg/DEBIAN/control
dpkg-deb --build brokenpkg
```

> ‚ö†Ô∏è Erreur attendue :
> 
> ```
> dpkg-deb: error: parsing file 'control' near line 2: missing field 'Version'
> ```

#### üí° R√©paration

Ajoutez le champ manquant et reconstruisez :

```bash
sed -i '2iVersion: 1.1' brokenpkg/DEBIAN/control
dpkg-deb --build brokenpkg
```

> ‚úÖ Construction r√©ussie.

---

### üßπ √âtape 8 ‚Äî D√©sinstallation et nettoyage

#### üíª Commandes

```bash
sudo dpkg -r hello-minimal
sudo dpkg -P hello-minimal
```

> Observation : `dpkg -r` supprime les binaires, `-P` (purge) efface aussi la configuration.

V√©rifiez :

```bash
dpkg -l | grep hello-minimal || echo "Paquet bien supprim√©"
```

---

## ‚úÖ 4. V√©rification des r√©sultats

- Le paquet `.deb` a √©t√© construit et install√© avec succ√®s.

- Le script fonctionne depuis n‚Äôimporte quel r√©pertoire.

- La suppression compl√®te ne laisse aucune trace (`dpkg --audit` vide).

- Les m√©tadonn√©es sont conformes.

---

## üßπ 5. Nettoyage complet

```bash
cd ~
rm -rf ~/lab_dpkg_build
sudo apt autoremove -y && sudo apt clean
```

---

## üí° 6. Astuces & Pi√®ges p√©dagogiques

| Type      | Description                                                                                                               |
| --------- | ------------------------------------------------------------------------------------------------------------------------- |
| üí° Astuce | `dpkg-deb --build` cr√©e le paquet ; `dpkg-deb --root-owner-group` corrige les permissions si besoin.                      |
| üí° Astuce | `Architecture: all` √©vite les erreurs de compatibilit√© mat√©rielle.                                                        |
| üí° Astuce | Vous pouvez tester la taille du paquet avec `dpkg-deb --showformat='${Package} ${Installed-Size}\n' --show mypkg.deb`.    |
| ‚ö†Ô∏è Pi√®ge  | Oublier un champ obligatoire (`Package`, `Version`, `Architecture`, `Maintainer`, `Description`) rend le paquet invalide. |
| ‚ö†Ô∏è Pi√®ge  | Les chemins dans `usr/local/bin` doivent √™tre relatifs √† la racine du syst√®me, sans ‚Äú/‚Äù initial.                          |
| ‚ö†Ô∏è Pi√®ge  | Ne pas ex√©cuter `dpkg -i` dans un r√©pertoire contenant plusieurs `.deb` : `dpkg` ne choisira pas automatiquement le bon.  |

---

# üß± Atelier 4 ‚Äî Paquet Debian complet : **LogPinger** (service `oneshot` + `timer`)

## üéØ Objectif

D√©ployer un utilitaire Python qui ping une liste d‚Äôh√¥tes et consigne les r√©sultats :

- binaire Python : `/usr/local/bin/logpinger.py`

- config : `/etc/logpinger/config.json`

- √©tat : `/var/lib/logpinger/state.json`

- logs : `/var/log/logpinger/monitor.log`

- int√©gration systemd : `logpinger.service` (oneshot) + `logpinger.timer`

---

## üß∞ Pr√©-requis

- Debian 12 / Ubuntu 22.04

- `sudo`, `python3`, `iputils-ping`, `dpkg-deb`

---

## ü™ú √âtapes

### 1) Pr√©parer l‚Äôarborescence de construction

```bash
mkdir -p ~/lab_logpinger/logpinger_pkg/{DEBIAN,usr/local/bin,etc/logpinger,var/lib/logpinger,var/log/logpinger,etc/systemd/system}
```

---

### 2) Programme principal Python

Cr√©er le fichier **`logpinger_pkg/usr/local/bin/logpinger.py`** :

```bash
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
LogPinger : utilitaire simple qui v√©rifie la connectivit√© (ping) vers une liste d'h√¥tes
et √©crit les r√©sultats dans /var/log/logpinger/monitor.log, tout en stockant le dernier
√©tat par h√¥te dans /var/lib/logpinger/state.json.

Chemins attendus (install√©s par le paquet) :
- /etc/logpinger/config.json   : configuration (liste des h√¥tes)
- /var/lib/logpinger/state.json: fichier d'√©tat (dernier statut + horodatage)
- /var/log/logpinger/monitor.log: journal des ex√©cutions
"""

import subprocess
import json
import os
from datetime import datetime

CONFIG_FILE = "/etc/logpinger/config.json"
STATE_FILE = "/var/lib/logpinger/state.json"
LOG_FILE = "/var/log/logpinger/monitor.log"

def load_config():
    """Charge la configuration JSON contenant au minimum la cl√© 'hosts' (liste)."""
    with open(CONFIG_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def load_state():
    """Charge le fichier d'√©tat si pr√©sent, sinon renvoie un dict vide."""
    if os.path.exists(STATE_FILE):
        with open(STATE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

def save_state(state):
    """Sauvegarde le dict d'√©tat au format JSON (lisible)."""
    os.makedirs(os.path.dirname(STATE_FILE), exist_ok=True)
    with open(STATE_FILE, "w", encoding="utf-8") as f:
        json.dump(state, f, indent=2, ensure_ascii=False)

def ping_host(host: str, count: int = 1, timeout_sec: int = 2) -> bool:
    """
    Retourne True si un ping ICMP simple (count paquets) r√©ussit, False sinon.
    -c : nombre de paquets
    -W : d√©lai d'attente (en secondes) pour la r√©ponse
    """
    try:
        subprocess.run(
            ["ping", "-c", str(count), "-W", str(timeout_sec), host],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            check=True
        )
        return True
    except subprocess.CalledProcessError:
        return False

def log_line(message: str):
    """Ajoute une ligne dat√©e dans le fichier de log."""
    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(f"{now} | {message}\n")

def main():
    """
    - Lit la liste des h√¥tes depuis la config.
    - Ping chaque h√¥te et produit une ligne de log.
    - Met √† jour le fichier d'√©tat avec (status, timestamp).
    """
    cfg = load_config()
    hosts = cfg.get("hosts", [])
    if not hosts:
        log_line("Aucun h√¥te d√©fini dans la configuration.")
        return

    state = load_state()
    for host in hosts:
        ok = ping_host(host)
        status = "OK" if ok else "KO"
        state[host] = {
            "status": status,
            "timestamp": datetime.now().isoformat(timespec="seconds")
        }
        log_line(f"{host} : {status}")

    save_state(state)

if __name__ == "__main__":
    main()
```

Rendre ex√©cutable :

```bash
chmod +x logpinger_pkg/usr/local/bin/logpinger.py
```

---

### 3) Configuration (JSON)

> Remarque : JSON **n‚Äôaccepte pas** les commentaires. Documentez les cl√©s dans l‚Äôatelier, pas dans le fichier.

Cr√©er le fichier **`logpinger_pkg/etc/logpinger/config.json`** :

```bash
{
  "hosts": ["8.8.8.8", "1.1.1.1", "debian.org"]
}
```

---

### 4) Unit√© systemd (service `oneshot`)

Cr√©er le fichier **`logpinger_pkg/etc/systemd/system/logpinger.service`** :

```bash
[Unit]
Description=V√©rification ponctuelle de connectivit√© r√©seau (LogPinger)

[Service]
Type=oneshot
# Lance le script Python une fois, puis s'arr√™te (pilot√© par le timer)
ExecStart=/usr/local/bin/logpinger.py
```

---

### 5) Timer systemd (toutes les 5 minutes)

Cr√©er le fichier **`logpinger_pkg/etc/systemd/system/logpinger.timer`** :

```bash
[Unit]
Description=Lance LogPinger toutes les 5 minutes

[Timer]
# Premi√®re ex√©cution 30 s apr√®s le boot
OnBootSec=30s
# Puis toutes les 5 minutes apr√®s chaque ex√©cution
OnUnitActiveSec=5min
Unit=logpinger.service

[Install]
WantedBy=timers.target
```

---

### 6) M√©tadonn√©es Debian

Cr√©er le fichier **`logpinger_pkg/DEBIAN/control`** :

```bash
Package: logpinger
Version: 1.0
Section: admin
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Description: Outil Python simple de supervision de connectivit√© (ping) avec journaux et √©tat.
```

*(option recommand√© pour permissions root dans le .deb)*  
Cr√©er le fichier **`logpinger_pkg/DEBIAN/postinst`** :

```bash
#!/bin/sh
set -e
# Assure l'existence et les droits des r√©pertoires d'√©tat et de log
install -d -m 0755 /var/lib/logpinger
install -d -m 0755 /var/log/logpinger
# Recharge systemd pour prendre en compte les nouvelles unit√©s
systemctl daemon-reload || true
# Active le timer (ne d√©marre pas imm√©diatement le service)
systemctl enable --now logpinger.timer || true
exit 0
```

Cr√©er le fichier **`logpinger_pkg/DEBIAN/prerm`** :

```bash
#!/bin/sh
set -e
# D√©sactive/arr√™te le timer avant suppression
systemctl disable --now logpinger.timer || true
exit 0
```

Cr√©er le fichier **`logpinger_pkg/DEBIAN/postrm`** :

```bash
#!/bin/sh
set -e
# Nettoyage l√©ger post-suppression (on conserve les logs/√©tat sauf purge)
systemctl daemon-reload || true
exit 0
```

Rendre les maintainer-scripts ex√©cutables :

```bash
chmod 0755 logpinger_pkg/DEBIAN/postinst logpinger_pkg/DEBIAN/prerm logpinger_pkg/DEBIAN/postrm
```

---

### 7) Construire le paquet

```bash
dpkg-deb --build logpinger_pkg
# attend : logpinger_pkg.deb
```

---

### 8) Installer et activer

```bash
sudo dpkg -i logpinger_pkg.deb
# postinst active d√©j√† le timer, mais on peut forcer un reload si besoin :
sudo systemctl daemon-reload
sudo systemctl enable --now logpinger.timer
```

V√©rifier le timer :

```bash
systemctl list-timers | grep logpinger
```

---

### 9) Tester le fonctionnement

Ex√©cution ponctuelle manuelle :

```bash
sudo systemctl start logpinger.service
```

Consulter les journaux et l‚Äô√©tat :

```bash
sudo tail -n 50 /var/log/logpinger/monitor.log
sudo cat /var/lib/logpinger/state.json
```

---

### 10) D√©sinstaller / Purger

```bash
sudo systemctl disable --now logpinger.timer
sudo dpkg -r logpinger          # supprime les binaires/configs "non-conffiles"
sudo dpkg -P logpinger          # purge + supprime fichiers de config (conffiles)
```

*(apr√®s purge, /etc/logpinger/* peut √™tre supprim√© si marqu√© conffile ; /var/log et /var/lib restent souvent pour post-audit ‚Äî √† ajuster selon votre politique.)*

---

## ‚úÖ V√©rification finale

- `logpinger.service` = `oneshot` ‚úÖ

- `logpinger.timer` lance toutes les 5 min ‚úÖ

- logs dans `/var/log/logpinger/monitor.log` ‚úÖ

- √©tat dans `/var/lib/logpinger/state.json` ‚úÖ

- config JSON dans `/etc/logpinger/config.json` ‚úÖ

---

## üí° Astuces & Pi√®ges

- **Astuces**
  
  - `postinst` garantit l‚Äôexistence et les droits des r√©pertoires cibles.
  
  - `systemctl daemon-reload` apr√®s installation d‚Äôunit√©s systemd via un `.deb`.
  
  - Utilisez `Architecture: all` (script Python ind√©pendant mat√©riel).

- **Pi√®ges**
  
  - JSON sans commentaires : documentez la config dans l‚Äôatelier, pas dans le fichier.
  
  - Oublier de rendre ex√©cutable `postinst/prerm/postrm`.
  
  - Tester des h√¥tes injoignables induit des `KO` normaux : c‚Äôest un *test*, pas une erreur du service.


