# 🗃️ Atelier 8 — Dépôt Debian professionnel avec Nexus Repository OSS

- ✅ les **10 points d’amélioration** précédents ;

- ✅ un **serveur de packages dédié** pour un usage professionnel réaliste ;

- ✅ la démonstration **multi-machine** : publication du `.deb` sur un serveur de dépôt (hébergé sous **Nexus Repository OSS**, plus stable que `reprepro` ou `aptly` dans les environnements d’entreprise), puis téléchargement et test depuis un poste client Debian.

Le tout est présenté dans le **format “recette pédagogique complète”**, avec contexte, préparation, exécution détaillée, vérifications, nettoyage et pièges.

---

# 🗃️ Atelier 8 — Dépôt Debian professionnel avec Nexus Repository OSS

---

## 🎯 1. Contexte & Objectif




**Objectifs pédagogiques :**

- Installer et configurer Nexus Repository pour héberger des paquets Debian.

- Créer un repository “hosted” Debian et y publier un `.deb`.

- Ajouter le dépôt Nexus sur une machine cliente et installer le paquet.

- Comprendre la structure interne et la validation GPG.

- Comparer brièvement avec un dépôt local manuel.

---

## ⚙️ 2. Préparation de l’environnement

### 🖥️ Machines nécessaires

| Rôle          | OS                       | Nom d’hôte   | Adresse IP      |
| ------------- | ------------------------ | ------------ | --------------- |
| Serveur Nexus | Debian 12 / Ubuntu 22.04 | `nexus.lab`  | `192.168.56.10` |
| Client Debian | Debian 12 / Ubuntu 22.04 | `client.lab` | `192.168.56.20` |

Les deux machines doivent se pinguer mutuellement.

---

### 📦 Prérequis logiciels (sur le serveur)

```bash
sudo apt update
sudo apt install -y openjdk-17-jdk wget gnupg lsof net-tools
```

---

## 🏗️ 3. Installation et configuration de Nexus Repository OSS

---

### 🧩 Étape 1 — Téléchargement et déploiement

```bash
cd /opt
sudo wget https://download.sonatype.com/nexus/3/latest-unix.tar.gz
sudo tar -xzf latest-unix.tar.gz
sudo mv nexus-* nexus
sudo adduser nexus --disabled-password --home /opt/nexus
sudo chown -R nexus:nexus /opt/nexus
```

---

### ⚙️ Étape 2 — Service systemd pour Nexus

Créez `/etc/systemd/system/nexus.service` :

```ini
[Unit]
Description=Nexus Repository OSS
After=network.target

[Service]
Type=simple
User=nexus
ExecStart=/opt/nexus/bin/nexus run
Restart=on-abort

[Install]
WantedBy=multi-user.target
```

Activez et démarrez :

```bash
sudo systemctl daemon-reload
sudo systemctl enable nexus
sudo systemctl start nexus
```

> 🔍 Vérifiez : `sudo netstat -tlnp | grep 8081`  
> Nexus écoute sur le port 8081.

---

### 🌐 Étape 3 — Accès web et configuration initiale

1. Ouvrez dans le navigateur :  
   `http://192.168.56.10:8081`

2. Connectez-vous avec :
   
   - user : `admin`
   
   - mot de passe : contenu du fichier `/opt/sonatype-work/nexus3/admin.password`

3. Changez le mot de passe et désactivez le mode “Allow anonymous”.

---

## 🧱 4. Création du dépôt Debian dans Nexus

### 🧩 Étape 4.1 — Créer un repository Debian “hosted”

1. **Repositories → Create repository → Debian (hosted)**

2. Paramètres :
   
   - **Name** : `debian-internal`
   
   - **Distribution** : `stable`
   
   - **Component** : `main`
   
   - **Architecture** : `amd64`
   
   - **Deployment policy** : `Allow redeploy`
   
   - **Hosted type** : `hosted`

3. Cliquez **Create repository**.

> 💡 L’URL du dépôt sera par défaut :  
> `http://192.168.56.10:8081/repository/debian-internal/`

---

## 📦 5. Publication du paquet `.deb` sur Nexus (machine serveur)

### 🧩 Étape 5.1 — Créer un petit paquet d’exemple

```bash
mkdir -p ~/mypkg_1.0_all/DEBIAN
cat > ~/mypkg_1.0_all/DEBIAN/control <<'EOF'
Package: mypkg
Version: 1.0
Section: misc
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Description: Petit paquet interne pour dépôt Nexus.
EOF
dpkg-deb --build ~/mypkg_1.0_all
```

---

### ⚙️ Étape 5.2 — Uploader via l’API Nexus

Nexus 3 ne fournit pas d’interface Debian interactive ; l’upload se fait via API REST :

```bash
curl -u admin:monmotdepasse \
     --upload-file mypkg_1.0_all.deb \
     "http://192.168.56.10:8081/repository/debian-internal/pool/main/m/mypkg/mypkg_1.0_all.deb"
```

> ✅ Retour attendu : code HTTP 201 Created.

#### 💡 Vérification Web

Dans l’interface Nexus → Browse → debian-internal → `pool/main/m/mypkg/`  
Votre paquet y apparaît.

---

## 💻 6. Consommation du dépôt depuis la machine cliente

---

### 🧩 Étape 6.1 — Ajout du dépôt Nexus dans APT

Sur `client.lab` :

```bash
echo "deb [trusted=yes] http://192.168.56.10:8081/repository/debian-internal stable main" \
| sudo tee /etc/apt/sources.list.d/nexus.list
sudo apt update
```

> Vérifiez : APT affiche le dépôt `[debian-internal]`.

---

### 🧩 Étape 6.2 — Installation du paquet depuis Nexus

```bash
sudo apt install mypkg
```

> ✅ Sortie attendue :
> 
> ```
> Get:1 http://192.168.56.10:8081/repository/debian-internal stable/main amd64 mypkg all 1.0
> Setting up mypkg (1.0) ...
> ```

---

### 🧩 Étape 6.3 — Observation du catalogue APT

```bash
apt-cache policy mypkg
```

> Observation : montre la provenance `500 http://192.168.56.10:8081/...`

---

### 🧩 Étape 6.4 — Test de mise à jour (v 1.1)

Sur la machine serveur :

```bash
mkdir -p ~/mypkg_1.1_all/DEBIAN
cat > ~/mypkg_1.1_all/DEBIAN/control <<'EOF'
Package: mypkg
Version: 1.1
Architecture: all
Maintainer: Formateur <formateur@lab>
Description: Nouvelle version du paquet interne.
EOF
dpkg-deb --build ~/mypkg_1.1_all
curl -u admin:monmotdepasse \
     --upload-file mypkg_1.1_all.deb \
     "http://192.168.56.10:8081/repository/debian-internal/pool/main/m/mypkg/mypkg_1.1_all.deb"
```

Sur la machine cliente :

```bash
sudo apt update
apt list --upgradable | grep mypkg
sudo apt upgrade -y mypkg
```

> ✅ La version 1.1 est proposée et installée.

---

## 🔍 7. Vérifications & diagnostics

### Vérifier la structure interne (sur le serveur)

```bash
tree -L 4 /opt/sonatype-work/nexus3/blobs/default/content/vol-*/chap-*/pool
```

### Vérifier la cohérence côté client

```bash
apt-cache show mypkg | grep -E 'Version|Description'
apt policy mypkg
```

### Cas d’erreur à tester

1. **`Packages.gz` manquant** → forcer `sudo apt update` et observer le message.

2. **Dépôt inaccessible** → stopper Nexus : `sudo systemctl stop nexus` et constater l’erreur `Err:... Connection refused`.

---

## ✅ 8. Vérification des résultats pédagogiques

1. Vous avez installé et configuré Nexus Repository OSS.

2. Vous savez publier un paquet Debian interne via l’API REST.

3. Vous savez ajouter ce dépôt sur un autre hôte et installer depuis `apt`.

4. Vous pouvez mettre à jour le paquet et voir la propagation.

5. Vous avez visualisé la structure interne et compris les fichiers de métadonnées.

---

## 🧹 9. Nettoyage complet

### Sur le client

```bash
sudo apt remove mypkg -y
sudo rm /etc/apt/sources.list.d/nexus.list
sudo apt autoremove -y && sudo apt clean
```

### Sur le serveur

```bash
sudo systemctl stop nexus
sudo rm -rf /opt/nexus /opt/sonatype-work
sudo deluser --remove-home nexus
sudo rm -rf ~/mypkg_* ~/lab_dpkg_repo
```

---

## 💡 10. Astuces & Pièges pédagogiques

| Type      | Description                                                                                          |
| --------- | ---------------------------------------------------------------------------------------------------- |
| 💡 Astuce | Nexus OSS supporte aussi Maven, PyPI, npm ; utile pour standardiser vos dépôts internes.             |
| 💡 Astuce | `apt-cache policy` permet d’identifier la source exacte d’un paquet (URL + priorité).                |
| 💡 Astuce | `curl -u user:pwd --upload-file file.deb` est pratique pour CI/CD sans interface web.                |
| ⚠️ Piège  | Ne pas oublier le suffixe `/repository/<repo>` dans l’URL APT.                                       |
| ⚠️ Piège  | Si le dépôt est signé, importer la clé publique : `curl http://.../key.gpg                           |
| ⚠️ Piège  | Si `dpkg-scanpackages` n’est pas exécuté (dépôt manuel), `Packages.gz` manquant bloque `apt update`. |



## ⏱ 11. Durée estimée (terrain)

🕒 **≈ 90 minutes**

- 20 min : installation Nexus + service systemd

- 20 min : création repository Debian + publication

- 20 min : configuration client et tests d’installation

- 20 min : mise à jour, diagnostic et observation des erreurs

- 10 min : nettoyage et bilan pédagogique


