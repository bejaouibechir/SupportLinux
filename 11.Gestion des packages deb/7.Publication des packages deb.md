# ğŸ—ƒï¸ Atelier 8 â€” DÃ©pÃ´t Debian professionnel avec Nexus Repository OSS

- âœ… les **10 points dâ€™amÃ©lioration** prÃ©cÃ©dents ;

- âœ… un **serveur de packages dÃ©diÃ©** pour un usage professionnel rÃ©aliste ;

- âœ… la dÃ©monstration **multi-machine** : publication du `.deb` sur un serveur de dÃ©pÃ´t (hÃ©bergÃ© sous **Nexus Repository OSS**, plus stable que `reprepro` ou `aptly` dans les environnements dâ€™entreprise), puis tÃ©lÃ©chargement et test depuis un poste client Debian.

Le tout est prÃ©sentÃ© dans le **format â€œrecette pÃ©dagogique complÃ¨teâ€**, avec contexte, prÃ©paration, exÃ©cution dÃ©taillÃ©e, vÃ©rifications, nettoyage et piÃ¨ges.

---

# ğŸ—ƒï¸ Atelier 8 â€” DÃ©pÃ´t Debian professionnel avec Nexus Repository OSS

---

## ğŸ¯ 1. Contexte & Objectif




**Objectifs pÃ©dagogiques :**

- Installer et configurer Nexus Repository pour hÃ©berger des paquets Debian.

- CrÃ©er un repository â€œhostedâ€ Debian et y publier un `.deb`.

- Ajouter le dÃ©pÃ´t Nexus sur une machine cliente et installer le paquet.

- Comprendre la structure interne et la validation GPG.

- Comparer briÃ¨vement avec un dÃ©pÃ´t local manuel.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### ğŸ–¥ï¸ Machines nÃ©cessaires

| RÃ´le          | OS                       | Nom dâ€™hÃ´te   | Adresse IP      |
| ------------- | ------------------------ | ------------ | --------------- |
| Serveur Nexus | Debian 12 / Ubuntu 22.04 | `nexus.lab`  | `192.168.56.10` |
| Client Debian | Debian 12 / Ubuntu 22.04 | `client.lab` | `192.168.56.20` |

Les deux machines doivent se pinguer mutuellement.

---

### ğŸ“¦ PrÃ©requis logiciels (sur le serveur)

```bash
sudo apt update
sudo apt install -y openjdk-17-jdk wget gnupg lsof net-tools
```

---

## ğŸ—ï¸ 3. Installation et configuration de Nexus Repository OSS

---

### ğŸ§© Ã‰tape 1 â€” TÃ©lÃ©chargement et dÃ©ploiement

```bash
cd /opt
sudo wget https://download.sonatype.com/nexus/3/latest-unix.tar.gz
sudo tar -xzf latest-unix.tar.gz
sudo mv nexus-* nexus
sudo adduser nexus --disabled-password --home /opt/nexus
sudo chown -R nexus:nexus /opt/nexus
```

---

### âš™ï¸ Ã‰tape 2 â€” Service systemd pour Nexus

CrÃ©ez `/etc/systemd/system/nexus.service` :

```ini
[Unit]
Description=Nexus Repository OSS
After=network.target

[Service]
Type=simple
User=nexus
ExecStart=/opt/nexus/bin/nexus run
Restart=on-abort

[Install]
WantedBy=multi-user.target
```

Activez et dÃ©marrez :

```bash
sudo systemctl daemon-reload
sudo systemctl enable nexus
sudo systemctl start nexus
```

> ğŸ” VÃ©rifiez : `sudo netstat -tlnp | grep 8081`  
> Nexus Ã©coute sur le port 8081.

---

### ğŸŒ Ã‰tape 3 â€” AccÃ¨s web et configuration initiale

1. Ouvrez dans le navigateur :  
   `http://192.168.56.10:8081`

2. Connectez-vous avec :
   
   - user : `admin`
   
   - mot de passe : contenu du fichier `/opt/sonatype-work/nexus3/admin.password`

3. Changez le mot de passe et dÃ©sactivez le mode â€œAllow anonymousâ€.

---

## ğŸ§± 4. CrÃ©ation du dÃ©pÃ´t Debian dans Nexus

### ğŸ§© Ã‰tape 4.1 â€” CrÃ©er un repository Debian â€œhostedâ€

1. **Repositories â†’ Create repository â†’ Debian (hosted)**

2. ParamÃ¨tres :
   
   - **Name** : `debian-internal`
   
   - **Distribution** : `stable`
   
   - **Component** : `main`
   
   - **Architecture** : `amd64`
   
   - **Deployment policy** : `Allow redeploy`
   
   - **Hosted type** : `hosted`

3. Cliquez **Create repository**.

> ğŸ’¡ Lâ€™URL du dÃ©pÃ´t sera par dÃ©faut :  
> `http://192.168.56.10:8081/repository/debian-internal/`

---

## ğŸ“¦ 5. Publication du paquet `.deb` sur Nexus (machine serveur)

### ğŸ§© Ã‰tape 5.1 â€” CrÃ©er un petit paquet dâ€™exemple

```bash
mkdir -p ~/mypkg_1.0_all/DEBIAN
cat > ~/mypkg_1.0_all/DEBIAN/control <<'EOF'
Package: mypkg
Version: 1.0
Section: misc
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Description: Petit paquet interne pour dÃ©pÃ´t Nexus.
EOF
dpkg-deb --build ~/mypkg_1.0_all
```

---

### âš™ï¸ Ã‰tape 5.2 â€” Uploader via lâ€™API Nexus

Nexus 3 ne fournit pas dâ€™interface Debian interactive ; lâ€™upload se fait via API REST :

```bash
curl -u admin:monmotdepasse \
     --upload-file mypkg_1.0_all.deb \
     "http://192.168.56.10:8081/repository/debian-internal/pool/main/m/mypkg/mypkg_1.0_all.deb"
```

> âœ… Retour attendu : code HTTP 201 Created.

#### ğŸ’¡ VÃ©rification Web

Dans lâ€™interface Nexus â†’ Browse â†’ debian-internal â†’ `pool/main/m/mypkg/`  
Votre paquet y apparaÃ®t.

---

## ğŸ’» 6. Consommation du dÃ©pÃ´t depuis la machine cliente

---

### ğŸ§© Ã‰tape 6.1 â€” Ajout du dÃ©pÃ´t Nexus dans APT

Sur `client.lab` :

```bash
echo "deb [trusted=yes] http://192.168.56.10:8081/repository/debian-internal stable main" \
| sudo tee /etc/apt/sources.list.d/nexus.list
sudo apt update
```

> VÃ©rifiez : APT affiche le dÃ©pÃ´t `[debian-internal]`.

---

### ğŸ§© Ã‰tape 6.2 â€” Installation du paquet depuis Nexus

```bash
sudo apt install mypkg
```

> âœ… Sortie attendue :
> 
> ```
> Get:1 http://192.168.56.10:8081/repository/debian-internal stable/main amd64 mypkg all 1.0
> Setting up mypkg (1.0) ...
> ```

---

### ğŸ§© Ã‰tape 6.3 â€” Observation du catalogue APT

```bash
apt-cache policy mypkg
```

> Observation : montre la provenance `500 http://192.168.56.10:8081/...`

---

### ğŸ§© Ã‰tape 6.4 â€” Test de mise Ã  jour (v 1.1)

Sur la machine serveur :

```bash
mkdir -p ~/mypkg_1.1_all/DEBIAN
cat > ~/mypkg_1.1_all/DEBIAN/control <<'EOF'
Package: mypkg
Version: 1.1
Architecture: all
Maintainer: Formateur <formateur@lab>
Description: Nouvelle version du paquet interne.
EOF
dpkg-deb --build ~/mypkg_1.1_all
curl -u admin:monmotdepasse \
     --upload-file mypkg_1.1_all.deb \
     "http://192.168.56.10:8081/repository/debian-internal/pool/main/m/mypkg/mypkg_1.1_all.deb"
```

Sur la machine cliente :

```bash
sudo apt update
apt list --upgradable | grep mypkg
sudo apt upgrade -y mypkg
```

> âœ… La version 1.1 est proposÃ©e et installÃ©e.

---

## ğŸ” 7. VÃ©rifications & diagnostics

### VÃ©rifier la structure interne (sur le serveur)

```bash
tree -L 4 /opt/sonatype-work/nexus3/blobs/default/content/vol-*/chap-*/pool
```

### VÃ©rifier la cohÃ©rence cÃ´tÃ© client

```bash
apt-cache show mypkg | grep -E 'Version|Description'
apt policy mypkg
```

### Cas dâ€™erreur Ã  tester

1. **`Packages.gz` manquant** â†’ forcer `sudo apt update` et observer le message.

2. **DÃ©pÃ´t inaccessible** â†’ stopper Nexus : `sudo systemctl stop nexus` et constater lâ€™erreur `Err:... Connection refused`.

---

## âœ… 8. VÃ©rification des rÃ©sultats pÃ©dagogiques

1. Vous avez installÃ© et configurÃ© Nexus Repository OSS.

2. Vous savez publier un paquet Debian interne via lâ€™API REST.

3. Vous savez ajouter ce dÃ©pÃ´t sur un autre hÃ´te et installer depuis `apt`.

4. Vous pouvez mettre Ã  jour le paquet et voir la propagation.

5. Vous avez visualisÃ© la structure interne et compris les fichiers de mÃ©tadonnÃ©es.

---

## ğŸ§¹ 9. Nettoyage complet

### Sur le client

```bash
sudo apt remove mypkg -y
sudo rm /etc/apt/sources.list.d/nexus.list
sudo apt autoremove -y && sudo apt clean
```

### Sur le serveur

```bash
sudo systemctl stop nexus
sudo rm -rf /opt/nexus /opt/sonatype-work
sudo deluser --remove-home nexus
sudo rm -rf ~/mypkg_* ~/lab_dpkg_repo
```

---

## ğŸ’¡ 10. Astuces & PiÃ¨ges pÃ©dagogiques

| Type      | Description                                                                                          |
| --------- | ---------------------------------------------------------------------------------------------------- |
| ğŸ’¡ Astuce | Nexus OSS supporte aussi Maven, PyPI, npm ; utile pour standardiser vos dÃ©pÃ´ts internes.             |
| ğŸ’¡ Astuce | `apt-cache policy` permet dâ€™identifier la source exacte dâ€™un paquet (URL + prioritÃ©).                |
| ğŸ’¡ Astuce | `curl -u user:pwd --upload-file file.deb` est pratique pour CI/CD sans interface web.                |
| âš ï¸ PiÃ¨ge  | Ne pas oublier le suffixe `/repository/<repo>` dans lâ€™URL APT.                                       |
| âš ï¸ PiÃ¨ge  | Si le dÃ©pÃ´t est signÃ©, importer la clÃ© publique : `curl http://.../key.gpg                           |
| âš ï¸ PiÃ¨ge  | Si `dpkg-scanpackages` nâ€™est pas exÃ©cutÃ© (dÃ©pÃ´t manuel), `Packages.gz` manquant bloque `apt update`. |



## â± 11. DurÃ©e estimÃ©e (terrain)

ğŸ•’ **â‰ˆ 90 minutes**

- 20 min : installation Nexus + service systemd

- 20 min : crÃ©ation repository Debian + publication

- 20 min : configuration client et tests dâ€™installation

- 20 min : mise Ã  jour, diagnostic et observation des erreurs

- 10 min : nettoyage et bilan pÃ©dagogique


