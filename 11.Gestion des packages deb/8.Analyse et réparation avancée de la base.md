

# üß© Atelier 9 ‚Äî Analyse et r√©paration avanc√©e de la base dpkg



## üéØ 1. Contexte m√©tier & objectif

**Contexte r√©aliste :** sur un serveur de test, une mise √† jour importante est interrompue (coupure SSH / disque plein). Plusieurs paquets restent en √©tat incoh√©rent, certains fichiers `.list` ou `.md5sums` sont manquants. L‚Äô√©quipe doit diagnostiquer, r√©parer sans perte de donn√©es et documenter les actions.

**Objectifs :**

- Diagnostiquer une base `dpkg` cass√©e suite √† coupure ou disque plein.

- Reproduire un √©chec r√©el, observer les logs, ex√©cuter une r√©paration progressive (√©chec ‚Üí diagnostic ‚Üí action ‚Üí v√©rification).

- Montrer les risques d‚Äô√©dition manuelle et la proc√©dure s√ªre de sauvegarde/restauration.

- Comparer `dpkg` vs `apt-get check` et lire les journaux `dpkg.log` et `apt/history.log`.

---

## üß∞ 2. Pr√©paration de l‚Äôenvironnement

- Syst√®me : Debian 12 / Ubuntu 22.04

- Acc√®s : `sudo`

- Dossier labo :

```bash
mkdir -p ~/lab_dpkg_repair && cd ~/lab_dpkg_repair
sudo apt update
sudo apt install -y sl
```

V√©rifier l‚Äô√©tat initial :

```bash
dpkg -l | grep sl
sudo dpkg --audit
sudo tail -n 20 /var/log/dpkg.log
sudo tail -n 20 /var/log/apt/history.log
```

---

## ü™ú 3. Sc√©nario r√©aliste ‚Äî ‚Äúcoupure disque plein pendant update‚Äù

Nous allons simuler deux incidents distincts :

1. **Disque plein** pendant `apt upgrade` (√©criture interrompue dans `/var/lib/dpkg/info`).

2. **Coupure SSH** pendant `dpkg --configure -a` (processus tu√©).

> Chaque incident suit la s√©quence : *Observation ‚Üí Analyse ‚Üí Action corrective ‚Üí V√©rification*.

---

### INCIDENT A ‚Äî Simulation : disque plein pendant installation

#### Observation (pr√©parer la simulation)

Faites un commit ‚Äúavant‚Äù :

```bash
sudo cp /var/lib/dpkg/status ~/lab_dpkg_repair/status.before
sudo tar czf ~/lab_dpkg_repair/dpkg-info.before.tgz /var/lib/dpkg/info
```

Simulez disque plein (cr√©ation d‚Äôun fichier occupeur dans /tmp) :

```bash
# cr√©e un fichier de 2G dans /tmp (adapter la taille selon votre espace)
fallocate -l 2G /tmp/filler.img
```

Lancer une installation volumineuse (ou r√©installer un paquet pour provoquer √©criture) :

```bash
sudo apt install --reinstall -y sl  # d√©clenche √©criture dans /var/lib/dpkg/info
```

Pendant l‚Äôinstallation, forcez le disque plein (si pas suffisant) :

```bash
# √©crase l'espace disque
fallocate -l 95% /tmp/filler2.img  # ATTENTION : utilisez prudemment
```

Vous verrez des erreurs `dpkg`/`apt` (troncature d‚Äô√©criture, erreur IO).

#### Analyse

`Observation :` messages d‚Äôerreur pendant `apt`/`dpkg` (ex : I/O error, write failed).  
`Interpr√©tation :` des fichiers `*.list` ou `*.md5sums` peuvent √™tre incomplets ou manquants ‚Üí `dpkg` flaggera paquets en √©tat partiel.

V√©rifier √©tat et anomalies :

```bash
sudo dpkg --audit
sudo dpkg -C
sudo tail -n 50 /var/log/dpkg.log
```

Examinez `/var/lib/dpkg/info` pour paquets affect√©s :

```bash
ls -l /var/lib/dpkg/info | grep sl || true
```

#### Action corrective (premi√®re tentative ‚Äî sans risquer le syst√®me)

1. Lib√©rer de l‚Äôespace disque :

```bash
sudo rm -f /tmp/filler.img /tmp/filler2.img
sync
```

2. Tenter r√©paration automatique :

```bash
sudo apt --fix-broken install
sudo dpkg --configure -a
```

#### V√©rification

```bash
sudo dpkg --audit       # doit idealement √™tre vide
dpkg -l | grep sl
sudo tail -n 50 /var/log/dpkg.log
```

Si `dpkg --configure -a` √©choue encore, passez en mode diagnostic approfondi (voir incident B).

---

### INCIDENT B ‚Äî Simulation : coupure (kill) pendant `dpkg --configure -a`

#### Observation

Lancez une configuration longue (ou simulez) :

```bash
# Simule une action qui prend du temps ; ici, on force le comportement pour l'exemple
sudo apt install -y --reinstall sl
# pendant l'ex√©cution, dans un autre terminal : trouver le PID dpkg et le tuer
pidof dpkg && sudo pkill -SIGTERM dpkg
```

Vous verrez `dpkg` interrompu et certains paquets marqu√©s `iU` ou `half-configured`.

V√©rifiez :

```bash
dpkg -l | egrep 'iU|half'
sudo dpkg --audit
tail -n 50 /var/log/dpkg.log
```

#### Analyse

`Observation :` paquets en √©tat `iU` ou `half-installed`.  
`Interpr√©tation :` l‚Äô√©tape de `configure` n‚Äôa pas √©t√© ex√©cut√©e ‚Äî scripts maintainer non lanc√©s ou interrompus ‚Üí risque de fichiers partiels et d√©pendances cass√©es.

#### Action corrective (approche progressive)

1. Tenter une reconfiguration :

```bash
sudo dpkg --configure -a
```

2. Si √©chec, ex√©cuter `dpkg -C` pour suggestions :

```bash
sudo dpkg -C
```

3. Pour un paquet pr√©cis bloqu√© (ex : `sl`) forcez la r√©installation :

```bash
sudo apt --reinstall install sl
```

4. Si paquet impossible √† configurer, forcer suppression s√ªre puis r√©installer :

```bash
sudo dpkg -r --force-remove-reinstreq sl
sudo apt install -y sl
```

#### V√©rification

```bash
dpkg -l | grep sl
sudo dpkg --audit
sudo tail -n 50 /var/log/dpkg.log
```

---

## üßæ 4. Extraits concrets des fichiers-cl√©s (visualisation)

**Observation ‚Üí** affichez et commentez des extraits (ne pas √©diter sans sauvegarde) :

Afficher un bloc `Package:` dans `status` :

```bash
grep -nA6 "^Package: sl$" /var/lib/dpkg/status || true
# Exemple d'affichage √† expliquer : Package:, Status:, Version:, etc.
```

Montrer structure d‚Äôun `.list` manquant :

```bash
ls -l /var/lib/dpkg/info/sl.list || echo "sl.list manquant"
```

Afficher les md5sums :

```bash
sudo head -n 10 /var/lib/dpkg/info/sl.md5sums || echo "md5sums absent"
```

‚Üí **Interpr√©tation p√©dagogique** : montrez comment `dpkg --verify` s‚Äôappuie sur ces `.md5sums` et `.list`.

---

## üîç 5. Comparaison claire : `dpkg` vs `apt-get check`

- `dpkg` est le **gestionnaire bas niveau** : liste/installe/package/configure localement.  
  Commandes utiles : `dpkg --verify`, `dpkg --configure -a`, `dpkg -C`.

- `apt-get`/`apt` est **haut niveau** : r√©sout d√©pendances, t√©l√©charge paquets et peut r√©parer (`apt --fix-broken install`, `apt-get check`).  
  `apt-get check` v√©rifie la coh√©rence du cache et des d√©pendances APT ; il **ne modifie** pas l‚Äô√©tat des paquets par d√©faut.

**Usage recommand√© :** utiliser `dpkg` pour diagnostic fin ; employer `apt --fix-broken` pour r√©paration automatique lorsque appropri√©.

---

## ‚ö†Ô∏è 6. Risques d‚Äô√©dition manuelle du fichier `status` ‚Äî d√©monstration (NE PAS faire en prod)

**Observation :** faites une copie avant toute modif :

```bash
sudo cp /var/lib/dpkg/status /var/lib/dpkg/status.bak
```

**Cas p√©dagogique (danger contr√¥l√©)** : supprimez un bloc `Package: sl` dans un fichier de test (sur copie), puis montrez l‚Äôeffet apr√®s restauration.

Commandes :

```bash
# travailler sur la copie, jamais directement
cp /var/lib/dpkg/status ~/lab_dpkg_repair/status.copy
# montrer comment supprimer (mais NE PAS appliquer)
sed -n '1,80p' ~/lab_dpkg_repair/status.copy | sed -n '1,40p'
# (expliquer : si on supprime le bloc et qu'on replace, dpkg peut perdre connaissance du paquet)
```

**Action corrective s√ªre :** toujours restaurer depuis `status.bak` :

```bash
sudo cp ~/lab_dpkg_repair/status.bak /var/lib/dpkg/status
sudo dpkg --configure -a
```

---

## üßæ 7. Exploitation des journaux pour validation

Lire logs pour tracer l‚Äôincident et la r√©paration :

```bash
sudo tail -n 100 /var/log/dpkg.log
sudo tail -n 100 /var/log/apt/history.log
# Exemple : grep "install" ou "error"
sudo grep -i "error" /var/log/dpkg.log | tail -n 20
```

**Observation p√©dagogique :** montrez la chronologie (timestamp) ‚Üí utile pour post-mortem.

---

## üõ° 8. Sauvegarde & restauration prudente (proc√©dure recommand√©e)

Avant toute op√©ration sensible, sauvegarder :

```bash
sudo tar czf ~/lab_dpkg_repair/dpkg-backup-$(date +%F_%T).tgz /var/lib/dpkg
sudo cp /var/lib/dpkg/status ~/lab_dpkg_repair/status.`date +%F_%T`
```

Pour restaurer (proc√©dure contr√¥l√©e) :

```bash
# Restaurer l'archive (apr√®s v√©rification)
sudo tar xzf dpkg-backup-2025-10-08_12:00:00.tgz -C /
sudo apt-get check
sudo dpkg --configure -a
```

Apr√®s restauration, lister les fichiers `.info` :

```bash
ls -l /var/lib/dpkg/info | head -n 20
```

---

## ‚úÖ 9. V√©rifications finales (Observation ‚Üí Analyse ‚Üí Action pour chaque item)

1. `sudo dpkg --audit` ‚Üí **Observation** : vide ? ‚Üí **Action** : OK.

2. `dpkg -l | egrep 'rc|iU|half'` ‚Üí **Observation** : lignes ‚Üí **Action** : r√©installer/purger.

3. `sudo dpkg --verify <pkg>` ‚Üí **Observation** : marqueurs (`5`, `M`, `L`) ‚Üí **Action** : r√©installation.

4. V√©rifier journaux `dpkg.log` et `apt/history.log` pour confirmer la s√©quence temporelle.

5. Tester `apt-get check` pour confirmer absence d‚Äôanomalies APT.

---

## üßπ 10. Nettoyage & synth√®se finale

Nettoyer le labo et assurer que le syst√®me est propre :

```bash
sudo apt remove --purge sl -y
sudo apt autoremove -y && sudo apt clean
# restauration si vous aviez besoin du snapshot original:
# sudo cp ~/lab_dpkg_repair/status.before /var/lib/dpkg/status
rm -rf ~/lab_dpkg_repair
sudo dpkg --audit
```

Affichez le contr√¥le final :

```bash
dpkg -l | egrep 'rc|iU|half' || echo "Aucune anomalie restante. Base dpkg propre."
```

---

## üí° 11. Astuces & pi√®ges p√©dagogiques (r√©sum√©s)

- Toujours sauvegarder `/var/lib/dpkg/status` avant modification.

- `dpkg -C` fournit des recommandations : regardez-les avant d‚Äôagir.

- `apt --fix-broken install` peut r√©parer automatiquement, mais lisez la proposition.

- `dpkg --verify` compare contre les `.md5sums` ‚Äî expliquez les lettres retourn√©es.

- √âvitez `--force-all` ; utilisez les options `--force-*` cibl√©es et documentez chaque action.

- Conserver les logs et timestamps pour post-mortem.


