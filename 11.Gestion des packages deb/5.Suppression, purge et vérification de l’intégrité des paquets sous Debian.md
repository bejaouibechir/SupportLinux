

# üßπ Atelier 6 ‚Äî Suppression, purge et v√©rification de l‚Äôint√©grit√© des paquets sous Debian

---

## üéØ 1. Contexte & Objectif

Les administrateurs syst√®mes doivent r√©guli√®rement **d√©sinstaller des paquets** sans perturber le syst√®me et **garantir la coh√©rence** de la base `dpkg`.  
Cet atelier vous apprendra √† :

- Identifier les diff√©rents **√©tats de paquet** (`ii`, `rc`, `un`‚Ä¶),

- Diff√©rencier les commandes `dpkg -r` et `dpkg -P`,

- V√©rifier les restes de configuration et les fichiers orphelins,

- Utiliser les options de diagnostic : `--audit`, `--verify`, `--get-selections`.

---

## ‚öôÔ∏è 2. Pr√©paration de l‚Äôenvironnement

### Conditions

- Debian 12 / Ubuntu 22.04

- Acc√®s `sudo`

- Connexion Internet (uniquement pour t√©l√©charger le paquet d‚Äôexemple)

### Mise en place du laboratoire

```bash
mkdir -p ~/lab_dpkg_clean && cd ~/lab_dpkg_clean
sudo apt update
sudo apt install -y cowsay   # paquet l√©ger et visible
```

---

## ü™ú 3. √âtapes pas √† pas

---

### üßæ √âtape 1 ‚Äî Observer l‚Äô√©tat initial du paquet

#### üíª Commandes

```bash
dpkg -l | grep cowsay
```

> ‚úÖ Sortie attendue :  
> `ii cowsay ...` ‚Üí le paquet est install√© et configur√©.

#### üß† Explication

- Premi√®re colonne `ii` = install√© et op√©rationnel.

- Les autres codes possibles : `rc`, `un`, `iU`, `pn`.

---

### üß© √âtape 2 ‚Äî Supprimer le paquet (`-r`)

#### üíª Action

```bash
sudo dpkg -r cowsay
```

#### üí¨ Observation

> ```
> Removing cowsay (3.03+dfsg2-8) ...
> ```

#### üí° V√©rification

```bash
dpkg -l | grep cowsay
```

> ‚úÖ Sortie attendue : `rc cowsay ...` ‚Üí paquet supprim√© mais fichiers de configuration restants.

---

### ‚öôÔ∏è √âtape 3 ‚Äî Localiser les fichiers de configuration restants

```bash
sudo ls -l /etc | grep cowsay || echo "Aucun fichier restant"
```

> Observation : certains paquets laissent un fichier dans `/etc` m√™me apr√®s `-r`.

#### üß† Explication

- Le code `rc` signifie : *Removed but Config files remain*.

- Ces fichiers sont utiles pour une r√©installation rapide avec les m√™mes param√®tres.

---

### üß© √âtape 4 ‚Äî Purger le paquet (`-P`)

#### üíª Action

```bash
sudo dpkg -P cowsay
```

> ‚úÖ Sortie attendue :
> 
> ```
> Purging configuration files for cowsay ...
> ```

#### üí° V√©rification

```bash
dpkg -l | grep cowsay || echo "Aucune trace restante"
```

> ‚úÖ Le paquet dispara√Æt de la liste.  
> Les fichiers de configuration ont √©t√© supprim√©s.

---

### üîç √âtape 5 ‚Äî Comparer les √©tats dans la base dpkg

#### üíª Commandes

```bash
dpkg --get-selections | grep cowsay
```

> Observation : le paquet n‚Äôappara√Æt plus ‚Üí compl√®tement purgeÃÅ.

Affichez tous les paquets supprim√©s mais non purg√©s :

```bash
dpkg -l | awk '$1=="rc"{print $2}'
```

---

### üß∞ √âtape 6 ‚Äî V√©rifier l‚Äôint√©grit√© de la base dpkg

#### üíª Audit global

```bash
sudo dpkg --audit
```

> Observation : renvoie aucune erreur si la base est saine.

#### üíª V√©rification de fichiers

```bash
sudo dpkg --verify
```

> Compare les sommes MD5 avec celles enregistr√©es dans `/var/lib/dpkg/info/*.md5sums`.

---

### ‚öôÔ∏è √âtape 7 ‚Äî Simuler une incoh√©rence et r√©parer

#### üé¨ Sc√©nario

Un fichier de configuration a √©t√© supprim√© manuellement.

#### üíª Action

```bash
sudo apt install -y cowsay
sudo rm /usr/games/cowsay
sudo dpkg --verify cowsay | grep cowsay
```

> ‚úÖ Affiche une diff√©rence (`?5??????`) ‚Üí fichier manquant.

#### ü©π R√©paration

```bash
sudo apt --reinstall install cowsay
```

> R√©installe le paquet et corrige les sommes.

---

### üß† √âtape 8 ‚Äî Observation des fichiers info et statut post-r√©paration

```bash
ls /var/lib/dpkg/info | grep cowsay
dpkg -s cowsay | grep Status
```

> Observation : `Status: install ok installed` ‚Üí base de nouveau coh√©rente.

---

## ‚úÖ 4. V√©rification des r√©sultats

1. Vous savez faire la diff√©rence entre `-r` et `-P`.

2. Vous identifiez les √©tats `ii`, `rc`, `un`.

3. Vous savez utiliser `--audit` et `--verify`.

4. Vous savez corriger une incoh√©rence par r√©installation.

---

## üßπ 5. Nettoyage final

```bash
cd ~
sudo rm -rf ~/lab_dpkg_clean
sudo apt remove --purge cowsay -y
sudo apt autoremove -y && sudo apt clean
```

---

## üí° 6. Astuces & Pi√®ges p√©dagogiques

| Type      | Description                                                                                |
| --------- | ------------------------------------------------------------------------------------------ |
| üí° Astuce | `dpkg -l                                                                                   |
| üí° Astuce | `dpkg --get-selections > sauvegarde.list` peut sauvegarder vos paquets avant un nettoyage. |
| üí° Astuce | `apt --reinstall install <pkg>` r√©pare un paquet sans affecter les autres.                 |
| ‚ö†Ô∏è Pi√®ge  | Supprimer manuellement les fichiers dans `/usr` ou `/etc` d√©synchronise la base dpkg.      |
| ‚ö†Ô∏è Pi√®ge  | Oublier de purger peut laisser des fichiers de config et des services fant√¥mes.            |
| ‚ö†Ô∏è Pi√®ge  | √âvitez `rm -rf /var/lib/dpkg` : cela rend tout le syst√®me inop√©rant.                       |


