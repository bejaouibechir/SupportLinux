

# 🧩 Atelier 3 — Inspection approfondie d’un paquet `.deb`

---

## 🎯 1. Contexte & Objectif

Avant d’installer un paquet avec `dpkg`, il est essentiel de savoir **ce qu’il contient réellement** : fichiers, scripts, métadonnées, dépendances.  
Cet atelier montre comment **décortiquer un fichier `.deb`** pour comprendre sa structure interne et **inspecter les informations qu’il embarque**, sans l’installer.

**Objectif de l’atelier :**

- Identifier la composition interne d’un paquet Debian.

- Lire les métadonnées et dépendances déclarées.

- Explorer les fichiers de configuration embarqués.

- Vérifier la cohérence et l’intégrité du paquet avant installation.

---

## 🧰 2. Préparation de l’environnement

### ⚙️ Conditions

- Machine : Debian 12 ou Ubuntu 22.04

- Accès `sudo`

- Dossier de travail dédié :
  
  ```bash
  mkdir -p ~/lab_dpkg_inspect && cd ~/lab_dpkg_inspect
  ```

### 📦 Télécharger un paquet pour analyse

Utilisez `apt download` pour un paquet simple, sans installation :

```bash
sudo apt update
apt download nano
```

Vérifiez :

```bash
ls -lh
```

> ✅ Vous devez obtenir un fichier du type `nano_7.2-1_amd64.deb`.

---

## 🪜 3. Étapes pas à pas

---

### 🔍 Étape 1 — Identifier la structure du paquet

#### 🎬 Action

```bash
file nano_*.deb
```

> ✅ Sortie :  
> `Debian binary package (format 2.0)`

#### 🧠 Explication

Un paquet `.deb` est en réalité une **archive ar** composée de trois fichiers internes :

- `debian-binary` → indique la version du format (toujours 2.0)

- `control.tar.xz` → contient les métadonnées et scripts de maintenance

- `data.tar.xz` → contient les fichiers qui seront installés dans le système

#### 💡 Observation

Vérifions ces fichiers sans les extraire :

```bash
ar t nano_*.deb
```

> ✅ Résultat attendu :
> 
> ```
> debian-binary
> control.tar.xz
> data.tar.xz
> ```

---

### 📂 Étape 2 — Extraire le contenu pour inspection

#### 🎬 Action

Créez un répertoire d’extraction :

```bash
mkdir extrait && cd extrait
ar x ../nano_*.deb
ls -1
```

> Observation : vous voyez les trois composants principaux.

#### 🧠 Explication

`ar` ne décompresse pas : il extrait simplement les fichiers internes.  
Nous allons maintenant analyser leurs contenus.

---

### 🧾 Étape 3 — Lire les métadonnées (control.tar.xz)

#### 🎬 Action

Extraire les fichiers de contrôle :

```bash
mkdir control && tar -xf control.tar.* -C control
ls control
```

> ✅ Contenu typique : `control`, `md5sums`, `postinst`, `prerm`, `triggers`.

#### 🧠 Observation

Le fichier **`control`** contient les métadonnées déclaratives du paquet.

#### 💻 Lecture :

```bash
cat control/control
```

#### 🧠 Explication

Les champs essentiels :

- `Package:` → nom du paquet

- `Version:` → numéro exact

- `Architecture:` → amd64, all, etc.

- `Depends:` → liste des dépendances minimales

- `Description:` → texte descriptif

💬 Interprétez la ligne `Depends:` : elle définit ce que `dpkg` vérifiera avant d’autoriser l’installation.

---

### 🧮 Étape 4 — Lister les fichiers du paquet (data.tar.xz)

#### 🎬 Action

```bash
mkdir data && tar -xf data.tar.* -C data
tree -L 2 data
```

> ✅ Observation : on voit les répertoires `/usr/bin`, `/usr/share`, `/etc`, etc.

#### 🧠 Explication

Ces fichiers sont ceux qui seraient réellement copiés sur le système si on installait le paquet avec `dpkg -i`.

#### 💡 Test complémentaire

Comptez le nombre total de fichiers :

```bash
find data | wc -l
```

---

### ⚙️ Étape 5 — Examiner les scripts de maintenance (sans les exécuter)

#### 🎬 Action

Affichez le contenu du script `postinst` s’il existe :

```bash
cat control/postinst | head -n 10
```

> Observation : vous verrez souvent des commandes de mise à jour du cache man-page, ou création de symlinks.

#### ⚠️ Attention

Ne pas exécuter ces scripts manuellement ; `dpkg` le fait automatiquement au moment de l’installation.

---

### 🧩 Étape 6 — Vérifier l’intégrité du paquet

#### 🎬 Action

```bash
cd ..
dpkg-deb --info nano_*.deb
```

> ✅ Sortie :
> 
> ```
> new debian package, version 2.0.
> size 217kB.
> control archive: xz compressed.
> Package: nano
> Version: 7.2-1
> Architecture: amd64
> Depends: libc6, libncursesw6
> ```

#### 🧠 Explication

Cette commande lit le même fichier `control` mais sans extraction manuelle.  
C’est la méthode recommandée pour vérifier un paquet reçu par e-mail ou via dépôt interne avant de le déployer.

#### 💡 Vérification de l’intégrité

```bash
dpkg-deb --contents nano_*.deb | head -n 5
```

> Affiche un aperçu des fichiers embarqués avec leurs chemins d’installation futurs.

---

### 🧨 Étape 7 — Simuler un cas de corruption du paquet

#### 🎬 Scénario

On suppose qu’un fichier `.deb` est incomplet (mauvais transfert réseau).

#### 💻 Action

```bash
cp nano_*.deb test_corrupt.deb
truncate -s 50k test_corrupt.deb
dpkg-deb --info test_corrupt.deb
```

> ⚠️ Erreur attendue :
> 
> ```
> dpkg-deb: error: archive 'test_corrupt.deb' has premature member 'control.tar.xz' before 'debian-binary'
> ```

#### 🧠 Explication

`dpkg-deb` valide la cohérence interne du format.  
Ce test montre comment détecter un `.deb` endommagé avant installation.

---

### 📜 Étape 8 — Observation finale

Réaffichez la hiérarchie extraite pour synthèse :

```bash
tree -L 1 extrait
```

> Résumé :
> 
> - `control/` → métadonnées
> 
> - `data/` → fichiers réels
> 
> - `debian-binary` → version du format

---

## ✅ 4. Vérification des résultats

1. Vous pouvez identifier les trois composants d’un `.deb`.

2. Vous savez lire les métadonnées (`control`).

3. Vous avez observé les fichiers réels et leurs destinations.

4. Vous avez détecté un paquet corrompu à l’aide de `dpkg-deb`.

---

## 🧹 5. Nettoyage / Restauration

```bash
cd ~
rm -rf ~/lab_dpkg_inspect
```

---

## 💡 6. Astuces & Pièges pédagogiques

| Type      | Description                                                                                                         |
| --------- | ------------------------------------------------------------------------------------------------------------------- |
| 💡 Astuce | `dpkg-deb --showformat='${Package} ${Version}\n' --show nano_*.deb` donne un résumé personnalisé.                   |
| 💡 Astuce | `ar t paquet.deb` est plus sûr que `dpkg-deb --extract` pour vérifier une archive suspecte.                         |
| 💡 Astuce | `dpkg-deb --info` et `--contents` sont complémentaires : l’un lit les métadonnées, l’autre liste le contenu.        |
| ⚠️ Piège  | Ne jamais modifier les fichiers extraits : `dpkg` refusera ensuite le paquet reconstruit sans recalcul d’intégrité. |
| ⚠️ Piège  | Un paquet `.deb` peut contenir des scripts postinst dangereux ; toujours les lire avant installation.               |


