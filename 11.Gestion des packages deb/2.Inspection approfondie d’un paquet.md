

# ğŸ§© Atelier 3 â€” Inspection approfondie dâ€™un paquet `.deb`

---

## ğŸ¯ 1. Contexte & Objectif

Avant dâ€™installer un paquet avec `dpkg`, il est essentiel de savoir **ce quâ€™il contient rÃ©ellement** : fichiers, scripts, mÃ©tadonnÃ©es, dÃ©pendances.  
Cet atelier montre comment **dÃ©cortiquer un fichier `.deb`** pour comprendre sa structure interne et **inspecter les informations quâ€™il embarque**, sans lâ€™installer.

**Objectif de lâ€™atelier :**

- Identifier la composition interne dâ€™un paquet Debian.

- Lire les mÃ©tadonnÃ©es et dÃ©pendances dÃ©clarÃ©es.

- Explorer les fichiers de configuration embarquÃ©s.

- VÃ©rifier la cohÃ©rence et lâ€™intÃ©gritÃ© du paquet avant installation.

---

## ğŸ§° 2. PrÃ©paration de lâ€™environnement

### âš™ï¸ Conditions

- Machine : Debian 12 ou Ubuntu 22.04

- AccÃ¨s `sudo`

- Dossier de travail dÃ©diÃ© :
  
  ```bash
  mkdir -p ~/lab_dpkg_inspect && cd ~/lab_dpkg_inspect
  ```

### ğŸ“¦ TÃ©lÃ©charger un paquet pour analyse

Utilisez `apt download` pour un paquet simple, sans installation :

```bash
sudo apt update
apt download nano
```

VÃ©rifiez :

```bash
ls -lh
```

> âœ… Vous devez obtenir un fichier du type `nano_7.2-1_amd64.deb`.

---

## ğŸªœ 3. Ã‰tapes pas Ã  pas

---

### ğŸ” Ã‰tape 1 â€” Identifier la structure du paquet

#### ğŸ¬ Action

```bash
file nano_*.deb
```

> âœ… Sortie :  
> `Debian binary package (format 2.0)`

#### ğŸ§  Explication

Un paquet `.deb` est en rÃ©alitÃ© une **archive ar** composÃ©e de trois fichiers internes :

- `debian-binary` â†’ indique la version du format (toujours 2.0)

- `control.tar.xz` â†’ contient les mÃ©tadonnÃ©es et scripts de maintenance

- `data.tar.xz` â†’ contient les fichiers qui seront installÃ©s dans le systÃ¨me

#### ğŸ’¡ Observation

VÃ©rifions ces fichiers sans les extraire :

```bash
ar t nano_*.deb
```

> âœ… RÃ©sultat attendu :
> 
> ```
> debian-binary
> control.tar.xz
> data.tar.xz
> ```

---

### ğŸ“‚ Ã‰tape 2 â€” Extraire le contenu pour inspection

#### ğŸ¬ Action

CrÃ©ez un rÃ©pertoire dâ€™extraction :

```bash
mkdir extrait && cd extrait
ar x ../nano_*.deb
ls -1
```

> Observation : vous voyez les trois composants principaux.

#### ğŸ§  Explication

`ar` ne dÃ©compresse pas : il extrait simplement les fichiers internes.  
Nous allons maintenant analyser leurs contenus.

---

### ğŸ§¾ Ã‰tape 3 â€” Lire les mÃ©tadonnÃ©es (control.tar.xz)

#### ğŸ¬ Action

Extraire les fichiers de contrÃ´le :

```bash
mkdir control && tar -xf control.tar.* -C control
ls control
```

> âœ… Contenu typique : `control`, `md5sums`, `postinst`, `prerm`, `triggers`.

#### ğŸ§  Observation

Le fichier **`control`** contient les mÃ©tadonnÃ©es dÃ©claratives du paquet.

#### ğŸ’» Lecture :

```bash
cat control/control
```

#### ğŸ§  Explication

Les champs essentiels :

- `Package:` â†’ nom du paquet

- `Version:` â†’ numÃ©ro exact

- `Architecture:` â†’ amd64, all, etc.

- `Depends:` â†’ liste des dÃ©pendances minimales

- `Description:` â†’ texte descriptif

ğŸ’¬ InterprÃ©tez la ligne `Depends:` : elle dÃ©finit ce que `dpkg` vÃ©rifiera avant dâ€™autoriser lâ€™installation.

---

### ğŸ§® Ã‰tape 4 â€” Lister les fichiers du paquet (data.tar.xz)

#### ğŸ¬ Action

```bash
mkdir data && tar -xf data.tar.* -C data
tree -L 2 data
```

> âœ… Observation : on voit les rÃ©pertoires `/usr/bin`, `/usr/share`, `/etc`, etc.

#### ğŸ§  Explication

Ces fichiers sont ceux qui seraient rÃ©ellement copiÃ©s sur le systÃ¨me si on installait le paquet avec `dpkg -i`.

#### ğŸ’¡ Test complÃ©mentaire

Comptez le nombre total de fichiers :

```bash
find data | wc -l
```

---

### âš™ï¸ Ã‰tape 5 â€” Examiner les scripts de maintenance (sans les exÃ©cuter)

#### ğŸ¬ Action

Affichez le contenu du script `postinst` sâ€™il existe :

```bash
cat control/postinst | head -n 10
```

> Observation : vous verrez souvent des commandes de mise Ã  jour du cache man-page, ou crÃ©ation de symlinks.

#### âš ï¸ Attention

Ne pas exÃ©cuter ces scripts manuellement ; `dpkg` le fait automatiquement au moment de lâ€™installation.

---

### ğŸ§© Ã‰tape 6 â€” VÃ©rifier lâ€™intÃ©gritÃ© du paquet

#### ğŸ¬ Action

```bash
cd ..
dpkg-deb --info nano_*.deb
```

> âœ… Sortie :
> 
> ```
> new debian package, version 2.0.
> size 217kB.
> control archive: xz compressed.
> Package: nano
> Version: 7.2-1
> Architecture: amd64
> Depends: libc6, libncursesw6
> ```

#### ğŸ§  Explication

Cette commande lit le mÃªme fichier `control` mais sans extraction manuelle.  
Câ€™est la mÃ©thode recommandÃ©e pour vÃ©rifier un paquet reÃ§u par e-mail ou via dÃ©pÃ´t interne avant de le dÃ©ployer.

#### ğŸ’¡ VÃ©rification de lâ€™intÃ©gritÃ©

```bash
dpkg-deb --contents nano_*.deb | head -n 5
```

> Affiche un aperÃ§u des fichiers embarquÃ©s avec leurs chemins dâ€™installation futurs.

---

### ğŸ§¨ Ã‰tape 7 â€” Simuler un cas de corruption du paquet

#### ğŸ¬ ScÃ©nario

On suppose quâ€™un fichier `.deb` est incomplet (mauvais transfert rÃ©seau).

#### ğŸ’» Action

```bash
cp nano_*.deb test_corrupt.deb
truncate -s 50k test_corrupt.deb
dpkg-deb --info test_corrupt.deb
```

> âš ï¸ Erreur attendue :
> 
> ```
> dpkg-deb: error: archive 'test_corrupt.deb' has premature member 'control.tar.xz' before 'debian-binary'
> ```

#### ğŸ§  Explication

`dpkg-deb` valide la cohÃ©rence interne du format.  
Ce test montre comment dÃ©tecter un `.deb` endommagÃ© avant installation.

---

### ğŸ“œ Ã‰tape 8 â€” Observation finale

RÃ©affichez la hiÃ©rarchie extraite pour synthÃ¨se :

```bash
tree -L 1 extrait
```

> RÃ©sumÃ© :
> 
> - `control/` â†’ mÃ©tadonnÃ©es
> 
> - `data/` â†’ fichiers rÃ©els
> 
> - `debian-binary` â†’ version du format

---

## âœ… 4. VÃ©rification des rÃ©sultats

1. Vous pouvez identifier les trois composants dâ€™un `.deb`.

2. Vous savez lire les mÃ©tadonnÃ©es (`control`).

3. Vous avez observÃ© les fichiers rÃ©els et leurs destinations.

4. Vous avez dÃ©tectÃ© un paquet corrompu Ã  lâ€™aide de `dpkg-deb`.

---

## ğŸ§¹ 5. Nettoyage / Restauration

```bash
cd ~
rm -rf ~/lab_dpkg_inspect
```

---

## ğŸ’¡ 6. Astuces & PiÃ¨ges pÃ©dagogiques

| Type      | Description                                                                                                         |
| --------- | ------------------------------------------------------------------------------------------------------------------- |
| ğŸ’¡ Astuce | `dpkg-deb --showformat='${Package} ${Version}\n' --show nano_*.deb` donne un rÃ©sumÃ© personnalisÃ©.                   |
| ğŸ’¡ Astuce | `ar t paquet.deb` est plus sÃ»r que `dpkg-deb --extract` pour vÃ©rifier une archive suspecte.                         |
| ğŸ’¡ Astuce | `dpkg-deb --info` et `--contents` sont complÃ©mentaires : lâ€™un lit les mÃ©tadonnÃ©es, lâ€™autre liste le contenu.        |
| âš ï¸ PiÃ¨ge  | Ne jamais modifier les fichiers extraits : `dpkg` refusera ensuite le paquet reconstruit sans recalcul dâ€™intÃ©gritÃ©. |
| âš ï¸ PiÃ¨ge  | Un paquet `.deb` peut contenir des scripts postinst dangereux ; toujours les lire avant installation.               |


