# ğŸ§° Atelier 5 â€” Gestion complÃ¨te des scripts de maintenance dans un paquet `.deb` (version amÃ©liorÃ©e)

---

## ğŸ¯ 1. Contexte & Objectif

Vous Ãªtes responsable dâ€™un environnement Debian interne oÃ¹ plusieurs utilitaires maison sont dÃ©ployÃ©s sous forme de paquets `.deb`.  
Lâ€™un de ces outils, **`hello-maint`**, doit :

- crÃ©er un fichier de log lors de lâ€™installation,

- enregistrer chaque action (install, remove, purge) avec horodatage,

- nettoyer automatiquement ses traces lors de la dÃ©sinstallation.

Cet atelier montre comment concevoir, intÃ©grer, tester et corriger les **scripts de maintenance Debian** (`postinst`, `prerm`, `postrm`).

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### Conditions minimales

- Debian 12 / Ubuntu 22.04

- AccÃ¨s `sudo`

- Aucun paquet additionnel requis

### Mise en place du laboratoire

```bash
mkdir -p ~/lab_dpkg_scripts && cd ~/lab_dpkg_scripts
```

---

## ğŸªœ 3. Ã‰tapes pas Ã  pas

---

### ğŸ§© Ã‰tape 1 : CrÃ©er le contenu principal du paquet

#### ğŸ¬ ScÃ©nario

Lâ€™utilitaire `hello-maint.sh` affiche un message dâ€™accueil et logge ses exÃ©cutions dans `/var/log/hello-maint/`.

#### ğŸ’» Commandes

```bash
mkdir -p pkg/usr/local/bin
cat > pkg/usr/local/bin/hello-maint.sh <<'EOF'
#!/bin/bash
LOGDIR="/var/log/hello-maint"
LOGFILE="$LOGDIR/hello.log"

mkdir -p "$LOGDIR"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
echo "[$DATE] Hello from hello-maint executed by $(whoami)" >> "$LOGFILE"
EOF

chmod 755 pkg/usr/local/bin/hello-maint.sh
```

---

### ğŸ—‚ï¸ Ã‰tape 2 : CrÃ©er le dossier `DEBIAN` et le fichier `control`

```bash
mkdir pkg/DEBIAN
cat > pkg/DEBIAN/control <<'EOF'
Package: hello-maint
Version: 1.0
Section: utils
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Installed-Size: 15
Description: Exemple de paquet avec scripts de maintenance horodatÃ©s.
EOF
```

VÃ©rification rapide :

```bash
cat pkg/DEBIAN/control
```

---

### âš™ï¸ Ã‰tape 3 : Ajouter les scripts de maintenance

#### ğŸ“˜ Principe

`dpkg` appelle automatiquement les scripts avec un **paramÃ¨tre positionnel** `$1` indiquant lâ€™action (`install`, `upgrade`, `remove`, `purge`).

#### ğŸ’» CrÃ©ation des scripts

##### `postinst` â€” aprÃ¨s installation

```bash
cat > pkg/DEBIAN/postinst <<'EOF'
#!/bin/bash
LOGFILE="/var/log/hello-maint/install.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
ACTION=$1
echo "[$DATE] [POSTINST] Action=$ACTION : Installation rÃ©ussie de hello-maint" >> "$LOGFILE"
EOF
chmod 755 pkg/DEBIAN/postinst
```

##### `prerm` â€” avant suppression

```bash
cat > pkg/DEBIAN/prerm <<'EOF'
#!/bin/bash
LOGFILE="/var/log/hello-maint/install.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
ACTION=$1
echo "[$DATE] [PRERM] Action=$ACTION : Suppression imminente" >> "$LOGFILE"
EOF
chmod 755 pkg/DEBIAN/prerm
```

##### `postrm` â€” aprÃ¨s suppression/purge

```bash
cat > pkg/DEBIAN/postrm <<'EOF'
#!/bin/bash
LOGFILE="/var/log/hello-maint/install.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
ACTION=$1
echo "[$DATE] [POSTRM] Action=$ACTION : Nettoyage effectuÃ©" >> "$LOGFILE"
EOF
chmod 755 pkg/DEBIAN/postrm
```

---

### ğŸ§± Ã‰tape 4 : Construire et inspecter le paquet

```bash
dpkg-deb --build pkg
```

> âœ… RÃ©sultat : `pkg.deb` gÃ©nÃ©rÃ©

VÃ©rification :

```bash
dpkg-deb --info pkg.deb
dpkg-deb --contents pkg.deb
find pkg/DEBIAN -type f -exec ls -l {} \;
```

> Observation : tous les scripts doivent Ãªtre `-rwxr-xr-x`.

---

### ğŸ§© Ã‰tape 5 : Installation et analyse des scripts exÃ©cutÃ©s

#### ğŸ’» Installation

```bash
sudo dpkg -i pkg.deb
```

> Observation : `dpkg` exÃ©cute `postinst` Ã  la fin.  
> Les messages â€œSetting up hello-maintâ€ ou â€œProcessing triggers for man-dbâ€ peuvent apparaÃ®tre ; ce sont des scripts globaux du systÃ¨me.

#### ğŸ’» VÃ©rification des logs

```bash
sudo tail -n 3 /var/log/hello-maint/install.log
```

> âœ… Exemple de sortie :
> 
> ```
> [2025-10-07 16:02:01] [POSTINST] Action=configure : Installation rÃ©ussie de hello-maint
> ```

---

### âš™ï¸ Ã‰tape 6 : Suppression du paquet

```bash
sudo dpkg -r hello-maint
sudo tail -n 4 /var/log/hello-maint/install.log
```

> Observation :
> 
> ```
> [PRERM] Action=remove : Suppression imminente
> [POSTRM] Action=remove : Nettoyage effectuÃ©
> ```

---

### ğŸ§¨ Ã‰tape 7 : Simulation dâ€™erreur et diagnostic

#### ğŸ¬ ScÃ©nario

Un bug sâ€™introduit dans le script `postinst`.

#### ğŸ’» Action

```bash
sed -i '1i exit 1' pkg/DEBIAN/postinst
dpkg-deb --build pkg
sudo dpkg -i pkg.deb
```

> âš ï¸ Sortie attendue :
> 
> ```
> dpkg: error processing archive pkg.deb (--install):
> installed hello-maint package post-installation script subprocess returned error exit status 1
> ```

#### ğŸ’¡ Analyse

- `exit 1` signale Ã  `dpkg` un Ã©chec â†’ Ã©tat â€œhalf-configuredâ€.

- Diagnostic :
  
  ```bash
  sudo dpkg --audit
  ```
  
  â†’ signale le paquet non configurÃ©.

#### ğŸ©¹ RÃ©paration

Supprimez la ligne fautive :

```bash
sed -i '/exit 1/d' pkg/DEBIAN/postinst
dpkg-deb --build pkg
sudo dpkg --configure -a
```

VÃ©rifiez :

```bash
sudo tail -n 2 /var/log/hello-maint/install.log
```

---

### ğŸ”§ Ã‰tape 8 : Relancer les scripts sans rÃ©installation

Test de `dpkg-reconfigure` :

```bash
sudo dpkg-reconfigure hello-maint
sudo tail -n 2 /var/log/hello-maint/install.log
```

> Observation : relance du `postinst` â†’ utile aprÃ¨s modification.

---

### ğŸ§¹ Ã‰tape 9 : Purge complÃ¨te et observation finale

```bash
sudo dpkg -P hello-maint
sudo cat /var/log/hello-maint/install.log
```

> Tous les Ã©vÃ©nements (`install`, `remove`, `purge`) sont consignÃ©s avec horodatage.

---

## âœ… 4. VÃ©rification des rÃ©sultats

1. Les trois scripts se sont exÃ©cutÃ©s aux moments attendus.

2. Les actions et horodatages sont visibles dans le log.

3. Une erreur simulÃ©e a Ã©tÃ© correctement dÃ©tectÃ©e et corrigÃ©e.

4. `dpkg-reconfigure` relance le script `postinst` sans rÃ©installer le paquet.

---

## ğŸ§¹ 5. Nettoyage final

```bash
cd ~
sudo rm -rf ~/lab_dpkg_scripts /var/log/hello-maint
sudo apt autoremove -y && sudo apt clean
```

---

## ğŸ’¡ 6. Astuces & PiÃ¨ges pÃ©dagogiques

| Type      | Description                                                                                               |
| --------- | --------------------------------------------------------------------------------------------------------- |
| ğŸ’¡ Astuce | `$1` dans les scripts de maintenance indique lâ€™action courante (`install`, `upgrade`, `remove`, `purge`). |
| ğŸ’¡ Astuce | Utilisez `set -e` pour arrÃªter un script dÃ¨s la premiÃ¨re erreur.                                          |
| ğŸ’¡ Astuce | Testez vos scripts manuellement avant de construire le paquet.                                            |
| âš ï¸ PiÃ¨ge  | Un `exit 1` non gÃ©rÃ© bloque la configuration et nÃ©cessite `dpkg --configure -a`.                          |
| âš ï¸ PiÃ¨ge  | Des droits erronÃ©s sur `DEBIAN/*` entraÃ®nent lâ€™ignorance du script.                                       |
| âš ï¸ PiÃ¨ge  | Les redirections vers `/tmp` peuvent Ãªtre perdues avant lecture.                                          |

---

## â± 7. DurÃ©e estimÃ©e (terrain)

ğŸ•’ **â‰ˆ 55 minutes**

- 10 min : crÃ©ation et permissions

- 15 min : Ã©criture et tests des scripts

- 15 min : simulation dâ€™erreur et correction

- 10 min : reconfiguration + observation finale

- 5 min : nettoyage

---

Souhaitez-vous que je lance maintenant la **phase 2 de cet atelier 5** : la critique et dÃ©gagement des points dâ€™amÃ©lioration ?
