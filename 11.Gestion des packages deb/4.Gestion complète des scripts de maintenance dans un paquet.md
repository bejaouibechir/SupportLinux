

# üß∞ Atelier 5 ‚Äî Gestion compl√®te des scripts de maintenance dans un paquet `.deb` (version am√©lior√©e)

---

## üéØ 1. Contexte & Objectif

Vous √™tes responsable d‚Äôun environnement Debian interne o√π plusieurs utilitaires maison sont d√©ploy√©s sous forme de paquets `.deb`.  
L‚Äôun de ces outils, **`hello-maint`**, doit :

- cr√©er un fichier de log lors de l‚Äôinstallation,

- enregistrer chaque action (install, remove, purge) avec horodatage,

- nettoyer automatiquement ses traces lors de la d√©sinstallation.

Cet atelier montre comment concevoir, int√©grer, tester et corriger les **scripts de maintenance Debian** (`postinst`, `prerm`, `postrm`).

---

## ‚öôÔ∏è 2. Pr√©paration de l‚Äôenvironnement

### Conditions minimales

- Debian 12 / Ubuntu 22.04

- Acc√®s `sudo`

- Aucun paquet additionnel requis

### Mise en place du laboratoire

```bash
mkdir -p ~/lab_dpkg_scripts && cd ~/lab_dpkg_scripts
```

---

## ü™ú 3. √âtapes pas √† pas

---

### üß© √âtape 1 : Cr√©er le contenu principal du paquet

#### üé¨ Sc√©nario

L‚Äôutilitaire `hello-maint.sh` affiche un message d‚Äôaccueil et logge ses ex√©cutions dans `/var/log/hello-maint/`.

#### üíª Commandes

```bash
mkdir -p pkg/usr/local/bin
cat > pkg/usr/local/bin/hello-maint.sh <<'EOF'
#!/bin/bash
LOGDIR="/var/log/hello-maint"
LOGFILE="$LOGDIR/hello.log"

mkdir -p "$LOGDIR"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
echo "[$DATE] Hello from hello-maint executed by $(whoami)" >> "$LOGFILE"
EOF

chmod 755 pkg/usr/local/bin/hello-maint.sh
```

---

### üóÇÔ∏è √âtape 2 : Cr√©er le dossier `DEBIAN` et le fichier `control`

```bash
mkdir pkg/DEBIAN
cat > pkg/DEBIAN/control <<'EOF'
Package: hello-maint
Version: 1.0
Section: utils
Priority: optional
Architecture: all
Maintainer: Formateur <formateur@lab>
Installed-Size: 15
Description: Exemple de paquet avec scripts de maintenance horodat√©s.
EOF
```

V√©rification rapide :

```bash
cat pkg/DEBIAN/control
```

---

### ‚öôÔ∏è √âtape 3 : Ajouter les scripts de maintenance

#### üìò Principe

`dpkg` appelle automatiquement les scripts avec un **param√®tre positionnel** `$1` indiquant l‚Äôaction (`install`, `upgrade`, `remove`, `purge`).

#### üíª Cr√©ation des scripts

##### `postinst` ‚Äî apr√®s installation

```bash
cat > pkg/DEBIAN/postinst <<'EOF'
#!/bin/bash
LOGFILE="/var/log/hello-maint/install.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
ACTION=$1
echo "[$DATE] [POSTINST] Action=$ACTION : Installation r√©ussie de hello-maint" >> "$LOGFILE"
EOF
chmod 755 pkg/DEBIAN/postinst
```

##### `prerm` ‚Äî avant suppression

```bash
cat > pkg/DEBIAN/prerm <<'EOF'
#!/bin/bash
LOGFILE="/var/log/hello-maint/install.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
ACTION=$1
echo "[$DATE] [PRERM] Action=$ACTION : Suppression imminente" >> "$LOGFILE"
EOF
chmod 755 pkg/DEBIAN/prerm
```

##### `postrm` ‚Äî apr√®s suppression/purge

```bash
cat > pkg/DEBIAN/postrm <<'EOF'
#!/bin/bash
LOGFILE="/var/log/hello-maint/install.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')
ACTION=$1
echo "[$DATE] [POSTRM] Action=$ACTION : Nettoyage effectu√©" >> "$LOGFILE"
EOF
chmod 755 pkg/DEBIAN/postrm
```

---

### üß± √âtape 4 : Construire et inspecter le paquet

```bash
dpkg-deb --build pkg
```

> ‚úÖ R√©sultat : `pkg.deb` g√©n√©r√©

V√©rification :

```bash
dpkg-deb --info pkg.deb
dpkg-deb --contents pkg.deb
find pkg/DEBIAN -type f -exec ls -l {} \;
```

> Observation : tous les scripts doivent √™tre `-rwxr-xr-x`.

---

### üß© √âtape 5 : Installation et analyse des scripts ex√©cut√©s

#### üíª Installation

```bash
sudo dpkg -i pkg.deb
```

> Observation : `dpkg` ex√©cute `postinst` √† la fin.  
> Les messages ‚ÄúSetting up hello-maint‚Äù ou ‚ÄúProcessing triggers for man-db‚Äù peuvent appara√Ætre ; ce sont des scripts globaux du syst√®me.

#### üíª V√©rification des logs

```bash
sudo tail -n 3 /var/log/hello-maint/install.log
```

> ‚úÖ Exemple de sortie :
> 
> ```
> [2025-10-07 16:02:01] [POSTINST] Action=configure : Installation r√©ussie de hello-maint
> ```

---

### ‚öôÔ∏è √âtape 6 : Suppression du paquet

```bash
sudo dpkg -r hello-maint
sudo tail -n 4 /var/log/hello-maint/install.log
```

> Observation :
> 
> ```
> [PRERM] Action=remove : Suppression imminente
> [POSTRM] Action=remove : Nettoyage effectu√©
> ```

---

### üß® √âtape 7 : Simulation d‚Äôerreur et diagnostic

#### üé¨ Sc√©nario

Un bug s‚Äôintroduit dans le script `postinst`.

#### üíª Action

```bash
sed -i '1i exit 1' pkg/DEBIAN/postinst
dpkg-deb --build pkg
sudo dpkg -i pkg.deb
```

> ‚ö†Ô∏è Sortie attendue :
> 
> ```
> dpkg: error processing archive pkg.deb (--install):
> installed hello-maint package post-installation script subprocess returned error exit status 1
> ```

#### üí° Analyse

- `exit 1` signale √† `dpkg` un √©chec ‚Üí √©tat ‚Äúhalf-configured‚Äù.

- Diagnostic :
  
  ```bash
  sudo dpkg --audit
  ```
  
  ‚Üí signale le paquet non configur√©.

#### ü©π R√©paration

Supprimez la ligne fautive :

```bash
sed -i '/exit 1/d' pkg/DEBIAN/postinst
dpkg-deb --build pkg
sudo dpkg --configure -a
```

V√©rifiez :

```bash
sudo tail -n 2 /var/log/hello-maint/install.log
```

---

### üîß √âtape 8 : Relancer les scripts sans r√©installation

Test de `dpkg-reconfigure` :

```bash
sudo dpkg-reconfigure hello-maint
sudo tail -n 2 /var/log/hello-maint/install.log
```

> Observation : relance du `postinst` ‚Üí utile apr√®s modification.

---

### üßπ √âtape 9 : Purge compl√®te et observation finale

```bash
sudo dpkg -P hello-maint
sudo cat /var/log/hello-maint/install.log
```

> Tous les √©v√©nements (`install`, `remove`, `purge`) sont consign√©s avec horodatage.

---

## ‚úÖ 4. V√©rification des r√©sultats

1. Les trois scripts se sont ex√©cut√©s aux moments attendus.

2. Les actions et horodatages sont visibles dans le log.

3. Une erreur simul√©e a √©t√© correctement d√©tect√©e et corrig√©e.

4. `dpkg-reconfigure` relance le script `postinst` sans r√©installer le paquet.

---

## üßπ 5. Nettoyage final

```bash
cd ~
sudo rm -rf ~/lab_dpkg_scripts /var/log/hello-maint
sudo apt autoremove -y && sudo apt clean
```

---

## üí° 6. Astuces & Pi√®ges p√©dagogiques

| Type      | Description                                                                                               |
| --------- | --------------------------------------------------------------------------------------------------------- |
| üí° Astuce | `$1` dans les scripts de maintenance indique l‚Äôaction courante (`install`, `upgrade`, `remove`, `purge`). |
| üí° Astuce | Utilisez `set -e` pour arr√™ter un script d√®s la premi√®re erreur.                                          |
| üí° Astuce | Testez vos scripts manuellement avant de construire le paquet.                                            |
| ‚ö†Ô∏è Pi√®ge  | Un `exit 1` non g√©r√© bloque la configuration et n√©cessite `dpkg --configure -a`.                          |
| ‚ö†Ô∏è Pi√®ge  | Des droits erron√©s sur `DEBIAN/*` entra√Ænent l‚Äôignorance du script.                                       |
| ‚ö†Ô∏è Pi√®ge  | Les redirections vers `/tmp` peuvent √™tre perdues avant lecture.                                          |


