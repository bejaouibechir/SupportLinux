Excellent 👌  
Voici la **version 2 enrichie et professionnelle** de l’**Atelier – Sécurisation GPG des paquets et dépôts Debian**, intégrant **les 10 améliorations** précédentes.  
Cette version est plus **ancrée dans un scénario DevOps réel**, inclut des **erreurs simulées**, des **vérifications détaillées**, des **analyses de fichiers signés**, et des **explications sur les algorithmes et les permissions**.

---

# 🔐 Atelier — Sécurisation GPG des dépôts Debian (version 2 enrichie et réaliste)

---

## 🎯 1. Contexte & objectif

**Scénario concret (DevOps CI/CD)**  
Une équipe DevOps interne publie ses propres paquets `.deb` générés par des pipelines Jenkins/GitLab CI.  
Avant leur mise en ligne sur un **dépôt Nexus Debian interne**, ces paquets doivent être **signés et validés** afin de garantir :

- leur **authenticité** (provenance vérifiée),

- leur **intégrité** (aucune modification en transit),

- et la **confiance APT** côté client sans avertissement GPG.

**Objectifs pédagogiques :**

- Créer et gérer une **clé GPG** de signature pour un dépôt Debian.

- Signer les métadonnées (`InRelease`, `Release.gpg`) et **vérifier les signatures** localement.

- Distribuer la **clé publique** via la méthode moderne `signed-by=` (sans `apt-key`).

- Simuler et corriger des erreurs GPG (`NO_PUBKEY`, `EXPKEYSIG`).

- Expliquer les différences `InRelease` / `Release.gpg` et bonnes pratiques DevOps CI/CD.

---

## ⚙️ 2. Préparation du terrain

### Infrastructure

| Machine      | Rôle                         | Nom d’hôte | Adresse IP    |
| ------------ | ---------------------------- | ---------- | ------------- |
| `repo.lab`   | Serveur de dépôt (signature) | Debian 12  | 192.168.56.10 |
| `client.lab` | Machine cliente (validation) | Debian 12  | 192.168.56.20 |

Les deux machines doivent se pinguer mutuellement.

### Logiciels nécessaires

```bash
# Sur le serveur
sudo apt update
sudo apt install -y dpkg-dev gnupg

# Sur le client
sudo apt update
sudo apt install -y gnupg apt-transport-https
```

---

## 🧩 3. Étapes pas à pas (serveur → client)

---

### 🧠 Étape 1 — Comprendre les bases GPG

- **RSA 4096 bits** : algorithme asymétrique standard pour signature (rapide et compatible).

- **“sign” vs “encrypt”** : ici on ne chiffre rien, on signe pour prouver l’origine.

- **Durée 1 an (`1y`)** : bonne pratique pour rotation annuelle des clés.

---

### 🧩 Étape 2 — Créer la clé GPG du dépôt (serveur)

```bash
gpg --quick-generate-key "CI Repo <ci@repo.lab>" rsa4096 sign 1y
```

> Cette clé servira uniquement à signer les dépôts.  
> Vérifiez :

```bash
gpg --list-keys "CI Repo"
```

> Affiche :  
> `pub rsa4096 YYYY-MM-DD [SC] [expires: YYYY-MM-DD]`  
> Notez l’ID de clé (8 à 16 caractères).

---

### 🧩 Étape 3 — Générer et signer les fichiers du dépôt

**Créer un dépôt local minimal pour l’exercice :**

```bash
mkdir -p ~/repo/{pool, dists/stable/main/binary-amd64}
cd ~/repo
dpkg-scanpackages pool /dev/null | gzip -9c > dists/stable/main/binary-amd64/Packages.gz
```

**Créer un fichier `Release` clair et le signer :**

```bash
cd dists/stable
cat > Release <<'EOF'
Origin: DevOpsLab
Label: InternalCI
Suite: stable
Codename: stable
Architectures: amd64
Components: main
Description: Dépôt Debian interne signé
EOF

# Signature détachée (legacy)
gpg --output Release.gpg -abs Release
# Signature inline (moderne)
gpg --clearsign -o InRelease Release
```

---

### 🧾 Étape 4 — Visualiser et comparer les signatures

#### Voir le contenu du `InRelease`

```bash
head -n 10 InRelease
```

> Montre les en-têtes :
> 
> ```
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
> Origin: DevOpsLab
> ...
> -----BEGIN PGP SIGNATURE-----
> ...
> -----END PGP SIGNATURE-----
> ```

#### Comparaison :

| Fichier       | Type                                      | Vérification                    |
| ------------- | ----------------------------------------- | ------------------------------- |
| `InRelease`   | signature **inline** (moderne)            | vérifié automatiquement par APT |
| `Release.gpg` | signature **détachée** (ancienne méthode) | fichier `Release` requis à côté |

---

### 🔍 Étape 5 — Vérifier la signature côté serveur

Avant toute publication :

```bash
gpg --verify InRelease
gpg --verify Release.gpg Release
```

> ✅ Sortie :  
> `Good signature from "CI Repo <ci@repo.lab>"`  
> ⚠️ En cas d’erreur : clé manquante, fichier altéré, ou date système incorrecte.

---

### 🧾 Étape 6 — Exporter et publier la clé publique

```bash
gpg --export -a "CI Repo <ci@repo.lab>" > /tmp/repo_pubkey.asc
ls -lh /tmp/repo_pubkey.asc
```

> Copiez ce fichier vers le client via `scp` ou rendez-le disponible par HTTP :  
> `http://repo.lab/key/repo_pubkey.asc`

---

### 🧩 Étape 7 — Installer la clé sur le client (méthode moderne `signed-by`)

Sur `client.lab` :

```bash
wget http://192.168.56.10/key/repo_pubkey.asc -O /tmp/repo_pubkey.asc
sudo gpg --dearmor -o /usr/share/keyrings/repo-ci.gpg /tmp/repo_pubkey.asc
```

Configurer le dépôt :

```bash
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/repo-ci.gpg] http://192.168.56.10/repo stable main" \
| sudo tee /etc/apt/sources.list.d/repo-ci.list
```

Mise à jour :

```bash
sudo apt update
```

> ✅ Résultat attendu : APT valide la signature `InRelease` → aucun avertissement.

---

### ⚠️ Étape 8 — Simuler des erreurs GPG et les corriger

#### Cas 1 — Clé absente

```bash
sudo rm /usr/share/keyrings/repo-ci.gpg
sudo apt update
```

> Erreur :  
> `NO_PUBKEY <KEYID>`  
> 🔧 Correction : réinstaller la clé publique (Étape 7).

#### Cas 2 — Clé expirée

Vérifiez l’expiration :

```bash
gpg --list-keys "CI Repo"
```

Simulez une clé expirée (exp date manuelle via `gpg --edit-key` → `expire` → `save`).

> ⚠️ `EXPKEYSIG` dans `apt update`  
> 🔧 Correction :

```bash
# Côté serveur : régénérer clé + resigner
gpg --quick-set-expire "CI Repo" 2y
gpg --clearsign -o InRelease Release
gpg --output Release.gpg -abs Release
```

Puis republier la clé publique et refaire `sudo apt update` côté client.

---

### 🧩 Étape 9 — Vérification complète de confiance côté client

```bash
apt-cache policy
apt-cache policy dummy | head -n 10
sudo apt-get check
```

> Vérifiez que le dépôt `repo.lab` apparaît avec `500 http://192.168.56.10/repo stable/main amd64`.

---

### 🧩 Étape 10 — (Optionnel) Signature individuelle des `.deb` avec `dpkg-sig`

Sur le serveur :

```bash
sudo apt install -y dpkg-sig
dpkg-sig --sign builder pool/main/d/dummy_1.0_all.deb
dpkg-sig --verify pool/main/d/dummy_1.0_all.deb
```

> ✅ Vérifiez “Good signature” — utile pour CI/CD qui signe automatiquement les artefacts `.deb`.

---

## 🧠 4. Bonnes pratiques de sécurité & permissions

| Élément                            | Bonnes pratiques                                                  |
| ---------------------------------- | ----------------------------------------------------------------- |
| Répertoire `~/.gnupg`              | Permissions `700`, propriétaire unique                            |
| Fichiers `InRelease`/`Release.gpg` | Permissions `644`, répertoire `755`                               |
| Clé privée                         | Jamais exportée, stockée hors CI/CD non sécurisé                  |
| Rotation                           | Nouvelle clé avant expiration, publier clé publique avant bascule |
| NTP                                | Horloge système synchronisée pour validité temporelle             |

---

## 🧹 5. Nettoyage

Sur le client :

```bash
sudo rm /etc/apt/sources.list.d/repo-ci.list
sudo rm /usr/share/keyrings/repo-ci.gpg
sudo apt update
```

Sur le serveur :

```bash
rm -f /tmp/repo_pubkey.asc
gpg --delete-secret-keys "CI Repo"
gpg --delete-keys "CI Repo"
```

---

## 💡 6. Astuces & pièges pédagogiques (complétés)

| Type      | Description                                                                            |
| --------- | -------------------------------------------------------------------------------------- |
| 💡 Astuce | `gpg --show-keys repo_pubkey.asc` pour lire l’ID et la date d’expiration avant import. |
| 💡 Astuce | `apt-key` est obsolète : préférez `signed-by`.                                         |
| 💡 Astuce | Gardez les `InRelease` et `Release.gpg` ensemble pour compatibilité.                   |
| ⚠️ Piège  | Supprimer `InRelease` bloque toute mise à jour — `apt` refuse un dépôt non signé.      |
| ⚠️ Piège  | Un dépôt signé avec clé expirée est refusé même si la signature est correcte.          |
| ⚠️ Piège  | Horloge système décalée → signature considérée invalide.                               |
| ⚠️ Piège  | Mauvaises permissions `~/.gnupg` = “unsafe permissions” → GPG refuse d’exécuter.       |


