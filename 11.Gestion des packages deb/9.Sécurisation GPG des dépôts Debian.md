Excellent ğŸ‘Œ  
Voici la **version 2 enrichie et professionnelle** de lâ€™**Atelier â€“ SÃ©curisation GPG des paquets et dÃ©pÃ´ts Debian**, intÃ©grant **les 10 amÃ©liorations** prÃ©cÃ©dentes.  
Cette version est plus **ancrÃ©e dans un scÃ©nario DevOps rÃ©el**, inclut des **erreurs simulÃ©es**, des **vÃ©rifications dÃ©taillÃ©es**, des **analyses de fichiers signÃ©s**, et des **explications sur les algorithmes et les permissions**.

---

# ğŸ” Atelier â€” SÃ©curisation GPG des dÃ©pÃ´ts Debian (version 2 enrichie et rÃ©aliste)

---

## ğŸ¯ 1. Contexte & objectif

**ScÃ©nario concret (DevOps CI/CD)**  
Une Ã©quipe DevOps interne publie ses propres paquets `.deb` gÃ©nÃ©rÃ©s par des pipelines Jenkins/GitLab CI.  
Avant leur mise en ligne sur un **dÃ©pÃ´t Nexus Debian interne**, ces paquets doivent Ãªtre **signÃ©s et validÃ©s** afin de garantir :

- leur **authenticitÃ©** (provenance vÃ©rifiÃ©e),

- leur **intÃ©gritÃ©** (aucune modification en transit),

- et la **confiance APT** cÃ´tÃ© client sans avertissement GPG.

**Objectifs pÃ©dagogiques :**

- CrÃ©er et gÃ©rer une **clÃ© GPG** de signature pour un dÃ©pÃ´t Debian.

- Signer les mÃ©tadonnÃ©es (`InRelease`, `Release.gpg`) et **vÃ©rifier les signatures** localement.

- Distribuer la **clÃ© publique** via la mÃ©thode moderne `signed-by=` (sans `apt-key`).

- Simuler et corriger des erreurs GPG (`NO_PUBKEY`, `EXPKEYSIG`).

- Expliquer les diffÃ©rences `InRelease` / `Release.gpg` et bonnes pratiques DevOps CI/CD.

---

## âš™ï¸ 2. PrÃ©paration du terrain

### Infrastructure

| Machine      | RÃ´le                         | Nom dâ€™hÃ´te | Adresse IP    |
| ------------ | ---------------------------- | ---------- | ------------- |
| `repo.lab`   | Serveur de dÃ©pÃ´t (signature) | Debian 12  | 192.168.56.10 |
| `client.lab` | Machine cliente (validation) | Debian 12  | 192.168.56.20 |

Les deux machines doivent se pinguer mutuellement.

### Logiciels nÃ©cessaires

```bash
# Sur le serveur
sudo apt update
sudo apt install -y dpkg-dev gnupg

# Sur le client
sudo apt update
sudo apt install -y gnupg apt-transport-https
```

---

## ğŸ§© 3. Ã‰tapes pas Ã  pas (serveur â†’ client)

---

### ğŸ§  Ã‰tape 1 â€” Comprendre les bases GPG

- **RSA 4096 bits** : algorithme asymÃ©trique standard pour signature (rapide et compatible).

- **â€œsignâ€ vs â€œencryptâ€** : ici on ne chiffre rien, on signe pour prouver lâ€™origine.

- **DurÃ©e 1 an (`1y`)** : bonne pratique pour rotation annuelle des clÃ©s.

---

### ğŸ§© Ã‰tape 2 â€” CrÃ©er la clÃ© GPG du dÃ©pÃ´t (serveur)

```bash
gpg --quick-generate-key "CI Repo <ci@repo.lab>" rsa4096 sign 1y
```

> Cette clÃ© servira uniquement Ã  signer les dÃ©pÃ´ts.  
> VÃ©rifiez :

```bash
gpg --list-keys "CI Repo"
```

> Affiche :  
> `pub rsa4096 YYYY-MM-DD [SC] [expires: YYYY-MM-DD]`  
> Notez lâ€™ID de clÃ© (8 Ã  16 caractÃ¨res).

---

### ğŸ§© Ã‰tape 3 â€” GÃ©nÃ©rer et signer les fichiers du dÃ©pÃ´t

**CrÃ©er un dÃ©pÃ´t local minimal pour lâ€™exercice :**

```bash
mkdir -p ~/repo/{pool, dists/stable/main/binary-amd64}
cd ~/repo
dpkg-scanpackages pool /dev/null | gzip -9c > dists/stable/main/binary-amd64/Packages.gz
```

**CrÃ©er un fichier `Release` clair et le signer :**

```bash
cd dists/stable
cat > Release <<'EOF'
Origin: DevOpsLab
Label: InternalCI
Suite: stable
Codename: stable
Architectures: amd64
Components: main
Description: DÃ©pÃ´t Debian interne signÃ©
EOF

# Signature dÃ©tachÃ©e (legacy)
gpg --output Release.gpg -abs Release
# Signature inline (moderne)
gpg --clearsign -o InRelease Release
```

---

### ğŸ§¾ Ã‰tape 4 â€” Visualiser et comparer les signatures

#### Voir le contenu du `InRelease`

```bash
head -n 10 InRelease
```

> Montre les en-tÃªtes :
> 
> ```
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
> Origin: DevOpsLab
> ...
> -----BEGIN PGP SIGNATURE-----
> ...
> -----END PGP SIGNATURE-----
> ```

#### Comparaison :

| Fichier       | Type                                      | VÃ©rification                    |
| ------------- | ----------------------------------------- | ------------------------------- |
| `InRelease`   | signature **inline** (moderne)            | vÃ©rifiÃ© automatiquement par APT |
| `Release.gpg` | signature **dÃ©tachÃ©e** (ancienne mÃ©thode) | fichier `Release` requis Ã  cÃ´tÃ© |

---

### ğŸ” Ã‰tape 5 â€” VÃ©rifier la signature cÃ´tÃ© serveur

Avant toute publication :

```bash
gpg --verify InRelease
gpg --verify Release.gpg Release
```

> âœ… Sortie :  
> `Good signature from "CI Repo <ci@repo.lab>"`  
> âš ï¸ En cas dâ€™erreur : clÃ© manquante, fichier altÃ©rÃ©, ou date systÃ¨me incorrecte.

---

### ğŸ§¾ Ã‰tape 6 â€” Exporter et publier la clÃ© publique

```bash
gpg --export -a "CI Repo <ci@repo.lab>" > /tmp/repo_pubkey.asc
ls -lh /tmp/repo_pubkey.asc
```

> Copiez ce fichier vers le client via `scp` ou rendez-le disponible par HTTP :  
> `http://repo.lab/key/repo_pubkey.asc`

---

### ğŸ§© Ã‰tape 7 â€” Installer la clÃ© sur le client (mÃ©thode moderne `signed-by`)

Sur `client.lab` :

```bash
wget http://192.168.56.10/key/repo_pubkey.asc -O /tmp/repo_pubkey.asc
sudo gpg --dearmor -o /usr/share/keyrings/repo-ci.gpg /tmp/repo_pubkey.asc
```

Configurer le dÃ©pÃ´t :

```bash
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/repo-ci.gpg] http://192.168.56.10/repo stable main" \
| sudo tee /etc/apt/sources.list.d/repo-ci.list
```

Mise Ã  jour :

```bash
sudo apt update
```

> âœ… RÃ©sultat attendu : APT valide la signature `InRelease` â†’ aucun avertissement.

---

### âš ï¸ Ã‰tape 8 â€” Simuler des erreurs GPG et les corriger

#### Cas 1 â€” ClÃ© absente

```bash
sudo rm /usr/share/keyrings/repo-ci.gpg
sudo apt update
```

> Erreur :  
> `NO_PUBKEY <KEYID>`  
> ğŸ”§ Correction : rÃ©installer la clÃ© publique (Ã‰tape 7).

#### Cas 2 â€” ClÃ© expirÃ©e

VÃ©rifiez lâ€™expiration :

```bash
gpg --list-keys "CI Repo"
```

Simulez une clÃ© expirÃ©e (exp date manuelle via `gpg --edit-key` â†’ `expire` â†’ `save`).

> âš ï¸ `EXPKEYSIG` dans `apt update`  
> ğŸ”§ Correction :

```bash
# CÃ´tÃ© serveur : rÃ©gÃ©nÃ©rer clÃ© + resigner
gpg --quick-set-expire "CI Repo" 2y
gpg --clearsign -o InRelease Release
gpg --output Release.gpg -abs Release
```

Puis republier la clÃ© publique et refaire `sudo apt update` cÃ´tÃ© client.

---

### ğŸ§© Ã‰tape 9 â€” VÃ©rification complÃ¨te de confiance cÃ´tÃ© client

```bash
apt-cache policy
apt-cache policy dummy | head -n 10
sudo apt-get check
```

> VÃ©rifiez que le dÃ©pÃ´t `repo.lab` apparaÃ®t avec `500 http://192.168.56.10/repo stable/main amd64`.

---

### ğŸ§© Ã‰tape 10 â€” (Optionnel) Signature individuelle des `.deb` avec `dpkg-sig`

Sur le serveur :

```bash
sudo apt install -y dpkg-sig
dpkg-sig --sign builder pool/main/d/dummy_1.0_all.deb
dpkg-sig --verify pool/main/d/dummy_1.0_all.deb
```

> âœ… VÃ©rifiez â€œGood signatureâ€ â€” utile pour CI/CD qui signe automatiquement les artefacts `.deb`.

---

## ğŸ§  4. Bonnes pratiques de sÃ©curitÃ© & permissions

| Ã‰lÃ©ment                            | Bonnes pratiques                                                  |
| ---------------------------------- | ----------------------------------------------------------------- |
| RÃ©pertoire `~/.gnupg`              | Permissions `700`, propriÃ©taire unique                            |
| Fichiers `InRelease`/`Release.gpg` | Permissions `644`, rÃ©pertoire `755`                               |
| ClÃ© privÃ©e                         | Jamais exportÃ©e, stockÃ©e hors CI/CD non sÃ©curisÃ©                  |
| Rotation                           | Nouvelle clÃ© avant expiration, publier clÃ© publique avant bascule |
| NTP                                | Horloge systÃ¨me synchronisÃ©e pour validitÃ© temporelle             |

---

## ğŸ§¹ 5. Nettoyage

Sur le client :

```bash
sudo rm /etc/apt/sources.list.d/repo-ci.list
sudo rm /usr/share/keyrings/repo-ci.gpg
sudo apt update
```

Sur le serveur :

```bash
rm -f /tmp/repo_pubkey.asc
gpg --delete-secret-keys "CI Repo"
gpg --delete-keys "CI Repo"
```

---

## ğŸ’¡ 6. Astuces & piÃ¨ges pÃ©dagogiques (complÃ©tÃ©s)

| Type      | Description                                                                            |
| --------- | -------------------------------------------------------------------------------------- |
| ğŸ’¡ Astuce | `gpg --show-keys repo_pubkey.asc` pour lire lâ€™ID et la date dâ€™expiration avant import. |
| ğŸ’¡ Astuce | `apt-key` est obsolÃ¨te : prÃ©fÃ©rez `signed-by`.                                         |
| ğŸ’¡ Astuce | Gardez les `InRelease` et `Release.gpg` ensemble pour compatibilitÃ©.                   |
| âš ï¸ PiÃ¨ge  | Supprimer `InRelease` bloque toute mise Ã  jour â€” `apt` refuse un dÃ©pÃ´t non signÃ©.      |
| âš ï¸ PiÃ¨ge  | Un dÃ©pÃ´t signÃ© avec clÃ© expirÃ©e est refusÃ© mÃªme si la signature est correcte.          |
| âš ï¸ PiÃ¨ge  | Horloge systÃ¨me dÃ©calÃ©e â†’ signature considÃ©rÃ©e invalide.                               |
| âš ï¸ PiÃ¨ge  | Mauvaises permissions `~/.gnupg` = â€œunsafe permissionsâ€ â†’ GPG refuse dâ€™exÃ©cuter.       |


