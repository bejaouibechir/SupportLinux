\# üõ°Ô∏è Th√®me 4 ‚Äî Permissions (Partie A : 30 exercices pratiques)



---



\### Exercice 1 ‚Äî V√©rifier et comprendre les permissions d‚Äôun fichier



\*\*√ânonc√© :\*\* Inspectez `/etc/passwd` et expliquez chaque champ de `ls -l` (rwxr-xr-x) pour ce fichier.

\*\*D√©marche :\*\*



```bash

ls -l /etc/passwd

stat /etc/passwd

```



\*\*R√©sultat attendu :\*\* Compr√©hension de `rwx` pour owner, group, others ; owner (root), group (root).

\*\*Conseils :\*\*



\* Utilisez `stat` pour obtenir UID/GID et timestamps.

\* Apprenez la correspondance symbolique ‚Üî octale (r=4, w=2, x=1).

&nbsp; \*\*Astuces :\*\*

\* `namei -l /chemin/fichier` d√©compose le chemin et affiche perms chaque segment.

\* `getfacl` montre ACL √©ventuelles.

&nbsp; \*\*Pi√®ges √† √©viter :\*\*

\* Ne pas modifier `/etc/passwd` sans sauvegarde.

\* Confondre perm de r√©pertoire et perm de fichier (x pour traverser).



---



\### Exercice 2 ‚Äî Conversion symbolique ‚Üî octale



\*\*√ânonc√© :\*\* Convertissez `chmod u=rw,g=r,o=` en mode octal et appliquez sur un fichier de test.

\*\*D√©marche :\*\*



```bash

touch test\_perm \&\& chmod u=rw,g=r,o= test\_perm

stat -c '%A %a %n' test\_perm

```



\*\*R√©sultat attendu :\*\* Permissions `rw-r-----` = octal `640`.

\*\*Conseils :\*\*



\* M√©morisez petites tables : r=4,w=2,x=1.

&nbsp; \*\*Astuces :\*\*

\* `chmod 640 file` √©quivaut √† `chmod u=rw,g=r,o= file`.

&nbsp; \*\*Pi√®ges :\*\*

\* Utiliser `chmod 0640` vs `chmod 640` : souvent identiques, mais octal √† 4 chiffres inclut setuid/setgid/sticky.



---



\### Exercice 3 ‚Äî Changer propri√©taire et groupe avec s√©curit√©



\*\*√ânonc√© :\*\* Changez owner de `/tmp/projet` vers `deploy`, groupe `web`, en testant d‚Äôabord les effets.

\*\*D√©marche :\*\*



```bash

sudo mkdir -p /tmp/projet

sudo useradd -M deploy  # si n√©cessaire en test

sudo groupadd web       # si n√©cessaire en test

sudo chown deploy:web /tmp/projet

ls -ld /tmp/projet

```



\*\*R√©sultat attendu :\*\* owner `deploy`, group `web`.

\*\*Conseils :\*\*



\* Toujours v√©rifier avec `ls -ld` avant et apr√®s.

&nbsp; \*\*Astuces :\*\*

\* `chown --from=olduser:oldgroup newuser:newgroup file` pour s√©curit√©.

&nbsp; \*\*Pi√®ges :\*\*

\* `chown -R` sur `/` ou sur des dossiers syst√®me = catastrophe.



---



\### Exercice 4 ‚Äî SetUID (suid) concret et dangereux



\*\*√ânonc√© :\*\* √âtudiez un binaire setuid (ex: `/usr/bin/passwd`) et testez comportement en test avec un binaire simul√© C (setuid root).

\*\*D√©marche (simulation en VM safe) :\*\*



```bash

\# C: small suid demo (ne faites PAS sur prod)

cat > demo\_suid.c <<'C' 

\#include <stdio.h>

\#include <stdlib.h>

\#include <unistd.h>

int main(){ setuid(0); system("/bin/sh"); return 0; }

C

gcc demo\_suid.c -o demo\_suid

sudo chown root:root demo\_suid

sudo chmod 4755 demo\_suid

./demo\_suid

```



\*\*R√©sultat attendu :\*\* remarque sur √©l√©vation si binaire vuln√©rable.

\*\*Conseils :\*\*



\* Ne jamais placer scripts interpr√©t√©s en setuid (bash, python) ‚Äî syst√®me les ignore ou les rend dangereux.

&nbsp; \*\*Astuces :\*\*

\* `find / -perm -4000 -type f 2>/dev/null` liste setuid existants.

&nbsp; \*\*Pi√®ges :\*\*

\* Ne pas rendre des programmes √©crits par vous-m√™mes setuid root si non audit√©s ‚Äî backdoor potentiel.



---



\### Exercice 5 ‚Äî SetGID sur r√©pertoire pour partage collaboratif



\*\*√ânonc√© :\*\* Configurez `/srv/projet` pour que les fichiers cr√©√©s h√©ritent du groupe `projet`.

\*\*D√©marche :\*\*



```bash

sudo groupadd projet

sudo mkdir -p /srv/projet

sudo chown :projet /srv/projet

sudo chmod 2775 /srv/projet   # setgid bit = leading 2

```



\*\*R√©sultat attendu :\*\* fichiers cr√©√©s auront GID `projet`.

\*\*Conseils :\*\*



\* Combinez avec `umask` recommand√© (e.g., 002) pour que groupe ait write.

&nbsp; \*\*Astuces :\*\*

\* `stat -c '%A %g %G' /srv/projet` pour v√©rifier.

&nbsp; \*\*Pi√®ges :\*\*

\* Oublier `2` (setgid) et constater que les fichiers prennent le groupe primaire de l‚Äôutilisateur.



---



\### Exercice 6 ‚Äî Sticky bit sur /tmp et dossiers partag√©s



\*\*√ânonc√© :\*\* Expliquez pourquoi `/tmp` a sticky bit et appliquez sticky sur `/srv/shared`. Testez suppression par autre utilisateur.

\*\*D√©marche :\*\*



```bash

sudo mkdir -p /tmp/testshared

sudo chmod 1777 /tmp/testshared

\# as user1 create file; as user2 try rm -> fails

```



\*\*R√©sultat attendu :\*\* seul owner peut supprimer son fichier.

\*\*Conseils :\*\*



\* Sticky bit = 1xxx en octal ; prot√®ge fichiers dans dir world-writable.

&nbsp; \*\*Astuces :\*\*

\* `ls -ld /tmp` pour voir `drwxrwxrwt`.

&nbsp; \*\*Pi√®ges :\*\*

\* Penser que sticky bit prot√®ge le contenu des fichiers (non) ‚Äî il emp√™che seulement suppression par autres.



---



\### Exercice 7 ‚Äî umask per-user et par service



\*\*√ânonc√© :\*\* Comparez umask d‚Äôun utilisateur normal, d‚Äôun service systemd et d‚Äôun cron job.

\*\*D√©marche :\*\*



```bash

\# utilisateur

umask

\# cron (dans crontab): \* \* \* \* \* umask 027; echo $(umask) > /tmp/cron\_umask.txt

\# systemd: systemctl cat monservice | grep -i Umask

```



\*\*R√©sultat attendu :\*\* compr√©hension que umask peut √™tre diff√©rent selon contexte.

\*\*Conseils :\*\*



\* Fixez umask global dans `/etc/profile` ou par service unit.

&nbsp; \*\*Astuces :\*\*

\* systemd units acceptent `UMask=` directive.

&nbsp; \*\*Pi√®ges :\*\*

\* Croire que umask system-wide s‚Äôapplique aux services g√©r√©s par systemd (par d√©faut non).



---



\### Exercice 8 ‚Äî D√©tecter fichiers world-writable dangereux



\*\*√ânonc√© :\*\* Trouvez tous les fichiers world-writable sous `/var/www` et listez propri√©taires.

\*\*D√©marche :\*\*



```bash

sudo find /var/www -type f -perm -002 -ls

```



\*\*R√©sultat attendu :\*\* liste des fichiers avec `-rw-rw-rw-`.

\*\*Conseils :\*\*



\* Corriger en `chmod o-w` sur fichiers sensibles.

&nbsp; \*\*Astuces :\*\*

\* `-perm -o=w` √©quivalent.

&nbsp; \*\*Pi√®ges :\*\*

\* Ignorer r√©pertoires qui doivent rester world-writable (ex: /tmp) ; v√©rifier contexte.



---



\### Exercice 9 ‚Äî Utiliser find + exec pour corriger permissions en masse (s√ªrement)



\*\*√ânonc√© :\*\* Remettez √† 644 tous les .php dans un site, et 755 pour r√©pertoires, sans casser liens ni fichiers sp√©ciaux.

\*\*D√©marche :\*\*



```bash

sudo find /var/www/site -type f -name "\*.php" -exec chmod 644 {} +

sudo find /var/www/site -type d -exec chmod 755 {} +

```



\*\*R√©sultat attendu :\*\* fichiers PHP lisibles, dirs traversables.

\*\*Conseils :\*\*



\* Testez d‚Äôabord avec `-print` avant `-exec`.

&nbsp; \*\*Astuces :\*\*

\* Utiliser `-maxdepth` pour limiter port√©e pendant tests.

&nbsp; \*\*Pi√®ges :\*\*

\* `chmod -R` imprudent : peut modifier permissions binaires.



---



\### Exercice 10 ‚Äî Permissions √©tendues : POSIX ACLs (setfacl/getfacl) basiques



\*\*√ânonc√© :\*\* Donnez √† l‚Äôutilisateur `dev1` acc√®s en √©criture sur `/srv/projet` sans changer le groupe.

\*\*D√©marche :\*\*



```bash

sudo setfacl -m u:dev1:rwx /srv/projet

getfacl /srv/projet

```



\*\*R√©sultat attendu :\*\* `user:dev1:rwx` visible.

\*\*Conseils :\*\*



\* V√©rifiez que FS supporte ACL (`tune2fs -l` ou mount options).

&nbsp; \*\*Astuces :\*\*

\* `setfacl -R -m ...` pour propager.

&nbsp; \*\*Pi√®ges :\*\*

\* Ne pas oublier `setfacl -b` pour nettoyer si vous avez fait des erreurs.



---



\### Exercice 11 ‚Äî ACLs par d√©faut pour h√©riter sur nouveaux fichiers



\*\*√ânonc√© :\*\* Configurez une ACL par d√©faut pour que tous les nouveaux fichiers du dossier h√©ritent d‚Äôun droit pour `devgroup`.

\*\*D√©marche :\*\*



```bash

sudo setfacl -d -m g:devgroup:rwx /srv/projet

getfacl /srv/projet

```



\*\*R√©sultat attendu :\*\* `default:group:devgroup:rwx`.

\*\*Conseils :\*\*



\* M√©langer setgid+default ACL pour comportement stable.

&nbsp; \*\*Astuces :\*\*

\* `getfacl -R` pour v√©rifier r√©cursivement.

&nbsp; \*\*Pi√®ges :\*\*

\* Confusion entre ACLs effectives et ACLs par d√©faut.



---



\### Exercice 12 ‚Äî Retirer ACLs et restaurer permissions de base



\*\*√ânonc√© :\*\* Nettoyez les ACLs d‚Äôun r√©pertoire et restaurez les perms √† `rwxr-x---`.

\*\*D√©marche :\*\*



```bash

sudo setfacl -bR /srv/projet

sudo chmod -R 750 /srv/projet

```



\*\*R√©sultat attendu :\*\* ACLs effac√©es et perms appliqu√©es.

\*\*Conseils :\*\*



\* Faire une sauvegarde avant (`getfacl -R > acl\_backup.txt`).

&nbsp; \*\*Astuces :\*\*

\* Restaurer par parsing du backup si besoin.

&nbsp; \*\*Pi√®ges :\*\*

\* Perdre ACL utiles en nettoyant brutalement.



---



\### Exercice 13 ‚Äî chattr et attribut immutable (+i)



\*\*√ânonc√© :\*\* Prot√©gez un fichier de configuration critique (`/etc/myapp.conf`) pour emp√™cher toute modification, m√™me par root (sauf via chattr).

\*\*D√©marche :\*\*



```bash

sudo touch /etc/myapp.conf

sudo chattr +i /etc/myapp.conf

lsattr /etc/myapp.conf

\# Pour modifier ensuite: sudo chattr -i /etc/myapp.conf

```



\*\*R√©sultat attendu :\*\* `i` pr√©sent dans `lsattr`.

\*\*Conseils :\*\*



\* Utilisez avec parcimonie ; `+i` bloque m√™me `rm`.

&nbsp; \*\*Astuces :\*\*

\* `chattr` n√©cessite syst√®me de fichiers ext\\\*.

&nbsp; \*\*Pi√®ges :\*\*

\* Oublier qu‚Äôon a mis +i et s‚Äô√©tonner que config n‚Äôapplique pas les changements.



---



\### Exercice 14 ‚Äî chattr +a (append-only) pour logs



\*\*√ânonc√© :\*\* Configurez un fichier de log pour n‚Äôaccepter que des append (utile pour journaux immuables).

\*\*D√©marche :\*\*



```bash

sudo touch /var/log/secure\_append.log

sudo chattr +a /var/log/secure\_append.log

lsattr /var/log/secure\_append.log

```



\*\*R√©sultat attendu :\*\* `a` visible ; fichiers ne peuvent √™tre √©cras√©s.

\*\*Conseils :\*\*



\* Combinez append-only avec rotation contr√¥l√©e.

&nbsp; \*\*Astuces :\*\*

\* `logrotate` doit √™tre configur√© pour manipuler ces fichiers (stop/start ou chattr -a).

&nbsp; \*\*Pi√®ges :\*\*

\* Rotation automatique √©chouera si vous n‚Äôenlevez pas `a`.



---



\### Exercice 15 ‚Äî Capabilit√©s POSIX (setcap) pour binaire non-root



\*\*√ânonc√© :\*\* Donnez au binaire `tcpdump` la capacit√© de capturer sans rendre le binaire setuid root.

\*\*D√©marche :\*\*



```bash

sudo setcap cap\_net\_raw,cap\_net\_admin+ep /usr/sbin/tcpdump

getcap /usr/sbin/tcpdump

```



\*\*R√©sultat attendu :\*\* `cap\_net\_raw,cap\_net\_admin+ep`.

\*\*Conseils :\*\*



\* Pr√©ferez capabilities aux setuid quand possible.

&nbsp; \*\*Astuces :\*\*

\* `getpcaps <pid>` montre capabilities en runtime.

&nbsp; \*\*Pi√®ges :\*\*

\* Capabilities mal pos√©es = failles potentielles.



---



\### Exercice 16 ‚Äî R√©parer permissions apr√®s copie depuis Windows/ZIP



\*\*√ânonc√© :\*\* Vous avez extrait un ZIP sur serveur et tout est `-rwxrwxrwx`. R√©parez en appliquant 755 pour r√©pertoires, 644 pour fichiers.

\*\*D√©marche :\*\*



```bash

sudo find /srv/app -type d -exec chmod 755 {} +

sudo find /srv/app -type f -exec chmod 644 {} +

```



\*\*R√©sultat attendu :\*\* perms raisonnables.

\*\*Conseils :\*\*



\* Toujours tester sur subset d‚Äôabord.

&nbsp; \*\*Astuces :\*\*

\* `file` d√©tecte binaires ; pour binaires appliquez 755.

&nbsp; \*\*Pi√®ges :\*\*

\* rater les fichiers ex√©cutables n√©cessaires (scripts) si on force 644 partout.



---



\### Exercice 17 ‚Äî SFTP vs FTP : permissions et umask c√¥t√© serveur



\*\*√ânonc√© :\*\* Configurez un utilisateur SFTP chroot√© et assurez-vous que permissions du chroot respectent s√©curit√©.

\*\*D√©marche (r√©sum√©) :\*\*



\* Dans `/etc/ssh/sshd\_config` : `Match Group sftpusers` ‚Üí `ChrootDirectory /srv/sftp/%u` etc.

\* Le chroot dir \*\*doit\*\* √™tre owned by root\\:root et non writable by others.

&nbsp; \*\*R√©sultat attendu :\*\* utilisateur peut sftp mais pas √©crire dans chroot racine ; √©criture possible dans `uploads/` si chown correct.

&nbsp; \*\*Conseils :\*\*

\* Placez uploads dans sous-dossier owned by user.

&nbsp; \*\*Astuces :\*\*

\* `chmod 755 /srv/sftp` ; `mkdir /srv/sftp/user/uploads \&\& chown user:user /srv/sftp/user/uploads`.

&nbsp; \*\*Pi√®ges :\*\*

\* Mettre chroot owned by user ‚Üí SSHD refuse la connexion.



---



\### Exercice 18 ‚Äî Samba \& permissions Windows ‚Üî Linux



\*\*√ânonc√© :\*\* Configurez partage Samba pour que les utilisateurs Windows cr√©ent des fichiers qui conservent groupe `smbgroup` et perms 770.

\*\*D√©marche (smb.conf snippet) :\*\*



```ini

\[projet]

&nbsp;path = /srv/projet

&nbsp;create mask = 0770

&nbsp;directory mask = 2770

&nbsp;force group = smbgroup

```



\*\*R√©sultat attendu :\*\* fichiers cr√©√©s via SMB appartiennent au groupe forc√©.

\*\*Conseils :\*\*



\* Mettez `force user` si besoin.

&nbsp; \*\*Astuces :\*\*

\* Combinez avec setgid sur le r√©pertoire.

&nbsp; \*\*Pi√®ges :\*\*

\* Confondre masks samba et chmod locaux ‚Äî testez.



---



\### Exercice 19 ‚Äî NFS mount \& root\\\_squash / no\\\_root\\\_squash



\*\*√ânonc√© :\*\* Montez un export NFS et testez `root\_squash` vs `no\_root\_squash`.

\*\*D√©marche :\*\*



\* Exporter `/export` avec `rw,sync,root\_squash` dans `/etc/exports`.

\* Sur client, v√©rifier UID 0 maps to `nobody` (squashed).

&nbsp; \*\*R√©sultat attendu :\*\* root sur client n‚Äôa pas root droit si `root\_squash`.

&nbsp; \*\*Conseils :\*\*

\* Pr√©f√©rer `root\_squash` pour s√©curit√©.

&nbsp; \*\*Astuces :\*\*

\* `showmount -e server` liste exports.

&nbsp; \*\*Pi√®ges :\*\*

\* `no\_root\_squash` sur shares sensibles = risque d‚Äôescalade.



---



\### Exercice 20 ‚Äî Restaurer permissions depuis backup tar avec sauvegarde des ownerships



\*\*√ânonc√© :\*\* D√©ployez un tar contenant propri√©taires et perms et restaurez-le correctement.

\*\*D√©marche :\*\*



```bash

sudo tar -xpvf backup.tar -C /srv/restore

\# options: p = preserve perms, v verbose

```



\*\*R√©sultat attendu :\*\* owners et perms pr√©serv√©s.

\*\*Conseils :\*\*



\* Utiliser `--numeric-owner` si les UIDs ne correspondent pas entre syst√®mes.

&nbsp; \*\*Astuces :\*\*

\* `tar --same-owner` si root.

&nbsp; \*\*Pi√®ges :\*\*

\* Restaurer un tar d‚Äôun autre host sans v√©rifier UIDs ‚Üí ownership incorrect.



---



\### Exercice 21 ‚Äî Detecter trous de permission avec audit



\*\*√ânonc√© :\*\* Cr√©ez une r√®gle auditd pour surveiller changements sur `/etc/sudoers` et `/etc/sudoers.d`.

\*\*D√©marche (exemple) :\*\*



```bash

sudo auditctl -w /etc/sudoers -p wa -k sudoers\_changes

sudo ausearch -k sudoers\_changes

```



\*\*R√©sultat attendu :\*\* logs d‚Äô√©criture/attributs modifi√©s.

\*\*Conseils :\*\*



\* Configurez `auditd` pour production.

&nbsp; \*\*Astuces :\*\*

\* `ausearch` / `aureport` pour rapports.

&nbsp; \*\*Pi√®ges :\*\*

\* Trop de rules peut g√©n√©rer du bruit ; ciblez pr√©cis√©ment.



---



\### Exercice 22 ‚Äî Fichiers setgid vs setuid : audit et listage



\*\*√ânonc√© :\*\* Lister tous fichiers setgid et expliquer risques.

\*\*D√©marche :\*\*



```bash

sudo find / -perm -2000 -type f -ls 2>/dev/null  # setgid

sudo find / -perm -4000 -type f -ls 2>/dev/null  # setuid

```



\*\*R√©sultat attendu :\*\* inventaire setuid/setgid.

\*\*Conseils :\*\*



\* V√©rifiez chaque binaire pour vuln√©rabilit√© exploitables.

&nbsp; \*\*Astuces :\*\*

\* G√©rer liste via CM (Ansible) en prod.

&nbsp; \*\*Pi√®ges :\*\*

\* Ignorer scripts setuid (souvent non support√©s) mais pr√©sents.



---



\### Exercice 23 ‚Äî Permissions pour scripts cron



\*\*√ânonc√© :\*\* Assurez-vous que les scripts ex√©cut√©s par cron ne sont pas world-writable et appartiennent au bon owner.

\*\*D√©marche :\*\*



```bash

ls -l /etc/cron.\* /var/spool/cron/crontabs

\# Corriger

sudo chmod 700 /etc/cron.daily/monscript

sudo chown root:root /etc/cron.daily/monscript

```



\*\*R√©sultat attendu :\*\* scripts s√©curis√©s.

\*\*Conseils :\*\*



\* Cron ignore certains scripts non-ex√©cutables.

&nbsp; \*\*Astuces :\*\*

\* `run-parts` n‚Äôex√©cute que fichiers sans extension sur Debian.

&nbsp; \*\*Pi√®ges :\*\*

\* D√©ployer scripts via SFTP avec perms incorrects ‚Üí cron n‚Äôex√©cute pas.



---



\### Exercice 24 ‚Äî Debug permission denied pour service systemd



\*\*√ânonc√© :\*\* Un service ne d√©marre pas : `Permission denied` sur /var/run/my.sock. Diagnostiquez.

\*\*D√©marche :\*\*



\* `journalctl -u myservice`

\* `ls -l /var/run/my.sock`

\* V√©rifier owner/groupe, umask du service unit (`UMask=`), `ProtectSystem=` ou `ReadOnlyPaths=` directives.

&nbsp; \*\*R√©sultat attendu :\*\* r√©parer owner/group et red√©marrer.

&nbsp; \*\*Conseils :\*\*

\* Pr√©f√©rer `RuntimeDirectory=` in unit file pour cr√©er dir avec bon owner.

&nbsp; \*\*Astuces :\*\*

\* `systemd-analyze verify` pour erreurs unit.

&nbsp; \*\*Pi√®ges :\*\*

\* Penser que c‚Äôest une bug app alors que c‚Äôest juste un mauvais owner.



---



\### Exercice 25 ‚Äî Permissions sur ex√©cutables scripts vs binaire



\*\*√ânonc√© :\*\* Pourquoi rendre un script ex√©cutable n‚Äôest pas la m√™me chose que rendre un binaire ex√©cutable ? D√©monstration.

\*\*D√©marche :\*\*



```bash

echo -e '#!/bin/bash\\necho hello' > s.sh

chmod 755 s.sh

./s.sh   # fonctionne

\# mettre setuid sur script = non recommand√© et souvent ignor√©

sudo chmod 4755 s.sh

ls -l s.sh

```



\*\*R√©sultat attendu :\*\* setuid souvent ignor√© sur scripts ; danger s‚Äôil √©tait appliqu√©.

\*\*Conseils :\*\*



\* Eviter setuid sur scripts ; wrapper binaire possible si n√©cessaire.

&nbsp; \*\*Astuces :\*\*

\* Utiliser `sudo` configur√© ou capabilities.

&nbsp; \*\*Pi√®ges :\*\*

\* Penser qu‚Äôun script setuid √©l√®vera privil√®ges ‚Äî souvent non.



---



\### Exercice 26 ‚Äî Droits sur devices (/dev) et udev



\*\*√ânonc√© :\*\* Ajoutez un utilisateur au groupe `dialout` pour acc√©der √† `/dev/ttyUSB0` et testez.

\*\*D√©marche :\*\*



```bash

sudo usermod -aG dialout developer

ls -l /dev/ttyUSB0

```



\*\*R√©sultat attendu :\*\* user in `dialout` peut acc√©der au device apr√®s reconnect/login.

\*\*Conseils :\*\*



\* udev g√®re perms ; privil√©giez group mapping.

&nbsp; \*\*Astuces :\*\*

\* `udevadm info -a -n /dev/ttyUSB0` pour r√®gles.

&nbsp; \*\*Pi√®ges :\*\*

\* Oublier de se relogger pour que group membership prenne effet.



---



\### Exercice 27 ‚Äî Contr√¥le d‚Äôacc√®s via PAM (ex: restrict home dirs)



\*\*√ânonc√© :\*\* Interdire connexion SSH si home est world-writable (s√©curit√©). V√©rifiez `sshd` configuration et test.

\*\*D√©marche :\*\*



\* `sshd` impose souvent checks sur `/etc/ssh/sshd\_config` StrictModes yes.

\* Rendre home world-writable et tester login.

&nbsp; \*\*R√©sultat attendu :\*\* sshd refuse la connexion si StrictModes active.

&nbsp; \*\*Conseils :\*\*

\* Gardez `chmod 700 /home/user`.

&nbsp; \*\*Astuces :\*\*

\* `ssh -vvv` pour debugging.

&nbsp; \*\*Pi√®ges :\*\*

\* Changer StrictModes sans savoir cause probl√®me.



---



\### Exercice 28 ‚Äî Exporter \& documenter permissions d‚Äôun projet (audit)



\*\*√ânonc√© :\*\* Produisez un rapport CSV des fichiers avec owner, group, perms pour `/srv/projet`.

\*\*D√©marche :\*\*



```bash

sudo find /srv/projet -printf '%p,%u,%g,%m\\n' > /tmp/perms\_report.csv

```



\*\*R√©sultat attendu :\*\* CSV listable dans spreadsheet.

\*\*Conseils :\*\*



\* Ajoutez checksums (md5) si besoin pour int√©grit√©.

&nbsp; \*\*Astuces :\*\*

\* Utilisez `awk`/`python` pour analyser.

&nbsp; \*\*Pi√®ges :\*\*

\* Omettre fichiers cach√©s si scripts mal faits.



---



\### Exercice 29 ‚Äî Migration de permissions entre deux serveurs (UID mapping)



\*\*√ânonc√© :\*\* Vous migrez /home d‚Äôun serveur A √† B o√π UIDs diff√®rent. Comment pr√©server/ajuster owners ?

\*\*D√©marche :\*\*



\* Exporter `getent passwd` pour mapping, ou utiliser `rsync -a --numeric-ids`.



```bash

sudo rsync -aHAX --numeric-ids /source/ user@target:/dest/

```



\*\*R√©sultat attendu :\*\* owners pr√©serv√©s si numeric-ids ; sinon reconstruire mapping.

\*\*Conseils :\*\*



\* Pr√©parez mapping user ‚Üî UID avant migration.

&nbsp; \*\*Astuces :\*\*

\* `tar --numeric-owner` pour tar.

&nbsp; \*\*Pi√®ges :\*\*

\* Perdre ownership ou attribuer files √† wrong users.



---



\### Exercice 30 ‚Äî D√©fi final (cluster) : coh√©rence permissions entre nodes



\*\*√ânonc√© :\*\* Dans un cluster de 3 serveurs partageant NFS, garantissez que `/srv/app` a m√™me owners and ACLs sur tous les nodes ; automatisez v√©rif.

\*\*D√©marche (pr√©conis√©e) :\*\*



\* Centraliser users via LDAP/AD (UIDs identiques).

\* D√©ployer script d‚Äôaudit :



```bash

for host in node1 node2 node3; do ssh $host "getfacl -R /srv/app" > /tmp/acl\_$host.txt; done

\# compare via diff

```



\*\*R√©sultat attendu :\*\* matching ACL/owners across nodes.

\*\*Conseils :\*\*



\* Utiliser CM (Ansible) pour ensure idempotence.

&nbsp; \*\*Astuces :\*\*

\* `rsync -a` pour synchroniser si n√©cessaire.

&nbsp; \*\*Pi√®ges :\*\*

\* UID mismatch sans directory service provoque d√©sastre.



---



\# üîê Th√®me 4 ‚Äî Partie B : 10 exercices d√©di√©s \*\*au fichier sudoers\*\* (utilisateurs \& groupes)



> Ces 10 exercices approfondissent \*\*les param√®tres du sudoers\*\* qui affectent les permissions des \*utilisateurs\* et des \*groupes\* : `User\_Alias`, `Runas\_Alias`, `Host\_Alias`, `Cmnd\_Alias`, NOPASSWD, !authenticate, `Defaults` li√©s aux groupes/users, `sudoers.d` includes, et pi√®ges de s√©curit√©.



---



\### Sudoers Exercice 1 ‚Äî Lire sudoers en toute s√©curit√©



\*\*√ânonc√© :\*\* Ouvrez et inspectez `/etc/sudoers` \*uniquement\* avec `visudo`. Expliquez pourquoi.

\*\*D√©marche :\*\*



```bash

sudo visudo

\# ou sudo visudo -f /etc/sudoers.d/custom

```



\*\*R√©sultat attendu :\*\* Compr√©hension de syntactic checks.

\*\*Conseils :\*\*



\* Toujours modifier avec `visudo` pour √©viter syntax error bloquant sudo.

&nbsp; \*\*Astuces :\*\*

\* visudo v√©rifie la syntaxe et verrouille le fichier.

&nbsp; \*\*Pi√®ges :\*\*

\* √âditer /etc/sudoers directement peut vous verrouiller hors sudo.



---



\### Sudoers Exercice 2 ‚Äî User\\\_Alias \& Cmnd\\\_Alias pratique



\*\*√ânonc√© :\*\* Cr√©ez alias pour administrateurs et ensemble de commandes courantes, puis autorisez alias.

\*\*D√©marche (visudo):\*\*



```

User\_Alias ADMINS = alice, bob

Cmnd\_Alias      SYS = /bin/systemctl, /bin/journalctl

ADMINS ALL = (root) SYS

```



\*\*R√©sultat attendu :\*\* alice/bob peuvent ex√©cuter SYS cmds avec sudo.

\*\*Conseils :\*\*



\* Groupez commandes r√©p√©titives pour lisibilit√©.

&nbsp; \*\*Astuces :\*\*

\* Testez `sudo -l -U alice`.

&nbsp; \*\*Pi√®ges :\*\*

\* Ne pas restreindre arguments (`/bin/systemctl \*` peut √™tre dangereuse).



---



\### Sudoers Exercice 3 ‚Äî NOPASSWD usage et risques



\*\*√ânonc√© :\*\* Ajoutez un utilisateur `deploy` qui peut red√©marrer `nginx` sans mot de passe. √âvaluez le risque.

\*\*D√©marche (visudo):\*\*



```

deploy ALL=(root) NOPASSWD: /bin/systemctl restart nginx

```



\*\*R√©sultat attendu :\*\* deploy peut red√©marrer nginx sans password.

\*\*Conseils :\*\*



\* Restreindre commandes pr√©cises ; documenter pourquoi NOPASSWD est n√©cessaire.

&nbsp; \*\*Astuces :\*\*

\* Utilisez `sudo -l -U deploy` to inspect allowed commands.

&nbsp; \*\*Pi√®ges :\*\*

\* Autoriser scripts shell via NOPASSWD peut √™tre exploit√© (`/bin/sh` wrapper).



---



\### Sudoers Exercice 4 ‚Äî Runas\\\_Alias et principe least-privilege



\*\*√ânonc√© :\*\* Autorisez un service account √† ex√©cuter commandes en tant qu‚Äôun autre utilisateur non-root (e.g., deployer run as appuser).

\*\*D√©marche (visudo):\*\*



```

Runas\_Alias APP = appuser

deploy ALL=(APP) /usr/bin/rsync

```



\*\*R√©sultat attendu :\*\* deploy peut rsync en tant que appuser, pas root.

\*\*Conseils :\*\*



\* Limitez le Runas √† comptes non-privileg√©s si possible.

&nbsp; \*\*Astuces :\*\*

\* `sudo -u appuser command` simule.

&nbsp; \*\*Pi√®ges :\*\*

\* Autoriser `ALL` dans runas revient √† √©l√©vation root potentielle.



---



\### Sudoers Exercice 5 ‚Äî Defaults pour utilisateurs \& groupes



\*\*√ânonc√© :\*\* Ajoutez un `Defaults` qui enregistre timestamp\\\_timeout=0 pour `interns` group (forcer mot de passe chaque commande).

\*\*D√©marche (visudo):\*\*



```

Defaults:%interns timestamp\_timeout=0

```



\*\*R√©sultat attendu :\*\* membres du group interns doivent saisir passwd √† chaque sudo.

\*\*Conseils :\*\*



\* Utiliser Defaults pour renforcer s√©curit√© pour groupes √† risque.

&nbsp; \*\*Astuces :\*\*

\* Combinez with `lecture` et `logfile`.

&nbsp; \*\*Pi√®ges :\*\*

\* Defaults mal plac√©s peuvent provoquer erreurs de parsing.



---



\### Sudoers Exercice 6 ‚Äî Inclus dans /etc/sudoers.d et principe d‚Äôordre



\*\*√ânonc√© :\*\* Cr√©ez `/etc/sudoers.d/deploy` avec r√®gles et v√©rifiez que `visudo -c` valide. Expliquez ordre d‚Äô√©valuation.

\*\*D√©marche :\*\*



```bash

echo "deploy ALL=(root) /usr/bin/systemctl restart nginx" | sudo tee /etc/sudoers.d/deploy

sudo visudo -c

```



\*\*R√©sultat attendu :\*\* fichier valide ; r√®gles appliqu√©es.

\*\*Conseils :\*\*



\* Nommez fichiers avec descriptif (`10-deploy`, `90-admin`) si besoin.

&nbsp; \*\*Astuces :\*\*

\* `visudo -cf /etc/sudoers.d/deploy` pour check single file.

&nbsp; \*\*Pi√®ges :\*\*

\* Droits de /etc/sudoers.d doivent √™tre 0440 ; sinon ignored or insecure.



---



\### Sudoers Exercice 7 ‚Äî Interdire environnement dangereux (env\\\_keep)



\*\*√ânonc√© :\*\* Testez comment `env\_reset` et `env\_keep` affectent variables (PATH, LD\\\_PRELOAD). Configurez pour bloquer LD\\\_PRELOAD.

\*\*D√©marche (visudo):\*\*



```

Defaults env\_reset

Defaults env\_keep += "HOME"

```



\*\*R√©sultat attendu :\*\* LD\\\_PRELOAD n‚Äôest pas conserv√©e ‚Äî prot√®ge contre injection.

\*\*Conseils :\*\*



\* Ne garder que ce qui est n√©cessaire via env\\\_keep.

&nbsp; \*\*Astuces :\*\*

\* `sudo -E` behavior depends on Defaults.

&nbsp; \*\*Pi√®ges :\*\*

\* Garder PATH utilisateur peut √™tre risqu√© (path injection).



---



\### Sudoers Exercice 8 ‚Äî Commandes avec arguments s√ªrs (CMND\\\_Alias \& sudoers)



\*\*√ânonc√© :\*\* Autorisez `backup` √† ex√©cuter `/usr/bin/rsync` uniquement avec un jeu d‚Äôarguments pr√©d√©fini.

\\\*\\\*D√©marche (visudo):



```

Cmnd\_Alias BACKUP = /usr/bin/rsync -av --delete /srv/data /backup/

backup ALL=(root) NOPASSWD: BACKUP

```



\*\*R√©sultat attendu :\*\* backup ne peut pas lancer rsync arbitrary args.

\*\*Conseils :\*\*



\* Short-circuit : si l‚Äôadmin peut modifier script cible, il peut √©chapper la restriction.

&nbsp; \*\*Astuces :\*\*

\* Wrappez la commande dans un script contr√¥l√©, et autorisez uniquement ce script.

&nbsp; \*\*Pi√®ges :\*\*

\* Autoriser `rsync` sans args = potentiel d‚Äôabus.



---



\### Sudoers Exercice 9 ‚Äî Audit des permissions sudo et remediation



\*\*√ânonc√© :\*\* G√©n√©rer rapport des NOPASSWD entries et proposez rem√©diations.

\*\*D√©marche :\*\*



```bash

sudo grep -R "NOPASSWD" /etc/sudoers /etc/sudoers.d || true

```



\*\*R√©sultat attendu :\*\* liste des occurrences.

\*\*Conseils :\*\*



\* Documenter raison business pour chaque NOPASSWD ; √©valuer risques.

&nbsp; \*\*Astuces :\*\*

\* Automatiser revue via script et envoyer rapport aux owners.

&nbsp; \*\*Pi√®ges :\*\*

\* Laisser NOPASSWD en prod sans justification.



---



\### Sudoers Exercice 10 ‚Äî D√©fi s√©curit√© : fermer √©l√©vation via sudo pour un groupe



\*\*√ânonc√© :\*\* Le groupe `contractors` a trop de privil√®ges. Cr√©ez r√®gle `Defaults:%contractors !authenticate` ‚Üí inversez pour forcer authentication et limitez commandes. Testez et proposez rollback.

\*\*D√©marche (visudo):\*\*



```

\# retirer !authenticate si pr√©sent, forcer auth:

Defaults:%contractors authenticate

\# restreindre commandes:

%contractors ALL=(root) /usr/bin/systemctl status, /usr/bin/journalctl -n 200

```



\*\*R√©sultat attendu :\*\* contractors doivent s‚Äôauthentifier et only allowed cmds.

\*\*Conseils :\*\*



\* Toujours tester via `sudo -l -U user`.

&nbsp; \*\*Astuces :\*\*

\* Pr√©voir un bouton rollback (commenter r√®gle) via orchestrator.

&nbsp; \*\*Pi√®ges :\*\*

\* Mal √©crire `%contractor` vs `%contractors` provoque r√®gle inop√©rante.



---



‚úÖ Voil√† les \*\*40 exercices\*\* (30 sur permissions g√©n√©riques + 10 centr√©s sudoers). Chaque exercice est con√ßu pour √™tre \*\*ex√©cut√© en environnement de test\*\* et est orient√© ¬´ cas r√©el ¬ª (d√©ploiement, partage, services, NFS, samba, SFTP, audit).



Si vous voulez, je peux maintenant :



1\. \*\*G√©n√©rer des scripts pr√™ts\*\* (Ansible/ bash) pour automatiser plusieurs de ces t√¢ches (par exemple la cr√©ation du r√©pertoire partag√© setgid + ACLs + users), ou

2\. \*\*Transformer ces exercices en ateliers pas-√†-pas pr√™t √† l‚Äôinstant (avec validations automatiques)\*\* pour vos sessions de formation (ex : checks `OK/KO` pour chaque √©tape), ou

3\. \*\*Passer au Th√®me 5 (Scripts shell)\*\* et produire 20 exercices semblablement d√©taill√©s.



