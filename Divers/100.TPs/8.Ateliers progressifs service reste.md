# üß© Labo 2 : Service `oneshot`

Un service **oneshot** ex√©cute une t√¢che ponctuelle puis s‚Äôarr√™te.

---

### √âtape 1 : Service oneshot basique

**D√©marche :**
Cr√©ez `/usr/local/bin/init-message.sh` :

```bash
#!/usr/bin/env bash
echo "Initialisation du syst√®me $(date)" >> /var/log/init-message.log
```

```bash
chmod +x /usr/local/bin/init-message.sh
```

Unit√© `/etc/systemd/system/init-message.service` :

```ini
[Unit]
Description=Service oneshot qui √©crit un message

[Service]
Type=oneshot
ExecStart=/usr/local/bin/init-message.sh
```

```bash
sudo systemctl daemon-reload
sudo systemctl start init-message
```

**Validation :** `cat /var/log/init-message.log` ‚Üí message √©crit.

**Astuce :** id√©al pour init de variables, migration DB.
**Conseil :** utilisez `Type=oneshot` pour scripts ponctuels.
**Pi√®ge :** sans `RemainAfterExit=yes`, `systemctl status` le montre inactif apr√®s ex√©cution.

---

### √âtape 2 : Garder l‚Äô√©tat apr√®s ex√©cution

**D√©marche :** Ajoutez √† `[Service]` :

```ini
RemainAfterExit=yes
```

**Validation :** `systemctl status init-message` ‚Üí reste ‚Äúactive (exited)‚Äù.

**Astuce :** utile pour services de configuration (iptables, sysctl).
**Conseil :** l‚Äô√©tat refl√®te la r√©ussite, pas l‚Äôex√©cution continue.
**Pi√®ge :** croire qu‚Äôil tourne encore ‚Üí ce n‚Äôest pas le cas.

---

### √âtape 3 : Stop explicite

Ajoutez :

```ini
ExecStop=/bin/rm -f /var/log/init-message.log
```

```bash
systemctl stop init-message
```

**Validation :** fichier log supprim√©.
**Astuce :** `ExecStop` dans oneshot sert √† annuler les effets.
**Conseil :** d√©finissez toujours un cleanup quand c‚Äôest pertinent.
**Pi√®ge :** oublier `RemainAfterExit` ‚Üí `ExecStop` jamais appel√©.

---

### √âtape 4 : Ajouter plusieurs √©tapes

**D√©marche :**

```ini
ExecStart=/usr/bin/echo "Step 1" >> /tmp/steps.log
ExecStart=/usr/bin/echo "Step 2" >> /tmp/steps.log
ExecStart=/usr/bin/echo "Step 3" >> /tmp/steps.log
```

**Validation :** `cat /tmp/steps.log` ‚Üí 3 lignes.
**Astuce :** plusieurs `ExecStart` s‚Äôex√©cutent **en s√©quence**.
**Conseil :** c‚Äôest pratique pour une mini-checklist.
**Pi√®ge :** pas de parall√©lisme ‚Üí tout est s√©quentiel.

---

### √âtape 5 : Packaging

Incluez script + service dans un `.deb` via `fpm` :

```bash
fpm -s dir -t deb -n init-message \
  /usr/local/bin/init-message.sh=/usr/local/bin/init-message.sh \
  /etc/systemd/system/init-message.service=/etc/systemd/system/init-message.service
```

**Astuce :** `systemctl preset-all` applique les politiques par d√©faut.
**Conseil :** livrez vos units packag√©es plut√¥t que copi√©es manuellement.
**Pi√®ge :** oublier `daemon-reload` post-install ‚Üí service non d√©tect√©.

---

# üåÄ Labo 3 : Service `forking`

Un service **forking** = un d√©mon qui se d√©tache (ex: Apache).

---

### √âtape 1 : Exemple minimal avec `sleep`

**D√©marche :**
Cr√©ez un script `/usr/local/bin/daemon.sh` :

```bash
#!/usr/bin/env bash
( while true; do date >> /var/log/daemon.log; sleep 5; done ) &
echo $! > /var/run/daemon.pid
```

Unit√© `/etc/systemd/system/daemon.service` :

```ini
[Unit]
Description=Service forking

[Service]
Type=forking
ExecStart=/usr/local/bin/daemon.sh
PIDFile=/var/run/daemon.pid
```

```bash
sudo systemctl daemon-reload
sudo systemctl start daemon
```

**Validation :** `systemctl status daemon` ‚Üí actif.

**Astuce :** `PIDFile=` crucial pour que systemd suive le bon process.
**Conseil :** utilisez ce type pour vieux daemons non systemd-ready.
**Pi√®ge :** script sans PIDFile ‚Üí systemd ‚Äúperd‚Äù le suivi.

---

### √âtape 2 : Stop/Restart

Ajoutez :

```ini
ExecStop=/bin/kill -TERM $MAINPID
```

Testez :

```bash
sudo systemctl stop daemon
sudo systemctl restart daemon
```

**Astuce :** `$MAINPID` lit PIDFile.
**Conseil :** ajustez `Restart=` selon vos besoins.
**Pi√®ge :** `killall` tue tous les daemons du m√™me nom ‚Üí dangereux.

---

### √âtape 3 : Reload

Ajoutez dans script :

```bash
trap 'echo reload >> /var/log/daemon.log' HUP
```

Puis dans l‚Äôunit√© :

```ini
ExecReload=/bin/kill -HUP $MAINPID
```

**Validation :** `systemctl reload daemon`.

---

# üîî Labo 4 : Service `notify`

Un service **notify** communique explicitement son √©tat √† systemd.

---

### √âtape 1 : Script avec sd\_notify

**D√©marche :** Installez `libsystemd-dev`.
Script `/usr/local/bin/notify.sh` :

```bash
#!/usr/bin/env bash
echo "READY=1" | systemd-notify --fd=3
while true; do sleep 5; done
```

Unit√© :

```ini
[Service]
Type=notify
ExecStart=/usr/local/bin/notify.sh
NotifyAccess=all
```

**Validation :** `systemctl status notify` ‚Üí devient ‚Äúactive‚Äù apr√®s READY.

**Astuce :** assure un d√©marrage **r√©ellement pr√™t**.
**Conseil :** pr√©f√©rez `notify` pour services r√©seau lents √† initialiser.
**Pi√®ge :** oublier `NotifyAccess=all` ‚Üí READY jamais re√ßu.

---

# üéØ Labo 5 : Unit Target

Un target regroupe plusieurs services.

---

### √âtape 1 : Cr√©er un target custom

**D√©marche :**
Unit√© `/etc/systemd/system/dev-env.target` :

```ini
[Unit]
Description=Environnement de dev
Requires=nginx.service mysql.service
After=nginx.service mysql.service
```

Activation :

```bash
sudo systemctl daemon-reload
sudo systemctl isolate dev-env.target
```

**Validation :** les services requis d√©marrent ensemble.

**Astuce :** utilisez pour regrouper des stacks compl√®tes.
**Conseil :** `isolate` change de target comme runlevel.
**Pi√®ge :** oublier `After=` ‚Üí ordre non garanti.

---

# ‚è∞ Labo 6 : Unit Timer

Un timer remplace avantageusement cron.

---

### √âtape 1 : Service + timer simple

**D√©marche :**
Cr√©ez `/etc/systemd/system/backup.service` :

```ini
[Service]
Type=oneshot
ExecStart=/usr/local/bin/backup.sh
```

Puis `/etc/systemd/system/backup.timer` :

```ini
[Timer]
OnCalendar=daily
Persistent=true
```

Activation :

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now backup.timer
```

**Validation :** `systemctl list-timers`.

**Astuce :** `Persistent=true` ex√©cute m√™me si machine √©teinte √† l‚Äôheure.
**Conseil :** pr√©f√©rez timer plut√¥t que cron pour logs int√©gr√©s.
**Pi√®ge :** activer `.service` mais pas `.timer` ‚Üí rien ne tourne.

---

### √âtape 2 : Random delay

Ajoutez :

```ini
RandomizedDelaySec=15m
```

√âvite les pics simultan√©s en cluster.

