# 🗓️ Thème 6 — Planification (cron / at) — Exercices pratiques enrichis avec scripts

---

## A) Bases de `cron` (utilisateur & système)

---

### 1) Créer sa première tâche utilisateur

**Énoncé :** Exécuter `date >> ~/cron.log` chaque minute.

**Crontab :**

```bash
* * * * * /usr/local/bin/logdate.sh
```

**📄 Contenu du script `/usr/local/bin/logdate.sh` :**

```bash
#!/bin/bash
# logdate.sh — écrit la date courante dans un log

set -euo pipefail
echo "Execution à $(date)" >> "$HOME/cron.log"
```

**Validation :**
Après 2–3 min, vérifier :

```bash
tail ~/cron.log
```

---

### 2) Configurer PATH et SHELL dans crontab

**Énoncé :** Définir un `PATH` explicite dans la crontab.

**Crontab :**

```bash
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
*/5 * * * * /usr/local/bin/showenv.sh
```

**📄 Contenu du script `/usr/local/bin/showenv.sh` :**

```bash
#!/bin/bash
# showenv.sh — affiche l'environnement vu par cron

set -euo pipefail
env >> "$HOME/env.txt"
```

**Validation :**

```bash
cat ~/env.txt
```

---

### 3) Utiliser les alias @hourly/@daily/@reboot

**Énoncé :** Écrire 3 jobs : `@reboot`, `@hourly`, `@daily`.

**Crontab :**

```bash
@reboot /usr/local/bin/onboot.sh
@hourly /usr/local/bin/onhour.sh
@daily /usr/local/bin/onday.sh
```

**📄 Scripts associés :**

`/usr/local/bin/onboot.sh`

```bash
#!/bin/bash
echo "Démarrage système $(date)" >> "$HOME/boot.log"
```

`/usr/local/bin/onhour.sh`

```bash
#!/bin/bash
echo "Nouvelle heure $(date)" >> "$HOME/hour.log"
```

`/usr/local/bin/onday.sh`

```bash
#!/bin/bash
echo "Nouveau jour $(date)" >> "$HOME/day.log"
```

---

### 4) Comprendre run-parts et /etc/cron.daily

**Énoncé :** Ajouter un script exécutable dans `/etc/cron.daily/`.

**📄 Script `/etc/cron.daily/mydaily` :**

```bash
#!/bin/sh
echo "Execution mydaily à $(date)" >> /var/log/mydaily.log
```

**Validation :**

```bash
sudo run-parts --report /etc/cron.daily
```

---

### 5) `MAILTO` pour recevoir les sorties

**Énoncé :** Envoyer la sortie d’un job par mail.

**Crontab :**

```bash
MAILTO="votre.email@example.com"
*/10 * * * * /usr/local/bin/mailreport.sh
```

**📄 Script `/usr/local/bin/mailreport.sh` :**

```bash
#!/bin/bash
echo "Rapport généré à $(date)"
```

---

### 6) Journaliser proprement (stdout/stderr)

**Énoncé :** Séparer logs out/err.

**Crontab :**

```bash
*/5 * * * * /usr/local/bin/job.sh >> $HOME/job.out 2>> $HOME/job.err
```

**📄 Script `/usr/local/bin/job.sh` :**

```bash
#!/bin/bash
# job.sh — génère sortie normale + erreur

echo "Sortie normale à $(date)"
echo "Erreur simulée à $(date)" >&2
```

---

### 7) Empêcher la concurrence (flock)

**Énoncé :** Ne laisser qu’une instance du script.

**Crontab :**

```bash
*/3 * * * * flock -n /tmp/backup.lock /usr/local/bin/backup.sh
```

**📄 Script `/usr/local/bin/backup.sh` :**

```bash
#!/bin/bash
set -euo pipefail
LOGFILE="$HOME/backup-demo.log"

echo "[$(date '+%F %T')] Début sauvegarde fictive" >> "$LOGFILE"
sleep 60
echo "[$(date '+%F %T')] Fin sauvegarde fictive" >> "$LOGFILE"
```

---

### 8) Mécanisme allow/deny

**Énoncé :** Autoriser cron à certains utilisateurs.

**Commande :**

```bash
echo "user1" | sudo tee -a /etc/cron.allow
echo "user2" | sudo tee -a /etc/cron.deny
```

(Pas de script associé.)

---

### 9) Crontab système vs utilisateur

**Énoncé :** Planifier un job système.

**/etc/crontab :**

```bash
*/15 * * * * root /usr/local/bin/healthcheck.sh
```

**📄 Script `/usr/local/bin/healthcheck.sh` :**

```bash
#!/bin/bash
echo "Healthcheck OK $(date)" >> /var/log/healthcheck.log
```

---

### 10) Décalage aléatoire (stagger)

**Énoncé :** Éviter pics simultanés.

**Crontab :**

```bash
0 * * * * sleep $((RANDOM % 600)); /usr/local/bin/randomjob.sh
```

**📄 Script `/usr/local/bin/randomjob.sh` :**

```bash
#!/bin/bash
echo "Job décalé exécuté à $(date)" >> "$HOME/randomjob.log"
```

# 🗓️ Thème 6 — Planification (cron / at)

## B) Cron avancé (robustesse, TZ, anacron, rotation)

---

### 11) Forcer un fuseau horaire

**Énoncé :** Lancer un job à 02:30 UTC.

**Crontab :**

```bash
30 2 * * * TZ=UTC /usr/local/bin/report.sh
```

**📄 Script `/usr/local/bin/report.sh` :**

```bash
#!/bin/bash
echo "Rapport exécuté à $(date)" >> "$HOME/report.log"
```

---

### 12) Gérer DST (heure d’été/hiver)

**Énoncé :** S’assurer qu’un job critique s’exécute le jour du passage d’heure.

**Crontab :**

```bash
15 2 * * * /usr/local/bin/dstjob.sh
15 3 * * * /usr/local/bin/dstjob.sh
```

**📄 Script `/usr/local/bin/dstjob.sh` :**

```bash
#!/bin/bash
echo "Job critique exécuté à $(date)" >> "$HOME/dstjob.log"
```

---

### 13) `anacron` pour hôtes non 24/7

**Énoncé :** Lancer `daily` même si PC était éteint.

**📄 Script `/etc/cron.daily/myanacron` :**

```bash
#!/bin/bash
echo "Job anacron exécuté à $(date)" >> /var/log/myanacron.log
```

(⚠️ Ce script sera déclenché par `anacron`, pas directement par `cron`.)

---

### 14) Rotation de logs pour jobs cron

**Énoncé :** Protéger `/var/log/myjob.log` avec logrotate.

**📄 Script `/usr/local/bin/myjob.sh` :**

```bash
#!/bin/bash
echo "Job écrit dans log à $(date)" >> /var/log/myjob.log
```

**Fichier `/etc/logrotate.d/myjob` :**

```conf
/var/log/myjob.log {
    weekly
    rotate 8
    compress
    missingok
    notifempty
    create 0640 root adm
}
```

---

### 15) Pré/post-hook dans un wrapper

**Énoncé :** Encapsuler le job avec logs début/fin.

**Crontab :**

```bash
*/10 * * * * /usr/local/bin/wrapper.sh >> /var/log/wrapper.log 2>&1
```

**📄 Script `/usr/local/bin/wrapper.sh` :**

```bash
#!/bin/bash
set -euo pipefail

START=$(date +%s)
echo "=== Début job à $(date) ==="

# Simulation d’une tâche
sleep 45

END=$(date +%s)
echo "=== Fin job à $(date) (Durée: $((END - START))s) ==="
```

---

### 16) Notifications de succès/échec

**Énoncé :** Envoyer une alerte en cas d’échec.

**Crontab :**

```bash
*/10 * * * * /usr/local/bin/failjob.sh || /usr/local/bin/notify_fail.sh "failjob"
```

**📄 Script `/usr/local/bin/failjob.sh` :**

```bash
#!/bin/bash
# Simule un job avec 50% d’échec
if (( RANDOM % 2 )); then
  echo "Succès à $(date)"
else
  echo "Échec volontaire à $(date)" >&2
  exit 1
fi
```

**📄 Script `/usr/local/bin/notify_fail.sh` :**

```bash
#!/bin/bash
JOB=$1
echo "ALERTE : $JOB a échoué à $(date)" >> "$HOME/failalerts.log"
```

---

### 17) Vérifier l’espace disque avant job

**Énoncé :** Ne lancer que si `/` a >20% libre.

**Crontab :**

```bash
*/30 * * * * /usr/local/bin/checkdisk.sh
```

**📄 Script `/usr/local/bin/checkdisk.sh` :**

```bash
#!/bin/bash
USED=$(df -P / | awk 'NR==2 {print $5}' | tr -d '%')
if [ "$USED" -lt 80 ]; then
  echo "Espace disque OK → tâche lancée $(date)" >> "$HOME/checkdisk.log"
else
  echo "Espace disque insuffisant → tâche annulée $(date)" >> "$HOME/checkdisk.log"
fi
```

---

### 18) Contrôler la durée (timeout)

**Énoncé :** Tuer la tâche si >10 minutes.

**Crontab :**

```bash
*/5 * * * * timeout 10m /usr/local/bin/longjob.sh
```

**📄 Script `/usr/local/bin/longjob.sh` :**

```bash
#!/bin/bash
echo "Début job long $(date)" >> "$HOME/longjob.log"
sleep 900   # 15 min → sera tué par timeout
echo "Fin job long $(date)" >> "$HOME/longjob.log"
```

---

### 19) Éviter l’exécution si instance précédente en cours (PID file)

**Énoncé :** Empêcher le chevauchement via PID file.

**Crontab :**

```bash
*/5 * * * * /usr/local/bin/pidjob.sh
```

**📄 Script `/usr/local/bin/pidjob.sh` :**

```bash
#!/bin/bash
PIDFILE="/tmp/pidjob.pid"

if [ -f "$PIDFILE" ]; then
  echo "Job déjà en cours ($(cat $PIDFILE)) à $(date)" >> "$HOME/pidjob.log"
  exit 1
fi

echo $$ > "$PIDFILE"
trap "rm -f $PIDFILE" EXIT

echo "Début job avec PID $$ à $(date)" >> "$HOME/pidjob.log"
sleep 60
echo "Fin job avec PID $$ à $(date)" >> "$HOME/pidjob.log"
```

---

### 20) `crontab` depuis Ansible (idempotent)

**Énoncé :** Gérer crontab via Ansible.

**📄 Exemple Playbook `cron.yml` :**

```yaml
- name: Démo gestion crontab
  hosts: all
  tasks:
    - name: Ajouter un job backup
      cron:
        name: "Sauvegarde journalière"
        minute: "0"
        hour: "1"
        job: "/usr/local/bin/backup.sh"
```

**📄 Script `/usr/local/bin/backup.sh` (placeholder) :**

```bash
#!/bin/bash
echo "Sauvegarde via Ansible à $(date)" >> "$HOME/ansible-backup.log"
```
