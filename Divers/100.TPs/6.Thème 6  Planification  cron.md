# ðŸ—“ï¸ ThÃ¨me 6 â€” Planification (cron / at) â€” Exercices pratiques enrichis avec scripts

---

## A) Bases de `cron` (utilisateur & systÃ¨me)

---

### 1) CrÃ©er sa premiÃ¨re tÃ¢che utilisateur

**Ã‰noncÃ© :** ExÃ©cuter `date >> ~/cron.log` chaque minute.

**Crontab :**

```bash
* * * * * /usr/local/bin/logdate.sh
```

**ðŸ“„ Contenu du script `/usr/local/bin/logdate.sh` :**

```bash
#!/bin/bash
# logdate.sh â€” Ã©crit la date courante dans un log

set -euo pipefail
echo "Execution Ã  $(date)" >> "$HOME/cron.log"
```

**Validation :**
AprÃ¨s 2â€“3 min, vÃ©rifier :

```bash
tail ~/cron.log
```

---

### 2) Configurer PATH et SHELL dans crontab

**Ã‰noncÃ© :** DÃ©finir un `PATH` explicite dans la crontab.

**Crontab :**

```bash
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
*/5 * * * * /usr/local/bin/showenv.sh
```

**ðŸ“„ Contenu du script `/usr/local/bin/showenv.sh` :**

```bash
#!/bin/bash
# showenv.sh â€” affiche l'environnement vu par cron

set -euo pipefail
env >> "$HOME/env.txt"
```

**Validation :**

```bash
cat ~/env.txt
```

---

### 3) Utiliser les alias @hourly/@daily/@reboot

**Ã‰noncÃ© :** Ã‰crire 3 jobs : `@reboot`, `@hourly`, `@daily`.

**Crontab :**

```bash
@reboot /usr/local/bin/onboot.sh
@hourly /usr/local/bin/onhour.sh
@daily /usr/local/bin/onday.sh
```

**ðŸ“„ Scripts associÃ©s :**

`/usr/local/bin/onboot.sh`

```bash
#!/bin/bash
echo "DÃ©marrage systÃ¨me $(date)" >> "$HOME/boot.log"
```

`/usr/local/bin/onhour.sh`

```bash
#!/bin/bash
echo "Nouvelle heure $(date)" >> "$HOME/hour.log"
```

`/usr/local/bin/onday.sh`

```bash
#!/bin/bash
echo "Nouveau jour $(date)" >> "$HOME/day.log"
```

---

### 4) Comprendre run-parts et /etc/cron.daily

**Ã‰noncÃ© :** Ajouter un script exÃ©cutable dans `/etc/cron.daily/`.

**ðŸ“„ Script `/etc/cron.daily/mydaily` :**

```bash
#!/bin/sh
echo "Execution mydaily Ã  $(date)" >> /var/log/mydaily.log
```

**Validation :**

```bash
sudo run-parts --report /etc/cron.daily
```

---

### 5) `MAILTO` pour recevoir les sorties

**Ã‰noncÃ© :** Envoyer la sortie dâ€™un job par mail.

**Crontab :**

```bash
MAILTO="votre.email@example.com"
*/10 * * * * /usr/local/bin/mailreport.sh
```

**ðŸ“„ Script `/usr/local/bin/mailreport.sh` :**

```bash
#!/bin/bash
echo "Rapport gÃ©nÃ©rÃ© Ã  $(date)"
```

---

### 6) Journaliser proprement (stdout/stderr)

**Ã‰noncÃ© :** SÃ©parer logs out/err.

**Crontab :**

```bash
*/5 * * * * /usr/local/bin/job.sh >> $HOME/job.out 2>> $HOME/job.err
```

**ðŸ“„ Script `/usr/local/bin/job.sh` :**

```bash
#!/bin/bash
# job.sh â€” gÃ©nÃ¨re sortie normale + erreur

echo "Sortie normale Ã  $(date)"
echo "Erreur simulÃ©e Ã  $(date)" >&2
```

---

### 7) EmpÃªcher la concurrence (flock)

**Ã‰noncÃ© :** Ne laisser quâ€™une instance du script.

**Crontab :**

```bash
*/3 * * * * flock -n /tmp/backup.lock /usr/local/bin/backup.sh
```

**ðŸ“„ Script `/usr/local/bin/backup.sh` :**

```bash
#!/bin/bash
set -euo pipefail
LOGFILE="$HOME/backup-demo.log"

echo "[$(date '+%F %T')] DÃ©but sauvegarde fictive" >> "$LOGFILE"
sleep 60
echo "[$(date '+%F %T')] Fin sauvegarde fictive" >> "$LOGFILE"
```

---

### 8) MÃ©canisme allow/deny

**Ã‰noncÃ© :** Autoriser cron Ã  certains utilisateurs.

**Commande :**

```bash
echo "user1" | sudo tee -a /etc/cron.allow
echo "user2" | sudo tee -a /etc/cron.deny
```

(Pas de script associÃ©.)

---

### 9) Crontab systÃ¨me vs utilisateur

**Ã‰noncÃ© :** Planifier un job systÃ¨me.

**/etc/crontab :**

```bash
*/15 * * * * root /usr/local/bin/healthcheck.sh
```

**ðŸ“„ Script `/usr/local/bin/healthcheck.sh` :**

```bash
#!/bin/bash
echo "Healthcheck OK $(date)" >> /var/log/healthcheck.log
```

---

### 10) DÃ©calage alÃ©atoire (stagger)

**Ã‰noncÃ© :** Ã‰viter pics simultanÃ©s.

**Crontab :**

```bash
0 * * * * sleep $((RANDOM % 600)); /usr/local/bin/randomjob.sh
```

**ðŸ“„ Script `/usr/local/bin/randomjob.sh` :**

```bash
#!/bin/bash
echo "Job dÃ©calÃ© exÃ©cutÃ© Ã  $(date)" >> "$HOME/randomjob.log"
```

# ðŸ—“ï¸ ThÃ¨me 6 â€” Planification (cron / at)

## B) Cron avancÃ© (robustesse, TZ, anacron, rotation)

---

### 11) Forcer un fuseau horaire

**Ã‰noncÃ© :** Lancer un job Ã  02:30 UTC.

**Crontab :**

```bash
30 2 * * * TZ=UTC /usr/local/bin/report.sh
```

**ðŸ“„ Script `/usr/local/bin/report.sh` :**

```bash
#!/bin/bash
echo "Rapport exÃ©cutÃ© Ã  $(date)" >> "$HOME/report.log"
```

---

### 12) GÃ©rer DST (heure dâ€™Ã©tÃ©/hiver)

**Ã‰noncÃ© :** Sâ€™assurer quâ€™un job critique sâ€™exÃ©cute le jour du passage dâ€™heure.

**Crontab :**

```bash
15 2 * * * /usr/local/bin/dstjob.sh
15 3 * * * /usr/local/bin/dstjob.sh
```

**ðŸ“„ Script `/usr/local/bin/dstjob.sh` :**

```bash
#!/bin/bash
echo "Job critique exÃ©cutÃ© Ã  $(date)" >> "$HOME/dstjob.log"
```

---

### 13) `anacron` pour hÃ´tes non 24/7

**Ã‰noncÃ© :** Lancer `daily` mÃªme si PC Ã©tait Ã©teint.

**ðŸ“„ Script `/etc/cron.daily/myanacron` :**

```bash
#!/bin/bash
echo "Job anacron exÃ©cutÃ© Ã  $(date)" >> /var/log/myanacron.log
```

(âš ï¸ Ce script sera dÃ©clenchÃ© par `anacron`, pas directement par `cron`.)

---

### 14) Rotation de logs pour jobs cron

**Ã‰noncÃ© :** ProtÃ©ger `/var/log/myjob.log` avec logrotate.

**ðŸ“„ Script `/usr/local/bin/myjob.sh` :**

```bash
#!/bin/bash
echo "Job Ã©crit dans log Ã  $(date)" >> /var/log/myjob.log
```

**Fichier `/etc/logrotate.d/myjob` :**

```conf
/var/log/myjob.log {
    weekly
    rotate 8
    compress
    missingok
    notifempty
    create 0640 root adm
}
```

---

### 15) PrÃ©/post-hook dans un wrapper

**Ã‰noncÃ© :** Encapsuler le job avec logs dÃ©but/fin.

**Crontab :**

```bash
*/10 * * * * /usr/local/bin/wrapper.sh >> /var/log/wrapper.log 2>&1
```

**ðŸ“„ Script `/usr/local/bin/wrapper.sh` :**

```bash
#!/bin/bash
set -euo pipefail

START=$(date +%s)
echo "=== DÃ©but job Ã  $(date) ==="

# Simulation dâ€™une tÃ¢che
sleep 45

END=$(date +%s)
echo "=== Fin job Ã  $(date) (DurÃ©e: $((END - START))s) ==="
```

---

### 16) Notifications de succÃ¨s/Ã©chec

**Ã‰noncÃ© :** Envoyer une alerte en cas dâ€™Ã©chec.

**Crontab :**

```bash
*/10 * * * * /usr/local/bin/failjob.sh || /usr/local/bin/notify_fail.sh "failjob"
```

**ðŸ“„ Script `/usr/local/bin/failjob.sh` :**

```bash
#!/bin/bash
# Simule un job avec 50% dâ€™Ã©chec
if (( RANDOM % 2 )); then
  echo "SuccÃ¨s Ã  $(date)"
else
  echo "Ã‰chec volontaire Ã  $(date)" >&2
  exit 1
fi
```

**ðŸ“„ Script `/usr/local/bin/notify_fail.sh` :**

```bash
#!/bin/bash
JOB=$1
echo "ALERTE : $JOB a Ã©chouÃ© Ã  $(date)" >> "$HOME/failalerts.log"
```

---

### 17) VÃ©rifier lâ€™espace disque avant job

**Ã‰noncÃ© :** Ne lancer que si `/` a >20% libre.

**Crontab :**

```bash
*/30 * * * * /usr/local/bin/checkdisk.sh
```

**ðŸ“„ Script `/usr/local/bin/checkdisk.sh` :**

```bash
#!/bin/bash
USED=$(df -P / | awk 'NR==2 {print $5}' | tr -d '%')
if [ "$USED" -lt 80 ]; then
  echo "Espace disque OK â†’ tÃ¢che lancÃ©e $(date)" >> "$HOME/checkdisk.log"
else
  echo "Espace disque insuffisant â†’ tÃ¢che annulÃ©e $(date)" >> "$HOME/checkdisk.log"
fi
```

---

### 18) ContrÃ´ler la durÃ©e (timeout)

**Ã‰noncÃ© :** Tuer la tÃ¢che si >10 minutes.

**Crontab :**

```bash
*/5 * * * * timeout 10m /usr/local/bin/longjob.sh
```

**ðŸ“„ Script `/usr/local/bin/longjob.sh` :**

```bash
#!/bin/bash
echo "DÃ©but job long $(date)" >> "$HOME/longjob.log"
sleep 900   # 15 min â†’ sera tuÃ© par timeout
echo "Fin job long $(date)" >> "$HOME/longjob.log"
```

---

### 19) Ã‰viter lâ€™exÃ©cution si instance prÃ©cÃ©dente en cours (PID file)

**Ã‰noncÃ© :** EmpÃªcher le chevauchement via PID file.

**Crontab :**

```bash
*/5 * * * * /usr/local/bin/pidjob.sh
```

**ðŸ“„ Script `/usr/local/bin/pidjob.sh` :**

```bash
#!/bin/bash
PIDFILE="/tmp/pidjob.pid"

if [ -f "$PIDFILE" ]; then
  echo "Job dÃ©jÃ  en cours ($(cat $PIDFILE)) Ã  $(date)" >> "$HOME/pidjob.log"
  exit 1
fi

echo $$ > "$PIDFILE"
trap "rm -f $PIDFILE" EXIT

echo "DÃ©but job avec PID $$ Ã  $(date)" >> "$HOME/pidjob.log"
sleep 60
echo "Fin job avec PID $$ Ã  $(date)" >> "$HOME/pidjob.log"
```

---

### 20) `crontab` depuis Ansible (idempotent)

**Ã‰noncÃ© :** GÃ©rer crontab via Ansible.

**ðŸ“„ Exemple Playbook `cron.yml` :**

```yaml
- name: DÃ©mo gestion crontab
  hosts: all
  tasks:
    - name: Ajouter un job backup
      cron:
        name: "Sauvegarde journaliÃ¨re"
        minute: "0"
        hour: "1"
        job: "/usr/local/bin/backup.sh"
```

**ðŸ“„ Script `/usr/local/bin/backup.sh` (placeholder) :**

```bash
#!/bin/bash
echo "Sauvegarde via Ansible Ã  $(date)" >> "$HOME/ansible-backup.log"
```
