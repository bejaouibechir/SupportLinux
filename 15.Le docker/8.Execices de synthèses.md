



## üß© Exercice 1 ‚Äî Synchronisation basique : sans `depends_on`

**Objectif** : observer le comportement d‚Äôun service qui d√©pend d‚Äôun autre sans synchronisation.

Cr√©er **docker-compose-no-depends.yml** :

```yaml
version: "3.9"

services:
  db:
    image: mysql:8.4
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=testdb

  web:
    image: alpine:3.20
    command: ["/bin/sh", "-c", "mysql -h db -u root -prootpass -e 'SHOW DATABASES;'"]
```

Ex√©cutez :

```bash
docker compose -f docker-compose-no-depends.yml up -d
docker logs web
```

‚û°Ô∏è Erreur attendue : `Can't connect to MySQL server` ‚Äî le conteneur web d√©marre trop t√¥t.

---

## üß© Exercice 2 ‚Äî Ordonnancement : `depends_on`

**Objectif** : forcer le lancement dans l‚Äôordre.

Cr√©er **docker-compose-depends.yml** :

```yaml
version: "3.9"

services:
  db:
    image: mysql:8.4
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=testdb

  web:
    image: alpine:3.20
    depends_on:
      - db
    command: ["/bin/sh", "-c", "sleep 2 && mysql -h db -u root -prootpass -e 'SHOW DATABASES;'"]
```

‚û°Ô∏è L‚Äôordre est respect√©, mais MySQL peut encore √™tre ¬´ non pr√™t ¬ª.

---

## üß© Exercice 3 ‚Äî Synchronisation fiable : `depends_on.condition: service_healthy`

**Objectif** : attendre que la base soit r√©ellement **ready** avant le `web`.

Cr√©er **docker-compose-healthy.yml** :

```yaml
version: "3.9"

services:
  db:
    image: mysql:8.4
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=testdb
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s

  web:
    image: alpine:3.20
    depends_on:
      db:
        condition: service_healthy
    command: ["/bin/sh", "-c", "mysql -h db -u root -prootpass -e 'SELECT DATABASE();'"]
```

‚û°Ô∏è R√©sultat attendu : succ√®s apr√®s que MySQL affiche `healthy`.

---

## üß© Exercice 4 ‚Äî Configuration : `environment` vs `env_file`

**Objectif** : distinguer les deux approches.

- `environment:` pour variables simples visibles dans le YAML.

- `env_file:` pour centraliser secrets et variables r√©utilisables.

Exemple de test :

```yaml
version: "3.9"
services:
  test:
    image: alpine
    env_file: .env
    command: ["/bin/sh", "-c", "env | sort"]
```

Puis dans `.env` :

```
VAR1=from_file
VAR2=secret
```

‚û°Ô∏è Comparer avec des valeurs inline sous `environment:`.

---

## üß© Exercice 5 ‚Äî Fiabilit√© : politiques `restart`

**Objectif** : illustrer `no`, `on-failure`, `always`, `unless-stopped`.

Testez :

```yaml
services:
  demo:
    image: alpine
    command: ["/bin/sh", "-c", "exit 1"]
    restart: on-failure
```

‚û°Ô∏è Observer `Restarting` via `docker ps` ou `docker compose ps`.

---

## üß© Exercice 6 ‚Äî R√©seaux

**Objectif** : cr√©er des r√©seaux isol√©s et v√©rifier la r√©solution DNS interne.

```yaml
version: "3.9"
networks:
  frontnet:
  backnet:

services:
  db:
    image: mysql:8.4
    networks: [backnet]
  api:
    image: alpine
    networks: [backnet]
  web:
    image: nginx
    networks: [frontnet]
```

‚û°Ô∏è Tester : `docker exec -it <api> ping db` (ok), `ping web` (non).

---

## üß© Exercice 7 ‚Äî Volumes (bind vs named)

**Objectif** : persistance des donn√©es et permissions.

Cas 1 : volume nomm√©

```yaml
volumes:
  data: {}
services:
  db:
    image: mysql:8.4
    volumes:
      - data:/var/lib/mysql
```

Cas 2 : montage bind

```yaml
services:
  db:
    image: mysql:8.4
    volumes:
      - ./mysql-data:/var/lib/mysql
```

‚û°Ô∏è Comparer persistance apr√®s `docker compose down -v`.

---

## üß© Exercice 8 ‚Äî S√©curit√© et durcissement

**Objectif** : appliquer `read_only`, `cap_drop`, `security_opt`.

```yaml
services:
  app:
    image: synthese-backend:v3
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
```

‚û°Ô∏è V√©rifier : le conteneur fonctionne, mais ne peut plus √©crire sur le rootfs.

---

## üß© Exercice 9 ‚Äî Nettoyage global

**Objectif** : supprimer tous les artefacts.

```bash
docker compose -f docker-compose-healthy.yml down -v
docker rm -f old_db || true
```

‚û°Ô∏è Retour √† un environnement propre.

---

## üß© Exercice 10 ‚Äî R√©sum√© comparatif (r√©vision)

| M√©thode                                 | Fonction                      | Garantit ordre | Garantit ‚Äúready‚Äù | Recommand√©e ? |
| --------------------------------------- | ----------------------------- | -------------- | ---------------- | ------------- |
| Aucun lien                              | Services d√©marrent sans ordre | ‚ùå              | ‚ùå                | ‚ùå             |
| `depends_on` simple                     | Lance dans l‚Äôordre            | ‚úÖ              | ‚ùå                | ‚ö†Ô∏è            |
| `depends_on.condition: service_healthy` | Attente r√©elle de sant√©       | ‚úÖ              | ‚úÖ                | ‚úÖ             |
| `--link`                                | Lien statique obsol√®te        | partiel        | ‚ùå                | ‚ùå             |


