

# üß± Atelier 2 ‚Äî Introduction pratique √† Docker

**Installation, images, conteneurs, r√©seau et volumes (avec nettoyage)**

## üéØ Objectifs

- Installer Docker proprement (service + CLI + Compose plugin).

- Manipuler images & conteneurs : recherche, pull, ex√©cution, logs, inspect.

- G√©rer le r√©seau Docker (bridge, r√©seaux d√©di√©s) et les volumes.

- D√©sinstaller/nettoyer proprement l‚Äôenvironnement.

## üß∞ Pr√©-requis

- Debian 12 ou Ubuntu 22.04 (sudo disponible).

- Connexion Internet.

- (Option) Script auto-install : voir atelier 9 (si d√©j√† utilis√©, ignorer l‚Äô√©tape 1).

---

## 1) Installation de Docker (m√©thode simple via d√©p√¥t Ubuntu/Debian)

> Remarque : la m√©thode ‚Äúrapide‚Äù ci-dessous installe le paquet **`docker.io`** des d√©p√¥ts de ta distribution (pratique pour un lab). Pour la **derni√®re version officielle**, pr√©f√®re l‚Äôatelier 9 (installation via d√©p√¥t Docker).  
> Si ton script/commande vient d‚Äôun poste Windows, convertis d‚Äôabord CRLF ‚Üí LF.

### 1.1 Mise √† jour et installation

```bash
sudo apt update
sudo apt install -y docker.io
```

D√©marrer et activer au boot :

```bash
sudo systemctl start docker
sudo systemctl enable docker
sudo systemctl status docker --no-pager
```

‚ûï Ajouter ton utilisateur au groupe `docker` (optionnel) :

```bash
groups $USER
sudo usermod -aG docker $USER
# D√©connecte/reconnecte ta session pour que le groupe prenne effet
```

*(Install & enable inspir√© de ta recette :* `apt install docker.io`, `systemctl start|enable`*)*

### 1.2 (Astuce) Correction CRLF ‚Üí LF si script copi√© depuis Windows

```bash
sed -i 's/\r$//' install_docker.sh
```

---

## 2) Images Docker ‚Äî recherche, pull, listing & suppression

### 2.1 Rechercher des images sur Docker Hub

```bash
docker search sqlserver
docker search httpd
docker search phpmyadmin
```

üëâ Utile pour d√©couvrir les r√©f√©rences officielles (ex: `httpd`, `mcr.microsoft.com/mssql/server`).

### 2.2 Aide sur la sous-commande images

```bash
docker image --help
```

*(R√©f√©rence d‚Äôaide issue de ta recette)*

### 2.3 T√©l√©charger (pull) des images

```bash
docker pull httpd              # derni√®re version (tag : latest)
docker pull httpd:2            # version pr√©cise
```

*(Exemples ‚Äúhttpd‚Äù et ‚Äúhttpd:2‚Äù repris)*

### 2.4 Lister & supprimer des images

```bash
docker images                  # ou: docker image ls
docker image rm httpd:2        # supprime une image pr√©cise
docker image prune -a          # nettoie les images non utilis√©es
docker rmi $(docker image ls -q)   # supprime TOUTES les images (dangereux)
```

> ‚ö†Ô∏è Correction : `docker rm -f` sert aux **conteneurs**, pas aux images. Pour forcer la suppression d‚Äôune image : `docker rmi -f IMAGE_ID`. (Ta recette mentionnait √† tort `docker rm - f image identifier`)

---

## 3) Conteneurs ‚Äî ex√©cuter, lister, logs, exec, inspect

### 3.1 Lister les conteneurs

```bash
docker ps        # en cours d'ex√©cution
docker ps -a     # tous (y compris stopp√©s)
```

*(Commandes align√©es sur ta recette)*

### 3.2 Cr√©er et d√©marrer un conteneur

```bash
docker run -itd --name hello_devops httpd:alpine
docker start hello_devops
docker restart hello_devops
```

> Options utiles :  
> `-t` pseudo-terminal, `-i` interactif, `-d` d√©tach√© (arri√®re-plan).

### 3.3 Arr√™ter & supprimer des conteneurs

```bash
docker stop hello_devops
docker container prune               # supprime conteneurs stopp√©s inutilis√©s
docker rm -f $(docker ps -a -q)      # supprime TOUS les conteneurs (dangereux)
```

*(`container prune` repris, plus `rm` global conforme)*

### 3.4 Ex√©cuter une commande dans un conteneur

```bash
docker exec -ti hello_devops bash    # shell interactif si image le permet
docker exec -ti m1 bash              # exemple de la recette
```

> On peut aussi ex√©cuter des commandes ponctuelles :  
> `docker exec -ti hello_devops ls -al /usr/local/apache2/`

### 3.5 Logs & Inspect

```bash
docker logs --tail=20 hello_devops   # derni√®res 20 lignes
docker logs -f hello_devops          # suivi live (Ctrl+C pour quitter)

docker inspect hello_devops          # JSON d√©taill√© (r√©seau, volumes, etc.)
```

*(Logs tail/follow et inspect repris)*

---

## 4) R√©seau Docker ‚Äî bridge, r√©seaux d√©di√©s, connexion

### 4.1 Outils r√©seau dans le conteneur (si besoin de ping/ip)

```bash
apt-get update -y
apt-get install -y iputils-ping iproute2
```

> √Ä ex√©cuter **√† l‚Äôint√©rieur** d‚Äôun conteneur Debian/Ubuntu si tu veux tester `ping`/`ip`.

### 4.2 Inspecter les r√©seaux et le bridge par d√©faut

```bash
docker network ls
docker network inspect bridge
```

*(Repris de ta recette)*

### 4.3 Cr√©er des r√©seaux d√©di√©s

```bash
docker network create --driver bridge vlan1
docker network create vlan2 --subnet=192.168.10.0/24 --gateway=192.168.10.1
```

Connecter/d√©connecter un conteneur en cours d‚Äôex√©cution :

```bash
docker network connect vlan1 srv1
docker network disconnect vlan1 srv1
```

Supprimer/ranger :

```bash
docker network rm vlan1
docker network prune -f
```

*(Suite r√©seau fid√®le √† ta recette, avec exemples)*

### 4.4 Exposer un port (exemple SQL Server Linux)

```bash
docker run -e 'ACCEPT_EULA=Y' -e 'SA_PASSWORD=<your_password>' \
  -p 1433:1433 --name sql_server_instance -d \
  mcr.microsoft.com/mssql/server:2019-latest

docker exec -it sql_server_instance \
  /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P '<your_password>'
```

*(Exemple exact de ta recette)*

---

## 5) Volumes ‚Äî persistance de donn√©es

Cr√©er & lister :

```bash
docker volume create --name data
docker volume ls
```

> Utilise ensuite `-v data:/chemin/dans/conteneur` dans `docker run` pour persister.

---

## 6) Nettoyage complet du lab

### 6.1 Supprimer conteneurs, images, r√©seaux non utilis√©s

```bash
docker rm -f $(docker ps -a -q)            # tous les conteneurs
docker rmi -f $(docker images -q)          # toutes les images
docker network prune -f
docker volume prune -f
```

### 6.2 D√©sinstallation ‚Äúm√©thode simple‚Äù

> (Uniquement si tu as install√© via `apt install docker.io` ci-dessus)

```bash
sudo systemctl stop docker docker.socket containerd || true
sudo apt purge -y docker.io
sudo rm -rf /var/lib/docker /var/lib/containerd
sudo apt autoremove -y && sudo apt clean
```

> Pour la **m√©thode officielle** (d√©p√¥t Docker), utilise la proc√©dure de d√©sinstall de l‚Äôatelier 9.

---

## ‚úÖ V√©rifications finales

- `docker --version` renvoie une version.

- `docker run hello-world` fonctionne.

- `docker ps`, `docker images`, `docker network ls` listent des √©l√©ments.

- Apr√®s nettoyage, `which docker || echo "Docker d√©sinstall√©"` affiche le message.

---

## üí° Astuces & pi√®ges

- **Permissions** : ajoute ton user au groupe `docker` pour √©viter `sudo` (reconnexion requise).

- **Ports** : `-p HOST:CONTENEUR` expose bien le service (v√©rifie firewall local).

- **R√©seau** : `docker network inspect` est ton ami pour diagnostiquer connectivit√©/alias.

- **CRLF** : toujours convertir tes scripts copi√©s depuis Windows : `sed -i 's/\r$//' fichier.sh`.

- **Prune** : `image/container/network/volume prune` ne supprime **que** ce qui est non utilis√©.

---

### (Annexe) Aide interactive

- `docker image --help`, `docker container --help`, `docker network --help`, `docker volume --help`.

- Documentation `docker exec` : `docker exec --help` et page de r√©f√©rence en ligne.


