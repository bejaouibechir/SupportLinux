# 🧠 Atelier 4 – Analyse et réparation du montage des systèmes de fichiers

**Niveau 1 – Amorçage & bases du boot (Debian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Durant la phase d’initialisation, après le chargement du noyau et la prise en main par `systemd`, le système doit **monter les partitions racine (`/`), boot (`/boot`), swap, home, etc.)** conformément au fichier `/etc/fstab`.

Un montage incorrect (UUID erroné, périphérique manquant, erreur `fsck`, etc.) peut bloquer complètement le démarrage.

Objectifs pédagogiques :

- Comprendre la logique de montage automatique (fstab, initramfs, systemd-mount).

- Diagnostiquer un blocage au boot dû à un système de fichiers défectueux.

- Réparer un `fstab` ou un système de fichiers corrompu via un environnement Live.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1 – Téléchargement du Live Debian 13

📥 Image officielle (ISO Live GNOME) :  
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

---

### 2.2 – Script de configuration initiale (AZERTY + utilitaires)

Créer le fichier **prepare_live_env.sh** :

```bash
#!/usr/bin/env bash
# Script pour préparer un environnement Live Debian de dépannage (clavier FR, outils disque et réseau)

set -euo pipefail

echo "---- Configuration du clavier français ----"
sudo localectl set-keymap fr
sudo localectl set-x11-keymap fr

echo "---- Installation des outils nécessaires ----"
sudo apt update
sudo apt install -y vim gparted parted e2fsprogs dosfstools lvm2 mdadm btrfs-progs ntfs-3g sshfs
```

🗨️ **Bulle explicative**  
Ce script configure le clavier AZERTY et installe les utilitaires nécessaires pour manipuler, réparer et monter des partitions de tous types (ext4, LVM, Btrfs, NTFS…).

---

## 🧩 3. Étude du fonctionnement du montage des systèmes de fichiers

### 3.1 – Fichier `/etc/fstab`

Afficher le contenu :

```bash
cat /etc/fstab
```

🗨️ **Bulle explicative**  
Chaque ligne du fichier `/etc/fstab` décrit une partition à monter automatiquement au démarrage.  
Format :

```
<source>   <point_de_montage>   <type>   <options>   <dump>   <pass>
```

Exemple typique :

```
UUID=1e7b1b4a-7b11-4fd9-bf0a-8a452ce6fca0  /  ext4  errors=remount-ro  0  1
UUID=E3A0-FD12  /boot/efi  vfat  umask=0077  0  1
UUID=8a43-9f6c  none  swap  sw  0  0
```

---

### 3.2 – Identifier les disques et partitions

```bash
lsblk -f
```

🗨️ **Bulle explicative**  
Affiche la hiérarchie des périphériques bloc, leurs UUID, types de système de fichiers et points de montage.  
Très utile pour vérifier la correspondance avec `/etc/fstab`.

---

### 3.3 – Consulter les logs de montage au boot

```bash
journalctl -b -u systemd-fsck --no-pager
```

🗨️ **Bulle explicative**  
`systemd-fsck` effectue la vérification des systèmes de fichiers au démarrage.  
Cette commande montre s’il a détecté ou réparé des erreurs.

---

## ⚠️ 4. Simulation d’une erreur de montage

### 4.1 – Casser une entrée `fstab` (sur une VM)

```bash
sudo cp /etc/fstab /etc/fstab.bak
sudo sed -i 's/UUID/#UUID/' /etc/fstab
```

🗨️ **Bulle explicative**  
On commente temporairement les UUID pour simuler une entrée illisible.  
Lors du prochain redémarrage, Debian démarrera en mode “maintenance” (`emergency.target`).

---

### 4.2 – Vérifier le comportement au boot

Redémarrer la VM :

```bash
sudo reboot
```

🗨️ **Bulle explicative**  
Le système affichera un message du type :  
`cannot find UUID=xxxxxxx` ou `enter root password for maintenance`.  
C’est une situation typique de boot bloqué par `fstab`.

---

## 🧰 5. Réparation via un environnement Live

### 5.1 – Monter la partition racine

```bash
sudo fdisk -l
sudo mount /dev/sda1 /mnt
```

🗨️ **Bulle explicative**  
Identifie et monte la partition racine du système à réparer sur `/mnt`.

---

### 5.2 – Vérifier l’intégrité du système de fichiers

```bash
sudo e2fsck -f /dev/sda1
```

🗨️ **Bulle explicative**  
Force la vérification du système de fichiers ext4.  
Les erreurs trouvées seront corrigées automatiquement avec confirmation.

---

### 5.3 – Restaurer le fichier `fstab`

```bash
sudo cp /mnt/etc/fstab.bak /mnt/etc/fstab
```

🗨️ **Bulle explicative**  
Restaure la configuration correcte des points de montage.

---

### 5.4 – Vérifier les UUID réels

```bash
sudo blkid
```

🗨️ **Bulle explicative**  
Affiche les UUID exacts de chaque partition.  
Toujours les comparer avec ceux du fichier `/etc/fstab`.

---

### 5.5 – (Optionnel) Régénérer `initramfs`

```bash
sudo chroot /mnt
update-initramfs -u
exit
```

🗨️ **Bulle explicative**  
L’image `initramfs` contient les pilotes et outils nécessaires au montage initial des partitions racine.  
Une régénération peut corriger des erreurs de dépendance.

---

## 🔍 6. Vérification après redémarrage

```bash
sudo reboot
mount | grep "^/dev"
```

🗨️ **Bulle explicative**  
Affiche les points de montage actifs et confirme que toutes les partitions prévues dans `fstab` sont bien montées.

---

## 🧹 7. Nettoyage / rollback

```bash
sudo rm /mnt/etc/fstab.bak
sudo umount /mnt
```

🗨️ **Bulle explicative**  
Supprime la sauvegarde temporaire et démonte la partition réparée.

---

## 💡 8. Astuces & Pièges fréquents

| Problème                    | Cause probable                 | Solution                           |
| --------------------------- | ------------------------------ | ---------------------------------- |
| Blocage `emergency mode`    | Mauvais UUID dans `/etc/fstab` | Corriger via Live + `blkid`        |
| `mount: wrong fs type`      | Type de FS erroné              | Vérifier avec `lsblk -f`           |
| `fsck` échoue               | Système de fichiers corrompu   | `e2fsck -f -y /dev/sda1`           |
| Boot lent sur disque absent | Option `nofail` manquante      | Ajouter `nofail` dans `/etc/fstab` |

---

## ✅ Résumé de l’atelier

- Lecture et interprétation du fichier `/etc/fstab`.

- Utilisation de `lsblk`, `blkid`, et `journalctl` pour diagnostiquer les montages.

- Réparation d’un montage bloquant via un environnement Live.

- Vérification et régénération du `initramfs` pour corriger les dépendances.
