

# 🧠 Atelier 3 – Analyse du processus `systemd` au démarrage

**Niveau 1 – Amorçage & bases du boot (Debian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Après le chargement du noyau Linux par GRUB, c’est le **PID 1**, `systemd`, qui prend la main.  
Il orchestre la montée en services : montage des disques, démarrage réseau, affichage, etc.

Objectifs de cet atelier :

- Comprendre la structure et le rôle de `systemd`.

- Analyser les unités (units) exécutées au démarrage.

- Diagnostiquer un démarrage lent ou bloqué.

- Créer un service personnalisé simple et le surveiller au boot.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1 – Contexte système

Vérifiez la version de Debian et du noyau :

```bash
hostnamectl
uname -r
```

🗨️ **Bulle explicative**  
`hostnamectl` affiche les informations système : distribution, architecture, version du kernel.  
`uname -r` affiche la version exacte du noyau utilisé par `systemd` pour ce boot.

---

### 2.2 – Mettre à jour et installer les outils d’analyse

```bash
sudo apt update
sudo apt install -y systemd systemd-analyze psmisc htop
```

🗨️ **Bulle explicative**

- `systemd-analyze` : mesure le temps de démarrage.

- `psmisc` : fournit `pstree` pour visualiser la hiérarchie des processus.

- `htop` : surveillance interactive du système.

---

## 🧩 3. Observation du processus `systemd`

### 3.1 – Identifier le PID 1

```bash
ps -p 1 -o pid,comm,cmd
```

🗨️ **Bulle explicative**  
Affiche le processus dont le PID est 1 : il doit s’agir de `systemd`.  
Si ce n’est pas le cas, c’est qu’un autre init est utilisé (rare sur Debian 13).

---

### 3.2 – Lister les unités actives

```bash
systemctl list-units --type=service --state=running
```

🗨️ **Bulle explicative**  
Montre tous les services actuellement actifs et gérés par `systemd`.  
Les colonnes :

- **LOAD** : service chargé.

- **ACTIVE** : état général.

- **SUB** : état détaillé (running, exited, dead…).

---

### 3.3 – Visualiser les dépendances

```bash
systemctl list-dependencies multi-user.target
```

🗨️ **Bulle explicative**  
Affiche l’arbre des services qui doivent être actifs pour atteindre la cible `multi-user.target`  
(équivalent du **runlevel 3**, démarrage sans interface graphique).

---

### 3.4 – Hiérarchie complète des processus

```bash
pstree -p 1
```

🗨️ **Bulle explicative**  
Affiche la structure des processus descendants de `systemd` :  
on y voit `NetworkManager`, `sshd`, `cron`, etc.  
Cela illustre la façon dont `systemd` supervise tous les services.

---

## ⏱ 4. Analyse du temps de démarrage

### 4.1 – Durée totale du boot

```bash
systemd-analyze
```

🗨️ **Bulle explicative**  
Indique combien de temps ont pris :

- le firmware/BIOS,

- le chargeur (GRUB),

- le noyau,

- l’espace utilisateur (`systemd`).

Exemple :

```
Startup finished in 2.345s (kernel) + 4.789s (userspace) = 7.134s
```

---

### 4.2 – Identifier les services lents

```bash
systemd-analyze blame | head
```

🗨️ **Bulle explicative**  
Liste les unités les plus longues à démarrer.  
Très utile pour détecter un service bloquant ou mal configuré.

---

### 4.3 – Diagramme critique

```bash
systemd-analyze critical-chain
```

🗨️ **Bulle explicative**  
Affiche la **chaîne critique** du boot :  
le chemin exact des services qui déterminent le temps total de démarrage.

---

## 🧰 5. Création d’un service personnalisé

Créer le fichier **/etc/systemd/system/hello-boot.service** :

```bash
[Unit]
Description=Message de démarrage personnalisé
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/hello-boot.sh

[Install]
WantedBy=multi-user.target
```

🗨️ **Bulle explicative**  
Ce service exécute un petit script une seule fois au boot (`Type=oneshot`).  
Il se lance après que le réseau soit disponible.

---

Créer le fichier **/usr/local/bin/hello-boot.sh** :

```bash
#!/usr/bin/env bash
# Petit script d’affichage d’un message de boot
set -euo pipefail
logger "💡 Atelier systemd : le service hello-boot vient de s’exécuter avec succès !"
```

🗨️ **Bulle explicative**  
Le script envoie un message dans le journal système via `logger`.  
C’est la manière propre de communiquer avec `journald`.

---

Activer et tester le service :

```bash
sudo chmod +x /usr/local/bin/hello-boot.sh
sudo systemctl daemon-reload
sudo systemctl enable hello-boot.service
sudo systemctl start hello-boot.service
```

🗨️ **Bulle explicative**

- `daemon-reload` : recharge les fichiers d’unité.

- `enable` : active le service pour le prochain boot.

- `start` : exécute immédiatement le service.

---

Vérifiez le journal :

```bash
journalctl -u hello-boot.service --no-pager
```

🗨️ **Bulle explicative**  
Permet de confirmer que le message du script a bien été enregistré dans les logs `systemd`.

---

## 🔍 6. Dépannage et vérification

### 6.1 – Lister tous les échecs

```bash
systemctl --failed
```

🗨️ **Bulle explicative**  
Affiche les unités ayant échoué au démarrage.  
Très utile pour comprendre pourquoi un service ne s’est pas lancé.

---

### 6.2 – Examiner les logs globaux du boot courant

```bash
journalctl -b --priority=3 --no-pager
```

🗨️ **Bulle explicative**  
Affiche uniquement les messages de priorité 3 (erreurs) du dernier boot.  
Pratique pour détecter rapidement les anomalies.

---

## 🧹 7. Nettoyage / rollback

```bash
sudo systemctl disable hello-boot.service
sudo rm /etc/systemd/system/hello-boot.service
sudo rm /usr/local/bin/hello-boot.sh
sudo systemctl daemon-reload
```

🗨️ **Bulle explicative**  
Supprime le service de test et recharge `systemd` proprement.

---

## 💡 8. Astuces & Pièges fréquents

| Problème                    | Cause probable                          | Solution                                                    |
| --------------------------- | --------------------------------------- | ----------------------------------------------------------- |
| Service non exécuté au boot | Mauvais `WantedBy` ou `After`           | Vérifier les dépendances avec `systemctl list-dependencies` |
| Boot très lent              | Timeout sur un service (network, fstab) | Analyser avec `systemd-analyze blame`                       |
| Journal vide                | `systemd-journald` désactivé            | `systemctl enable --now systemd-journald`                   |
| Fichier d’unité ignoré      | Pas de `daemon-reload` après ajout      | Lancer `systemctl daemon-reload`                            |

---

## ✅ Résumé de l’atelier

- Compréhension du rôle fondamental de `systemd` (PID 1).

- Exploration des unités, dépendances et services.

- Diagnostic des lenteurs ou échecs de boot.

- Création et gestion d’un service personnalisé au démarrage.


