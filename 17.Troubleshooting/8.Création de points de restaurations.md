

# ğŸ§  Atelier 8 â€“ CrÃ©er et restaurer un â€œpoint de restaurationâ€ du systÃ¨me Debian 13

**Niveau 1 â€“ AmorÃ§age & bases du boot (Debian 13 â€œTrixieâ€)**

---

## ğŸ¯ 1. Contexte & Objectif

CrÃ©er un **point de restauration** signifie capturer Ã  un instant T lâ€™Ã©tat du systÃ¨me :

- fichiers critiques du dÃ©marrage (BIOS, MBR, GRUB, Kernel),

- configuration systÃ¨me (`/etc`, `/var`, `/boot`),

- donnÃ©es utilisateurs (`/home`),

â€¦et Ãªtre capable de **revenir** Ã  cet Ã©tat en cas de corruption, mauvaise mise Ã  jour ou suppression accidentelle.

### Objectifs pÃ©dagogiques

- CrÃ©er un â€œsnapshotâ€ local complet du systÃ¨me.

- Automatiser la crÃ©ation de ce snapshot.

- Restaurer le systÃ¨me depuis un point enregistrÃ©.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1 â€“ PrÃ©requis

- Debian 13 avec accÃ¨s root (`sudo`).

- Un deuxiÃ¨me disque ou un rÃ©pertoire montÃ© pour stocker les snapshots (ex : `/mnt/snapshots`).

- Les paquets `rsync`, `tar`, `grub`, `gzip` installÃ©s.

### 2.2 â€“ CrÃ©ation du rÃ©pertoire des snapshots

```bash
sudo mkdir -p /mnt/snapshots
sudo chmod 700 /mnt/snapshots
```

ğŸ—¨ï¸ **Bulle explicative**  
Le rÃ©pertoire `/mnt/snapshots` hÃ©bergera les â€œpoints de restaurationâ€ datÃ©s et compressÃ©s.  
Les droits 700 garantissent que seul root peut y accÃ©der.

---

## ğŸ’¾ 3. Script : crÃ©ation dâ€™un point de restauration complet

CrÃ©er le fichier **/usr/local/bin/create_restore_point.sh** :

```bash
#!/usr/bin/env bash
# CrÃ©e un point de restauration complet du systÃ¨me Debian
# Auteur : Atelier DevOps Debian
# Usage : sudo bash /usr/local/bin/create_restore_point.sh

set -euo pipefail

DATE=$(date +%F-%H%M)
SNAP_DIR="/mnt/snapshots/restore_$DATE"

echo "---- CrÃ©ation du snapshot $SNAP_DIR ----"
mkdir -p "$SNAP_DIR"

echo "---- Sauvegarde du MBR ----"
dd if=/dev/sda of="$SNAP_DIR/mbr_backup.img" bs=512 count=1 status=none

echo "---- Archivage des rÃ©pertoires critiques ----"
tar -cpzf "$SNAP_DIR/etc_boot.tar.gz" /etc /boot /lib/systemd /etc/default/grub

echo "---- Sauvegarde du /home ----"
tar -cpzf "$SNAP_DIR/home.tar.gz" /home

echo "---- VÃ©rification ----"
ls -lh "$SNAP_DIR"

echo "---- Point de restauration crÃ©Ã© avec succÃ¨s ----"
```

ğŸ—¨ï¸ **Bulle explicative**

- `dd` : capture le MBR du disque.

- `tar -cpzf` : archive et compresse les rÃ©pertoires critiques (`/etc`, `/boot`, etc.).

- Les fichiers sont stockÃ©s dans un dossier datÃ© (`restore_YYYY-MM-DD-HHMM`).

- Ce script constitue une **photographie complÃ¨te** de lâ€™Ã©tat du systÃ¨me.

---

## ğŸ§° 4. Automatiser la crÃ©ation de points de restauration

CrÃ©er le fichier **/etc/cron.daily/create_restore_point** :

```bash
#!/bin/bash
/usr/local/bin/create_restore_point.sh > /var/log/restore_point.log 2>&1
```

Rendre le script exÃ©cutable :

```bash
sudo chmod +x /etc/cron.daily/create_restore_point
```

ğŸ—¨ï¸ **Bulle explicative**  
Chaque jour, un point de restauration est crÃ©Ã© automatiquement et journalisÃ©.  
Le fichier `/var/log/restore_point.log` conserve la trace des opÃ©rations.

---

## âš™ï¸ 5. Simulation : suppression du GRUB ou du /etc corrompu

> âš ï¸ Ã€ faire uniquement sur une VM de test !

```bash
sudo mv /boot/grub /boot/grub.bak
sudo rm -rf /etc/*
sudo reboot
```

ğŸ—¨ï¸ **Bulle explicative**  
On simule une corruption grave du systÃ¨me : le GRUB et les fichiers de configuration sont perdus.  
La machine ne pourra plus dÃ©marrer.

---

## ğŸ”§ 6. Restauration depuis un point de restauration (Live Debian)

### 6.1 â€“ Monter la partition racine

```bash
sudo fdisk -l
sudo mount /dev/sda1 /mnt
sudo mount /dev/sdb1 /mnt/snapshots
```

ğŸ—¨ï¸ **Bulle explicative**  
`/dev/sda1` : partition Ã  restaurer,  
`/dev/sdb1` : disque contenant les snapshots.

---

### 6.2 â€“ Extraire le snapshot choisi

```bash
cd /mnt
sudo tar -xpvzf /mnt/snapshots/restore_2025-10-21-1400/etc_boot.tar.gz -C /
sudo tar -xpvzf /mnt/snapshots/restore_2025-10-21-1400/home.tar.gz -C /
```

ğŸ—¨ï¸ **Bulle explicative**  
Les archives sont dÃ©compressÃ©es et leurs fichiers replacÃ©s dans leur emplacement dâ€™origine.  
Les options `-xpvzf` : extraction, prÃ©servation des permissions, mode verbeux, gzip, fichier source.

---

### 6.3 â€“ Restauration du MBR

```bash
sudo dd if=/mnt/snapshots/restore_2025-10-21-1400/mbr_backup.img of=/dev/sda bs=512 count=1
```

ğŸ—¨ï¸ **Bulle explicative**  
RÃ©Ã©crit le chargeur de premier niveau.  
Attention : toujours vÃ©rifier le bon disque avant dâ€™exÃ©cuter cette commande.

---

### 6.4 â€“ RÃ©installer GRUB et rÃ©gÃ©nÃ©rer lâ€™initramfs

```bash
sudo chroot /mnt
grub-install /dev/sda
update-grub
update-initramfs -u -k all
exit
```

ğŸ—¨ï¸ **Bulle explicative**  
RÃ©installe GRUB et rÃ©gÃ©nÃ¨re les fichiers de dÃ©marrage pour aligner les UUID et modules du noyau.

---

### 6.5 â€“ RedÃ©marrage et vÃ©rification

```bash
sudo reboot
```

VÃ©rifiez ensuite :

```bash
uname -r
ls /boot
systemctl status
```

ğŸ—¨ï¸ **Bulle explicative**  
Le systÃ¨me doit redÃ©marrer normalement avec le noyau et les fichiers restaurÃ©s.

---

## ğŸ§¹ 7. Nettoyage et rotation automatique des snapshots

CrÃ©er le script **/usr/local/bin/cleanup_snapshots.sh** :

```bash
#!/usr/bin/env bash
# Supprime les snapshots de plus de 7 jours
find /mnt/snapshots/restore_* -maxdepth 0 -mtime +7 -exec rm -rf {} \;
```

ğŸ—¨ï¸ **Bulle explicative**  
Ce script supprime les anciens points de restauration (plus de 7 jours) pour Ã©viter la saturation disque.

---

## ğŸ’¡ 8. Astuces & bonnes pratiques

| Composant            | MÃ©thode de restauration                | Outil principal       |
| -------------------- | -------------------------------------- | --------------------- |
| MBR corrompu         | Restaurer `mbr_backup.img`             | `dd`                  |
| GRUB cassÃ©           | Extraire `/boot/grub` + `grub-install` | `tar`, `grub-install` |
| initramfs perdu      | `update-initramfs -u`                  | `initramfs-tools`     |
| /etc corrompu        | Extraire `etc_boot.tar.gz`             | `tar`                 |
| utilisateur supprimÃ© | Restaurer `/etc/passwd`, `/etc/shadow` | `tar`                 |
| snapshot automatique | `/etc/cron.daily/create_restore_point` | `cron`                |

---

## âœ… RÃ©sumÃ© de lâ€™atelier

- Mise en place dâ€™un **mÃ©canisme de points de restauration systÃ¨me** sans outils externes.

- Capture complÃ¨te : **MBR, /boot, /etc, /home, systemd**.

- Automatisation via **cron** et rotation automatique.

- ProcÃ©dure de **restauration complÃ¨te** depuis un environnement Live.


