# 🧠 Atelier 7 – Sauvegarde préventive et recouvrement des fichiers système critiques

**Niveau 1 – Amorçage & bases du boot (Debian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Un incident de démarrage peut provenir :

- d’une mise à jour du noyau échouée,

- d’un GRUB corrompu,

- d’une modification accidentelle de `/etc/fstab`,

- ou d’un disque endommagé.

La bonne pratique consiste à **sauvegarder régulièrement** les éléments essentiels du boot et du système.

### Objectifs pédagogiques

- Identifier les fichiers et dossiers critiques à sauvegarder.

- Automatiser leur sauvegarde avec un script.

- Tester la restauration à partir d’un Live Debian.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1 – Pré-requis

- Machine Debian 13 avec accès root (`sudo`).

- Un disque externe ou une clé USB montée sur `/mnt/backup`.

- Le paquet `rsync` installé.

### 2.2 – Création du répertoire de destination

```bash
sudo mkdir -p /mnt/backup/system_backup_$(date +%F)
```

🗨️ **Bulle explicative**  
Crée un répertoire daté sur le support externe pour y stocker les fichiers du jour.  
Cela permet de conserver plusieurs versions successives.

---

## 🧩 3. Identification des fichiers / répertoires critiques

| Catégorie             | Emplacement                                   | Contenu principal                     | Utilité                  |
| --------------------- | --------------------------------------------- | ------------------------------------- | ------------------------ |
| MBR                   | `/dev/sda` (secteur 0)                        | Chargeur de premier niveau            | Amorce le système        |
| GRUB                  | `/boot/grub/`                                 | Fichiers et configuration du chargeur | Gère les entrées de boot |
| Kernel                | `/boot/vmlinuz-*` + `/boot/initrd.img-*`      | Noyaux et images initramfs            | Démarrage Linux          |
| systemd               | `/etc/systemd/` + `/lib/systemd/system/`      | Units et cibles                       | Gestion des services     |
| fstab + boot          | `/etc/fstab`, `/etc/default/grub`             | Points de montage et config GRUB      | Liens système–disques    |
| Config réseau + users | `/etc/network/`, `/etc/passwd`, `/etc/shadow` | Réseau et utilisateurs                | Accès et identité        |

---

## 💾 4. Script de sauvegarde complet

Créer le fichier **/usr/local/bin/system_backup.sh** :

```bash
#!/usr/bin/env bash
# Script de sauvegarde préventive des fichiers critiques du système Debian
# Auteur : Atelier DevOps Debian
# Usage : sudo bash /usr/local/bin/system_backup.sh

set -euo pipefail

# Répertoire cible
BACKUP_DIR="/mnt/backup/system_backup_$(date +%F)"
mkdir -p "$BACKUP_DIR"

echo "---- Sauvegarde MBR ----"
# Copie du premier secteur du disque (512 octets)
sudo dd if=/dev/sda of="$BACKUP_DIR/mbr_backup.img" bs=512 count=1

echo "---- Sauvegarde des fichiers critiques ----"
sudo rsync -aAXv \
  /boot/ \
  /etc/fstab \
  /etc/default/grub \
  /etc/systemd/ \
  /lib/systemd/ \
  /etc/network/ \
  /etc/passwd \
  /etc/shadow \
  /etc/group \
  "$BACKUP_DIR/"

echo "---- Vérification du contenu ----"
ls -lh "$BACKUP_DIR"

echo "Sauvegarde terminée avec succès."
```

🗨️ **Bulle explicative**

- `dd if=/dev/sda of=mbr_backup.img` : copie binaire du MBR.

- `rsync -aAXv` : archive complète avec attributs et permissions.

- Les fichiers utilisateurs, boot et systemd sont inclus pour un recouvrement complet.

---

## 🧰 5. Vérification du backup

```bash
sudo du -sh /mnt/backup/system_backup_$(date +%F)
sudo ls -l /mnt/backup/system_backup_$(date +%F)/boot
```

🗨️ **Bulle explicative**  
Permet de vérifier la taille et la présence des fichiers principaux (`vmlinuz-*`, `initrd.img-*`, `grub.cfg`, etc.).

---

## ⚠️ 6. Simulation : corruption et restauration

### 6.1 – Simulation (VM de test uniquement)

```bash
sudo mv /boot/grub /boot/grub.old
sudo reboot
```

🗨️ **Bulle explicative**  
Simule un GRUB supprimé pour tester la restauration manuelle.

---

### 6.2 – Restauration depuis un Live Debian

#### Étape 1 – Monter la partition racine

```bash
sudo mount /dev/sda1 /mnt
sudo mount /dev/sda2 /mnt/boot
```

#### Étape 2 – Monter la sauvegarde externe

```bash
sudo mount /dev/sdb1 /mnt/backup
```

#### Étape 3 – Copier les fichiers de sauvegarde

```bash
sudo rsync -aAXv /mnt/backup/system_backup_2025-10-21/boot/ /mnt/boot/
sudo rsync -aAXv /mnt/backup/system_backup_2025-10-21/etc/ /mnt/etc/
```

🗨️ **Bulle explicative**  
Cette opération restaure les fichiers `boot` et `etc` depuis la sauvegarde datée.

---

#### Étape 4 – Restauration du MBR

```bash
sudo dd if=/mnt/backup/system_backup_2025-10-21/mbr_backup.img of=/dev/sda bs=512 count=1
```

🗨️ **Bulle explicative**  
Réécrit le MBR initial du disque.  
⚠️ À exécuter uniquement si le MBR d’origine est réellement perdu ou corrompu.

---

#### Étape 5 – Régénération de GRUB et initramfs

```bash
sudo chroot /mnt
update-grub
update-initramfs -u -k all
exit
```

🗨️ **Bulle explicative**  
Recrée la configuration GRUB et les images de démarrage pour s’assurer que tout correspond aux fichiers restaurés.

---

## 🔍 7. Vérification post-restauration

```bash
sudo reboot
systemctl status
ls /boot
```

🗨️ **Bulle explicative**  
Le système doit redémarrer normalement avec le GRUB et les noyaux restaurés.

---

## 🧹 8. Nettoyage et rotation des backups

Créer le fichier **/usr/local/bin/cleanup_backups.sh** :

```bash
#!/usr/bin/env bash
# Supprime les sauvegardes de plus de 14 jours

find /mnt/backup/system_backup_* -maxdepth 0 -mtime +14 -exec rm -rf {} \;
```

🗨️ **Bulle explicative**  
Permet de garder les sauvegardes récentes seulement et d’éviter la saturation du support externe.

---

## 💡 9. Astuces & bonnes pratiques

| Risque                       | Prévention                           | Outil                |
| ---------------------------- | ------------------------------------ | -------------------- |
| MBR corrompu                 | Sauvegarder le secteur 0 (`dd`)      | `dd`, `grub-install` |
| GRUB effacé                  | Sauvegarde de `/boot/grub`           | `rsync`              |
| Noyau supprimé               | Sauvegarde de `/boot/vmlinuz-*`      | `rsync`              |
| Mauvais `fstab`              | Sauvegarde régulière de `/etc/fstab` | `rsync`              |
| Blocage systemd              | Sauvegarde de `/etc/systemd/`        | `rsync`              |
| Fichiers utilisateurs perdus | Inclure `/etc/passwd`, `/etc/shadow` | `rsync`              |

---

## ✅ Résumé de l’atelier

- Création d’une **stratégie de sauvegarde préventive** basée sur `rsync` et `dd`.

- Sauvegarde automatisée du **MBR, GRUB, kernel, systemd, fstab, comptes, réseau**.

- Simulation de corruption et **récupération complète** depuis une machine Live.

- Introduction à la **rotation automatique des backups** pour la maintenance préventive.
