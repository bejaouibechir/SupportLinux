# 🧠 Atelier 5 – Analyse et dépannage du chargeur `initramfs`

**Niveau 1 – Amorçage & bases du boot (Debian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Lorsque GRUB charge le noyau Linux, il charge également une **image compressée** appelée `initramfs` (souvent nommée `/boot/initrd.img-<version>`).  
Cette image contient :

- Les modules essentiels (drivers disque, RAID, LVM, etc.)

- Les outils pour monter la partition racine réelle `/`

- Le script d’initialisation `/init`

Objectifs pédagogiques :

- Comprendre le rôle et la structure de l’initramfs.

- Explorer son contenu.

- Diagnostiquer une erreur “initramfs shell” au démarrage.

- Régénérer l’initramfs pour réparer un système Debian non bootable.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1 – Téléchargement du Live Debian 13

📥 Image officielle (Live GNOME, 64-bit) :  
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

---

### 2.2 – Script de préparation rapide

Créer le fichier **prepare_live_initramfs.sh** :

```bash
#!/usr/bin/env bash
# Configuration de l’environnement Live pour l’analyse d’un initramfs

set -euo pipefail

echo "---- Configuration du clavier français ----"
sudo localectl set-keymap fr
sudo localectl set-x11-keymap fr

echo "---- Installation des outils nécessaires ----"
sudo apt update
sudo apt install -y vim gzip cpio file binwalk lz4 lzop dracut initramfs-tools
```

🗨️ **Bulle explicative**  
Ce script prépare l’environnement Live :

- `initramfs-tools` et `dracut` : outils de génération / analyse.

- `binwalk`, `gzip`, `cpio`, `lz4` : nécessaires pour décompresser et inspecter une image `initrd`.

---

## 🧩 3. Structure et fonctionnement de `initramfs`

### 3.1 – Fichiers concernés dans `/boot`

```bash
ls -lh /boot | grep initrd
```

🗨️ **Bulle explicative**  
Affiche toutes les images `initrd.img-<version>` présentes.  
Chaque version correspond à un noyau installé.

---

### 3.2 – Vérification du lien avec GRUB

```bash
grep initrd /boot/grub/grub.cfg | head -n 5
```

🗨️ **Bulle explicative**  
Cette commande montre comment GRUB charge l’image `initrd` associée à un noyau.  
Par exemple :

```
initrd /boot/initrd.img-6.8.0-4-amd64
```

---

### 3.3 – Comprendre la séquence

Lors du démarrage :

1. GRUB charge le **noyau** (`vmlinuz-*`) et l’**initrd** (`initrd.img-*`).

2. Le **kernel** monte l’initramfs en mémoire (RAM disk).

3. Le script `/init` de l’initramfs :
   
   - Charge les modules nécessaires (drivers disque, RAID, LVM, etc.)
   
   - Monte `/` réel (depuis `/etc/fstab` ou UUID)
   
   - Transfère le contrôle à `systemd`

---

## 🔍 4. Exploration du contenu d’un initramfs

### 4.1 – Créer un répertoire temporaire

```bash
mkdir /tmp/initramfs && cd /tmp/initramfs
```

---

### 4.2 – Copier et décompresser une image

```bash
cp /boot/initrd.img-$(uname -r) /tmp/initramfs/
cd /tmp/initramfs
mkdir extracted && cd extracted
zcat ../initrd.img-$(uname -r) | cpio -idmv
```

🗨️ **Bulle explicative**

- `zcat` : décompresse le flux gzip.

- `cpio -idmv` : extrait les fichiers contenus.  
  Le répertoire `extracted/` contient désormais toute l’arborescence initiale montée par le noyau.

---

### 4.3 – Explorer la structure extraite

```bash
ls -R | head -n 20
```

🗨️ **Bulle explicative**  
Vous y trouverez :

- `/init` → script principal exécuté par le noyau.

- `/scripts/` → modules de montage (lvm, mdadm, fsck).

- `/conf/` → configuration du root device et options du kernel.

---

### 4.4 – Examiner le script principal `/init`

```bash
less init
```

🗨️ **Bulle explicative**  
Ce script détecte le périphérique racine (`root=` du noyau) et tente de le monter.  
Si le montage échoue → shell `busybox` (prompt `(initramfs)`).

---

## ⚠️ 5. Simulation et diagnostic d’une erreur “initramfs shell”

### 5.1 – Simulation d’un périphérique racine invalide

```bash
sudo cp /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
sudo sed -i 's/root=UUID=[^ ]*/root=UUID=fake-uuid/' /boot/grub/grub.cfg
```

🗨️ **Bulle explicative**  
Cette commande falsifie l’UUID racine.  
Au redémarrage, le système échouera à trouver la partition racine et vous amènera à une invite `(initramfs)`.

---

### 5.2 – Diagnostic depuis le shell initramfs

> Sur la console `(initramfs)` :

```bash
ls /dev
blkid
cat /proc/cmdline
```

🗨️ **Bulle explicative**

- `ls /dev` montre les périphériques détectés.

- `blkid` permet de vérifier les vrais UUID.

- `cat /proc/cmdline` affiche les paramètres du noyau (dont le mauvais UUID).

---

## 🧰 6. Réparation via un environnement Live

### 6.1 – Monter et chrooter

```bash
sudo mount /dev/sda1 /mnt
sudo mount --bind /dev /mnt/dev
sudo mount --bind /proc /mnt/proc
sudo mount --bind /sys /mnt/sys
sudo chroot /mnt
```

🗨️ **Bulle explicative**  
On accède au système installé pour le réparer.

---

### 6.2 – Régénérer l’initramfs

```bash
update-initramfs -u -k all
```

🗨️ **Bulle explicative**  
Reconstruit toutes les images `initrd.img-*` présentes.  
Option `-u` = mise à jour, `-k all` = toutes les versions de noyau.

---

### 6.3 – Vérifier le contenu et la date

```bash
ls -lh /boot/initrd.img*
```

🗨️ **Bulle explicative**  
Vérifie que l’image a bien été reconstruite récemment.

---

### 6.4 – Regénérer le menu GRUB

```bash
update-grub
exit
sudo reboot
```

🗨️ **Bulle explicative**  
Met à jour GRUB pour s’assurer que le chemin de l’image initramfs est correct.  
Le système doit à présent démarrer normalement.

---

## 🧹 7. Nettoyage / rollback

```bash
sudo mv /boot/grub/grub.cfg.bak /boot/grub/grub.cfg
sudo rm -rf /tmp/initramfs
```

🗨️ **Bulle explicative**  
Restaure la configuration GRUB et supprime le répertoire temporaire utilisé pour l’extraction.

---

## 💡 8. Astuces & Pièges fréquents

| Problème                         | Cause probable                  | Solution                         |
| -------------------------------- | ------------------------------- | -------------------------------- |
| Invite `(initramfs)` au boot     | Périphérique racine introuvable | Vérifier `root=` dans GRUB       |
| Modules manquants dans initramfs | Drivers non inclus              | `update-initramfs -u`            |
| `gzip: invalid magic`            | Image corrompue                 | Supprimer et regénérer initrd    |
| Boot très lent                   | Initramfs trop volumineux       | Nettoyer `/lib/modules/` anciens |

---

## ✅ Résumé de l’atelier

- Compréhension complète du rôle et du contenu de l’initramfs.

- Exploration manuelle de l’image initrd.

- Simulation d’une erreur “initramfs shell”.

- Régénération et réparation complète de l’image via `update-initramfs`.
