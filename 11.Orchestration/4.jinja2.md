# Jinja2

# Exercice 1 ‚Äî Premi√®re interpolation avec `{{ var }}`

## Contexte

On veut g√©n√©rer un fichier `/tmp/welcome.txt` qui dit ‚ÄúBienvenue sur <nom_h√¥te>‚Äù.

## Objectif

D√©couvrir la **base de Jinja2** : afficher une variable dans un template.

## O√π sont d√©finies les variables ?

Dans `group_vars/all.yml` :

```
project/
 ‚îú‚îÄ group_vars/
 ‚îÇ   ‚îî‚îÄ all.yml
 ‚îú‚îÄ templates/
 ‚îÇ   ‚îî‚îÄ welcome.j2
 ‚îî‚îÄ ex01_template.yml
```

**Contenu `group_vars/all.yml`**

```yaml
welcome_msg: "Bienvenue sur"
```

**Contenu du template `templates/welcome.j2`**

```
{{ welcome_msg }} {{ inventory_hostname }}
```

## Playbook principal ‚Äî `ex01_template.yml`

```yaml
---
- name: Basic Jinja2 template example
  hosts: all
  gather_facts: false
  tasks:
    - name: Render welcome message
      template:                           # module template
        src: templates/welcome.j2         # fichier source .j2
        dest: /tmp/welcome.txt            # fichier g√©n√©r√©
```

## Playbook de nettoyage ‚Äî `ex01_cleanup.yml`

```yaml
---
- name: Cleanup ex01
  hosts: all
  tasks:
    - file:
        path: /tmp/welcome.txt
        state: absent
```

## Commandes

```bash
ansible-playbook ex01_template.yml -i /etc/ansible/hosts
ansible-playbook ex01_cleanup.yml -i /etc/ansible/hosts
```

## V√©rification

```bash
ansible all -m command -a "cat /tmp/welcome.txt"
```

## Lecture pas-√†-pas

1. Ansible lit `group_vars/all.yml` ‚Üí charge `welcome_msg`.

2. Le template `welcome.j2` remplace `{{ welcome_msg }}` et `{{ inventory_hostname }}`.

3. R√©sultat √©crit dans `/tmp/welcome.txt`.

## Astuces & pi√®ges

- V√©rifiez toujours que le fichier `.j2` est bien dans `templates/`.

- Attention aux espaces : `{{ var }}` n‚Äôest pas `{{var}}` ‚Üí √ßa marche, mais l‚Äôespace rend le code lisible.

---

# üü¢ Exercice 2 ‚Äî Filtres Jinja2

## Contexte

On veut g√©n√©rer une liste d‚Äôutilisateurs en majuscules.

## Objectif

Utiliser des **filtres Jinja2** (`upper`, `join`).

## O√π ?

```
project/
 ‚îú‚îÄ group_vars/
 ‚îÇ   ‚îî‚îÄ all.yml
 ‚îú‚îÄ templates/
 ‚îÇ   ‚îî‚îÄ users.j2
 ‚îî‚îÄ ex02_template.yml
```

**Contenu `group_vars/all.yml`**

```yaml
users:
  - alice
  - bob
  - charlie
```

**Contenu `templates/users.j2`**

```
Liste des utilisateurs :
{% for user in users %}
- {{ user | upper }}
{% endfor %}

En ligne : {{ users | join(', ') }}
```

## Playbook ‚Äî `ex02_template.yml`

```yaml
---
- name: Template with filters
  hosts: all
  gather_facts: false
  tasks:
    - name: Render user list
      template:
        src: templates/users.j2
        dest: /tmp/users.txt
```

## Cleanup ‚Äî `ex02_cleanup.yml`

```yaml
---
- name: Cleanup ex02
  hosts: all
  tasks:
    - file:
        path: /tmp/users.txt
        state: absent
```

## V√©rification

```bash
ansible all -m command -a "cat /tmp/users.txt"
```

## Lecture pas-√†-pas

1. La boucle `for` parcourt `users`.

2. Chaque nom est mis en majuscules avec `| upper`.

3. Ensuite on affiche la m√™me liste en une ligne avec `| join(', ')`.

## Astuces & pi√®ges

- `| default('valeur')` est tr√®s utile pour √©viter les erreurs si une variable manque.

- Pensez aux filtres comme **mini-fonctions de transformation**.

---

# üü¢ Exercice 3 ‚Äî Conditions `if/else`

## Contexte

On veut g√©n√©rer un fichier de configuration qui change selon l‚Äôenvironnement (dev/prod).

## Objectif

D√©couvrir les blocs conditionnels `{% if %} ... {% else %}`.

## O√π ?

```
group_vars/
 ‚îî‚îÄ all.yml
templates/
 ‚îî‚îÄ config.j2
```

**Contenu `group_vars/all.yml`**

```yaml
env: dev
```

**Contenu `templates/config.j2`**

```
# Configuration pour l'environnement
{% if env == "prod" %}
mode=performance
debug=false
{% else %}
mode=debug
debug=true
{% endif %}
```

## Playbook ‚Äî `ex03_template.yml`

```yaml
---
- name: Template with conditions
  hosts: all
  gather_facts: false
  tasks:
    - name: Render config based on env
      template:
        src: templates/config.j2
        dest: /tmp/config.cfg
```

## Cleanup ‚Äî `ex03_cleanup.yml`

```yaml
---
- name: Cleanup ex03
  hosts: all
  tasks:
    - file:
        path: /tmp/config.cfg
        state: absent
```

## V√©rification

```bash
ansible all -m command -a "cat /tmp/config.cfg"
```

## Lecture pas-√†-pas

- Si `env=prod`, le fichier contient `mode=performance`.

- Sinon (`dev`), le fichier est en mode debug.

## Astuces & pi√®ges

- V√©rifiez bien vos comparaisons : `==` et non `=`.

- √âvitez de m√©langer la logique m√©tier **trop complexe** dans les templates.

---

# üü¢ Exercice 4 ‚Äî Boucles sur dictionnaire

## Contexte

Vous devez g√©n√©rer une configuration d‚ÄôIP par interface.

## Objectif

Parcourir un dictionnaire dans un template.

## O√π ?

```
group_vars/
 ‚îî‚îÄ all.yml
templates/
 ‚îî‚îÄ network.j2
```

**Contenu `group_vars/all.yml`**

```yaml
interfaces:
  eth0: 192.168.1.10
  eth1: 10.0.0.5
```

**Contenu `templates/network.j2`**

```
# Network configuration
{% for iface, ip in interfaces.items() %}
{{ iface }} -> {{ ip }}
{% endfor %}
```

## Playbook ‚Äî `ex04_template.yml`

```yaml
---
- name: Template with dictionary loop
  hosts: all
  gather_facts: false
  tasks:
    - name: Render network config
      template:
        src: templates/network.j2
        dest: /tmp/network.txt
```

## Cleanup ‚Äî `ex04_cleanup.yml`

```yaml
---
- name: Cleanup ex04
  hosts: all
  tasks:
    - file:
        path: /tmp/network.txt
        state: absent
```

## V√©rification

```bash
ansible all -m command -a "cat /tmp/network.txt"
```

## Lecture pas-√†-pas

1. On parcourt le dictionnaire `interfaces`.

2. √Ä chaque tour, on r√©cup√®re `iface` et `ip`.

3. R√©sultat : chaque ligne associe interface ‚Üí IP.

## Astuces & pi√®ges

- `.items()` est obligatoire pour it√©rer sur un dictionnaire.

- Attention : l‚Äôordre peut varier ‚Üí utilisez `| dictsort` si n√©cessaire.

---

# üü¢ Exercice 5 ‚Äî Template avec `with_items` et inclusion

## Contexte

Vous devez g√©n√©rer un fichier `motd` qui liste plusieurs messages.

## Objectif

Utiliser un template avec une **liste pass√©e par une boucle**.

## O√π ?

```
group_vars/
 ‚îî‚îÄ all.yml
templates/
 ‚îî‚îÄ motd.j2
```

**Contenu `group_vars/all.yml`**

```yaml
messages:
  - "Syst√®me g√©r√© par Ansible"
  - "Acc√®s r√©serv√©"
  - "Surveillez vos logs"
```

**Contenu `templates/motd.j2`**

```
*** Message of the Day ***
{% for msg in messages %}
- {{ msg }}
{% endfor %}
```

## Playbook ‚Äî `ex05_template.yml`

```yaml
---
- name: MOTD with loop
  hosts: all
  gather_facts: false
  tasks:
    - name: Render motd from list
      template:
        src: templates/motd.j2
        dest: /tmp/motd
```

## Cleanup ‚Äî `ex05_cleanup.yml`

```yaml
---
- name: Cleanup ex05
  hosts: all
  tasks:
    - file:
        path: /tmp/motd
        state: absent
```

## V√©rification

```bash
ansible all -m command -a "cat /tmp/motd"
```

## Lecture pas-√†-pas

- On parcourt la liste `messages`.

- Chaque message est affich√© sous forme de puce.

## Astuces & pi√®ges

- Tr√®s pratique pour **messages d‚Äôaccueil**, **listes d‚Äôalertes**, etc.

- Si vous voulez injecter depuis la ligne de commande :
  
  ```bash
  ansible-playbook ex05_template.yml -e 'messages=["Hello","World"]'
  ```


