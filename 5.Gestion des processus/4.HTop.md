

--

# OPTIONS AU LANCEMENT

---

## OPTION `htop -u utilisateur` — Filtrer par utilisateur

### 1) Script

**Titre** : `cpu_stress_labuser.py`  
**Intro** : même que pour `top`, charge CPU légère sous l’utilisateur `labuser`.

```python
# cpu_stress_labuser.py
import time, math
end = time.time() + 60
while time.time() < end:
    _ = math.sqrt(12345.6789)
    time.sleep(0.001)
```

### Préparation

```bash
sudo adduser --disabled-password --gecos "" labuser
sudo -u labuser python3 cpu_stress_labuser.py &
echo $! > labuser_cpu.pid
```

### 2) Scénarios htop

- **Scénario A** : voir uniquement les processus de labuser
  
  ```bash
  htop -u labuser
  ```
  
  **À observer** : liste restreinte aux PIDs de `labuser`.

- **Scénario B** : lancer en parallèle un `sleep 200` en root et vérifier qu’il **n’apparaît pas** dans ce filtre.

### 3) Conseils / Astuces / Pièges

- **Expérience** : lance deux utilisateurs différents (`labuser` et `appuser`) avec la même charge → compare avec `htop -u labuser` et `htop -u appuser`.

- **Piège** : si tu lances `htop` sans `-u` mais filtres ensuite (F4), ce n’est pas équivalent → testable.

---

## OPTION `htop -s PERCENT_MEM` — Tri par mémoire

### 1) Script

**Titre** : `mem_stress2.py`  
**Intro** : alloue ~600 MB pour dominer le tri mémoire.

```python
# mem_stress2.py
import time
buf = bytearray(600 * 1024 * 1024)
time.sleep(60)
```

### Préparation

```bash
python3 mem_stress2.py &
echo $! > mem2.pid
```

### 2) Scénarios htop

- **Scénario A** : démarrage trié par mémoire
  
  ```bash
  htop -s PERCENT_MEM
  ```
  
  **À observer** : `mem_stress2.py` remonte en haut.

- **Scénario B** : relance avec `-s PERCENT_CPU` et compare le classement.

### 3) Conseils / Astuces / Pièges

- **Expérience** : lance en parallèle `mid_mem.py` (~400 MB). Compare leur ordre avec `htop -s PERCENT_MEM`.

- **Piège** : `%MEM` est relatif à la RAM totale. Teste sur une VM 1 GB vs une machine 16 GB → le pourcentage diffère mais la conso absolue (RES) reste.

---

## OPTION `htop -t` — Vue arborescente

### 1) Script

**Titre** : `tree_parent.sh`  
**Intro** : crée un process parent qui lance 3 enfants, parfait pour tester l’arborescence.

```bash
#!/usr/bin/env bash
# tree_parent.sh
for i in 1 2 3; do
  sleep 120 &
done
wait
```

### Préparation

```bash
chmod +x tree_parent.sh
./tree_parent.sh &
echo $! > tree_parent.pid
```

### 2) Scénarios htop

- **Scénario A** : démarrer directement en vue arborescente
  
  ```bash
  htop -t
  ```
  
  **À observer** : un process parent avec ses 3 enfants indentés.

- **Scénario B** : lancer sans `-t`, puis appuyer sur `F5` (raccourci vue arborescente) → même résultat.

### 3) Conseils / Astuces / Pièges

- **Expérience** : tue un des enfants (`kill <PID>`) → observe que seul lui disparaît, pas les autres.

- **Piège** : si un parent meurt, ses enfants deviennent orphelins → refais le test et vérifie qu’ils sont réassignés au PID 1 (systemd).

---

# RACCOURCIS CLAVIER

---

## Navigation & affichage

- **Flèches ↑↓** : déplace-toi entre processus.  
  **Expérience** : sélectionne `mem_stress2.py` puis descends jusqu’à un autre → observe la ligne mise en surbrillance.

- **Flèches ←→** : change de colonne active pour le tri.  
  **Expérience** : bascule de `%CPU` vers `%MEM` avec les flèches, observe l’ordre.

---

## F1 — Aide

- **Action** : appuie `F1`.  
  **À observer** : menu d’aide interne avec la liste des touches.

- **Expérience** : compare avec `man htop` → observe les différences.

---

## F2 — Setup

- **Action** : appuie `F2`.  
  **À observer** : menu config. Ajoute une colonne (ex. PPID).

- **Expérience** : sauvegarde avec **Esc** puis relance `htop`. La colonne ajoutée reste (cf. `~/.config/htop/htoprc`).

---

## F3 — Recherche

- **Action** : appuie `F3`, tape `python`.  
  **À observer** : htop saute sur le process `python3 mem_stress2.py`.

- **Expérience** : recherche `sleep` → trouve les sleepers lancés.

---

## F4 — Filtrer

- **Action** : appuie `F4`, tape `mem_stress`.  
  **À observer** : vue réduite aux process contenant ce mot.

- **Expérience** : efface le filtre avec `F4` vide → reviens à la vue complète.

---

## F5 — Vue arborescente

- **Action** : appuie `F5`.  
  **À observer** : indentation parent → enfants (`tree_parent.sh`).

- **Expérience** : alterne F5 / F5 pour basculer flat <-> tree.

---

## F6 — Tri par colonne

- **Action** : appuie `F6`, choisis `%MEM`.  
  **À observer** : tri change instantanément.

- **Expérience** : compare F6 `%CPU` vs `%MEM` avec `cpu_stress.py` + `mem_stress2.py` actifs.

---

## F7 / F8 — Ajuster la valeur nice

- **Action** : sélectionne `cpu_stress.py`, appuie `F7` pour diminuer nice (plus de priorité CPU), `F8` pour l’augmenter (moins de priorité).

- **Expérience** : ouvre un autre terminal, lance `ps -o pid,ni,comm -p $(cat cpu.pid)` → observe le nice changer.

---

## F9 — Tuer un processus

- **Action** : sélectionne `sleeper.sh`, appuie `F9`. Choisis `TERM`.  
  **À observer** : process disparaît.

- **Expérience** : retente avec `KILL` si TERM échoue → observe la différence.

---

## Espace — Sélection multiple

- **Action** : sélectionne `cpu_stress.py`, appuie `Espace`, puis `mem_stress2.py` et `Espace`.  
  **À observer** : deux lignes marquées.

- **Expérience** : appuie `F9` → htop propose de tuer tous les sélectionnés.

---

## Esc — Sauvegarde config

- **Action** : après changement (ex. ajout de colonnes via F2), appuie `Esc`.  
  **À observer** : fichier `~/.config/htop/htoprc` mis à jour.

- **Expérience** : relance `htop` → la config personnalisée persiste.

---

# Nettoyage après tests

```bash
pkill -f cpu_stress_labuser.py 2>/dev/null || true
pkill -f cpu_stress.py 2>/dev/null || true
pkill -f mem_stress2.py 2>/dev/null || true
pkill -f mid_mem.py 2>/dev/null || true
pkill -f sleeper.sh 2>/dev/null || true
pkill -f tree_parent.sh 2>/dev/null || true
[ -f labuser_cpu.pid ] && kill "$(cat labuser_cpu.pid)" 2>/dev/null || true
[ -f mem2.pid ] && kill "$(cat mem2.pid)" 2>/dev/null || true
[ -f cpu.pid ] && kill "$(cat cpu.pid)" 2>/dev/null || true
[ -f tree_parent.pid ] && kill "$(cat tree_parent.pid)" 2>/dev/null || true
rm -f *.pid bigfile.dat
sudo deluser --remove-home labuser 2>/dev/null || true
```

---


