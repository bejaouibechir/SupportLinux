# **TP Complet et Autonome : Maîtriser `sudoers` sous Linux**

## **Objectifs pédagogiques**

À la fin de cet atelier, les participants sauront :

* Ajouter des utilisateurs sudoers.
* Comprendre et manipuler la syntaxe **`ALL=(ALL:ALL) NOPASSWD:ALL`**.
* Restreindre les droits **par commande**, **par utilisateur cible**, **par groupe cible** et **par hôte**.
* Vérifier concrètement les permissions avec `sudo`.

---

## **Contexte**

Nous allons créer **trois utilisateurs** :

* **alice** → sudoer complet (tous les droits, pas de mot de passe).
* **bob** → sudoer limité à certaines commandes simples.
* **charlie** → sudoer avec des commandes demandant ou non le mot de passe.

---

## **Étape 1 — Préparer l’environnement**

### 1.1. Créer les utilisateurs

```bash
sudo adduser alice
sudo adduser bob
sudo adduser charlie
```

Attribue des mots de passe simples pour tester.

---

### 1.2. Vérifier qu’ils ne sont pas sudoers par défaut

```bash
su - bob
sudo ls /root
```

Résultat attendu :

```
bob is not in the sudoers file. This incident will be reported.
```

 C’est normal.

---

## \*\*Étape 2 — Comprendre la syntaxe `sudoers`

Ouvrir le fichier :

```bash
sudo visudo
```

Exemple par défaut :

```
root    ALL=(ALL:ALL) ALL
```

**Décodage pédagogique :**

| Élément         | Rôle                                                              |
| --------------- | ----------------------------------------------------------------- |
| **1er ALL**     | Depuis **quelle machine** l’utilisateur peut exécuter la commande |
| **(ALL\:ALL)**  | Avec quel **utilisateur cible** et **groupe cible**               |
| **Dernier ALL** | Quelles **commandes** sont autorisées                             |
| **NOPASSWD**    | Évite de demander un mot de passe pour ces commandes              |

---

## **Étape 3 — Démo 1 : Sudoer complet (alice)**

### **Contexte**

Donner **tous les droits** à `alice` **sans mot de passe**.

### **Manipulation**

Dans `visudo` :

```
alice   ALL=(ALL:ALL) NOPASSWD:ALL
```

### **Test**

```bash
su - alice
sudo whoami
```

Résultat attendu :

```
root
```

Aucun mot de passe demandé .

---

## **Étape 4 — Démo 2 : Restreindre à quelques commandes simples (bob)**

### **Contexte**

Donner à `bob` le droit de :

* Lire les fichiers système (`/etc/passwd` et `/etc/shadow`),
* Voir les processus (`ps aux`),
* Mais **pas** d'autres commandes.

### **Manipulation**

Dans `visudo` :

```
bob   ALL=(ALL:ALL) /bin/cat /etc/passwd, /bin/ps aux
```

### **Tests**

```bash
su - bob
sudo cat /etc/passwd    #  fonctionne
sudo ps aux             #  fonctionne
sudo cat /etc/shadow    #  Permission denied
```

**Analyse pédagogique**
→ Démonstration immédiate et claire des **commandes autorisées vs interdites**.

---

## **Étape 5 — Démo 3 : Mélanger PASSWD et NOPASSWD (charlie)**

### **Contexte**

`charlie` doit :

* Pouvoir afficher la date sans mot de passe,
* Mais devoir entrer son mot de passe pour voir le contenu de `/etc/shadow`.

### **Manipulation**

Dans `visudo` :

```
charlie ALL=(ALL:ALL) NOPASSWD:/bin/date, PASSWD:/bin/cat /etc/shadow
```

### **Tests**

```bash
su - charlie
sudo date                #  pas de mot de passe
sudo cat /etc/shadow     #  mot de passe demandé
```

---

## **Étape 6 — Démo 4 : Restreindre à un utilisateur cible**

### **Contexte**

`bob` doit pouvoir **exécuter `ls` comme root** mais rien d’autre.

### **Manipulation**

Dans `visudo` :

```
bob ALL=(root:ALL) /bin/ls
```

### **Test**

```bash
su - bob
sudo -u root ls /root    #  fonctionne
sudo ls /root            #  aussi
sudo whoami              #  Permission denied
```

---

## **Étape 7 — Démo 5 : Restreindre à un groupe cible**

### **Contexte**

`charlie` peut lancer `id` **uniquement sous le groupe `adm`**.

### **Manipulation**

Dans `visudo` :

```
charlie ALL=(ALL:adm) /usr/bin/id
```

### **Test**

```bash
su - charlie
sudo -g adm id
```

Résultat attendu :

```
uid=1002(charlie) gid=4(adm) groups=4(adm)
```

---

## **Étape 8 — Démo 6 : Restreindre par hôte (scénario concret)**

### **Contexte**

Deux serveurs EC2 : **host1** et **host2**.
On veut que `alice` ait tous les droits **uniquement sur host1**.

### **Manipulation**

1. Configurer le hostname :

   ```bash
   sudo hostnamectl set-hostname host1   # sur machine 1
   sudo hostnamectl set-hostname host2   # sur machine 2
   ```
2. Dans `visudo` :

   ```
   alice host1=(ALL:ALL) NOPASSWD:ALL
   ```

### **Tests**

* **Sur host1** :

```bash
su - alice
sudo whoami    #  root
```

* **Sur host2** :

```bash
su - alice
sudo whoami    #  Permission denied
```

---

## **Étape 9 — Vérifier les droits d’un sudoer**

Lister les permissions autorisées pour chaque utilisateur :

```bash
sudo -l -U alice
sudo -l -U bob
sudo -l -U charlie
```

Résultat attendu → affiche exactement les commandes autorisées.

---

## **Exercice final pour les participants**

**Objectif :** Créer un utilisateur `dev` qui :

1. Peut **lister** les fichiers dans `/var/log` **sans mot de passe**.
2. Peut **afficher** `/etc/shadow` mais **avec mot de passe**.
3. Ne peut **rien faire d’autre**.

**Vérification :**

```bash
sudo -l -U dev
sudo ls /var/log       #  pas de mot de passe
sudo cat /etc/shadow   #  demande mot de passe
sudo reboot            #  Permission denied
```

---

# **Résumé visuel de la syntaxe sudoers**

```
utilisateur  HÔTES = (UTILISATEURS_CIBLES:GROUPE_CIBLE)  COMMANDE [, COMMANDE]
```

* **HÔTES** → sur quelle(s) machine(s) la règle s’applique.
* **UTILISATEURS\_CIBLES** → exécuter en tant que qui.
* **GROUPE\_CIBLE** → exécuter sous quel groupe.
* **COMMANDES** → limiter ou ouvrir totalement les privilèges.

---

## **Points forts de ce TP**

* **100 % autonome** → aucune installation de service.
* **Exemples concrets** → on manipule des commandes système déjà présentes.
* **Vérification immédiate** → chaque démo est testée en live.
* **Progression pédagogique** → de sudoer complet → sudoer restreint → sudoer personnalisé.


