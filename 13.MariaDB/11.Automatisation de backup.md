

# Automatiser les backups et la maintenance

## But de l’atelier

Apprendre à :

1. Automatiser les sauvegardes MariaDB avec **cron** (méthode classique).

2. Automatiser la même tâche avec un **service et un timer systemd** (méthode moderne).

3. Comprendre avantages et limites des deux approches.

---

## Étapes de l’atelier

### Partie 1 — Cron

1. Préparer un script de sauvegarde MariaDB.

2. Créer une tâche cron quotidienne.

3. Vérifier l’exécution et les logs.

### Partie 2 — Service + Timer systemd

4. Créer une unité systemd de type `oneshot` pour lancer la sauvegarde.

5. Créer un timer associé.

6. Vérifier que le timer déclenche bien le service.

---

## Démarches (commandes commentées)

### Partie 1 — Automatisation avec cron

#### 1. Script de sauvegarde

Créer le script :

```bash
sudo nano /usr/local/sbin/mariadb-backup.sh
```

Contenu :

```bash
#!/usr/bin/env bash
set -euo pipefail

BACKUP_DIR="/var/backups/mariadb"
STAMP=$(date +%F_%H-%M-%S)
mkdir -p "$BACKUP_DIR"

/usr/bin/mysqldump --all-databases > "$BACKUP_DIR/backup_$STAMP.sql"

echo "Backup terminé: $BACKUP_DIR/backup_$STAMP.sql"
```

Rendre exécutable :

```bash
sudo chmod 0755 /usr/local/sbin/mariadb-backup.sh
```

#### 2. Créer la tâche cron

Éditer la crontab :

```bash
crontab -e
```

Ajouter la ligne suivante (sauvegarde quotidienne à 2h du matin) :

```
0 2 * * * /usr/local/sbin/mariadb-backup.sh >> /var/log/mariadb-backup.log 2>&1
```

#### 3. Vérifier l’exécution

Lister les tâches cron :

```bash
crontab -l
```

Consulter les logs après exécution :

```bash
tail -n 20 /var/log/mariadb-backup.log
```

---

### Partie 2 — Automatisation avec service + timer systemd

#### 4. Créer le service

Fichier unité :

```bash
sudo nano /etc/systemd/system/mariadb-backup.service
```

Contenu :

```ini
[Unit]
Description=Backup complet MariaDB
Requires=mariadb.service
After=mariadb.service

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/mariadb-backup.sh
User=root
```

#### 5. Créer le timer

Fichier unité :

```bash
sudo nano /etc/systemd/system/mariadb-backup.timer
```

Contenu :

```ini
[Unit]
Description=Timer backup MariaDB (quotidien)

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
```

Activer le timer :

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now mariadb-backup.timer
```

#### 6. Vérifier le fonctionnement

Lister les timers :

```bash
systemctl list-timers --all | grep mariadb-backup
```

Forcer un déclenchement manuel :

```bash
sudo systemctl start mariadb-backup.service
```

Vérifier les logs :

```bash
journalctl -u mariadb-backup.service -n 20 --no-pager
```

---

## Résultats attendus

- Avec **cron** : un fichier de sauvegarde apparaît chaque jour dans `/var/backups/mariadb/`, les sorties sont visibles dans `/var/log/mariadb-backup.log`.

- Avec **systemd service + timer** :
  
  - Le service peut être lancé manuellement ou par le timer.
  
  - Le timer apparaît dans `systemctl list-timers`.
  
  - Les logs sont accessibles via `journalctl`.

---

Très bien, nous restons dans le **chapitre Automatisation et intégration** et passons à l’**Atelier 22**.

---

# Vérification de santé automatique avec script Bash et notification par mail (Postfix)

## But de l’atelier

Apprendre à :

1. Écrire un script Bash qui teste la santé de MariaDB (ping et requête simple).

2. Intégrer une notification par mail en cas d’échec, via Postfix déjà installé.

3. Automatiser ce script avec **cron** ou un **timer systemd**.

Cet atelier illustre une supervision simple sans outil externe.

---

## Étapes de l’atelier

1. Préparer un script de healthcheck.

2. Tester le script manuellement.

3. Intégrer une alerte mail en cas d’erreur.

4. Automatiser l’exécution régulière avec cron.

5. (Optionnel) Automatiser avec systemd service + timer.

---

## Démarches (commandes commentées)

### 1. Script de healthcheck

Créer le fichier :

```bash
sudo nano /usr/local/sbin/mariadb-healthcheck.sh
```

Contenu :

```bash
#!/usr/bin/env bash
set -euo pipefail

STATUS_FILE="/var/tmp/mariadb-health.status"
LOG="/var/log/mariadb-health.log"
STAMP=$(date +%F_%T)

ok=true

# Test 1 : ping MariaDB
if mysqladmin ping --silent; then
  echo "$STAMP PING=OK" >> "$LOG"
else
  echo "$STAMP PING=KO" >> "$LOG"
  ok=false
fi

# Test 2 : requête simple
if mysql -e "SELECT 1;" >/dev/null 2>&1; then
  echo "$STAMP QUERY=OK" >> "$LOG"
else
  echo "$STAMP QUERY=KO" >> "$LOG"
  ok=false
fi

# Résultat global
if [ "$ok" = true ]; then
  echo "$STAMP STATUS=OK" > "$STATUS_FILE"
else
  echo "$STAMP STATUS=KO" > "$STATUS_FILE"
  exit 1
fi
```

Rendre exécutable :

```bash
sudo chmod 0755 /usr/local/sbin/mariadb-healthcheck.sh
```

---

### 2. Tester le script

```bash
/usr/local/sbin/mariadb-healthcheck.sh
cat /var/tmp/mariadb-health.status
tail -n 10 /var/log/mariadb-health.log
```

Résultat attendu : `STATUS=OK`.

---

### 3. Intégrer une notification mail

Modifier le script pour envoyer un mail si échec (ajouter en bas avant `exit 1`) :

```bash
# Si échec, notifier par mail
if [ "$ok" = false ]; then
  echo "MariaDB est en panne sur $(hostname) le $STAMP" \
  | mail -s "ALERTE: MariaDB KO" admin@example.com
  exit 1
fi
```

Vérification du mail :

- L’utilisateur reçoit un message avec sujet **"ALERTE: MariaDB KO"**.

---

### 4. Automatiser avec cron

Éditer la crontab :

```bash
crontab -e
```

Ajouter (exécution toutes les 5 minutes) :

```
*/5 * * * * /usr/local/sbin/mariadb-healthcheck.sh
```

Vérification :

```bash
tail -n 20 /var/log/mariadb-health.log
```

---

### 5. (Optionnel) Automatiser avec systemd

Créer le service :

```bash
sudo nano /etc/systemd/system/mariadb-health.service
```

Contenu :

```ini
[Unit]
Description=Vérification santé MariaDB
After=mariadb.service
Requires=mariadb.service

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/mariadb-healthcheck.sh
```

Créer le timer :

```bash
sudo nano /etc/systemd/system/mariadb-health.timer
```

Contenu :

```ini
[Unit]
Description=Timer healthcheck MariaDB

[Timer]
OnCalendar=*:0/5
Persistent=true

[Install]
WantedBy=timers.target
```

Activation :

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now mariadb-health.timer
```

Vérification :

```bash
systemctl list-timers --all | grep mariadb-health
```

---

## Résultats attendus

- Le script `mariadb-healthcheck.sh` produit un état dans `/var/tmp/mariadb-health.status` et un log détaillé.

- En cas de panne MariaDB, un mail est envoyé via Postfix.

- Le cron ou le timer systemd exécute automatiquement la vérification toutes les 5 minutes.

-
