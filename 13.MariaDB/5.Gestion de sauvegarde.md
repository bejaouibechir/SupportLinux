# Atelier  — Gestion de sauvegarde MariaDB : Approches pédagogiques progressives

#### **Scénario**

"Vous êtes administrateur de la base `gestion_stock`. Suite à une panne, vous devez mettre en place une procédure de sauvegarde fiable."

---

### **Démarche 1 : Préparation de l'environnement**

**Étape 1.1** - Ouvrez votre terminal et créez le répertoire pour les sauvegardes :

```
 sudo mkdir -p /var/backups/mariadb
```

**Étape 1.2** - Donnez-vous les droits d'accès à ce dossier :

```
 sudo chown $(whoami) /var/backups/mariadb
```

**Question** : Pourquoi est-il important de créer un dossier spécifique pour les sauvegardes ?
→ *Réfléchissez à l'organisation et à la sécurité des sauvegardes.*

---

### **Démarche 2 : Première sauvegarde complète**

**Étape 2.1** - Lancez votre première sauvegarde de toutes les bases :

```
 mysqldump --all-databases > /var/backups/mariadb/backup_full.sql
```

**Observation** : Regardez ce qui se passe :

- La commande s'exécute-t-elle rapidement ou lentement ?
- Y a-t-il des messages d'erreur ou de confirmation ?

**Étape 2.2** - Vérifiez que le fichier a bien été créé :

```
ls -lh /var/backups/mariadb/
```

**Question** : Quelle est la taille de votre fichier de sauvegarde ? Cela vous semble-t-il cohérent ?

---

### **Démarche 3 : Analyse du contenu de la sauvegarde**

**Étape 3.1** - Examinez le début du fichier de sauvegarde :

```
 head -n 20 /var/backups/mariadb/backup_full.sql
```

**À observer** :

- Reconnaissez-vous des commandes SQL ?
- Voyez-vous la mention de vos bases de données ?

**Étape 3.2** - Cherchez spécifiquement votre base `gestion_stock` :

```
 grep -n "gestion_stock" /var/backups/mariadb/backup_full.sql
```

**Question** : À quelle ligne apparaît votre base ? Que contient cette section ?

---

### **Démarche 4 : Simulation d'un incident**

**Étape 4.1** - Connectez-vous à MariaDB :

```
 mysql -u root -p
```

**Étape 4.2** - Dans l'invite MySQL, listez vos bases actuelles :

```
Commande MySQL : SHOW DATABASES;
```

Notez que `gestion_stock` est présente.

**Étape 4.3** - Simulez la perte accidentelle de la base :

```
Commande MySQL : DROP DATABASE gestion_stock;
```

**Étape 4.4** - Vérifiez que la base a bien disparu :

```
Commande MySQL : SHOW DATABASES;
```

**Réflexion** : Imaginez que ce soit un incident réel. Quelle serait la procédure à suivre ?

---

### **Démarche 5 : Restauration des données**

**Étape 5.1** - Quittez l'invite MySQL :

```
Commande MySQL : exit
```

**Étape 5.2** - Restaurez toutes les bases depuis votre sauvegarde :

```
 mysql < /var/backups/mariadb/backup_full.sql
```

**Observation** :

- Combien de temps prend la restauration ?
- Y a-t-il des messages d'erreur ?

**Étape 5.3** - Vérifiez que la restauration a fonctionné :

```
 mysql -e "SHOW DATABASES;"
```

**Étape 5.4** - Vérifiez spécifiquement votre base `gestion_stock` :

```
 mysql -e "USE gestion_stock; SELECT COUNT(*) FROM produits;"
```

---

### **Démarche 6 : Analyse critique**

**Questions de synthèse** :

1. **Avantages** : Quels sont les points forts de cette méthode `mysqldump` ?
   → *Écrivez 2-3 avantages que vous avez observés.*

2. **Limites** : Quels problèmes pourriez-vous rencontrer avec cette approche ?
   → *Pensez au temps d'exécution, à la taille des fichiers, aux bases en production.*

3. **Améliorations** : Comment pourriez-vous optimiser cette sauvegarde ?
   → *Proposez au moins une idée d'amélioration.*

---

## Sauvegarde sélective - Approche progressive**

 **Scénario :** Vous ne voulez sauvegarder qu'une base précise pour gagner du temps et de l'espace.



### **Démarche 1 : Création d'une base de test**

**Étape 1.1** - Connectez-vous à MariaDB :

```
mysql -u root -p
```

**Étape 1.2** - Créez une nouvelle base dédiée aux tests de sauvegarde :

```sql
CREATE DATABASE demo_backup;
USE demo_backup;
```

**Étape 1.3** - Créez une table simple avec quelques données :

```sql
CREATE TABLE clients (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100),
    email VARCHAR(100)
);

INSERT INTO clients (nom, email) VALUES
('Alice', 'alice@example.com'),
('Bob', 'bob@example.com');
```

**Vérification** :

```sql
SELECT * FROM clients;
```

---

### **Démarche 2 : Sauvegarde ciblée d'une seule base**

**Étape 2.1** - Quittez MariaDB et retournez au terminal.

**Étape 2.2** - Sauvegardez UNIQUEMENT la base `demo_backup` :

```
mysqldump demo_backup > /var/backups/mariadb/demo_backup.sql
```

**Étape 2.3** - Comparez les tailles des fichiers :

```
ls -lh /var/backups/mariadb/backup_full.sql
ls -lh /var/backups/mariadb/demo_backup.sql
```

**Question** : Quelle est la différence de taille ? Est-ce significatif ?

---

### **Démarche 3 : Test de restauration sélective**

**Étape 3.1** - Supprimez la base de test :

```
mysql -e "DROP DATABASE demo_backup;"
```

**Étape 3.2** - Vérifiez qu'elle a bien disparu :

```
mysql -e "SHOW DATABASES;" | grep demo_backup
```

**Étape 3.3** - Restaurez-la depuis votre sauvegarde ciblée :

```
mysql < /var/backups/mariadb/demo_backup.sql
```

**Étape 3.4** - Vérifiez la réussite de la restauration :

```
mysql -e "USE demo_backup; SHOW TABLES; SELECT * FROM clients;"
```

---

### **Démarche 4 : Sauvegarde encore plus ciblée - une seule table**

**Étape 4.1** - Sauvegardez uniquement la table `clients` :

```
mysqldump demo_backup clients > /var/backups/mariadb/clients_only.sql
```

**Étape 4.2** - Examinez la différence entre les deux fichiers :

```
head -n 10 /var/backups/mariadb/demo_backup.sql
head -n 10 /var/backups/mariadb/clients_only.sql
```

**Question** : Que remarquez-vous dans le fichier `clients_only.sql` ?

---

### **Démarche 5 : Exercice pratique guidé**

**Situation** : Imaginez que la table `clients` a été corrompue, mais pas le reste de la base.

**Consigne** : 

1. Supprimez seulement la table `clients`
2. Restaurez-la depuis `clients_only.sql`
3. Vérifiez que le reste de la base (s'il y avait d'autres tables) est intact

**À faire** :

```
# 1. Suppression
mysql -e "USE demo_backup; DROP TABLE clients;"

# 2. Vérification
mysql -e "USE demo_backup; SHOW TABLES;"

# 3. Restauration
mysql demo_backup < /var/backups/mariadb/clients_only.sql

# 4. Vérification finale
mysql -e "USE demo_backup; SHOW TABLES; SELECT * FROM clients;"
```



### Optimisation des sauvegardes - Approche progressive**

**Problématique :** "Vos sauvegardes prennent trop de place et vous souhaitez les sécuriser."

---

### **Démarche 1 : Compression simple**

**Étape 1.1** - Observez la taille actuelle de votre sauvegarde complète :

```
ls -lh /var/backups/mariadb/backup_full.sql
```

**Étape 1.2** - Compressez-la avec gzip :

```
gzip /var/backups/mariadb/backup_full.sql
```

**Étape 1.3** - Vérifiez le résultat :

```
ls -lh /var/backups/mariadb/backup_full.sql.gz
```

**Question** : Quel est le taux de compression ? (Taille originale / Taille compressée)

---

### **Démarche 2 : Décompression pour restauration**

**Étape 2.1** - Décompressez le fichier pour pouvoir le restaurer :

```
gunzip /var/backups/mariadb/backup_full.sql.gz
```

**Étape 2.2** - Vérifiez que le fichier est à nouveau lisible :

```
head -n 5 /var/backups/mariadb/backup_full.sql
```

**Étape 2.3** - Recompressez-le pour continuer :

```
gzip /var/backups/mariadb/backup_full.sql
```

---

### **Démarche 3 : Chiffrement de sécurité**

**Étape 3.1** - Chiffrez votre sauvegarde compressée :

```
gpg -c /var/backups/mariadb/backup_full.sql.gz
```

**À noter** : 

- On vous demande un mot de passe
- Choisissez un mot de passe simple pour le test (ex: "test123")
- Un nouveau fichier `.gpg` est créé

**Étape 3.2** - Supprimez la version non chiffrée pour plus de sécurité :

```
rm /var/backups/mariadb/backup_full.sql.gz
```

**Question** : Pourquoi supprimer la version non chiffrée ?

---

### **Démarche 4 : Restauration depuis une sauvegarde sécurisée**

**Situation** : Vous devez restaurer la base mais la sauvegarde est chiffrée.

**Étape 4.1** - Déchiffrez d'abord le fichier :

```
gpg /var/backups/mariadb/backup_full.sql.gz.gpg
```

**À noter** : Entrez le mot de passe que vous avez choisi.

**Étape 4.2** - Décompressez ensuite :

```
gunzip /var/backups/mariadb/backup_full.sql.gz
```

**Étape 4.3** - Restaurez enfin :

```
mysql < /var/backups/mariadb/backup_full.sql
```

---

### **Démarche 5 : Automatisation (concept)**

**Exercice mental** : Imaginez que vous devez faire cela tous les jours.

**Questions** :

1. Quelles étapes pourriez-vous automatiser ?
2. Comment géreriez-vous les mots de passe de façon sécurisée ?
3. Comment organiseriez-vous les sauvegardes par date ?

**Proposition de solution** : Créer un script qui :

1. Sauvegarde toutes les bases
2. Compresse le résultat
3. Chiffre avec un mot de passe stocké de manière sécurisée
4. Donne un nom avec la date du jour
5. Supprime les sauvegardes de plus de 7 jours

---

## **Synthèse et bonnes pratiques**

### **Checklist de fin d'atelier**

À la fin de cet atelier, vous devriez être capable de :

- [ ] Créer une sauvegarde complète de toutes les bases
- [ ] Sauvegarder une base spécifique seulement
- [ ] Sauvegarder une table précise
- [ ] Restaurer une base depuis une sauvegarde
- [ ] Compresser une sauvegarde pour gagner de l'espace
- [ ] Chiffrer une sauvegarde pour la sécuriser
- [ ] Restaurer depuis une sauvegarde chiffrée et compressée

### **Exercice final intégrateur**

**Scénario** : Vous êtes administrateur de la base `gestion_stock`. Créez une procédure de sauvegarde qui :

1. Sauvegarde UNIQUEMENT la base `gestion_stock`
2. Compresse la sauvegarde
3. Chiffre le résultat
4. Donne un nom incluant la date
5. Stocke le tout dans `/var/backups/mariadb/`

**Indices** :

- Utilisez la commande `date` pour obtenir la date du jour
- Enchaînez les commandes avec `|` (pipe) ou exécutez-les séquentiellement
- Testez votre procédure en restaurant ensuite la base

**Solution possible** :

```
# Obtenir la date
DATE=$(date +%Y%m%d)

# Sauvegarde, compression et chiffrement
mysqldump gestion_stock | gzip | gpg -c --batch --passphrase "votre_mot_de_passe" > /var/backups/mariadb/gestion_stock_$DATE.sql.gz.gpg
```

**Test final** : Restaurez et vérifiez que tout fonctionne !

---

## **Évaluation formative**

**Auto-évaluation** : Sur une échelle de 1 à 5, notez votre maîtrise :

1. Je comprends l'importance des sauvegardes régulières
2. Je sais choisir la bonne méthode de sauvegarde selon le besoin
3. Je peux restaurer une base depuis une sauvegarde
4. Je comprends l'intérêt de la compression et du chiffrement
5. Je pourrais mettre en place un plan de sauvegarde simple

**Prochaines étapes** :

- Expérimentez avec des bases plus volumineuses
- Testez la sauvegarde incrémentielle
- Explorez les options avancées de `mysqldump` (`--single-transaction`, `--lock-tables`, etc.)
- Mettez en place une automatisation avec cron

---

**Rappel pédagogique** : L'important n'est pas de mémoriser toutes les commandes, mais de comprendre :

1. **Pourquoi** on fait une sauvegarde
2. **Quand** choisir chaque méthode
3. **Comment** vérifier que la sauvegarde a fonctionné
4. **Comment tester** régulièrement la restauration

Une sauvegarde qui n'a jamais été testée n'est pas une sauvegarde fiable !
