# Atelier  ‚Äî Cr√©ation d‚Äôune base et d‚Äôun utilisateur en MariaDB/MySQL

## üéØ But de l‚Äôatelier

Dans cet atelier, vous allez apprendre √† cr√©er une base de donn√©es, une table et un utilisateur en appliquant le **principe du moindre privil√®ge** (least privilege principle). Ce principe de s√©curit√© consiste √† accorder √† un utilisateur uniquement les permissions n√©cessaires √† sa t√¢che, r√©duisant ainsi les risques en cas de compromission.

### Objectifs p√©dagogiques :

1. **Comprendre** l‚Äôarchitecture d‚Äôune base de donn√©es relationnelle
2. **Cr√©er** une base de donn√©es et une table avec des contraintes
3. **G√©rer** les utilisateurs et leurs droits d‚Äôacc√®s
4. **V√©rifier** et **tester** les permissions accord√©es
5. **Appliquer** les bonnes pratiques de s√©curit√©

### Pr√©requis :

- MariaDB ou MySQL install√©
- Acc√®s administrateur (root) √† la base de donn√©es
- Connexion en ligne de commande

---

## üìö Contexte th√©orique

### Qu'est-ce qu'une base de donn√©es ?

Une base de donn√©es est un ensemble organis√© de donn√©es stock√©es et accessibles √©lectroniquement. MariaDB/MySQL utilise le mod√®le relationnel, o√π les donn√©es sont organis√©es en tables avec des relations entre elles.

### S√©curit√© des bases de donn√©es :

- **Authentification** : V√©rification de l'identit√© (utilisateur/mot de passe)
- **Autorisation** : Droits accord√©s sur les objets (tables, bases)
- **Audit** : Tra√ßabilit√© des actions effectu√©es

### Principe du moindre privil√®ge :

Donner uniquement les droits n√©cessaires pour accomplir une t√¢che sp√©cifique. Par exemple, une application de consultation ne devrait pas pouvoir supprimer des donn√©es.

---

## üöÄ √âtapes d√©taill√©es de l'atelier

### Phase 1 : Pr√©paration de l'environnement

#### √âtape 0 : Connexion en tant qu'administrateur

```bash
# Se connecter √† MariaDB/MySQL avec les droits root
sudo mysql -u root -p

# Alternative sans mot de passe (si configur√©)
sudo mysql
```

**Explication :** 

- `sudo` donne les privil√®ges administrateur syst√®me
- `mysql` est le client en ligne de commande
- `-u root` sp√©cifie l'utilisateur
- `-p` demande le mot de passe (√† saisir apr√®s)

---

### Phase 2 : Cr√©ation de la base de donn√©es et des tables

#### √âtape 1.1 : Cr√©er la base de donn√©es

```sql
-- Cr√©ation d'une base de donn√©es nomm√©e "gestion_stock"
-- IF NOT EXISTS √©vite une erreur si la base existe d√©j√†
CREATE DATABASE IF NOT EXISTS gestion_stock;

-- V√©rification de la cr√©ation
SHOW DATABASES LIKE 'gestion_stock';
```

**Questions de r√©flexion :**

- Quelle est la diff√©rence entre `CREATE DATABASE` et `CREATE SCHEMA` ?
- Pourquoi utiliser `IF NOT EXISTS` dans un script de production ?

#### √âtape 1.2 : S√©lectionner la base de donn√©es

```sql
-- S√©lectionner la base de donn√©es pour les op√©rations suivantes
USE gestion_stock;

-- V√©rifier qu'on est dans la bonne base
SELECT DATABASE();
```

#### √âtape 1.3 : Cr√©er la table "produits"

```sql
-- Cr√©ation d'une table pour stocker les produits
CREATE TABLE produits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    quantite INT NOT NULL CHECK (quantite >= 0),
    prix DECIMAL(10,2) NOT NULL CHECK (prix > 0),
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    date_modification TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Explication des colonnes :
-- id : identifiant unique, auto-incr√©ment√©
-- nom : texte de maximum 100 caract√®res, obligatoire
-- quantite : entier positif ou nul
-- prix : nombre d√©cimal avec 2 chiffres apr√®s la virgule
-- date_creation : horodatage automatique √† la cr√©ation
-- date_modification : horodatage mis √† jour automatiquement

-- V√©rifier la structure de la table
DESCRIBE produits;
SHOW CREATE TABLE produits;
```

**Concept important :** Les contraintes (constraints)

- `PRIMARY KEY` : identifiant unique
- `NOT NULL` : valeur obligatoire
- `CHECK` : validation de la valeur
- `DEFAULT` : valeur par d√©faut
- `FOREIGN KEY` : cl√© √©trang√®re (non utilis√©e ici pour simplifier)

#### √âtape 1.4 : Ins√©rer des donn√©es initiales

```sql
-- Insertion de donn√©es de test
INSERT INTO produits (nom, quantite, prix) VALUES
('Stylo bleu', 100, 1.50),
('Stylo rouge', 80, 1.50),
('Clavier m√©canique', 10, 89.99),
('√âcran 24 pouces', 5, 249.99),
('Souris ergonomique', 15, 45.50);

-- V√©rifier l'insertion
SELECT COUNT(*) AS nombre_produits FROM produits;
SELECT * FROM produits ORDER BY nom;
```

**Exercice :** Ins√©rez 2 produits suppl√©mentaires de votre choix.

---

### Phase 3 : Gestion des utilisateurs

#### √âtape 2.1 : Comprendre la syntaxe de cr√©ation d'utilisateur

```sql
-- Syntaxe g√©n√©rale
CREATE USER 'nom_utilisateur'@'hote' IDENTIFIED BY 'mot_de_passe';

-- Exemples d'h√¥tes :
-- 'utilisateur'@'localhost' : uniquement depuis la machine locale
-- 'utilisateur'@'%' : depuis n'importe quelle machine (D√âCONSEILL√â en production)
-- 'utilisateur'@'192.168.1.%' : depuis un sous-r√©seau sp√©cifique
```

#### √âtape 2.2 : Cr√©er l'utilisateur "stock_user"

```sql
-- Cr√©ation d'un utilisateur avec un mot de passe fort
CREATE USER 'stock_user'@'localhost' 
IDENTIFIED BY 'Str0ngP@ssw0rd!2025';

-- Bonnes pratiques pour les mots de passe :
-- Au moins 12 caract√®res
-- Majuscules, minuscules, chiffres, caract√®res sp√©ciaux
-- Pas de mots du dictionnaire
-- Unique pour chaque service

-- V√©rifier la cr√©ation
SELECT user, host FROM mysql.user WHERE user = 'stock_user';
```

**‚ö†Ô∏è S√©curit√© :** En production, utilisez toujours des mots de passe forts et changez-les r√©guli√®rement !

---

### Phase 4 : Gestion des permissions

#### √âtape 3.1 : Comprendre le syst√®me de permissions

```sql
-- Syntaxe g√©n√©rale
GRANT type_de_permission ON base.table TO utilisateur;

-- Niveaux de permissions :
-- *.* : toutes les bases, toutes les tables (DANGEREUX)
-- base.* : toutes les tables d'une base
-- base.table : une table sp√©cifique
-- base.procedure : une proc√©dure stock√©e

-- Types de permissions courantes :
-- SELECT : lire les donn√©es
-- INSERT : ins√©rer des donn√©es
-- UPDATE : modifier des donn√©es
-- DELETE : supprimer des donn√©es
-- CREATE : cr√©er des tables
-- DROP : supprimer des tables
-- ALL PRIVILEGES : tous les droits (ADMIN)
```

#### √âtape 3.2 : Accorder des droits sp√©cifiques

```sql
-- Donner uniquement SELECT, INSERT, UPDATE sur toutes les tables de gestion_stock
GRANT SELECT, INSERT, UPDATE ON gestion_stock.* TO 'stock_user'@'localhost';

-- Appliquer les changements (n√©cessaire dans certaines versions)
FLUSH PRIVILEGES;

-- V√©rifier les droits accord√©s
SHOW GRANTS FOR 'stock_user'@'localhost';
```

#### √âtape 3.3 : V√©rifier les permissions en d√©tail

```sql
-- Voir les permissions sp√©cifiques
SELECT * FROM mysql.tables_priv 
WHERE Db = 'gestion_stock' AND User = 'stock_user';

-- Voir les permissions globales
SELECT * FROM mysql.user 
WHERE user = 'stock_user' AND host = 'localhost'\G
```

**Exercice :** Quelles permissions manquent √† `stock_user` pour pouvoir cr√©er une nouvelle table ?

---

### Phase 5 : Tests approfondis des permissions

#### √âtape 4.1 : Se connecter en tant que stock_user

```bash
# Dans un nouveau terminal, se connecter avec le nouvel utilisateur
mysql -u stock_user -p gestion_stock

# Entrez le mot de passe : Str0ngP@ssw0rd!2025
```

#### √âtape 4.2 : Tester les permissions accord√©es

```sql
-- Test 1 : Lecture (SELECT) - DEVRAIT FONCTIONNER
USE gestion_stock;
SELECT * FROM produits;
SELECT nom, prix FROM produits WHERE quantite > 10;

-- Test 2 : Insertion (INSERT) - DEVRAIT FONCTIONNER
INSERT INTO produits (nom, quantite, prix) 
VALUES ('C√¢ble HDMI 2m', 50, 12.99);

-- Test 3 : Modification (UPDATE) - DEVRAIT FONCTIONNER
UPDATE produits 
SET quantite = quantite - 1 
WHERE nom = 'Stylo bleu';

-- V√©rifier les changements
SELECT * FROM produits WHERE nom LIKE '%Stylo%';
```

#### √âtape 4.3 : Tester les permissions REFUS√âES

```sql
-- Test 4 : Suppression (DELETE) - DEVRAIT √âCHOUER
-- stock_user n'a pas le droit DELETE
DELETE FROM produits WHERE id = 1;

-- Test 5 : Cr√©ation de table - DEVRAIT √âCHOUER
CREATE TABLE test (id INT);

-- Test 6 : Suppression de table - DEVRAIT √âCHOUER
DROP TABLE produits;

-- Test 7 : Acc√®s √† d'autres bases - DEVRAIT √âCHOUER
USE mysql;
SELECT * FROM user;

-- Test 8 : Modification de structure - DEVRAIT √âCHOUER
ALTER TABLE produits ADD COLUMN marque VARCHAR(50);
```

**Note :** Chaque √©chec doit produire une erreur sp√©cifique. Analysez ces messages pour comprendre ce qui manque.

#### √âtape 4.4 : V√©rifier ce que l'utilisateur peut voir

```sql
-- Quelles bases sont visibles ?
SHOW DATABASES;

-- Quelles tables dans gestion_stock ?
SHOW TABLES;

-- Tenter de voir les processus (n√©cessite des droits sp√©ciaux)
SHOW PROCESSLIST;
```

---

### Phase 6 : Analyse et correction

#### √âtape 5.1 : Retourner en administrateur

```bash
# Dans le terminal original, si vous √™tes encore connect√© en root
# Sinon reconnectez-vous
sudo mysql -u root -p
```

#### √âtape 5.2 : Analyser les besoins suppl√©mentaires

Supposons que `stock_user` ait besoin de :

1. Supprimer des produits p√©rim√©s (n√©cessite DELETE)
2. Cr√©er une vue pour les produits √† r√©approvisionner

```sql
-- Ajouter le droit DELETE de mani√®re cibl√©e
GRANT DELETE ON gestion_stock.produits TO 'stock_user'@'localhost';

-- Cr√©er une vue en tant qu'admin
CREATE VIEW produits_a_reapprovisionner AS
SELECT id, nom, quantite, prix 
FROM produits 
WHERE quantite < 10;

-- Donner l'acc√®s en lecture √† la vue
GRANT SELECT ON gestion_stock.produits_a_reapprovisionner 
TO 'stock_user'@'localhost';

FLUSH PRIVILEGES;
```

#### √âtape 5.3 : Retester avec les nouveaux droits

```bash
# Reconnectez-vous en tant que stock_user
mysql -u stock_user -p gestion_stock
```

```sql
-- Tester le nouveau droit DELETE
DELETE FROM produits WHERE nom = 'Produit obsol√®te';

-- Utiliser la vue
SELECT * FROM produits_a_reapprovisionner;

-- V√©rifier que CREATE TABLE est toujours interdit
CREATE TABLE inventaire (id INT); -- Doit √©chouer
```

---

### Phase 7 : Nettoyage et bonnes pratiques

#### √âtape 6.1 : R√©voquer des permissions (si n√©cessaire)

```sql
-- Revenir en administrateur
-- R√©voquer un droit sp√©cifique
REVOKE DELETE ON gestion_stock.produits FROM 'stock_user'@'localhost';

-- R√©voquer tous les droits
-- REVOKE ALL PRIVILEGES ON gestion_stock.* FROM 'stock_user'@'localhost';

FLUSH PRIVILEGES;
```

#### √âtape 6.2 : Supprimer l'utilisateur (si n√©cessaire)

```sql
-- Supprimer l'utilisateur
DROP USER 'stock_user'@'localhost';

-- V√©rifier la suppression
SELECT user FROM mysql.user WHERE user = 'stock_user';
```

#### √âtape 6.3 : Journalisation et audit

```sql
-- V√©rifier qui a fait quoi (si la journalisation est activ√©e)
-- Note : n√©cessite une configuration sp√©cifique
SELECT * FROM mysql.general_log 
WHERE user_host LIKE '%stock_user%'
ORDER BY event_time DESC
LIMIT 10;
```

---

## üìä Tableau r√©capitulatif des permissions

| Permission | Description                | Exemple d'utilisation      | Accord√©e √† stock_user ? |
| ---------- | -------------------------- | -------------------------- | ----------------------- |
| SELECT     | Lire les donn√©es           | `SELECT * FROM produits`   | ‚úÖ Oui                   |
| INSERT     | Ajouter des donn√©es        | `INSERT INTO produits ...` | ‚úÖ Oui                   |
| UPDATE     | Modifier des donn√©es       | `UPDATE produits SET ...`  | ‚úÖ Oui                   |
| DELETE     | Supprimer des donn√©es      | `DELETE FROM produits ...` | ‚ùå Non (initialement)    |
| CREATE     | Cr√©er des tables/bases     | `CREATE TABLE ...`         | ‚ùå Non                   |
| DROP       | Supprimer des tables/bases | `DROP TABLE produits`      | ‚ùå Non                   |
| ALTER      | Modifier la structure      | `ALTER TABLE ...`          | ‚ùå Non                   |
| INDEX      | Cr√©er/supprimer index      | `CREATE INDEX ...`         | ‚ùå Non                   |
| ALL        | Tous les droits            | `GRANT ALL ...`            | ‚ùå Non                   |

---

## üîç Sc√©narios avanc√©s

### Sc√©nario 1 : Gestion des inventaires multiples

```sql
-- Cr√©er un utilisateur par d√©partement
CREATE USER 'stock_ventes'@'localhost' IDENTIFIED BY 'P@ssVentes2025';
CREATE USER 'stock_achats'@'localhost' IDENTIFIED BY 'P@ssAchats2025';

-- Droits diff√©rents selon le d√©partement
GRANT SELECT ON gestion_stock.* TO 'stock_ventes'@'localhost';
GRANT SELECT, INSERT, UPDATE ON gestion_stock.* TO 'stock_achats'@'localhost';
GRANT SELECT ON gestion_stock.produits_a_reapprovisionner TO 'stock_ventes'@'localhost';
```

### Sc√©nario 2 : Acc√®s par proc√©dures stock√©es

```sql
-- Cr√©er une proc√©dure pour mise √† jour s√©curis√©e
DELIMITER $$
CREATE PROCEDURE diminuer_stock(IN produit_id INT, IN quantite INT)
BEGIN
    UPDATE produits 
    SET quantite = quantite - quantite
    WHERE id = produit_id AND quantite >= quantite;
END$$
DELIMITER ;

-- Donner uniquement le droit d'ex√©cuter la proc√©dure
GRANT EXECUTE ON PROCEDURE gestion_stock.diminuer_stock 
TO 'stock_user'@'localhost';**
```



## üìö Ressources pour aller plus loin

1. Documentation officielle MariaDB :
   
   - [CREATE USER](https://mariadb.com/kb/en/create-user/)
   - [GRANT](https://mariadb.com/kb/en/grant/)
   - [Privileges](https://mariadb.com/kb/en/privileges/)

2. S√©curit√© des bases de donn√©es :
   
   - OWASP Database Security
   - CIS Benchmarks for MySQL/MariaDB

3. Outils de gestion :
   
   - phpMyAdmin (interface web)
   - MySQL Workbench (desktop)
   - Adminer (alternative l√©g√®re)

---

## üéâ Conclusion

F√©licitations ! Vous avez maintenant une compr√©hension solide de :

- La cr√©ation et gestion de bases de donn√©es MariaDB/MySQL
- La cr√©ation et s√©curisation des utilisateurs
- L'application du principe du moindre privil√®ge
- La v√©rification et le test des permissions
