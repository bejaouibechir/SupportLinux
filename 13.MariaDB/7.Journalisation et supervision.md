# Atelier 11 — Activer et analyser le *slow query log*

## But de l’atelier

Apprendre à :

1. Activer le journal des requêtes lentes (*slow query log*) dans MariaDB.

2. Définir un seuil de lenteur pour identifier les requêtes problématiques.

3. Consulter et analyser le fichier de log.

4. Utiliser ces informations pour optimiser les performances.

---

## Étapes de l’atelier

1. Vérifier si le *slow query log* est activé.

2. L’activer et définir un seuil (par exemple 1 seconde).

3. Exécuter une requête volontairement lente.

4. Lire et analyser le fichier de log.

5. Désactiver le *slow query log* si nécessaire.

---

## Démarches (commandes commentées)

### 1. Vérifier l’état actuel

Dans MariaDB :

```sql
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'slow_query_log_file';
SHOW VARIABLES LIKE 'long_query_time';
```

Résultats attendus :

- `slow_query_log` = OFF (désactivé par défaut).

- `slow_query_log_file` = chemin du fichier log.

- `long_query_time` = seuil actuel en secondes (souvent 10).

---

### 2. Activer le *slow query log* temporairement

```sql
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
```

Explications :

- `slow_query_log=ON` active la journalisation.

- `long_query_time=1` définit comme lente toute requête > 1 seconde.

---

### 3. Exécuter une requête lente

Créons une requête qui scanne toute une grande table, sans index.

```sql
USE perf_demo;
-- Requête volontairement lourde
SELECT * FROM clients WHERE nom LIKE '%9999%';
```

Cette requête fait un scan complet et devrait être enregistrée dans le *slow query log*.

---

### 4. Lire le fichier de log

En shell :

```bash
sudo cat /var/log/mysql/mariadb-slow.log
```

Résultat attendu :

- Informations sur la requête exécutée.

- Temps d’exécution.

- Nombre de lignes examinées.

---

### 5. Désactiver si nécessaire

```sql
SET GLOBAL slow_query_log = 'OFF';
```

---

## Résultats attendus

- Le *slow query log* est activé et configuré.

- Une requête lente volontaire a été enregistrée.

- Le fichier de log contient les détails de la requête et permet d’identifier les problèmes de performance.

- On sait comment activer/désactiver et configurer le seuil de lenteur.

---

# Les binlogs (Binary Logs)

Apprendre à :

1. Comprendre le rôle des *binary logs* (binlogs) dans MariaDB.

2. Activer et configurer les binlogs.

3. Consulter leur contenu.

4. Purger les binlogs pour éviter la saturation disque.

Les binlogs enregistrent toutes les modifications de données (INSERT, UPDATE, DELETE, CREATE…), utiles pour la réplication et la restauration point-in-time.

---

## Étapes de l’atelier

1. Vérifier si les binlogs sont activés.

2. Activer les binlogs dans la configuration.

3. Générer des événements (insertions).

4. Consulter le contenu des binlogs.

5. Purger les binlogs anciens.

---

## Démarches (commandes commentées)

### 1. Vérifier si les binlogs sont activés

```sql
SHOW VARIABLES LIKE 'log_bin';
SHOW BINARY LOGS;
```

Résultat attendu :

- Si `log_bin` = OFF, les binlogs ne sont pas activés.

- Sinon, la liste des fichiers binlog apparaît.

---

### 2. Activer les binlogs (si besoin)

Éditer le fichier de configuration MariaDB :

```bash
sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
```

Ajouter ou décommenter :

```
[mysqld]
log_bin                 = /var/log/mysql/mariadb-bin
server_id               = 1
binlog_format           = ROW
expire_logs_days        = 7
```

Puis redémarrer MariaDB :

```bash
sudo systemctl restart mariadb
```

Vérification :

```sql
SHOW BINARY LOGS;
```

---

### 3. Générer des événements

```sql
USE gestion_stock;
INSERT INTO produits (nom, quantite, prix) VALUES ('Tablette', 30, 250.00);
INSERT INTO produits (nom, quantite, prix) VALUES ('Ordinateur', 15, 800.00);
```

---

### 4. Lire le contenu des binlogs

En shell :

```bash
sudo mysqlbinlog /var/log/mysql/mariadb-bin.000001 | less
```

Résultat attendu :

- On voit les événements SQL correspondant aux insertions effectuées.

---

### 5. Purger les binlogs anciens

Méthode SQL :

```sql
PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);
```

Ou purger jusqu’à un fichier spécifique :

```sql
PURGE BINARY LOGS TO 'mariadb-bin.000010';
```

Vérification :

```sql
SHOW BINARY LOGS;
```

---

## Résultats attendus

- Les binlogs sont activés et stockent toutes les opérations de modification.

- On peut lire leur contenu avec `mysqlbinlog`.

- Les insertions apparaissent dans le fichier binaire.

- Les binlogs anciens peuvent être purgés pour éviter de remplir le disque.

---

Nous restons dans le **chapitre Maintenance et optimisation** et passons à l’atelier suivant sur l’intégration des journaux.

---

# Intégration avec les logs système

# systemd-journald

# /var/log/mysql/

## But de l’atelier

Apprendre à :

1. Identifier où MariaDB enregistre ses journaux.

2. Consulter les journaux via `systemd-journald`.

3. Consulter les fichiers de logs classiques dans `/var/log/mysql/`.

4. Savoir utiliser ces journaux pour diagnostiquer des problèmes.

---

## Étapes de l’atelier

1. Vérifier le service MariaDB avec systemd.

2. Lire les logs via `journalctl`.

3. Lire les fichiers dans `/var/log/mysql/`.

4. Provoquer une erreur pour observer son enregistrement.

---

## Démarches (commandes commentées)

### 1. Vérifier le service MariaDB

```bash
systemctl status mariadb
```

Résultat attendu : état du service, démarré ou arrêté, avec quelques lignes de log récentes.

---

### 2. Lire les journaux via journald

```bash
# Derniers événements liés à MariaDB
journalctl -u mariadb -n 20 --no-pager

# Suivre les logs en temps réel
journalctl -u mariadb -f
```

Résultat attendu : affichage des événements système liés à MariaDB (démarrages, arrêts, erreurs).

---

### 3. Lire les fichiers de logs classiques

Dans Debian, MariaDB écrit aussi dans `/var/log/mysql/` :

```bash
ls -lh /var/log/mysql/
```

Fichiers typiques :

- `error.log` : erreurs, plantages, redémarrages.

- `mariadb-slow.log` : requêtes lentes (si activé).

Exemple :

```bash
sudo tail -n 20 /var/log/mysql/error.log
```

---

### 4. Provoquer une erreur et l’observer

Dans MariaDB :

```sql
USE base_inexistante;
```

Résultat attendu : message d’erreur dans le terminal et enregistrement dans `journalctl` et `error.log`.

Vérification :

```bash
journalctl -u mariadb -n 5 --no-pager
sudo tail -n 5 /var/log/mysql/error.log
```

---

## Résultats attendus

- On sait utiliser `systemctl status` et `journalctl` pour voir les logs système.

- On connaît l’emplacement des fichiers de logs spécifiques dans `/var/log/mysql/`.

- Une erreur volontaire apparaît bien dans les journaux, confirmant la traçabilité.

---

Nous restons dans le **chapitre Maintenance et optimisation** et passons à l’atelier 14 sur la supervision basique de MariaDB.

---

# Vérification d’état avec mysqladmin

## But de l’atelier

Apprendre à :

1. Utiliser l’outil en ligne de commande `mysqladmin` pour vérifier rapidement l’état de MariaDB.

2. Exécuter des requêtes SQL de monitoring pour obtenir des informations plus détaillées.

3. Identifier des indicateurs utiles pour la supervision (uptime, connexions, requêtes, threads).

---

## Étapes de l’atelier

1. Vérifier la disponibilité du serveur avec `mysqladmin ping`.

2. Consulter l’état général avec `mysqladmin status`.

3. Obtenir des statistiques complètes avec `mysqladmin extended-status`.

4. Lancer des requêtes SQL de monitoring (`SHOW STATUS`, `SHOW PROCESSLIST`).

5. Interpréter quelques métriques clés.

---

## Démarches (commandes commentées)

### 1. Vérifier la disponibilité

```bash
mysqladmin ping -u root
```

Résultat attendu :

```
mysqld is alive
```

---

### 2. Consulter l’état général

```bash
mysqladmin status -u root
```

Exemple de sortie :

```
Uptime: 1234  Threads: 2  Questions: 50  Slow queries: 0  Opens: 100  Flush tables: 1  Open tables: 80  Queries per second avg: 0.04
```

Explication des champs :

- `Uptime` : durée de fonctionnement du serveur.

- `Threads` : connexions actives.

- `Questions` : nombre de requêtes exécutées.

- `Slow queries` : requêtes lentes détectées.

- `Queries per second avg` : moyenne de requêtes/s depuis le démarrage.

---

### 3. Obtenir des statistiques détaillées

```bash
mysqladmin extended-status -u root | less
```

Résultat attendu : une liste de variables et leurs valeurs, comme :

- `Threads_connected` : connexions actives.

- `Connections` : nombre total de connexions établies depuis le démarrage.

- `Queries` : nombre total de requêtes exécutées.

---

### 4. Requêtes SQL de monitoring

Dans MariaDB :

```sql
-- Voir les principales statistiques
SHOW GLOBAL STATUS LIKE 'Threads%';
SHOW GLOBAL STATUS LIKE 'Connections';
SHOW GLOBAL STATUS LIKE 'Queries';

-- Voir les requêtes en cours
SHOW PROCESSLIST;
```

---

### 5. Interprétation de quelques métriques

- `Threads_connected` : nombre d’utilisateurs actuellement connectés.

- `Connections` : utile pour détecter des pics de charge.

- `Slow_queries` : à surveiller pour identifier des problèmes de performance.

- `Threads_running` : connexions actives exécutant des requêtes.

---

## Résultats attendus

- Avec `mysqladmin`, on obtient en une commande un état rapide du serveur.

- Les requêtes SQL permettent d’aller plus loin avec des métriques détaillées.

- L’administrateur sait identifier les indicateurs essentiels pour surveiller la santé du serveur MariaDB.

---
