

# Monitoring MariaDB avec Prometheus + Grafana

## Ã‰tape 1. Installer mysqld_exporter (via socket Unix)

### 1.1 TÃ©lÃ©charger et installer

```bash
cd /tmp
VER="0.17.2"
curl -fLO "https://github.com/prometheus/mysqld_exporter/releases/download/v${VER}/mysqld_exporter-${VER}.linux-amd64.tar.gz"
tar -xzf mysqld_exporter-${VER}.linux-amd64.tar.gz
sudo install -m0755 mysqld_exporter-${VER}.linux-amd64/mysqld_exporter /usr/local/bin/mysqld_exporter

/usr/local/bin/mysqld_exporter --version
```

### 1.2 CrÃ©er lâ€™utilisateur SQL

Dans MariaDB :

```sql
DROP USER IF EXISTS 'prom_exporter'@'localhost';
CREATE USER 'prom_exporter'@'localhost' IDENTIFIED BY 'PromPass2025_';
GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'prom_exporter'@'localhost';
GRANT SELECT ON performance_schema.* TO 'prom_exporter'@'localhost';
FLUSH PRIVILEGES;
```

---

## Ã‰tape 2. Test sans service

### 2.1 Fichier client

```bash
mkdir -p ~/.mysqld_exporter_test
cat > ~/.mysqld_exporter_test/my.cnf <<'EOF'
[client]
user=prom_exporter
password=PromPass2025_
socket=/run/mysqld/mysqld.sock
EOF
chmod 600 ~/.mysqld_exporter_test/my.cnf
```

### 2.2 Lancer et tester

Terminal A :

```bash
/usr/local/bin/mysqld_exporter \
  --config.my-cnf=$HOME/.mysqld_exporter_test/my.cnf \
  --web.listen-address=":9104"
```

Terminal B :

```bash
curl -s http://127.0.0.1:9104/metrics | head -n 20
```

ğŸ‘‰ Tu dois voir `# HELP`, `# TYPE`, puis des mÃ©triques `mysql_...`.  
ArrÃªte avec `Ctrl+C`.

---

## Ã‰tape 3. Service systemd pour mysqld_exporter

### 3.1 CrÃ©er un utilisateur systÃ¨me et fichier conf

```bash
sudo useradd --no-create-home --shell /usr/sbin/nologin mysqldexp 2>/dev/null || true
sudo mkdir -p /etc/mysqld_exporter
sudo tee /etc/mysqld_exporter/.my.cnf >/dev/null <<'EOF'
[client]
user=prom_exporter
password=PromPass2025_
socket=/run/mysqld/mysqld.sock
EOF
sudo chown mysqldexp:mysqldexp /etc/mysqld_exporter/.my.cnf
sudo chmod 640 /etc/mysqld_exporter/.my.cnf
```

### 3.2 UnitÃ© systemd

```bash
sudo tee /etc/systemd/system/mysqld_exporter.service >/dev/null <<'UNIT'
[Unit]
Description=Prometheus MySQLd Exporter (socket)
After=network.target mariadb.service
Requires=mariadb.service

[Service]
User=mysqldexp
Group=mysqldexp
ExecStart=/usr/local/bin/mysqld_exporter \
  --config.my-cnf=/etc/mysqld_exporter/.my.cnf \
  --web.listen-address=":9104"
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
UNIT

sudo systemctl daemon-reload
sudo systemctl enable --now mysqld_exporter.service
systemctl status mysqld_exporter.service --no-pager
```

ğŸ‘‰ VÃ©rifie encore avec :

```bash
curl -s http://127.0.0.1:9104/metrics | head -n 20
```

---

## Ã‰tape 4. Installer Prometheus (avec correctif)

### 4.1 Installer le paquet

```bash
sudo apt-get update
sudo apt-get install -y prometheus
```

### 4.2 RÃ©pertoires et droits (correctif)

```bash
sudo useradd --system --no-create-home --shell /usr/sbin/nologin prometheus 2>/dev/null || true
sudo mkdir -p /var/lib/prometheus /etc/prometheus/consoles /etc/prometheus/console_libraries
sudo chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
```

### 4.3 Config minimal

```bash
sudo tee /etc/prometheus/prometheus.yml >/dev/null <<'YAML'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'mariadb'
    static_configs:
      - targets: ['localhost:9104']
YAML
```

### 4.4 Forcer les ARGS

```bash
sudo sed -i 's|^ARGS=.*|ARGS="--config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus --web.listen-address=:9090"|' /etc/default/prometheus
```

### 4.5 DÃ©marrer et vÃ©rifier

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now prometheus
systemctl status prometheus --no-pager
ss -tlnp | grep 9090
curl -s http://localhost:9090/-/ready
curl -s http://localhost:9090/targets | head
```

ğŸ‘‰ Les jobs `prometheus` et `mariadb` doivent Ãªtre `UP`.

---

## Ã‰tape 5. Installer Grafana

```bash
sudo mkdir -p /etc/apt/keyrings
wget -O- https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | \
  sudo tee /etc/apt/sources.list.d/grafana.list

sudo apt-get update
sudo apt-get install -y grafana
sudo systemctl enable --now grafana-server
systemctl status grafana-server --no-pager
```

AccÃ¨de via navigateur â†’ `http://<IP>:3000` (login `admin` / `admin`).  
Ajoute **Prometheus** comme source (`http://localhost:9090` â†’ Save & Test).

---

## Ã‰tape 6. Dashboard simpliste

### Option rapide (UI)

- Create â†’ Dashboard â†’ Add panel

- Query :
  
  ```promql
  rate(mysql_global_status_queries[1m])
  ```

- Visualization : **Stat** ou **Gauge**

- Title : `Queries Per Second (QPS)`

- Save dashboard.

### Option import JSON

```json
{
  "title": "MariaDB Simple Demo",
  "schemaVersion": 39,
  "version": 1,
  "panels": [
    {
      "type": "stat",
      "title": "Queries Per Second (QPS)",
      "gridPos": {"x": 0, "y": 0, "w": 12, "h": 6},
      "targets": [
        {"expr": "rate(mysql_global_status_queries[1m])", "refId": "A"}
      ],
      "options": {
        "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false},
        "orientation": "horizontal",
        "textMode": "value",
        "colorMode": "value"
      }
    }
  ],
  "time": {"from": "now-15m", "to": "now"}
}
```

---

## Ã‰tape 7. Simulation de charge (dÃ©mo)

### 7.1 PrÃ©parer la base

```bash
mysql -uroot -e "
CREATE DATABASE IF NOT EXISTS monitoring_demo;
USE monitoring_demo;
CREATE TABLE IF NOT EXISTS events (
  id INT AUTO_INCREMENT PRIMARY KEY,
  payload VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);"
```

### 7.2 Script de charge

```bash
cat > ~/demo_load.sh <<'EOF'
#!/bin/bash
DB="monitoring_demo"
while true; do
  for i in $(seq 1 30); do
    mysql -uroot -e "INSERT INTO $DB.events(payload) VALUES (CONCAT('evt-', RAND()));"
  done
  for i in $(seq 1 30); do
    mysql -uroot -e "SELECT COUNT(*) FROM $DB.events;" >/dev/null
  done
  sleep 1
done
EOF
chmod +x ~/demo_load.sh
```

### 7.3 Lancer et observer

```bash
./demo_load.sh
```

ğŸ‘‰ Dans Grafana :

- QPS monte pendant lâ€™exÃ©cution.

- Quand tu arrÃªtes (`Ctrl+C`), QPS retombe Ã  0.

---

âœ… RÃ©sultat final :

- mysqld_exporter tourne en service (socket Unix).

- Prometheus scrape les mÃ©triques.

- Grafana affiche un dashboard simpliste QPS.

- Script de charge rend la dÃ©mo visuelle et immÃ©diate.


