

# Protection des données avec le chiffrement au repos (at-rest encryption)

## But de l’atelier

Apprendre à :

1. Activer le chiffrement au repos dans MariaDB.

2. Chiffrer les tables et les journaux de MariaDB.

3. Vérifier que le chiffrement est bien actif.

Le chiffrement *at-rest* protège les données stockées sur disque (fichiers de tables, journaux, binlogs), de sorte qu’un attaquant qui copie les fichiers ne puisse pas les lire.

---

## Étapes de l’atelier

1. Vérifier la prise en charge du chiffrement dans la version MariaDB installée.

2. Activer le plugin de chiffrement.

3. Configurer une clé de chiffrement.

4. Créer une table chiffrée.

5. Vérifier que le chiffrement est appliqué.

---

## Démarches

### 1. Vérifier le support du chiffrement

Dans MariaDB :

```sql
SHOW VARIABLES LIKE 'innodb_encrypt%';
SHOW PLUGINS LIKE 'file_key_management';
```

Résultat attendu :

- Les variables `innodb_encrypt_tables` et `innodb_encrypt_log` doivent exister.

- Le plugin `file_key_management` peut être utilisé pour gérer les clés.

---

### 2. Activer le plugin de chiffrement

Éditer le fichier de configuration MariaDB :

```bash
sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
```

Ajouter dans la section `[mysqld]` :

```
plugin_load_add = file_key_management
file_key_management_filename = /etc/mysql/encryption/keyfile.enc
file_key_management_filekey = FILE:/etc/mysql/encryption/keyfile
innodb_encrypt_tables = ON
innodb_encrypt_log = ON
encrypt_binlog = ON
```

---

### 3. Créer une clé de chiffrement

Créer le répertoire et le fichier de clé :

```bash
sudo mkdir -p /etc/mysql/encryption
sudo chmod 700 /etc/mysql/encryption

# Génération d’une clé aléatoire de 32 octets
openssl rand -base64 32 | sudo tee /etc/mysql/encryption/keyfile > /dev/null

# Créer un fichier de clés chiffrées
sudo mariadb-key-management \
  --write-keyfile --file-keyfile /etc/mysql/encryption/keyfile \
  --encryption-keyfile /etc/mysql/encryption/keyfile.enc
```

Assurer les permissions :

```bash
sudo chown -R mysql:mysql /etc/mysql/encryption
sudo chmod 600 /etc/mysql/encryption/*
```

---

### 4. Créer une table chiffrée

Après redémarrage de MariaDB :

```bash
sudo systemctl restart mariadb
```

Dans MariaDB :

```sql
CREATE DATABASE secure_demo;
USE secure_demo;

CREATE TABLE secrets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    info VARCHAR(100)
) ENCRYPTED=YES;

INSERT INTO secrets (info) VALUES ('motdepasse'), ('token_api');
```

---

### 5. Vérifier le chiffrement

Vérification des options :

```sql
SHOW VARIABLES LIKE 'innodb_encrypt_tables';
SHOW VARIABLES LIKE 'innodb_encrypt_log';
```

Vérification d’une table :

```sql
SELECT TABLE_SCHEMA, TABLE_NAME, CREATE_OPTIONS
FROM information_schema.tables
WHERE table_schema='secure_demo';
```

Résultat attendu : la colonne `CREATE_OPTIONS` contient `ENCRYPTED=YES`.

---

## Résultats attendus

- Le plugin de gestion de clés est activé et configuré.

- Les fichiers de tables et journaux MariaDB sont chiffrés sur disque.

- La table `secrets` est stockée avec l’option `ENCRYPTED=YES`.

- Même si quelqu’un copie les fichiers du disque, les données ne sont pas lisibles sans la clé.


