# Atelier 0 — Installer MariaDB et préparer le terrain

## Objectifs

* Installer MariaDB (Debian/Ubuntu).

* Mettre en route + test de connexion.
  
  * Préparer les  **répertoires** , **utilisateurs SQL**  et **données de démo** .
  
  * Activer un **slow query log**  (utile pour le timer de rotation).
  
  * Mettre en place l’auth **root via socket**  (par défaut) + un fichier `/root/.my.cnf` pour les scripts **root** .
  
  * Vérifs + mini-nettoyage.

> On **n’installe pas**  encore d’unités systemd personnalisées ici : on prépare l’environnement pour que les ateliers 1..N fonctionnent **du premier coup** .

---

## 0) Installation

```bash
sudo apt update

sudo apt install -y mariadb-server mariadb-client
```

Démarrage  & statut :

```bash
sudo systemctl enable --now mariadb

sudo systemctl status mariadb
```

---

### Créer le dossier de log avec les bons droits

```bash
sudo install -d -o mysql -g adm -m 2750 /var/log/mysql
```

### Créer le fichier du slow log (vide) avec les bons droits

```bash
sudo install -o mysql -g adm -m 640 /dev/null /var/log/mysql/mariadb-slow.log
```

## Vérifier que la conf est bien en place (dans /etc/mysql/mariadb.conf.d/50-server.cnf, section [mysqld]) :

- slow_query_log = ON

- slow_query_log_file = /var/log/mysql/mariadb-slow.log

- long_query_time = 1

- (optionnel) log_output = FILE

## 1) Connexion admin (root via socket) + fichier client

Sur Debian, MariaDB utilise **unix   _socket**  pour `root@localhost`.

Tant que vous exécutez les commandes en **root** , vous pouvez entrer sans mot de passe.

Test :

```bash
sudo mysql -e "SELECT VERSION();"
```

Préparez un **client config**  pour tous les scripts qui tourneront en root :

**Explications (ce que contient le fichier ci-dessous)** 

* Section ` [client]` pour éviter de répéter les options.

* `user=root` + socket → pas besoin de password si le plugin socket est actif.

**Fichier à créer : `/root/.my.cnf` (permissions 600)** 

```
 [client]

user=root

host=localhost
```

Appliquez les droits :

```bash
sudo chmod 600 /root/.my.cnf
```

> Si vous avez **désactivé**  l’auth socket et mis un mot de passe root, ajoutez `password=...` dans ce fichier.

---

## 2) Arborescence standard pour nos ateliers

```bash
 # Scripts DB et jeux de données

sudo mkdir -p /opt/db/migrations

 # App factice (pour les targets déploiement)

sudo mkdir -p /opt/app

 # Dossier sauvegardes (pour le timer backup)

sudo mkdir -p /var/backups/mariadb

 # Logs de travail (temporaires)

sudo mkdir -p /var/tmp

sudo chown -R root:root /opt/db /opt/app /var/backups/mariadb /var/tmp
```

> On utilisera `/opt/db` pour `backup.sh`, `maintain.sh`, `migrate.sh`, etc., dans les ateliers suivants.

---

## 3) Base de démo + données

Créez une base **demo**  + une table simple (utile pour maintenance, backups, health, etc.) :

```bash
sudo mysql <<'SQL'

CREATE DATABASE IF NOT EXISTS demo;

CREATE TABLE IF NOT EXISTS demo.notes (

  id  INT PRIMARY KEY AUTO _INCREMENT,

  txt VARCHAR(255) NOT NULL

);

INSERT INTO demo.notes (txt) VALUES ('hello'), ('world'), ('mariadb ready');

SQL
```

Test :

```bash
sudo mysql -e "SELECT COUNT( *) AS n FROM demo.notes;"
```

---

## 4) Comptes SQL dédiés (pour futurs ateliers)

> On garde **root via socket**  pour les opérations admin (purge binlogs, migrations).

> On crée des comptes **non-root**  pour les scripts spécifiques (backup  & health).

### 4.1 Compte backup  @localhost

* Permissions minimales pour `mysqldump` ** toutes bases** .

```bash
sudo mysql <<'SQL'

CREATE USER IF NOT EXISTS 'backup'@'localhost' IDENTIFIED BY 'ChangeMe _Backup!';

GRANT RELOAD, PROCESS, LOCK TABLES, REPLICATION CLIENT, SELECT, SHOW VIEW, EVENT, TRIGGER ON  *. * TO 'backup'@'localhost';

FLUSH PRIVILEGES;

SQL
```

Un fichier client **optionnel**  si vous voulez que ** des services non-root**  l’utilisent :

```
 # /root/.my.cnf-backup (si vous en avez besoin)

 [client]

user=backup

password=ChangeMe _Backup!

host=localhost
```

> Dans mes ateliers, les scripts de backup tourneront **en root**  et liront `/root/.my.cnf` root.

> Si vous préférez **non-root** , créez un user système dédié + un `~/.my.cnf` pour lui.

### 4.2 Compte ** health  @localhost **

* Droits lecture **sur demo**  pour un check simple (SELECT 1 sur une table).

```bash
sudo mysql <<'SQL'

CREATE USER IF NOT EXISTS 'health'@'localhost' IDENTIFIED BY 'ChangeMe _Health!';

GRANT SELECT ON demo. * TO 'health'@'localhost';

FLUSH PRIVILEGES;

SQL
```

Test :

```bash
mysql --user=health --password=ChangeMe _Health! --host=localhost -e "SELECT 1, NOW();"
```

---

## 5) Slow query log (utile pour l’atelier “rotation slow log”)

**Explications (ce que vous allez modifier)** 

* On active un slow log dédié à MariaDB avec un seuil **bas**  (1s) pour la démo.

* Vous pouvez remonter ce seuil plus tard (ex. `long _query _time=3`).

**Éditez**  `/etc/mysql/mariadb.conf.d/50-server.cnf` et **ajoutez**  (dans la section ` [mysqld]`) :

```
slow _query _log = ON

slow _query _log _file = /var/log/mysql/mariadb-slow.log

long _query _time = 1
```

Créez le fichier et fixez les droits :

```bash
sudo install -o mysql -g adm -m 640 /dev/null /var/log/mysql/mariadb-slow.log

sudo systemctl restart mariadb
```

Vérif :

```bash
sudo mysql -e "SHOW VARIABLES LIKE 'slow _query _log%';"

sudo ls -l /var/log/mysql/mariadb-slow.log
```

Générer une requête lente de test (ex. un `SLEEP(2)` ou une jointure naïve) :

```bash
sudo mysql -e "SELECT SLEEP(2);"

sudo tail -n 20 /var/log/mysql/mariadb-slow.log
```

---

## 6) Sanity checks rapides

```bash
 # MariaDB up ?

sudo systemctl is-active mariadb



 # ping SQL (via socket root)

mysqladmin --defaults-file=/root/.my.cnf ping



 # lecture de données

sudo mysql -e "SELECT  * FROM demo.notes LIMIT 3;"



 # emplacement binaire mysql/mysqldump (utile pour services)

command -v mysql

command -v mysqldump
```

---

## 7) Ce que vous avez maintenant (terrain prêt)

* MariaDB **installée** , **démarrée** , et testée.

***root via socket**  prêt pour scripts **admin**  (purge binlogs, migrations, etc.).

* Comptes **backup**  (dump global minimal) et **health**  (read demo.   *).

* Dossiers **/opt/db** , **/opt/app** , **/var/backups/mariadb**  créés pour les prochains ateliers.

**Slow log**  activé pour pouvoir implémenter un ** timer de rotation** .

* Données de **démo**  prêtes (base `demo`, table `notes`).

> On peut maintenant enchaîner **Atelier 1**  (maintenance ANALYZE/OPTIMIZE), **Atelier 2**  (health + timer 5 min avec envoi mail Postfix), **Atelier 3**  (backup chaque minute pour la démo), etc.

> Tu as demandé “un par un” : dis-moi par lequel tu veux commencer, et je te donne l’atelier prêt à coller.

---

## 8) Nettoyage (optionnel, sans désinstaller MariaDB)

```bash
 # Retirer les comptes de démo

sudo mysql -e "DROP USER IF EXISTS 'backup'@'localhost';"

sudo mysql -e "DROP USER IF EXISTS 'health'@'localhost';"

sudo mysql -e "DROP DATABASE IF EXISTS demo;"



 # Retirer fichiers créés

sudo rm -f /root/.my.cnf-backup 2>/dev/null || true

sudo rm -rf /opt/db /opt/app

sudo rm -rf /var/backups/mariadb

sudo rm -f /var/log/mysql/mariadb-slow.log



 # (si vous avez modifié 50-server.cnf, revenez en arrière et redémarrez mariadb)
```

---

### ✅ Prochaine étape

La connection à maria db au niveau terminal pour faire un premier contact
