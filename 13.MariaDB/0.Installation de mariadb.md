# #Introduction MariaDB vs MySQL : Comprendre les diff√©rences

## üìú Contexte historique

**MySQL** a √©t√© cr√©√© en 1995 par une soci√©t√© su√©doise, MySQL AB. En 2008, Sun Microsystems rach√®te MySQL AB, puis en 2010, **Oracle rach√®te Sun Microsystems**. Cela a inqui√©t√© la communaut√© open-source car Oracle est surtout connu pour sa base de donn√©es propri√©taire Oracle Database.

**MariaDB** est n√© en 2009 en tant que **fork de MySQL**, cr√©√© par **Michael "Monty" Widenius** (le cr√©ateur original de MySQL) et son √©quipe. Le nom vient de la deuxi√®me fille de Monty, Maria (My pour sa premi√®re fille, My).

---

## üîç Principales diff√©rences techniques

### 1. **Licence et philosophie**

- **MySQL** : Appartient √† Oracle. Dual-licence (GPL + commerciale). Certains d√©veloppeurs craignent une orientation plus commerciale.
- **MariaDB** : Enti√®rement open-source (sous licence GPL), maintenu par la fondation MariaDB et la communaut√©.

### 2. **Moteurs de stockage**

- **MySQL** : Se concentre sur InnoDB (Oracle). A retir√© certains moteurs comme MyISAM dans les versions r√©centes.
- **MariaDB** : Supporte plus de moteurs, dont :
  - **Aria** (remplacement de MyISAM, avec recovery crash-safe)
  - **ColumnStore** (pour l'analytique)
  - **MyRocks** (optimis√© pour le stockage SSD)
  - **Spider** (pour le sharding)

### 3. **Performances et optimisations**

- **MariaDB 10+** inclut des optimisations notables :
  - Thread pool (meilleure gestion des connexions)
  - Optimisations sp√©cifiques pour les requ√™tes complexes
  - **Parallel replication** (meilleure que MySQL jusqu'√† r√©cemment)

### 4. **Fonctionnalit√©s avanc√©es**

**MariaDB offre des fonctionnalit√©s absentes de MySQL :**

- **WITH ROLLUP** dans GROUP BY
- **INVISIBLE columns** (colonnes qui existent mais ne sont pas visibles dans SELECT *)
- **System-versioned tables** (historisation automatique des donn√©es)
- **Sequences** (objets de base de donn√©es pour g√©n√©rer des s√©quences)
- **Fonctions JSON plus √©tendues**

### 5. **Compatibilit√©**

- MariaDB se veut **drop-in replacement** pour MySQL
- M√™me structure de fichiers, m√™mes APIs (PHP, Python, etc.)
- M√™mes commandes (`mysql`, `mysqldump`, etc.)
- En pratique, tr√®s peu de modifications n√©cessaires pour migrer

---

## üìä Tableau comparatif simplifi√©

| Aspect              | MySQL                                | MariaDB                                            |
| ------------------- | ------------------------------------ | -------------------------------------------------- |
| **Cr√©ation**        | 1995                                 | 2009 (fork de MySQL)                               |
| **√âditeur**         | Oracle                               | Fondation MariaDB (communaut√©)                     |
| **Licence**         | Dual (GPL + commercial)              | GPL pure                                           |
| **Moteurs inclus**  | InnoDB (prioritaire)                 | Aria, ColumnStore, MyRocks, Spider, etc.           |
| **Optimisations**   | Standard                             | Thread pool, r√©plication parall√®le, etc.           |
| **Fonctionnalit√©s** | Standards SQL + certaines extensions | Toutes celles de MySQL + extensions additionnelles |
| **Communaut√©**      | Large mais g√©r√©e par Oracle          | Tr√®s active, orient√©e communaut√©                   |

---

## üöÄ Pourquoi choisir MariaDB ?

### Avantages de MariaDB :

1. **Innovation plus rapide** : La communaut√© apporte des fonctionnalit√©s nouvelles rapidement
2. **Plus de choix** : Multiples moteurs de stockage adapt√©s √† diff√©rents cas d'usage
3. **Transparence** : D√©veloppement ouvert, pas de surprises commerciales
4. **Meilleure performance** dans certains sc√©narios (r√©plication, requ√™tes complexes)
5. **Gratuit√© totale** : M√™me pour les fonctionnalit√©s avanc√©es

### Quand MySQL reste pertinent :

1. **Environnements d'entreprise** o√π Oracle fournit un support commercial
2. **Int√©gration avec d'autres produits Oracle**
3. **Stabilit√© extr√™me** n√©cessaire (bien que MariaDB soit √©galement tr√®s stable)

---

## üîÑ Migration de MySQL vers MariaDB

La migration est g√©n√©ralement simple :

```bash
# 1. Arr√™ter MySQL
sudo systemctl stop mysql

# 2. D√©sinstaller MySQL
sudo apt remove mysql-server

# 3. Installer MariaDB
sudo apt install mariadb-server

# 4. D√©marrer MariaDB
sudo systemctl start mariadb

# 5. V√©rifier la migration
mysql -u root -p -e "SELECT VERSION();"
```

**Important** : Toujours faire un backup avant migration !

---

## üß™ Exemple de fonctionnalit√© unique √† MariaDB

### Colonnes invisibles (MariaDB 10.3+)

```sql
-- Cr√©er une table avec une colonne invisible
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    password_hash VARCHAR(255) INVISIBLE
);

-- Ins√©rer des donn√©es (doit sp√©cifier toutes les colonnes visibles)
INSERT INTO users (name, password_hash) 
VALUES ('Alice', 'hash123');

-- SELECT * ne montre pas la colonne invisible
SELECT * FROM users;
-- R√©sultat : seulement id et name

-- Pour voir la colonne invisible, il faut la nommer explicitement
SELECT id, name, password_hash FROM users;
```





# Atelier 0 ‚Äî Installation de MariaDB et pr√©paration de l'environnement

## Objectifs p√©dagogiques

√Ä la fin de cet atelier, vous serez capable de :

1. Installer MariaDB sur une distribution Debian/Ubuntu
2. Comprendre l'architecture de base d'une installation MariaDB
3. Configurer l'authentification par socket pour l'utilisateur root
4. Cr√©er une structure de r√©pertoires coh√©rente pour la gestion de bases de donn√©es
5. Configurer et comprendre le slow query log
6. Cr√©er des utilisateurs SQL avec des privil√®ges granulaires

---

## Introduction

MariaDB est un syst√®me de gestion de base de donn√©es relationnelle (SGBDR) open-source, fork de MySQL. Dans cet atelier, nous allons :

1. **Installer** MariaDB et ses outils clients
2. **Configurer** l'environnement pour les ateliers futurs
3. **Comprendre** les concepts cl√©s via des d√©monstrations pratiques

---

## 0) Installation de MariaDB

### Pourquoi ces commandes ?

Les commandes suivantes mettent √† jour la liste des paquets disponibles puis installent MariaDB et son client.

```bash
# Actualise la liste des paquets disponibles dans les d√©p√¥ts
sudo apt update

# Installe le serveur MariaDB et l'outil client
# -y : r√©pond automatiquement "oui" aux questions de confirmation
sudo apt install -y mariadb-server mariadb-client
```

### D√©marrer et v√©rifier le service

```bash
# Active et d√©marre imm√©diatement le service MariaDB
# --now : d√©marre le service en plus de l'activer au d√©marrage
sudo systemctl enable --now mariadb

# Affiche le statut du service (actif/inactif, logs r√©cents)
sudo systemctl status mariadb
```

**√Ä v√©rifier** : Le statut doit indiquer "active (running)". Si ce n'est pas le cas, consultez les logs avec `sudo journalctl -u mariadb`.

---

## 1) Configuration des r√©pertoires de logs

### Pourquoi s√©parer les logs ?

Par d√©faut, MariaDB utilise `/var/log/mysql/`. Nous cr√©ons ce r√©pertoire avec des permissions sp√©cifiques pour des raisons de s√©curit√© et d'organisation.

```bash
# Cr√©e le r√©pertoire /var/log/mysql avec des permissions sp√©cifiques
# -d : cr√©e un r√©pertoire
# -o mysql : propri√©taire = utilisateur mysql
# -g adm : groupe = adm (groupe administrateur syst√®me)
# -m 2750 : permissions = 2750 (2 = sticky bit pour h√©ritage groupe)
#           7 = rwx pour propri√©taire, 5 = rx pour groupe, 0 = rien pour autres
sudo install -d -o mysql -g adm -m 2750 /var/log/mysql

# Cr√©e un fichier vide pour le slow query log
# /dev/null : source vide, cr√©e donc un fichier vide
# -m 640 : rw- pour propri√©taire, r-- pour groupe, --- pour autres
sudo install -o mysql -g adm -m 640 /dev/null /var/log/mysql/mariadb-slow.log
```

---

## 2) Le fichier de configuration principal : `/etc/mysql/mariadb.conf.d/50-server.cnf`

### Importance de ce fichier

Ce fichier est **le c≈ìur de la configuration** de MariaDB. Il contient tous les param√®tres qui contr√¥lent :

- La m√©moire allou√©e
- Le comportement des logs
- La s√©curit√©
- Les performances

**D√©monstration** : Voyons la structure actuelle de la configuration :

```bash
# Affiche la section [mysqld] du fichier de configuration
sudo grep -A 20 "^\[mysqld\]" /etc/mysql/mariadb.conf.d/50-server.cnf
```

### Configuration du slow query log

Le slow query log enregistre **toutes les requ√™tes qui prennent plus de temps qu'un seuil d√©fini**. C'est essentiel pour :

- Identifier les goulots d'√©tranglement
- Optimiser les performances
- D√©tecter les requ√™tes mal √©crites

√âditez le fichier de configuration :

```bash
# Ouvre le fichier de configuration avec nano (ou utilisez vim)
sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
```

Ajoutez ou modifiez ces lignes dans la section `[mysqld]` :

```ini
[mysqld]
# Active le log des requ√™tes lentes
slow_query_log = ON

# Sp√©cifie le fichier de log (celui que nous avons cr√©√©)
slow_query_log_file = /var/log/mysql/mariadb-slow.log

# Seuil en secondes : toute requ√™te prenant plus de 1 seconde sera logg√©e
long_query_time = 1

# Format de sortie : FILE pour √©crire dans un fichier
log_output = FILE
```

**Explication des param√®tres** :

- `slow_query_log = ON` : Active la fonctionnalit√©
- `slow_query_log_file` : O√π √©crire les logs
- `long_query_time = 1` : Seuil de 1 seconde (ajustable selon vos besoins)
- `log_output = FILE` : √âcriture dans un fichier (vs TABLE pour stocker dans la DB)

Red√©marrez MariaDB pour appliquer les changements :

```bash
sudo systemctl restart mariadb
```

**V√©rification** :

```bash
# V√©rifie que les param√®tres sont bien appliqu√©s
sudo mysql -e "SHOW VARIABLES LIKE 'slow_query_log%';"
sudo mysql -e "SHOW VARIABLES LIKE 'long_query_time';"

# V√©rifie que le fichier de log existe
sudo ls -l /var/log/mysql/mariadb-slow.log
```

---

## 3) Authentification root par socket

### Qu'est-ce que l'authentification par socket ?

Sur Debian/Ubuntu, MariaDB est configur√© par d√©faut pour permettre √† l'utilisateur **root du syst√®me** de se connecter **sans mot de passe** via le socket Unix. Ce m√©canisme est plus s√©curis√© qu'un mot de passe car :

- Il n√©cessite un acc√®s root au syst√®me
- Aucun mot de passe n'est transmis sur le r√©seau
- Il fonctionne seulement en local

**Test de connexion** :

```bash
# -e : ex√©cute la commande SQL directement depuis le terminal
sudo mysql -e "SELECT VERSION();"
```

### Cr√©ation du fichier de configuration client pour root

Le fichier `~/.my.cnf` permet de stocker les param√®tres de connexion pour √©viter de les retaper √† chaque fois.

```bash
# Cr√©e le fichier de configuration avec les param√®tres de connexion
sudo tee /root/.my.cnf > /dev/null << EOF
[client]
user=root
host=localhost
# Note : pas de mot de passe car nous utilisons l'authentification par socket
EOF

# S√©curise le fichier (lecture/√©criture seulement par root)
sudo chmod 600 /root/.my.cnf
```

**Explication du format** :

- `[client]` : Section pour les param√®tres du client MySQL
- `user=root` : Utilisateur par d√©faut
- `host=localhost` : Connexion locale (pas via r√©seau)

**Test avec le nouveau fichier** :

```bash
# Maintenant vous pouvez vous connecter sans sp√©cifier d'utilisateur
sudo mysql -e "SELECT CURRENT_USER();"
# Devrait afficher : root@localhost
```

---

## 4) Structure des r√©pertoires pour nos ateliers

Une bonne organisation est essentielle pour maintenir un environnement propre.

```bash
# Scripts de base de donn√©es et migrations
sudo mkdir -p /opt/db/migrations
# -p : cr√©e les r√©pertoires parents si n√©cessaire

# Application factice (pour simuler un environnement de production)
sudo mkdir -p /opt/app

# Sauvegardes de base de donn√©es
sudo mkdir -p /var/backups/mariadb

# R√©pertoire temporaire pour les travaux en cours
sudo mkdir -p /var/tmp

# Assigne la propri√©t√© √† root
sudo chown -R root:root /opt/db /opt/app /var/backups/mariadb /var/tmp
```

**Arborescence cr√©√©e** :

```
/opt/
‚îú‚îÄ‚îÄ db/          # Scripts et migrations de base de donn√©es
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îú‚îÄ‚îÄ app/         # Application factice
/var/
‚îú‚îÄ‚îÄ backups/
‚îÇ   ‚îî‚îÄ‚îÄ mariadb/ # Sauvegardes de bases de donn√©es
‚îî‚îÄ‚îÄ tmp/         # Fichiers temporaires
```

---

## 5) Base de donn√©es de d√©monstration

Cr√©ons une base simple pour tester et d√©montrer les fonctionnalit√©s.

```bash
# Ex√©cute plusieurs commandes SQL en une seule fois
sudo mysql <<'SQL'
-- Cr√©e la base 'demo' si elle n'existe pas
CREATE DATABASE IF NOT EXISTS demo;

-- Utilise la base 'demo'
USE demo;

-- Cr√©e une table simple pour les notes
CREATE TABLE IF NOT EXISTS notes (
  id INT PRIMARY KEY AUTO_INCREMENT,  -- Identifiant unique auto-incr√©ment√©
  txt VARCHAR(255) NOT NULL,          -- Texte de la note (max 255 caract√®res)
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- Date de cr√©ation automatique
);

-- Ins√®re des donn√©es de test
INSERT INTO notes (txt) VALUES 
  ('Premi√®re note : Hello'),
  ('Deuxi√®me note : World'),
  ('Troisi√®me note : MariaDB est pr√™t');

-- Affiche ce que nous avons ins√©r√©
SELECT * FROM notes;
SQL
```

**V√©rification** :

```bash
# Compte le nombre d'enregistrements
sudo mysql -e "SELECT COUNT(*) AS nombre_de_notes FROM demo.notes;"

# Affiche les notes avec leur date de cr√©ation
sudo mysql -e "SELECT id, txt, created_at FROM demo.notes ORDER BY id;"
```

---

## 6) Cr√©ation d'utilisateurs avec privil√®ges sp√©cifiques

### Pourquoi cr√©er des utilisateurs d√©di√©s ?

La s√©curit√© impose le principe du moindre privil√®ge : chaque utilisateur ne doit avoir que les droits n√©cessaires √† sa t√¢che.

### 6.1 Utilisateur pour les sauvegardes (`backup`)

Cet utilisateur aura **juste les droits n√©cessaires** pour effectuer des sauvegardes compl√®tes.

```bash
sudo mysql <<'SQL'
-- Cr√©e l'utilisateur 'backup' s'il n'existe pas
CREATE USER IF NOT EXISTS 'backup'@'localhost' 
IDENTIFIED BY 'ChangeMe_Backup!';  -- Mot de passe √† changer en production

-- Accorde les privil√®ges n√©cessaires pour mysqldump
GRANT 
  RELOAD,              -- Recharge les tables (pour verrouillage)
  PROCESS,             -- Voir les processus en cours
  LOCK TABLES,         -- Verrouiller les tables pendant le dump
  REPLICATION CLIENT,  -- Pour les backups coh√©rents (master-slave)
  SELECT,              -- Lire les donn√©es
  SHOW VIEW,           -- Voir les vues
  EVENT,               -- Sauvegarder les √©v√©nements
  TRIGGER              -- Sauvegarder les triggers
ON *.*                 -- Toutes les bases, toutes les tables
TO 'backup'@'localhost';

-- Applique les changements de privil√®ges
FLUSH PRIVILEGES;
SQL
```

**Explication des privil√®ges** :

- `RELOAD` : N√©cessaire pour `FLUSH TABLES WITH READ LOCK` (sauvegarde coh√©rente)
- `PROCESS` : Pour voir quelles requ√™tes sont en cours
- `LOCK TABLES` : Verrouille les tables pendant la sauvegarde
- `REPLICATION CLIENT` : Pour obtenir la position du journal binaire

### 6.2 Utilisateur pour les checks de sant√© (`health`)

Un utilisateur avec **un acc√®s minimal** pour v√©rifier que la base r√©pond.

```bash
sudo mysql <<'SQL'
CREATE USER IF NOT EXISTS 'health'@'localhost' 
IDENTIFIED BY 'ChangeMe_Health!';

-- Accorde seulement le droit de SELECT sur la base 'demo'
GRANT SELECT ON demo.* TO 'health'@'localhost';

FLUSH PRIVILEGES;
SQL
```

**Test des utilisateurs** :

```bash
# Test de l'utilisateur backup (doit pouvoir voir les processus)
mysql --user=backup --password=ChangeMe_Backup! \
  -e "SHOW PROCESSLIST;"

# Test de l'utilisateur health (doit pouvoir lire demo.notes)
mysql --user=health --password=ChangeMe_Health! \
  -e "SELECT COUNT(*) FROM demo.notes;"

# Test n√©gatif : health ne doit PAS pouvoir cr√©er de tables
mysql --user=health --password=ChangeMe_Health! \
  -e "CREATE TABLE demo.test_interdit (id INT);" 2>&1 | grep -i "denied"
# Devrait afficher une erreur d'autorisation
```

---

## 7) D√©monstration du slow query log

### G√©n√©rons une requ√™te lente volontairement

```bash
# Cette requ√™te va durer 2 secondes (d√©passera notre seuil de 1s)
sudo mysql -e "SELECT 'D√©but de la requ√™te lente', NOW();
               SELECT SLEEP(2);
               SELECT 'Fin de la requ√™te lente', NOW();"
```

### Examinons le log

```bash
# Affiche les derni√®res lignes du slow query log
sudo tail -n 10 /var/log/mysql/mariadb-slow.log
```

**Ce que vous devriez voir** :

```
# Time: 2024-01-15T10:30:00.123456Z
# User@Host: root[root] @ localhost []
# Thread_id: 5  Schema:   QC_hit: No
# Query_time: 2.000123  Lock_time: 0.000000  Rows_sent: 1  Rows_examined: 0
SET timestamp=1673785800;
SELECT SLEEP(2);
```

**Analyse du log** :

- `Query_time: 2.000123` : La requ√™te a pris 2 secondes
- `Lock_time: 0.000000` : Temps d'attente pour verrou
- `Rows_sent: 1` : Nombre de lignes renvoy√©es
- `Rows_examined: 0` : Nombre de lignes examin√©es (0 car SLEEP ne scanne pas de table)

---

## 8) V√©rifications finales

Ex√©cutez cette s√©rie de tests pour v√©rifier que tout fonctionne :

```bash
echo "=== V√©rification 1: Service MariaDB ==="
sudo systemctl is-active mariadb

echo -e "\n=== V√©rification 2: Ping via socket ==="
mysqladmin --defaults-file=/root/.my.cnf ping

echo -e "\n=== V√©rification 3: Donn√©es de d√©mo ==="
sudo mysql -e "SELECT * FROM demo.notes;"

echo -e "\n=== V√©rification 4: Chemins des ex√©cutables ==="
command -v mysql
command -v mysqldump

echo -e "\n=== V√©rification 5: Utilisateurs cr√©√©s ==="
sudo mysql -e "SELECT user, host FROM mysql.user WHERE user IN ('backup', 'health');"

echo -e "\n=== V√©rification 6: Slow query log ==="
sudo ls -lh /var/log/mysql/mariadb-slow.log

echo -e "\n=== V√©rification 7: Structure des r√©pertoires ==="
ls -ld /opt/db /opt/app /var/backups/mariadb
```

---

## 9) Nettoyage (optionnel)

Si vous souhaitez tout r√©initialiser sans d√©sinstaller MariaDB :

```bash
echo "Suppression des utilisateurs de d√©mo..."
sudo mysql -e "DROP USER IF EXISTS 'backup'@'localhost';"
sudo mysql -e "DROP USER IF EXISTS 'health'@'localhost';"

echo "Suppression de la base de d√©mo..."
sudo mysql -e "DROP DATABASE IF EXISTS demo;"

echo "Nettoyage des fichiers de configuration..."
sudo rm -f /root/.my.cnf 2>/dev/null || true

echo "Nettoyage des r√©pertoires de travail..."
sudo rm -rf /opt/db /opt/app
sudo rm -rf /var/backups/mariadb

echo "Remise √† z√©ro de la configuration du slow log..."
# R√©initialise la configuration
sudo sed -i '/^slow_query_log/d' /etc/mysql/mariadb.conf.d/50-server.cnf
sudo sed -i '/^slow_query_log_file/d' /etc/mysql/mariadb.conf.d/50-server.cnf
sudo sed -i '/^long_query_time/d' /etc/mysql/mariadb.conf.d/50-server.cnf
sudo sed -i '/^log_output/d' /etc/mysql/mariadb.conf.d/50-server.cnf

echo "Red√©marrage de MariaDB..."
sudo systemctl restart mariadb

echo "Nettoyage termin√©. MariaDB est toujours install√© mais l'environnement est r√©initialis√©."
```

---

## ‚úÖ R√©sum√© et prochaines √©tapes

### Ce que vous avez accompli

1. ‚úÖ **Installation** de MariaDB et v√©rification du service
2. ‚úÖ **Configuration** du slow query log avec d√©monstration pratique
3. ‚úÖ **Authentification** root par socket avec fichier `.my.cnf`
4. ‚úÖ **Structure** d'arborescence pour les ateliers futurs
5. ‚úÖ **Base de donn√©es** de d√©monstration avec donn√©es de test
6. ‚úÖ **Utilisateurs** sp√©cifiques avec privil√®ges granulaires
7. ‚úÖ **V√©rifications** compl√®tes du syst√®me

### Concepts cl√©s √† retenir

- **Authentification par socket** : Plus s√©curis√©e que par mot de passe pour l'admin local
- **Principe du moindre privil√®ge** : Donner seulement les droits n√©cessaires
- **Slow query log** : Outil essentiel pour l'optimisation des performances
- **Fichier `my.cnf`** : Centralise la configuration du client MySQL

### Prochain atelier

Maintenant que l'environnement est pr√™t, nous pouvons passer √† l'**Atelier 1 : Maintenance des bases de donn√©es** o√π nous aborderons :

- Les op√©rations `ANALYZE TABLE` et `OPTIMIZE TABLE`
- La gestion des indexes
- Les statistiques des tables

---

## üìö Pour aller plus loin

### Documentation officielle

- [Documentation MariaDB](https://mariadb.com/kb/en/documentation/)
- [Configuration du slow query log](https://mariadb.com/kb/en/slow-query-log-overview/)

### Commandes utiles √† explorer

```bash
# Voir toutes les variables de configuration
sudo mysql -e "SHOW VARIABLES;"

# Voir les processus en cours
sudo mysql -e "SHOW PROCESSLIST;"

# Informations sur les bases de donn√©es
sudo mysql -e "SHOW DATABASES;"

# Informations sur les privil√®ges d'un utilisateur
sudo mysql -e "SHOW GRANTS FOR 'backup'@'localhost';"
```

### Bonnes pratiques √† retenir

1. **Toujours** s√©curiser les fichiers `.my.cnf` avec `chmod 600`
2. **Jamais** utiliser l'utilisateur root pour les applications
3. **Toujours** tester les sauvegardes apr√®s les avoir cr√©√©es
4. **Configurer** des alertes pour les requ√™tes trop lentes en production
