# Atelier — Gestion avancée des rôles dans MariaDB

## Objectif pratique

Maîtriser la création, l'attribution et la gestion des rôles dans MariaDB pour simplifier l'administration des permissions dans un environnement multi-utilisateurs.

---

## Mise en situation

Vous êtes l'administrateur d'une base de données pour une entreprise. L'équipe s'agrandit et vous devez gérer efficacement les accès de 3 types d'utilisateurs : les lecteurs, les éditeurs et les administrateurs. Au lieu d'attribuer des permissions individuellement à chaque nouvel employé, vous allez utiliser des rôles.

---

## Étape 1 : Préparation de l'environnement

Connectez-vous à MariaDB en tant qu'administrateur :

```bash
mysql -u root -p
```

Créez la base de données de démonstration :

```sql
CREATE DATABASE IF NOT EXISTS entreprise_db;
```

Créez quelques tables pour simuler un environnement réel :

```sql
USE entreprise_db;

CREATE TABLE clients (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100),
    email VARCHAR(100),
    actif BOOLEAN DEFAULT true
);

CREATE TABLE commandes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    client_id INT,
    montant DECIMAL(10,2),
    date_commande DATE,
    FOREIGN KEY (client_id) REFERENCES clients(id)
);

CREATE TABLE employes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100),
    departement VARCHAR(50)
);

-- Insérez quelques données de test
INSERT INTO clients (nom, email) VALUES
('Marie Martin', 'marie@entreprise.com'),
('Pierre Durand', 'pierre@entreprise.com');

INSERT INTO commandes (client_id, montant, date_commande) VALUES
(1, 1500.00, '2024-01-15'),
(2, 2300.50, '2024-01-16');
```

---

## Étape 2 : Création des rôles de base

### Créez trois rôles correspondant aux profils de votre entreprise :

**Rôle 1 : lecteur_entreprise** (peut seulement consulter les données)

```sql
CREATE ROLE lecteur_entreprise;
```

**Rôle 2 : editeur_entreprise** (peut lire et modifier les données)

```sql
CREATE ROLE editeur_entreprise;
```

**Rôle 3 : admin_entreprise** (a tous les droits)

```sql
CREATE ROLE admin_entreprise;
```

Vérifiez que les rôles sont créés :

```sql
SELECT * FROM mysql.user WHERE user LIKE '%entreprise';
```

---

## Étape 3 : Attribution des permissions aux rôles

### Pour le rôle lecteur_entreprise :

```sql
GRANT SELECT ON entreprise_db.* TO lecteur_entreprise;
```

### Pour le rôle editeur_entreprise :

```sql
GRANT SELECT, INSERT, UPDATE ON entreprise_db.* TO editeur_entreprise;
```

### Pour le rôle admin_entreprise :

```sql
GRANT ALL PRIVILEGES ON entreprise_db.* TO admin_entreprise;
```

Vérifiez les permissions attribuées à chaque rôle :

```sql
SHOW GRANTS FOR lecteur_entreprise;
SHOW GRANTS FOR editeur_entreprise;
SHOW GRANTS FOR admin_entreprise;
```

---

## Étape 4 : Création des utilisateurs

Créez trois utilisateurs correspondant à des employés fictifs :

```sql
CREATE USER 'alice_lecteur'@'localhost' IDENTIFIED BY 'Pass123!';
CREATE USER 'bob_editeur'@'localhost' IDENTIFIED BY 'Pass456!';
CREATE USER 'charlie_admin'@'localhost' IDENTIFIED BY 'Pass789!';
```

Attribuez les rôles aux utilisateurs :

```sql
GRANT lecteur_entreprise TO 'alice_lecteur'@'localhost';
GRANT editeur_entreprise TO 'bob_editeur'@'localhost';
GRANT admin_entreprise TO 'charlie_admin'@'localhost';
```

---

## Étape 5 : Test des rôles

### Test 1 : Connexion en tant que lecteur

Ouvrez un nouveau terminal et connectez-vous en tant qu'Alice :

```bash
mysql -u alice_lecteur -p
```

Activez son rôle :

```sql
SET ROLE lecteur_entreprise;
```

Testez les permissions :

```sql
-- Doit fonctionner
USE entreprise_db;
SELECT * FROM clients;

-- Doit échouer (pas de permission d'écriture)
INSERT INTO clients (nom, email) VALUES ('Test', 'test@test.com');
```

### Test 2 : Connexion en tant qu'éditeur

Dans un autre terminal, connectez-vous en tant que Bob :

```bash
mysql -u bob_editeur -p
```

Activez son rôle :

```sql
SET ROLE editeur_entreprise;
```

Testez les permissions :

```sql
-- Doit fonctionner (lecture)
SELECT * FROM commandes;

-- Doit fonctionner (écriture)
INSERT INTO clients (nom, email) VALUES ('Nouveau Client', 'client@test.com');

-- Doit échouer (pas de permission pour supprimer)
DELETE FROM clients WHERE id = 1;
```

---

## Étape 6 : Activation automatique des rôles

Plutôt que de devoir exécuter `SET ROLE` à chaque connexion, vous pouvez définir des rôles par défaut.

Pour Alice, définissez son rôle comme activé par défaut :

```sql
-- Reconnectez-vous en tant que root
mysql -u root -p

-- Définir le rôle par défaut pour Alice
SET DEFAULT ROLE lecteur_entreprise TO 'alice_lecteur'@'localhost';
```

Maintenant, quand Alice se connecte, son rôle sera automatiquement activé.

Testez :

```bash
mysql -u alice_lecteur -p -e "SHOW CURRENT_ROLE;"
```

---

## Étape 7 : Rôles avec permissions spécifiques

Créez un rôle spécialisé pour la gestion des clients seulement :

```sql
CREATE ROLE gestion_clients;

GRANT SELECT, INSERT, UPDATE ON entreprise_db.clients TO gestion_clients;
GRANT SELECT ON entreprise_db.commandes TO gestion_clients;

-- Créez un utilisateur pour ce rôle
CREATE USER 'david_clients'@'localhost' IDENTIFIED BY 'PassClients!';
GRANT gestion_clients TO 'david_clients'@'localhost';
SET DEFAULT ROLE gestion_clients TO 'david_clients'@'localhost';
```

Testez ce nouveau rôle :

```bash
mysql -u david_clients -p
```

```sql
-- Doit fonctionner
SELECT * FROM clients;
INSERT INTO clients (nom, email) VALUES ('David Client', 'david@test.com');

-- Doit échouer (pas d'accès à la table employes)
SELECT * FROM employes;
```

---

## Étape 8 : Hiérarchie de rôles

MariaDB permet d'imbriquer des rôles. Créez un rôle senior qui hérite des permissions d'un rôle de base.

Créez d'abord un rôle de base :

```sql
CREATE ROLE employe_base;
GRANT SELECT ON entreprise_db.* TO employe_base;
```

Créez un rôle senior qui ajoute des permissions :

```sql
CREATE ROLE employe_senior;
GRANT INSERT, UPDATE ON entreprise_db.* TO employe_senior;
```

Maintenant, attribuez les deux rôles à un utilisateur :

```sql
CREATE USER 'eva_senior'@'localhost' IDENTIFIED BY 'PassSenior!';
GRANT employe_base TO 'eva_senior'@'localhost';
GRANT employe_senior TO 'eva_senior'@'localhost';
```

Quand Eva active ses deux rôles :

```sql
SET ROLE employe_base, employe_senior;
```

Elle bénéficie des permissions combinées des deux rôles.

---

## Étape 9 : Gestion des rôles

### Afficher tous les rôles existants :

```sql
SELECT * FROM information_schema.applicable_roles;
```

### Voir quels utilisateurs ont un rôle spécifique :

```sql
SELECT * FROM mysql.role_edges WHERE TO_ROLE = 'lecteur_entreprise';
```

### Révoquer un rôle d'un utilisateur :

```sql
REVOKE lecteur_entreprise FROM 'alice_lecteur'@'localhost';
```

### Modifier les permissions d'un rôle :

```sql
-- Ajouter une permission
GRANT DELETE ON entreprise_db.clients TO editeur_entreprise;

-- Retirer une permission
REVOKE INSERT ON entreprise_db.employes FROM editeur_entreprise;
```

### Supprimer un rôle :

```sql
DROP ROLE IF EXISTS ancien_role;
```

---

## Exercice pratique

**Scénario** : Vous devez créer un système de gestion des accès pour une bibliothèque.

**Structure** :

- Table `livres` (id, titre, auteur, disponible)
- Table `membres` (id, nom, email, date_inscription)
- Table `emprunts` (id, membre_id, livre_id, date_emprunt, date_retour)

**À faire** :

1. Créez la base `bibliotheque` et les trois tables.

2. Créez trois rôles :
   
   - `membre_bibliotheque` : peut voir les livres disponibles
   - `bibliothecaire` : peut gérer les emprunts et retours
   - `administrateur_bibliotheque` : peut tout faire, y compris ajouter/supprimer des livres

3. Créez au moins un utilisateur par rôle.

4. Testez que chaque rôle a les bonnes permissions.

**Solution guidée** :

Pour la table `livres` :

```sql
CREATE TABLE livres (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titre VARCHAR(200),
    auteur VARCHAR(100),
    disponible BOOLEAN DEFAULT true
);
```

Pour le rôle `bibliothecaire` :

```sql
CREATE ROLE bibliothecaire;
GRANT SELECT, INSERT, UPDATE ON bibliotheque.emprunts TO bibliothecaire;
GRANT SELECT ON bibliotheque.livres TO bibliothecaire;
GRANT SELECT ON bibliotheque.membres TO bibliothecaire;
```

Testez votre implémentation en créant un utilisateur avec ce rôle et en essayant d'ajouter un emprunt.

---

## Cas réel : Migration depuis une gestion manuelle

Imaginez que votre entreprise gère actuellement les permissions manuellement. Vous avez 20 utilisateurs avec des permissions similaires. Voici comment migrer vers des rôles :

1. Identifiez les groupes d'utilisateurs avec des permissions similaires.

2. Créez des rôles pour chaque groupe.

3. Pour chaque utilisateur, notez ses permissions actuelles :
   
   ```sql
   SHOW GRANTS FOR 'utilisateur_existant'@'localhost';
   ```

4. Attribuez le rôle approprié à chaque utilisateur.

5. Testez que les nouvelles permissions via les rôles correspondent aux anciennes.

6. Supprimez les permissions individuelles une fois que les rôles fonctionnent.

---

## Pièges courants et solutions

### Problème 1 : "Le rôle n'est pas activé après connexion"

Solution : Utilisez `SET DEFAULT ROLE` ou ajoutez dans la configuration de l'utilisateur.

### Problème 2 : "Les permissions ne semblent pas fonctionner"

Solution : Vérifiez que le rôle est activé dans la session courante avec `SELECT CURRENT_ROLE();`.

### Problème 3 : "Un utilisateur avec plusieurs rôles a trop de permissions"

Solution : Révoquez le rôle inapproprié avec `REVOKE role FROM utilisateur;`.

### Problème 4 : "Je veux voir toutes les permissions d'un utilisateur"

Solution : Utilisez `SHOW GRANTS FOR utilisateur;` qui montre les rôles et les permissions directes.

---

## Bonnes pratiques

1. **Nommage cohérent** : Utilisez une convention (ex: `role_nomfonction`).

2. **Principle of Least Privilege** : Donnez seulement les permissions nécessaires.

3. **Documentation** : Maintenez une liste des rôles et de leurs permissions.

4. **Audit régulier** : Vérifiez périodiquement qui a quels rôles.

5. **Test systématique** : Testez toujours les nouveaux rôles avec un utilisateur de test avant de les déployer.

---

## Commandes de référence rapide

```sql
-- Création
CREATE ROLE nom_role;
GRANT permission ON base.table TO nom_role;
CREATE USER 'user'@'host' IDENTIFIED BY 'password';
GRANT nom_role TO 'user'@'host';

-- Activation
SET ROLE nom_role;
SET DEFAULT ROLE nom_role TO 'user'@'host';

-- Vérification
SELECT CURRENT_ROLE();
SHOW GRANTS;
SHOW GRANTS FOR 'user'@'host';

-- Modification
REVOKE permission ON base.table FROM nom_role;
REVOKE nom_role FROM 'user'@'host';

-- Suppression
DROP ROLE nom_role;
```

---

## À retenir

1. Les rôles simplifient la gestion des permissions pour plusieurs utilisateurs.

2. Un utilisateur peut avoir plusieurs rôles, et les permissions s'additionnent.

3. Les rôles doivent être activés explicitement (sauf si définis par défaut).

4. Utilisez `SHOW GRANTS` pour vérifier les permissions effectives.

5. Pensez en termes de fonctions (lecteur, éditeur, admin) plutôt qu'en termes d'utilisateurs individuels.

---

# Section supplémentaire : Gestion des rôles avec MySQL Workbench

## Limitations importantes

**MySQL Workbench ne permet PAS de créer ou gérer des rôles via l'interface graphique.**  
Toutes les opérations de rôles doivent être effectuées via des commandes SQL.

## Comment utiliser Workbench pour la gestion des rôles

### 1. Exécution des commandes SQL

Dans Workbench, ouvrez un nouvel onglet SQL et exécutez toutes les commandes de cet atelier normalement.

**Astuce** : Pour exécuter une seule commande, sélectionnez-la et appuyez sur `Ctrl+Shift+Enter`.

### 2. Visualisation des rôles existants

Bien que vous ne puissiez pas créer des rôles graphiquement, vous pouvez les visualiser avec cette requête :

```sql
SELECT 
    user AS role_name,
    host,
    account_locked,
    'ROLE' AS type
FROM mysql.user 
WHERE account_locked = 'Y'
ORDER BY user;
```

### 3. Gestion des utilisateurs via l'interface graphique

Workbench permet de créer des utilisateurs graphiquement :

1. Allez dans **Management → Users and Privileges**
2. Cliquez sur **Add Account**
3. Remplissez les informations de l'utilisateur
4. **Important** : N'attribuez PAS de permissions ici, utilisez plutôt les commandes SQL pour attribuer des rôles

### 4. Visualisation des permissions attribuées via les rôles

Pour voir quelles permissions un utilisateur a via ses rôles :

```sql
-- Dans l'onglet SQL de Workbench
SHOW GRANTS FOR 'alice_lecteur'@'localhost';
```

### 5. Création de connexions de test

Pour tester les rôles dans Workbench :

1. Menu **Database → Manage Connections...**
2. Cliquez sur **New**
3. Créez une connexion avec les identifiants de l'utilisateur test
4. Testez les permissions avec cette nouvelle connexion

### 6. Script réutilisable pour Workbench

Créez un fichier SQL dans Workbench avec ce template :

```sql
-- ============================================
-- GESTION DES RÔLES - TEMPLATE WORKBENCH
-- ============================================

-- 1. CRÉATION DES RÔLES
-- CREATE ROLE nom_role;

-- 2. PERMISSIONS DES RÔLES
-- GRANT SELECT ON base.table TO nom_role;

-- 3. CRÉATION UTILISATEURS (via Workbench UI)
-- CREATE USER 'user'@'localhost' IDENTIFIED BY 'password';

-- 4. ATTRIBUTION DES RÔLES
-- GRANT nom_role TO 'user'@'localhost';

-- 5. VÉRIFICATION
-- SHOW GRANTS FOR 'user'@'localhost';
```

### 7. Documentation dans Workbench

Utilisez les fonctionnalités d'export de Workbench pour documenter votre configuration :

1. Exécutez : `SELECT * FROM mysql.user WHERE account_locked = 'Y';`
2. Cliquez sur **Export** (icône disquette) dans le panneau des résultats
3. Choisissez **Export to Excel** pour documentation

### 8. Recommandation pour Workbench

Pour la gestion des rôles avec Workbench :

1. **Utilisez toujours l'onglet SQL** pour les commandes de rôle
2. **Utilisez l'interface graphique** seulement pour créer les utilisateurs de base
3. **Testez systématiquement** avec de nouvelles connexions
4. **Documentez avec des exports** Excel/CSV

**Rappel** : Workbench est un excellent outil pour exécuter des requêtes SQL, mais pour les rôles MariaDB, il n'offre pas d'interface graphique dédiée.
