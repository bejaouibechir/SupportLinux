

# **ARTICLE  – TECHNIQUE ETL CDC (Change Data Capture) AVEC MARIADB + MAXSCALE**

---

# 1. Introduction

L’ETL basé sur le **Change Data Capture (CDC)** vise à transférer les données **en continu**, sans recourir à des traitements batch lourds.  
Cette approche devient incontournable lorsque :

- les données doivent être synchronisées en quasi temps réel,

- un Data Warehouse doit suivre fidèlement une base opérationnelle,

- les APIs d'application ne peuvent pas exposer toutes les modifications.

La technique présentée repose exclusivement sur :

- les **binlogs MariaDB**,

- **MariaDB MaxScale** (binlogrouter, avrorouter, cdcrouter),

- la **réplication MariaDB** pour appliquer les changements vers une instance cible,

- **mysqlbinlog** pour visualiser ou rejouer les événements,

sans aucune ligne de code Python ou autre langage.  
Elle constitue une solution professionnelle, robuste et compréhensible par des profils non développeurs.

---

# 2. Architecture technique

L’architecture suivante illustre l’ensemble du pipeline CDC :

```
+---------------------------+     Binlogs      +---------------------------+     CDC/AVRO/JSON
|   MariaDB SOURCE (OLTP)   | ---------------> |         MaxScale           | -----------+
|  Base : shop_tx           |                  |  Binlogrouter/Avro/CDC     |            |
+---------------------------+                  +---------------------------+            |
                                                                                         |
                                                                                         v
                                                                 +--------------------------------------+
                                                                 |  MariaDB CIBLE (DW / Reporting)      |
                                                                 |  Base : shop_dw                      |
                                                                 +--------------------------------------+
```

**Points clés :**

- Le serveur source écrit toutes les modifications dans les **binlogs**.

- MaxScale les lit, les transforme, et peut exposer un flux CDC.

- Le serveur cible les récupère via **réplication** ou via un **rejeu ponctuel**.

- Aucun script custom n’est requis : seulement des outils MariaDB natifs.

---

# 3. Structure de la solution

L’atelier s’articule en 7 grandes étapes :

1. Installation de MaxScale

2. Préparation du serveur MariaDB source

3. Activation et configuration des binlogs

4. Configuration de MaxScale (Binlogrouter, Avro, CDC)

5. Visualisation du CDC via mysqlbinlog

6. Propagation des modifications vers un serveur cible (réplication)

7. Export et rejouage des binlogs (CDC → fichiers → base cible)

Chaque étape est accompagnée de commandes, explications, tests et résultats attendus.

---

# 4. Installation de MariaDB MaxScale

Les commandes ci-dessous installent MaxScale à partir du dépôt officiel MariaDB.  
Elles doivent être exécutées sur un serveur dédié (Linux).

## 4.1. Ajouter le dépôt MariaDB

Pour Debian/Ubuntu :

```bash
curl -LsS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash
```

Pour RHEL/CentOS/Alma/Rocky :

```bash
curl -LsS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash
sudo yum install maxscale
```

## 4.2. Installer MaxScale

```bash
sudo apt update
sudo apt install maxscale
```

## 4.3. Vérifier l’installation

```bash
maxscale --version
systemctl status maxscale
```

Résultat attendu : service actif et en cours d’exécution.

---

# 5. Préparation du serveur MariaDB source (shop_tx)

## 5.1. Activer les binlogs en mode ROW

Créer le fichier :

### Créer le fichier **/etc/mysql/conf.d/cdc_source.cnf** :

```ini
[mysqld]
server_id = 1
log_bin = mariadb-bin
binlog_format = ROW
expire_logs_days = 7
```

Redémarrer MariaDB :

```bash
sudo systemctl restart mariadb
```

## 5.2. Vérification

```sql
SHOW VARIABLES LIKE 'log_bin';
SHOW VARIABLES LIKE 'binlog_format';
```

Résultat attendu :

- `log_bin = ON`

- `binlog_format = ROW`

---

## 5.3. Créer un utilisateur dédié pour MaxScale

```sql
CREATE USER 'maxscale'@'%' IDENTIFIED BY 'Mot2PasseMaxScale!';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'maxscale'@'%';
FLUSH PRIVILEGES;
```

---

## 5.4. Créer la base et la table à suivre

```sql
CREATE DATABASE IF NOT EXISTS shop_tx;
USE shop_tx;

CREATE TABLE commandes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  client VARCHAR(100),
  montant DECIMAL(10,2),
  statut VARCHAR(20),
  date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

# 6. Configuration complète de MariaDB MaxScale (CDC)

MaxScale utilise différents modules :

- **binlogrouter** : lit les binlogs MariaDB

- **avrorouter** : convertit les événements en fichiers AVRO/JSON

- **cdcrouter** : expose un flux CDC

- **mariadbmon** : surveille l’état du serveur MariaDB source

## 6.1. Configuration du serveur source

### Créer le fichier **/etc/maxscale.cnf** :

```ini
[maxscale]
threads=auto

[server1]
type=server
address=192.168.10.10
port=3306
protocol=mariadbclient

[MariaDB-Monitor]
type=monitor
module=mariadbmon
servers=server1
user=maxscale
password=Mot2PasseMaxScale!
monitor_interval=5s
```

---

## 6.2. Configurer le Binlogrouter

```ini
[Binlog-Service]
type=service
router=binlogrouter
servers=server1
user=maxscale
password=Mot2PasseMaxScale!
binlogdir=/var/lib/maxscale/binlogs
```

---

## 6.3. Configurer l’AvroRouter (binlogs → AVRO/JSON)

```ini
[Avro-Service]
type=service
router=avrorouter
source=Binlog-Service
avrodir=/var/lib/maxscale/avro
match=shop_tx%
```

Notes :

- `match=shop_tx%` limite la capture aux tables de shop_tx.

- Le module Avro est intégré **par défaut** dans MaxScale, mais **non activé** tant qu’il n’est pas configuré ici.

---

## 6.4. Exposer un flux CDC

```ini
[CDC-Service]
type=service
router=cdcrouter
source=Avro-Service
```

Listener :

```ini
[CDC-Listener]
type=listener
service=CDC-Service
protocol=CDC
port=4001
```

---

## 6.5. Redémarrer MaxScale et vérifier

```bash
sudo systemctl restart maxscale
maxctrl list services
maxctrl list servers
```

Résultat attendu :

- Binlog-Service : Running

- Avro-Service : Running

- CDC-Service : Running

---

# 7. Visualiser les changements (CDC) avec mysqlbinlog

Cette section est essentielle pour un public non développeur : **aucun code**, seulement des outils natifs.

## 7.1. Lire un binlog existant

```bash
mysqlbinlog \
  --base64-output=DECODE-ROWS \
  --verbose \
  /var/lib/mysql/mariadb-bin.000001 | less
```

Le stagiaire doit voir :

- `### INSERT INTO commandes`

- `### UPDATE commandes`

- `### DELETE FROM commandes`

- les valeurs ligne par ligne

---

## 7.2. Suivre les changements en direct (CDC live)

```bash
mysqlbinlog \
  --read-from-remote-server \
  --host=192.168.10.10 \
  --user=maxscale \
  --password \
  --stop-never \
  --base64-output=DECODE-ROWS \
  --verbose \
  mariadb-bin.000001
```

Chaque nouvelle opération dans `shop_tx.commandes` apparaît instantanément.  
C’est une démonstration spectaculaire et très claire du **CDC temps réel**.

---

# 8. Transfert continu vers une instance cible (réplication)

## 8.1. Préparer la base cible (shop_dw)

```sql
CREATE DATABASE IF NOT EXISTS shop_dw;
USE shop_dw;

CREATE TABLE commandes_dw (
  id INT PRIMARY KEY,
  client VARCHAR(100),
  montant DECIMAL(10,2),
  statut VARCHAR(20),
  date_creation TIMESTAMP
);
```

---

## 8.2. Récupérer l’état du binlog sur la source

```sql
SHOW MASTER STATUS;
```

Note :

- `File`

- `Position`

---

## 8.3. Configurer la réplication sur la cible

Créer le fichier :

### Créer le fichier **/etc/mysql/conf.d/replica.cnf** :

```ini
[mysqld]
server_id = 2
relay_log = mariadb-relay-bin
```

Redémarrer :

```bash
sudo systemctl restart mariadb
```

---

## 8.4. Établir la réplication

```sql
CHANGE MASTER TO
  MASTER_HOST='192.168.10.10',
  MASTER_USER='maxscale',
  MASTER_PASSWORD='Mot2PasseMaxScale!',
  MASTER_LOG_FILE='mariadb-bin.000003',
  MASTER_LOG_POS=1200;
```

Lancer :

```sql
START SLAVE; 
```

Vérifier :

```sql
SHOW SLAVE STATUS\G
```

Résultat attendu : réplication active.

---

## 8.5. Résultat : ETL CDC continu

Dès qu’un changement est effectué sur `shop_tx.commandes` :

- il entre dans les binlogs,

- MaxScale peut le consommer via Avro/CDC,

- la réplication l’envoie immédiatement vers `shop_dw.commandes_dw`.

Aucune ligne de code.  
Aucun script d’ETL.  
Un pipeline CDC professionnel, entièrement basé sur MariaDB.

---

# 9. Export et rejouage des binlogs (ETL ponctuel)

## 9.1. Exporter les changements d’une période précise

```bash
mysqlbinlog \
  --read-from-remote-server \
  --host=192.168.10.10 \
  --user=maxscale \
  --password \
  --start-datetime="2025-12-10 01:00:00" \
  --stop-datetime="2025-12-10 02:00:00" \
  mariadb-bin.000003 > changements_01h_02h.sql
```

---

## 9.2. Rejouer les changements sur la base cible

```bash
mysqlbinlog \
  --read-from-remote-server \
  --host=192.168.10.10 \
  --user=maxscale \
  --password \
  --start-datetime="2025-12-10 01:00:00" \
  --stop-datetime="2025-12-10 02:00:00" \
  mariadb-bin.000003 \
| mysql -h 192.168.10.20 -u etl_user -p shop_dw
```

Résultat :

- toutes les modifications survenues dans l’intervalle 01:00–02:00  
  sont appliquées sur `shop_dw`.

---

# 10. Conclusion

Cette technique CDC permet :

- une synchronisation **quasi temps réel** entre instances MariaDB,

- une détection fiable des changements via les binlogs,

- une mise en place **sans programmation**, adaptée aux profils non développeurs,

- une architecture professionnelle reposant sur MaxScale,

- une capacité à exporter ou rejouer des changements (ETL incrémental),

- une séparation claire entre **OLTP** (source) et **DW/Reporting** (cible).

C’est l’une des approches les plus puissantes pour des pipelines ETL robustes, scalables et maintenables dans un environnement MariaDB.
