## üß™ Atelier complet : D√©ploiement automatis√© d‚Äôune application Flask avec Ansistrano

---

## 1Ô∏è‚É£ Contexte & objectif

Dans ce laboratoire, vous allez apprendre √† **d√©ployer automatiquement une application web Flask** √† l‚Äôaide d‚Äô**Ansible et du r√¥le Ansistrano**, qui s‚Äôoccupe de g√©rer les releases, les versions et le rollback.

### üéØ Objectifs p√©dagogiques

- D√©couvrir la logique des d√©ploiements Ansistrano (releases + symlink `current`).

- Automatiser le d√©ploiement d‚Äôune application Flask simple.

- Apprendre √† revenir √† la version pr√©c√©dente sans tout casser (rollback).

- Pr√©parer une base pour des pipelines CI/CD futurs.

### üí° Cas pratique

L‚Äôapplication Flask expose un endpoint `/health` qui indique sa version :

- Version 1 : ‚ÄúHealth OK ‚Äì Version 1‚Äù

- Version 2 : ‚ÄúHealth OK ‚Äì Version 2‚Äù

Vous d√©ploierez ces deux versions successives, puis effectuerez un rollback.

---

## 2Ô∏è‚É£ Pr√©paration de l‚Äôenvironnement

### 2.1. Topologie du labo

| Machine     | R√¥le            | Adresse IP    | Logiciels cl√©s  |
| ----------- | --------------- | ------------- | --------------- |
| **control** | Machine Ansible | 192.168.56.10 | Ansible + Git   |
| **web01**   | Serveur cible   | 192.168.56.11 | Python3 + Nginx |

### 2.2. Installation sur la machine **control**

```bash
sudo apt update
sudo apt install -y ansible git python3-pip tree
ansible-galaxy install ansistrano.deploy ansistrano.rollback
```

### 2.3. Installation sur la machine **web01**

```bash
sudo apt update
sudo apt install -y python3 python3-venv nginx
sudo mkdir -p /var/www/ansistrano_app
sudo chown -R $USER:$USER /var/www/ansistrano_app
```

### 2.4. Authentification SSH sans mot de passe

Depuis la machine `control` :

```bash
ssh-keygen -t ed25519
ssh-copy-id user@192.168.56.11
```

V√©rifiez la connexion :

```bash
ssh user@192.168.56.11
```

---

## 3Ô∏è‚É£ Structure du projet

```
ansistrano-demo/
‚îú‚îÄ‚îÄ inventory.ini
‚îú‚îÄ‚îÄ deploy.yml
‚îú‚îÄ‚îÄ rollback.yml
‚îú‚îÄ‚îÄ cleanup_lab.sh
‚îî‚îÄ‚îÄ app/
    ‚îú‚îÄ‚îÄ app.py
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îî‚îÄ‚îÄ wsgi.sh
```

---

## 4Ô∏è‚É£ Cr√©ation des fichiers n√©cessaires

---

### Cr√©er le fichier **inventory.ini** :

```ini
[web]
192.168.56.11 ansible_user=user ansible_become=yes
```

> üîπ Ce fichier indique que le groupe `[web]` contient le serveur cible.  
> üîπ `ansible_become=yes` permet d‚Äôex√©cuter les commandes en mode administrateur.

---

### Cr√©er le fichier **app/app.py** :

```python
# ----------------------------
# Application Flask simple pour test de d√©ploiement Ansistrano
# ----------------------------
from flask import Flask
import os

app = Flask(__name__)

@app.route("/health")
def health():
    # Le message de version sera lu depuis une variable d'environnement
    version = os.getenv("APP_VERSION", "Version inconnue")
    return f"Health OK ‚Äì {version}"

if __name__ == "__main__":
    # L'application √©coute sur toutes les interfaces (port 5000)
    app.run(host="0.0.0.0", port=5000)
```

> üîπ Cette app est minimale mais suffisante pour illustrer le d√©ploiement.  
> üîπ Le texte affich√© changera selon la version d√©finie.

---

### Cr√©er le fichier **app/requirements.txt** :

```text
Flask==3.0.3
```

---

### Cr√©er le fichier **app/wsgi.sh** :

```bash
#!/usr/bin/env bash
# --------------------------------------
# Script de d√©marrage de l'application Flask
# --------------------------------------

cd "$(dirname "$0")"
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# D√©finir la version via variable d'environnement
export APP_VERSION="Version 1"
python3 app.py
```

> üîπ Ce script sera ex√©cut√© sur le serveur distant pour lancer l‚Äôapplication Flask.  
> üîπ Il installe les d√©pendances dans un environnement virtuel local.

Donner les droits d‚Äôex√©cution :

```bash
chmod +x app/wsgi.sh
```

---

### Cr√©er le fichier **deploy.yml** :

```yaml
---
# --------------------------------------
# Playbook de d√©ploiement avec Ansistrano
# --------------------------------------
- name: D√©ploiement application Flask avec Ansistrano
  hosts: web
  become: yes

  vars:
    ansistrano_deploy_to: "/var/www/ansistrano_app"
    ansistrano_keep_releases: 3
    ansistrano_deploy_via: copy
    ansistrano_local_copy_path: "./app"
    ansistrano_before_symlink_tasks_file: "before-symlink-tasks.yml"
    ansistrano_after_symlink_tasks_file: "after-symlink-tasks.yml"

  roles:
    - role: ansistrano.deploy
```

> üîπ `ansistrano_deploy_via: copy` permet de copier le dossier local `app/` directement vers la machine distante.  
> üîπ Les fichiers de hooks (`before-symlink` / `after-symlink`) permettent d‚Äôajouter des t√¢ches personnalis√©es avant ou apr√®s la mise √† jour du lien symbolique.

---

### Cr√©er le fichier **rollback.yml** :

```yaml
---
# --------------------------------------
# Playbook de rollback Ansistrano
# --------------------------------------
- name: Retour √† la version pr√©c√©dente
  hosts: web
  become: yes
  roles:
    - role: ansistrano.rollback
```

> üîπ Ce playbook revient automatiquement √† la version pr√©c√©dente.

---

### Cr√©er le fichier **before-symlink-tasks.yml** :

```yaml
---
# --------------------------------------
# T√¢ches ex√©cut√©es avant la mise √† jour du lien 'current'
# --------------------------------------
- name: Stopper le service Flask si en cours
  ansible.builtin.shell: "pkill -f app.py || true"
  ignore_errors: yes
```

---

### Cr√©er le fichier **after-symlink-tasks.yml** :

```yaml
---
# --------------------------------------
# T√¢ches ex√©cut√©es apr√®s la mise √† jour du lien 'current'
# --------------------------------------
- name: D√©marrer la nouvelle version de l'application Flask
  ansible.builtin.shell: |
    cd {{ ansistrano_release_path.stdout }}
    nohup ./wsgi.sh > /tmp/flask.log 2>&1 &
  args:
    chdir: "{{ ansistrano_deploy_to }}/current"
```

> üîπ Cela lance la nouvelle version automatiquement apr√®s le d√©ploiement.

---

### Cr√©er le fichier **cleanup_lab.sh** :

```bash
#!/usr/bin/env bash
# --------------------------------------
# Script de nettoyage du laboratoire Ansistrano
# --------------------------------------
set -e
echo "Nettoyage du laboratoire Ansistrano..."
ssh user@192.168.56.11 "sudo pkill -f app.py || true"
ssh user@192.168.56.11 "sudo rm -rf /var/www/ansistrano_app"
echo "R√©pertoire supprim√© et processus Flask arr√™t√©s."
```

---

## 5Ô∏è‚É£ D√©ploiement de la version 1

Depuis la machine `control` :

```bash
ansible-playbook -i inventory.ini deploy.yml
```

V√©rifiez le r√©sultat :

```bash
ssh user@192.168.56.11 "tree /var/www/ansistrano_app"
```

Sortie attendue :

```
/var/www/ansistrano_app
‚îú‚îÄ‚îÄ current -> releases/2025-10-16_21-00-00/
‚îî‚îÄ‚îÄ releases/
    ‚îî‚îÄ‚îÄ 2025-10-16_21-00-00/
```

Tester l‚Äôapplication :

```bash
curl -f http://192.168.56.11:5000/health
```

R√©sultat attendu :

```
Health OK ‚Äì Version 1
```

---

## 6Ô∏è‚É£ D√©ploiement de la version 2

Modifier `app/wsgi.sh` :

```bash
export APP_VERSION="Version 2"
```

Puis relancer :

```bash
ansible-playbook -i inventory.ini deploy.yml
```

Tester :

```bash
curl -f http://192.168.56.11:5000/health
```

R√©sultat attendu :

```
Health OK ‚Äì Version 2
```

---

## 7Ô∏è‚É£ Rollback vers la version pr√©c√©dente

Lancer :

```bash
ansible-playbook -i inventory.ini rollback.yml
```

Tester √† nouveau :

```bash
curl -f http://192.168.56.11:5000/health
```

R√©sultat attendu :

```
Health OK ‚Äì Version 1
```

---

## 8Ô∏è‚É£ V√©rifications et validation

| √âtape                      | Commande                                | R√©sultat attendu                     |
| -------------------------- | --------------------------------------- | ------------------------------------ |
| V√©rifier les releases      | `ls /var/www/ansistrano_app/releases`   | 2 dossiers horodat√©s                 |
| V√©rifier le lien `current` | `ls -l /var/www/ansistrano_app/current` | Lien vers la derni√®re release active |
| Tester le service Flask    | `curl /health`                          | Affiche la version active            |
| V√©rifier les logs          | `cat /tmp/flask.log`                    | Pas d‚Äôerreur lors du lancement       |

---

## 9Ô∏è‚É£ Nettoyage du laboratoire

Ex√©cuter :

```bash
bash cleanup_lab.sh
```

Puis valider :

```bash
ssh user@192.168.56.11 "ls /var/www"
```

‚Üí le r√©pertoire `ansistrano_app` doit avoir disparu.

---

## üîü Conseils, pi√®ges et bonnes pratiques

| Cas                        | Cause probable                        | Solution                           |
| -------------------------- | ------------------------------------- | ---------------------------------- |
| D√©ploiement √©choue         | Mauvais chemin `ansistrano_deploy_to` | Corriger le chemin                 |
| Flask non accessible       | Port ferm√© ou Flask non relanc√©       | V√©rifier `after-symlink-tasks.yml` |
| Rollback ne fonctionne pas | Trop peu de releases                  | Ajuster `ansistrano_keep_releases` |
| Permissions refus√©es       | Absence de `become: yes`              | Ajouter `become` dans les plays    |

---

## üîÅ Ouverture vers la CI/CD

Une fois l‚Äôatelier valid√©, vous pouvez :

- Int√©grer le playbook `deploy.yml` dans une **pipeline GitLab CI** :
  
  - √âtape `build` ‚Üí `test` ‚Üí `deploy`.

- Ajouter un **test automatique de sant√©** :
  
  ```bash
  curl -fs http://web01:5000/health || exit 1
  ```

- D√©ployer plusieurs environnements : `staging`, `production`.


