

# Exercice 1 — Créer un fichier `ansible.cfg` minimal

## Contexte & objectif

Par défaut, Ansible utilise `/etc/ansible/ansible.cfg`. Ici, nous allons créer un **fichier de configuration local** dans un projet afin de définir un inventaire par défaut.

## Préparation

Créer une arborescence de projet :

```
project/
 ├─ ansible.cfg
 ├─ inventory.ini
 └─ test.yml
```

**Contenu `inventory.ini`**

```ini
[web]
localhost ansible_connection=local
```

**Contenu `ansible.cfg`**

```ini
[defaults]
inventory = ./inventory.ini
```

## Étapes de l’exercice

1. Créez le fichier `ansible.cfg` comme ci-dessus.

2. Exécutez un playbook de test sans préciser `-i`.

**Playbook `test.yml`**

```yaml
---
- name: Test ansible.cfg inventory
  hosts: web
  tasks:
    - debug:
        msg: "Hello from {{ inventory_hostname }}"
```

## Commande

```bash
ansible-playbook test.yml
```

## Nettoyage

Supprimer le fichier `ansible.cfg` :

```bash
rm ansible.cfg
```

## Astuces & pièges

- Ansible cherche `ansible.cfg` dans **cet ordre** :
  
  1. Variable d’environnement `ANSIBLE_CONFIG`
  
  2. Fichier `ansible.cfg` dans le répertoire courant
  
  3. `~/.ansible.cfg`
  
  4. `/etc/ansible/ansible.cfg`

- Utiliser un `ansible.cfg` dans un projet permet de **ne pas polluer la config globale**.

---

# Exercice 2 — Activer `host_key_checking`

## Contexte & objectif

Par défaut, Ansible vérifie l’empreinte SSH des hôtes. Nous allons configurer et tester cette option.

## Préparation

Ajouter à `ansible.cfg` :

```ini
[defaults]
inventory = ./inventory.ini
host_key_checking = True
```

## Étapes

1. Connectez-vous à une nouvelle machine **jamais contactée en SSH** → Ansible demandera de valider la clé.

2. Rejouez la commande après acceptation → plus de message d’avertissement.

## Commande

```bash
ansible web -m ping
```

## Nettoyage

Remettez la valeur à `False` si vous ne voulez pas garder cette sécurité stricte.

## Astuces & pièges

- En **production**, laissez `True` pour éviter les attaques MITM.

- En **lab**, désactivez-le pour éviter des blocages.

---

# Exercice 3 — Configurer `remote_user`

## Contexte & objectif

Définir un utilisateur SSH par défaut au lieu de devoir utiliser `-u` à chaque fois.

## Préparation

Créer `ansible.cfg` :

```ini
[defaults]
inventory = ./inventory.ini
remote_user = ansible
```

## Étapes

1. Ajoutez un utilisateur `ansible` sur la machine distante.
   
   ```bash
   sudo useradd ansible -m -s /bin/bash
   sudo passwd ansible
   ```

2. Configurez l’accès SSH pour cet utilisateur.

3. Testez sans option `-u`.

**Commande**

```bash
ansible web -m ping
```

## Nettoyage

Supprimer l’utilisateur `ansible` si inutile :

```bash
sudo userdel -r ansible
```

## Astuces & pièges

- `remote_user` dans `ansible.cfg` évite les oublis.

- Vous pouvez aussi définir `ansible_user` directement dans l’inventaire.

---

# Exercice 4 — Configurer `become`

## Contexte & objectif

Exécuter automatiquement les tâches avec privilèges root via `sudo` sans ajouter `-b`.

## Préparation

Modifier `ansible.cfg` :

```ini
[defaults]
inventory = ./inventory.ini
remote_user = ansible
become = True
become_method = sudo
become_user = root
```

## Étapes

1. Créez un playbook qui installe `htop` :

**`install_htop.yml`**

```yaml
---
- name: Install htop with become
  hosts: web
  tasks:
    - name: Install htop
      apt:
        name: htop
        state: present
```

2. Exécutez sans `-b` → Ansible utilisera `become` automatiquement.

**Commande**

```bash
ansible-playbook install_htop.yml
```

## Nettoyage

```bash
ansible web -m apt -a "name=htop state=absent" --become
```

## Astuces & pièges

- `become=True` dans `ansible.cfg` = plus besoin de `-b`.

- Attention à ne pas activer ça pour des utilisateurs qui n’ont pas `sudo`.

---

# Exercice 5 — Configurer la verbosité et logs

## Contexte & objectif

Par défaut, Ansible affiche tout à l’écran. Nous allons activer un **fichier de logs** pour garder une trace.

## Préparation

Dans `ansible.cfg` :

```ini
[defaults]
inventory = ./inventory.ini
log_path = ./ansible.log
```

## Étapes

1. Exécutez un playbook :

```bash
ansible-playbook test.yml
```

2. Vérifiez le fichier `ansible.log` :

```bash
cat ansible.log
```

## Nettoyage

Supprimer `ansible.log` après usage :

```bash
rm ansible.log
```

## Astuces & pièges

- Utile pour **debugger en formation ou production**.

- Pensez à gérer la taille du fichier → sinon il peut devenir énorme.

---

✅ Ces 5 premiers exercices couvrent :

- configuration locale `ansible.cfg`

- inventaire par défaut

- sécurité SSH (`host_key_checking`)

- utilisateur par défaut (`remote_user`)

- élévation (`become`)

- logs (`log_path`)


