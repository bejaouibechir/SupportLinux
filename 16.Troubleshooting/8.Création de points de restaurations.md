

# 🧠 Atelier 8 – Créer et restaurer un “point de restauration” du système Debian 13

**Niveau 1 – Amorçage & bases du boot (Debian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Créer un **point de restauration** signifie capturer à un instant T l’état du système :

- fichiers critiques du démarrage (BIOS, MBR, GRUB, Kernel),

- configuration système (`/etc`, `/var`, `/boot`),

- données utilisateurs (`/home`),

…et être capable de **revenir** à cet état en cas de corruption, mauvaise mise à jour ou suppression accidentelle.

### Objectifs pédagogiques

- Créer un “snapshot” local complet du système.

- Automatiser la création de ce snapshot.

- Restaurer le système depuis un point enregistré.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1 – Prérequis

- Debian 13 avec accès root (`sudo`).

- Un deuxième disque ou un répertoire monté pour stocker les snapshots (ex : `/mnt/snapshots`).

- Les paquets `rsync`, `tar`, `grub`, `gzip` installés.

### 2.2 – Création du répertoire des snapshots

```bash
sudo mkdir -p /mnt/snapshots
sudo chmod 700 /mnt/snapshots
```

🗨️ **Bulle explicative**  
Le répertoire `/mnt/snapshots` hébergera les “points de restauration” datés et compressés.  
Les droits 700 garantissent que seul root peut y accéder.

---

## 💾 3. Script : création d’un point de restauration complet

Créer le fichier **/usr/local/bin/create_restore_point.sh** :

```bash
#!/usr/bin/env bash
# Crée un point de restauration complet du système Debian
# Auteur : Atelier DevOps Debian
# Usage : sudo bash /usr/local/bin/create_restore_point.sh

set -euo pipefail

DATE=$(date +%F-%H%M)
SNAP_DIR="/mnt/snapshots/restore_$DATE"

echo "---- Création du snapshot $SNAP_DIR ----"
mkdir -p "$SNAP_DIR"

echo "---- Sauvegarde du MBR ----"
dd if=/dev/sda of="$SNAP_DIR/mbr_backup.img" bs=512 count=1 status=none

echo "---- Archivage des répertoires critiques ----"
tar -cpzf "$SNAP_DIR/etc_boot.tar.gz" /etc /boot /lib/systemd /etc/default/grub

echo "---- Sauvegarde du /home ----"
tar -cpzf "$SNAP_DIR/home.tar.gz" /home

echo "---- Vérification ----"
ls -lh "$SNAP_DIR"

echo "---- Point de restauration créé avec succès ----"
```

🗨️ **Bulle explicative**

- `dd` : capture le MBR du disque.

- `tar -cpzf` : archive et compresse les répertoires critiques (`/etc`, `/boot`, etc.).

- Les fichiers sont stockés dans un dossier daté (`restore_YYYY-MM-DD-HHMM`).

- Ce script constitue une **photographie complète** de l’état du système.

---

## 🧰 4. Automatiser la création de points de restauration

Créer le fichier **/etc/cron.daily/create_restore_point** :

```bash
#!/bin/bash
/usr/local/bin/create_restore_point.sh > /var/log/restore_point.log 2>&1
```

Rendre le script exécutable :

```bash
sudo chmod +x /etc/cron.daily/create_restore_point
```

🗨️ **Bulle explicative**  
Chaque jour, un point de restauration est créé automatiquement et journalisé.  
Le fichier `/var/log/restore_point.log` conserve la trace des opérations.

---

## ⚙️ 5. Simulation : suppression du GRUB ou du /etc corrompu

> ⚠️ À faire uniquement sur une VM de test !

```bash
sudo mv /boot/grub /boot/grub.bak
sudo rm -rf /etc/*
sudo reboot
```

🗨️ **Bulle explicative**  
On simule une corruption grave du système : le GRUB et les fichiers de configuration sont perdus.  
La machine ne pourra plus démarrer.

---

## 🔧 6. Restauration depuis un point de restauration (Live Debian)

### 6.1 – Monter la partition racine

```bash
sudo fdisk -l
sudo mount /dev/sda1 /mnt
sudo mount /dev/sdb1 /mnt/snapshots
```

🗨️ **Bulle explicative**  
`/dev/sda1` : partition à restaurer,  
`/dev/sdb1` : disque contenant les snapshots.

---

### 6.2 – Extraire le snapshot choisi

```bash
cd /mnt
sudo tar -xpvzf /mnt/snapshots/restore_2025-10-21-1400/etc_boot.tar.gz -C /
sudo tar -xpvzf /mnt/snapshots/restore_2025-10-21-1400/home.tar.gz -C /
```

🗨️ **Bulle explicative**  
Les archives sont décompressées et leurs fichiers replacés dans leur emplacement d’origine.  
Les options `-xpvzf` : extraction, préservation des permissions, mode verbeux, gzip, fichier source.

---

### 6.3 – Restauration du MBR

```bash
sudo dd if=/mnt/snapshots/restore_2025-10-21-1400/mbr_backup.img of=/dev/sda bs=512 count=1
```

🗨️ **Bulle explicative**  
Réécrit le chargeur de premier niveau.  
Attention : toujours vérifier le bon disque avant d’exécuter cette commande.

---

### 6.4 – Réinstaller GRUB et régénérer l’initramfs

```bash
sudo chroot /mnt
grub-install /dev/sda
update-grub
update-initramfs -u -k all
exit
```

🗨️ **Bulle explicative**  
Réinstalle GRUB et régénère les fichiers de démarrage pour aligner les UUID et modules du noyau.

---

### 6.5 – Redémarrage et vérification

```bash
sudo reboot
```

Vérifiez ensuite :

```bash
uname -r
ls /boot
systemctl status
```

🗨️ **Bulle explicative**  
Le système doit redémarrer normalement avec le noyau et les fichiers restaurés.

---

## 🧹 7. Nettoyage et rotation automatique des snapshots

Créer le script **/usr/local/bin/cleanup_snapshots.sh** :

```bash
#!/usr/bin/env bash
# Supprime les snapshots de plus de 7 jours
find /mnt/snapshots/restore_* -maxdepth 0 -mtime +7 -exec rm -rf {} \;
```

🗨️ **Bulle explicative**  
Ce script supprime les anciens points de restauration (plus de 7 jours) pour éviter la saturation disque.

---

## 💡 8. Astuces & bonnes pratiques

| Composant            | Méthode de restauration                | Outil principal       |
| -------------------- | -------------------------------------- | --------------------- |
| MBR corrompu         | Restaurer `mbr_backup.img`             | `dd`                  |
| GRUB cassé           | Extraire `/boot/grub` + `grub-install` | `tar`, `grub-install` |
| initramfs perdu      | `update-initramfs -u`                  | `initramfs-tools`     |
| /etc corrompu        | Extraire `etc_boot.tar.gz`             | `tar`                 |
| utilisateur supprimé | Restaurer `/etc/passwd`, `/etc/shadow` | `tar`                 |
| snapshot automatique | `/etc/cron.daily/create_restore_point` | `cron`                |

---

## ✅ Résumé de l’atelier

- Mise en place d’un **mécanisme de points de restauration système** sans outils externes.

- Capture complète : **MBR, /boot, /etc, /home, systemd**.

- Automatisation via **cron** et rotation automatique.

- Procédure de **restauration complète** depuis un environnement Live.


