

# üß† Atelier 2 ‚Äì R√©installer et diagnostiquer GRUB sur Debian 13

**Niveau 1 ‚Äì Amor√ßage & bases du boot**

---

## üéØ 1. Contexte & Objectif

GRUB (**GRand Unified Bootloader**) est le chargeur de d√©marrage le plus utilis√© sous Debian.  
Il permet de lancer le noyau Linux, de g√©rer plusieurs syst√®mes d‚Äôexploitation, et de r√©cup√©rer un syst√®me endommag√©.

Dans cet atelier, vous allez :

- Comprendre la structure et les fichiers du chargeur GRUB.

- Diagnostiquer un GRUB corrompu (erreur `grub rescue>`).

- R√©installer compl√®tement GRUB depuis un environnement Live Debian.

Objectif final :  
‚û°Ô∏è √ätre capable de **r√©parer le chargeur de d√©marrage** et de **restaurer un syst√®me bootable** sans r√©installation.

---

## ‚öôÔ∏è 2. Pr√©paration de l‚Äôenvironnement

### 2.1. T√©l√©chargement du Live Debian 13

Lien direct (m√™me que pour l‚ÄôAtelier 1) :

üì• https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

### 2.2. Script pour pr√©parer l‚Äôenvironnement Live

Cr√©er le fichier **setup_live_env.sh** :

```bash
#!/usr/bin/env bash
# Ce script pr√©pare un environnement Live Debian avec clavier AZERTY, SSH et outils de r√©cup√©ration

set -euo pipefail

echo "---- Configuration du clavier ----"
sudo localectl set-keymap fr
sudo localectl set-x11-keymap fr
echo "Clavier d√©fini en fran√ßais (AZERTY)."

echo "---- Installation des outils n√©cessaires ----"
sudo apt update
sudo apt install -y vim grub2-common grub-pc-bin os-prober efibootmgr mount parted openssh-client

echo "---- V√©rification des outils ----"
which grub-install grub-mkconfig os-prober || echo "‚ö†Ô∏è  Un outil essentiel manque."
```

üó®Ô∏è **Explication**

- `localectl` change imm√©diatement la disposition du clavier (utile sur ISO Live).

- `grub-pc-bin`, `os-prober` et `efibootmgr` sont n√©cessaires pour r√©installer GRUB sur disques BIOS ou UEFI.

- `openssh-client` permet d‚Äôintervenir √† distance si n√©cessaire.

---

## üß© 3. √âtude du fonctionnement de GRUB

### 3.1. Structure des fichiers

```bash
ls -lh /boot/grub
cat /boot/grub/grub.cfg | head -n 10
```

üó®Ô∏è **Bulle explicative**

- `/boot/grub/grub.cfg` : fichier principal g√©n√©r√© automatiquement par `update-grub`.

- `/boot/grub/x86_64-efi/` : contient les modules GRUB (UEFI).

- `/boot/grub/fonts/` : polices utilis√©es dans le menu graphique.

---

### 3.2. Identifier le p√©riph√©rique de boot

```bash
sudo fdisk -l
```

üó®Ô∏è **Bulle explicative**  
Cette commande permet de rep√©rer la partition o√π Debian est install√©e, g√©n√©ralement `/dev/sda1` pour la racine `/`.  
Sous UEFI, la partition EFI (type `EFI System`) est souvent `/dev/sda2`.

---

## üß∞ 4. Cas pratique : GRUB corrompu ou manquant

### 4.1. Simulation du probl√®me

> ‚ö†Ô∏è Exercice √† faire sur une VM uniquement !

```bash
sudo mv /boot/grub /boot/grub.old
sudo reboot
```

üó®Ô∏è **Bulle explicative**  
On simule une corruption de GRUB en renommant son dossier principal.  
Le syst√®me red√©marre sur une erreur `grub rescue>`.

---

### 4.2. R√©paration depuis le Live Debian

#### √âtape 1 : Monter la partition syst√®me

```bash
sudo fdisk -l
sudo mount /dev/sda1 /mnt
sudo mount --bind /dev /mnt/dev
sudo mount --bind /proc /mnt/proc
sudo mount --bind /sys /mnt/sys
```

üó®Ô∏è **Bulle explicative**  
On monte la partition racine et les r√©pertoires virtuels n√©cessaires pour ex√©cuter `grub-install` depuis le chroot.

---

#### √âtape 2 : Identifier si le syst√®me est UEFI ou BIOS

```bash
[ -d /sys/firmware/efi ] && echo "UEFI" || echo "BIOS"
```

üó®Ô∏è **Bulle explicative**  
Permet de savoir si le bootloader doit √™tre install√© en mode BIOS (`grub-pc`) ou UEFI (`grub-efi-amd64`).

---

#### √âtape 3 : Chrooter dans le syst√®me

```bash
sudo chroot /mnt
```

üó®Ô∏è **Bulle explicative**  
On entre dans le syst√®me install√© : toutes les commandes suivantes agiront comme si on avait d√©marr√© dessus.

---

#### √âtape 4 : R√©installer GRUB

##### Mode BIOS (classique MBR)

```bash
grub-install /dev/sda
update-grub
```

üó®Ô∏è **Bulle explicative**  
`grub-install` √©crit le code GRUB dans le MBR.  
`update-grub` reg√©n√®re le fichier `/boot/grub/grub.cfg` avec d√©tection automatique des noyaux Linux.

##### Mode UEFI

```bash
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=debian
update-grub
```

üó®Ô∏è **Bulle explicative**  
Installe GRUB dans la partition EFI (`/boot/efi/EFI/debian/grubx64.efi`) et enregistre une entr√©e de boot UEFI.

---

#### √âtape 5 : Sortir et red√©marrer

```bash
exit
sudo umount /mnt/{dev,proc,sys}
sudo umount /mnt
sudo reboot
```

üó®Ô∏è **Bulle explicative**  
D√©montage propre et red√©marrage.  
Le menu GRUB devrait r√©appara√Ætre normalement avec l‚Äôentr√©e Debian.

---

## üîç 5. V√©rification post-r√©paration

```bash
grub-install --version
grep menuentry /boot/grub/grub.cfg
```

üó®Ô∏è **Bulle explicative**

- `grub-install --version` confirme que GRUB est bien install√©.

- `grep menuentry` v√©rifie que Debian a bien √©t√© d√©tect√©e dans le menu.

---

## üßπ 6. Nettoyage

```bash
sudo rm -rf /boot/grub.old
```

üó®Ô∏è **Bulle explicative**  
On supprime le dossier corrompu sauvegard√© pr√©c√©demment pour lib√©rer l‚Äôespace.

---

## üí° 7. Astuces & Pi√®ges fr√©quents

| Sympt√¥me              | Cause probable                | Solution                                |
| --------------------- | ----------------------------- | --------------------------------------- |
| `grub rescue>` prompt | Dossier `/boot/grub` manquant | R√©installer GRUB depuis Live ISO        |
| Menu GRUB vide        | Mauvaise d√©tection du syst√®me | Lancer `os-prober` avant `update-grub`  |
| Boot EFI non d√©tect√©  | `efibootmgr` absent           | `apt install efibootmgr` dans le chroot |
| √âcran noir apr√®s GRUB | Mauvais noyau / initrd        | V√©rifier `/boot/initrd.img-*`           |

---

## ‚úÖ R√©sum√© de l‚Äôatelier

- Vous avez appris √† **r√©installer GRUB** sur Debian 13 (BIOS et UEFI).

- Vous savez **monter un syst√®me manuellement**, **entrer en chroot**, et **r√©g√©n√©rer la configuration GRUB**.

- Vous avez d√©couvert comment identifier le type de d√©marrage, et r√©parer un bootloader corrompu.


