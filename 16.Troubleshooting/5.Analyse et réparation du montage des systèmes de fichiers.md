# ğŸ§  Atelier 4 â€“ Analyse et rÃ©paration du montage des systÃ¨mes de fichiers

**Niveau 1 â€“ AmorÃ§age & bases du boot (Debian 13 â€œTrixieâ€)**

---

## ğŸ¯ 1. Contexte & Objectif

Durant la phase dâ€™initialisation, aprÃ¨s le chargement du noyau et la prise en main par `systemd`, le systÃ¨me doit **monter les partitions racine (`/`), boot (`/boot`), swap, home, etc.)** conformÃ©ment au fichier `/etc/fstab`.

Un montage incorrect (UUID erronÃ©, pÃ©riphÃ©rique manquant, erreur `fsck`, etc.) peut bloquer complÃ¨tement le dÃ©marrage.

Objectifs pÃ©dagogiques :

- Comprendre la logique de montage automatique (fstab, initramfs, systemd-mount).

- Diagnostiquer un blocage au boot dÃ» Ã  un systÃ¨me de fichiers dÃ©fectueux.

- RÃ©parer un `fstab` ou un systÃ¨me de fichiers corrompu via un environnement Live.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1 â€“ TÃ©lÃ©chargement du Live Debian 13

ğŸ“¥ Image officielle (ISO Live GNOME) :  
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

---

### 2.2 â€“ Script de configuration initiale (AZERTY + utilitaires)

CrÃ©er le fichier **prepare_live_env.sh** :

```bash
#!/usr/bin/env bash
# Script pour prÃ©parer un environnement Live Debian de dÃ©pannage (clavier FR, outils disque et rÃ©seau)

set -euo pipefail

echo "---- Configuration du clavier franÃ§ais ----"
sudo localectl set-keymap fr
sudo localectl set-x11-keymap fr

echo "---- Installation des outils nÃ©cessaires ----"
sudo apt update
sudo apt install -y vim gparted parted e2fsprogs dosfstools lvm2 mdadm btrfs-progs ntfs-3g sshfs
```

ğŸ—¨ï¸ **Bulle explicative**  
Ce script configure le clavier AZERTY et installe les utilitaires nÃ©cessaires pour manipuler, rÃ©parer et monter des partitions de tous types (ext4, LVM, Btrfs, NTFSâ€¦).

---

## ğŸ§© 3. Ã‰tude du fonctionnement du montage des systÃ¨mes de fichiers

### 3.1 â€“ Fichier `/etc/fstab`

Afficher le contenu :

```bash
cat /etc/fstab
```

ğŸ—¨ï¸ **Bulle explicative**  
Chaque ligne du fichier `/etc/fstab` dÃ©crit une partition Ã  monter automatiquement au dÃ©marrage.  
Format :

```
<source>   <point_de_montage>   <type>   <options>   <dump>   <pass>
```

Exemple typique :

```
UUID=1e7b1b4a-7b11-4fd9-bf0a-8a452ce6fca0  /  ext4  errors=remount-ro  0  1
UUID=E3A0-FD12  /boot/efi  vfat  umask=0077  0  1
UUID=8a43-9f6c  none  swap  sw  0  0
```

---

### 3.2 â€“ Identifier les disques et partitions

```bash
lsblk -f
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche la hiÃ©rarchie des pÃ©riphÃ©riques bloc, leurs UUID, types de systÃ¨me de fichiers et points de montage.  
TrÃ¨s utile pour vÃ©rifier la correspondance avec `/etc/fstab`.

---

### 3.3 â€“ Consulter les logs de montage au boot

```bash
journalctl -b -u systemd-fsck --no-pager
```

ğŸ—¨ï¸ **Bulle explicative**  
`systemd-fsck` effectue la vÃ©rification des systÃ¨mes de fichiers au dÃ©marrage.  
Cette commande montre sâ€™il a dÃ©tectÃ© ou rÃ©parÃ© des erreurs.

---

## âš ï¸ 4. Simulation dâ€™une erreur de montage

### 4.1 â€“ Casser une entrÃ©e `fstab` (sur une VM)

```bash
sudo cp /etc/fstab /etc/fstab.bak
sudo sed -i 's/UUID/#UUID/' /etc/fstab
```

ğŸ—¨ï¸ **Bulle explicative**  
On commente temporairement les UUID pour simuler une entrÃ©e illisible.  
Lors du prochain redÃ©marrage, Debian dÃ©marrera en mode â€œmaintenanceâ€ (`emergency.target`).

---

### 4.2 â€“ VÃ©rifier le comportement au boot

RedÃ©marrer la VM :

```bash
sudo reboot
```

ğŸ—¨ï¸ **Bulle explicative**  
Le systÃ¨me affichera un message du type :  
`cannot find UUID=xxxxxxx` ou `enter root password for maintenance`.  
Câ€™est une situation typique de boot bloquÃ© par `fstab`.

---

## ğŸ§° 5. RÃ©paration via un environnement Live

### 5.1 â€“ Monter la partition racine

```bash
sudo fdisk -l
sudo mount /dev/sda1 /mnt
```

ğŸ—¨ï¸ **Bulle explicative**  
Identifie et monte la partition racine du systÃ¨me Ã  rÃ©parer sur `/mnt`.

---

### 5.2 â€“ VÃ©rifier lâ€™intÃ©gritÃ© du systÃ¨me de fichiers

```bash
sudo e2fsck -f /dev/sda1
```

ğŸ—¨ï¸ **Bulle explicative**  
Force la vÃ©rification du systÃ¨me de fichiers ext4.  
Les erreurs trouvÃ©es seront corrigÃ©es automatiquement avec confirmation.

---

### 5.3 â€“ Restaurer le fichier `fstab`

```bash
sudo cp /mnt/etc/fstab.bak /mnt/etc/fstab
```

ğŸ—¨ï¸ **Bulle explicative**  
Restaure la configuration correcte des points de montage.

---

### 5.4 â€“ VÃ©rifier les UUID rÃ©els

```bash
sudo blkid
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche les UUID exacts de chaque partition.  
Toujours les comparer avec ceux du fichier `/etc/fstab`.

---

### 5.5 â€“ (Optionnel) RÃ©gÃ©nÃ©rer `initramfs`

```bash
sudo chroot /mnt
update-initramfs -u
exit
```

ğŸ—¨ï¸ **Bulle explicative**  
Lâ€™image `initramfs` contient les pilotes et outils nÃ©cessaires au montage initial des partitions racine.  
Une rÃ©gÃ©nÃ©ration peut corriger des erreurs de dÃ©pendance.

---

## ğŸ” 6. VÃ©rification aprÃ¨s redÃ©marrage

```bash
sudo reboot
mount | grep "^/dev"
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche les points de montage actifs et confirme que toutes les partitions prÃ©vues dans `fstab` sont bien montÃ©es.

---

## ğŸ§¹ 7. Nettoyage / rollback

```bash
sudo rm /mnt/etc/fstab.bak
sudo umount /mnt
```

ğŸ—¨ï¸ **Bulle explicative**  
Supprime la sauvegarde temporaire et dÃ©monte la partition rÃ©parÃ©e.

---

## ğŸ’¡ 8. Astuces & PiÃ¨ges frÃ©quents

| ProblÃ¨me                    | Cause probable                 | Solution                           |
| --------------------------- | ------------------------------ | ---------------------------------- |
| Blocage `emergency mode`    | Mauvais UUID dans `/etc/fstab` | Corriger via Live + `blkid`        |
| `mount: wrong fs type`      | Type de FS erronÃ©              | VÃ©rifier avec `lsblk -f`           |
| `fsck` Ã©choue               | SystÃ¨me de fichiers corrompu   | `e2fsck -f -y /dev/sda1`           |
| Boot lent sur disque absent | Option `nofail` manquante      | Ajouter `nofail` dans `/etc/fstab` |

---

## âœ… RÃ©sumÃ© de lâ€™atelier

- Lecture et interprÃ©tation du fichier `/etc/fstab`.

- Utilisation de `lsblk`, `blkid`, et `journalctl` pour diagnostiquer les montages.

- RÃ©paration dâ€™un montage bloquant via un environnement Live.

- VÃ©rification et rÃ©gÃ©nÃ©ration du `initramfs` pour corriger les dÃ©pendances.
