# ðŸ§  Atelier 1 â€“ Comprendre la sÃ©quence de dÃ©marrage Debian

**Niveau 1 â€“ AmorÃ§age & bases du boot (Debian 13 â€œTrixieâ€)**

---

## ðŸŽ¯ 1. Contexte & Objectif

Le processus de dÃ©marrage (boot) dâ€™un systÃ¨me Linux Debian est une chaÃ®ne dâ€™Ã©tapes interdÃ©pendantes :  
**BIOS â†’ MBR â†’ GRUB â†’ Kernel â†’ systemd.**

Lâ€™objectif de cet atelier est de :

- Comprendre le rÃ´le de chaque Ã©tape.

- Examiner les fichiers et journaux liÃ©s au boot.

- Simuler une panne (kernel manquant) et la rÃ©parer via un environnement `chroot`.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1. TÃ©lÃ©charger lâ€™image Debian 13 Trixie (Live ou netinst)

ðŸ“¥ TÃ©lÃ©chargement direct :  
âž¡ï¸ **ISO netinst (classique, 64 bits)**  
https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-13.1.0-amd64-netinst.iso

âž¡ï¸ **ISO Live (avec environnement GNOME et Terminal prÃ©installÃ©)**  
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

ðŸ’¡ **Astuce sÃ©curitÃ© :**  
TÃ©lÃ©chargez Ã©galement le fichier `.sha256sum` pour vÃ©rifier lâ€™intÃ©gritÃ© :

```bash
sha256sum debian-live-13.1.0-amd64-gnome.iso
```

---

### 2.2. Script de prÃ©paration (AZERTY + SSH + Utilitaires)

CrÃ©er le fichier **setup_server.sh** :

```bash
#!/usr/bin/env bash
# Ce script configure le clavier en AZERTY, installe SSH et les utilitaires de base
# Usage : sudo bash setup_server.sh

set -euo pipefail

echo "---- Ã‰tape 1 : configuration du clavier ----"
sudo sed -i 's/XKBLAYOUT=.*/XKBLAYOUT=\"fr\"/' /etc/default/keyboard
sudo sed -i 's/XKBVARIANT=.*/XKBVARIANT=\"\"/' /etc/default/keyboard
sudo dpkg-reconfigure --frontend noninteractive keyboard-configuration
sudo udevadm trigger --subsystem-match=input --action=change

echo "---- Ã‰tape 2 : mise Ã  jour du systÃ¨me ----"
sudo apt update && sudo apt upgrade -y

echo "---- Ã‰tape 3 : installation du serveur SSH ----"
sudo apt install -y openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh

echo "---- Ã‰tape 4 : installation des utilitaires ----"
sudo apt install -y vim htop curl wget net-tools

echo "---- Ã‰tape 5 : vÃ©rification ----"
sudo systemctl status ssh --no-pager
localectl status | grep "VC Keymap"
```

ðŸ—¨ï¸ **Explication dÃ©taillÃ©e**

- `set -euo pipefail` : stoppe le script si une erreur se produit.

- Bloc 1 : Configure le clavier AZERTY en remplaÃ§ant la disposition `XKBLAYOUT` et applique la nouvelle configuration immÃ©diatement.

- Bloc 2 : Met Ã  jour le systÃ¨me avec les derniÃ¨res versions de paquets.

- Bloc 3 : Installe et active le service SSH pour permettre un accÃ¨s distant.

- Bloc 4 : Installe des outils utiles pour la supervision et le dÃ©pannage.

- Bloc 5 : VÃ©rifie que SSH fonctionne et que le clavier est bien configurÃ©.

---

## ðŸ§© 3. Ã‰tude de la sÃ©quence de dÃ©marrage Debian

### 3.1. BIOS / UEFI

```bash
sudo dmidecode -t bios | grep -E "Vendor|Version|Release"
```

ðŸ—¨ï¸ **Bulle explicative**  
Cette commande affiche les informations du firmware : constructeur, version, et date.  
Le BIOS (ou UEFI) initialise le matÃ©riel et cherche un pÃ©riphÃ©rique amorÃ§able (disque, clÃ© USB, CD).

---

### 3.2. MBR (Master Boot Record)

```bash
sudo dd if=/dev/sda bs=512 count=1 | hexdump -C | head
```

ðŸ—¨ï¸ **Bulle explicative**  
Le MBR est le tout premier secteur du disque (512 octets).  
Cette commande en affiche le contenu hexadÃ©cimal pour vÃ©rification.  
Il contient le code dâ€™amorÃ§age initial (premier niveau de GRUB) et la table de partitions.

---

### 3.3. GRUB (Grand Unified Bootloader)

```bash
ls /boot/grub
cat /boot/grub/grub.cfg | head -n 10
```

ðŸ—¨ï¸ **Bulle explicative**  
GRUB est le chargeur de deuxiÃ¨me niveau.  
Le rÃ©pertoire `/boot/grub` contient sa configuration, notamment `grub.cfg`, oÃ¹ figurent les entrÃ©es de menu vers le noyau Linux et lâ€™image initramfs.

---

### 3.4. Kernel (noyau Linux)

```bash
ls -lh /boot
```

ðŸ—¨ï¸ **Bulle explicative**  
Cette commande liste les fichiers de dÃ©marrage :

- `vmlinuz-â€¦` : le noyau Linux.

- `initrd.img-â€¦` : lâ€™image initiale montÃ©e en RAM.

- `System.map` et `config` : symboles et configuration du noyau.

---

```bash
dmesg | less
```

ðŸ—¨ï¸ **Bulle explicative**  
`dmesg` affiche les messages du noyau depuis le dÃ©marrage : dÃ©tection matÃ©riel, montages, pilotes chargÃ©s.

---

### 3.5. systemd (PID 1)

```bash
ps -p 1 -o comm=
```

ðŸ—¨ï¸ **Bulle explicative**  
Le processus 1 (`PID 1`) est `systemd`, responsable du lancement des unitÃ©s (services, sockets, cibles).

```bash
systemd-analyze
systemd-analyze blame | head
```

ðŸ—¨ï¸ **Bulle explicative**  
Analyse le temps de dÃ©marrage global et affiche les services les plus lents Ã  se lancer.

---

## ðŸ§° 4. Simulation dâ€™un kernel manquant & rÃ©paration via chroot

### 4.1. Simulation de la panne

```bash
sudo mv /boot/vmlinuz-$(uname -r) /boot/vmlinuz-$(uname -r).bak
sudo reboot
```

ðŸ—¨ï¸ **Bulle explicative**  
On dÃ©place le fichier du noyau pour simuler une suppression.  
Au redÃ©marrage, GRUB affichera une erreur : `file not found`.

---

### 4.2. RÃ©paration depuis un Live ISO

1. DÃ©marrez la machine avec **Debian Live 13**.

2. Identifiez la partition systÃ¨me :
   
   ```bash
   sudo fdisk -l
   ```

3. Montez-la :
   
   ```bash
   sudo mount /dev/sda1 /mnt
   ```

4. Montez les systÃ¨mes virtuels nÃ©cessaires :
   
   ```bash
   sudo mount --bind /dev /mnt/dev
   sudo mount --bind /proc /mnt/proc
   sudo mount --bind /sys /mnt/sys
   ```

5. Entrez dans lâ€™environnement du systÃ¨me installÃ© :
   
   ```bash
   sudo chroot /mnt
   ```

ðŸ—¨ï¸ **Bulle explicative**  
`chroot` change la racine du systÃ¨me de fichiers vers `/mnt`, simulant un dÃ©marrage complet du vrai systÃ¨me.  
Cela permet dâ€™utiliser `apt`, `update-grub`, etc., comme si on Ã©tait dÃ©marrÃ© dessus.

---

### 4.3. RÃ©installation du kernel

```bash
apt update
apt install --reinstall linux-image-amd64
update-grub
```

ðŸ—¨ï¸ **Bulle explicative**

- `apt update` met Ã  jour la liste des paquets.

- `apt install --reinstall` restaure le noyau.

- `update-grub` regÃ©nÃ¨re le fichier `grub.cfg` pour pointer sur le bon kernel.

---

### 4.4. Sortie et redÃ©marrage

```bash
exit
sudo umount /mnt/{dev,proc,sys}
sudo umount /mnt
sudo reboot
```

ðŸ—¨ï¸ **Bulle explicative**  
Ces commandes dÃ©montent proprement les systÃ¨mes montÃ©s et redÃ©marrent la machine, qui doit Ã  prÃ©sent booter normalement.

---

## ðŸ” 5. VÃ©rification / RÃ©sultats attendus

```bash
uname -r
ls /boot
systemctl status ssh --no-pager
journalctl -b | grep "Started"
```

ðŸ—¨ï¸ **Bulle explicative**

- `uname -r` affiche la version du kernel restaurÃ©.

- `ls /boot` confirme la prÃ©sence du noyau.

- `journalctl -b` montre les services lancÃ©s avec succÃ¨s par `systemd`.

---

## ðŸ§¹ 6. Nettoyage / rollback

```bash
sudo rm /boot/vmlinuz-*.bak
```

ðŸ—¨ï¸ **Bulle explicative**  
Supprime la sauvegarde du noyau simulÃ© pour garder `/boot` propre.

---

## ðŸ’¡ 7. Astuces & PiÃ¨ges frÃ©quents

| ProblÃ¨me                 | Cause probable                   | Solution                         |
| ------------------------ | -------------------------------- | -------------------------------- |
| `file not found` au boot | Fichier noyau ou initrd supprimÃ© | RÃ©installer `linux-image-amd64`  |
| `grub rescue>`           | MBR ou GRUB corrompu             | `grub-install /dev/sda`          |
| Boot lent                | Service bloquÃ©                   | `systemd-analyze blame`          |
| Aucun log kernel         | `rsyslog` inactif                | `systemctl enable --now rsyslog` |

---

### âœ… RÃ©sumÃ© de lâ€™atelier

- ComprÃ©hension complÃ¨te de la sÃ©quence BIOS â†’ MBR â†’ GRUB â†’ Kernel â†’ systemd.

- Lecture des journaux via `dmesg` et `journalctl`.

- RÃ©paration dâ€™un systÃ¨me Debian via `chroot` et rÃ©installation du noyau.

- Configuration du clavier, SSH et outils essentiels sur un environnement Live.

- 
