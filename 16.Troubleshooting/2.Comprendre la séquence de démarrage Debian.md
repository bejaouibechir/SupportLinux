

# 🧠 Atelier 1 – Comprendre la séquence de démarrage Debian

**Niveau 1 – Amorçage & bases du boot (Debian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Le processus de démarrage (boot) d’un système Linux Debian est une chaîne d’étapes interdépendantes :  
**BIOS → MBR → GRUB → Kernel → systemd.**

L’objectif de cet atelier est de :

- Comprendre le rôle de chaque étape.

- Examiner les fichiers et journaux liés au boot.

- Simuler une panne (kernel manquant) et la réparer via un environnement `chroot`.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1. Télécharger l’image Debian 13 Trixie (Live ou netinst)

📥 Téléchargement direct :  
➡️ **ISO netinst (classique, 64 bits)**  
https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-13.1.0-amd64-netinst.iso

➡️ **ISO Live (avec environnement GNOME et Terminal préinstallé)**  
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

💡 **Astuce sécurité :**  
Téléchargez également le fichier `.sha256sum` pour vérifier l’intégrité :

```bash
sha256sum debian-live-13.1.0-amd64-gnome.iso
```

---

### 2.2. Script de préparation (AZERTY + SSH + Utilitaires)

Créer le fichier **setup_server.sh** :

```bash
#!/usr/bin/env bash
# Ce script configure le clavier en AZERTY, installe SSH et les utilitaires de base
# Usage : sudo bash setup_server.sh

set -euo pipefail

echo "---- Étape 1 : configuration du clavier ----"
sudo sed -i 's/XKBLAYOUT=.*/XKBLAYOUT=\"fr\"/' /etc/default/keyboard
sudo sed -i 's/XKBVARIANT=.*/XKBVARIANT=\"\"/' /etc/default/keyboard
sudo dpkg-reconfigure --frontend noninteractive keyboard-configuration
sudo udevadm trigger --subsystem-match=input --action=change

echo "---- Étape 2 : mise à jour du système ----"
sudo apt update && sudo apt upgrade -y

echo "---- Étape 3 : installation du serveur SSH ----"
sudo apt install -y openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh

echo "---- Étape 4 : installation des utilitaires ----"
sudo apt install -y vim htop curl wget net-tools

echo "---- Étape 5 : vérification ----"
sudo systemctl status ssh --no-pager
localectl status | grep "VC Keymap"
```

🗨️ **Explication détaillée**

- `set -euo pipefail` : stoppe le script si une erreur se produit.

- Bloc 1 : Configure le clavier AZERTY en remplaçant la disposition `XKBLAYOUT` et applique la nouvelle configuration immédiatement.

- Bloc 2 : Met à jour le système avec les dernières versions de paquets.

- Bloc 3 : Installe et active le service SSH pour permettre un accès distant.

- Bloc 4 : Installe des outils utiles pour la supervision et le dépannage.

- Bloc 5 : Vérifie que SSH fonctionne et que le clavier est bien configuré.

---

## 🧩 3. Étude de la séquence de démarrage Debian

### 3.1. BIOS / UEFI

```bash
sudo dmidecode -t bios | grep -E "Vendor|Version|Release"
```

🗨️ **Bulle explicative**  
Cette commande affiche les informations du firmware : constructeur, version, et date.  
Le BIOS (ou UEFI) initialise le matériel et cherche un périphérique amorçable (disque, clé USB, CD).

---

### 3.2. MBR (Master Boot Record)

```bash
sudo dd if=/dev/sda bs=512 count=1 | hexdump -C | head
```

🗨️ **Bulle explicative**  
Le MBR est le tout premier secteur du disque (512 octets).  
Cette commande en affiche le contenu hexadécimal pour vérification.  
Il contient le code d’amorçage initial (premier niveau de GRUB) et la table de partitions.

---

### 3.3. GRUB (Grand Unified Bootloader)

```bash
ls /boot/grub
cat /boot/grub/grub.cfg | head -n 10
```

🗨️ **Bulle explicative**  
GRUB est le chargeur de deuxième niveau.  
Le répertoire `/boot/grub` contient sa configuration, notamment `grub.cfg`, où figurent les entrées de menu vers le noyau Linux et l’image initramfs.

---

### 3.4. Kernel (noyau Linux)

```bash
ls -lh /boot
```

🗨️ **Bulle explicative**  
Cette commande liste les fichiers de démarrage :

- `vmlinuz-…` : le noyau Linux.

- `initrd.img-…` : l’image initiale montée en RAM.

- `System.map` et `config` : symboles et configuration du noyau.

---

```bash
dmesg | less
```

🗨️ **Bulle explicative**  
`dmesg` affiche les messages du noyau depuis le démarrage : détection matériel, montages, pilotes chargés.

---

### 3.5. systemd (PID 1)

```bash
ps -p 1 -o comm=
```

🗨️ **Bulle explicative**  
Le processus 1 (`PID 1`) est `systemd`, responsable du lancement des unités (services, sockets, cibles).

```bash
systemd-analyze
systemd-analyze blame | head
```

🗨️ **Bulle explicative**  
Analyse le temps de démarrage global et affiche les services les plus lents à se lancer.

---

## 🧰 4. Simulation d’un kernel manquant & réparation via chroot

### 4.1. Simulation de la panne

```bash
sudo mv /boot/vmlinuz-$(uname -r) /boot/vmlinuz-$(uname -r).bak
sudo reboot
```

🗨️ **Bulle explicative**  
On déplace le fichier du noyau pour simuler une suppression.  
Au redémarrage, GRUB affichera une erreur : `file not found`.

---

### 4.2. Réparation depuis un Live ISO

1. Démarrez la machine avec **Debian Live 13**.

2. Identifiez la partition système :
   
   ```bash
   sudo fdisk -l
   ```

3. Montez-la :
   
   ```bash
   sudo mount /dev/sda1 /mnt
   ```

4. Montez les systèmes virtuels nécessaires :
   
   ```bash
   sudo mount --bind /dev /mnt/dev
   sudo mount --bind /proc /mnt/proc
   sudo mount --bind /sys /mnt/sys
   ```

5. Entrez dans l’environnement du système installé :
   
   ```bash
   sudo chroot /mnt
   ```

🗨️ **Bulle explicative**  
`chroot` change la racine du système de fichiers vers `/mnt`, simulant un démarrage complet du vrai système.  
Cela permet d’utiliser `apt`, `update-grub`, etc., comme si on était démarré dessus.

---

### 4.3. Réinstallation du kernel

```bash
apt update
apt install --reinstall linux-image-amd64
update-grub
```

🗨️ **Bulle explicative**

- `apt update` met à jour la liste des paquets.

- `apt install --reinstall` restaure le noyau.

- `update-grub` regénère le fichier `grub.cfg` pour pointer sur le bon kernel.

---

### 4.4. Sortie et redémarrage

```bash
exit
sudo umount /mnt/{dev,proc,sys}
sudo umount /mnt
sudo reboot
```

🗨️ **Bulle explicative**  
Ces commandes démontent proprement les systèmes montés et redémarrent la machine, qui doit à présent booter normalement.

---

## 🔍 5. Vérification / Résultats attendus

```bash
uname -r
ls /boot
systemctl status ssh --no-pager
journalctl -b | grep "Started"
```

🗨️ **Bulle explicative**

- `uname -r` affiche la version du kernel restauré.

- `ls /boot` confirme la présence du noyau.

- `journalctl -b` montre les services lancés avec succès par `systemd`.

---

## 🧹 6. Nettoyage / rollback

```bash
sudo rm /boot/vmlinuz-*.bak
```

🗨️ **Bulle explicative**  
Supprime la sauvegarde du noyau simulé pour garder `/boot` propre.

---

## 💡 7. Astuces & Pièges fréquents

| Problème                 | Cause probable                   | Solution                         |
| ------------------------ | -------------------------------- | -------------------------------- |
| `file not found` au boot | Fichier noyau ou initrd supprimé | Réinstaller `linux-image-amd64`  |
| `grub rescue>`           | MBR ou GRUB corrompu             | `grub-install /dev/sda`          |
| Boot lent                | Service bloqué                   | `systemd-analyze blame`          |
| Aucun log kernel         | `rsyslog` inactif                | `systemctl enable --now rsyslog` |

---

### ✅ Résumé de l’atelier

- Compréhension complète de la séquence BIOS → MBR → GRUB → Kernel → systemd.

- Lecture des journaux via `dmesg` et `journalctl`.

- Réparation d’un système Debian via `chroot` et réinstallation du noyau.

- Configuration du clavier, SSH et outils essentiels sur un environnement Live.
