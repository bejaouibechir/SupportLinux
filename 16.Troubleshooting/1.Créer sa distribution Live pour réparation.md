

# Atelier — Générer un **CD/ISO Debian Live** avec `live-build`

## 1) Contexte & objectif

- **Objectif V1** : générer une ISO Debian Live minimale, reproductible, avec `live-build`.

- **Objectif V2** : même ISO mais **embarquant deux scripts** exécutés au **premier démarrage** :
  
  1. Configurer le clavier en **AZERTY**.
  
  2. Installer/activer **OpenSSH Server**.

- **Nettoyage** : un script **`cleanup_build_env.sh`** pour remettre la machine hôte à plat entre deux tests.

## 2) Préparation de l’environnement

- Machine hôte : Debian/Ubuntu (ou dérivée) avec `sudo`.

- Paquets requis : `live-build`.

```bash
sudo apt update
sudo apt install -y live-build
```

> Conseil : travaillez dans un répertoire dédié (ex. `~/atelier-live-build`).

---

## 3) Exécution pas à pas

### 3.1 — Version 1 : ISO Debian Live minimale (script unique)

Créer le fichier **build_live_minimal.sh** :

```bash
#!/usr/bin/env bash
# ---------------------------------------------------------------
# build_live_minimal.sh
# Génère une ISO Debian Live minimale (bookworm, amd64) avec
# une configuration inline via `lb config` (sans fichiers externes).
# ---------------------------------------------------------------
set -euo pipefail

# 1) Définir l’espace de travail (modifiable)
WB="${HOME}/ma_debian_perso_v1"

# 2) Réinitialiser l’espace de travail
rm -rf "${WB}"
mkdir -p "${WB}"
cd "${WB}"

# 3) Configurer live-build (options essentielles)
#    - Mode Debian, image live, arch amd64, ISO hybride BIOS/UEFI
#    - Dépôts main/contrib/non-free (+ firmware)
#    - Installeur "live" (installe la distrib telle que construite)
sudo lb config noauto \
  --mode "debian" \
  --system "live" \
  --distribution "bookworm" \
  --architecture "amd64" \
  --archive-areas "main contrib non-free non-free-firmware" \
  --security "true" \
  --updates "true" \
  --backports "false" \
  --binary-images "iso-hybrid" \
  --bootloaders "syslinux grub-efi" \
  --apt-indices "true" \
  --apt-recommends "true" \
  --apt-secure "true" \
  --apt-source-archives "false" \
  --linux-package "linux-image linux-headers" \
  --debian-installer "live" \
  --debian-installer-distribution "bookworm" \
  --debian-installer-gui "true" \
  --firmware-binary "true" \
  --firmware-chroot "true" \
  --iso-publisher "Atelier Live; https://exemple.local; contact@exemple.local" \
  --memtest "none" \
  --win32-loader "false" \
  --clean \
  --debug \
  --verbose \
  --source "false"

# 4) Construire l’ISO (log affiché + build.log sur disque)
sudo lb build 2>&1 | tee build.log

# 5) Résultat attendu
ISO="$(ls -1 ${WB}/live-image-*.iso 2>/dev/null || ls -1 ${WB}/live-image-*.hybrid.iso 2>/dev/null || true)"
echo "ISO générée : ${ISO:-non_trouvée}"
```

**Exécuter :**

```bash
chmod +x build_live_minimal.sh
./build_live_minimal.sh
```

**Résultat attendu :** un fichier `live-image-amd64.hybrid.iso` dans `~/ma_debian_perso_v1/`.

---

### 3.2 — Version 2 : ISO avec **scripts embarqués** exécutés au **premier boot**

#### Étape A — Préparer les **sources locales** que le script de build copiera dans l’ISO

Créer le fichier **lists/xfce.chroot** (liste de paquets) :

```bash
# XFCE minimal + utilitaires utiles en atelier (français, navigateur, outils)
task-french-desktop task-french
xfce4 xfce4-goodies xfce4-terminal mousepad
network-manager-gnome curl wget
vim htop less bash-completion
firefox-esr firefox-esr-l10n-fr
openssh-client
```

Créer le fichier **payload/clavier_azerty.sh** :

```bash
#!/usr/bin/env bash
# Configure le clavier en AZERTY (FR) pour la console et X11.
set -euo pipefail

echo "[clavier_azerty] Configuration du clavier en fr (pc105)..."

# Console (kbd)
sudo sed -i 's/^XKBLAYOUT=.*/XKBLAYOUT="fr"/' /etc/default/keyboard || true
sudo sed -i 's/^XKBMODEL=.*/XKBMODEL="pc105"/' /etc/default/keyboard || true
sudo dpkg-reconfigure -f noninteractive keyboard-configuration || true
sudo setupcon || true

# X11 (si localectl dispo)
if command -v localectl >/dev/null 2>&1; then
  sudo localectl set-x11-keymap fr pc105 "" ""
fi

echo "[clavier_azerty] OK. Relancez la session graphique si nécessaire."
```

Créer le fichier **payload/install_ssh.sh** :

```bash
#!/usr/bin/env bash
# Installe et active OpenSSH Server.
set -euo pipefail

echo "[install_ssh] Installation et activation d'OpenSSH Server..."

sudo apt-get update -y
sudo apt-get install -y openssh-server

sudo systemctl enable ssh || sudo systemctl enable ssh.service || true
sudo systemctl restart ssh || sudo systemctl restart ssh.service || true

echo "[install_ssh] Terminé. Pensez à un mot de passe fort (passwd) ou aux clés SSH."
```

Créer le fichier **systemd/firstboot-tasks.sh** :

```bash
#!/usr/bin/env bash
# Lance une seule fois au premier boot les scripts du payload.
set -euo pipefail

STAMP="/var/lib/firstboot/.done"
PAYLOAD="/opt/payload"
mkdir -p "$(dirname "${STAMP}")"

if [ -f "${STAMP}" ]; then
  echo "[firstboot] Déjà exécuté, on sort."
  exit 0
fi

echo "[firstboot] Exécution des scripts de payload..."

if [ -x "${PAYLOAD}/clavier_azerty.sh" ]; then
  bash "${PAYLOAD}/clavier_azerty.sh" || echo "[firstboot] clavier_azerty a échoué."
fi
if [ -x "${PAYLOAD}/install_ssh.sh" ]; then
  bash "${PAYLOAD}/install_ssh.sh" || echo "[firstboot] install_ssh a échoué."
fi

date | sudo tee "${STAMP}" >/dev/null
echo "[firstboot] Terminé."
```

Créer le fichier **systemd/firstboot-tasks.service** :

```ini
[Unit]
Description=First boot tasks (payload scripts)
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/firstboot-tasks.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

> Arborescence attendue côté hôte (vous) avant le build V2 :  
> `lists/xfce.chroot`  
> `payload/clavier_azerty.sh`  
> `payload/install_ssh.sh`  
> `systemd/firstboot-tasks.sh`  
> `systemd/firstboot-tasks.service`

Assurez-vous que les trois scripts sont exécutables :

```bash
chmod +x payload/*.sh systemd/firstboot-tasks.sh
```

#### Étape B — Script de **build** qui assemble tout et produit l’ISO

Créer le fichier **build_live_with_payload.sh** :

```bash
#!/usr/bin/env bash
# ---------------------------------------------------------------
# build_live_with_payload.sh
# Construit une ISO Debian Live (bookworm, amd64) en embarquant :
#  - /opt/payload/clavier_azerty.sh
#  - /opt/payload/install_ssh.sh
#  - Service systemd firstboot-tasks.service + script wrapper,
#    exécutés automatiquement au premier démarrage (une seule fois).
#  - Liste de paquets XFCE depuis lists/xfce.chroot
# ---------------------------------------------------------------
set -euo pipefail

# 1) Vérifier la présence des sources locales
for f in "lists/xfce.chroot" \
         "payload/clavier_azerty.sh" "payload/install_ssh.sh" \
         "systemd/firstboot-tasks.sh" "systemd/firstboot-tasks.service"
do
  [[ -f "$f" ]] || { echo "Manquant: $f"; exit 1; }
done

# 2) Espace de travail
WB="${HOME}/ma_debian_perso_v2"
rm -rf "${WB}"
mkdir -p "${WB}"
cd "${WB}"

# 3) Config live-build
sudo lb config noauto \
  --mode "debian" \
  --system "live" \
  --distribution "bookworm" \
  --architecture "amd64" \
  --archive-areas "main contrib non-free non-free-firmware" \
  --security "true" \
  --updates "true" \
  --backports "false" \
  --binary-images "iso-hybrid" \
  --bootloaders "syslinux grub-efi" \
  --apt-indices "true" \
  --apt-recommends "true" \
  --apt-secure "true" \
  --apt-source-archives "false" \
  --linux-package "linux-image linux-headers" \
  --debian-installer "live" \
  --debian-installer-distribution "bookworm" \
  --debian-installer-gui "true" \
  --firmware-binary "true" \
  --firmware-chroot "true" \
  --iso-publisher "Atelier Live; https://exemple.local; contact@exemple.local" \
  --memtest "none" \
  --win32-loader "false" \
  --clean \
  --debug \
  --verbose \
  --source "false"

# 4) Déposer la liste de paquets (XFCE) dans config/
mkdir -p ./config/packages-lists
cp -a "${OLDPWD}/lists/xfce.chroot" ./config/packages-lists/

# 5) Embarquer les scripts dans l’image :
#    - /opt/payload/* (les deux scripts demandés)
#    - /usr/local/sbin/firstboot-tasks.sh (wrapper)
#    - service systemd + symlink WantedBy
install -d ./config/includes.chroot/opt/payload
install -m 0755 "${OLDPWD}/payload/clavier_azerty.sh" ./config/includes.chroot/opt/payload/
install -m 0755 "${OLDPWD}/payload/install_ssh.sh"    ./config/includes.chroot/opt/payload/

install -d ./config/includes.chroot/usr/local/sbin
install -m 0755 "${OLDPWD}/systemd/firstboot-tasks.sh" ./config/includes.chroot/usr/local/sbin/

install -d ./config/includes.chroot/etc/systemd/system
install -m 0644 "${OLDPWD}/systemd/firstboot-tasks.service" ./config/includes.chroot/etc/systemd/system/

install -d ./config/includes.chroot/etc/systemd/system/multi-user.target.wants
ln -sf /etc/systemd/system/firstboot-tasks.service \
      ./config/includes.chroot/etc/systemd/system/multi-user.target.wants/firstboot-tasks.service

# 6) (Option sécurité clavier) Définir AZERTY par défaut dans l’image
install -d ./config/includes.chroot/etc/default
cat > ./config/includes.chroot/etc/default/keyboard <<'EOK'
XKBMODEL="pc105"
XKBLAYOUT="fr"
XKBVARIANT=""
XKBOPTIONS=""
BACKSPACE="guess"
EOK

# 7) Construire l’ISO (log affiché + build.log)
sudo lb build 2>&1 | tee build.log

# 8) Résultat
ISO="$(ls -1 ${WB}/live-image-*.iso 2>/dev/null || ls -1 ${WB}/live-image-*.hybrid.iso 2>/dev/null || true)"
echo "ISO générée : ${ISO:-non_trouvée}"
echo "Au premier boot : clavier AZERTY + OpenSSH Server seront configurés."
```

**Exécuter :**

```bash
chmod +x build_live_with_payload.sh
./build_live_with_payload.sh
```

**Résultat attendu :**

- Un fichier `live-image-amd64.hybrid.iso` dans `~/ma_debian_perso_v2/`.

- **Premier démarrage** :
  
  - Le service **`firstboot-tasks.service`** s’exécute **une seule fois**.
  
  - Clavier basculé en **fr** (console + X11).
  
  - **OpenSSH Server** installé, service **`ssh`** activé/actif.

---

### 3.3 — Programme de **nettoyage** (hôte) pour rejouer vite

Créer le fichier **cleanup_build_env.sh** :

```bash
#!/usr/bin/env bash
# ---------------------------------------------------------------
# cleanup_build_env.sh
# Nettoie les workspaces de build live-build (V1/V2) pour rejouer
# rapidement de nouveaux tests. Conserve les ISO par défaut.
# Option --full : supprime aussi les ISO générées.
# ---------------------------------------------------------------
set -euo pipefail

WBS=(
  "${HOME}/ma_debian_perso_v1"
  "${HOME}/ma_debian_perso_v2"
)

FULL=0
if [[ "${1:-}" == "--full" ]]; then
  FULL=1
fi

for WB in "${WBS[@]}"; do
  [[ -d "${WB}" ]] || continue
  echo "[cleanup] Workspace: ${WB}"
  pushd "${WB}" >/dev/null || continue

  # 1) lb clean + purge fichiers générés
  sudo lb clean || true
  rm -f config/binary config/bootstrap config/chroot config/common config/source 2>/dev/null || true
  rm -f build.log 2>/dev/null || true

  # 2) Répertoires lourds éventuels
  sudo rm -rf cache chroot local 2>/dev/null || true

  # 3) Cache apt local machine (facultatif)
  sudo apt-get clean || true
  sudo rm -rf /var/cache/apt/archives/*.deb 2>/dev/null || true

  # 4) Suppression des ISO en mode --full
  if [[ ${FULL} -eq 1 ]]; then
    echo "[cleanup] Suppression des ISO dans ${WB}"
    sudo rm -f "${WB}"/live-image-*.iso "${WB}"/live-image-*.hybrid.iso 2>/dev/null || true
  fi

  popd >/dev/null || true
done

echo "[cleanup] OK."
```

**Exécuter :**

```bash
chmod +x cleanup_build_env.sh
./cleanup_build_env.sh         # nettoie sans supprimer les ISO
./cleanup_build_env.sh --full  # nettoie et supprime aussi les ISO
```

---

## 4) Vérifications / Résultats attendus

### Version 1

- ISO générée.

- Boot VM : session Live accessible (en anglais par défaut si vous n’avez pas ajouté de liste de paquets locale).

### Version 2

- ISO générée.

- **Premier boot** :
  
  - `journalctl -u firstboot-tasks.service -b` montre l’exécution.
  
  - `localectl status` → X11 keymap `fr`.
  
  - `/etc/default/keyboard` → `XKBLAYOUT="fr"` ; console en AZERTY.
  
  - `systemctl status ssh` → actif ; connexion possible depuis une autre machine.

---

## 5) Cleanup / Rollback

- Rejouer un build propre :
  
  - `./cleanup_build_env.sh` puis `./build_live_minimal.sh` **ou** `./build_live_with_payload.sh`.

- En cas d’échec de build :
  
  - Consulter `build.log` dans le workspace (V1/V2).
  
  - Relancer après `cleanup`.

---

## 6) Tips & pitfalls (retours d’expérience)

- **Droits root** : `lb build` et `lb clean` nécessitent sudo.

- **Espace disque** : prévoir plusieurs Go libres (cache apt + chroot + ISO).

- **UEFI/BIOS** : `--bootloaders "syslinux grub-efi"` rend l’ISO hybride (VMs variées).

- **Réseau** : pour accélérer les builds, garder un cache local (proxy apt) si possible.

- **Reproductibilité** : épingler la **distribution** (`bookworm`) et éviter les backports pour un atelier stable.

- **Sécurité** : en V2, pensez à **changer le mot de passe** (ou utiliser des **clés SSH**) si vous exposez la machine.

Oui, c’est possible — et on va le faire proprement sous forme d’atelier prêt-à-l’emploi, avec scripts **entièrement commentés** et sans “split view”.

---

# Les scripts en block

## Version 1 — ISO Debian Live minimale (XFCE en exemple)

**Structure générée automatiquement** :  
`$HOME/ma_debian_perso/auto/{config,build,clean}`, `config/*`, etc.

Créer le fichier **build_live_minimal.sh** :

```bash
#!/usr/bin/env bash
# -------------------------------------------------------------------
# Script : build_live_minimal.sh
# But    : Construire une ISO Debian Live minimale (XFCE) avec live-build
# Usage  : ./build_live_minimal.sh
# Notes  : - Crée un workspace propre dans $HOME/ma_debian_perso
#          - Ajoute une liste de paquets simple
#          - Construit une ISO hybride (BIOS/UEFI) "bookworm"
# -------------------------------------------------------------------
set -euo pipefail

# 1) Définir le répertoire de travail (modifiable)
WB="${HOME}/ma_debian_perso"

# 2) (Ré)initialiser un workspace propre
rm -rf "${WB}"
mkdir -p "${WB}/auto" "${WB}/config"
cd "${WB}"

# 3) Récupérer des squelettes d'auto/* fournis par live-build (exemples)
#    - Certains systèmes n'ont pas les exemples — on crée nos propres scripts plus bas.
if [ -d /usr/share/doc/live-build/examples/auto ]; then
  cp -a /usr/share/doc/live-build/examples/auto/* ./auto/ || true
fi

# 4) Créer auto/config : options de build principales
cat > ./auto/config <<'EOF'
#!/bin/sh
set -e
lb config noauto \
  --mode "debian" \
  --system "live" \
  --distribution "bookworm" \
  --architecture "amd64" \
  --archive-areas "main contrib non-free non-free-firmware" \
  --security "true" \
  --updates "true" \
  --backports "false" \
  --binary-images "iso-hybrid" \
  --bootloaders "syslinux grub-efi" \
  --apt-indices "true" \
  --apt-recommends "true" \
  --apt-secure "true" \
  --apt-source-archives "false" \
  --linux-package "linux-image linux-headers" \
  --debian-installer "live" \
  --debian-installer-distribution "bookworm" \
  --debian-installer-gui "true" \
  --firmware-binary "true" \
  --firmware-chroot "true" \
  --iso-publisher "Atelier Live; https://exemple.local; contact@exemple.local" \
  --memtest "none" \
  --win32-loader "false" \
  --clean \
  --debug \
  --verbose \
  --source "false" \
  "${@}"
EOF
chmod +x ./auto/config

# 5) Créer auto/build : lancement + log
cat > ./auto/build <<'EOF'
#!/bin/sh
set -e
lb build noauto "$@" 2>&1 | tee build.log
EOF
chmod +x ./auto/build

# 6) Créer auto/clean : nettoyage standard live-build
cat > ./auto/clean <<'EOF'
#!/bin/sh
set -e
lb clean noauto "$@"
rm -f config/binary config/bootstrap config/chroot config/common config/source
rm -f build.log
EOF
chmod +x ./auto/clean

# 7) Ajouter une liste de paquets XFCE (basique mais utilisable)
mkdir -p ./config/packages-lists
cat > ./config/packages-lists/xfce.chroot <<'EOF'
# Environnement XFCE minimal + utilitaires fréquents
task-french-desktop task-french
xfce4 xfce4-goodies xfce4-terminal mousepad
network-manager-gnome curl wget
vim htop less bash-completion
firefox-esr firefox-esr-l10n-fr
openssh-client
EOF

# 8) (Optionnel) Thème clavier FR directement (utile même sans script V2)
mkdir -p ./config/includes.chroot/etc/default
cat > ./config/includes.chroot/etc/default/keyboard <<'EOF'
XKBMODEL="pc105"
XKBLAYOUT="fr"
XKBVARIANT=""
XKBOPTIONS=""
BACKSPACE="guess"
EOF

# 9) Construire l’ISO
sudo ./auto/config
sudo ./auto/build

echo "ISO générée : ${WB}/live-image-amd64.hybrid.iso"
```



## Version 2 — ISO avec **scripts embarqués** + **exécution au premier démarrage**

**Idée** : on **embarque deux scripts** dans l’image (sous `/opt/payload`) et on installe un **service systemd one-shot** qui, au **premier boot**, exécute ces scripts puis se désactive.

Créer le fichier **build_live_with_payload.sh** :

```bash
#!/usr/bin/env bash
# -------------------------------------------------------------------
# Script : build_live_with_payload.sh
# But    : Construire une ISO Debian Live + embarquer deux scripts
#          1) clavier_azerty.sh : bascule clavier en AZERTY
#          2) install_ssh.sh    : installe et active OpenSSH Server
#          + service systemd firstboot-tasks.service pour exécution auto
# Usage  : ./build_live_with_payload.sh
# -------------------------------------------------------------------
set -euo pipefail

WB="${HOME}/ma_debian_perso_payload"

# 1) Workspace propre
rm -rf "${WB}"
mkdir -p "${WB}/auto" "${WB}/config" "${WB}/payload"
cd "${WB}"

# 2) Scripts à embarquer (seront accessibles dans le Live sous /opt/payload)
mkdir -p ./payload

# 2.a) Script clavier -> AZERTY (console + X11)
cat > ./payload/clavier_azerty.sh <<'EOF'
#!/usr/bin/env bash
# Ce script configure le clavier en AZERTY (FR) pour la console et X11.
set -euo pipefail

echo "[clavier_azerty] Configuration du clavier en fr (pc105)..."

# Console (kbd)
sudo sed -i 's/^XKBLAYOUT=.*/XKBLAYOUT="fr"/' /etc/default/keyboard || true
sudo sed -i 's/^XKBMODEL=.*/XKBMODEL="pc105"/' /etc/default/keyboard || true
sudo dpkg-reconfigure -f noninteractive keyboard-configuration || true
sudo setupcon || true

# Environnements X (si systemd-localed présent)
if command -v localectl >/dev/null 2>&1; then
  sudo localectl set-x11-keymap fr pc105 "" ""
fi

echo "[clavier_azerty] OK. Vous pouvez relancer la session graphique si nécessaire."
EOF
chmod +x ./payload/clavier_azerty.sh

# 2.b) Script installer SSH + activer au boot
cat > ./payload/install_ssh.sh <<'EOF'
#!/usr/bin/env bash
# Ce script installe le serveur OpenSSH et l'active.
set -euo pipefail

echo "[install_ssh] Installation et activation d'OpenSSH Server..."

# Mise à jour de l'index + install
sudo apt-get update -y
sudo apt-get install -y openssh-server

# Activer et démarrer le service
sudo systemctl enable ssh || sudo systemctl enable ssh.service || true
sudo systemctl restart ssh || sudo systemctl restart ssh.service || true

# Conseils : modifier le mot de passe et/ou clés
echo "[install_ssh] Terminé. Pensez à définir un mot de passe fort (passwd) ou des clés SSH."
EOF
chmod +x ./payload/install_ssh.sh

# 3) Scripts "wrapper" et service systemd pour exécution au premier boot
mkdir -p ./config/includes.chroot/usr/local/sbin
cat > ./config/includes.chroot/usr/local/sbin/firstboot-tasks.sh <<'EOF'
#!/usr/bin/env bash
# Script lancé une seule fois au premier démarrage du Live.
# - Exécute les deux scripts embarqués dans /opt/payload
# - Se marque comme "fait" via un fichier drapeau pour ne pas se relancer
set -euo pipefail

STAMP="/var/lib/firstboot/.done"
PAYLOAD="/opt/payload"
mkdir -p "$(dirname "${STAMP}")"

if [ -f "${STAMP}" ]; then
  echo "[firstboot] Déjà exécuté, on sort."
  exit 0
fi

echo "[firstboot] Exécution des scripts de payload..."

# Exécuter clavier_azerty puis install_ssh si présents
if [ -x "${PAYLOAD}/clavier_azerty.sh" ]; then
  bash "${PAYLOAD}/clavier_azerty.sh" || echo "[firstboot] clavier_azerty a renvoyé une erreur."
fi
if [ -x "${PAYLOAD}/install_ssh.sh" ]; then
  bash "${PAYLOAD}/install_ssh.sh" || echo "[firstboot] install_ssh a renvoyé une erreur."
fi

# Marquer comme exécuté
date | sudo tee "${STAMP}" >/dev/null
echo "[firstboot] Terminé."
EOF
chmod +x ./config/includes.chroot/usr/local/sbin/firstboot-tasks.sh

# 3.b) Service systemd one-shot
mkdir -p ./config/includes.chroot/etc/systemd/system
cat > ./config/includes.chroot/etc/systemd/system/firstboot-tasks.service <<'EOF'
[Unit]
Description=First boot tasks (payload scripts)
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/firstboot-tasks.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 4) Copier les scripts payload dans l'image, sous /opt/payload
mkdir -p ./config/includes.chroot/opt/payload
cp -a ./payload/* ./config/includes.chroot/opt/payload/

# 5) Activer le service au boot (drop-in de symlink via chroot includes)
#    -> systemd-respecte WantedBy=multi-user.target, mais on force le symlink pour garantir.
mkdir -p ./config/includes.chroot/etc/systemd/system/multi-user.target.wants
ln -sf /etc/systemd/system/firstboot-tasks.service \
       ./config/includes.chroot/etc/systemd/system/multi-user.target.wants/firstboot-tasks.service

# 6) Config live-build (similaire à la V1)
cat > ./auto/config <<'EOF'
#!/bin/sh
set -e
lb config noauto \
  --mode "debian" \
  --system "live" \
  --distribution "bookworm" \
  --architecture "amd64" \
  --archive-areas "main contrib non-free non-free-firmware" \
  --security "true" \
  --updates "true" \
  --backports "false" \
  --binary-images "iso-hybrid" \
  --bootloaders "syslinux grub-efi" \
  --apt-indices "true" \
  --apt-recommends "true" \
  --apt-secure "true" \
  --apt-source-archives "false" \
  --linux-package "linux-image linux-headers" \
  --debian-installer "live" \
  --debian-installer-distribution "bookworm" \
  --debian-installer-gui "true" \
  --firmware-binary "true" \
  --firmware-chroot "true" \
  --iso-publisher "Atelier Live; https://exemple.local; contact@exemple.local" \
  --memtest "none" \
  --win32-loader "false" \
  --clean \
  --debug \
  --verbose \
  --source "false" \
  "${@}"
EOF
chmod +x ./auto/config

# 7) auto/build + auto/clean
cat > ./auto/build <<'EOF'
#!/bin/sh
set -e
lb build noauto "$@" 2>&1 | tee build.log
EOF
chmod +x ./auto/build

cat > ./auto/clean <<'EOF'
#!/bin/sh
set -e
lb clean noauto "$@"
rm -f config/binary config/bootstrap config/chroot config/common config/source
rm -f build.log
EOF
chmod +x ./auto/clean

# 8) Paquets utiles (XFCE + SSH client comme en V1)
mkdir -p ./config/packages-lists
cat > ./config/packages-lists/xfce.chroot <<'EOF'
task-french-desktop task-french
xfce4 xfce4-goodies xfce4-terminal mousepad
network-manager-gnome curl wget
vim htop less bash-completion
firefox-esr firefox-esr-l10n-fr
openssh-client
EOF

# 9) (Optionnel) AZERTY par défaut côté image (au cas où le firstboot échoue)
mkdir -p ./config/includes.chroot/etc/default
cat > ./config/includes.chroot/etc/default/keyboard <<'EOF'
XKBMODEL="pc105"
XKBLAYOUT="fr"
XKBVARIANT=""
XKBOPTIONS=""
BACKSPACE="guess"
EOF

# 10) Construire
sudo ./auto/config
sudo ./auto/build

echo "ISO générée : ${WB}/live-image-amd64.hybrid.iso"
echo "Note : Au premier boot, les scripts payload seront exécutés automatiquement."
```

### Ce que fait la Version 2 au premier démarrage

- Exécute `/opt/payload/clavier_azerty.sh` → clavier en **fr**.

- Exécute `/opt/payload/install_ssh.sh` → installe **openssh-server**, active et démarre `ssh`.

- Place un **drapeau** `/var/lib/firstboot/.done` pour **ne plus relancer** le service aux boots suivants.

---

## Programme de **nettoyage** (machine hôte)

Créer le fichier **cleanup_build_env.sh** :

```bash
#!/usr/bin/env bash
# -------------------------------------------------------------------
# Script : cleanup_build_env.sh
# But    : Nettoyer l'environnement local de build pour rejouer des tests
# Usage  : ./cleanup_build_env.sh [--full]
# Notes  : - Supprime les artefacts live-build (bootstrap, chroot, cache apt)
#          - Conserve par défaut les ISO générées (sauf --full)
# -------------------------------------------------------------------
set -euo pipefail

# Workspaces possibles à nettoyer (ajoutez les vôtres si besoin)
WBS=(
  "${HOME}/ma_debian_perso"
  "${HOME}/ma_debian_perso_payload"
)

FULL=0
if [[ "${1:-}" == "--full" ]]; then
  FULL=1
fi

for WB in "${WBS[@]}"; do
  if [[ -d "${WB}" ]]; then
    echo "[cleanup] Nettoyage du workspace : ${WB}"
    pushd "${WB}" >/dev/null || continue
    # 1) lb clean + suppression des fichiers de config générés
    if [[ -x ./auto/clean ]]; then
      sudo ./auto/clean || true
    else
      sudo lb clean || true
      rm -f config/binary config/bootstrap config/chroot config/common config/source || true
      rm -f build.log || true
    fi
    # 2) Purge des répertoires lourds si résiduels
    sudo rm -rf cache chroot local || true
    # 3) Nettoyage apt local de la machine
    sudo apt-get clean || true
    sudo rm -rf /var/cache/apt/archives/*.deb || true

    # 4) Option --full : supprimer ISO(s)
    if [[ ${FULL} -eq 1 ]]; then
      echo "[cleanup] Suppression des ISO dans ${WB}"
      sudo rm -f "${WB}"/live-image-*.iso "${WB}"/live-image-*.hybrid.iso || true
    fi

    popd >/dev/null || true
  fi
done

echo "[cleanup] Terminé."
```

- **Sans option** : on nettoie tout sauf les ISO (pratique pour conserver une référence).

- **Avec `--full`** : on **supprime aussi les ISO**.

---

## Vérifications & Conseils

1. **Tester l’ISO** (VM/USB). Sur la Version 2, après le premier boot, vérifier :
   
   - Clavier en **fr** (console et X11).
   
   - `ssh` actif : `systemctl status ssh` ; depuis une autre machine, `ssh <user>@<ip-live>`.

2. **Logs first boot** :
   
   - `journalctl -u firstboot-tasks.service -b` (voir la sortie du wrapper).

3. **Rejouer un build propre** :
   
   - `./cleanup_build_env.sh` puis relancer un script de build.

4. **Persistance (optionnel)** : si vous testez sur **clé USB** avec **persistance**, ajouter `persistence` au menu de boot ou l’intégrer dans les entrées `isolinux/grub` lors d’un atelier dédié.


