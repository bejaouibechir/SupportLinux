# ğŸ§  Atelier 5 â€“ Analyse et dÃ©pannage du chargeur `initramfs`

**Niveau 1 â€“ AmorÃ§age & bases du boot (Debian 13 â€œTrixieâ€)**

---

## ğŸ¯ 1. Contexte & Objectif

Lorsque GRUB charge le noyau Linux, il charge Ã©galement une **image compressÃ©e** appelÃ©e `initramfs` (souvent nommÃ©e `/boot/initrd.img-<version>`).  
Cette image contient :

- Les modules essentiels (drivers disque, RAID, LVM, etc.)

- Les outils pour monter la partition racine rÃ©elle `/`

- Le script dâ€™initialisation `/init`

Objectifs pÃ©dagogiques :

- Comprendre le rÃ´le et la structure de lâ€™initramfs.

- Explorer son contenu.

- Diagnostiquer une erreur â€œinitramfs shellâ€ au dÃ©marrage.

- RÃ©gÃ©nÃ©rer lâ€™initramfs pour rÃ©parer un systÃ¨me Debian non bootable.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1 â€“ TÃ©lÃ©chargement du Live Debian 13

ğŸ“¥ Image officielle (Live GNOME, 64-bit) :  
https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-gnome.iso

---

### 2.2 â€“ Script de prÃ©paration rapide

CrÃ©er le fichier **prepare_live_initramfs.sh** :

```bash
#!/usr/bin/env bash
# Configuration de lâ€™environnement Live pour lâ€™analyse dâ€™un initramfs

set -euo pipefail

echo "---- Configuration du clavier franÃ§ais ----"
sudo localectl set-keymap fr
sudo localectl set-x11-keymap fr

echo "---- Installation des outils nÃ©cessaires ----"
sudo apt update
sudo apt install -y vim gzip cpio file binwalk lz4 lzop dracut initramfs-tools
```

ğŸ—¨ï¸ **Bulle explicative**  
Ce script prÃ©pare lâ€™environnement Live :

- `initramfs-tools` et `dracut` : outils de gÃ©nÃ©ration / analyse.

- `binwalk`, `gzip`, `cpio`, `lz4` : nÃ©cessaires pour dÃ©compresser et inspecter une image `initrd`.

---

## ğŸ§© 3. Structure et fonctionnement de `initramfs`

### 3.1 â€“ Fichiers concernÃ©s dans `/boot`

```bash
ls -lh /boot | grep initrd
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche toutes les images `initrd.img-<version>` prÃ©sentes.  
Chaque version correspond Ã  un noyau installÃ©.

---

### 3.2 â€“ VÃ©rification du lien avec GRUB

```bash
grep initrd /boot/grub/grub.cfg | head -n 5
```

ğŸ—¨ï¸ **Bulle explicative**  
Cette commande montre comment GRUB charge lâ€™image `initrd` associÃ©e Ã  un noyau.  
Par exemple :

```
initrd /boot/initrd.img-6.8.0-4-amd64
```

---

### 3.3 â€“ Comprendre la sÃ©quence

Lors du dÃ©marrage :

1. GRUB charge le **noyau** (`vmlinuz-*`) et lâ€™**initrd** (`initrd.img-*`).

2. Le **kernel** monte lâ€™initramfs en mÃ©moire (RAM disk).

3. Le script `/init` de lâ€™initramfs :
   
   - Charge les modules nÃ©cessaires (drivers disque, RAID, LVM, etc.)
   
   - Monte `/` rÃ©el (depuis `/etc/fstab` ou UUID)
   
   - TransfÃ¨re le contrÃ´le Ã  `systemd`

---

## ğŸ” 4. Exploration du contenu dâ€™un initramfs

### 4.1 â€“ CrÃ©er un rÃ©pertoire temporaire

```bash
mkdir /tmp/initramfs && cd /tmp/initramfs
```

---

### 4.2 â€“ Copier et dÃ©compresser une image

```bash
cp /boot/initrd.img-$(uname -r) /tmp/initramfs/
cd /tmp/initramfs
mkdir extracted && cd extracted
zcat ../initrd.img-$(uname -r) | cpio -idmv
```

ğŸ—¨ï¸ **Bulle explicative**

- `zcat` : dÃ©compresse le flux gzip.

- `cpio -idmv` : extrait les fichiers contenus.  
  Le rÃ©pertoire `extracted/` contient dÃ©sormais toute lâ€™arborescence initiale montÃ©e par le noyau.

---

### 4.3 â€“ Explorer la structure extraite

```bash
ls -R | head -n 20
```

ğŸ—¨ï¸ **Bulle explicative**  
Vous y trouverez :

- `/init` â†’ script principal exÃ©cutÃ© par le noyau.

- `/scripts/` â†’ modules de montage (lvm, mdadm, fsck).

- `/conf/` â†’ configuration du root device et options du kernel.

---

### 4.4 â€“ Examiner le script principal `/init`

```bash
less init
```

ğŸ—¨ï¸ **Bulle explicative**  
Ce script dÃ©tecte le pÃ©riphÃ©rique racine (`root=` du noyau) et tente de le monter.  
Si le montage Ã©choue â†’ shell `busybox` (prompt `(initramfs)`).

---

## âš ï¸ 5. Simulation et diagnostic dâ€™une erreur â€œinitramfs shellâ€

### 5.1 â€“ Simulation dâ€™un pÃ©riphÃ©rique racine invalide

```bash
sudo cp /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
sudo sed -i 's/root=UUID=[^ ]*/root=UUID=fake-uuid/' /boot/grub/grub.cfg
```

ğŸ—¨ï¸ **Bulle explicative**  
Cette commande falsifie lâ€™UUID racine.  
Au redÃ©marrage, le systÃ¨me Ã©chouera Ã  trouver la partition racine et vous amÃ¨nera Ã  une invite `(initramfs)`.

---

### 5.2 â€“ Diagnostic depuis le shell initramfs

> Sur la console `(initramfs)` :

```bash
ls /dev
blkid
cat /proc/cmdline
```

ğŸ—¨ï¸ **Bulle explicative**

- `ls /dev` montre les pÃ©riphÃ©riques dÃ©tectÃ©s.

- `blkid` permet de vÃ©rifier les vrais UUID.

- `cat /proc/cmdline` affiche les paramÃ¨tres du noyau (dont le mauvais UUID).

---

## ğŸ§° 6. RÃ©paration via un environnement Live

### 6.1 â€“ Monter et chrooter

```bash
sudo mount /dev/sda1 /mnt
sudo mount --bind /dev /mnt/dev
sudo mount --bind /proc /mnt/proc
sudo mount --bind /sys /mnt/sys
sudo chroot /mnt
```

ğŸ—¨ï¸ **Bulle explicative**  
On accÃ¨de au systÃ¨me installÃ© pour le rÃ©parer.

---

### 6.2 â€“ RÃ©gÃ©nÃ©rer lâ€™initramfs

```bash
update-initramfs -u -k all
```

ğŸ—¨ï¸ **Bulle explicative**  
Reconstruit toutes les images `initrd.img-*` prÃ©sentes.  
Option `-u` = mise Ã  jour, `-k all` = toutes les versions de noyau.

---

### 6.3 â€“ VÃ©rifier le contenu et la date

```bash
ls -lh /boot/initrd.img*
```

ğŸ—¨ï¸ **Bulle explicative**  
VÃ©rifie que lâ€™image a bien Ã©tÃ© reconstruite rÃ©cemment.

---

### 6.4 â€“ RegÃ©nÃ©rer le menu GRUB

```bash
update-grub
exit
sudo reboot
```

ğŸ—¨ï¸ **Bulle explicative**  
Met Ã  jour GRUB pour sâ€™assurer que le chemin de lâ€™image initramfs est correct.  
Le systÃ¨me doit Ã  prÃ©sent dÃ©marrer normalement.

---

## ğŸ§¹ 7. Nettoyage / rollback

```bash
sudo mv /boot/grub/grub.cfg.bak /boot/grub/grub.cfg
sudo rm -rf /tmp/initramfs
```

ğŸ—¨ï¸ **Bulle explicative**  
Restaure la configuration GRUB et supprime le rÃ©pertoire temporaire utilisÃ© pour lâ€™extraction.

---

## ğŸ’¡ 8. Astuces & PiÃ¨ges frÃ©quents

| ProblÃ¨me                         | Cause probable                  | Solution                         |
| -------------------------------- | ------------------------------- | -------------------------------- |
| Invite `(initramfs)` au boot     | PÃ©riphÃ©rique racine introuvable | VÃ©rifier `root=` dans GRUB       |
| Modules manquants dans initramfs | Drivers non inclus              | `update-initramfs -u`            |
| `gzip: invalid magic`            | Image corrompue                 | Supprimer et regÃ©nÃ©rer initrd    |
| Boot trÃ¨s lent                   | Initramfs trop volumineux       | Nettoyer `/lib/modules/` anciens |

---

## âœ… RÃ©sumÃ© de lâ€™atelier

- ComprÃ©hension complÃ¨te du rÃ´le et du contenu de lâ€™initramfs.

- Exploration manuelle de lâ€™image initrd.

- Simulation dâ€™une erreur â€œinitramfs shellâ€.

- RÃ©gÃ©nÃ©ration et rÃ©paration complÃ¨te de lâ€™image via `update-initramfs`.
