# 🧠 Atelier 0 – Monter et explorer une partition système d’une autre machine

**Niveau 1 – Amorçage & bases du boot (Débian 13 “Trixie”)**

---

## 🎯 1. Contexte & Objectif

Quand un système Debian ne démarre plus (problème BIOS, GRUB, kernel, ou systemd), il est souvent nécessaire de :

- **Monter son disque sur une autre machine fonctionnelle**,

- **Explorer / corriger / sauvegarder** ses fichiers critiques,

- **Réinstaller des composants du boot** (GRUB, initramfs, etc.) sans réinstallation complète.

Dans cet atelier, vous allez :

1. Connecter le disque défectueux à une autre machine.

2. Identifier ses partitions.

3. Monter la racine (`/`), le boot (`/boot`), et l’EFI (si UEFI).

4. Explorer les zones sensibles liées au boot (BIOS/MBR/GRUB/Kernel/systemd).

5. Réparer directement depuis la machine saine.

---

## ⚙️ 2. Préparation de l’environnement

### 2.1 – Matériel

- **Machine saine** : Debian 13 fonctionnelle.

- **Disque de la machine en panne** : connecté en SATA, USB, ou NVMe (ex : `/dev/sdb`).

- **Droits root (`sudo`)** requis.

---

### 2.2 – Installation des outils nécessaires

Créer le script **mount_remote_disk_tools.sh** :

```bash
#!/usr/bin/env bash
# Installe les outils nécessaires à l'exploration et la réparation de disques Debian

set -euo pipefail

sudo apt update
sudo apt install -y parted e2fsprogs btrfs-progs lvm2 ntfs-3g mdadm mount htop vim rsync
```

🗨️ **Bulle explicative**  
Ce script installe tous les outils nécessaires à la détection, la gestion et la réparation de partitions :

- `e2fsprogs` → pour les systèmes ext4.

- `btrfs-progs`, `lvm2`, `mdadm` → pour les systèmes Btrfs, LVM ou RAID.

- `ntfs-3g` → pour lire un disque Windows.

---

## 🧩 3. Identifier le disque et ses partitions

```bash
sudo lsblk -f
```

🗨️ **Bulle explicative**  
Affiche tous les disques et leurs partitions avec les colonnes :

- **NAME** : nom du périphérique.

- **FSTYPE** : type de système de fichiers.

- **MOUNTPOINT** : emplacement de montage actuel.

- **UUID** : identifiant unique (référence dans `/etc/fstab`).

Exemple :

```
sda      ├─sda1 ext4  boot
         ├─sda2 vfat  efi
         └─sda3 ext4  root
sdb      ├─sdb1 ext4  /
         ├─sdb2 swap
```

Ici, `sdb` correspond au disque de la machine défectueuse.

---

## ⚙️ 4. Montage de la partition racine et des volumes associés

Créer le répertoire de montage principal :

```bash
sudo mkdir -p /mnt/rescue
```

---

### 4.1 – Monter la partition racine

```bash
sudo mount /dev/sdb1 /mnt/rescue
```

🗨️ **Bulle explicative**  
Monte la partition principale de la machine en panne dans `/mnt/rescue`.  
Vous pouvez maintenant naviguer dans son contenu depuis la machine saine.

---

### 4.2 – Monter les partitions associées

```bash
sudo mount /dev/sdb2 /mnt/rescue/boot
sudo mount /dev/sdb3 /mnt/rescue/boot/efi
```

🗨️ **Bulle explicative**  
Monte respectivement les partitions `/boot` et `/boot/efi` si le système était UEFI.  
Elles contiennent :

- `/boot/grub/` → fichiers GRUB.

- `/boot/vmlinuz-*` → noyaux.

- `/boot/initrd.img-*` → initramfs.

---

### 4.3 – Monter les systèmes virtuels pour diagnostic complet

```bash
sudo mount --bind /dev /mnt/rescue/dev
sudo mount --bind /proc /mnt/rescue/proc
sudo mount --bind /sys /mnt/rescue/sys
```

🗨️ **Bulle explicative**  
Ces systèmes virtuels sont requis si vous comptez lancer des commandes comme `grub-install` ou `update-initramfs` directement dans le `chroot`.

---

## 🧰 5. Exploration du disque monté

### 5.1 – Explorer les zones critiques

#### BIOS/MBR

```bash
sudo dd if=/dev/sdb bs=512 count=1 | hexdump -C | head
```

🗨️ **Bulle explicative**  
Affiche le contenu brut du MBR du disque `sdb`.  
Permet de vérifier que le chargeur GRUB Stage 1 est présent.

---

#### GRUB

```bash
ls /mnt/rescue/boot/grub
cat /mnt/rescue/boot/grub/grub.cfg | head -n 15
```

🗨️ **Bulle explicative**  
Vérifie la présence des fichiers GRUB et du menu de démarrage.  
Si le fichier `grub.cfg` est manquant → GRUB devra être régénéré.

---

#### Kernel

```bash
ls -lh /mnt/rescue/boot | grep vmlinuz
```

🗨️ **Bulle explicative**  
Liste les noyaux Linux disponibles sur la machine en panne.

---

#### systemd

```bash
ls -lh /mnt/rescue/lib/systemd/system | grep target
```

🗨️ **Bulle explicative**  
Liste les fichiers de cibles (`*.target`) gérés par systemd.  
Permet de vérifier si `default.target` pointe bien vers `multi-user.target` ou `graphical.target`.

---

#### Logs du boot

```bash
sudo journalctl --directory=/mnt/rescue/var/log/journal --no-pager -b -1 | head
```

🗨️ **Bulle explicative**  
Explore les journaux `systemd` du dernier démarrage de la machine montée.  
Utile pour repérer les erreurs système avant la panne.

---

## 🧩 6. Réparation depuis le chroot (optionnel)

Si vous souhaitez réparer GRUB, kernel ou initramfs directement depuis cette machine :

```bash
sudo chroot /mnt/rescue
grub-install /dev/sdb
update-grub
update-initramfs -u -k all
exit
```

🗨️ **Bulle explicative**

- `chroot` exécute les commandes dans le contexte du système monté.

- `grub-install` réécrit le chargeur de démarrage.

- `update-grub` régénère la configuration.

- `update-initramfs` reconstruit les images de démarrage.

---

## 🔍 7. Vérification post-opération

```bash
sudo ls /mnt/rescue/boot
sudo grep -E "vmlinuz|initrd" /mnt/rescue/boot/grub/grub.cfg
```

🗨️ **Bulle explicative**  
Vérifie que le GRUB fait bien référence à un noyau et un initramfs valides.

---

## 🧹 8. Nettoyage / démontage

```bash
sudo umount /mnt/rescue/{dev,proc,sys,boot/efi,boot}
sudo umount /mnt/rescue
```

🗨️ **Bulle explicative**  
Démonte toutes les partitions et sous-systèmes montés proprement.  
Toujours démonter dans l’ordre inverse du montage.

---

## 💡 9. Astuces & Pièges fréquents

| Problème                 | Cause probable         | Solution                                           |
| ------------------------ | ---------------------- | -------------------------------------------------- |
| Le disque ne monte pas   | Mauvais type de FS     | Ajouter `-t ext4` ou installer `ntfs-3g`           |
| Erreur “already mounted” | Partition déjà active  | `umount -l` puis remonter                          |
| GRUB absent              | `/boot/grub` vide      | `grub-install` depuis `chroot`                     |
| kernel/initrd manquant   | Paquet supprimé        | `apt install --reinstall linux-image-amd64`        |
| Logs inaccessibles       | journal non persistant | Examiner `/var/log/` texte au lieu de `journalctl` |

---

## ✅ Résumé de l’atelier

- Vous avez appris à **monter le disque d’un système Debian en panne** sur une autre machine.

- Vous savez explorer et analyser les zones critiques : **MBR, GRUB, noyau, systemd**.

- Vous pouvez intervenir via `chroot` pour réparer GRUB, initramfs, ou le kernel.

- Vous avez une procédure complète de **montage, exploration et démontage propre**.
