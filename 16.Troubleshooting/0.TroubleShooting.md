# ğŸ§  Atelier 0 â€“ Monter et explorer une partition systÃ¨me dâ€™une autre machine

**Niveau 1 â€“ AmorÃ§age & bases du boot (DÃ©bian 13 â€œTrixieâ€)**

---

## ğŸ¯ 1. Contexte & Objectif

Quand un systÃ¨me Debian ne dÃ©marre plus (problÃ¨me BIOS, GRUB, kernel, ou systemd), il est souvent nÃ©cessaire de :

- **Monter son disque sur une autre machine fonctionnelle**,

- **Explorer / corriger / sauvegarder** ses fichiers critiques,

- **RÃ©installer des composants du boot** (GRUB, initramfs, etc.) sans rÃ©installation complÃ¨te.

Dans cet atelier, vous allez :

1. Connecter le disque dÃ©fectueux Ã  une autre machine.

2. Identifier ses partitions.

3. Monter la racine (`/`), le boot (`/boot`), et lâ€™EFI (si UEFI).

4. Explorer les zones sensibles liÃ©es au boot (BIOS/MBR/GRUB/Kernel/systemd).

5. RÃ©parer directement depuis la machine saine.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1 â€“ MatÃ©riel

- **Machine saine** : Debian 13 fonctionnelle.

- **Disque de la machine en panne** : connectÃ© en SATA, USB, ou NVMe (ex : `/dev/sdb`).

- **Droits root (`sudo`)** requis.

---

### 2.2 â€“ Installation des outils nÃ©cessaires

CrÃ©er le script **mount_remote_disk_tools.sh** :

```bash
#!/usr/bin/env bash
# Installe les outils nÃ©cessaires Ã  l'exploration et la rÃ©paration de disques Debian

set -euo pipefail

sudo apt update
sudo apt install -y parted e2fsprogs btrfs-progs lvm2 ntfs-3g mdadm mount htop vim rsync
```

ğŸ—¨ï¸ **Bulle explicative**  
Ce script installe tous les outils nÃ©cessaires Ã  la dÃ©tection, la gestion et la rÃ©paration de partitions :

- `e2fsprogs` â†’ pour les systÃ¨mes ext4.

- `btrfs-progs`, `lvm2`, `mdadm` â†’ pour les systÃ¨mes Btrfs, LVM ou RAID.

- `ntfs-3g` â†’ pour lire un disque Windows.

---

## ğŸ§© 3. Identifier le disque et ses partitions

```bash
sudo lsblk -f
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche tous les disques et leurs partitions avec les colonnes :

- **NAME** : nom du pÃ©riphÃ©rique.

- **FSTYPE** : type de systÃ¨me de fichiers.

- **MOUNTPOINT** : emplacement de montage actuel.

- **UUID** : identifiant unique (rÃ©fÃ©rence dans `/etc/fstab`).

Exemple :

```
sda      â”œâ”€sda1 ext4  boot
         â”œâ”€sda2 vfat  efi
         â””â”€sda3 ext4  root
sdb      â”œâ”€sdb1 ext4  /
         â”œâ”€sdb2 swap
```

Ici, `sdb` correspond au disque de la machine dÃ©fectueuse.

---

## âš™ï¸ 4. Montage de la partition racine et des volumes associÃ©s

CrÃ©er le rÃ©pertoire de montage principal :

```bash
sudo mkdir -p /mnt/rescue
```

---

### 4.1 â€“ Monter la partition racine

```bash
sudo mount /dev/sdb1 /mnt/rescue
```

ğŸ—¨ï¸ **Bulle explicative**  
Monte la partition principale de la machine en panne dans `/mnt/rescue`.  
Vous pouvez maintenant naviguer dans son contenu depuis la machine saine.

---

### 4.2 â€“ Monter les partitions associÃ©es

```bash
sudo mount /dev/sdb2 /mnt/rescue/boot
sudo mount /dev/sdb3 /mnt/rescue/boot/efi
```

ğŸ—¨ï¸ **Bulle explicative**  
Monte respectivement les partitions `/boot` et `/boot/efi` si le systÃ¨me Ã©tait UEFI.  
Elles contiennent :

- `/boot/grub/` â†’ fichiers GRUB.

- `/boot/vmlinuz-*` â†’ noyaux.

- `/boot/initrd.img-*` â†’ initramfs.

---

### 4.3 â€“ Monter les systÃ¨mes virtuels pour diagnostic complet

```bash
sudo mount --bind /dev /mnt/rescue/dev
sudo mount --bind /proc /mnt/rescue/proc
sudo mount --bind /sys /mnt/rescue/sys
```

ğŸ—¨ï¸ **Bulle explicative**  
Ces systÃ¨mes virtuels sont requis si vous comptez lancer des commandes comme `grub-install` ou `update-initramfs` directement dans le `chroot`.

---

## ğŸ§° 5. Exploration du disque montÃ©

### 5.1 â€“ Explorer les zones critiques

#### BIOS/MBR

```bash
sudo dd if=/dev/sdb bs=512 count=1 | hexdump -C | head
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche le contenu brut du MBR du disque `sdb`.  
Permet de vÃ©rifier que le chargeur GRUB Stage 1 est prÃ©sent.

---

#### GRUB

```bash
ls /mnt/rescue/boot/grub
cat /mnt/rescue/boot/grub/grub.cfg | head -n 15
```

ğŸ—¨ï¸ **Bulle explicative**  
VÃ©rifie la prÃ©sence des fichiers GRUB et du menu de dÃ©marrage.  
Si le fichier `grub.cfg` est manquant â†’ GRUB devra Ãªtre rÃ©gÃ©nÃ©rÃ©.

---

#### Kernel

```bash
ls -lh /mnt/rescue/boot | grep vmlinuz
```

ğŸ—¨ï¸ **Bulle explicative**  
Liste les noyaux Linux disponibles sur la machine en panne.

---

#### systemd

```bash
ls -lh /mnt/rescue/lib/systemd/system | grep target
```

ğŸ—¨ï¸ **Bulle explicative**  
Liste les fichiers de cibles (`*.target`) gÃ©rÃ©s par systemd.  
Permet de vÃ©rifier si `default.target` pointe bien vers `multi-user.target` ou `graphical.target`.

---

#### Logs du boot

```bash
sudo journalctl --directory=/mnt/rescue/var/log/journal --no-pager -b -1 | head
```

ğŸ—¨ï¸ **Bulle explicative**  
Explore les journaux `systemd` du dernier dÃ©marrage de la machine montÃ©e.  
Utile pour repÃ©rer les erreurs systÃ¨me avant la panne.

---

## ğŸ§© 6. RÃ©paration depuis le chroot (optionnel)

Si vous souhaitez rÃ©parer GRUB, kernel ou initramfs directement depuis cette machine :

```bash
sudo chroot /mnt/rescue
grub-install /dev/sdb
update-grub
update-initramfs -u -k all
exit
```

ğŸ—¨ï¸ **Bulle explicative**

- `chroot` exÃ©cute les commandes dans le contexte du systÃ¨me montÃ©.

- `grub-install` rÃ©Ã©crit le chargeur de dÃ©marrage.

- `update-grub` rÃ©gÃ©nÃ¨re la configuration.

- `update-initramfs` reconstruit les images de dÃ©marrage.

---

## ğŸ” 7. VÃ©rification post-opÃ©ration

```bash
sudo ls /mnt/rescue/boot
sudo grep -E "vmlinuz|initrd" /mnt/rescue/boot/grub/grub.cfg
```

ğŸ—¨ï¸ **Bulle explicative**  
VÃ©rifie que le GRUB fait bien rÃ©fÃ©rence Ã  un noyau et un initramfs valides.

---

## ğŸ§¹ 8. Nettoyage / dÃ©montage

```bash
sudo umount /mnt/rescue/{dev,proc,sys,boot/efi,boot}
sudo umount /mnt/rescue
```

ğŸ—¨ï¸ **Bulle explicative**  
DÃ©monte toutes les partitions et sous-systÃ¨mes montÃ©s proprement.  
Toujours dÃ©monter dans lâ€™ordre inverse du montage.

---

## ğŸ’¡ 9. Astuces & PiÃ¨ges frÃ©quents

| ProblÃ¨me                 | Cause probable         | Solution                                           |
| ------------------------ | ---------------------- | -------------------------------------------------- |
| Le disque ne monte pas   | Mauvais type de FS     | Ajouter `-t ext4` ou installer `ntfs-3g`           |
| Erreur â€œalready mountedâ€ | Partition dÃ©jÃ  active  | `umount -l` puis remonter                          |
| GRUB absent              | `/boot/grub` vide      | `grub-install` depuis `chroot`                     |
| kernel/initrd manquant   | Paquet supprimÃ©        | `apt install --reinstall linux-image-amd64`        |
| Logs inaccessibles       | journal non persistant | Examiner `/var/log/` texte au lieu de `journalctl` |

---

## âœ… RÃ©sumÃ© de lâ€™atelier

- Vous avez appris Ã  **monter le disque dâ€™un systÃ¨me Debian en panne** sur une autre machine.

- Vous savez explorer et analyser les zones critiques : **MBR, GRUB, noyau, systemd**.

- Vous pouvez intervenir via `chroot` pour rÃ©parer GRUB, initramfs, ou le kernel.

- Vous avez une procÃ©dure complÃ¨te de **montage, exploration et dÃ©montage propre**.
