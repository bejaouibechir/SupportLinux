# ğŸ§  Atelier 10 (version dÃ©monstrative)

**Exploration progressive des *targets systemd* et rÃ©parations concrÃ¨tes â€“ Debian 13**

---

## ğŸ¯ Objectif gÃ©nÃ©ral

Passer **progressivement de `emergency.target` Ã  `graphical.target`**,  
et Ã  chaque niveau :

- observer **ce qui est lancÃ©**,

- confirmer **ce qui est dÃ©sactivÃ©**,

- exÃ©cuter **une rÃ©paration typique** rÃ©alisable Ã  ce stade.

---

## ğŸ§© 1. PrÃ©paration initiale

Avant de commencer :

```bash
sudo systemctl get-default
```

ğŸ—¨ï¸ **Exemple de sortie** :

```
graphical.target
```

â¡ï¸ Cela indique que Debian dÃ©marre normalement en mode graphique.  
Nous allons maintenant isoler chaque target successivement.

---

## ğŸ”¸ Phase 1 : emergency.target

*(niveau minimal absolu â€“ aucun service, aucun montage secondaire)*

### 1.1 â€“ Entrer dans le mode

```bash
sudo systemctl isolate emergency.target
```

Tu obtiens une console root directe, sans authentification, sans couleur, souvent sans message de bienvenue.

---

### 1.2 â€“ VÃ©rification concrÃ¨te

```bash
whoami
ps -p 1 -o comm=
systemctl list-units --type=service --state=running
ip link
```

ğŸ—¨ï¸ **Analyse des rÃ©sultats attendus** :

- `whoami` â†’ `root`

- `ps -p 1 -o comm=` â†’ `systemd`

- `systemctl list-units ...` â†’ trÃ¨s peu de services (souvent `systemd-journald`, `systemd-udevd`, `emergency.service`)

- `ip link` â†’ interface `lo` seulement (aucun `enp0s3` ou `eth0` actif)

---

### 1.3 â€“ Cas concret : rÃ©parer `/etc/fstab`

```bash
mount -o remount,rw /
nano /etc/fstab
mount -a
```

ğŸ—¨ï¸ **Observation** :

- Avant la correction, `mount -a` gÃ©nÃ©rait une erreur sur un UUID invalide.

- AprÃ¨s correction, aucun message dâ€™erreur.

ğŸ‘‰ **Tu viens de restaurer la capacitÃ© du systÃ¨me Ã  atteindre `rescue.target`.**

---

## ğŸ”¸ Phase 2 : rescue.target

*(Ã©quivalent runlevel 1 â€“ mono-utilisateur, systÃ¨me montÃ©, pas de rÃ©seau)*

### 2.1 â€“ Passage

```bash
sudo systemctl isolate rescue.target
```

Tu verras un message du type :

```
You are in rescue mode. Press Ctrl-D to continue or enter root password for maintenance.
```

---

### 2.2 â€“ VÃ©rification concrÃ¨te

```bash
whoami
systemctl list-units --type=service --state=running | grep -E "sshd|NetworkManager|gdm"
ip a
lsmod | grep e1000
```

ğŸ—¨ï¸ **Analyse** :

- `sshd`, `NetworkManager`, `gdm` nâ€™apparaissent pas â†’ **pas de rÃ©seau ni interface graphique**.

- `ip a` â†’ `lo` actif uniquement.

- `lsmod | grep e1000` â†’ le module du pilote rÃ©seau nâ€™est mÃªme pas chargÃ©.

---

### 2.3 â€“ Cas concret : rÃ©gÃ©nÃ©rer un initramfs manquant

```bash
update-initramfs -u -k all
ls -lh /boot/initrd.img*
```

ğŸ—¨ï¸ **Observation** : tu vois maintenant une image initrd recrÃ©Ã©e.  
â¡ï¸ Cela corrige les pannes de boot signalÃ©es Ã  lâ€™Ã©tape `initramfs shell`.

---

## ğŸ”¸ Phase 3 : multi-user.target

*(Ã©quivalent runlevel 3 â€“ mode texte, rÃ©seau et services actifs)*

### 3.1 â€“ Passage

```bash
sudo systemctl isolate multi-user.target
```

---

### 3.2 â€“ VÃ©rifications concrÃ¨tes

```bash
systemctl list-units --type=service --state=running | head -n 10
systemctl is-active ssh
systemctl is-active NetworkManager
ip -br addr
ss -tlnp
```

ğŸ—¨ï¸ **Analyse :**

- `sshd.service` et `NetworkManager.service` doivent Ãªtre **actifs**.

- `ip -br addr` â†’ tu verras une adresse IP attribuÃ©e (`enp0s3 UP 192.168.x.x`).

- `ss -tlnp` â†’ port 22 ouvert (SSH).

ğŸ‘‰ **On peut dÃ©sormais intervenir Ã  distance.**

---

### 3.3 â€“ Cas concret : corriger un service bloquÃ©

```bash
systemctl --failed
systemctl status rsyslog
journalctl -u rsyslog | tail -n 5
systemctl restart rsyslog
```

ğŸ—¨ï¸ **Observation :**  
Tu dÃ©tectes, inspectes puis redÃ©marres un service critique, par exemple `rsyslog`.

---

## ğŸ”¸ Phase 4 : graphical.target

*(Ã©quivalent runlevel 5 â€“ interface graphique complÃ¨te)*

### 4.1 â€“ Passage

```bash
sudo systemctl isolate graphical.target
```

---

### 4.2 â€“ VÃ©rifications concrÃ¨tes

```bash
systemctl is-active gdm
systemctl list-units --type=target | grep graphical
ps aux | grep Xorg
loginctl list-sessions
```

ğŸ—¨ï¸ **Analyse** :

- `gdm.service` â†’ actif.

- `Xorg` ou `Wayland` prÃ©sent dans `ps aux`.

- `loginctl list-sessions` â†’ affiche la session utilisateur connectÃ©e (`seat0`).

---

### 4.3 â€“ Cas concret : rÃ©paration graphique

```bash
lspci | grep VGA
apt reinstall firmware-misc-nonfree
systemctl restart gdm
```

ğŸ—¨ï¸ **Observation** :

- AprÃ¨s rÃ©installation du firmware, la session graphique redÃ©marre correctement.

- Les logs de `journalctl -xe` ne contiennent plus dâ€™erreur GPU.

---

## ğŸ”¸ Phase 5 : reboot.target & poweroff.target

### VÃ©rification

```bash
systemctl isolate reboot.target
```

ğŸ—¨ï¸ **Observation :**  
Le systÃ¨me redÃ©marre proprement, sans redÃ©marrage brutal (pas de `fsck` au boot suivant).

---

## ğŸ”¸ Phase 6 : synthÃ¨se des niveaux et tests

| Target       | Services visibles                     | Commande de test         | Exemple de panne traitÃ©e |
| ------------ | ------------------------------------- | ------------------------ | ------------------------ |
| `emergency`  | `systemd-journald`, `udevd`           | `ip link` â†’ `lo` seul    | `/etc/fstab` invalide    |
| `rescue`     | `journald`, `udevd`, `systemd-logind` | `systemctl list-units`   | initramfs / GRUB         |
| `multi-user` | + `NetworkManager`, `sshd`, `cron`    | `ip -br addr`            | service bloquÃ©, DNS      |
| `graphical`  | + `gdm`, `Xorg`, `cups`               | `loginctl list-sessions` | pilote graphique         |

---

## âœ… RÃ©sumÃ© de la dÃ©marche

1. **Isoler un target** pour travailler dans un contexte propre.

2. **Observer les processus rÃ©ellement chargÃ©s** (`systemctl list-units`, `ps -p 1 -o comm=`).

3. **Confirmer ce qui est arrÃªtÃ©** (`systemctl is-active ...`).

4. **Effectuer des rÃ©parations adaptÃ©es au niveau courant**.

5. **Remonter progressivement vers `graphical.target`** aprÃ¨s validation.
