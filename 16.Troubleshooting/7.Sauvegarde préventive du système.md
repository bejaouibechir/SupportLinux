# ğŸ§  Atelier 7 â€“ Sauvegarde prÃ©ventive et recouvrement des fichiers systÃ¨me critiques

**Niveau 1 â€“ AmorÃ§age & bases du boot (Debian 13 â€œTrixieâ€)**

---

## ğŸ¯ 1. Contexte & Objectif

Un incident de dÃ©marrage peut provenir :

- dâ€™une mise Ã  jour du noyau Ã©chouÃ©e,

- dâ€™un GRUB corrompu,

- dâ€™une modification accidentelle de `/etc/fstab`,

- ou dâ€™un disque endommagÃ©.

La bonne pratique consiste Ã  **sauvegarder rÃ©guliÃ¨rement** les Ã©lÃ©ments essentiels du boot et du systÃ¨me.

### Objectifs pÃ©dagogiques

- Identifier les fichiers et dossiers critiques Ã  sauvegarder.

- Automatiser leur sauvegarde avec un script.

- Tester la restauration Ã  partir dâ€™un Live Debian.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1 â€“ PrÃ©-requis

- Machine Debian 13 avec accÃ¨s root (`sudo`).

- Un disque externe ou une clÃ© USB montÃ©e sur `/mnt/backup`.

- Le paquet `rsync` installÃ©.

### 2.2 â€“ CrÃ©ation du rÃ©pertoire de destination

```bash
sudo mkdir -p /mnt/backup/system_backup_$(date +%F)
```

ğŸ—¨ï¸ **Bulle explicative**  
CrÃ©e un rÃ©pertoire datÃ© sur le support externe pour y stocker les fichiers du jour.  
Cela permet de conserver plusieurs versions successives.

---

## ğŸ§© 3. Identification des fichiers / rÃ©pertoires critiques

| CatÃ©gorie             | Emplacement                                   | Contenu principal                     | UtilitÃ©                  |
| --------------------- | --------------------------------------------- | ------------------------------------- | ------------------------ |
| MBR                   | `/dev/sda` (secteur 0)                        | Chargeur de premier niveau            | Amorce le systÃ¨me        |
| GRUB                  | `/boot/grub/`                                 | Fichiers et configuration du chargeur | GÃ¨re les entrÃ©es de boot |
| Kernel                | `/boot/vmlinuz-*` + `/boot/initrd.img-*`      | Noyaux et images initramfs            | DÃ©marrage Linux          |
| systemd               | `/etc/systemd/` + `/lib/systemd/system/`      | Units et cibles                       | Gestion des services     |
| fstab + boot          | `/etc/fstab`, `/etc/default/grub`             | Points de montage et config GRUB      | Liens systÃ¨meâ€“disques    |
| Config rÃ©seau + users | `/etc/network/`, `/etc/passwd`, `/etc/shadow` | RÃ©seau et utilisateurs                | AccÃ¨s et identitÃ©        |

---

## ğŸ’¾ 4. Script de sauvegarde complet

CrÃ©er le fichier **/usr/local/bin/system_backup.sh** :

```bash
#!/usr/bin/env bash
# Script de sauvegarde prÃ©ventive des fichiers critiques du systÃ¨me Debian
# Auteur : Atelier DevOps Debian
# Usage : sudo bash /usr/local/bin/system_backup.sh

set -euo pipefail

# RÃ©pertoire cible
BACKUP_DIR="/mnt/backup/system_backup_$(date +%F)"
mkdir -p "$BACKUP_DIR"

echo "---- Sauvegarde MBR ----"
# Copie du premier secteur du disque (512 octets)
sudo dd if=/dev/sda of="$BACKUP_DIR/mbr_backup.img" bs=512 count=1

echo "---- Sauvegarde des fichiers critiques ----"
sudo rsync -aAXv \
  /boot/ \
  /etc/fstab \
  /etc/default/grub \
  /etc/systemd/ \
  /lib/systemd/ \
  /etc/network/ \
  /etc/passwd \
  /etc/shadow \
  /etc/group \
  "$BACKUP_DIR/"

echo "---- VÃ©rification du contenu ----"
ls -lh "$BACKUP_DIR"

echo "Sauvegarde terminÃ©e avec succÃ¨s."
```

ğŸ—¨ï¸ **Bulle explicative**

- `dd if=/dev/sda of=mbr_backup.img` : copie binaire du MBR.

- `rsync -aAXv` : archive complÃ¨te avec attributs et permissions.

- Les fichiers utilisateurs, boot et systemd sont inclus pour un recouvrement complet.

---

## ğŸ§° 5. VÃ©rification du backup

```bash
sudo du -sh /mnt/backup/system_backup_$(date +%F)
sudo ls -l /mnt/backup/system_backup_$(date +%F)/boot
```

ğŸ—¨ï¸ **Bulle explicative**  
Permet de vÃ©rifier la taille et la prÃ©sence des fichiers principaux (`vmlinuz-*`, `initrd.img-*`, `grub.cfg`, etc.).

---

## âš ï¸ 6. Simulation : corruption et restauration

### 6.1 â€“ Simulation (VM de test uniquement)

```bash
sudo mv /boot/grub /boot/grub.old
sudo reboot
```

ğŸ—¨ï¸ **Bulle explicative**  
Simule un GRUB supprimÃ© pour tester la restauration manuelle.

---

### 6.2 â€“ Restauration depuis un Live Debian

#### Ã‰tape 1 â€“ Monter la partition racine

```bash
sudo mount /dev/sda1 /mnt
sudo mount /dev/sda2 /mnt/boot
```

#### Ã‰tape 2 â€“ Monter la sauvegarde externe

```bash
sudo mount /dev/sdb1 /mnt/backup
```

#### Ã‰tape 3 â€“ Copier les fichiers de sauvegarde

```bash
sudo rsync -aAXv /mnt/backup/system_backup_2025-10-21/boot/ /mnt/boot/
sudo rsync -aAXv /mnt/backup/system_backup_2025-10-21/etc/ /mnt/etc/
```

ğŸ—¨ï¸ **Bulle explicative**  
Cette opÃ©ration restaure les fichiers `boot` et `etc` depuis la sauvegarde datÃ©e.

---

#### Ã‰tape 4 â€“ Restauration du MBR

```bash
sudo dd if=/mnt/backup/system_backup_2025-10-21/mbr_backup.img of=/dev/sda bs=512 count=1
```

ğŸ—¨ï¸ **Bulle explicative**  
RÃ©Ã©crit le MBR initial du disque.  
âš ï¸ Ã€ exÃ©cuter uniquement si le MBR dâ€™origine est rÃ©ellement perdu ou corrompu.

---

#### Ã‰tape 5 â€“ RÃ©gÃ©nÃ©ration de GRUB et initramfs

```bash
sudo chroot /mnt
update-grub
update-initramfs -u -k all
exit
```

ğŸ—¨ï¸ **Bulle explicative**  
RecrÃ©e la configuration GRUB et les images de dÃ©marrage pour sâ€™assurer que tout correspond aux fichiers restaurÃ©s.

---

## ğŸ” 7. VÃ©rification post-restauration

```bash
sudo reboot
systemctl status
ls /boot
```

ğŸ—¨ï¸ **Bulle explicative**  
Le systÃ¨me doit redÃ©marrer normalement avec le GRUB et les noyaux restaurÃ©s.

---

## ğŸ§¹ 8. Nettoyage et rotation des backups

CrÃ©er le fichier **/usr/local/bin/cleanup_backups.sh** :

```bash
#!/usr/bin/env bash
# Supprime les sauvegardes de plus de 14 jours

find /mnt/backup/system_backup_* -maxdepth 0 -mtime +14 -exec rm -rf {} \;
```

ğŸ—¨ï¸ **Bulle explicative**  
Permet de garder les sauvegardes rÃ©centes seulement et dâ€™Ã©viter la saturation du support externe.

---

## ğŸ’¡ 9. Astuces & bonnes pratiques

| Risque                       | PrÃ©vention                           | Outil                |
| ---------------------------- | ------------------------------------ | -------------------- |
| MBR corrompu                 | Sauvegarder le secteur 0 (`dd`)      | `dd`, `grub-install` |
| GRUB effacÃ©                  | Sauvegarde de `/boot/grub`           | `rsync`              |
| Noyau supprimÃ©               | Sauvegarde de `/boot/vmlinuz-*`      | `rsync`              |
| Mauvais `fstab`              | Sauvegarde rÃ©guliÃ¨re de `/etc/fstab` | `rsync`              |
| Blocage systemd              | Sauvegarde de `/etc/systemd/`        | `rsync`              |
| Fichiers utilisateurs perdus | Inclure `/etc/passwd`, `/etc/shadow` | `rsync`              |

---

## âœ… RÃ©sumÃ© de lâ€™atelier

- CrÃ©ation dâ€™une **stratÃ©gie de sauvegarde prÃ©ventive** basÃ©e sur `rsync` et `dd`.

- Sauvegarde automatisÃ©e du **MBR, GRUB, kernel, systemd, fstab, comptes, rÃ©seau**.

- Simulation de corruption et **rÃ©cupÃ©ration complÃ¨te** depuis une machine Live.

- Introduction Ã  la **rotation automatique des backups** pour la maintenance prÃ©ventive.
