# ğŸ§  Atelier 3 â€“ Analyse du processus `systemd` au dÃ©marrage

**Niveau 1 â€“ AmorÃ§age & bases du boot (Debian 13 â€œTrixieâ€)**

---

## ğŸ¯ 1. Contexte & Objectif

AprÃ¨s le chargement du noyau Linux par GRUB, câ€™est le **PID 1**, `systemd`, qui prend la main.  
Il orchestre la montÃ©e en services : montage des disques, dÃ©marrage rÃ©seau, affichage, etc.

Objectifs de cet atelier :

- Comprendre la structure et le rÃ´le de `systemd`.

- Analyser les unitÃ©s (units) exÃ©cutÃ©es au dÃ©marrage.

- Diagnostiquer un dÃ©marrage lent ou bloquÃ©.

- CrÃ©er un service personnalisÃ© simple et le surveiller au boot.

---

## âš™ï¸ 2. PrÃ©paration de lâ€™environnement

### 2.1 â€“ Contexte systÃ¨me

VÃ©rifiez la version de Debian et du noyau :

```bash
hostnamectl
uname -r
```

ğŸ—¨ï¸ **Bulle explicative**  
`hostnamectl` affiche les informations systÃ¨me : distribution, architecture, version du kernel.  
`uname -r` affiche la version exacte du noyau utilisÃ© par `systemd` pour ce boot.

---

### 2.2 â€“ Mettre Ã  jour et installer les outils dâ€™analyse

```bash
sudo apt update
sudo apt install -y systemd systemd-analyze psmisc htop
```

ğŸ—¨ï¸ **Bulle explicative**

- `systemd-analyze` : mesure le temps de dÃ©marrage.

- `psmisc` : fournit `pstree` pour visualiser la hiÃ©rarchie des processus.

- `htop` : surveillance interactive du systÃ¨me.

---

## ğŸ§© 3. Observation du processus `systemd`

### 3.1 â€“ Identifier le PID 1

```bash
ps -p 1 -o pid,comm,cmd
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche le processus dont le PID est 1 : il doit sâ€™agir de `systemd`.  
Si ce nâ€™est pas le cas, câ€™est quâ€™un autre init est utilisÃ© (rare sur Debian 13).

---

### 3.2 â€“ Lister les unitÃ©s actives

```bash
systemctl list-units --type=service --state=running
```

ğŸ—¨ï¸ **Bulle explicative**  
Montre tous les services actuellement actifs et gÃ©rÃ©s par `systemd`.  
Les colonnes :

- **LOAD** : service chargÃ©.

- **ACTIVE** : Ã©tat gÃ©nÃ©ral.

- **SUB** : Ã©tat dÃ©taillÃ© (running, exited, deadâ€¦).

---

### 3.3 â€“ Visualiser les dÃ©pendances

```bash
systemctl list-dependencies multi-user.target
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche lâ€™arbre des services qui doivent Ãªtre actifs pour atteindre la cible `multi-user.target`  
(Ã©quivalent du **runlevel 3**, dÃ©marrage sans interface graphique).

---

### 3.4 â€“ HiÃ©rarchie complÃ¨te des processus

```bash
pstree -p 1
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche la structure des processus descendants de `systemd` :  
on y voit `NetworkManager`, `sshd`, `cron`, etc.  
Cela illustre la faÃ§on dont `systemd` supervise tous les services.

---

## â± 4. Analyse du temps de dÃ©marrage

### 4.1 â€“ DurÃ©e totale du boot

```bash
systemd-analyze
```

ğŸ—¨ï¸ **Bulle explicative**  
Indique combien de temps ont pris :

- le firmware/BIOS,

- le chargeur (GRUB),

- le noyau,

- lâ€™espace utilisateur (`systemd`).

Exemple :

```
Startup finished in 2.345s (kernel) + 4.789s (userspace) = 7.134s
```

---

### 4.2 â€“ Identifier les services lents

```bash
systemd-analyze blame | head
```

ğŸ—¨ï¸ **Bulle explicative**  
Liste les unitÃ©s les plus longues Ã  dÃ©marrer.  
TrÃ¨s utile pour dÃ©tecter un service bloquant ou mal configurÃ©.

---

### 4.3 â€“ Diagramme critique

```bash
systemd-analyze critical-chain
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche la **chaÃ®ne critique** du boot :  
le chemin exact des services qui dÃ©terminent le temps total de dÃ©marrage.

---

## ğŸ§° 5. CrÃ©ation dâ€™un service personnalisÃ©

CrÃ©er le fichier **/etc/systemd/system/hello-boot.service** :

```bash
[Unit]
Description=Message de dÃ©marrage personnalisÃ©
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/hello-boot.sh

[Install]
WantedBy=multi-user.target
```

ğŸ—¨ï¸ **Bulle explicative**  
Ce service exÃ©cute un petit script une seule fois au boot (`Type=oneshot`).  
Il se lance aprÃ¨s que le rÃ©seau soit disponible.

---

CrÃ©er le fichier **/usr/local/bin/hello-boot.sh** :

```bash
#!/usr/bin/env bash
# Petit script dâ€™affichage dâ€™un message de boot
set -euo pipefail
logger "ğŸ’¡ Atelier systemd : le service hello-boot vient de sâ€™exÃ©cuter avec succÃ¨s !"
```

ğŸ—¨ï¸ **Bulle explicative**  
Le script envoie un message dans le journal systÃ¨me via `logger`.  
Câ€™est la maniÃ¨re propre de communiquer avec `journald`.

---

Activer et tester le service :

```bash
sudo chmod +x /usr/local/bin/hello-boot.sh
sudo systemctl daemon-reload
sudo systemctl enable hello-boot.service
sudo systemctl start hello-boot.service
```

ğŸ—¨ï¸ **Bulle explicative**

- `daemon-reload` : recharge les fichiers dâ€™unitÃ©.

- `enable` : active le service pour le prochain boot.

- `start` : exÃ©cute immÃ©diatement le service.

---

VÃ©rifiez le journal :

```bash
journalctl -u hello-boot.service --no-pager
```

ğŸ—¨ï¸ **Bulle explicative**  
Permet de confirmer que le message du script a bien Ã©tÃ© enregistrÃ© dans les logs `systemd`.

---

## ğŸ” 6. DÃ©pannage et vÃ©rification

### 6.1 â€“ Lister tous les Ã©checs

```bash
systemctl --failed
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche les unitÃ©s ayant Ã©chouÃ© au dÃ©marrage.  
TrÃ¨s utile pour comprendre pourquoi un service ne sâ€™est pas lancÃ©.

---

### 6.2 â€“ Examiner les logs globaux du boot courant

```bash
journalctl -b --priority=3 --no-pager
```

ğŸ—¨ï¸ **Bulle explicative**  
Affiche uniquement les messages de prioritÃ© 3 (erreurs) du dernier boot.  
Pratique pour dÃ©tecter rapidement les anomalies.

---

## ğŸ§¹ 7. Nettoyage / rollback

```bash
sudo systemctl disable hello-boot.service
sudo rm /etc/systemd/system/hello-boot.service
sudo rm /usr/local/bin/hello-boot.sh
sudo systemctl daemon-reload
```

ğŸ—¨ï¸ **Bulle explicative**  
Supprime le service de test et recharge `systemd` proprement.

---

## ğŸ’¡ 8. Astuces & PiÃ¨ges frÃ©quents

| ProblÃ¨me                    | Cause probable                          | Solution                                                    |
| --------------------------- | --------------------------------------- | ----------------------------------------------------------- |
| Service non exÃ©cutÃ© au boot | Mauvais `WantedBy` ou `After`           | VÃ©rifier les dÃ©pendances avec `systemctl list-dependencies` |
| Boot trÃ¨s lent              | Timeout sur un service (network, fstab) | Analyser avec `systemd-analyze blame`                       |
| Journal vide                | `systemd-journald` dÃ©sactivÃ©            | `systemctl enable --now systemd-journald`                   |
| Fichier dâ€™unitÃ© ignorÃ©      | Pas de `daemon-reload` aprÃ¨s ajout      | Lancer `systemctl daemon-reload`                            |

---

## âœ… RÃ©sumÃ© de lâ€™atelier

- ComprÃ©hension du rÃ´le fondamental de `systemd` (PID 1).

- Exploration des unitÃ©s, dÃ©pendances et services.

- Diagnostic des lenteurs ou Ã©checs de boot.

- CrÃ©ation et gestion dâ€™un service personnalisÃ© au dÃ©marrage.
