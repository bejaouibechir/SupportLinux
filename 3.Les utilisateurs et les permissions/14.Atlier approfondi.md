\# Exercice APPROFONDI ‚Äî \*\*TeamShare (sans script)\*\*



\## üéØ Probl√©matique



Mettre en place un \*\*r√©pertoire de travail partag√©\*\* o√π tous les membres d‚Äôun groupe (p. ex. `projet`) peuvent \*\*cr√©er/modifier\*\* des fichiers \*\*ensemble\*\*, avec :



\* \*\*Propri√©taire :\*\* `root` (ou un compte ‚Äúservice‚Äù)

\* \*\*Groupe :\*\* `projet`

\* \*\*H√©ritage automatique du groupe\*\* pour tout nouveau fichier/dossier (bit \*\*SGID\*\*)

\* \*\*Droits par d√©faut\*\* corrects sur tout ce qui est cr√©√© (via \*\*ACL par d√©faut\*\*)

\* \*\*Option bonus\*\* : un r√©pertoire ‚Äúd√©p√¥t public‚Äù type `/tmp` avec \*\*sticky bit\*\*



> Environnement : Debian 12/13, utiliser `sudo` si n√©cessaire.

> Si `setfacl/getfacl` manquent : `sudo apt install acl`.



---



\## üß≠ √âtapes (ce que vous faites, pas √† pas)



1\. \*\*Cr√©er le groupe\*\* et le r√©pertoire partag√©



&nbsp;  \* Groupe collaboratif `projet`

&nbsp;  \* Dossier `/srv/teamshare`



2\. \*\*Poser propri√©taire/groupe et activer l‚Äôh√©ritage de groupe\*\*



&nbsp;  \* `chown root:projet` sur le dossier

&nbsp;  \* Mettre le \*\*bit SGID\*\* sur le dossier (pour que tous les \*\*nouveaux √©l√©ments h√©ritent du groupe\*\* `projet`)



3\. \*\*Fixer des permissions convenables\*\*



&nbsp;  \* Pour un espace priv√© au groupe : `rwx` pour \*\*user\*\* et \*\*group\*\*, \*\*aucun acc√®s\*\* aux autres ‚Üí `2770`

&nbsp;  \* (Variante plus ouverte : `2775` si vous voulez que ‚Äúothers‚Äù lisent)



4\. \*\*Garantir des droits par d√©faut sur tout ce qui est cr√©√©\*\*



&nbsp;  \* Installer des \*\*ACL par d√©faut\*\* (ex. `u::rwx,g::rwx,o::---,mask::rwx`)

&nbsp;  \* Ainsi, m√™me si la \*\*umask\*\* d‚Äôun utilisateur est restrictive, le dossier forcera des droits coh√©rents c√¥t√© groupe.



5\. \*\*(Option bonus) Cr√©er un ‚Äúdropdir‚Äù public\*\*



&nbsp;  \* R√©pertoire de d√©p√¥t o√π \*\*chacun peut d√©poser\*\*, mais \*\*seul le propri√©taire peut supprimer\*\* ‚Üí \*\*sticky bit\*\* (`+t`)



---



\## ‚úÖ V√©rifications attendues



\* `ls -ld /srv/teamshare` affiche un `d` avec \*\*`s`\*\* sur les droits groupe (ex. `drwxrws---`) ‚Üí \*\*SGID actif\*\*

\* `getfacl /srv/teamshare` montre des \*\*ACL par d√©faut\*\* (`default:`) donnant \*\*rwx\*\* √† `projet`

\* Un fichier cr√©√© par \*Alice\* et un autre par \*Bob\* dans `/srv/teamshare` ont tous les deux le \*\*groupe `projet`\*\* et sont \*\*√©ditables par le groupe\*\*

\* Dans le ‚Äúdropdir‚Äù public, \*\*seul le propri√©taire\*\* d‚Äôun fichier peut le supprimer (gr√¢ce au \*\*sticky bit\*\*)



---



\## üß© Corrig√© ‚Äî \*\*Commandes comment√©es √† copier-coller\*\*



> ‚ö†Ô∏è Remplacez `alice` et `bob` par deux comptes existants (ou cr√©ez-les pour la d√©mo).



```bash

\# 1) Groupe + dossier

sudo groupadd -f projet

sudo mkdir -p /srv/teamshare



\# 2) Propri√©taire/groupe + h√©ritage de groupe (SGID)

sudo chown root:projet /srv/teamshare

sudo chmod 2770 /srv/teamshare

\#       ^^^^

\# 2=SGID sur le r√©pertoire, 770 = rwx (owner) + rwx (group) + aucun (others)

\# R√©sultat attendu sur le 'ls -ld' : drwxrws---  root projet  /srv/teamshare



\# 3) Ajouter des utilisateurs au groupe (session suivante ou 'newgrp projet' pour prendre effet)

sudo usermod -aG projet alice

sudo usermod -aG projet bob



\# 4) ACL par d√©faut pour forcer les droits au groupe sur tout ce qui est cr√©√©

\#    - u::rwx       : droits du propri√©taire

\#    - g::rwx       : droits du groupe propri√©taire (ici 'projet')

\#    - o::---       : aucun droit pour others

\#    - mask::rwx    : "plafond" d'ACL effectif (doit inclure rwx pour que g::rwx s'applique)

sudo setfacl -m u::rwx,g::rwx,o::---,mask::rwx /srv/teamshare

sudo setfacl -d -m u::rwx,g::rwx,o::---,mask::rwx /srv/teamshare

\#            ^ 'default:' via -d  -> s'appliquera automatiquement aux nouveaux fichiers/dossiers



\# 5) (V√©rification) Afficher droits + ACL

ls -ld /srv/teamshare

getfacl /srv/teamshare



\# 6) (Test) En tant que 'alice' puis 'bob' :

\#    - chaque utilisateur cr√©e un fichier; ils doivent partager le groupe 'projet' et √™tre modifiables par l'autre

sudo -u alice bash -c 'echo "par alice" > /srv/teamshare/alice.txt \&\& ls -l /srv/teamshare/alice.txt \&\& getfacl /srv/teamshare/alice.txt'

sudo -u bob   bash -c 'echo "par bob"   > /srv/teamshare/bob.txt   \&\& ls -l /srv/teamshare/bob.txt   \&\& getfacl /srv/teamshare/bob.txt'



\#    - bob modifie le fichier de alice (autoris√© si g::rw)

sudo -u bob bash -c 'echo "modif par bob" >> /srv/teamshare/alice.txt \&\& tail -n1 /srv/teamshare/alice.txt'



\# 7) (Bonus) R√©pertoire de d√©p√¥t public avec sticky bit (type /tmp)

sudo mkdir -p /srv/dropdir

sudo chmod 1777 /srv/dropdir

\#     ^ sticky bit : seul le propri√©taire d'un fichier peut le supprimer, m√™me si d'autres ont write sur le r√©pertoire

ls -ld /srv/dropdir   # attendu : drwxrwxrwt

```



---



\## ‚ñ∂Ô∏è Guide d‚Äôutilisation (apr√®s mise en place)



\* \*\*Ajouter un membre au groupe :\*\*

&nbsp; `sudo usermod -aG projet <utilisateur>`  ‚Üí l‚Äôutilisateur doit \*\*se reconnecter\*\* (ou `newgrp projet`) pour prendre le groupe.



\* \*\*Changer la ‚Äúpolitique‚Äù d‚Äôacc√®s :\*\*



&nbsp; \* Plus \*\*ouvert\*\* (lecture pour others) : `sudo chmod 2775 /srv/teamshare` + ajuster ACL si besoin (`o::r-x`).

&nbsp; \* Plus \*\*ferm√©\*\* (aucun acc√®s others) : garder `2770` et `o::---` (recommand√© en interne).



\* \*\*Comprendre SGID sur r√©pertoire :\*\*

&nbsp; assure que \*\*le groupe des nouveaux fichiers/dossiers = groupe du parent\*\* (`projet`), √©vite les m√©langes de groupes.



\* \*\*ACL par d√©faut :\*\*

&nbsp; garantit que les \*\*droits effectifs\*\* correspondent √† la collaboration (`g::rwx`) \*\*m√™me si\*\* la \*\*umask\*\* d‚Äôun utilisateur est stricte.



&nbsp; \* Voir : `getfacl /srv/teamshare` ‚Üí pr√©sence de lignes `default:`.

&nbsp; \* Retirer une ACL : `sudo setfacl -b /srv/teamshare` (‚ö†Ô∏è supprime toutes les ACL).



\* \*\*Sticky bit (dropdir public) :\*\*

&nbsp; `drwxrwxrwt` ‚Üí \*\*seul le propri√©taire\*\* peut supprimer \*\*son\*\* fichier, tr√®s utile pour des zones de d√©p√¥t communes.



\* \*\*D√©pannage rapide :\*\*



&nbsp; \* Un membre ne peut pas √©crire ? V√©rifier \*\*qu‚Äôil est dans `projet`\*\* (`id <user>`) et \*\*se reconnecter\*\*.

&nbsp; \* Le groupe n‚Äôh√©rite pas ? V√©rifier le \*\*`s`\*\* sur les droits du groupe du dossier (SGID).

&nbsp; \* Les fichiers restent en lecture seule pour le groupe ? V√©rifier \*\*`mask::`\*\* dans les ACL (doit au moins inclure `rw`).



---



\### ‚úÖ R√©sum√© express



\* \*\*SGID\*\* sur le dossier ‚ûú tous les nouveaux √©l√©ments \*\*h√©ritent du groupe\*\*.

\* \*\*ACL par d√©faut\*\* ‚ûú tous les nouveaux √©l√©ments ont des \*\*droits coh√©rents\*\* pour le groupe.

\* \*\*Sticky bit\*\* ‚ûú ‚Äúd√©p√¥t public‚Äù o√π \*\*seul le propri√©taire\*\* peut supprimer \*\*son\*\* fichier.







