# Atelier 4 — Sauvegarde complète et restauration avec `mysqldump`

## But de l’atelier

Découvrir comment réaliser une sauvegarde complète de toutes les bases MariaDB avec `mysqldump` et comment restaurer cette sauvegarde.  
Cet atelier montre la méthode la plus courante et la plus simple de sauvegarde logique.

---

## Étapes de l’atelier

1. Préparer un répertoire de sauvegarde.

2. Lancer une sauvegarde complète avec `mysqldump`.

3. Vérifier le fichier généré.

4. Supprimer une base pour simuler une perte.

5. Restaurer la base depuis la sauvegarde.

6. Vérifier que les données sont bien récupérées.

---

## Démarches (commandes commentées)

### 1. Préparer un répertoire de sauvegarde

```bash
# Créer un dossier pour stocker les sauvegardes
sudo mkdir -p /var/backups/mariadb
sudo chown $(whoami) /var/backups/mariadb
```

---

### 2. Lancer une sauvegarde complète

```bash
# Sauvegarde de toutes les bases avec un timestamp
mysqldump --all-databases > /var/backups/mariadb/backup_full.sql
```

Explication :

- `mysqldump` : outil de sauvegarde logique.

- `--all-databases` : exporte toutes les bases.

- Le fichier généré est un script SQL contenant toutes les instructions `CREATE DATABASE`, `CREATE TABLE`, et `INSERT`.

---

### 3. Vérifier le fichier généré

```bash
ls -lh /var/backups/mariadb/backup_full.sql
head -n 20 /var/backups/mariadb/backup_full.sql
```

Résultat attendu : un fichier texte lisible contenant les commandes SQL de création de bases et tables.

---

### 4. Simuler une perte de données

Supposons que la base `gestion_stock` créée aux ateliers précédents soit supprimée.

```sql
DROP DATABASE gestion_stock;
```

Vérification :

```sql
SHOW DATABASES;
```

La base `gestion_stock` ne doit plus apparaître.

---

### 5. Restaurer la base depuis la sauvegarde

```bash
mysql < /var/backups/mariadb/backup_full.sql
```

Explication :

- On réinjecte le fichier SQL comme entrée dans le client `mysql`.

- Toutes les bases exportées sont recréées.

---

### 6. Vérifier la restauration

```sql
SHOW DATABASES;
USE gestion_stock;
SELECT * FROM produits;
```

Résultat attendu : la base `gestion_stock` et sa table `produits` doivent être présentes avec leurs données.

---

## Résultats attendus

- Un fichier de sauvegarde complet `/var/backups/mariadb/backup_full.sql` est généré.

- Après suppression volontaire de la base `gestion_stock`, elle a pu être restaurée intégralement.

- Les données initiales sont disponibles après restauration.

Très bien, passons à **Atelier 5 : Sauvegarde sélective d’une base ou d’une table précise avec `mysqldump`**.

---

# Sauvegarde sélective avec `mysqldump`

## But de l’atelier

## Démarches (commandes commentées)

### 1. Créer une base de test

```sql
CREATE DATABASE demo_backup;
USE demo_backup;

CREATE TABLE clients (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(100),
    email VARCHAR(100)
);

INSERT INTO clients (nom, email) VALUES
('Alice', 'alice@example.com'),
('Bob', 'bob@example.com'),
('Charlie', 'charlie@example.com');
```

---

### 2. Sauvegarder uniquement la base

```bash
mysqldump demo_backup > /var/backups/mariadb/demo_backup.sql
```

Explication :

- Ici, seule la base `demo_backup` est exportée.

- Le fichier contient les commandes SQL pour recréer la base, les tables et les données.

Vérification :

```bash
head -n 15 /var/backups/mariadb/demo_backup.sql
```

---

### 3. Supprimer et restaurer la base

Suppression volontaire :

```sql
DROP DATABASE demo_backup;
```

Restauration :

```bash
mysql < /var/backups/mariadb/demo_backup.sql
```

Vérification :

```sql
SHOW DATABASES;
USE demo_backup;
SELECT * FROM clients;
```

---

### 4. Sauvegarder uniquement une table

```bash
mysqldump demo_backup clients > /var/backups/mariadb/clients_only.sql
```

Explication :

- On exporte uniquement la table `clients` de la base `demo_backup`.

- Le fichier généré contient uniquement le `CREATE TABLE` et les données de `clients`.

---

### 5. Supprimer et restaurer la table

Suppression volontaire :

```sql
USE demo_backup;
DROP TABLE clients;
SHOW TABLES;
```

Restauration :

```bash
mysql demo_backup < /var/backups/mariadb/clients_only.sql
```

Vérification :

```sql
SHOW TABLES;
SELECT * FROM clients;
```

---

## Résultats attendus

- Un fichier `demo_backup.sql` contenant uniquement la base `demo_backup`.

- Possibilité de restaurer la base complète depuis ce fichier.

- Un fichier `clients_only.sql` contenant uniquement la table `clients`.

- Possibilité de restaurer uniquement la table après suppression.

---

Très bien, passons à **Atelier 6 : Sauvegarde compressée et chiffrée (gzip + gpg)**.

---

# Sauvegarde compressée et chiffrée

---

## Démarches

### 1. Sauvegarde d’une base

Exemple avec la base `gestion_stock` :

```bash
mysqldump gestion_stock > /var/backups/mariadb/gestion_stock.sql
```

---

### 2. Compression avec gzip

```bash
gzip /var/backups/mariadb/gestion_stock.sql
```

Résultat attendu :  
Le fichier `gestion_stock.sql.gz` est créé, plus petit que l’original.  
Vérification :

```bash
ls -lh /var/backups/mariadb/
```

---

### 3. Chiffrement avec gpg

```bash
gpg -c /var/backups/mariadb/gestion_stock.sql.gz
```

Explication :

- `-c` signifie chiffrement symétrique (un mot de passe partagé est demandé).

- Un fichier `gestion_stock.sql.gz.gpg` est généré.

On peut supprimer l’original compressé pour ne garder que la version chiffrée :

```bash
rm /var/backups/mariadb/gestion_stock.sql.gz
```

---

### 4. Déchiffrement et décompression

```bash
# Déchiffrement
gpg /var/backups/mariadb/gestion_stock.sql.gz.gpg
# Le fichier .gz est recréé après saisie du mot de passe

# Décompression
gunzip /var/backups/mariadb/gestion_stock.sql.gz
```

Résultat attendu : on récupère le fichier `gestion_stock.sql`.

---

### 5. Restauration de la base

Supposons que la base ait été supprimée :

```sql
DROP DATABASE gestion_stock;
```

Restauration :

```bash
mysql < /var/backups/mariadb/gestion_stock.sql
```

Vérification :

```sql
SHOW DATABASES;
USE gestion_stock;
SELECT * FROM produits;
```

---

## Résultats attendus

- Le fichier brut `.sql` est compressé en `.sql.gz`, puis chiffré en `.sql.gz.gpg`.

- On ne peut lire la sauvegarde qu’en connaissant le mot de passe défini lors du chiffrement.

- Après déchiffrement et décompression, la restauration de la base fonctionne parfaitement.

Très bien, attaquons **Atelier 7 : Sauvegarde physique avec `mariabackup`**.

---

# Atelier 7 — Sauvegarde physique avec `mariabackup`

---

## Démarches (commandes commentées)

### 1. Installer mariabackup

Sous Debian :

```bash
sudo apt update
sudo apt install mariadb-backup -y
```

Vérification :

```bash
mariabackup --version
```

---

### 2. Lancer une sauvegarde complète

On choisit un répertoire de sauvegarde, par exemple `/var/backups/mariadb/full/`.

```bash
sudo mkdir -p /var/backups/mariadb/full
sudo mariabackup --backup \
    --target-dir=/var/backups/mariadb/full \
    --user=root
```

Explication :

- `--backup` lance la sauvegarde.

- `--target-dir` est le répertoire où la sauvegarde sera stockée.

- `--user=root` utilise l’utilisateur root MariaDB (mot de passe si nécessaire).

---

### 3. Préparer la sauvegarde

Avant de restaurer, il faut **appliquer les journaux** pour rendre la sauvegarde cohérente.

```bash
sudo mariabackup --prepare \
    --target-dir=/var/backups/mariadb/full
```

Résultat attendu : message indiquant que les journaux ont été appliqués.

---

### 4. Restaurer la sauvegarde

Supposons que la base MariaDB a été perdue ou corrompue.  
On arrête le service, on restaure, puis on redémarre.

```bash
# Arrêter MariaDB
sudo systemctl stop mariadb

# Restaurer les fichiers dans le datadir officiel
sudo mariabackup --copy-back \
    --target-dir=/var/backups/mariadb/full

# Donner les bons droits
sudo chown -R mysql:mysql /var/lib/mysql

# Redémarrer MariaDB
sudo systemctl start mariadb
```

---

### 5. Vérifier la restauration

Se reconnecter et vérifier que les bases sont présentes :

```bash
mysql -e "SHOW DATABASES;"
```

Les bases existantes avant la sauvegarde doivent être à nouveau disponibles.

---

## Résultats attendus

- Une copie physique complète de toutes les données est créée dans `/var/backups/mariadb/full/`.

- La sauvegarde est préparée (journaux appliqués).

- Après restauration avec `--copy-back`, toutes les bases sont récupérées telles qu’elles étaient lors de la sauvegarde.

- Cette méthode est plus rapide que `mysqldump`, particulièrement pour les bases volumineuses.
