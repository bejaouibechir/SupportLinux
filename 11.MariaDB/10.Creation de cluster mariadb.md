# Atelier 18 — Réplication Master-Slave MariaDB sur AWS Debian 13

## Objectif

Mettre en place une réplication **Master → Slave** avec MariaDB sur deux serveurs **Debian 13** hébergés sur AWS.
Vérifier la réplication par un test pratique, puis simuler un **crash du master** et promouvoir le slave en nouveau master dans le cadre d’un plan de continuité de service.

---

## Plan de l’atelier

1. Préparer l’infrastructure AWS et la connectivité réseau.
2. Installer MariaDB sur les deux serveurs.
3. Configurer le master (activation des binlogs et création de l’utilisateur de réplication).
4. Exporter l’état du master et transférer le dump vers le slave.
5. Configurer le slave pour se connecter au master.
6. Vérifier la réplication.
7. Simuler un crash du master et promouvoir le slave.

---

## Étape 1 — Préparation de l’infrastructure AWS

* **Master** : `172.31.44.217`
* **Slave**  : `172.31.35.64`

### Security Groups

* Ouvrir le port **3306/TCP** entre le master et le slave.
* Ouvrir le port **22/TCP** (SSH) pour l’administration.

### Vérification de la connectivité

Sur le **slave** :

```bash
nc -zv 172.31.44.217 3306
```

Résultat attendu : `succeeded!`, confirmant que le master est joignable.

---

## Étape 2 — Installation de MariaDB

Sur les deux serveurs :

```bash
sudo apt update
sudo apt install mariadb-server mariadb-client -y
sudo systemctl enable --now mariadb
systemctl status mariadb --no-pager
```

---

## Étape 3 — Configuration du Master

### 3.1 Fichier de configuration

Éditer `/etc/mysql/mariadb.conf.d/50-server.cnf` :

```ini
[mysqld]
server-id     = 1
log_bin       = /var/lib/mysql/mysql-bin
binlog_format = ROW
bind-address  = 0.0.0.0
log_error     = /var/log/mysql/error.log
```

### 3.2 Préparation des répertoires

```bash
sudo mkdir -p /var/log/mysql /run/mysqld
sudo chown -R mysql:mysql /var/log/mysql /var/lib/mysql /run/mysqld
sudo chmod 750 /var/log/mysql
```

### 3.3 Redémarrage

```bash
sudo systemctl restart mariadb
```

### 3.4 Création de l’utilisateur de réplication

Dans MariaDB sur le master :

```sql
CREATE USER 'repl'@'172.31.35.64' IDENTIFIED BY 'ReplPass!2025';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'172.31.35.64';
FLUSH PRIVILEGES;
```

### 3.5 Gel des tables et enregistrement des coordonnées binlog

```sql
FLUSH TABLES WITH READ LOCK;
SHOW MASTER STATUS;
```

Exemple de sortie (cas réel) :

```
File    : mysql-bin.000004
Position: 639
```

Conserver ces valeurs précieusement pour la configuration du slave.

---

## Étape 4 — Exportation et transfert du dump

### 4.1 Création du dump

```bash
sudo mysqldump --all-databases --master-data > /tmp/master_dump.sql
```

### 4.2 Transfert vers le slave

Utiliser un outil comme **MobaXterm/SFTP** pour copier le fichier `/tmp/master_dump.sql` du master vers `/tmp/master_dump.sql` sur le slave.

### 4.3 Déverrouillage des tables

```sql
UNLOCK TABLES;
```

---

## Étape 5 — Configuration du Slave

### 5.1 Fichier de configuration

Éditer `/etc/mysql/mariadb.conf.d/50-server.cnf` :

```ini
[mysqld]
server-id   = 2
relay-log   = /var/lib/mysql/relay-bin
bind-address = 0.0.0.0
log_error   = /var/log/mysql/error.log
```

### 5.2 Préparation des répertoires

```bash
sudo mkdir -p /var/log/mysql /run/mysqld
sudo chown -R mysql:mysql /var/log/mysql /var/lib/mysql /run/mysqld
sudo chmod 750 /var/log/mysql
```

### 5.3 Redémarrage

```bash
sudo systemctl restart mariadb
```

### 5.4 Importation du dump

```bash
mysql < /tmp/master_dump.sql
```

### 5.5 Connexion au master

Dans MariaDB sur le slave :

```sql
STOP SLAVE;

CHANGE MASTER TO
  MASTER_HOST='172.31.44.217',
  MASTER_USER='repl',
  MASTER_PASSWORD='ReplPass!2025',
  MASTER_LOG_FILE='mysql-bin.000004',
  MASTER_LOG_POS=639,
  MASTER_SSL=0;

START SLAVE;
```

### 5.6 Vérification

```sql
SHOW SLAVE STATUS\G
```

Résultat attendu :

```
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
```

---

## Étape 6 — Test de la réplication

Sur le **master** :

```sql
CREATE DATABASE IF NOT EXISTS repl_demo;
USE repl_demo;
CREATE TABLE t (id INT PRIMARY KEY, msg VARCHAR(50));
INSERT INTO t VALUES (1,'hello depuis master');
```

Sur le **slave** :

```sql
USE repl_demo;
SELECT * FROM t;
```

Résultat attendu : la ligne `(1, 'hello depuis master')` est présente.

---

## Étape 7 — Simulation de crash et promotion du slave

### 7.1 Arrêt du master

Sur le master :

```bash
sudo systemctl stop mariadb
systemctl status mariadb --no-pager
```

### 7.2 Promotion du slave

Sur le slave, dans MariaDB :

```sql
STOP SLAVE;
RESET SLAVE ALL;
```

Le slave est désormais un master et accepte les écritures.

### 7.3 Vérification

```sql
USE repl_demo;
INSERT INTO t VALUES (2,'écrit sur nouveau master');
SELECT * FROM t;
```

Résultat attendu :

```
1 | hello depuis master
2 | écrit sur nouveau master
```

---

## Conclusion

À l’issue de cet atelier :

* La réplication Master → Slave est opérationnelle.
* Les données créées sur le master sont automatiquement visibles sur le slave.
* En cas de panne du master, le slave peut être promu en master et continuer à traiter les requêtes.
* Le plan de continuité de service est validé.
