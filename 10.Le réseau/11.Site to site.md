# üß± Atelier : VPN IPSec Site-to-Site avec strongSwan

---

## ‚öôÔ∏è Pr√©requis

| √âl√©ment            | D√©tails                                                |
| ------------------ | ------------------------------------------------------ |
| OS                 | Debian 12 (ou Ubuntu √©quivalent)                       |
| Nombre de machines | 2 (M1 et M2)                                           |
| Interface r√©seau   | `enp0s8` (r√©seau interne)                              |
| Adresses IP        | M1 = `10.10.10.1`, M2 = `10.10.10.2`                   |
| Privil√®ges         | Acc√®s `sudo` sur les deux machines                     |
| Connectivit√©       | SSH possible entre M1 et M2                            |
| But final          | Chiffrer le trafic ICMP entre M1 et M2 via IPSec IKEv2 |

---

## 1Ô∏è‚É£ Contexte & objectif

Vous disposez de deux machines Debian reli√©es sur un r√©seau interne :

| Machine            | IP interne | Interface | R√¥le                                  |
| ------------------ | ---------- | --------- | ------------------------------------- |
| **Machine 1 (M1)** | 10.10.10.1 | enp0s8    | Autorit√© de certification (CA) + Peer |
| **Machine 2 (M2)** | 10.10.10.2 | enp0s8    | Peer distant                          |

üéØ **Objectif :**
Mettre en place un tunnel **IPSec IKEv2** site-√†-site qui chiffre tout le trafic entre M1 et M2.

---

### üß© Sch√©ma d‚Äôarchitecture globale

**site (M1 / M2) :** chaque point de terminaison du VPN, disposant de sa propre configuration strongSwan et d‚Äôun certificat unique.

**cert :** certificat X.509 propre √† chaque machine (machine1-cert.pem, machine2-cert.pem) sign√© par la CA. Il prouve l‚Äôidentit√© du site lors de l‚Äô√©change IKEv2.

**cacert :** certificat d‚Äôautorit√© (ca-cert.pem). C‚Äôest la racine de confiance commune utilis√©e pour v√©rifier la validit√© des certificats des deux sites.

**cert vs cacert :** 

- cert = identit√© sp√©cifique d‚Äôun h√¥te, sign√© par la CA.  
- cacert = autorit√© racine utilis√©e pour signer et valider les certs.  
  => sans cacert, les certs ne sont pas reconnus comme valides.

**ESP (Encapsulating Security Payload) :** protocole du tunnel IPSec qui chiffre les paquets IP entre M1 et M2.  Les √©changes ICMP ou TCP deviennent invisibles sur le r√©seau : seule une charge ESP chiffr√©e circule.

**IKEv2 (Internet Key Exchange v2) :** protocole d‚Äô√©change de cl√©s s√©curis√© utilis√© pour n√©gocier, authentifier et √©tablir les associations de s√©curit√© (SAs) IPSec entre M1 et M2. 

```mermaid
flowchart LR
    subgraph SITE_A["Site A M1 ‚Äî 10.10.10.1"]
        direction TB
        AOS[Debian + strongSwan/charon]
        AKEY[/machine1-key.pem/]
        ACERT[/machine1-cert.pem/]
        ACA[/ca-cert.pem/]
        noteA[[private,certs,cacerts]]
        AOS --> noteA
        noteA --> AKEY
        noteA --> ACERT
        noteA --> ACA
    end

    subgraph SITE_B["Site B M2 ‚Äî 10.10.10.2"]
        direction TB
        BOS[Debian + strongSwan/charon]
        BKEY[/machine2-key.pem/]
        BCERT[/machine2-cert.pem/]
        BCA[/ca-cert.pem/]
        noteB[[private,certs,cacerts]]
        BOS --> noteB
        noteB --> BKEY
        noteB --> BCERT
        noteB --> BCA
    end

    internet{{R√©seau interne enp0s8}}
    SITE_A <-- ESP/IKEv2 --> SITE_B
    SITE_A --- internet --- SITE_B
```



---

## 2Ô∏è‚É£ Pr√©paration de l‚Äôenvironnement

### Sur **les deux machines**

```bash
sudo apt update
sudo apt install -y \
  strongswan strongswan-starter strongswan-pki \
  libstrongswan-standard-plugins libstrongswan-extra-plugins libcharon-extra-plugins \
  libgmp10
```

üí° Ces paquets assurent :

- `strongswan` : le moteur IPSec,
- `strongswan-pki` : l‚Äôoutil de gestion des certificats `pki`,
- `strongswan-starter` : la commande `ipsec`,
- `libstrongswan-*` : tous les algorithmes cryptographiques n√©cessaires.

---

## 3Ô∏è‚É£ Coupure du bruit TPM

```bash
sudo install -d -m 755 /etc/strongswan.d/pki/plugins
printf "tpm {\n  load = no\n}\n" | sudo tee /etc/strongswan.d/pki/plugins/tpm.conf >/dev/null

sudo install -d -m 755 /etc/strongswan.d/charon/plugins
printf "tpm {\n  load = no\n}\n" | sudo tee /etc/strongswan.d/charon/plugins/tpm.conf >/dev/null
```

---

## 4Ô∏è‚É£ Pr√©paration des r√©pertoires PKI

```bash
mkdir -p ~/pki/{cacerts,certs,private}
chmod 700 ~/pki
```

---

## 5Ô∏è‚É£ G√©n√©ration de la CA et certificats

### üîπ Sur M1 ‚Äî g√©n√©ration CA et certs locaux

```bash
pki --gen --type rsa --size 4096 --outform pem > ~/pki/private/ca-key.pem
pki --self --ca --lifetime 3650 \
  --in  ~/pki/private/ca-key.pem --type rsa \
  --dn  "CN=VPN-CA" \
  --outform pem > ~/pki/cacerts/ca-cert.pem
```

Puis g√©n√©ration de la cl√© et du certificat de M1 :

```bash
pki --gen --type rsa --size 4096 --outform pem > ~/pki/private/machine1-key.pem
pki --pub --in ~/pki/private/machine1-key.pem --type rsa | \
pki --issue --lifetime 1825 \
  --cacert ~/pki/cacerts/ca-cert.pem \
  --cakey  ~/pki/private/ca-key.pem \
  --dn "CN=10.10.10.1" --san "10.10.10.1" \
  --flag serverAuth --flag ikeIntermediate \
  --outform pem > ~/pki/certs/machine1-cert.pem
```

### üîπ Sch√©ma : flux PKI (CA, signature, distribution)

```mermaid
sequenceDiagram
    autonumber
    participant M1 as M1 (CA + Peer)
    participant M2 as M2 (Peer)
    M1->>M1: G√©n√©ration CA (ca-key.pem, ca-cert.pem)
    M1->>M1: G√©n√©ration cl√© + cert machine1
    M1-->>M2: Transfert ca-cert.pem
    M2->>M2: G√©n√©ration cl√© machine2
    M2-->>M1: Envoi machine2-pub.pem
    M1->>M1: Signature machine2-pub.pem -> machine2-cert.pem
    M1-->>M2: Renvoyer machine2-cert.pem
```

---

## 6Ô∏è‚É£ Configuration IPSec

```bash
sudo nano /etc/ipsec.conf
```

Contenu (M1) :

```
config setup
    charondebug="ike 2, knl 2, cfg 2"
conn net-to-net
    left=10.10.10.1
    leftid="10.10.10.1"
    leftcert=machine1-cert.pem
    right=10.10.10.2
    rightid="10.10.10.2"
    rightcert=machine2-cert.pem
    auto=start
    keyexchange=ikev2
    authby=rsasig
```

(M2) :

```
config setup
    charondebug="ike 2, knl 2, cfg 2"
conn net-to-net
    left=10.10.10.2
    leftid="10.10.10.2"
    leftcert=machine2-cert.pem
    right=10.10.10.1
    rightid="10.10.10.1"
    rightcert=machine1-cert.pem
    auto=start
    keyexchange=ikev2
    authby=rsasig
```

---

## 7Ô∏è‚É£ D√©marrage et v√©rification du tunnel

```bash
sudo systemctl restart strongswan-starter
sudo systemctl enable strongswan-starter
sudo ipsec statusall
```

### üîπ Sch√©ma : flux IKEv2 et √©tablissement du tunnel

```mermaid
sequenceDiagram
    autonumber
    participant M1 as M1 (10.10.10.1)
    participant M2 as M2 (10.10.10.2)
    M1->>M2: IKE_SA_INIT (DH, Nonces, algos)
    M2-->>M1: R√©ponse IKE_SA_INIT
    M1->>M2: IKE_AUTH (Cert M1, signature)
    M2-->>M1: IKE_AUTH (Cert M2, signature)
    Note over M1,M2: Authentification mutuelle (CA partag√©e)
    M1->>M2: CREATE_CHILD_SA (ESP param√®tres)
    M2-->>M1: Accus√© installation ESP
    Note over M1,M2: SA √©tablie, tunnel actif
```

---

## 8Ô∏è‚É£ Tests de connectivit√© et chiffrement

### Ping

```bash
ping -c 3 10.10.10.2  # depuis M1
ping -c 3 10.10.10.1  # depuis M2
```

### V√©rification du trafic chiffr√©

```bash
sudo tcpdump -i enp0s8 esp
```

Les paquets **ESP** doivent appara√Ætre.

### üîπ Sch√©ma : flux ESP chiffr√©

```mermaid
flowchart LR
    P1[Ping ICMP 10.10.10.1 ‚ûú 10.10.10.2]
    Enc[Encapsulation ESP<br/>IPSec layer]
    Wire((R√©seau interne))
    Dec[D√©capsulation ESP<br/>M2 d√©chiffre]
    P1 --> Enc --> Wire --> Dec --> OK[Paquet re√ßu clair]
```

---

## 9Ô∏è‚É£ D√©pannage & Nettoyage

### Diagnostic

```bash
sudo journalctl -u strongswan-starter -e | tail -20
sudo ipsec restart
sudo ipsec listcerts
```

### Nettoyage (M1/M2)

```bash
sudo systemctl stop strongswan-starter
sudo apt purge -y strongswan strongswan-pki strongswan-starter \
  libcharon-extra-plugins libstrongswan-extra-plugins libstrongswan-standard-plugins
sudo rm -rf /etc/ipsec.d/* ~/pki
```

### üîπ Sch√©ma : emplacements des fichiers cl√©s

```mermaid
flowchart TB
    subgraph PKI[Structure des r√©pertoires]
        A[ipsec.conf]
        B[private]
        C[certs]
        D[cacerts]
        E[private,certs,cacerts]
    end

    B -->|"Cl√©s priv√©es"| F1[machine1-key.pem, machine2-key.pem]
    C -->|"Certificats"| F2[machine1-cert.pem, machine2-cert.pem]
    D -->|"CA partag√©e"| F3[ca-cert.pem]
```

---

## ‚úÖ R√©sultat final attendu

- Le tunnel `net-to-net` se monte automatiquement (`auto=start`)
- Le trafic ICMP est chiffr√© (ESP visible dans tcpdump)
- Aucun bruit TPM n‚Äôappara√Æt
- Les certificats et cl√©s sont correctement d√©ploy√©s dans `/etc/ipsec.d/`

Parfait ‚Äî je te fournis **4 scripts pr√™ts √† l‚Äôemploi** (textes copiables) :

- `cleanup-m1.sh` ‚Äî nettoyage complet √† lancer sur **M1 (10.10.10.1)**

- `cleanup-m2.sh` ‚Äî nettoyage complet √† lancer sur **M2 (10.10.10.2)**

- `setup-m1.sh` ‚Äî script de pr√©paration, g√©n√©ration CA & M1, signature automatique du pub M2 si pr√©sent, d√©ploiement et d√©marrage (√† lancer sur **M1**)

- `setup-m2.sh` ‚Äî script de pr√©paration, g√©n√©ration M2, envoi pub vers M1, r√©ception du cert sign√©, d√©ploiement et d√©marrage (√† lancer sur **M2**)

---

### 1) cleanup-m1.sh ‚Äî nettoyage (ex√©cuter sur M1 = 10.10.10.1)

```bash
#!/usr/bin/env bash
set -euo pipefail
# cleanup-m1.sh
# Nettoyage complet strongSwan + PKI sur M1 (10.10.10.1)
# Execute as regular user. sudo will be used where n√©cessaire.

# Variables (adapter si besoin)
INTERFACE="enp0s8"

echo ">> Arr√™t du service strongSwan"
sudo systemctl stop strongswan-starter || true
sudo systemctl disable strongswan-starter || true

echo ">> Suppression paquets strongSwan (purge)"
sudo apt-get update -y
sudo apt-get purge -y strongswan strongswan-starter strongswan-pki \
  libcharon-extra-plugins libstrongswan-extra-plugins libstrongswan-standard-plugins || true

echo ">> Nettoyage des fichiers de configuration et PKI"
sudo rm -rf /etc/ipsec.d/* /etc/strongswan.d/* /etc/ipsec.conf /etc/ipsec.secrets || true
rm -rf ~/pki ~/machine2-pub.pem ~/machine2-cert.pem || true

echo ">> R√©initialisation des fichiers de logs (optionnel)"
# ne supprime pas les logs syst√®me, mais on peut vider d'√©ventuels fichiers locaux
# sudo journalctl --rotate && sudo journalctl --vacuum-time=1s

echo ">> Nettoyage termin√© sur M1."
echo "V√©rifiez manuellement : sudo ls -la /etc/ipsec.d"
```

---

### 2) cleanup-m2.sh ‚Äî nettoyage (ex√©cuter sur M2 = 10.10.10.2)

```bash
#!/usr/bin/env bash
set -euo pipefail
# cleanup-m2.sh
# Nettoyage complet strongSwan + PKI sur M2 (10.10.10.2)

INTERFACE="enp0s8"

echo ">> Arr√™t du service strongSwan"
sudo systemctl stop strongswan-starter || true
sudo systemctl disable strongswan-starter || true

echo ">> Suppression paquets strongSwan (purge)"
sudo apt-get update -y
sudo apt-get purge -y strongswan strongswan-starter strongswan-pki \
  libcharon-extra-plugins libstrongswan-extra-plugins libstrongswan-standard-plugins || true

echo ">> Nettoyage des fichiers de configuration et PKI"
sudo rm -rf /etc/ipsec.d/* /etc/strongswan.d/* /etc/ipsec.conf /etc/ipsec.secrets || true
rm -rf ~/pki ~/machine2-pub.pem ~/machine2-cert.pem ~/machine1-pub.pem || true

echo ">> Nettoyage termin√© sur M2."
echo "V√©rifiez manuellement : sudo ls -la /etc/ipsec.d"
```

---

###3) setup-m1.sh ‚Äî installer + g√©n√©rer CA & M1 + signer pub M2 automatiquement (ex√©cuter sur M1)

> Avant d‚Äôex√©cuter : √©dite les variables `REMOTE_USER` et `REMOTE_HOST` si n√©cessaire (par d√©faut `REMOTE_HOST=10.10.10.2`).

```bash
#!/usr/bin/env bash
set -euo pipefail
# setup-m1.sh
# Script √† lancer sur M1 (10.10.10.1)
# Variables -> Modifier si besoin
REMOTE_USER="${REMOTE_USER:-user}"
REMOTE_HOST="${REMOTE_HOST:-10.10.10.2}"
REMOTE_IP="${REMOTE_IP:-10.10.10.2}"
LOCAL_IP="${LOCAL_IP:-10.10.10.1}"
INTERFACE="${INTERFACE:-enp0s8}"
WAIT_TIMEOUT="${WAIT_TIMEOUT:-300}"  # secondes max d'attente pour machine2-pub.pem

echo "### M1 setup starting (LOCAL_IP=${LOCAL_IP}, REMOTE=${REMOTE_USER}@${REMOTE_HOST})"

echo "1) Installer paquets n√©cessaires (avec recommends)"
sudo apt update
sudo apt install -y --install-recommends \
  strongswan strongswan-starter strongswan-pki \
  libstrongswan-standard-plugins libstrongswan-extra-plugins libcharon-extra-plugins \
  libgmp10

echo "2) D√©sactiver plugin TPM pour r√©duire le bruit"
sudo install -d -m 755 /etc/strongswan.d/pki/plugins
printf "tpm {\n  load = no\n}\n" | sudo tee /etc/strongswan.d/pki/plugins/tpm.conf >/dev/null
sudo install -d -m 755 /etc/strongswan.d/charon/plugins
printf "tpm {\n  load = no\n}\n" | sudo tee /etc/strongswan.d/charon/plugins/tpm.conf >/dev/null

echo "3) Pr√©parer arborescence PKI dans \$HOME"
mkdir -p ~/pki/{cacerts,certs,private}
chmod 700 ~/pki

# 4) G√©n√©rer CA si pas existante
if [ ! -f ~/pki/private/ca-key.pem ] || [ ! -f ~/pki/cacerts/ca-cert.pem ]; then
  echo "4.a G√©n√©ration CA (4096 bits)"
  pki --gen --type rsa --size 4096 --outform pem > ~/pki/private/ca-key.pem
  pki --self --ca --lifetime 3650 \
    --in  ~/pki/private/ca-key.pem --type rsa \
    --dn  "CN=VPN-CA" \
    --outform pem > ~/pki/cacerts/ca-cert.pem
else
  echo "4.b CA d√©j√† pr√©sente, on la r√©utilise"
fi

# 5) G√©n√©rer cl√© et certificat M1 si manquent
if [ ! -f ~/pki/private/machine1-key.pem ]; then
  echo "5.a G√©n√©ration cl√© priv√©e machine1"
  pki --gen --type rsa --size 4096 --outform pem > ~/pki/private/machine1-key.pem
fi
if [ ! -f ~/pki/certs/machine1-cert.pem ]; then
  echo "5.b Emission du certificat machine1"
  pki --pub --in ~/pki/private/machine1-key.pem --type rsa | \
    pki --issue --lifetime 1825 \
      --cacert ~/pki/cacerts/ca-cert.pem \
      --cakey  ~/pki/private/ca-key.pem \
      --dn "CN=${LOCAL_IP}" --san "${LOCAL_IP}" \
      --flag serverAuth --flag ikeIntermediate \
      --outform pem > ~/pki/certs/machine1-cert.pem
fi

# 6) Tenter de copier la CA vers M2 (silencieux si √©chec)
echo "6) Tentative copie de la CA vers ${REMOTE_USER}@${REMOTE_HOST}"
if scp ~/pki/cacerts/ca-cert.pem "${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/" 2>/dev/null; then
  echo "-> CA copi√©e vers ${REMOTE_HOST}:/home/${REMOTE_USER}/"
else
  echo "-> √âchec copie CA (v√©rifie acc√®s SSH). Tu peux copier manuellement:"
  echo "   scp ~/pki/cacerts/ca-cert.pem ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/"
fi

# 7) D√©ploiement local des fichiers dans /etc/ipsec.d
echo "7) D√©ployer certificats/clefs dans /etc/ipsec.d (sudo)"
sudo install -d -m 755 /etc/ipsec.d/private /etc/ipsec.d/certs /etc/ipsec.d/cacerts
sudo cp -v ~/pki/private/machine1-key.pem /etc/ipsec.d/private/
sudo cp -v ~/pki/certs/machine1-cert.pem   /etc/ipsec.d/certs/
sudo cp -v ~/pki/cacerts/ca-cert.pem       /etc/ipsec.d/cacerts/

# 8) Attendre la cl√© publique machine2-pub.pem (envoy√©e par M2)
echo "8) Attente de /home/${USER}/machine2-pub.pem (timeout ${WAIT_TIMEOUT}s)"
elapsed=0
interval=3
while [ $elapsed -lt $WAIT_TIMEOUT ]; do
  if [ -f ~/machine2-pub.pem ]; then
    echo "-> Trouv√© ~/machine2-pub.pem"
    break
  fi
  sleep $interval
  elapsed=$((elapsed + interval))
done

if [ -f ~/machine2-pub.pem ]; then
  echo "9) Signature de machine2-pub.pem"
  pki --issue --lifetime 1825 \
    --cacert ~/pki/cacerts/ca-cert.pem \
    --cakey  ~/pki/private/ca-key.pem \
    --in ~/machine2-pub.pem \
    --dn "CN=${REMOTE_IP}" --san "${REMOTE_IP}" \
    --flag serverAuth --flag ikeIntermediate \
    --outform pem > ~/pki/certs/machine2-cert.pem

  echo "-> Envoi du certificat sign√© vers ${REMOTE_USER}@${REMOTE_HOST}"
  if scp ~/pki/certs/machine2-cert.pem "${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/" 2>/dev/null; then
    echo "-> Cert renvoy√© avec succ√®s"
  else
    echo "-> √âchec envoi cert (v√©rifie SSH). Instructions :"
    echo "   scp ~/pki/certs/machine2-cert.pem ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/"
  fi
else
  echo "-> machine2-pub.pem non trouv√© dans le d√©lai. Skip signature automatique. Tu peux ex√©cuter manuellement sur M1 :"
  echo "   pki --issue --lifetime 1825 --cacert ~/pki/cacerts/ca-cert.pem --cakey ~/pki/private/ca-key.pem --in /chemin/machine2-pub.pem --dn \"CN=${REMOTE_IP}\" --san \"${REMOTE_IP}\" --flag serverAuth --flag ikeIntermediate --outform pem > ~/pki/certs/machine2-cert.pem"
fi

# 10) Ecrire ipsec.conf pour M1 (√©crase l'ancien)
echo "10) √âcriture /etc/ipsec.conf (M1)"
sudo tee /etc/ipsec.conf >/dev/null <<EOF
config setup
    charondebug="ike 2, knl 2, cfg 2"

conn net-to-net
    left=${LOCAL_IP}
    leftid="${LOCAL_IP}"
    leftcert=machine1-cert.pem
    right=${REMOTE_IP}
    rightid="${REMOTE_IP}"
    rightcert=machine2-cert.pem
    auto=start
    keyexchange=ikev2
    authby=rsasig
EOF

# 11) Red√©marrer le service et v√©rifier
echo "11) Red√©marrage strongswan-starter et v√©rification"
sudo systemctl restart strongswan-starter
sudo systemctl enable strongswan-starter
echo "Status (last 20 lines):"
sudo systemctl status strongswan-starter --no-pager | sed -n '1,120p'

echo "12) Afficher √©tat ipsec"
sudo ipsec statusall || true

echo "### FIN setup-m1.sh"
echo "Si la connexion n'est pas UP, v√©rifie journaux : sudo journalctl -u strongswan-starter -e"
```

---

### 4) setup-m2.sh ‚Äî installer + g√©n√©rer M2 + envoyer pub et r√©cup√©rer cert sign√© (ex√©cuter sur M2)

> Avant d‚Äôex√©cuter : √©dite `REMOTE_USER`/`REMOTE_HOST` si besoin (`REMOTE_HOST` doit pointer vers M1).

```bash
#!/usr/bin/env bash
set -euo pipefail
# setup-m2.sh
# Script √† lancer sur M2 (10.10.10.2)
# Variables -> Modifier si besoin
REMOTE_USER="${REMOTE_USER:-user}"
REMOTE_HOST="${REMOTE_HOST:-10.10.10.1}"
REMOTE_IP="${REMOTE_IP:-10.10.10.1}"
LOCAL_IP="${LOCAL_IP:-10.10.10.2}"
INTERFACE="${INTERFACE:-enp0s8}"
WAIT_TIMEOUT="${WAIT_TIMEOUT:-300}"  # attente pour machine2-cert.pem sign√©

echo "### M2 setup starting (LOCAL_IP=${LOCAL_IP}, REMOTE=${REMOTE_USER}@${REMOTE_HOST})"

echo "1) Installer paquets n√©cessaires"
sudo apt update
sudo apt install -y --install-recommends \
  strongswan strongswan-starter strongswan-pki \
  libstrongswan-standard-plugins libstrongswan-extra-plugins libcharon-extra-plugins \
  libgmp10

echo "2) D√©sactiver plugin TPM pour r√©duire le bruit"
sudo install -d -m 755 /etc/strongswan.d/pki/plugins
printf "tpm {\n  load = no\n}\n" | sudo tee /etc/strongswan.d/pki/plugins/tpm.conf >/dev/null
sudo install -d -m 755 /etc/strongswan.d/charon/plugins
printf "tpm {\n  load = no\n}\n" | sudo tee /etc/strongswan.d/charon/plugins/tpm.conf >/dev/null

echo "3) Pr√©parer arborescence PKI dans \$HOME"
mkdir -p ~/pki/{cacerts,certs,private}
chmod 700 ~/pki

# 4) R√©cup√©rer CA depuis M1 (tentative)
echo "4) Tentative r√©cup√©ration de la CA depuis ${REMOTE_USER}@${REMOTE_HOST}"
if scp "${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/ca-cert.pem" ~/pki/cacerts/ 2>/dev/null; then
  echo "-> CA r√©cup√©r√©e et plac√©e dans ~/pki/cacerts/"
else
  if [ -f ~/ca-cert.pem ]; then
    mv ~/ca-cert.pem ~/pki/cacerts/
    echo "-> CA trouv√©e localement et d√©plac√©e ~/pki/cacerts/"
  else
    echo "-> √âchec r√©cup√©ration CA. Copie manuelle requise: scp ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/ca-cert.pem ~/pki/cacerts/"
  fi
fi

# 5) G√©n√©ration cl√© priv√©e M2
if [ ! -f ~/pki/private/machine2-key.pem ]; then
  echo "5) G√©n√©ration cl√© priv√©e machine2"
  pki --gen --type rsa --size 4096 --outform pem > ~/pki/private/machine2-key.pem
fi

# 6) Extraire pub et envoyer √† M1 pour signature
echo "6) Extraction cl√© publique et envoi √† ${REMOTE_USER}@${REMOTE_HOST}"
pki --pub --in ~/pki/private/machine2-key.pem --type rsa > ~/machine2-pub.pem
if scp ~/machine2-pub.pem "${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/" 2>/dev/null; then
  echo "-> machine2-pub.pem envoy√© vers ${REMOTE_HOST}"
else
  echo "-> √âchec envoi machine2-pub.pem. R√©cup√®re manuellement sur M1 puis signe."
  echo "   scp ~/machine2-pub.pem ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/"
fi

# 7) Attendre le certificat sign√© renvoy√© depuis M1
echo "7) Attente de ~/machine2-cert.pem (timeout ${WAIT_TIMEOUT}s)"
elapsed=0
interval=3
while [ $elapsed -lt $WAIT_TIMEOUT ]; do
  if [ -f ~/machine2-cert.pem ]; then
    echo "-> Cert sign√© re√ßu localement: ~/machine2-cert.pem"
    break
  fi
  # tentative automatique de r√©cup√©rer depuis M1 si accessible
  if scp "${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/pki/certs/machine2-cert.pem" ~/machine2-cert.pem 2>/dev/null; then
    echo "-> R√©cup√©ration automatique depuis M1 r√©ussie"
    break
  fi
  if scp "${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/machine2-cert.pem" ~/machine2-cert.pem 2>/dev/null; then
    echo "-> R√©cup√©ration automatique depuis M1 r√©ussie (alt path)"
    break
  fi
  sleep $interval
  elapsed=$((elapsed + interval))
done

if [ ! -f ~/machine2-cert.pem ]; then
  echo "-> Cert sign√© non re√ßu dans le d√©lai. Tu dois r√©cup√©rer le fichier depuis M1 manuellement."
  echo "   scp ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/pki/certs/machine2-cert.pem ~/"
  exit 1
fi

# 8) D√©ployer les fichiers dans /etc/ipsec.d
echo "8) D√©ploiement dans /etc/ipsec.d (sudo)"
sudo install -d -m 755 /etc/ipsec.d/private /etc/ipsec.d/certs /etc/ipsec.d/cacerts
sudo cp -v ~/pki/private/machine2-key.pem /etc/ipsec.d/private/
sudo cp -v ~/machine2-cert.pem            /etc/ipsec.d/certs/
sudo cp -v ~/pki/cacerts/ca-cert.pem      /etc/ipsec.d/cacerts/

# 9) R√©diger ipsec.conf pour M2
echo "9) √âcriture /etc/ipsec.conf (M2)"
sudo tee /etc/ipsec.conf >/dev/null <<EOF
config setup
    charondebug="ike 2, knl 2, cfg 2"

conn net-to-net
    left=${LOCAL_IP}
    leftid="${LOCAL_IP}"
    leftcert=machine2-cert.pem
    right=${REMOTE_IP}
    rightid="${REMOTE_IP}"
    rightcert=machine1-cert.pem
    auto=start
    keyexchange=ikev2
    authby=rsasig
EOF

# 10) Red√©marrer le service et v√©rifier
echo "10) Red√©marrage strongswan-starter et v√©rification"
sudo systemctl restart strongswan-starter
sudo systemctl enable strongswan-starter
echo "Status (last lines):"
sudo systemctl status strongswan-starter --no-pager | sed -n '1,120p'

echo "11) Afficher √©tat ipsec"
sudo ipsec statusall || true

echo "12) Test ping vers M1"
ping -c 3 "${REMOTE_IP}" || true

echo "### FIN setup-m2.sh"
echo "Si la connexion n'est pas UP, v√©rifie journaux : sudo journalctl -u strongswan-starter -e"
```

---

### Notes d‚Äôutilisation & recommandations rapides

1. **√âdite les variables en t√™te** (`REMOTE_USER`, `REMOTE_HOST`, `LOCAL_IP`, `INTERFACE`) sur chaque script si ton utilisateur ou IP diff√®rent.

2. Les scripts essaient d‚Äôutiliser `scp` pour automatiser les transferts ; cela suppose un acc√®s SSH entre les machines (mieux : configurer une cl√© SSH). Si `scp` √©choue, le script t‚Äôindiquera la commande exacte √† ex√©cuter manuellement.

3. Les op√©rations `pki` sont ex√©cut√©es sans `sudo` (cr√©ation des fichiers dans `$HOME`). Les copies vers `/etc/ipsec.d` utilisent `sudo`. Ceci √©vite d‚Äôavoir des fichiers appartenant √† root dans ton r√©pertoire utilisateur.

4. Les scripts **d√©sactivent le plugin TPM** pour √©viter le bruit log.

5. Les scripts √©crasent `/etc/ipsec.conf` ‚Äî si tu as configurations personnalis√©es, sauvegarde-les avant : `sudo cp /etc/ipsec.conf /etc/ipsec.conf.bak`.

6. Temps d‚Äôattente (`WAIT_TIMEOUT`) configurable : si ton r√©seau est lent, augmente-le.
