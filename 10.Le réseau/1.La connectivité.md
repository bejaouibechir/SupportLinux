# Niveau 2 â€“ ConnectivitÃ© et services essentiels (Debian / VirtualBox)

---

## ğŸ”¹ Notion principale 3 : Routage et passerelles

### ğŸ“ Introduction

Dans Debian, le routage permet de dÃ©finir comment les paquets quittent la machine pour atteindre dâ€™autres rÃ©seaux.  
Par dÃ©faut, une machine a une **passerelle par dÃ©faut** (gateway) qui permet dâ€™accÃ©der Ã  Internet.  
Nous allons voir comment lister, ajouter et supprimer des routes, en utilisant **`ip`** (dÃ©jÃ  installÃ©) et Ã©ventuellement **`route`** si vous installez le paquet `net-tools`.

---

### ğŸ“Œ DÃ©mo 1 : VÃ©rifier la table de routage

Lister les routes avec `ip` (par dÃ©faut disponible) :

```bash
ip route show
```

Installer `net-tools` si vous voulez aussi la commande `route` :

```bash
sudo apt update
sudo apt install net-tools -y
```

Puis :

```bash
sudo route -n
```

- `-n` : affiche les adresses IP au lieu de tenter de rÃ©soudre les noms (plus rapide).

ğŸ‘‰ **RÃ©sultat attendu** :  
Vous devez voir une ligne contenant `default` ou `0.0.0.0` â†’ câ€™est la passerelle par dÃ©faut, souvent `192.168.56.1` en mode Host-Only sur VirtualBox.

et obtenu

```nginx
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 enp0s8
192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s
```

### Ligne `0.0.0.0 192.168.1.1 0.0.0.0`

- **Destination = 0.0.0.0**  
  â†’ Câ€™est la route **par dÃ©faut** (tout ce qui ne correspond pas Ã  un rÃ©seau connu).

- **Gateway = 192.168.1.1**  
  â†’ La passerelle par dÃ©faut. Tous les paquets destinÃ©s Ã  Internet ou Ã  dâ€™autres rÃ©seaux passent par cette IP.

- **Genmask = 0.0.0.0**  
  â†’ Masque associÃ© Ã  0.0.0.0 â†’ signifie "tous les rÃ©seaux".

- **Flags = UG**
  
  - **U** : route active (Up).
  
  - **G** : utilise une Gateway (passerelle).

- **Metric = 100**  
  â†’ PrioritÃ© de la route (plus bas = plus prioritaire).

- **Iface = enp0s8**  
  â†’ Lâ€™interface rÃ©seau utilisÃ©e est `enp0s8`.

ğŸ‘‰ **En clair** : tout trafic qui nâ€™est pas dans un rÃ©seau local connu est envoyÃ© vers **192.168.1.1** via `enp0s8`.

### Ligne `192.168.1.0 0.0.0.0 255.255.255.0`

- **Destination = 192.168.1.0**  
  â†’ RÃ©seau local auquel vous Ãªtes connectÃ©.

- **Gateway = 0.0.0.0**  
  â†’ Pas de passerelle â†’ les machines de ce rÃ©seau sont joignables **directement**.

- **Genmask = 255.255.255.0**  
  â†’ Masque /24 (rÃ©seau de 256 adresses : de 192.168.1.0 Ã  192.168.1.255).

- **Flags = U**
  
  - **U** : route active.

- **Iface = enp0s8**  
  â†’ Communication directe via lâ€™interface `enp0s8`.

ğŸ‘‰ **En clair** : toutes les machines du rÃ©seau **192.168.1.0/24** (par exemple 192.168.1.20) sont joignables directement sans passer par la gateway.

---

### ğŸ“Œ DÃ©mo 2 : Ajouter une route spÃ©cifique

Supposons que vous ayez ajoutÃ© une deuxiÃ¨me carte rÃ©seau (`enp0s8`) en mode Host-Only avec IP `192.168.100.10`.  
Vous voulez atteindre le rÃ©seau `10.10.10.0/24` via la passerelle `192.168.100.1` :

```bash
sudo ip route add 10.10.10.0/24 via 192.168.100.1 dev enp0s8
```

VÃ©rifier :

```bash
ip route show
```

ğŸ‘‰ **Astuce / PiÃ¨ge** :  
Si la passerelle `192.168.100.1` nâ€™existe pas (pas dâ€™autre VM ou pas de DHCP sur ce rÃ©seau), la commande Ã©chouera avec *â€œNexthop has invalid gatewayâ€*.  
âš ï¸ Solution : soit vous crÃ©ez une deuxiÃ¨me VM sur le rÃ©seau `192.168.100.0/24` avec lâ€™IP `192.168.100.1`, soit vous choisissez une passerelle valide existante (par ex. VirtualBox DHCP).

---

### ğŸ“Œ DÃ©mo 3 : Changer la passerelle par dÃ©faut

Changer la gateway par dÃ©faut pour passer par `192.168.56.1` :

```bash
sudo ip route replace default via 192.168.56.1 dev enp0s3
```

Tester la connectivitÃ© :

```bash
ping -c 4 8.8.8.8
```

ğŸ‘‰ **Troubleshooting** :

- Si `ping` marche sur `8.8.8.8` mais pas sur `google.com` â†’ problÃ¨me DNS.

- VÃ©rifiez `/etc/resolv.conf`.

---

### ğŸ”§ Commandes & options utiles â€“ Routage Debian

- `ip route show` â†’ afficher table de routage

- `ip route add <rÃ©seau>/<masque> via <passerelle> dev <iface>` â†’ ajouter route

- `ip route del <rÃ©seau>/<masque>` â†’ supprimer route

- `ip route replace default via <gateway>` â†’ changer gateway par dÃ©faut

- `route -n` (aprÃ¨s `net-tools`) â†’ voir routes rapides

---

## ğŸ”¹ Notion principale 4 : Outils de diagnostic

### ğŸ“ Introduction

Diagnostiquer la connectivitÃ© est crucial. Debian fournit plusieurs outils : `ping`, `traceroute`, `mtr`, `dig`, `nslookup`, et `ss`.

---

### ğŸ“Œ DÃ©mo 1 : VÃ©rifier la connectivitÃ© avec `ping`

Tester la connectivitÃ© avec la passerelle VirtualBox (`192.168.56.1`) :

```bash
ping -c 4 192.168.56.1
```

Options utiles :

- `-c <n>` â†’ envoyer *n* paquets

- `-i <s>` â†’ intervalle entre paquets

- `-s <taille>` â†’ taille du paquet

```bash
# -c 4  : envoyer exactement 4 paquets ICMP
# -i 1  : attendre 1 seconde entre chaque envoi
# -s 128: taille de la charge utile ICMP (payload) = 128 octets
#         (Taille totale â‰ˆ 128 + 8 (entÃªte ICMP) + 20 (entÃªte IP) = 156 octets)

ping -c 4 -i 1 -s 128 192.168.56.1
```

---

### ğŸ“Œ DÃ©mo 2 : DÃ©tecter un problÃ¨me de chemin avec `traceroute`

Installer lâ€™outil :

```bash
sudo apt install traceroute -y
```

VÃ©rifier la route par dÃ©faut (si vous voulez tester Internet)

```bash
ip route show default
```

#### Premier pas sur le rÃ©seau local

**Objectif :** comprendre la sortie de base avec la passerelle VirtualBox (`192.168.1.1`).

```bash
# Lancer un traceroute simple vers la passerelle Host-Only
# -n : pas de rÃ©solution DNS (plus rapide, plus lisible)
# -i enp0s9 : forcer lâ€™interface host-only
sudo traceroute -n -i enp0s9 192.168.1.1
```

Tracer le chemin vers Google DNS :

```bash
traceroute 8.8.8.8
```

**Objectif :** accÃ©lÃ©rer, limiter, clarifier lâ€™affichage.

```bash
# -n   : pas de DNS
# -q 1 : 1 seule sonde par hop (plus rapide)
# -w 2 : dÃ©lai d'attente 2 s par sonde
# -m 5 : maximum 5 sauts (utile en labo)
sudo traceroute -n -q 1 -w 2 -m 5 -i enp0s9 192.168.56.1
```

**Objectif :** montrer les variantes **ICMP** et **TCP** (parfois mieux acceptÃ©es par des firewalls).

```bash
# Variante ICMP (nÃ©cessite les privilÃ¨ges RAW) :
sudo traceroute -I -n -i enp0s9 192.168.56.1

# Variante TCP SYN vers un port "ouvert" courant (443) :
# Utile quand UDP/ICMP sont filtrÃ©s sur le chemin.
sudo traceroute -T -p 443 -n -i enp0s9 192.168.56.1
```

---

### ğŸ“Œ DÃ©mo 3 : Traceroute continu avec `mtr`

Installer :

```bash
sudo apt install mtr -y
```

Lancer :

```bash
mtr google.com
```

ğŸ‘‰ Avantage : `mtr` combine `ping` + `traceroute` en temps rÃ©el.

---

### ğŸ“Œ DÃ©mo 4 : RÃ©solution DNS avec `dig`

- **`dig`** (Domain Information Groper) interroge le **DNS**.

- Il sert Ã  **diagnostiquer** les problÃ¨mes de rÃ©solution (latence, cache, records manquants, filtrage, DNSSEC, etc.)

- **vÃ©rifier** les enregistrements (A/AAAA, MX, NS, TXTâ€¦), et Ã  **comprendre** comment un nom est rÃ©solu

Installer :

```bash
sudo apt install dnsutils -y
```

Tester :

```bash
dig google.com
; <<>> DiG 9.20.11-4-Debian <<>> google.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 49960
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;google.com.                    IN      A

;; ANSWER SECTION:
google.com.             43      IN      A       142.251.37.46

;; Query time: 48 msec
;; SERVER: 8.8.8.8#53(8.8.8.8) (UDP)
;; WHEN: Mon Sep 29 17:38:40 CEST 2025
;; MSG SIZE  rcvd: 55
```

Ces commandes nâ€™interrompent pas la connexion et vous aident Ã  explorer rapidement.

```bash
# 1) RÃ©ponse courte (pratique pour scripts)
dig +short google.com A      # IPv4
dig +short google.com AAAA   # IPv6

# 2) Interroger un serveur prÃ©cis (ici Cloudflare)
dig @1.1.1.1 google.com A

# 3) Voir le TTL restant (sortie complÃ¨te) et comparer chez plusieurs rÃ©solveurs
dig @8.8.8.8 google.com A
dig @1.1.1.1 google.com A

# 4) Remonter la chaÃ®ne d'autoritÃ© (root -> .com -> google.com)
dig +trace google.com

# 5) Demander les serveurs autoritatifs pour le domaine
dig google.com NS +nocomments +noquestion

# 6) Tester DNSSEC (si le rÃ©solveur valide, vous verrez le flag AD)
dig +dnssec google.com A
# Si le rÃ©solveur ne valide pas, pas de AD. Pour forcer la vÃ©rification cÃ´tÃ© client,
# interrogez un rÃ©solveur qui valide (ex: 1.1.1.1, 9.9.9.9) et observez le flag AD.

# 7) Forcer TCP (utile quand UDP est filtrÃ© ou quâ€™il y a troncature)
dig +tcp google.com A

# 8) Lookup inverse (rDNS) sur une IP
dig -x 142.251.37.46 +short
```

# Quand utiliser `dig` en pratique

- **AprÃ¨s un changement DNS** (A/AAAA, CNAME, MXâ€¦) : vÃ©rifier la valeur retournÃ©e, le TTL, et la propagation via `@` diffÃ©rents rÃ©solveurs.

- **Pannes applicatives** : confirmer que le **hostname** pointe vers la bonne IP et que la latence DNS nâ€™est pas la cause.

- **Mail** : vÃ©rifier **MX** et **TXT/SPF**, **DKIM** (TXT sur `selector._domainkey.example.com`).

- **CDN / gÃ©o-routing** : comprendre pourquoi une IP diffÃ¨re selon le lieu/rÃ©solveur.

- **SÃ©curitÃ©** : valider **DNSSEC** (`+dnssec` / flag **AD**), dÃ©tecter du **NXDOMAIN**, des **CNAME** inattendus, etc.

---

### ğŸ“Œ DÃ©mo 5 : VÃ©rifier les sockets avec `ss`

Lister les services en Ã©coute :

```bash
ss -tulnp
```

Options utiles :

- `-t` â†’ TCP

- `-u` â†’ UDP

- `-l` â†’ listening

- `-n` â†’ pas de rÃ©solution DNS

- `-p` â†’ affiche le PID et nom du processus

**Exemple de sortie:**

```bash
ss -tulnp
Netid      State       Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process
udp        UNCONN      0           0                      0.0.0.0:5353                 0.0.0.0:*
udp        UNCONN      0           0                      0.0.0.0:39213                0.0.0.0:*
udp        UNCONN      0           0                         [::]:5353                    [::]:*
udp        UNCONN      0           0                         [::]:45192                   [::]:*
tcp        LISTEN      0           128                  127.0.0.1:6011                 0.0.0.0:*
tcp        LISTEN      0           128                  127.0.0.1:6010                 0.0.0.0:*
tcp        LISTEN      0           511                    0.0.0.0:80                   0.0.0.0:*
tcp        LISTEN      0           128                    0.0.0.0:22                   0.0.0.0:*
tcp        LISTEN      0           100                    0.0.0.0:25                   0.0.0.0:*
tcp        LISTEN      0           80                192.168.1.16:3306                 0.0.0.0:*
tcp        LISTEN      0           4096                 127.0.0.1:631                  0.0.0.0:*
tcp        LISTEN      0           511                       [::]:80                      [::]:*
tcp        LISTEN      0           128                       [::]:22                      [::]:*
tcp        LISTEN      0           100                       [::]:25                      [::]:*
tcp        LISTEN      0           4096                     [::1]:631                     [::]:*
tcp        LISTEN      0           4096                         *:9090                       *:*
tcp        LISTEN      0           4096                         *:9100                       *:*
tcp        LISTEN      0           4096                         *:9104                       *:*
tcp        LISTEN      0           4096                         *:3000                       *:*
tcp        LISTEN      0           128                      [::1]:6011                    [::]:*
tcp        LISTEN      0           128                      [::1]:6010                    [::]:*
```

**State** : Ã©tat (`LISTEN` pour TCP ; `UNCONN` pour UDP).

**Recv-Q** : file dâ€™attente en rÃ©ception.

**Send-Q** : file dâ€™attente Ã©mission.

- **Local Address:Port** : IP/port **bindÃ©s** par le service.
  
  - `0.0.0.0` = toutes les IPv4, `[::]` = toutes les IPv6, `127.0.0.1` / `[::1]` = loopback.

- **Peer Address:Port** : paire distante (ici `*` = nâ€™importe qui).

- **Process** : PID/nom (vide si la commande nâ€™a pas tournÃ© en root ou si masquÃ© par la politique systÃ¨me).

---

## ğŸ”¹ Notion principale 5 : Service SSH

### ğŸ“ Introduction

SSH est indispensable pour se connecter Ã  distance et administrer un serveur. Sur Debian, le paquet est `openssh-server`.

---

### ğŸ“Œ DÃ©mo 1 : Installation du serveur SSH

Mettre Ã  jour et installer :

```bash
sudo apt update
sudo apt install openssh-server -y
```

VÃ©rifier lâ€™Ã©tat :

```bash
systemctl status ssh
```

---

### ğŸ“Œ DÃ©mo 2 : Connexion SSH

Depuis une autre machine du rÃ©seau Host-Only :

```bash
ssh user@192.168.56.101
```

Options utiles :

- `-p <port>` â†’ utiliser un port diffÃ©rent

- `-i <clÃ©>` â†’ clÃ© privÃ©e

---

### 

### ---

# âœ… RÃ©capitulatif des commandes du Niveau 2

- **Routage**
  
  - `ip route show/add/del/replace`
  
  - `route -n` (si installÃ© via `net-tools`)

- **Diagnostic**
  
  - `ping -c -i -s`
  
  - `traceroute -n -I`
  
  - `mtr <hÃ´te>`
  
  - `dig +short +trace`
  
  - `ss -tulnp`

- **SSH**
  
  - `apt install openssh-server`
  
  - `systemctl status|restart ssh`
  
  - `ssh -p -i`
