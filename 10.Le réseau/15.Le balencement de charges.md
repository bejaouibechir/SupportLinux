

# Atelier : Mise en place d’un Load-Balancer simple avec IPVS

---

## 1. Contexte & objectif

Dans cet atelier, nous allons transformer **machine1** en **load-balancer IPVS** qui répartit les connexions TCP (par ex. HTTP) entre deux serveurs applicatifs.

- **machine1** : load-balancer IPVS

- **machine2** : backend web 1 (Apache/Nginx simple)

- **machine1 (namespace supplémentaire)** ou **machine2 (conteneur léger)** : backend web 2

L’objectif est de montrer :

- comment IPVS permet de faire du load-balancing L4 (niveau transport)

- comment vérifier la répartition du trafic

- différence avec une simple redirection statique

---

## 2. Préparation du terrain

### 2.1. Paquets nécessaires

Sur **machine1 (load-balancer)** :

```bash
sudo apt update
sudo apt install -y ipvsadm iproute2 curl
```

Sur **machine2 (backend 1)** :

```bash
sudo apt update
sudo apt install -y apache2
echo "Réponse du serveur BACKEND-1" | sudo tee /var/www/html/index.html
sudo systemctl restart apache2
```

Sur **machine1 (pour backend 2 en namespace)** :

```bash
sudo apt install -y apache2
```

*(nous allons lancer un deuxième Apache dans un namespace réseau pour simuler un second serveur)*

---

### 2.2. Schéma réseau simplifié

- `machine1 enp0s8 = 10.10.10.1` → Load Balancer IPVS

- `machine2 enp0s8 = 10.10.10.2` → Backend 1 (Apache classique)

- `machine1 namespace ns-backend2 = 10.10.10.3` → Backend 2 (Apache dans un namespace)

---

## 3. Déroulement de l’exercice

### Étape 1 : Créer un namespace pour le deuxième backend

Sur **machine1** :

```bash
sudo ip netns add ns-backend2
sudo ip link add veth0 type veth peer name veth1
sudo ip link set veth0 netns ns-backend2
sudo ip addr add 10.10.10.3/24 dev veth1
sudo ip link set veth1 up
sudo ip netns exec ns-backend2 ip addr add 10.10.10.3/24 dev veth0
sudo ip netns exec ns-backend2 ip link set veth0 up
sudo ip netns exec ns-backend2 ip link set lo up
```

Vérification :

```bash
ping -c 2 10.10.10.3
```

### Étape 2 : Lancer Apache dans le namespace (backend 2)

```bash
sudo ip netns exec ns-backend2 bash -c "echo 'Réponse du serveur BACKEND-2' > /var/www/html/index.html"
sudo ip netns exec ns-backend2 systemctl start apache2
```

Vérification :

```bash
curl http://10.10.10.3
```

---

### Étape 3 : Configurer IPVS sur machine1

Définir une IP virtuelle pour le load balancer (VIP) :

```bash
sudo ip addr add 10.10.10.100/24 dev enp0s8
```

Configurer IPVS :

```bash
sudo ipvsadm -A -t 10.10.10.100:80 -s rr
sudo ipvsadm -a -t 10.10.10.100:80 -r 10.10.10.2:80 -m
sudo ipvsadm -a -t 10.10.10.100:80 -r 10.10.10.3:80 -m
```

Explications :

- `-A` ajoute un service virtuel (VIP:PORT)

- `-s rr` = round-robin

- `-r` ajoute un backend réel (realserver)

- `-m` active le mode NAT (masquerade)

---

### Étape 4 : Tester le load-balancing

Depuis machine1 ou machine2 :

```bash
for i in {1..6}; do curl -s http://10.10.10.100 | grep Réponse; done
```

Résultat attendu (alternance) :

```
Réponse du serveur BACKEND-1
Réponse du serveur BACKEND-2
Réponse du serveur BACKEND-1
Réponse du serveur BACKEND-2
...
```

Visualiser la table IPVS :

```bash
sudo ipvsadm -Ln
```

---

## 4. Nettoyage

À la fin de l’exercice, remettre le système propre :

### Supprimer configuration IPVS :

```bash
sudo ipvsadm -C
```

### Retirer l’IP virtuelle :

```bash
sudo ip addr del 10.10.10.100/24 dev enp0s8
```

### Supprimer le namespace backend2 :

```bash
sudo ip netns delete ns-backend2
```

### (Optionnel) Supprimer Apache si installé juste pour l’exercice :

```bash
sudo apt remove --purge -y apache2
sudo apt autoremove -y
```

---

✅ Cet atelier permet aux participants de :

- découvrir **IPVS et ipvsadm**

- comprendre les modes de load-balancing L4

- manipuler namespaces réseau et services virtuels

- visualiser la répartition de charge en pratique

-
