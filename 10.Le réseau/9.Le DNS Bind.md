

# Exercice 9 ‚Äî R√©solution de noms : `/etc/hosts` ‚ûú Bind9 (domaine `lab`)

## Contexte de lab

- **Machine1 (client)** : `10.10.10.1`

- **Machine2 (DNS serveur)** : `10.10.10.2`

- Domaine local choisi : **`lab`** (‚ö†Ô∏è **pas** `.local`, r√©serv√© mDNS)

---

## √âtape A ‚Äî D√©mo rapide avec `/etc/hosts`

### A.1 ‚Äî Ajouter des entr√©es (sur **les deux** machines)

cr√©er/√©diter le fichier : `/etc/hosts`

contenu √† ajouter en bas :

```text
10.10.10.1   m1.lab m1
10.10.10.2   m2.lab m2
```

### A.2 ‚Äî Test simple

```bash
# Depuis Machine1 vers Machine2
ping -c 3 m2.lab

# Depuis Machine2 vers Machine1
ping -c 3 m1.lab

# V√©rifier la r√©solution via la libc (nsswitch)
getent hosts m2.lab
getent hosts m1.lab
```

üí° Remarque : `ping` et `getent` consultent **/etc/hosts** avant DNS ;  
`dig`, lui, interroge **directement** un serveur DNS (on le verra plus bas).

---

## √âtape B ‚Äî Installation & pr√©paration de Bind9 (Machine2)

### B.1 ‚Äî Installer Bind9 et ses utilitaires

```bash
# Installer le serveur DNS et les outils de v√©rification
sudo apt update
sudo apt install -y bind9 bind9utils
```

### B.2 ‚Äî V√©rifier le service

```bash
# Statut du service
systemctl status bind9

# Voir l'√©coute sur le port 53
sudo ss -tulpn | grep ':53'
```

---

## √âtape C ‚Äî D√©claration de la zone `lab` (Machine2)

### C.1 ‚Äî D√©clarer la zone dans Bind9

cr√©er/√©diter le fichier : `/etc/bind/named.conf.local`

contenu (ajouter **exactement** ceci) :

```text
zone "lab" {
    type master;
    file "/etc/bind/db.lab";
};
```

### C.2 ‚Äî Cr√©er le fichier de zone

cr√©er le fichier : `/etc/bind/db.lab`

contenu du fichier :

```text
$TTL    604800
@       IN      SOA     ns.lab. admin.lab. (
                         1         ; Serial (incr√©mentez √† chaque modification)
                         604800    ; Refresh
                         86400     ; Retry
                         2419200   ; Expire
                         604800 )  ; Negative Cache TTL

; Serveur DNS faisant autorit√© pour "lab"
@       IN      NS      ns.lab.

; Enregistrements A de la zone
ns      IN      A       10.10.10.2
m1      IN      A       10.10.10.1
m2      IN      A       10.10.10.2
```

Notes importantes :

- `ns.lab.` **avec un point final** (= FQDN complet).

- `m1` et `m2` sont **des noms relatifs** √† la zone `lab` ‚Üí ils deviendront `m1.lab.` et `m2.lab.`.

### C.3 ‚Äî V√©rifier la configuration avant red√©marrage

```bash
# V√©rifie la syntaxe globale
sudo named-checkconf

# V√©rifie la zone "lab" sp√©cifiquement
sudo named-checkzone lab /etc/bind/db.lab
```

Attendu : `OK` sans erreurs.

### C.4 ‚Äî Red√©marrer Bind9

```bash
sudo systemctl restart bind9
sudo systemctl status bind9
```

---

## √âtape D ‚Äî Pointer le client vers **votre** DNS (Machine1)

### D.1 ‚Äî Utiliser le DNS de Machine2

cr√©er/√©diter le fichier : `/etc/resolv.conf`

contenu minimal pour le test :

```text
nameserver 10.10.10.2
```

üí° Si un gestionnaire (NetworkManager/systemd-resolved) r√©√©crit ce fichier, c‚Äôest **normal** en production ; pour le lab, on garde ce r√©glage simple. (On peut rendre √ßa persistant plus tard.)

---

## √âtape E ‚Äî Tests `dig` + explications

### E.1 ‚Äî Requ√™te A pour m1.lab (Machine1 ‚ûú Machine2)

```bash
dig m1.lab @10.10.10.2
```

Ce qu‚Äôon doit voir (explications) :

- `SERVER: 10.10.10.2#53` ‚Üí vous interrogez bien **votre Bind9**.

- `status: NOERROR` ‚Üí la zone contient le nom, pas d‚Äôerreur.

- `ANSWER SECTION:` avec une ligne du type :
  
  ```
  m1.lab.   604800  IN  A  10.10.10.1
  ```
  
  - `m1.lab.` : nom demand√©
  
  - `604800` : TTL (en secondes)
  
  - `A` : type d‚Äôenregistrement (IPv4)
  
  - `10.10.10.1` : adresse renvoy√©e

### E.2 ‚Äî Requ√™te A pour m2.lab

```bash
dig m2.lab @10.10.10.2
```

Attendu dans `ANSWER SECTION` :

```
m2.lab.   604800  IN  A  10.10.10.2
```

### E.3 ‚Äî Comparaison avec votre sortie pr√©c√©dente (NXDOMAIN)

Vos sorties montraient :

```
status: NXDOMAIN
```

üëâ Cela arrive quand :

- La **zone n‚Äô√©tait pas d√©clar√©e** dans `named.conf.local`, **ou**

- Le **fichier `/etc/bind/db.lab` √©tait vide** ou mal r√©f√©renc√©, **ou**

- Bind9 n‚Äôavait pas √©t√© red√©marr√© apr√®s vos changements.

Apr√®s nos corrections (zone d√©clar√©e + fichier de zone rempli + restart), vous devez obtenir **NOERROR** + **ANSWER SECTION**.

---

## √âtape F ‚Äî (Optionnel) Tests suppl√©mentaires utiles

### F.1 ‚Äî Sortie condens√©e

```bash
dig +short m1.lab @10.10.10.2
dig +short m2.lab @10.10.10.2
```

Attendu : juste les IP, plus lisible dans des scripts.

### F.2 ‚Äî Ping par nom (maintenant via DNS)

```bash
ping -c 3 m2.lab
```

### F.3 ‚Äî D√©pannage rapide si √ßa coince

```bash
# Voir les logs de Bind9 (erreurs de zone, etc.)
journalctl -u bind9 --no-pager -e

# V√©rifier l'√©coute sur UDP/TCP 53
sudo ss -tulpn | grep ':53'

# Forcer la requ√™te vers votre DNS (bypasse /etc/resolv.conf)
dig m1.lab @10.10.10.2
```

---

# ‚úÖ R√©sultat attendu global

- `/etc/hosts` : d√©mo locale **OK** (ping et getent).

- Bind9 (Machine2) : **zone `lab` op√©rationnelle** (`m1.lab`/`m2.lab`).

- `dig m1.lab @10.10.10.2` et `dig m2.lab @10.10.10.2` : **status `NOERROR`** + **ANSWER SECTION** avec les bonnes IP.

- Le client (Machine1) utilise votre DNS (via `nameserver 10.10.10.2`).


