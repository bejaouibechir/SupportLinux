# Exercice 9 â€” RÃ©solution de noms : `/etc/hosts` âœ Bind9 (domaine `lab`)

## Contexte de lab

- **Machine1 (client)** : `10.10.10.1`

- **Machine2 (DNS serveur)** : `10.10.10.2`

- Domaine local choisi : **`lab`** (âš ï¸ **pas** `.local`, rÃ©servÃ© mDNS)

---

## Ã‰tape A â€” DÃ©mo rapide avec `/etc/hosts`

### A.1 â€” Ajouter des entrÃ©es (sur **les deux** machines)

crÃ©er/Ã©diter le fichier : `/etc/hosts`

contenu Ã  ajouter en bas :

```text
10.10.10.1   m1.lab m1
10.10.10.2   m2.lab m2
```

### A.2 â€” Test simple

```bash
# Depuis Machine1 vers Machine2
ping -c 3 m2.lab

# Depuis Machine2 vers Machine1
ping -c 3 m1.lab

# VÃ©rifier la rÃ©solution via la libc (nsswitch)
getent hosts m2.lab
getent hosts m1.lab
```

ğŸ’¡ Remarque : `ping` et `getent` consultent **/etc/hosts** avant DNS ;  
`dig`, lui, interroge **directement** un serveur DNS (on le verra plus bas).

---

## Ã‰tape B â€” Installation & prÃ©paration de Bind9 (Machine2)

### B.1 â€” Installer Bind9 et ses utilitaires

```bash
# Installer le serveur DNS et les outils de vÃ©rification
sudo apt update
sudo apt install -y bind9 bind9utils
```

### B.2 â€” VÃ©rifier le service

```bash
# Statut du service
systemctl status bind9

# Voir l'Ã©coute sur le port 53
sudo ss -tulpn | grep ':53'
```

---

## Ã‰tape C â€” DÃ©claration de la zone `lab` (Machine2)

### C.1 â€” DÃ©clarer la zone dans Bind9

crÃ©er/Ã©diter le fichier : `/etc/bind/named.conf.local`

contenu (ajouter **exactement** ceci) :

```text
zone "lab" {
    type master;
    file "/etc/bind/db.lab";
};
```

### C.2 â€” CrÃ©er le fichier de zone

crÃ©er le fichier : `/etc/bind/db.lab`

contenu du fichier :

```text
$TTL    604800
@       IN      SOA     ns.lab. admin.lab. (
                         1         ; Serial (incrÃ©mentez Ã  chaque modification)
                         604800    ; Refresh
                         86400     ; Retry
                         2419200   ; Expire
                         604800 )  ; Negative Cache TTL

; Serveur DNS faisant autoritÃ© pour "lab"
@       IN      NS      ns.lab.

; Enregistrements A de la zone
ns      IN      A       10.10.10.2
m1      IN      A       10.10.10.1
m2      IN      A       10.10.10.2
```

Notes importantes :

- `ns.lab.` **avec un point final** (= FQDN complet).

- `m1` et `m2` sont **des noms relatifs** Ã  la zone `lab` â†’ ils deviendront `m1.lab.` et `m2.lab.`.

### C.3 â€” VÃ©rifier la configuration avant redÃ©marrage

```bash
# VÃ©rifie la syntaxe globale
sudo named-checkconf

# VÃ©rifie la zone "lab" spÃ©cifiquement
sudo named-checkzone lab /etc/bind/db.lab
```

Attendu : `OK` sans erreurs.

### C.4 â€” RedÃ©marrer Bind9

```bash
sudo systemctl restart bind9
sudo systemctl status bind9
```

---

## Ã‰tape D â€” Pointer le client vers **votre** DNS (Machine1)

### D.1 â€” Utiliser le DNS de Machine2

crÃ©er/Ã©diter le fichier : `/etc/resolv.conf`

contenu minimal pour le test :

```text
nameserver 10.10.10.2
```

ğŸ’¡ Si un gestionnaire (NetworkManager/systemd-resolved) rÃ©Ã©crit ce fichier, câ€™est **normal** en production ; pour le lab, on garde ce rÃ©glage simple. (On peut rendre Ã§a persistant plus tard.)

---

## Ã‰tape E â€” Tests `dig` + explications

### E.1 â€” RequÃªte A pour m1.lab (Machine1 âœ Machine2)

```bash
dig m1.lab @10.10.10.2
```

Ce quâ€™on doit voir (explications) :

- `SERVER: 10.10.10.2#53` â†’ vous interrogez bien **votre Bind9**.

- `status: NOERROR` â†’ la zone contient le nom, pas dâ€™erreur.

- `ANSWER SECTION:` avec une ligne du type :
  
  ```
  m1.lab.   604800  IN  A  10.10.10.1
  ```
  
  - `m1.lab.` : nom demandÃ©
  
  - `604800` : TTL (en secondes)
  
  - `A` : type dâ€™enregistrement (IPv4)
  
  - `10.10.10.1` : adresse renvoyÃ©e

### E.2 â€” RequÃªte A pour m2.lab

```bash
dig m2.lab @10.10.10.2
```

Attendu dans `ANSWER SECTION` :

```
m2.lab.   604800  IN  A  10.10.10.2
```

### E.3 â€” Comparaison avec votre sortie prÃ©cÃ©dente (NXDOMAIN)

Vos sorties montraient :

```
status: NXDOMAIN
```

ğŸ‘‰ Cela arrive quand :

- La **zone nâ€™Ã©tait pas dÃ©clarÃ©e** dans `named.conf.local`, **ou**

- Le **fichier `/etc/bind/db.lab` Ã©tait vide** ou mal rÃ©fÃ©rencÃ©, **ou**

- Bind9 nâ€™avait pas Ã©tÃ© redÃ©marrÃ© aprÃ¨s vos changements.

AprÃ¨s nos corrections (zone dÃ©clarÃ©e + fichier de zone rempli + restart), vous devez obtenir **NOERROR** + **ANSWER SECTION**.

---

## Ã‰tape F â€”Tests supplÃ©mentaires utiles

### F.1 â€” Sortie condensÃ©e

```bash
dig +short m1.lab @10.10.10.2
dig +short m2.lab @10.10.10.2
```

Attendu : juste les IP, plus lisible dans des scripts.

### F.2 â€” Ping par nom (maintenant via DNS)

```bash
ping -c 3 m2.lab
```

### F.3 â€” DÃ©pannage rapide si Ã§a coince

```bash
# Voir les logs de Bind9 (erreurs de zone, etc.)
journalctl -u bind9 --no-pager -e

# VÃ©rifier l'Ã©coute sur UDP/TCP 53
sudo ss -tulpn | grep ':53'

# Forcer la requÃªte vers votre DNS (bypasse /etc/resolv.conf)
dig m1.lab @10.10.10.2
```

Excellent ğŸ‘Œ â€” tu veux enrichir ton atelier DNS Bind existant avec une **Partie avancÃ©e cohÃ©rente**, pratique et rÃ©aliste.  
Voici la **version enrichie complÃ¨te** (prÃªte Ã  coller aprÃ¨s ton atelier existant `9.Le DNS Bind.md`), suivant exactement le mÃªme style pÃ©dagogique que tes autres labs :

---

# ğŸ§© Partie 2 â€” DNS Bind9 avancÃ© : zones inverses, alias, MX et administration Ã  chaud

## Objectifs

1. Ajouter une **zone inverse** pour les requÃªtes `PTR`.

2. CrÃ©er un **alias CNAME** pour un serveur web `www.lab`.

3. DÃ©clarer un **MX record** (serveur mail fictif avec Postfix).

4. Tester la **tolÃ©rance de panne** entre master et slave.

5. Utiliser **rndc** pour administrer Bind9 Ã  chaud.

6. Activer et observer les **logs de requÃªtes DNS**.

7. Simuler une **panne DNS** et observer le fallback `/etc/hosts`.

---

# DNS AvancÃ©

## ğŸ§± Ã‰tape 1 â€” Zone inverse (PTR) `10.10.10.in-addr.arpa`

### 1.1 â€” DÃ©clarer la zone inverse dans `/etc/bind/named.conf.local`

```bash
sudo nano /etc/bind/named.conf.local
```

Ajoute Ã  la fin :

```text
zone "10.10.10.in-addr.arpa" {
    type master;
    file "/etc/bind/db.10.10.10";
};
```

### 1.2 â€” CrÃ©er le fichier de zone inverse

```bash
sudo nano /etc/bind/db.10.10.10
```

Contenu :

```text
$TTL 604800
@   IN  SOA ns.lab. admin.lab. (
        2        ; Serial
        604800   ; Refresh
        86400    ; Retry
        2419200  ; Expire
        604800 ) ; Negative Cache TTL

; Serveur DNS autoritaire
@       IN  NS  ns.lab.

; Enregistrements PTR (rÃ©solution inverse)
1       IN  PTR  m1.lab.
2       IN  PTR  m2.lab.
```

### 1.3 â€” VÃ©rification

```bash
sudo named-checkzone 10.10.10.in-addr.arpa /etc/bind/db.10.10.10
sudo systemctl restart bind9
```

### 1.4 â€” Test de rÃ©solution inverse

Depuis Machine1 :

```bash
dig -x 10.10.10.2 @10.10.10.2
```

âœ… RÃ©sultat attendu :

```
;; ANSWER SECTION:
2.10.10.10.in-addr.arpa. IN PTR m2.lab.
```

---

## ğŸŒ Ã‰tape 2 â€” Alias CNAME : `www.lab` â†’ `m2.lab`

### 2.1 â€” Modifier la zone directe `/etc/bind/db.lab`

Ajoute Ã  la fin :

```text
www     IN  CNAME   m2.lab.
```

### 2.2 â€” VÃ©rification

```bash
sudo named-checkzone lab /etc/bind/db.lab
sudo systemctl restart bind9
```

### 2.3 â€” Test

```bash
dig www.lab @10.10.10.2
```

âœ… Attendu :

```
www.lab. 604800 IN CNAME m2.lab.
m2.lab.  604800 IN A 10.10.10.2
```

---

## ğŸ“§ Ã‰tape 3 â€” Enregistrement MX (serveur mail fictif)

### 3.1 â€” Installation Postfix sur Machine2 (fictive pour test)

```bash
sudo apt install -y postfix
sudo systemctl enable --now postfix
```

### 3.2 â€” Ajouter le MX dans la zone `/etc/bind/db.lab`

```text
lab.      IN  MX 10 mail.lab.
mail      IN  A  10.10.10.2
```

### 3.3 â€” VÃ©rification et test

```bash
sudo named-checkzone lab /etc/bind/db.lab
sudo systemctl restart bind9
dig lab MX @10.10.10.2
```

âœ… RÃ©sultat attendu :

```
lab. 604800 IN MX 10 mail.lab.
mail.lab. 604800 IN A 10.10.10.2
```

---

## âš™ï¸ Ã‰tape 4 â€” TolÃ©rance de panne : Slave DNS

### 4.1 â€” Sur Machine3 (slave)

Installe Bind9 :

```bash
sudo apt install -y bind9
```

### 4.2 â€” Fichier `/etc/bind/named.conf.local` (Machine3)

```text
zone "lab" {
    type slave;
    masters { 10.10.10.2; };
    file "/var/cache/bind/db.lab";
};

zone "10.10.10.in-addr.arpa" {
    type slave;
    masters { 10.10.10.2; };
    file "/var/cache/bind/db.10.10.10";
};
```

### 4.3 â€” Configurer le master (Machine2)

Dans `/etc/bind/named.conf.options`, ajoute :

```text
allow-transfer { 10.10.10.3; };
notify yes;
```

### 4.4 â€” RedÃ©marre les deux Bind

```bash
sudo systemctl restart bind9
```

### 4.5 â€” Test de failover

1. Sur Machine2 (master) :
   
   ```bash
   sudo systemctl stop bind9
   ```

2. Sur Machine1, teste avec le DNS slave :
   
   ```bash
   dig m2.lab @10.10.10.3
   ```

âœ… RÃ©sultat attendu : la rÃ©solution continue de fonctionner depuis le slave.

---

## ğŸ§© Ã‰tape 5 â€” Administration Ã  chaud avec `rndc`

### 5.1 â€” VÃ©rifier le statut de Bind9

```bash
sudo rndc status
```

### 5.2 â€” Recharger une zone sans redÃ©marrer le service

```bash
sudo rndc reload lab
```

### 5.3 â€” GÃ©nÃ©rer un dump de la base en mÃ©moire

```bash
sudo rndc dumpdb -zones
sudo cat /var/cache/bind/named_dump.db | grep lab
```

---

## ğŸ” Ã‰tape 6 â€” Activer la journalisation des requÃªtes DNS

### 6.1 â€” Modifier `/etc/bind/named.conf.options`

Sous la section `options { ... }`, ajoute :

```text
querylog yes;
```

Puis redÃ©marre :

```bash
sudo systemctl restart bind9
```

### 6.2 â€” Observer les requÃªtes entrantes

```bash
sudo tail -f /var/log/syslog | grep query:
```

Exemple de sortie :

```
client @0x7f... query: m1.lab IN A + (10.10.10.1)
```

---

## ğŸ©º Ã‰tape 7 â€” Suivi en temps rÃ©el avec `journalctl`

```bash
sudo journalctl -fu bind9
```

Tu verras les rechargements, requÃªtes, transferts de zone et erreurs en direct.

---

## ğŸ’£ Ã‰tape 8 â€” Simulation de panne DNS et bascule `/etc/hosts`

### 8.1 â€” Couper le DNS

```bash
sudo systemctl stop bind9
sudo ss -tulpn | grep :53
```

â†’ rien ne doit Ã©couter sur le port 53.

### 8.2 â€” Activer un fallback local

Ã‰dite `/etc/hosts` sur Machine1 :

```text
10.10.10.2   m2.lab www.lab mail.lab
```

### 8.3 â€” Test

```bash
ping -c 2 www.lab
```

âœ… Le nom est toujours rÃ©solu (grÃ¢ce Ã  `/etc/hosts`), mÃªme si le DNS est HS.

---

## âœ… RÃ©sumÃ© de la partie avancÃ©e

| ThÃ¨me        | RÃ©sultat attendu                               |
| ------------ | ---------------------------------------------- |
| Zone inverse | RÃ©solution PTR OK                              |
| Alias CNAME  | [www.lab](http://www.lab) â†’ m2.lab fonctionnel |
| MX record    | mail.lab (Postfix) enregistrÃ©                  |
| Failover     | Slave DNS prend le relais                      |
| rndc         | Administration Ã  chaud sans restart            |
| querylog     | RequÃªtes visibles en temps rÃ©el                |
| journalctl   | Logs continus de Bind9                         |
| Fallback     | `/etc/hosts` compense la panne DNS             |
