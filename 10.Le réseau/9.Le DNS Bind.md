# Exercice 9 — Résolution de noms : `/etc/hosts` ➜ Bind9 (domaine `lab`)

## Contexte de lab

- **Machine1 (client)** : `10.10.10.1`

- **Machine2 (DNS serveur)** : `10.10.10.2`

- Domaine local choisi : **`lab`** (⚠️ **pas** `.local`, réservé mDNS)

---

## Étape A — Démo rapide avec `/etc/hosts`

### A.1 — Ajouter des entrées (sur **les deux** machines)

créer/éditer le fichier : `/etc/hosts`

contenu à ajouter en bas :

```text
10.10.10.1   m1.lab m1
10.10.10.2   m2.lab m2
```

### A.2 — Test simple

```bash
# Depuis Machine1 vers Machine2
ping -c 3 m2.lab

# Depuis Machine2 vers Machine1
ping -c 3 m1.lab

# Vérifier la résolution via la libc (nsswitch)
getent hosts m2.lab
getent hosts m1.lab
```

💡 Remarque : `ping` et `getent` consultent **/etc/hosts** avant DNS ;  
`dig`, lui, interroge **directement** un serveur DNS (on le verra plus bas).

---

## Étape B — Installation & préparation de Bind9 (Machine2)

### B.1 — Installer Bind9 et ses utilitaires

```bash
# Installer le serveur DNS et les outils de vérification
sudo apt update
sudo apt install -y bind9 bind9utils
```

### B.2 — Vérifier le service

```bash
# Statut du service
systemctl status bind9

# Voir l'écoute sur le port 53
sudo ss -tulpn | grep ':53'
```

---

## Étape C — Déclaration de la zone `lab` (Machine2)

### C.1 — Déclarer la zone dans Bind9

créer/éditer le fichier : `/etc/bind/named.conf.local`

contenu (ajouter **exactement** ceci) :

```text
zone "lab" {
    type master;
    file "/etc/bind/db.lab";
};
```

### C.2 — Créer le fichier de zone

créer le fichier : `/etc/bind/db.lab`

contenu du fichier :

```text
$TTL    604800
@       IN      SOA     ns.lab. admin.lab. (
                         1         ; Serial (incrémentez à chaque modification)
                         604800    ; Refresh
                         86400     ; Retry
                         2419200   ; Expire
                         604800 )  ; Negative Cache TTL

; Serveur DNS faisant autorité pour "lab"
@       IN      NS      ns.lab.

; Enregistrements A de la zone
ns      IN      A       10.10.10.2
m1      IN      A       10.10.10.1
m2      IN      A       10.10.10.2
```

Notes importantes :

- `ns.lab.` **avec un point final** (= FQDN complet).

- `m1` et `m2` sont **des noms relatifs** à la zone `lab` → ils deviendront `m1.lab.` et `m2.lab.`.

### C.3 — Vérifier la configuration avant redémarrage

```bash
# Vérifie la syntaxe globale
sudo named-checkconf

# Vérifie la zone "lab" spécifiquement
sudo named-checkzone lab /etc/bind/db.lab
```

Attendu : `OK` sans erreurs.

### C.4 — Redémarrer Bind9

```bash
sudo systemctl restart bind9
sudo systemctl status bind9
```

---

## Étape D — Pointer le client vers **votre** DNS (Machine1)

### D.1 — Utiliser le DNS de Machine2

créer/éditer le fichier : `/etc/resolv.conf`

contenu minimal pour le test :

```text
nameserver 10.10.10.2
```

💡 Si un gestionnaire (NetworkManager/systemd-resolved) réécrit ce fichier, c’est **normal** en production ; pour le lab, on garde ce réglage simple. (On peut rendre ça persistant plus tard.)

---

## Étape E — Tests `dig` + explications

### E.1 — Requête A pour m1.lab (Machine1 ➜ Machine2)

```bash
dig m1.lab @10.10.10.2
```

Ce qu’on doit voir (explications) :

- `SERVER: 10.10.10.2#53` → vous interrogez bien **votre Bind9**.

- `status: NOERROR` → la zone contient le nom, pas d’erreur.

- `ANSWER SECTION:` avec une ligne du type :
  
  ```
  m1.lab.   604800  IN  A  10.10.10.1
  ```
  
  - `m1.lab.` : nom demandé
  
  - `604800` : TTL (en secondes)
  
  - `A` : type d’enregistrement (IPv4)
  
  - `10.10.10.1` : adresse renvoyée

### E.2 — Requête A pour m2.lab

```bash
dig m2.lab @10.10.10.2
```

Attendu dans `ANSWER SECTION` :

```
m2.lab.   604800  IN  A  10.10.10.2
```

### E.3 — Comparaison avec votre sortie précédente (NXDOMAIN)

Vos sorties montraient :

```
status: NXDOMAIN
```

👉 Cela arrive quand :

- La **zone n’était pas déclarée** dans `named.conf.local`, **ou**

- Le **fichier `/etc/bind/db.lab` était vide** ou mal référencé, **ou**

- Bind9 n’avait pas été redémarré après vos changements.

Après nos corrections (zone déclarée + fichier de zone rempli + restart), vous devez obtenir **NOERROR** + **ANSWER SECTION**.

---

## Étape F —Tests supplémentaires utiles

### F.1 — Sortie condensée

```bash
dig +short m1.lab @10.10.10.2
dig +short m2.lab @10.10.10.2
```

Attendu : juste les IP, plus lisible dans des scripts.

### F.2 — Ping par nom (maintenant via DNS)

```bash
ping -c 3 m2.lab
```

### F.3 — Dépannage rapide si ça coince

```bash
# Voir les logs de Bind9 (erreurs de zone, etc.)
journalctl -u bind9 --no-pager -e

# Vérifier l'écoute sur UDP/TCP 53
sudo ss -tulpn | grep ':53'

# Forcer la requête vers votre DNS (bypasse /etc/resolv.conf)
dig m1.lab @10.10.10.2
```

Excellent 👌 — tu veux enrichir ton atelier DNS Bind existant avec une **Partie avancée cohérente**, pratique et réaliste.  
Voici la **version enrichie complète** (prête à coller après ton atelier existant `9.Le DNS Bind.md`), suivant exactement le même style pédagogique que tes autres labs :

---

# 🧩 Partie 2 — DNS Bind9 avancé : zones inverses, alias, MX et administration à chaud

## Objectifs

1. Ajouter une **zone inverse** pour les requêtes `PTR`.

2. Créer un **alias CNAME** pour un serveur web `www.lab`.

3. Déclarer un **MX record** (serveur mail fictif avec Postfix).

4. Tester la **tolérance de panne** entre master et slave.

5. Utiliser **rndc** pour administrer Bind9 à chaud.

6. Activer et observer les **logs de requêtes DNS**.

7. Simuler une **panne DNS** et observer le fallback `/etc/hosts`.

---

# DNS Avancé

## 🧱 Étape 1 — Zone inverse (PTR) `10.10.10.in-addr.arpa`

### 1.1 — Déclarer la zone inverse dans `/etc/bind/named.conf.local`

```bash
sudo nano /etc/bind/named.conf.local
```

Ajoute à la fin :

```text
zone "10.10.10.in-addr.arpa" {
    type master;
    file "/etc/bind/db.10.10.10";
};
```

### 1.2 — Créer le fichier de zone inverse

```bash
sudo nano /etc/bind/db.10.10.10
```

Contenu :

```text
$TTL 604800
@   IN  SOA ns.lab. admin.lab. (
        2        ; Serial
        604800   ; Refresh
        86400    ; Retry
        2419200  ; Expire
        604800 ) ; Negative Cache TTL

; Serveur DNS autoritaire
@       IN  NS  ns.lab.

; Enregistrements PTR (résolution inverse)
1       IN  PTR  m1.lab.
2       IN  PTR  m2.lab.
```

### 1.3 — Vérification

```bash
sudo named-checkzone 10.10.10.in-addr.arpa /etc/bind/db.10.10.10
sudo systemctl restart bind9
```

### 1.4 — Test de résolution inverse

Depuis Machine1 :

```bash
dig -x 10.10.10.2 @10.10.10.2
```

✅ Résultat attendu :

```
;; ANSWER SECTION:
2.10.10.10.in-addr.arpa. IN PTR m2.lab.
```

---

## 🌐 Étape 2 — Alias CNAME : `www.lab` → `m2.lab`

### 2.1 — Modifier la zone directe `/etc/bind/db.lab`

Ajoute à la fin :

```text
www     IN  CNAME   m2.lab.
```

### 2.2 — Vérification

```bash
sudo named-checkzone lab /etc/bind/db.lab
sudo systemctl restart bind9
```

### 2.3 — Test

```bash
dig www.lab @10.10.10.2
```

✅ Attendu :

```
www.lab. 604800 IN CNAME m2.lab.
m2.lab.  604800 IN A 10.10.10.2
```

---

## 📧 Étape 3 — Enregistrement MX (serveur mail fictif)

### 3.1 — Installation Postfix sur Machine2 (fictive pour test)

```bash
sudo apt install -y postfix
sudo systemctl enable --now postfix
```

### 3.2 — Ajouter le MX dans la zone `/etc/bind/db.lab`

```text
lab.      IN  MX 10 mail.lab.
mail      IN  A  10.10.10.2
```

### 3.3 — Vérification et test

```bash
sudo named-checkzone lab /etc/bind/db.lab
sudo systemctl restart bind9
dig lab MX @10.10.10.2
```

✅ Résultat attendu :

```
lab. 604800 IN MX 10 mail.lab.
mail.lab. 604800 IN A 10.10.10.2
```

---

## ⚙️ Étape 4 — Tolérance de panne : Slave DNS

### 4.1 — Sur Machine3 (slave)

Installe Bind9 :

```bash
sudo apt install -y bind9
```

### 4.2 — Fichier `/etc/bind/named.conf.local` (Machine3)

```text
zone "lab" {
    type slave;
    masters { 10.10.10.2; };
    file "/var/cache/bind/db.lab";
};

zone "10.10.10.in-addr.arpa" {
    type slave;
    masters { 10.10.10.2; };
    file "/var/cache/bind/db.10.10.10";
};
```

### 4.3 — Configurer le master (Machine2)

Dans `/etc/bind/named.conf.options`, ajoute :

```text
allow-transfer { 10.10.10.3; };
notify yes;
```

### 4.4 — Redémarre les deux Bind

```bash
sudo systemctl restart bind9
```

### 4.5 — Test de failover

1. Sur Machine2 (master) :
   
   ```bash
   sudo systemctl stop bind9
   ```

2. Sur Machine1, teste avec le DNS slave :
   
   ```bash
   dig m2.lab @10.10.10.3
   ```

✅ Résultat attendu : la résolution continue de fonctionner depuis le slave.

---

## 🧩 Étape 5 — Administration à chaud avec `rndc`

### 5.1 — Vérifier le statut de Bind9

```bash
sudo rndc status
```

### 5.2 — Recharger une zone sans redémarrer le service

```bash
sudo rndc reload lab
```

### 5.3 — Générer un dump de la base en mémoire

```bash
sudo rndc dumpdb -zones
sudo cat /var/cache/bind/named_dump.db | grep lab
```

---

## 🔎 Étape 6 — Activer la journalisation des requêtes DNS

### 6.1 — Modifier `/etc/bind/named.conf.options`

Sous la section `options { ... }`, ajoute :

```text
querylog yes;
```

Puis redémarre :

```bash
sudo systemctl restart bind9
```

### 6.2 — Observer les requêtes entrantes

```bash
sudo tail -f /var/log/syslog | grep query:
```

Exemple de sortie :

```
client @0x7f... query: m1.lab IN A + (10.10.10.1)
```

---

## 🩺 Étape 7 — Suivi en temps réel avec `journalctl`

```bash
sudo journalctl -fu bind9
```

Tu verras les rechargements, requêtes, transferts de zone et erreurs en direct.

---

## 💣 Étape 8 — Simulation de panne DNS et bascule `/etc/hosts`

### 8.1 — Couper le DNS

```bash
sudo systemctl stop bind9
sudo ss -tulpn | grep :53
```

→ rien ne doit écouter sur le port 53.

### 8.2 — Activer un fallback local

Édite `/etc/hosts` sur Machine1 :

```text
10.10.10.2   m2.lab www.lab mail.lab
```

### 8.3 — Test

```bash
ping -c 2 www.lab
```

✅ Le nom est toujours résolu (grâce à `/etc/hosts`), même si le DNS est HS.

---

## ✅ Résumé de la partie avancée

| Thème        | Résultat attendu                               |
| ------------ | ---------------------------------------------- |
| Zone inverse | Résolution PTR OK                              |
| Alias CNAME  | [www.lab](http://www.lab) → m2.lab fonctionnel |
| MX record    | mail.lab (Postfix) enregistré                  |
| Failover     | Slave DNS prend le relais                      |
| rndc         | Administration à chaud sans restart            |
| querylog     | Requêtes visibles en temps réel                |
| journalctl   | Logs continus de Bind9                         |
| Fallback     | `/etc/hosts` compense la panne DNS             |
