T

# Atelier : Simulation d’un réseau DMZ

## 1. Contexte & Objectif

Dans un environnement réel, une **DMZ (Demilitarized Zone)** est une zone réseau intermédiaire entre un réseau interne (LAN) et l’Internet.  


L’objectif de cet atelier est de **transformer `machine1` en pare-feu Linux** disposant de trois zones :

- **WAN (Internet simulé via enp0s3 – ne pas toucher à la config, conserve la connectivité)**

- **DMZ (interface enp0s8, réseau 10.10.10.0/24)** hébergeant un serveur web exposé

- **LAN (interface enp0s9, réseau 192.168.50.0/24)** réservé aux clients internes

`machine2` sera utilisée comme **client interne LAN** et pourra tester l’accès contrôlé à la DMZ et à Internet.

---

## 2. Préparation du terrain

### a) Matériel & Réseau VBox

- **machine1 (pare-feu/DMZ)** :
  
  - `enp0s3` : NAT (192.168.1.x) → accès Internet (à ne pas modifier)
  
  - `enp0s8` : Réseau interne (10.10.10.1/24) → DMZ
  
  - `enp0s9` : Réseau interne (192.168.50.1/24) → LAN

- **machine2 (client interne LAN)** :
  
  - `enp0s3` : Réseau interne (192.168.50.2/24) → LAN

### b) Logiciels nécessaires

Sur `machine1` :

```bash
sudo apt update
sudo apt install -y nginx iptables-persistent
```

- `nginx` : service exposé dans la DMZ

- `iptables-persistent` : pour sauvegarder et restaurer les règles du pare-feu

Sur `machine2` :

```bash
sudo apt update
sudo apt install -y curl
```

- `curl` : pour tester l’accès aux services

---

## 3. Démarche de l’exercice

### Étape 1 : Configurer les interfaces réseau

Sur `machine1` :

```bash
# Interface DMZ
sudo ip addr add 10.10.10.1/24 dev enp0s8
sudo ip link set enp0s8 up

# Interface LAN
sudo ip addr add 192.168.50.1/24 dev enp0s9
sudo ip link set enp0s9 up
```

Sur `machine2` :

```bash
sudo ip addr add 192.168.50.2/24 dev enp0s3
sudo ip link set enp0s3 up
sudo ip route add default via 192.168.50.1
```

### Étape 2 : Déployer le service dans la DMZ

Sur `machine1` :

```bash
echo "<h1>Bienvenue dans la DMZ</h1>" | sudo tee /var/www/html/index.html
sudo systemctl enable --now nginx
```

Vérification :

```bash
curl http://10.10.10.1
```

### Étape 3 : Activer le routage IP

Sur `machine1` :

```bash
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
```

(Rendre permanent dans `/etc/sysctl.conf` → `net.ipv4.ip_forward=1`)

### Étape 4 : Configurer le pare-feu (iptables)

Sur `machine1` :

1. **Politique par défaut restrictive**

```bash
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT
```

2. **Autoriser SSH depuis LAN pour administration**

```bash
sudo iptables -A INPUT -i enp0s9 -p tcp --dport 22 -j ACCEPT
```

3. **Autoriser accès Web vers DMZ depuis WAN et LAN**

```bash
sudo iptables -A FORWARD -i enp0s3 -o enp0s8 -p tcp --dport 80 -j ACCEPT
sudo iptables -A FORWARD -i enp0s9 -o enp0s8 -p tcp --dport 80 -j ACCEPT
```

4. **Autoriser retour des connexions établies**

```bash
sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
```

5. **NAT pour donner Internet au LAN interne**

```bash
sudo iptables -t nat -A POSTROUTING -s 192.168.50.0/24 -o enp0s3 -j MASQUERADE
```

Sauvegarde :

```bash
sudo netfilter-persistent save
```

### Étape 5 : Tests

- Depuis `machine2` (LAN) :

```bash
# Test accès DMZ
curl http://10.10.10.1

# Test accès Internet via NAT
curl http://example.com
```

- Depuis un PC externe (si VBox NAT + port forwarding configuré) :  
  Tester `http://[IPpubliqueMachine1]:80` → accès au serveur DMZ.

---

## 4. Nettoyage

Sur `machine1` :

```bash
sudo apt remove --purge -y nginx iptables-persistent
sudo iptables -F
sudo iptables -t nat -F
sudo iptables -X
sudo iptables -P INPUT ACCEPT
sudo iptables -P FORWARD ACCEPT
```

Sur `machine2` :

```bash
sudo apt remove --purge -y curl
sudo ip addr flush dev enp0s3
```

Optionnel : retirer l’interface `enp0s9` depuis VBox si elle ne sera plus utilisée.


