

 Atelier : Mise en place d‚Äôun VPN WireGuard entre deux machines Debian

---

## Objectifs

- Comprendre le r√¥le d‚Äôun VPN : cr√©er un **tunnel chiffr√©** entre deux r√©seaux.

- Mettre en place un **VPN site-√†-site simple** entre vos deux VM Debian locales (Machine1 et Machine2).

- (Optionnel) √âtendre avec une machine Debian sur AWS pour tester un **VPN vers le cloud**.

- V√©rifier la communication via le tunnel.

- Nettoyer et restaurer l‚Äô√©tat initial.

---

## Pr√©paration

Sur **les deux machines Debian** (et la VM AWS si utilis√©e) :

```bash
sudo apt update
sudo apt install wireguard -y
```

Cr√©er un dossier pour les cl√©s :

```bash
mkdir -p ~/wgkeys && cd ~/wgkeys
```

---

## G√©n√©ration des cl√©s

Chaque machine doit avoir une **paire de cl√©s priv√©e/publique**.

Exemple sur Machine1 :

```bash
wg genkey | tee privatekey | wg pubkey > publickey
```

- `privatekey` = cl√© priv√©e (garder secr√®te).

- `publickey` = cl√© publique (√† √©changer avec l‚Äôautre machine).

üëâ Faites la m√™me chose sur Machine2 et (optionnellement) sur AWS.

---

## Choix des interfaces

- On utilise `enp0s8` (r√©seau interne VirtualBox, d√©j√† configur√© en 10.10.10.x).

- On cr√©e une interface VPN virtuelle `wg0`.

- Chaque machine aura une **IP VPN d√©di√©e** dans un sous-r√©seau distinct, par ex : `192.168.100.0/24`.

---

## Configuration WireGuard

### Machine1

Fichier `/etc/wireguard/wg0.conf` :

```ini
[Interface]
PrivateKey = (cl√© priv√©e Machine1)
Address = 192.168.100.1/24
ListenPort = 51820

[Peer]
PublicKey = (cl√© publique Machine2)
AllowedIPs = 192.168.100.2/32
Endpoint = 10.10.10.2:51820
```

---

### Machine2

Fichier `/etc/wireguard/wg0.conf` :

```ini
[Interface]
PrivateKey = (cl√© priv√©e Machine2)
Address = 192.168.100.2/24
ListenPort = 51820

[Peer]
PublicKey = (cl√© publique Machine1)
AllowedIPs = 192.168.100.1/32
Endpoint = 10.10.10.1:51820
```

üëâ Remarques :

- On utilise les IP de `enp0s8` (10.10.10.x) comme **canal de transport**.

- Le VPN cr√©e un nouveau r√©seau priv√© `192.168.100.0/24`.

---

## D√©marrage du VPN

Sur chaque machine :

```bash
sudo wg-quick up wg0
```

V√©rifier :

```bash
sudo wg show
```

---

## Tests de connectivit√©

Depuis Machine1 :

```bash
ping -c 3 192.168.100.2
```

‚úÖ Doit r√©pondre ‚Üí tunnel VPN fonctionnel.

Depuis Machine2 :

```bash
ping -c 3 192.168.100.1
```

‚úÖ Doit r√©pondre.

---

## (Optionnel) Extension vers AWS

- Cr√©ez une VM Debian sur AWS (Elastic IP publique).

- Configurez `wg0` sur la VM AWS avec une IP `192.168.100.3/24`.

- Modifiez les fichiers `wg0.conf` de Machine1/Machine2 pour ajouter un **nouveau Peer** pointant vers l‚ÄôIP publique AWS.

- Testez la connectivit√© VPN locale ‚Üî AWS.

---

## Nettoyage (rollback)

Pour d√©sactiver le VPN :

```bash
sudo wg-quick down wg0
```

Supprimer les configs si besoin :

```bash
sudo rm -f /etc/wireguard/wg0.conf
sudo rm -rf ~/wgkeys
```

V√©rifier que les machines sont revenues √† leur √©tat initial :

```bash
ip a
```

‚úÖ Seules `lo`, `enp0s3`, `enp0s8` doivent rester.

---


