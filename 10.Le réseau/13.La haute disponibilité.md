

# Atelier â€“ VRRP avec keepalived

## 1. Contexte & objectif

Lâ€™objectif de cet atelier est de **mettre en place la haute disponibilitÃ© (HA)** en configurant **keepalived** sur deux machines Debian 



- En cas de panne du **serveur maÃ®tre**, le **serveur backup** prend automatiquement le relais et continue de rÃ©pondre Ã  lâ€™adresse IP virtuelle.

- Le protocole utilisÃ© est **VRRP (Virtual Router Redundancy Protocol)**.

ðŸ‘‰ Ã€ la fin, vous aurez un service rÃ©seau capable de **tolÃ©rer la panne dâ€™une machine** sans interruption pour le client.

---

## 2. PrÃ©paration du terrain

### 2.1. Topologie

- Deux machines Debian (machine1 & machine2) reliÃ©es via le rÃ©seau interne **10.10.10.0/24**.

- Interfaces utilisÃ©es pour VRRP : `enp0s8`.

- Adresse IP virtuelle choisie : **10.10.10.100**.

```
machine1 (MASTER)    : 10.10.10.1
machine2 (BACKUP)    : 10.10.10.2
VIP (flottante VRRP) : 10.10.10.100
```

### 2.2. Installation de keepalived

Sur **les deux machines** :

```bash
sudo apt update
sudo apt install -y keepalived
```

VÃ©rifiez :

```bash
keepalived --version
```

Doit afficher une version > 2.x.

### 2.3. PrÃ©parer un service de test

Sur chaque machine, installez **nginx** comme service Ã  surveiller :

```bash
sudo apt install -y nginx
```

- `machine1` : page dâ€™accueil `/var/www/html/index.html` â†’ Ã©crire **"Serveur MASTER"**

- `machine2` : page dâ€™accueil `/var/www/html/index.html` â†’ Ã©crire **"Serveur BACKUP"**

Cela permettra de tester le basculement (failover).

---

## 3. DÃ©roulement de lâ€™exercice (Ã©tapes progressives)

### Ã‰tape 1 â€“ Configuration du MASTER (machine1)

CrÃ©er le fichier `/etc/keepalived/keepalived.conf` :

```bash
sudo nano /etc/keepalived/keepalived.conf
```

Contenu :

```bash
vrrp_instance VI_1 {
    state MASTER                # rÃ´le principal
    interface enp0s8            # interface rÃ©seau VRRP
    virtual_router_id 51        # ID unique partagÃ©
    priority 200                # prioritÃ© Ã©levÃ©e (MASTER > BACKUP)
    advert_int 1                # intervalle dâ€™annonce en secondes
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
}
```

RedÃ©marrer le service :

```bash
sudo systemctl enable keepalived --now
```

VÃ©rifier :

```bash
ip a show enp0s8
```

ðŸ‘‰ Lâ€™adresse `10.10.10.100` doit apparaÃ®tre sur machine1.

---

### Ã‰tape 2 â€“ Configuration du BACKUP (machine2)

Ã‰diter `/etc/keepalived/keepalived.conf` :

```bash
vrrp_instance VI_1 {
    state BACKUP
    interface enp0s8
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
}
```

Activer le service :

```bash
sudo systemctl enable keepalived --now
```

VÃ©rifier :

```bash
ip a show enp0s8
```

ðŸ‘‰ Lâ€™adresse `10.10.10.100` ne doit PAS apparaÃ®tre ici (car câ€™est le MASTER qui la dÃ©tient).

---

### Ã‰tape 3 â€“ Test de haute disponibilitÃ©

1. Depuis une machine cliente (ou depuis `machine2`) :

```bash
curl http://10.10.10.100
```

ðŸ‘‰ La page doit afficher **Serveur MASTER**.

2. Simuler une panne sur le MASTER (`machine1`) :

```bash
sudo systemctl stop keepalived
```

3. VÃ©rifier cÃ´tÃ© BACKUP (`machine2`) :

```bash
ip a show enp0s8
```

ðŸ‘‰ Lâ€™adresse **10.10.10.100** doit maintenant apparaÃ®tre.

4. Tester Ã  nouveau :

```bash
curl http://10.10.10.100
```

ðŸ‘‰ La page doit afficher **Serveur BACKUP**.

5. Relancer keepalived sur `machine1` et observer le retour de la VIP.

---

### Ã‰tape 4 â€“ Ajout de suivi de service (optionnel)

On peut faire en sorte que keepalived ne garde le rÃ´le MASTER que si nginx fonctionne.

Modifier `/etc/keepalived/keepalived.conf` sur le MASTER :

```bash
vrrp_script chk_nginx {
    script "pidof nginx"
    interval 2
    weight -20
}

vrrp_instance VI_1 {
    state MASTER
    interface enp0s8
    virtual_router_id 51
    priority 200
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
    track_script {
        chk_nginx
    }
}
```

ðŸ‘‰ Si nginx tombe, la prioritÃ© baisse et le BACKUP prend le relais.

---

## 4. Nettoyage

Une fois la dÃ©mo terminÃ©e :

```bash
# ArrÃªt des services keepalived
sudo systemctl stop keepalived
sudo apt remove --purge -y keepalived
sudo rm -rf /etc/keepalived

# Suppression du service de test
sudo apt remove --purge -y nginx
sudo rm -rf /var/www/html/*
```

VÃ©rifier quâ€™il ne reste plus dâ€™adresse VIP :

```bash
ip a show enp0s8
```




