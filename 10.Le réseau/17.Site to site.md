

# Atelier : VPN IPSec site-to-site avec strongSwan

---

## 1. Contexte & objectif

Vous disposez de deux machines Debian (VBox) :

- **Machine1** : `10.10.10.1` (r√©seau interne `enp0s8`)

- **Machine2** : `10.10.10.2` (r√©seau interne `enp0s8`)

Elles sont d√©j√† dans le m√™me r√©seau interne.  
L‚Äôobjectif de cet atelier est de **chiffrer tout le trafic entre les deux machines** via un tunnel VPN **IPSec** configur√© avec **strongSwan**.

√Ä la fin, les communications ICMP/SSH entre `10.10.10.1` et `10.10.10.2` passeront dans un tunnel IPSec s√©curis√©.

---

## 2. Pr√©paration du terrain

### Paquets n√©cessaires

Sur **les deux machines** :

```bash
sudo apt update
sudo apt install -y strongswan strongswan-pki libcharon-extra-plugins
```

### R√©pertoires et certificats

Pour g√©n√©rer et stocker les certificats :

```bash
mkdir -p ~/pki/{cacerts,certs,private}
chmod 700 ~/pki
```

Nous allons cr√©er une **autorit√© de certification locale** et deux certificats (un pour chaque machine).

### G√©n√©ration de l‚ÄôAC (sur Machine1 uniquement)

```bash
ipsec pki --gen --outform pem > ~/pki/private/ca-key.pem
ipsec pki --self --ca --lifetime 3650 \
    --in ~/pki/private/ca-key.pem \
    --type rsa --dn "CN=VPN-CA" \
    --outform pem > ~/pki/cacerts/ca-cert.pem
```

Copier le certificat `ca-cert.pem` vers **Machine2** :

```bash
scp ~/pki/cacerts/ca-cert.pem user@10.10.10.2:/home/user/
```

### G√©n√©ration des cl√©s et certificats serveurs

Sur **Machine1** :

```bash
ipsec pki --gen --outform pem > ~/pki/private/machine1-key.pem
ipsec pki --pub --in ~/pki/private/machine1-key.pem --type rsa | \
  ipsec pki --issue --lifetime 1825 \
    --cacert ~/pki/cacerts/ca-cert.pem \
    --cakey ~/pki/private/ca-key.pem \
    --dn "CN=10.10.10.1" --san "10.10.10.1" \
    --flag serverAuth --flag ikeIntermediate \
    --outform pem > ~/pki/certs/machine1-cert.pem
```

Sur **Machine2** (m√™me logique) :

```bash
ipsec pki --gen --outform pem > ~/pki/private/machine2-key.pem
ipsec pki --pub --in ~/pki/private/machine2-key.pem --type rsa | \
  ipsec pki --issue --lifetime 1825 \
    --cacert ~/ca-cert.pem \
    --cakey ~/pki/private/ca-key.pem \
    --dn "CN=10.10.10.2" --san "10.10.10.2" \
    --flag serverAuth --flag ikeIntermediate \
    --outform pem > ~/pki/certs/machine2-cert.pem
```

Chaque machine doit avoir :

- sa **cl√© priv√©e** dans `/etc/ipsec.d/private/`

- son **certificat** dans `/etc/ipsec.d/certs/`

- la **CA** dans `/etc/ipsec.d/cacerts/`

Copie et mise en place :

```bash
sudo cp ~/pki/private/*.pem /etc/ipsec.d/private/
sudo cp ~/pki/certs/*.pem /etc/ipsec.d/certs/
sudo cp ~/pki/cacerts/*.pem /etc/ipsec.d/cacerts/
```

---

## 3. D√©marche (√âtapes logiques)

### √âtape 1 ‚Äì Configuration strongSwan

√âditer `/etc/ipsec.conf` sur **Machine1** :

```
config setup
    charondebug="ike 2, knl 2, cfg 2"

conn net-to-net
    left=10.10.10.1
    leftcert=machine1-cert.pem
    leftid="10.10.10.1"
    right=10.10.10.2
    rightid="10.10.10.2"
    rightcert=machine2-cert.pem
    auto=start
    keyexchange=ikev2
    authby=rsasig
```

√âditer `/etc/ipsec.conf` sur **Machine2** :

```
config setup
    charondebug="ike 2, knl 2, cfg 2"

conn net-to-net
    left=10.10.10.2
    leftcert=machine2-cert.pem
    leftid="10.10.10.2"
    right=10.10.10.1
    rightid="10.10.10.1"
    rightcert=machine1-cert.pem
    auto=start
    keyexchange=ikev2
    authby=rsasig
```

### √âtape 2 ‚Äì Activer et tester

Red√©marrer le service sur les deux machines :

```bash
sudo systemctl restart strongswan
sudo systemctl enable strongswan
```

V√©rifier l‚Äô√©tat du tunnel :

```bash
sudo ipsec statusall
```

### √âtape 3 ‚Äì V√©rification du trafic chiffr√©

Sur **Machine1** :

```bash
ping -c 3 10.10.10.2
```

Sur **Machine2** :

```bash
ping -c 3 10.10.10.1
```

Observer avec `tcpdump` sur enp0s8 :

```bash
sudo tcpdump -i enp0s8 esp
```

Vous devriez voir du trafic **ESP** (chiffr√©).

---

## 4. Nettoyage

Si vous souhaitez supprimer le lab :

```bash
sudo systemctl stop strongswan
sudo apt purge -y strongswan strongswan-pki libcharon-extra-plugins
sudo rm -rf /etc/ipsec.d/* ~/pki
```

---

üîë **R√©sultat attendu :**  
Le tunnel IPSec est mont√© automatiquement au d√©marrage, et tout le trafic entre `10.10.10.1` et `10.10.10.2` est encapsul√© dans ESP (v√©rifiable avec tcpdump).


