

# Atelier : Mise en place d’un Syslog centralisé réseau

## 1. Contexte & objectif

Dans une infrastructure réelle, il est essentiel de **centraliser les journaux** système et applicatifs afin de :

- Avoir une vision unifiée des événements.

- Détecter plus rapidement les anomalies.

- Sécuriser les logs en évitant leur suppression locale par un attaquant.

Dans cet atelier, vous allez :

- Transformer `machine1` en **serveur Syslog central** (rsyslog).

- Configurer `machine2` comme **client Syslog** qui enverra ses logs à `machine1`.

- Vérifier en temps réel la réception et la classification des logs.

---

## 2. Préparation du terrain

### Prérequis

- 2 machines Debian reliées par le réseau interne `10.10.10.0/24`.
  
  - `machine1` : 10.10.10.1 (serveur Syslog).
  
  - `machine2` : 10.10.10.2 (client Syslog).

### Paquets nécessaires

Sur **les deux machines** :

```bash
sudo apt update
sudo apt install -y rsyslog
```

Vérifiez que `rsyslog` est activé et fonctionne :

```bash
systemctl status rsyslog
```

---

## 3. Démarche progressive

### Étape 1 – Activer le serveur Syslog sur machine1

1. Ouvrir le fichier de configuration principale :
   
   ```bash
   sudo nano /etc/rsyslog.conf
   ```

2. Décommentez ou ajoutez ces lignes pour autoriser la réception réseau :
   
   ```conf
   # Activer réception UDP
   module(load="imudp")
   input(type="imudp" port="514")
   
   # Activer réception TCP
   module(load="imtcp")
   input(type="imtcp" port="514")
   ```

3. Sauvegardez et redémarrez rsyslog :
   
   ```bash
   sudo systemctl restart rsyslog
   ```

4. Vérifiez que le port est bien ouvert :
   
   ```bash
   sudo ss -tulpn | grep 514
   ```

---

### Étape 2 – Configurer le client Syslog sur machine2

1. Éditer la configuration de rsyslog :
   
   ```bash
   sudo nano /etc/rsyslog.conf
   ```

2. Ajoutez une règle pour envoyer tous les logs vers `machine1` :
   
   ```conf
   *.*   @10.10.10.1:514        # envoi UDP
   # ou
   *.*   @@10.10.10.1:514       # envoi TCP (double @)
   ```

3. Sauvegardez et redémarrez rsyslog :
   
   ```bash
   sudo systemctl restart rsyslog
   ```

---

### Étape 3 – Vérifier la centralisation

1. Sur `machine2`, générez un message de log :
   
   ```bash
   logger "Test log depuis machine2"
   ```

2. Sur `machine1`, vérifiez l’arrivée du message dans les fichiers de logs :
   
   ```bash
   sudo tail -f /var/log/syslog
   ```
   
   Vous devez voir :
   
   ```
   Oct  2 22:45 machine2 Test log depuis machine2
   ```

---

### Étape 4 – Organisation des logs par hôte

Pour mieux séparer les logs, configurez `machine1` :

1. Créez un fichier de configuration dédié :
   
   ```bash
   sudo nano /etc/rsyslog.d/remote.conf
   ```

2. Ajoutez :
   
   ```conf
   # Stocker les logs entrants par machine
   if ($fromhost-ip != "") then {
      action(type="omfile" file="/var/log/remote/%HOSTNAME%.log")
      stop
   }
   ```

3. Créez le dossier et redémarrez :
   
   ```bash
   sudo mkdir -p /var/log/remote
   sudo systemctl restart rsyslog
   ```

4. Testez de nouveau avec `logger` depuis machine2 → un fichier `/var/log/remote/machine2.log` doit apparaître.

---

## 4. Nettoyage

Pour remettre l’environnement à zéro :

### Sur machine2 (client)

- Supprimer la règle d’envoi :
  
  ```bash
  sudo nano /etc/rsyslog.conf
  # commentez la ligne *.* @10.10.10.1:514
  ```

- Redémarrer :
  
  ```bash
  sudo systemctl restart rsyslog
  ```

### Sur machine1 (serveur)

- Supprimer ou commenter les lignes ajoutées dans `/etc/rsyslog.conf` et `/etc/rsyslog.d/remote.conf`.

- Supprimer le dossier créé :
  
  ```bash
  sudo rm -rf /var/log/remote
  ```

- Redémarrer rsyslog :
  
  ```bash
  sudo systemctl restart rsyslog
  ```

---

✅ **Résultat attendu** : vous avez démontré un **serveur Syslog centralisé** capable de collecter et organiser les journaux d’autres machines du réseau.


