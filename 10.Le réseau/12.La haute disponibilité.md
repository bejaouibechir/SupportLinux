# Atelier ‚Äì VRRP avec keepalived

## 1. Contexte & objectif

L‚Äôobjectif de cet atelier est de **mettre en place la haute disponibilit√© (HA)** en configurant **keepalived** sur deux machines Debian 

- En cas de panne du **serveur ma√Ætre**, le **serveur backup** prend automatiquement le relais et continue de r√©pondre √† l‚Äôadresse IP virtuelle.

- Le protocole utilis√© est **VRRP (Virtual Router Redundancy Protocol)**.

üëâ √Ä la fin, vous aurez un service r√©seau capable de **tol√©rer la panne d‚Äôune machine** sans interruption pour le client.

---

## 2. Pr√©paration du terrain

### 2.1. Topologie

- Deux machines Debian (machine1 & machine2) reli√©es via le r√©seau interne **10.10.10.0/24**.

- Interfaces utilis√©es pour VRRP : `enp0s8`.

- Adresse IP virtuelle choisie : **10.10.10.100**.

```
machine1 (MASTER)    : 10.10.10.1
machine2 (BACKUP)    : 10.10.10.2
VIP (flottante VRRP) : 10.10.10.100
```

### 2.2. Installation de keepalived

Sur **les deux machines** :

```bash
sudo apt update
sudo apt install -y keepalived
```

V√©rifiez :

```bash
keepalived --version
```

Doit afficher une version > 2.x.

### 2.3. Pr√©parer un service de test

Sur chaque machine, installez **nginx** comme service √† surveiller :

```bash
sudo apt install -y nginx
```

- `machine1` : page d‚Äôaccueil `/var/www/html/index.html` ‚Üí √©crire **"Serveur MASTER"**

- `machine2` : page d‚Äôaccueil `/var/www/html/index.html` ‚Üí √©crire **"Serveur BACKUP"**

Cela permettra de tester le basculement (failover).

---

## 3. D√©roulement de l‚Äôexercice (√©tapes progressives)

### √âtape 1 ‚Äì Configuration du MASTER (machine1)

Cr√©er le fichier `/etc/keepalived/keepalived.conf` :

```bash
sudo nano /etc/keepalived/keepalived.conf
```

Contenu :

```bash
vrrp_instance VI_1 {
    state MASTER                # r√¥le principal
    interface enp0s8            # interface r√©seau VRRP
    virtual_router_id 51        # ID unique partag√©
    priority 200                # priorit√© √©lev√©e (MASTER > BACKUP)
    advert_int 1                # intervalle d‚Äôannonce en secondes
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
}
```

Red√©marrer le service :

```bash
sudo systemctl enable keepalived --now
```

V√©rifier :

```bash
ip a show enp0s8
```

üëâ L‚Äôadresse `10.10.10.100` doit appara√Ætre sur machine1.

---

### √âtape 2 ‚Äì Configuration du BACKUP (machine2)

√âditer `/etc/keepalived/keepalived.conf` :

```bash
vrrp_instance VI_1 {
    state BACKUP
    interface enp0s8
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
}
```

Activer le service :

```bash
sudo systemctl enable keepalived --now
```

V√©rifier :

```bash
ip a show enp0s8
```

üëâ L‚Äôadresse `10.10.10.100` ne doit PAS appara√Ætre ici (car c‚Äôest le MASTER qui la d√©tient).

---

### √âtape 3 ‚Äì Test de haute disponibilit√©

1. Depuis une machine cliente (ou depuis `machine2`) :

```bash
curl http://10.10.10.100
```

üëâ La page doit afficher **Serveur MASTER**.

2. Simuler une panne sur le MASTER (`machine1`) :

```bash
sudo systemctl stop keepalived
```

3. V√©rifier c√¥t√© BACKUP (`machine2`) :

```bash
ip a show enp0s8
```

üëâ L‚Äôadresse **10.10.10.100** doit maintenant appara√Ætre.

4. Tester √† nouveau :

```bash
curl http://10.10.10.100
```

üëâ La page doit afficher **Serveur BACKUP**.

5. Relancer keepalived sur `machine1` et observer le retour de la VIP.

---

### √âtape 4 ‚Äì Ajout de suivi de service (optionnel)

On peut faire en sorte que keepalived ne garde le r√¥le MASTER que si nginx fonctionne.

Modifier `/etc/keepalived/keepalived.conf` sur le MASTER :

```bash
vrrp_script chk_nginx {
    script "pidof nginx"
    interval 2
    weight -20
}

vrrp_instance VI_1 {
    state MASTER
    interface enp0s8
    virtual_router_id 51
    priority 200
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
    track_script {
        chk_nginx
    }
}
```

üëâ Si nginx tombe, la priorit√© baisse et le BACKUP prend le relais.

---

## 4. Nettoyage

Une fois la d√©mo termin√©e :

```bash
# Arr√™t des services keepalived
sudo systemctl stop keepalived
sudo apt remove --purge -y keepalived
sudo rm -rf /etc/keepalived

# Suppression du service de test
sudo apt remove --purge -y nginx
sudo rm -rf /var/www/html/*
```

V√©rifier qu‚Äôil ne reste plus d‚Äôadresse VIP :

```bash
ip a show enp0s8
```

Excellent üëå  
Nous allons **√©tendre ton atelier VRRP/Keepalived** en suivant le **mode recette p√©dagogique compl√®te**, √©tape par √©tape, sans rien omettre.  
Les quatre extensions pr√©vues seront int√©gr√©es dans une seule d√©marche progressive, chacune introduite, expliqu√©e, test√©e et v√©rifi√©e.

---

# üß© Atelier ‚Äì Haute disponibilit√© avanc√©e avec Keepalived (multi-services, notifications, 3 n≈ìuds, failback contr√¥l√©)

---

## 1Ô∏è‚É£ Contexte & Objectif

Cet atelier prolonge la configuration de base de **Keepalived + VRRP** en abordant les cas r√©els rencontr√©s en production.  
L‚Äôobjectif est de rendre la **haute disponibilit√© plus robuste et plus contr√¥l√©e**.

### Objectifs concrets :

1. Surveiller **plusieurs services critiques (nginx + sshd)**.

2. √ätre notifi√© automatiquement lors du basculement.

3. √âtendre le cluster √† **3 n≈ìuds** (MASTER + 2 BACKUP).

4. Contr√¥ler le **retour automatique (failback)** avec `nopreempt`.

---

## 2Ô∏è‚É£ Pr√©paration de l‚Äôenvironnement

### Topologie

| R√¥le    | Nom machine | IP           | Priorit√© | Interface | Fonction          |
| ------- | ----------- | ------------ | -------- | --------- | ----------------- |
| MASTER  | node1       | 10.10.10.1   | 200      | enp0s8    | Serveur principal |
| BACKUP1 | node2       | 10.10.10.2   | 150      | enp0s8    | Premier secours   |
| BACKUP2 | node3       | 10.10.10.3   | 120      | enp0s8    | Second secours    |
| VIP     | ‚Äî           | 10.10.10.100 | ‚Äî        | ‚Äî         | IP flottante VRRP |

---

### Installation sur les trois n≈ìuds

```bash
sudo apt update
sudo apt install -y keepalived nginx mailutils
```

V√©rification :

```bash
keepalived --version
```

R√©sultat attendu : version ‚â• 2.x

---

### Pr√©parer un service de test sur chaque n≈ìud

#### Page Web personnalis√©e

```bash
echo "Serveur MASTER (node1)" | sudo tee /var/www/html/index.html
# Sur node2
echo "Serveur BACKUP1 (node2)" | sudo tee /var/www/html/index.html
# Sur node3
echo "Serveur BACKUP2 (node3)" | sudo tee /var/www/html/index.html
```

#### Activer nginx

```bash
sudo systemctl enable --now nginx
```

#### V√©rifier

```bash
curl http://localhost
```

Attendu : le texte propre √† chaque n≈ìud.

---

## 3Ô∏è‚É£ √âtape 1 ‚Äì Surveillance multi-service

### 3.1. Cr√©ation de deux scripts de v√©rification

#### Fichier `/etc/keepalived/check_nginx.sh`

```bash
#!/bin/bash
pidof nginx >/dev/null 2>&1
exit $?
```

#### Fichier `/etc/keepalived/check_sshd.sh`

```bash
#!/bin/bash
pidof sshd >/dev/null 2>&1
exit $?
```

Rendre ex√©cutables :

```bash
sudo chmod +x /etc/keepalived/check_*.sh
```

---

### 3.2. Ajouter dans la configuration MASTER (`/etc/keepalived/keepalived.conf`)

```bash
vrrp_script chk_nginx {
    script "/etc/keepalived/check_nginx.sh"
    interval 2
    weight -10
}

vrrp_script chk_sshd {
    script "/etc/keepalived/check_sshd.sh"
    interval 2
    weight -5
}

vrrp_instance VI_1 {
    state MASTER
    interface enp0s8
    virtual_router_id 51
    priority 200
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mysecretpass
    }
    virtual_ipaddress {
        10.10.10.100/24
    }
    track_script {
        chk_nginx
        chk_sshd
    }
}
```

M√™me principe sur BACKUP1 et BACKUP2, avec des priorit√©s diff√©rentes (150 et 120).

---

### 3.3. V√©rification

Red√©marre keepalived :

```bash
sudo systemctl restart keepalived
```

Teste :

```bash
curl http://10.10.10.100
```

Puis simule la panne de `nginx` :

```bash
sudo systemctl stop nginx
```

R√©sultat attendu :  
‚Üí la priorit√© diminue, la VIP passe au BACKUP.  
‚Üí relancer nginx pour voir le retour.

---

## 4Ô∏è‚É£ √âtape 2 ‚Äì Notifications lors du basculement

### 4.1. Cr√©er le script de notification

Fichier `/etc/keepalived/notify.sh` :

```bash
#!/bin/bash
TYPE=$1
HOSTNAME=$(hostname)
DATE=$(date '+%Y-%m-%d %H:%M:%S')

case $TYPE in
  master)
    MESSAGE="[$DATE] $HOSTNAME devient MASTER (VIP active)."
    ;;
  backup)
    MESSAGE="[$DATE] $HOSTNAME devient BACKUP (VIP lib√©r√©e)."
    ;;
  fault)
    MESSAGE="[$DATE] $HOSTNAME est en √©tat FAULT (panne d√©tect√©e)."
    ;;
  *)
    MESSAGE="[$DATE] $HOSTNAME √©tat inconnu : $TYPE"
    ;;
esac

logger "$MESSAGE"
echo "$MESSAGE" | mail -s "Keepalived: changement d'√©tat $HOSTNAME" admin@example.com
```

Le rendre ex√©cutable :

```bash
sudo chmod +x /etc/keepalived/notify.sh
```

---

### 4.2. Int√©grer au bloc `vrrp_instance`

```bash
notify_master "/etc/keepalived/notify.sh master"
notify_backup "/etc/keepalived/notify.sh backup"
notify_fault "/etc/keepalived/notify.sh fault"
```

Exemple complet :

```bash
vrrp_instance VI_1 {
    ...
    track_script {
        chk_nginx
        chk_sshd
    }
    notify_master "/etc/keepalived/notify.sh master"
    notify_backup "/etc/keepalived/notify.sh backup"
    notify_fault "/etc/keepalived/notify.sh fault"
}
```

---

### 4.3. V√©rification

- Red√©marre Keepalived sur MASTER :
  
  ```bash
  sudo systemctl restart keepalived
  ```

- Consulter les logs :
  
  ```bash
  journalctl -fu keepalived | grep VIP
  ```

- Simule une panne :
  
  ```bash
  sudo systemctl stop keepalived
  ```
  
  ‚Üí Tu dois recevoir un mail et voir le message dans `/var/log/syslog`.

---

## 5Ô∏è‚É£ √âtape 3 ‚Äì Cluster √† 3 n≈ìuds

Les BACKUP doivent avoir la m√™me configuration mais des **priorit√©s d√©croissantes** :

- `node1`: 200

- `node2`: 150

- `node3`: 120

Chaque machine a un r√¥le de ‚Äúsecours du pr√©c√©dent‚Äù.

### Test

1. Stoppe Keepalived sur node1 (MASTER) ‚Üí la VIP passe √† node2.

2. Stoppe Keepalived sur node2 ‚Üí la VIP passe √† node3.

3. Relance node2 ‚Üí reste BACKUP tant que node1 n‚Äôest pas relanc√©.

Visualise :

```bash
watch -n1 "ip a show enp0s8 | grep 10.10.10.100"
```

---

## 6Ô∏è‚É£ √âtape 4 ‚Äì Failback contr√¥l√© (`nopreempt`)

### 6.1. Contexte

Par d√©faut, d√®s que le MASTER revient en ligne, il **reprend imm√©diatement** la VIP.  
Mais ce comportement peut cr√©er un **effet ping-pong** (yo-yo) :

- en cas de panne intermittente du MASTER,

- ou lors de travaux de maintenance temporaires.

### 6.2. Solution

Ajoute la directive :

```bash
nopreempt
```

Exemple :

```bash
vrrp_instance VI_1 {
    state MASTER
    interface enp0s8
    virtual_router_id 51
    priority 200
    nopreempt
    ...
}
```

### 6.3. Explication p√©dagogique

- **Pourquoi ?**  
  Pour stabiliser le cluster : le BACKUP garde la main tant qu‚Äôil est sain, m√™me si le MASTER revient.

- **Quand l‚Äôutiliser ?**
  
  - En maintenance planifi√©e du MASTER.
  
  - En r√©seau instable (pertes VRRP sporadiques).

- **Quand √©viter ?**
  
  - Quand le MASTER doit absolument redevenir prioritaire apr√®s red√©marrage.

---

### Test

1. Fais basculer la VIP sur node2.

2. Red√©marre node1 avec `nopreempt`.  
   ‚Üí La VIP **reste** sur node2.

3. Si tu veux qu‚Äôelle revienne manuellement :
   
   ```bash
   sudo systemctl restart keepalived
   ```
   
   ou
   
   ```bash
   sudo systemctl reload keepalived
   ```

---

## 7Ô∏è‚É£ V√©rifications globales

| Action                          | Attendu                  |
| ------------------------------- | ------------------------ |
| Arr√™t nginx sur MASTER          | BACKUP prend la VIP      |
| Arr√™t sshd sur MASTER           | priorit√© diminue         |
| Arr√™t complet Keepalived        | VIP bascule sur BACKUP1  |
| Panne BACKUP1                   | VIP bascule sur BACKUP2  |
| Retour du MASTER avec nopreempt | pas de failback imm√©diat |

---

## 8Ô∏è‚É£ Nettoyage / Rollback

```bash
sudo systemctl stop keepalived nginx
sudo apt remove --purge -y keepalived nginx mailutils
sudo rm -rf /etc/keepalived
sudo rm -rf /var/www/html/*
sudo apt autoremove -y
```

V√©rifie :

```bash
ip a show enp0s8
```

‚Üí la VIP doit avoir disparu.

---

## 9Ô∏è‚É£ Astuces & pi√®ges

| Probl√®me                    | Cause                                      | Solution                                           |
| --------------------------- | ------------------------------------------ | -------------------------------------------------- |
| La VIP ne bascule pas       | mauvais `virtual_router_id` ou `auth_pass` | V√©rifier la coh√©rence sur tous les n≈ìuds           |
| Pas de mail de notification | service `postfix`/`mailutils` manquant     | Installer `mailutils` ou utiliser `logger` uniquem |
| Keepalived ne d√©marre pas   | erreur syntaxe conf                        | V√©rifier via `systemctl status keepalived -l`      |
| Yo-yo de VIP                | preempt actif sur MASTER                   | Activer `nopreemp                                  |
