# 🧪 Exercice7-Atelier FTP — Comprendre et expérimenter `vsftpd` de manière réaliste

## 🧭 Contexte réseau

| Rôle        | Nom       | IP         | Interface |
| ----------- | --------- | ---------- | --------- |
| Client      | Machine 1 | 10.10.10.1 | enp0s8    |
| Serveur FTP | Machine 2 | 10.10.10.2 | enp0s8    |

---

## 🎯 Objectifs pédagogiques

1. Installer et activer un serveur FTP fonctionnel (`vsftpd`)
2. Créer et tester un **compte local** FTP
3. Expérimenter les options fondamentales de `/etc/vsftpd.conf`
4. Comprendre le **mode anonyme** et le **chroot**
5. Observer la journalisation et les logs
6. Nettoyer proprement l’environnement

---

## 🧱 Étape 1 — Installation du serveur FTP (Machine 2)

### 📝 Explication

`vsftpd` (Very Secure FTP Daemon) est un service rapide et sécurisé.
On installe le paquet et on démarre le service.

```bash
sudo apt update
sudo apt install -y vsftpd
sudo systemctl enable --now vsftpd
sudo systemctl status vsftpd --no-pager
```

Résultat attendu :

```
● vsftpd.service - vsftpd FTP server
   Active: active (running)
```

---

## 📁 Étape 2 — Préparation du répertoire FTP global

### 📝 Explication

Nous utiliserons un répertoire dédié sous `/ftpdata`, accessible à un utilisateur FTP local.

```bash
sudo mkdir -p /ftpdata/upload
sudo chmod 755 /ftpdata
```

---

## 👤 Étape 3 — Création d’un utilisateur standard

### 📝 Explication

On crée un utilisateur système normal `ftpuser`, avec un mot de passe simple.

```bash
sudo adduser ftpuser
sudo passwd ftpuser
```

Vérification :

```bash
getent passwd ftpuser
```

Exemple :

```
ftpuser:x:1001:1001::/home/ftpuser:/bin/bash
```

---

## ⚙️ Étape 4 — Configuration de base du serveur

Édite le fichier :

```bash
sudo nano /etc/vsftpd.conf
```

Remplace le contenu par :

```ini
listen=YES
listen_ipv6=NO

# Interdire l'accès anonyme
anonymous_enable=NO

# Autoriser les comptes locaux
local_enable=YES

# Autoriser l'écriture
write_enable=YES

# Confinement des utilisateurs
chroot_local_user=YES
allow_writeable_chroot=YES

# Dossier FTP par défaut
local_root=/ftpdata

# Journalisation
xferlog_enable=YES
log_ftp_protocol=YES

# Sécurité
pam_service_name=vsftpd
ssl_enable=NO
```

Appliquer :

```bash
sudo systemctl restart vsftpd
```

---

## 🧪 Étape 5 — Test de connexion locale (depuis Machine 1)

Sur la machine cliente :

```bash
sudo apt install -y ftp
ftp 10.10.10.2
```

Saisie interactive :

```
Name (10.10.10.2:bechir): ftpuser
Password: ****
```

Puis dans la session FTP :

```
ftp> pwd
ftp> cd upload
ftp> put /etc/hostname
ftp> ls
ftp> get hostname
ftp> bye
```

### ✅ Résultat attendu

* Connexion acceptée.
* Le fichier `/etc/hostname` est transféré vers `/ftpdata/upload`.

---

## 🧩 Étape 6 — Expériences pédagogiques sur `/etc/vsftpd.conf`

Nous allons tester les paramètres **un par un**, avec hypothèse + observation.

---

### 🧪 Scénario 1 – `anonymous_enable`

#### Objectif :

Activer puis désactiver le mode anonyme.

#### Étapes :

1. Modifie `/etc/vsftpd.conf` :
   
   ```ini
   anonymous_enable=YES
   ```

2. Redémarre :
   
   ```bash
   sudo systemctl restart vsftpd
   ```

3. Depuis la Machine 1 :
   
   ```bash
   ftp 10.10.10.2
   ```
   
   Login :
   
   ```
   Name: anonymous
   Password: (laisser vide ou mettre ton e-mail)
   ```

4. Vérifie :
   
   ```
   ftp> ls
   ftp> bye
   ```

#### Résultat :

* L’accès fonctionne sans vrai mot de passe.

* Les fichiers sont ceux de `/srv/ftp`.

* L’utilisateur ne peut **rien écrire** (lecture seule).
  
  ### Les commandes FTP

| Objectif                                         | Commande FTP    | Exemple                      | Description                              |
| ------------------------------------------------ | --------------- | ---------------------------- | ---------------------------------------- |
| **Télécharger un fichier (du serveur → client)** | `get`           | `get test.txt`               | récupère un fichier du serveur           |
| **Télécharger plusieurs fichiers**               | `mget`          | `mget *.txt`                 | récupère tous les fichiers correspondant |
| **Uploader un fichier (client → serveur)**       | `put`           | `put fichier.txt`            | envoie un fichier vers le serveur        |
| **Uploader plusieurs fichiers**                  | `mput`          | `mput *.txt`                 | envoie tous les fichiers correspondants  |
| **Changer de dossier côté serveur**              | `cd`            | `cd upload`                  | déplace le répertoire courant serveur    |
| **Changer de dossier côté client**               | `lcd`           | `lcd /home/bechir/Documents` | change le dossier local                  |
| **Lister les fichiers serveur**                  | `ls`            | `ls`                         | affiche les fichiers serveur             |
| **Lister les fichiers locaux**                   | `!ls`           | `!ls`                        | exécute une commande locale (ici `ls`)   |
| **Supprimer un fichier serveur**                 | `delete`        | `delete fichier.txt`         | supprime côté serveur                    |
| **Supprimer un fichier local**                   | `!rm`           | `!rm fichier.txt`            | exécute `rm` localement                  |
| **Quitter le FTP**                               | `bye` ou `quit` |                              | ferme la session FTP                     |

5. Reviens à la configuration initiale :
   
   ```bash
   sudo sed -i 's/^anonymous_enable=.*/anonymous_enable=NO/' /etc/vsftpd.conf
   sudo systemctl restart vsftpd
   ```

---

### 🧪 Scénario 2 – `local_enable`

#### Objectif :

Contrôler l’accès des utilisateurs système.

1. Mettre :
   
   ```ini
   local_enable=NO
   ```
   
   puis redémarrer :
   
   ```bash
   sudo systemctl restart vsftpd
   ```

2. Depuis la Machine 1 :
   
   ```bash
   ftp 10.10.10.2
   ```
   
   → **530 Login incorrect**

3. Revenir à :
   
   ```ini
   local_enable=YES
   ```
   
   puis :
   
   ```bash
   sudo systemctl restart vsftpd
   ```

---

### 🧪 Scénario 3 – `write_enable`

#### Objectif :

Autoriser ou interdire les transferts de fichiers.

1. Désactiver :
   
   ```ini
   write_enable=NO
   ```

2. Redémarrer et tester :
   
   ```
   ftp 10.10.10.2
   ftp> put fichier.txt
   550 Permission denied
   ```

3. Réactiver :
   
   ```ini
   write_enable=YES
   ```

---

### 🧪 Scénario 4 – `chroot_local_user` et `allow_writeable_chroot`

#### Objectif :

Comprendre le confinement utilisateur.

1. Cas 1 – Sans confinement :
   
   ```ini
   chroot_local_user=NO
   ```
   
   → `cd ..` fonctionne.

2. Cas 2 – Avec confinement :
   
   ```ini
   chroot_local_user=YES
   allow_writeable_chroot=YES
   ```
   
   → l’utilisateur reste dans `/ftpdata`
   → impossible de remonter à `/`

---

### 🧪 Scénario 5 – Journalisation

#### Objectif :

Observer les logs FTP.

```bash
sudo tail -f /var/log/vsftpd.log
```

Puis sur Machine 1 :

```bash
ftp 10.10.10.2
ftp> ls
ftp> bye
```

Observe les commandes :

```
Tue Oct  8 13:20:43 2025 [pid 1032] CONNECT: Client "::ffff:10.10.10.1"
Tue Oct  8 13:20:43 2025 [pid 1032] FTP command: USER ftpuser
```

---

## 🔒 Étape 7 — Sécuriser avec FTPS

> Bonus pour stagiaires avancés

```bash
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
-keyout /etc/ssl/private/vsftpd.pem \
-out /etc/ssl/certs/vsftpd.pem
```

Dans `/etc/vsftpd.conf` :

```ini
ssl_enable=YES
rsa_cert_file=/etc/ssl/certs/vsftpd.pem
rsa_private_key_file=/etc/ssl/private/vsftpd.pem
```

Puis :

```bash
sudo systemctl restart vsftpd
```

Test :

```bash
lftp -u ftpuser,ftpuser ftps://10.10.10.2
```

---

## 🧹 Étape 8 — Nettoyage

### 📝 Explication

Remet le serveur à un état neutre pour le prochain test.

```bash
sudo systemctl stop vsftpd
sudo deluser --remove-home ftpuser
sudo rm -rf /ftpdata
sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.bak.$(date +%Y%m%d-%H%M%S)
sudo bash -c 'cat > /etc/vsftpd.conf' <<'CONF'
listen=YES
listen_ipv6=NO
anonymous_enable=NO
local_enable=YES
write_enable=YES
chroot_local_user=NO
xferlog_enable=YES
log_ftp_protocol=YES
ssl_enable=NO
CONF
sudo systemctl restart vsftpd
```

---

## ✅ Résumé

| Paramètre                            | Effet principal                      | Test / Observation                 |
| ------------------------------------ | ------------------------------------ | ---------------------------------- |
| `listen`                             | Active le service FTP                | connexion `ftp` possible           |
| `anonymous_enable`                   | Active/désactive FTP public          | test avec `anonymous`              |
| `local_enable`                       | Active/désactive les comptes système | `ftpuser` accepté/refusé           |
| `write_enable`                       | Autorise l’écriture                  | `put` fonctionne ou non            |
| `chroot_local_user`                  | Confine l’utilisateur                | `cd ..` interdit                   |
| `allow_writeable_chroot`             | Évite erreur “OOPS”                  | login réussi                       |
| `xferlog_enable`, `log_ftp_protocol` | Enregistre les actions FTP           | visible dans `/var/log/vsftpd.log` |

### Netoyage

```bash

```
