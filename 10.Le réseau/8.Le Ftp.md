# ðŸ§ª Exercice7-Atelier FTP â€” Comprendre et expÃ©rimenter `vsftpd` de maniÃ¨re rÃ©aliste

## ðŸ§­ Contexte rÃ©seau

| RÃ´le        | Nom       | IP         | Interface |
| ----------- | --------- | ---------- | --------- |
| Client      | Machine 1 | 10.10.10.1 | enp0s8    |
| Serveur FTP | Machine 2 | 10.10.10.2 | enp0s8    |

---

## ðŸŽ¯ Objectifs pÃ©dagogiques

1. Installer et activer un serveur FTP fonctionnel (`vsftpd`)
2. CrÃ©er et tester un **compte local** FTP
3. ExpÃ©rimenter les options fondamentales de `/etc/vsftpd.conf`
4. Comprendre le **mode anonyme** et le **chroot**
5. Observer la journalisation et les logs
6. Nettoyer proprement lâ€™environnement

---

## ðŸ§± Ã‰tape 1 â€” Installation du serveur FTP (Machine 2)

### ðŸ“ Explication

`vsftpd` (Very Secure FTP Daemon) est un service rapide et sÃ©curisÃ©.
On installe le paquet et on dÃ©marre le service.

```bash
sudo apt update
sudo apt install -y vsftpd
sudo systemctl enable --now vsftpd
sudo systemctl status vsftpd --no-pager
```

RÃ©sultat attendu :

```
â— vsftpd.service - vsftpd FTP server
   Active: active (running)
```

---

## ðŸ“ Ã‰tape 2 â€” PrÃ©paration du rÃ©pertoire FTP global

### ðŸ“ Explication

Nous utiliserons un rÃ©pertoire dÃ©diÃ© sous `/ftpdata`, accessible Ã  un utilisateur FTP local.

```bash
sudo mkdir -p /ftpdata/upload
sudo chmod 755 /ftpdata
```

---

## ðŸ‘¤ Ã‰tape 3 â€” CrÃ©ation dâ€™un utilisateur standard

### ðŸ“ Explication

On crÃ©e un utilisateur systÃ¨me normal `ftpuser`, avec un mot de passe simple.

```bash
sudo adduser ftpuser
sudo passwd ftpuser
```

VÃ©rification :

```bash
getent passwd ftpuser
```

Exemple :

```
ftpuser:x:1001:1001::/home/ftpuser:/bin/bash
```

---

## âš™ï¸ Ã‰tape 4 â€” Configuration de base du serveur

Ã‰dite le fichier :

```bash
sudo nano /etc/vsftpd.conf
```

Remplace le contenu par :

```ini
listen=YES
listen_ipv6=NO

# Interdire l'accÃ¨s anonyme
anonymous_enable=NO

# Autoriser les comptes locaux
local_enable=YES

# Autoriser l'Ã©criture
write_enable=YES

# Confinement des utilisateurs
chroot_local_user=YES
allow_writeable_chroot=YES

# Dossier FTP par dÃ©faut
local_root=/ftpdata

# Journalisation
xferlog_enable=YES
log_ftp_protocol=YES

# SÃ©curitÃ©
pam_service_name=vsftpd
ssl_enable=NO
```

Appliquer :

```bash
sudo systemctl restart vsftpd
```

---

## ðŸ§ª Ã‰tape 5 â€” Test de connexion locale (depuis Machine 1)

Sur la machine cliente :

```bash
sudo apt install -y ftp
ftp 10.10.10.2
```

Saisie interactive :

```
Name (10.10.10.2:bechir): ftpuser
Password: ****
```

Puis dans la session FTP :

```
ftp> pwd
ftp> cd upload
ftp> put /etc/hostname
ftp> ls
ftp> get hostname
ftp> bye
```

### âœ… RÃ©sultat attendu

* Connexion acceptÃ©e.
* Le fichier `/etc/hostname` est transfÃ©rÃ© vers `/ftpdata/upload`.

---

## ðŸ§© Ã‰tape 6 â€” ExpÃ©riences pÃ©dagogiques sur `/etc/vsftpd.conf`

Nous allons tester les paramÃ¨tres **un par un**, avec hypothÃ¨se + observation.

---

### ðŸ§ª ScÃ©nario 1 â€“ `anonymous_enable`

#### Objectif :

Activer puis dÃ©sactiver le mode anonyme.

#### Ã‰tapes :

1. Modifie `/etc/vsftpd.conf` :
   
   ```ini
   anonymous_enable=YES
   ```

2. RedÃ©marre :
   
   ```bash
   sudo systemctl restart vsftpd
   ```

3. Depuis la Machine 1 :
   
   ```bash
   ftp 10.10.10.2
   ```
   
   Login :
   
   ```
   Name: anonymous
   Password: (laisser vide ou mettre ton e-mail)
   ```

4. VÃ©rifie :
   
   ```
   ftp> ls
   ftp> bye
   ```

#### RÃ©sultat :

* Lâ€™accÃ¨s fonctionne sans vrai mot de passe.

* Les fichiers sont ceux de `/srv/ftp`.

* Lâ€™utilisateur ne peut **rien Ã©crire** (lecture seule).
  
  ### Les commandes FTP

| Objectif                                         | Commande FTP    | Exemple                      | Description                              |
| ------------------------------------------------ | --------------- | ---------------------------- | ---------------------------------------- |
| **TÃ©lÃ©charger un fichier (du serveur â†’ client)** | `get`           | `get test.txt`               | rÃ©cupÃ¨re un fichier du serveur           |
| **TÃ©lÃ©charger plusieurs fichiers**               | `mget`          | `mget *.txt`                 | rÃ©cupÃ¨re tous les fichiers correspondant |
| **Uploader un fichier (client â†’ serveur)**       | `put`           | `put fichier.txt`            | envoie un fichier vers le serveur        |
| **Uploader plusieurs fichiers**                  | `mput`          | `mput *.txt`                 | envoie tous les fichiers correspondants  |
| **Changer de dossier cÃ´tÃ© serveur**              | `cd`            | `cd upload`                  | dÃ©place le rÃ©pertoire courant serveur    |
| **Changer de dossier cÃ´tÃ© client**               | `lcd`           | `lcd /home/bechir/Documents` | change le dossier local                  |
| **Lister les fichiers serveur**                  | `ls`            | `ls`                         | affiche les fichiers serveur             |
| **Lister les fichiers locaux**                   | `!ls`           | `!ls`                        | exÃ©cute une commande locale (ici `ls`)   |
| **Supprimer un fichier serveur**                 | `delete`        | `delete fichier.txt`         | supprime cÃ´tÃ© serveur                    |
| **Supprimer un fichier local**                   | `!rm`           | `!rm fichier.txt`            | exÃ©cute `rm` localement                  |
| **Quitter le FTP**                               | `bye` ou `quit` |                              | ferme la session FTP                     |

5. Reviens Ã  la configuration initiale :
   
   ```bash
   sudo sed -i 's/^anonymous_enable=.*/anonymous_enable=NO/' /etc/vsftpd.conf
   sudo systemctl restart vsftpd
   ```

---

### ðŸ§ª ScÃ©nario 2 â€“ `local_enable`

#### Objectif :

ContrÃ´ler lâ€™accÃ¨s des utilisateurs systÃ¨me.

1. Mettre :
   
   ```ini
   local_enable=NO
   ```
   
   puis redÃ©marrer :
   
   ```bash
   sudo systemctl restart vsftpd
   ```

2. Depuis la Machine 1 :
   
   ```bash
   ftp 10.10.10.2
   ```
   
   â†’ **530 Login incorrect**

3. Revenir Ã  :
   
   ```ini
   local_enable=YES
   ```
   
   puis :
   
   ```bash
   sudo systemctl restart vsftpd
   ```

---

### ðŸ§ª ScÃ©nario 3 â€“ `write_enable`

#### Objectif :

Autoriser ou interdire les transferts de fichiers.

1. DÃ©sactiver :
   
   ```ini
   write_enable=NO
   ```

2. RedÃ©marrer et tester :
   
   ```
   ftp 10.10.10.2
   ftp> put fichier.txt
   550 Permission denied
   ```

3. RÃ©activer :
   
   ```ini
   write_enable=YES
   ```

---

### ðŸ§ª ScÃ©nario 4 â€“ `chroot_local_user` et `allow_writeable_chroot`

#### Objectif :

Comprendre le confinement utilisateur.

1. Cas 1 â€“ Sans confinement :
   
   ```ini
   chroot_local_user=NO
   ```
   
   â†’ `cd ..` fonctionne.

2. Cas 2 â€“ Avec confinement :
   
   ```ini
   chroot_local_user=YES
   allow_writeable_chroot=YES
   ```
   
   â†’ lâ€™utilisateur reste dans `/ftpdata`
   â†’ impossible de remonter Ã  `/`

---

### ðŸ§ª ScÃ©nario 5 â€“ Journalisation

#### Objectif :

Observer les logs FTP.

```bash
sudo tail -f /var/log/vsftpd.log
```

Puis sur Machine 1 :

```bash
ftp 10.10.10.2
ftp> ls
ftp> bye
```

Observe les commandes :

```
Tue Oct  8 13:20:43 2025 [pid 1032] CONNECT: Client "::ffff:10.10.10.1"
Tue Oct  8 13:20:43 2025 [pid 1032] FTP command: USER ftpuser
```

---

## ðŸ”’ Ã‰tape 7 â€” SÃ©curiser avec FTPS

> Bonus pour stagiaires avancÃ©s

```bash
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
-keyout /etc/ssl/private/vsftpd.pem \
-out /etc/ssl/certs/vsftpd.pem
```

Dans `/etc/vsftpd.conf` :

```ini
ssl_enable=YES
rsa_cert_file=/etc/ssl/certs/vsftpd.pem
rsa_private_key_file=/etc/ssl/private/vsftpd.pem
```

Puis :

```bash
sudo systemctl restart vsftpd
```

Test :

```bash
lftp -u ftpuser,ftpuser ftps://10.10.10.2
```

---

## ðŸ§¹ Ã‰tape 8 â€” Nettoyage

### ðŸ“ Explication

Remet le serveur Ã  un Ã©tat neutre pour le prochain test.

```bash
sudo systemctl stop vsftpd
sudo deluser --remove-home ftpuser
sudo rm -rf /ftpdata
sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.bak.$(date +%Y%m%d-%H%M%S)
sudo bash -c 'cat > /etc/vsftpd.conf' <<'CONF'
listen=YES
listen_ipv6=NO
anonymous_enable=NO
local_enable=YES
write_enable=YES
chroot_local_user=NO
xferlog_enable=YES
log_ftp_protocol=YES
ssl_enable=NO
CONF
sudo systemctl restart vsftpd
```

---

## âœ… RÃ©sumÃ©

| ParamÃ¨tre                            | Effet principal                      | Test / Observation                 |
| ------------------------------------ | ------------------------------------ | ---------------------------------- |
| `listen`                             | Active le service FTP                | connexion `ftp` possible           |
| `anonymous_enable`                   | Active/dÃ©sactive FTP public          | test avec `anonymous`              |
| `local_enable`                       | Active/dÃ©sactive les comptes systÃ¨me | `ftpuser` acceptÃ©/refusÃ©           |
| `write_enable`                       | Autorise lâ€™Ã©criture                  | `put` fonctionne ou non            |
| `chroot_local_user`                  | Confine lâ€™utilisateur                | `cd ..` interdit                   |
| `allow_writeable_chroot`             | Ã‰vite erreur â€œOOPSâ€                  | login rÃ©ussi                       |
| `xferlog_enable`, `log_ftp_protocol` | Enregistre les actions FTP           | visible dans `/var/log/vsftpd.log` |

### Netoyage

```bash

```
