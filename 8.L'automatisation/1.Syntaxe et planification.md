# Partie 2 — Syntaxe & planification

---

## Exercice 4 : Exécution toutes les 2 minutes avec un script système

**1. Contexte & objectif**  
On veut automatiser la **surveillance du disque** toutes les 2 minutes.  
L’objectif est d’apprendre la syntaxe `*/2` et de produire un rapport utile et lisible.

**2. Préparation du terrain**  
Créer un script `~/check_disk.sh` :

```bash
nano ~/check_disk.sh
```

Contenu :

```bash
#!/bin/bash
echo "==== Rapport disque généré le $(date) ====" >> ~/disk_report.log
df -h >> ~/disk_report.log
echo "" >> ~/disk_report.log
```

Rendre exécutable :

```bash
chmod +x ~/check_disk.sh
```

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier le script toutes les 2 minutes :
  
  ```bash
  crontab -e
  ```
  
  Ajouter :
  
  ```
  */2 * * * * ~/check_disk.sh
  ```

- **Étape 2 :** Attendre 4 minutes et vérifier :
  
  ```bash
  tail -n 15 ~/disk_report.log
  ```

- **Étape 3 :** Faire modifier le participant le script pour ajouter aussi l’espace mémoire :
  
  ```bash
  free -h >> ~/disk_report.log
  ```

- **Étape 4 :** Constater les nouveaux résultats après 2 minutes.

**4. Nettoyage**

```bash
crontab -r
rm ~/check_disk.sh ~/disk_report.log
```

---

## Exercice 5 : Tâche hebdomadaire (lundi 8h) avec message système

**1. Contexte & objectif**  
Apprendre la syntaxe CRON `0 8 * * 1`.  
Cas réel : envoyer un **message de rappel hebdomadaire** (simulateur de rapport RH/IT).

**2. Préparation du terrain**  
Créer un script `~/reminder.sh` :

```bash
nano ~/reminder.sh
```

Contenu :

```bash
#!/bin/bash
echo "Rappel automatique : réunion hebdomadaire à 9h. Généré le $(date)" >> ~/reminder.log
```

Rendre exécutable :

```bash
chmod +x ~/reminder.sh
```

**3. Étapes de l’exercice**

- **Étape 1 :** Créer la tâche CRON hebdomadaire :
  
  ```
  0 8 * * 1 ~/reminder.sh
  ```

- **Étape 2 :** Pour tester, remplacer par `*/1 * * * *` (chaque minute).

- **Étape 3 :** Vérifier le fichier après 2–3 minutes :
  
  ```bash
  cat ~/reminder.log
  ```

- **Étape 4 :** Ajouter une amélioration → envoi sur le terminal (simulation “broadcast”) :
  
  ```bash
  echo "Message CRON : réunion bientôt !" | wall
  ```

**4. Nettoyage**

```bash
crontab -r
rm ~/reminder.sh ~/reminder.log
```

---

## Exercice 6 : Plage horaire (minutes 10 à 15)

**1. Contexte & objectif**  
Montrer comment exécuter une tâche **dans une plage précise**.  
Exemple : capturer des informations système entre la 10ᵉ et la 15ᵉ minute de chaque heure.

**2. Préparation du terrain**  
Créer un script Python simple `~/sysinfo.py` :

```bash
nano ~/sysinfo.py
```

Contenu :

```python
#!/usr/bin/env python3
import datetime, os, psutil

with open("/home/$USER/sysinfo.log", "a") as f:
    f.write("==== Info système " + str(datetime.datetime.now()) + " ====\n")
    f.write("CPU usage: " + str(psutil.cpu_percent()) + "%\n")
    f.write("RAM usage: " + str(psutil.virtual_memory().percent) + "%\n\n")
```

Installer `psutil` :

```bash
sudo apt install python3-pip -y
pip3 install psutil
chmod +x ~/sysinfo.py
```

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier la tâche de la minute 10 à 15 :
  
  ```
  10-15 * * * * ~/sysinfo.py
  ```

- **Étape 2 :** Simuler rapidement en changeant en `*/1 * * * *`.

- **Étape 3 :** Vérifier le fichier de log :
  
  ```bash
  tail -n 10 ~/sysinfo.log
  ```

- **Étape 4 :** Modifier le script pour inclure aussi `uptime` et relancer la planification.

**4. Nettoyage**

```bash
crontab -r
rm ~/sysinfo.py ~/sysinfo.log
pip3 uninstall -y psutil
```

---

## Exercice 7 : Liste de minutes (1,15,30)

**1. Contexte & objectif**  
Apprendre à exécuter un job à plusieurs moments dans l’heure via une **liste**.  
Cas pratique : vérifier la connectivité réseau régulièrement.

**2. Préparation du terrain**  
Créer `~/pingtest.sh` :

```bash
nano ~/pingtest.sh
```

Contenu :

```bash
#!/bin/bash
echo "==== Vérification $(date) ====" >> ~/ping.log
ping -c 2 8.8.8.8 >> ~/ping.log
echo "" >> ~/ping.log
```

Rendre exécutable :

```bash
chmod +x ~/pingtest.sh
```

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier :
  
  ```
  1,15,30 * * * * ~/pingtest.sh
  ```

- **Étape 2 :** Vérifier le log après 30 min (ou tester en modifiant en `*/1`).

- **Étape 3 :** Ajouter au script un test sur `google.com` pour comparer.

- **Étape 4 :** Comparer les résultats entre les deux destinations.

**4. Nettoyage**

```bash
crontab -r
rm ~/pingtest.sh ~/ping.log
```

---

## Exercice 8 : Cas pratique de sauvegarde automatique

**1. Contexte & objectif**  
Simuler un scénario de **sauvegarde automatisée** avec CRON.  
On va créer un fichier de données, puis un script de backup qui le copie dans un dossier dédié.

**2. Préparation du terrain**

- Créer un dossier de données :
  
  ```bash
  mkdir ~/data
  echo "fichier important" > ~/data/info.txt
  ```

- Créer un dossier de sauvegarde :
  
  ```bash
  mkdir ~/sauvegarde
  ```

- Créer le script `~/backup.sh` :
  
  ```bash
  nano ~/backup.sh
  ```
  
  Contenu :
  
  ```bash
  #!/bin/bash
  echo "==== Sauvegarde $(date) ====" >> ~/sauvegarde/backup.log
  cp -r ~/data/* ~/sauvegarde/
  ls -l ~/sauvegarde >> ~/sauvegarde/backup.log
  echo "" >> ~/sauvegarde/backup.log
  ```
  
  Rendre exécutable :
  
  ```bash
  chmod +x ~/backup.sh
  ```

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier toutes les minutes :
  
  ```
  * * * * * ~/backup.sh
  ```

- **Étape 2 :** Ajouter de nouveaux fichiers dans `~/data` et observer après 2–3 minutes que la sauvegarde est mise à jour.

- **Étape 3 :** Ouvrir `backup.log` pour voir l’historique :
  
  ```bash
  tail -n 15 ~/sauvegarde/backup.log
  ```

- **Étape 4 :** Modifier la planification pour toutes les 5 minutes (`*/5`).

**4. Nettoyage**

```bash
crontab -r
rm -r ~/data ~/sauvegarde ~/backup.sh
```
