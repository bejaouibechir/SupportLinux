# Partie 5 — Compléments pratiques (4 exercices)

---

## Exercice 15 : Utiliser Anacron pour les machines non 24/7

**1. Contexte & objectif**  
`cron` suppose que la machine est toujours allumée. Si la machine est éteinte, les jobs sont manqués.  
`anacron` résout ce problème en exécutant les tâches manquées au prochain démarrage.  
Objectif : installer, configurer et tester une tâche avec `anacron`.

---

**2. Préparation du terrain**

- Installer anacron :
  
  ```bash
  sudo apt update
  sudo apt install anacron -y
  ```

- Vérifier qu’il est activé :
  
  ```bash
  systemctl status anacron
  ```

Créer un script :

```bash
sudo nano /usr/local/bin/anacron_job.sh
```

Contenu :

```bash
#!/bin/bash
echo "Anacron exécuté à $(date)" >> /var/log/anacron_test.log
```

Rendre exécutable :

```bash
sudo chmod +x /usr/local/bin/anacron_job.sh
```

---

**3. Étapes de l’exercice**

- **Étape 1 :** Ajouter une tâche dans `/etc/anacrontab` :
  
  ```bash
  sudo nano /etc/anacrontab
  ```
  
  Exemple :
  
  ```
  1  5  anacron_test  /usr/local/bin/anacron_job.sh
  ```
  
  → Signifie : exécuter **tous les jours** avec délai de 5 minutes après démarrage.

- **Étape 2 :** Redémarrer la machine et patienter 5 minutes.

- **Étape 3 :** Vérifier le fichier :
  
  ```bash
  cat /var/log/anacron_test.log
  ```

---

**4. Nettoyage**

```bash
sudo sed -i '/anacron_test/d' /etc/anacrontab
sudo rm /usr/local/bin/anacron_job.sh /var/log/anacron_test.log
sudo apt remove --purge anacron -y
```

---

## Exercice 16 : Planifier une tâche ponctuelle avec `at`

**1. Contexte & objectif**  
Contrairement à CRON qui répète, `at` permet de lancer une tâche **une seule fois** dans le futur.  
Objectif : installer `at`, planifier une exécution unique et vérifier son résultat.

---

**2. Préparation du terrain**

- Installer `at` :
  
  ```bash
  sudo apt install at -y
  ```

- Activer son service :
  
  ```bash
  sudo systemctl enable --now atd
  ```

Créer un script :

```bash
nano ~/hello_at.sh
```

Contenu :

```bash
#!/bin/bash
echo "Job at exécuté à $(date)" >> ~/hello_at.log
```

Rendre exécutable :

```bash
chmod +x ~/hello_at.sh
```

---

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier une exécution unique dans 2 minutes :
  
  ```bash
  echo "~/hello_at.sh" | at now + 2 minutes
  ```

- **Étape 2 :** Vérifier la file d’attente :
  
  ```bash
  atq
  ```

- **Étape 3 :** Après 2 minutes, vérifier le fichier :
  
  ```bash
  cat ~/hello_at.log
  ```

---

**4. Nettoyage**

```bash
rm ~/hello_at.sh ~/hello_at.log
sudo apt remove --purge at -y
```

---

## Exercice 17 : Gérer et supprimer des jobs `at`

**1. Contexte & objectif**  
Il est possible de **voir** et **supprimer** des jobs planifiés avec `atq` et `atrm`.  
Objectif : manipuler la file d’attente `at`.

---

**2. Préparation du terrain**

- Réinstaller `at` si supprimé :
  
  ```bash
  sudo apt install at -y
  sudo systemctl enable --now atd
  ```

- Créer un job dans 10 minutes :
  
  ```bash
  echo "echo 'Job à 10 min' >> ~/future.log" | at now + 10 minutes
  ```

---

**3. Étapes de l’exercice**

- **Étape 1 :** Vérifier la liste des jobs :
  
  ```bash
  atq
  ```

- **Étape 2 :** Identifier l’ID du job (par ex. `5`).

- **Étape 3 :** Supprimer le job avant exécution :
  
  ```bash
  atrm 5
  ```

- **Étape 4 :** Vérifier avec `atq` que la file est vide.

---

**4. Nettoyage**

```bash
rm ~/future.log
sudo apt remove --purge at -y
```

---

## Exercice 18 : Nettoyer automatiquement /tmp avec CRON

**1. Contexte & objectif**  
En production, on veut souvent nettoyer les fichiers temporaires trop anciens.  
Objectif : créer un script qui supprime les fichiers de plus de 1 jour dans `/tmp`.

---

**2. Préparation du terrain**  
Créer un dossier de test :

```bash
mkdir ~/tmp_test
echo "ancien" > ~/tmp_test/old.txt
sleep 2
echo "nouveau" > ~/tmp_test/new.txt
```

Changer la date du fichier `old.txt` (simuler qu’il a 2 jours) :

```bash
touch -d "2 days ago" ~/tmp_test/old.txt
```

Créer le script :

```bash
nano ~/clean_tmp.sh
```

Contenu :

```bash
#!/bin/bash
find ~/tmp_test -type f -mtime +1 -exec rm {} \;
echo "Nettoyage fait à $(date)" >> ~/clean_tmp.log
```

Rendre exécutable :

```bash
chmod +x ~/clean_tmp.sh
```

---

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier l’exécution toutes les 2 minutes :
  
  ```bash
  crontab -e
  ```
  
  Ajouter :
  
  ```
  */2 * * * * ~/clean_tmp.sh
  ```

- **Étape 2 :** Attendre 2 minutes et vérifier que `old.txt` est supprimé mais `new.txt` reste.

- **Étape 3 :** Lire le log de nettoyage :
  
  ```bash
  cat ~/clean_tmp.log
  ```

---

**4. Nettoyage**

```bash
crontab -r
rm -r ~/tmp_test ~/clean_tmp.sh ~/clean_tmp.log
```
