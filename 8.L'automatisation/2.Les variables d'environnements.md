# Partie 3 — Variables d’environnement & sorties (corrigée)

---

## Exercice 9 : Comprendre l’importance du PATH dans CRON

**1. Contexte & objectif**  
Dans un CRON, le `PATH` est réduit par rapport au shell interactif → certaines commandes échouent.  
Objectif : montrer un échec lié au `PATH`, puis corriger le problème.

**2. Préparation du terrain**  
Aucune installation externe. On va créer un petit script.

```bash
nano ~/check_date.sh
```

Contenu :

```bash
#!/bin/bash
echo "Exécution à : $(date)" >> ~/date.log
```

Rendre exécutable :

```bash
chmod +x ~/check_date.sh
```

**3. Étapes de l’exercice**

- **Étape 1 :** Créer une tâche CRON volontairement cassée (PATH trop limité) :
  
  ```
  PATH=/usr/local/bin
  * * * * * ~/check_date.sh
  ```

- **Étape 2 :** Attendre 2 minutes, constater que `~/date.log` reste vide.

- **Étape 3 :** Corriger avec un PATH complet :
  
  ```
  PATH=/usr/local/bin:/usr/bin:/bin
  * * * * * ~/check_date.sh
  ```

- **Étape 4 :** Observer que les entrées apparaissent désormais.

**4. Nettoyage**

```bash
crontab -r
rm ~/check_date.sh ~/date.log
```

---

## Exercice 10 : Utiliser MAILTO pour recevoir les sorties CRON

**1. Contexte & objectif**  
Par défaut, CRON envoie ses sorties par mail à l’utilisateur local.  
Objectif : configurer `MAILTO` et observer les mails générés.

⚠️ Nécessite un agent de mail local (MTA).

---

**2. Préparation du terrain**

- **Installer Postfix (MTA local)** :
  
  ```bash
  sudo apt update
  sudo apt install postfix -y
  ```
  
  Pendant l’installation, choisir **Site Internet** ou **Local only**.

- **Vérifier que le service est actif** :
  
  ```bash
  systemctl status postfix
  ```
  
  → Doit afficher `active (running)`.

- **Vérifier la boîte aux lettres** :
  
  ```bash
  ls -l /var/mail/
  ```
  
  → On doit voir un fichier correspondant à l’utilisateur courant.

- **Créer le script de test** :
  
  ```bash
  nano ~/mailtest.sh
  ```
  
  Contenu :
  
  ```bash
  #!/bin/bash
  echo "Rapport CRON exécuté à $(date)"
  ls /root  # génère une erreur si pas root
  ```
  
  Rendre exécutable :
  
  ```bash
  chmod +x ~/mailtest.sh
  ```

---

**3. Étapes de l’exercice**

- **Étape 1 :** Créer une crontab avec `MAILTO` :
  
  ```
  MAILTO=$USER
  * * * * * ~/mailtest.sh
  ```

- **Étape 2 :** Attendre 2 minutes, puis consulter la boîte aux lettres :
  
  ```bash
  cat /var/mail/$USER
  ```

- **Étape 3 :** Vérifier que le mail contient à la fois la sortie normale (bonjour) et l’erreur (ls: cannot open directory).

- **Étape 4 :** Modifier `MAILTO` pour un autre utilisateur local (si existant).

- **Étape 5 (variante si postfix non dispo) :**
  
  ```
  MAILTO=""
  * * * * * ~/mailtest.sh >> ~/mail_emulation.log 2>&1
  ```
  
  → La sortie n’est plus envoyée par mail, mais consignée dans un fichier.

---

**4. Nettoyage**

```bash
crontab -r
rm ~/mailtest.sh ~/mail_emulation.log 2>/dev/null
sudo apt remove --purge postfix -y
sudo apt autoremove -y
```

---

## Exercice 11 : Rediriger les sorties vers des logs personnalisés

**1. Contexte & objectif**  
Souvent, on veut éviter les mails et consigner directement la sortie des scripts dans un fichier log.  
Objectif : utiliser les redirections `>`, `>>`, `2>&1`.

**2. Préparation du terrain**  
Aucune installation requise. On crée un script :

```bash
nano ~/job.sh
```

Contenu :

```bash
#!/bin/bash
echo "Exécution du job à $(date)"
echo "Utilisateurs connectés :"
who
echo "Forçage d'une erreur :" 
ls /dossier/inexistant
```

Rendre exécutable :

```bash
chmod +x ~/job.sh
```

---

**3. Étapes de l’exercice**

- **Étape 1 :** Planifier la tâche avec sortie dans un log :
  
  ```
  * * * * * ~/job.sh >> ~/job_output.log 2>&1
  ```

- **Étape 2 :** Attendre 2 minutes puis vérifier :
  
  ```bash
  tail -n 10 ~/job_output.log
  ```

- **Étape 3 :** Observer que la sortie **et** les erreurs sont présentes.

- **Étape 4 :** Supprimer `2>&1` et constater que les erreurs ne sont plus capturées → elles partent par mail (si MTA installé).

---

**4. Nettoyage**

```bash
crontab -r
rm ~/job.sh ~/job_output.log
> /var/mail/$USER 2>/dev/null
```

---

✅ Partie 3 corrigée :

- **Exercice 9** → pas de prérequis.

- **Exercice 10** → préparation claire avec installation de `postfix` + variante sans MTA.

- **Exercice 11** → pas de prérequis, mais montre l’impact du MTA si installé.
