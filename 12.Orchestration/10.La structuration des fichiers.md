

# Exercice 1 — Boucle simple avec `with_items`

## Contexte & objectif

Vous devez créer plusieurs fichiers de test en une seule tâche, au lieu de les répéter.  
L’objectif est de découvrir `with_items`.

## Préparation

Créer une arborescence :

```
project/
 ├─ inventory.ini
 └─ ex01_with_items.yml
```

**Contenu `inventory.ini`**

```ini
[ubuntu]
localhost ansible_connection=local
```

## Étapes de l’exercice

1. Créez le playbook `ex01_with_items.yml` :

```yaml
---
- name: Create files with with_items
  hosts: ubuntu
  tasks:
    - name: Create multiple test files
      file:
        path: "/tmp/{{ item }}"
        state: touch
      with_items:
        - file1.txt
        - file2.txt
        - file3.txt
```

2. Exécutez le playbook.

3. Vérifiez que les fichiers existent.

## Nettoyage

```yaml
---
- name: Cleanup ex01
  hosts: ubuntu
  tasks:
    - name: Remove test files
      file:
        path: "/tmp/{{ item }}"
        state: absent
      with_items:
        - file1.txt
        - file2.txt
        - file3.txt
```

## Astuces & pièges

- `with_items` est très pratique pour éviter de répéter du code.

- C’est l’équivalent d’une boucle `while`, mais en **idempotent** → Ansible crée uniquement si absent.

---

# Exercice 2 — Boucle numérique avec `with_sequence`

## Contexte & objectif

Vous devez créer une série de répertoires numérotés automatiquement.

## Préparation

Arborescence identique :

```
ex02_with_sequence.yml
```

## Étapes

1. Créez le playbook :

```yaml
---
- name: Create numbered directories
  hosts: ubuntu
  tasks:
    - name: Create directories 1 to 5
      file:
        path: "/tmp/dir{{ item }}"
        state: directory
      with_sequence: start=1 end=5
```

2. Exécutez.

3. Vérifiez la présence de `/tmp/dir1 … /tmp/dir5`.

## Nettoyage

```yaml
---
- name: Cleanup ex02
  hosts: ubuntu
  tasks:
    - file:
        path: "/tmp/dir{{ item }}"
        state: absent
      with_sequence: start=1 end=5
```

## Astuces & pièges

- `with_sequence` ≈ boucle **for**.

- Attention : commence toujours à `start` et finit à `end`.

---

# Exercice 3 — Boucles imbriquées avec dictionnaire

## Contexte & objectif

Vous devez créer plusieurs utilisateurs avec leur shell associé.

## Préparation

Créer `group_vars/all.yml` :

```yaml
users:
  - { name: alice, shell: /bin/bash }
  - { name: bob, shell: /bin/zsh }
```

## Étapes

1. Playbook :

```yaml
---
- name: Create users with loop
  hosts: ubuntu
  become: yes
  tasks:
    - name: Create users
      user:
        name: "{{ item.name }}"
        shell: "{{ item.shell }}"
      loop: "{{ users }}"
```

2. Vérifiez avec :

```bash
ansible ubuntu -m command -a "getent passwd alice"
```

## Nettoyage

```yaml
---
- name: Cleanup ex03
  hosts: ubuntu
  become: yes
  tasks:
    - user:
        name: "{{ item.name }}"
        state: absent
      loop: "{{ users }}"
```

## Astuces & pièges

- `loop` est plus moderne que `with_items`.

- Utilisez un dictionnaire pour associer plusieurs propriétés.

---

# Exercice 4 — Boucle avec condition

## Contexte & objectif

Créer seulement les fichiers `.conf` parmi une liste mixte.

## Préparation

Dans `group_vars/all.yml` :

```yaml
files:
  - "a.conf"
  - "b.txt"
  - "c.conf"
```

## Étapes

1. Playbook :

```yaml
---
- name: Create only .conf files
  hosts: ubuntu
  tasks:
    - name: Create conf files
      file:
        path: "/tmp/{{ item }}"
        state: touch
      loop: "{{ files }}"
      when: item.endswith('.conf')
```

2. Vérifiez que seuls `a.conf` et `c.conf` existent.

## Nettoyage

```yaml
---
- name: Cleanup ex04
  hosts: ubuntu
  tasks:
    - file:
        path: "/tmp/{{ item }}"
        state: absent
      loop: "{{ files }}"
```

## Astuces & pièges

- Toujours utiliser `when:` pour filtrer → évite du travail inutile.

- Attention à la syntaxe Jinja2 (`item.endswith(...)`).

---

# Exercice 5 — Structuration avec `roles` et boucles

## Contexte & objectif

Appliquer une configuration de packages via un rôle avec boucle.

## Préparation

Arborescence :

```
roles/
 └─ packages/
     └─ tasks/
         └─ main.yml
group_vars/all.yml
ex05_roles.yml
```

**Contenu `group_vars/all.yml`**

```yaml
packages:
  - vim
  - curl
  - htop
```

**Contenu `roles/packages/tasks/main.yml`**

```yaml
- name: Install common packages
  apt:
    name: "{{ item }}"
    state: present
  loop: "{{ packages }}"
```

**Playbook `ex05_roles.yml`**

```yaml
---
- name: Apply package role
  hosts: ubuntu
  become: yes
  roles:
    - packages
```

## Nettoyage

```yaml
---
- name: Cleanup ex05
  hosts: ubuntu
  become: yes
  tasks:
    - apt:
        name: "{{ item }}"
        state: absent
      loop: "{{ packages }}"
```

## Astuces & pièges

- Utilisez des rôles pour éviter les playbooks trop longs.

- `group_vars` + `loop` = flexibilité totale pour gérer vos listes.

---

✅ Ces 5 exercices montrent l’évolution :

- boucle simple (`with_items`)

- boucle numérique (`with_sequence`)

- dictionnaires et `loop`

- conditions dans la boucle

- structuration avec rôles


