# # Les conditions

## Exercice 1 — Bloc conditionnel **ET** (OS Debian **ET** RAM ≥ 1 Go **ET** non-VM)

### Playbook principal — `ex01_block_and.yml`

```yaml
---
- name: Block AND: Debian AND RAM>=1024 AND not guest VM
  hosts: all
  become: true
  gather_facts: true

  vars:
    min_ram_mb: 1024

  tasks:
    # 1) On calcule chaque condition séparément (lisibilité & réutilisation)
    - name: Compute condition flags (element-by-element)
      set_fact:
        cond_os_debian: "{{ ansible_facts.os_family == 'Debian' }}"
        cond_ram_ok: "{{ (ansible_facts.memtotal_mb | int) >= min_ram_mb }}"
        cond_not_guest: "{{ ansible_facts.virtualization_role != 'guest' }}"

    # 2) Bloc exécuté SEULEMENT si TOUTES les conditions sont vraies
    - block:
        - name: Create demo directory
          file:
            path: /opt/cond_and_demo
            state: directory
            mode: "0755"

        - name: Write info file
          copy:
            dest: /opt/cond_and_demo/info.txt
            content: "Block executed: Debian & RAM>= {{ min_ram_mb }} & not guest VM"
            mode: "0644"
      when:
        - cond_os_debian        # OS = Debian-family ?
        - cond_ram_ok           # RAM >= 1024 ?
        - cond_not_guest        # machine non-guest ?
      # ↑↑↑ Chaque ligne ci-dessus correspond à un drapeau explicitement nommé.

    # 3) Résultat clair en bas du playbook
    - name: Synthesis / Résultat de l'évaluation
      debug:
        msg:
          - "cond_os_debian   = {{ cond_os_debian }}"
          - "cond_ram_ok      = {{ cond_ram_ok }} (memtotal_mb={{ ansible_facts.memtotal_mb }})"
          - "cond_not_guest   = {{ cond_not_guest }} (role={{ ansible_facts.virtualization_role | default('n/a') }})"
          - "block_executed   = {{ cond_os_debian and cond_ram_ok and cond_not_guest }}"
```

### Playbook de nettoyage — `ex01_cleanup.yml`

```yaml
---
- name: Cleanup ex01
  hosts: all
  become: true
  tasks:
    - file:
        path: /opt/cond_and_demo
        state: absent
```

**Commande**

```bash
ansible-playbook -i inventory.ini ex01_block_and.yml
```

**Vérification**

```bash
ansible all -i inventory.ini -m command -a "ls -l /opt/cond_and_demo || true"
```

**Conseils & pièges**

- Nommez vos conditions (`cond_*`) : **compréhension immédiate** et **débogage simple**.

- Les facts nécessaires sont **explicitement affichés** dans la synthèse (RAM, rôle de virtualisation).

---

## Exercice 2 — Bloc conditionnel **OU** (Distro {Debian,Ubuntu} **OU** noyau ≥ 6.x)

### Playbook principal — `ex02_block_or.yml`

```yaml
---
- name: Block OR: distro in {Debian,Ubuntu} OR kernel major >= 6
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # 1) Définir des drapeaux lisibles
    - name: Compute condition flags
      set_fact:
        cond_distro_ok: "{{ ansible_facts.distribution in ['Debian','Ubuntu'] }}"
        # Simple: on considère ">=6" si la chaîne du kernel commence par '6'
        cond_kernel_ge6: "{{ ansible_facts.kernel is search('^6') or ansible_facts.kernel is search('^Linux 6') }}"
        # NOTE: selon version d'Ansible, ansible_facts.kernel peut être juste la version, ou 'Linux <ver>'

    # 2) Bloc exécuté si AU MOINS une condition est vraie
    - block:
        - name: Create OR demo directory
          file:
            path: /opt/cond_or_demo
            state: directory
            mode: "0755"
      when: cond_distro_ok or cond_kernel_ge6

    # 3) Résultat en bas
    - name: Synthesis / Résultat
      debug:
        msg:
          - "cond_distro_ok = {{ cond_distro_ok }} (distribution={{ ansible_facts.distribution }})"
          - "cond_kernel_ge6 = {{ cond_kernel_ge6 }} (kernel={{ ansible_facts.kernel }})"
          - "block_executed = {{ cond_distro_ok or cond_kernel_ge6 }}"
```

### Playbook de nettoyage — `ex02_cleanup.yml`

```yaml
---
- name: Cleanup ex02
  hosts: all
  become: true
  tasks:
    - file:
        path: /opt/cond_or_demo
        state: absent
```

**Conseils & pièges**

- Quand vous faites des comparaisons de versions, **privilégiez** un vrai test de version si disponible. Ici, on reste pédagogique et simple (regex sur le kernel).

---

## Exercice 3 — Deux blocs exclusifs selon présence du paquet (avec nettoyage “intelligent”)

### Playbook principal — `ex03_block_pkg_presence.yml`

```yaml
---
- name: Two exclusive blocks: nginx present vs absent
  hosts: all
  become: true
  gather_facts: false

  vars:
    demo_marker: /var/tmp/nginx_installed_by_demo

  tasks:
    - name: Collect package facts
      package_facts:
        manager: auto

    - name: Compute presence flag
      set_fact:
        pkg_nginx_present: "{{ 'nginx' in (ansible_facts.packages | default({})) }}"

    # Bloc A: nginx déjà présent → on ne l'installe pas, on configure juste un marqueur
    - block:
        - name: Write marker (nginx already present)
          copy:
            dest: /var/tmp/nginx_already_present
            content: "nginx was already installed"
            mode: "0644"
      when: pkg_nginx_present

    # Bloc B: nginx absent → on installe, on met un marqueur pour cleanup
    - block:
        - name: Install nginx (demo)
          apt:
            name: nginx
            state: present
            update_cache: yes
        - name: Mark that demo installed nginx (for cleanup)
          file:
            path: "{{ demo_marker }}"
            state: touch
      when: not pkg_nginx_present

    # Résultat
    - name: Synthesis / Résultat
      debug:
        msg:
          - "pkg_nginx_present = {{ pkg_nginx_present }}"
          - "installed_by_demo = {{ (pkg_nginx_present | ternary(false, true)) }}"
```

### Playbook de nettoyage — `ex03_cleanup.yml`

```yaml
---
- name: Cleanup ex03 (remove only what demo installed)
  hosts: all
  become: true
  gather_facts: false

  vars:
    demo_marker: /var/tmp/nginx_installed_by_demo

  tasks:
    - name: If demo marker exists, purge nginx
      stat:
        path: "{{ demo_marker }}"
      register: m

    - name: Purge nginx only if installed by demo
      apt:
        name: nginx
        state: absent
        purge: yes
      when: m.stat.exists

    - name: Remove markers
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ demo_marker }}"
        - /var/tmp/nginx_already_present
```

**Vérification**

```bash
ansible all -i inventory.ini -m command -a "dpkg -l | grep -E '^ii\s+nginx' || true"
```

**Conseils & pièges**

- **Jamais** désinstaller un paquet que vous n’avez pas installé vous-même : d’où le **marker**.

- `package_facts` + condition = **contrôle précis** de vos branches (présent/absent).

---

## Exercice 4 — Bloc conditionnel sur attributs `stat` (existence, type, mode)

### Playbook principal — `ex04_block_stat.yml`

```yaml
---
- name: Block with file attributes: exists & isreg & mode==0644
  hosts: all
  become: true
  gather_facts: false

  vars:
    target_file: /etc/hosts

  tasks:
    - name: Stat target_file
      stat:
        path: "{{ target_file }}"
      register: st

    - name: Compute stat-based flags
      set_fact:
        cond_exists: "{{ st.stat.exists | default(false) }}"
        cond_isreg: "{{ st.stat.isreg | default(false) }}"
        cond_mode_0644: "{{ (st.stat.mode | string)[-4:] == '0644' if st.stat.mode is defined else false }}"

    - block:
        - name: Append custom line (only if file meets all conditions)
          lineinfile:
            path: "{{ target_file }}"
            line: "127.0.0.1 custom.local"
            create: no
      when:
        - cond_exists
        - cond_isreg
        - cond_mode_0644

    - name: Synthesis / Résultat
      debug:
        msg:
          - "exists={{ cond_exists }}, isreg={{ cond_isreg }}, mode_0644={{ cond_mode_0644 }}"
          - "block_executed = {{ cond_exists and cond_isreg and cond_mode_0644 }}"
```

### Playbook de nettoyage — `ex04_cleanup.yml`

```yaml
---
- name: Cleanup ex04
  hosts: all
  become: true
  tasks:
    - lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1 custom\.local$'
        state: absent
```

**Conseils & pièges**

- Pour comparer un mode, **comparez la chaîne sur 4 digits** : `(...mode|string)[-4:] == '0644'`.

---

## Exercice 5 — Bloc conditionnel piloté par **compte** d’items éligibles

### Playbook principal — `ex05_block_count.yml`

```yaml
---
- name: Block gated by count of eligible users
  hosts: all
  become: true

  vars:
    users:
      - { name: "alice", state: "present" }
      - { name: "bob",   state: "absent"  }
      - { name: "carol", state: "present" }

  tasks:
    - name: Pre-filter eligible users (state='present')
      set_fact:
        eligible_users: "{{ users | selectattr('state','equalto','present') | list }}"
        eligible_count: "{{ (users | selectattr('state','equalto','present') | list) | length }}"

    - block:
        - name: Create only eligible users
          user:
            name: "{{ item.name }}"
            state: present
            shell: /bin/bash
            create_home: yes
          loop: "{{ eligible_users }}"
      when: eligible_count | int > 0

    - name: Synthesis / Résultat
      debug:
        msg:
          - "eligible_count = {{ eligible_count }}"
          - "eligible_users = {{ eligible_users | map(attribute='name') | list }}"
          - "block_executed = {{ eligible_count | int > 0 }}"
```

### Playbook de nettoyage — `ex05_cleanup.yml`

```yaml
---
- name: Cleanup ex05
  hosts: all
  become: true

  vars:
    users:
      - { name: "alice", state: "present" }
      - { name: "carol", state: "present" }

  tasks:
    - name: Remove created users
      user:
        name: "{{ item.name }}"
        state: absent
        remove: yes
      loop: "{{ users }}"
```

**Conseils & pièges**

- **Pré-filtrer** avec `selectattr` + `set_fact` rend la logique **claire** et **testable**.

- Le **résumé** affiche le **compte** et la **liste** réellement traitée.


