## Les commandes Ansible Ad-hoc

## **Exercice 1 – Vérifier la connectivité SSH et l’utilisateur courant**

**Contexte.** Avant toute administration, il faut vérifier si les hôtes répondent et avec quel utilisateur on exécute les actions.

**Étape 1 – Vérifier la connectivité.**

```bash
ansible all -i inventory.ini -m ping
```

👉 Le module `ping` ne fait qu’un échange via SSH (pas ICMP). Résultat attendu : `pong`.

**Étape 2 – Vérifier l’utilisateur courant.**

```bash
ansible all -i inventory.ini -m command -a "whoami"
```

👉 Permet de savoir si vous êtes en tant qu’utilisateur normal ou déjà root.

**Astuce & piège.**

- ⚠️ Ne pas confondre `ansible -m ping` avec la commande Linux `ping`.

- ⚠️ Le module `ping` réussit même si le pare-feu bloque ICMP.

**Nettoyage.** Pas nécessaire ici.

---

## **Exercice 2 – Installer et désinstaller `htop`**

**Contexte.** Les exercices suivants peuvent utiliser des utilitaires. On commence par installer un paquet simple (`htop`), puis on le retire après.

**Étape 1 – Installer le paquet.**

```bash
ansible all -i inventory.ini -b -m apt -a "name=htop state=present update_cache=yes"
```

👉 `-b` est utilisé car l’installation d’un logiciel modifie le système et nécessite des privilèges root.

**Étape 2 – Vérifier l’installation.**

```bash
ansible all -m command -a "htop --version"
```

**Étape 3 – Nettoyer (désinstaller).**

```bash
ansible all -b -m apt -a "name=htop state=absent"
```

**Astuce & piège.**

- ✅ Toujours `-b` pour les commandes qui écrivent dans le système (installation, services, comptes système…).

- ⚠️ Ne pas oublier `update_cache=yes` au premier run pour mettre à jour la liste des paquets.

---

## **Exercice 3 – Créer puis supprimer un utilisateur applicatif**

**Contexte.** Créer un utilisateur dédié pour vos applications, puis le retirer après usage.

**Étape 1 – Créer l’utilisateur.**

```bash
ansible web -i inventory.ini -b -m user -a "name=appuser shell=/bin/bash create_home=yes"
```

👉 Création avec un home et un shell bash.

**Étape 2 – Vérifier.**

```bash
ansible web -b -m command -a "id appuser"
```

**Étape 3 – Supprimer l’utilisateur et son répertoire home.**

```bash
ansible web -b -m user -a "name=appuser state=absent remove=yes"
```

**Astuce & piège.**

- ✅ Utiliser `remove=yes` pour effacer aussi le dossier `/home/appuser`.

- ⚠️ Sans `-b`, vous auriez une erreur `Permission denied` car la gestion des comptes exige root.

---

## **Exercice 4 – Déployer un fichier de test puis le nettoyer**

**Contexte.** Tester la commande `copy` en plaçant un fichier dans `/tmp` (dossier accessible, pas besoin de dépendance externe).

**Étape 1 – Copier le fichier.**

```bash
ansible all -m copy -a "content='Ceci est un test Ansible' dest=/tmp/testfile.txt mode=0644"
```

**Étape 2 – Vérifier le contenu.**

```bash
ansible all -m command -a "cat /tmp/testfile.txt"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/testfile.txt state=absent"
```

**Astuce & piège.**

- ✅ `copy` permet de créer un fichier avec `content=` sans avoir de fichier source.

- ⚠️ Attention aux chemins `/tmp` partagés par d’autres services.

---

## **Exercice 5 – Installer, tester et retirer nginx**

**Contexte.** Exemple classique de service, mais on assure ici que nginx soit installé avant usage et retiré après.

**Étape 1 – Installer nginx.**

```bash
ansible web -b -m apt -a "name=nginx state=present update_cache=yes"
```

**Étape 2 – Vérifier qu’il fonctionne (port 80).**

```bash
ansible web -m wait_for -a "port=80 timeout=15"
```

**Étape 3 – Tester la page d’accueil.**

```bash
ansible web -m command -a "curl -I http://localhost"
```

**Étape 4 – Nettoyer (supprimer nginx).**

```bash
ansible web -b -m apt -a "name=nginx state=absent purge=yes"
```

**Astuce & piège.**

- ✅ `wait_for` permet d’attendre que le service écoute avant de tester.

- ⚠️ Utiliser `purge=yes` pour retirer aussi les fichiers de configuration et repartir propre.

## **Exercice 6 – Vérifier et redémarrer un service systemd**

**Contexte.** Les services peuvent tomber. Nous allons vérifier l’état de `cron` (déjà installé par défaut sur Debian/Ubuntu), puis le redémarrer, et enfin revenir à l’état initial.

**Étape 1 – Vérifier l’état.**

```bash
ansible all -b -m service -a "name=cron state=started"
```

**Étape 2 – Redémarrer.**

```bash
ansible all -b -m service -a "name=cron state=restarted"
```

**Étape 3 – Vérifier avec une commande.**

```bash
ansible all -b -m command -a "systemctl is-active cron"
```

**Astuce & piège.**

- ✅ Le module `service` est idempotent : si le service tourne déjà, rien ne change.

- ⚠️ Certains services diffèrent selon OS (ex. `sshd` sur RHEL au lieu de `ssh`).

---

## **Exercice 7 – Gestion de fichiers temporaires**

**Contexte.** Créer un dossier temporaire pour stocker des données puis le supprimer.

**Étape 1 – Créer un dossier.**

```bash
ansible all -b -m file -a "path=/tmp/testdir state=directory mode=0755"
```

**Étape 2 – Vérifier.**

```bash
ansible all -m command -a "ls -ld /tmp/testdir"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -b -m file -a "path=/tmp/testdir state=absent"
```

**Astuce & piège.**

- ✅ Utiliser `state=directory` pour créer un répertoire.

- ⚠️ Éviter `/tmp` pour des données sensibles : tout le monde peut y écrire.

---

## **Exercice 8 – Déployer un fichier de configuration simulé**

**Contexte.** Simuler un fichier de configuration générique (pas nginx).

**Étape 1 – Copier un fichier de configuration.**

```bash
ansible all -m copy -a "content='CONFIG=1\nDEBUG=true' dest=/tmp/app.conf mode=0644"
```

**Étape 2 – Vérifier le contenu.**

```bash
ansible all -m command -a "cat /tmp/app.conf"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/app.conf state=absent"
```

**Astuce & piège.**

- ✅ `content=` évite de préparer un fichier externe.

- ⚠️ Attention à l’échappement des retours à la ligne (`\n`).

---

## **Exercice 9 – Gestion de packages multiples**

**Contexte.** Installer deux utilitaires (`tree` et `zip`) puis les retirer.

**Étape 1 – Installer.**

```bash
ansible all -b -m apt -a "name=tree,zip state=present update_cache=yes"
```

**Étape 2 – Vérifier.**

```bash
ansible all -m command -a "tree --version"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -b -m apt -a "name=tree,zip state=absent purge=yes"
```

**Astuce & piège.**

- ✅ On peut installer plusieurs paquets en une commande.

- ⚠️ `purge=yes` efface aussi les fichiers de config.

---

## **Exercice 10 – Modifier une ligne dans un fichier**

**Contexte.** Simuler une configuration dans `/tmp/app.conf`.

**Étape 1 – Créer le fichier.**

```bash
ansible all -m copy -a "content='DEBUG=false' dest=/tmp/app.conf"
```

**Étape 2 – Modifier la valeur.**

```bash
ansible all -m lineinfile -a "path=/tmp/app.conf regexp='^DEBUG=' line='DEBUG=true'"
```

**Étape 3 – Vérifier.**

```bash
ansible all -m command -a "cat /tmp/app.conf"
```

**Étape 4 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/app.conf state=absent"
```

**Astuce & piège.**

- ✅ `regexp` permet d’éditer sans dupliquer la ligne.

- ⚠️ Si le fichier n’existe pas, `lineinfile` peut l’ignorer : utilisez `create=yes` si besoin.

---

## **Exercice 11 – Collecter des faits système**

**Contexte.** Obtenir l’espace disque de chaque serveur.

**Étape 1 – Récupérer uniquement les facts disque.**

```bash
ansible all -m setup -a "filter=ansible_mounts"
```

**Étape 2 – Vérifier.**  
Sortie JSON affichant les partitions et l’espace disponible.

**Astuce & piège.**

- ✅ `filter=` réduit la sortie et accélère la commande.

- ⚠️ La collecte complète `setup` est très verbeuse : toujours filtrer.

---

## **Exercice 12 – Vérifier un port réseau**

**Contexte.** Vérifier si le port 22 (SSH) est ouvert.

**Étape 1 – Attendre que SSH soit disponible.**

```bash
ansible all -m wait_for -a "port=22 timeout=5"
```

**Astuce & piège.**

- ✅ Utile après un reboot ou un redémarrage de service SSH.

- ⚠️ `wait_for` vérifie du point de vue de la machine cible, pas depuis votre contrôleur.

---

## **Exercice 13 – Récupérer un fichier distant**

**Contexte.** Récupérer `/etc/hosts` pour audit.

**Étape 1 – Copier le fichier localement.**

```bash
ansible all -b -m fetch -a "src=/etc/hosts dest=./hosts_audit/ flat=yes"
```

**Étape 2 – Vérifier côté contrôleur.**

```bash
ls ./hosts_audit/
```

**Astuce & piège.**

- ✅ `flat=yes` évite d’avoir un sous-dossier par hôte.

- ⚠️ Les fichiers sont récupérés avec leurs permissions originales.

---

## **Exercice 14 – Modifier plusieurs lignes d’un fichier**

**Contexte.** Ajouter un bloc de configuration à `/tmp/app.conf`.

**Étape 1 – Créer le fichier.**

```bash
ansible all -m copy -a "content='CONFIG=1' dest=/tmp/app.conf"
```

**Étape 2 – Ajouter un bloc.**

```bash
ansible all -m blockinfile -a "path=/tmp/app.conf block='
[section]
VAR1=ok
VAR2=ok
'"
```

**Étape 3 – Vérifier.**

```bash
ansible all -m command -a "cat /tmp/app.conf"
```

**Étape 4 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/app.conf state=absent"
```

**Astuce & piège.**

- ✅ `blockinfile` ajoute un bloc entier avec des marqueurs.

- ⚠️ Vérifiez que les marqueurs ne perturbent pas l’application (vous pouvez les désactiver avec `marker=`).

---

## **Exercice 15 – Redémarrage contrôlé**

**Contexte.** Appliquer des mises à jour système nécessite un reboot.

**Étape 1 – Redémarrer les machines.**

```bash
ansible all -b -m reboot -a "reboot_timeout=600"
```

**Étape 2 – Vérifier.**

```bash
ansible all -m ping
```

**Astuce & piège.**

- ✅ Le module `reboot` attend automatiquement que SSH revienne.

- ⚠️ Ajustez `reboot_timeout` pour des machines lentes (VM, cloud).

## **Exercice 16 – Exécuter une commande en parallèle contrôlée**

**Contexte.** Vous avez 10 machines et vous voulez limiter la charge SSH.

**Étape 1 – Ping avec parallélisation limitée.**

```bash
ansible all -i inventory.ini -m ping -f 2
```

👉 `-f 2` signifie qu’Ansible exécute seulement 2 connexions simultanées.

**Étape 2 – Vérifier avec une commande simple.**

```bash
ansible all -m command -a "hostname" -f 2
```

**Astuce & conseil.**

- L’option `-f` ajuste le **nombre de forks (connexions simultanées)**.

- Une valeur trop basse = exécution très lente. Trop élevée = risque de surcharger le contrôleur ou le réseau.

---

## **Exercice 17 – Limiter l’exécution à un seul hôte**

**Contexte.** Vous ne voulez pas impacter toute l’infrastructure.

**Étape 1 – Installer `tree` seulement sur un hôte.**

```bash
ansible all --limit web01 -b -m apt -a "name=tree state=present"
```

👉 `--limit web01` cible uniquement `web01` dans le groupe `all`.

**Étape 2 – Vérifier.**

```bash
ansible web01 -m command -a "tree --version"
```

**Étape 3 – Nettoyer (désinstaller).**

```bash
ansible web01 -b -m apt -a "name=tree state=absent"
```

**Astuce & conseil.**

- L’option `--limit` est très utile pour tester une action sur **un sous-ensemble d’hôtes** avant de l’appliquer globalement.

---

## **Exercice 18 – Mode simulation avec `--check`**

**Contexte.** Vous voulez savoir ce qu’Ansible ferait sans rien changer.

**Étape 1 – Simuler l’installation de `htop`.**

```bash
ansible all -b -m apt -a "name=htop state=present" --check
```

**Étape 2 – Appliquer réellement.**

```bash
ansible all -b -m apt -a "name=htop state=present"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -b -m apt -a "name=htop state=absent"
```

**Astuce & conseil.**

- `--check` = **mode simulation** (aussi appelé “dry-run”). Très utile pour éviter les surprises.

- Si vous voyez `changed=0` en mode normal, c’est que l’action était déjà appliquée.

---

## **Exercice 19 – Voir les différences avec `--diff`**

**Contexte.** Vous voulez comparer les fichiers avant/après modification.

**Étape 1 – Créer un fichier.**

```bash
ansible all -m copy -a "content='DEBUG=false' dest=/tmp/conf.ini"
```

**Étape 2 – Modifier avec affichage de la différence.**

```bash
ansible all -m lineinfile -a "path=/tmp/conf.ini regexp='^DEBUG=' line='DEBUG=true'" --diff
```

**Étape 3 – Vérifier.**

```bash
ansible all -m command -a "cat /tmp/conf.ini"
```

**Étape 4 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/conf.ini state=absent"
```

**Astuce & conseil.**

- `--diff` montre **ce qui a été changé ligne par ligne**, comme un `git diff`.

- Très pratique pour valider des changements de configuration.

---

## **Exercice 20 – Format sortie compacte avec `-o`**

**Contexte.** La sortie Ansible est verbeuse. Vous voulez un résumé.

**Étape 1 – Lister les utilisateurs actifs en mode compact.**

```bash
ansible all -m command -a "whoami" -o
```

**Astuce & conseil.**

- `-o` (`--one-line`) affiche **une seule ligne par hôte**, idéal pour un aperçu rapide.

- Très utile avec des inventaires de dizaines de machines.

---

## **Exercice 21 – Augmenter la verbosité avec `-v`**

**Contexte.** Vous avez une erreur et vous voulez comprendre pourquoi.

**Étape 1 – Lancer une commande normale.**

```bash
ansible all -m command -a "hostname"
```

**Étape 2 – Relancer avec plus de détails.**

```bash
ansible all -m command -a "hostname" -vvv
```

**Astuce & conseil.**

- `-v`, `-vv`, `-vvv` ajoutent des niveaux de **détails supplémentaires**.

- `-vvv` montre les paramètres SSH, très utile pour déboguer une connexion.

---

## **Exercice 22 – Utiliser une variable avec `-e`**

**Contexte.** Vous voulez injecter un paramètre dynamique.

**Étape 1 – Créer un fichier paramétré.**

```bash
ansible all -m copy -a "content='APP_ENV={{ env }}' dest=/tmp/env.conf" -e "env=production"
```

**Étape 2 – Vérifier.**

```bash
ansible all -m command -a "cat /tmp/env.conf"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/env.conf state=absent"
```

**Astuce & conseil.**

- `-e` permet de passer une **variable à la volée**.

- C’est une bonne pratique pour éviter de coder en dur des valeurs (ex : mot de passe, chemin).

---

## **Exercice 23 – Lancer une commande longue en asynchrone**

**Contexte.** Une tâche peut prendre du temps (ex : backup).

**Étape 1 – Lancer une commande avec un délai.**

```bash
ansible all -m shell -a "sleep 20 && echo 'done'" -B 30 -P 0
```

👉 `-B 30` = job autorisé à durer 30 secondes, `-P 0` = exécution en arrière-plan.

**Étape 2 – Vérifier le statut.**

```bash
ansible all -m async_status -a "jid=<JOB_ID>"
```

**Astuce & conseil.**

- L’asynchrone permet de ne pas bloquer votre terminal.

- Notez le `jid` (job id) pour suivre l’exécution.

---

## **Exercice 24 – Déployer une clé SSH utilisateur**

**Contexte.** Autoriser un utilisateur à se connecter par clé publique.

**Étape 1 – Créer l’utilisateur.**

```bash
ansible all -b -m user -a "name=devuser shell=/bin/bash create_home=yes"
```

**Étape 2 – Ajouter une clé SSH publique.**

```bash
ansible all -b -m authorized_key -a "user=devuser key='ssh-rsa AAAAB3Nza... test@example'"
```

**Étape 3 – Vérifier.**

```bash
ansible all -m command -a "cat /home/devuser/.ssh/authorized_keys" -u devuser
```

**Étape 4 – Nettoyer (supprimer l’utilisateur).**

```bash
ansible all -b -m user -a "name=devuser state=absent remove=yes"
```

**Astuce & conseil.**

- `authorized_key` évite d’éditer manuellement `~/.ssh/authorized_keys`.

- Toujours vérifier les permissions de `~/.ssh` (700) et `authorized_keys` (600).

---

## **Exercice 25 – Monter un répertoire temporaire avec le module `mount`**

**Contexte.** Vous voulez tester un montage sans affecter le système.

**Étape 1 – Créer un répertoire local.**

```bash
ansible all -b -m file -a "path=/mnt/testdir state=directory"
```

**Étape 2 – Monter un tmpfs.**

```bash
ansible all -b -m mount -a "path=/mnt/testdir src=tmpfs fstype=tmpfs opts=size=64m state=mounted"
```

**Étape 3 – Vérifier.**

```bash
ansible all -m command -a "mount | grep /mnt/testdir"
```

**Étape 4 – Nettoyer (démonter et retirer).**

```bash
ansible all -b -m mount -a "path=/mnt/testdir state=absent"
ansible all -b -m file -a "path=/mnt/testdir state=absent"
```

**Astuce & conseil.**

- Monter un `tmpfs` permet de tester sans toucher aux disques.

- Toujours démonter avant de supprimer le répertoire.

## **Exercice 26 – Vérifier la disponibilité mémoire (facts filtrés)**

**Contexte.** Avant de déployer une application, il faut vérifier que la machine a suffisamment de RAM.

**Étape 1 – Collecter uniquement la mémoire totale.**

```bash
ansible all -m setup -a "filter=ansible_memtotal_mb"
```

**Étape 2 – Vérifier manuellement en exécutant `free -m`.**

```bash
ansible all -m command -a "free -m"
```

**Astuce & conseil.**

- Le module `setup` fournit **des faits système**.

- Avec `filter=`, on réduit la sortie et on évite de se perdre dans trop d’informations.

---

## **Exercice 27 – Mode interactif avec `--ask-become-pass`**

**Contexte.** Parfois le mot de passe sudo n’est pas configuré en SSH sans mot de passe.

**Étape 1 – Lancer une installation en demandant le mot de passe sudo.**

```bash
ansible all -m apt -a "name=htop state=present" -b --ask-become-pass
```

**Étape 2 – Vérifier.**

```bash
ansible all -m command -a "htop --version"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -b -m apt -a "name=htop state=absent"
```

**Astuce & conseil.**

- `--ask-become-pass` est nécessaire si `sudo` demande un mot de passe.

- Pour un environnement automatisé, configurez `NOPASSWD:` dans `/etc/sudoers`.

---

## **Exercice 28 – Contrôler un fichier avec `stat`**

**Contexte.** Vérifier l’existence et les permissions d’un fichier critique.

**Étape 1 – Créer un fichier de test.**

```bash
ansible all -m copy -a "content='SECURE=1' dest=/tmp/secure.conf mode=0600"
```

**Étape 2 – Vérifier ses propriétés.**

```bash
ansible all -m stat -a "path=/tmp/secure.conf"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/secure.conf state=absent"
```

**Astuce & conseil.**

- `stat` renvoie des détails (taille, permissions, propriétaire).

- Très utile pour écrire des conditions dans des playbooks (ex. exécuter une tâche seulement si un fichier existe).

---

## **Exercice 29 – Gérer un job cron utilisateur**

**Contexte.** Automatiser une tâche de sauvegarde pour un utilisateur.

**Étape 1 – Créer un job cron.**

```bash
ansible all -b -m cron -a "name='backup job' user=root minute=0 hour=3 job='/usr/bin/tar -czf /tmp/backup.tgz /etc'"
```

**Étape 2 – Vérifier.**

```bash
ansible all -b -m command -a "crontab -l -u root | grep 'backup job'"
```

**Étape 3 – Nettoyer.**

```bash
ansible all -b -m cron -a "name='backup job' user=root state=absent"
```

**Astuce & conseil.**

- Le module `cron` permet de gérer des tâches planifiées sans éditer le fichier `/etc/crontab` à la main.

- Attention à toujours préciser l’utilisateur, sinon la tâche s’ajoute à `root` par défaut.

---

## **Exercice 30 – Déployer et restaurer un fichier avec `backup`**

**Contexte.** Vous modifiez un fichier système, mais vous voulez être sûr de pouvoir revenir en arrière.

**Étape 1 – Modifier un fichier avec sauvegarde.**

```bash
ansible all -b -m lineinfile -a "path=/etc/hosts line='127.0.0.1 test.local' backup=yes"
```

**Étape 2 – Vérifier l’ajout.**

```bash
ansible all -b -m command -a "grep test.local /etc/hosts"
```

**Étape 3 – Restaurer le fichier depuis la sauvegarde.**  
👉 Le fichier sauvegardé est placé par défaut dans le même répertoire (`/etc/hosts.XXXXXX`).

```bash
ansible all -b -m copy -a "src=/etc/hosts.* dest=/etc/hosts backup=no"
```

*(le `src` doit être ajusté selon le nom exact du fichier backup créé)*

**Astuce & conseil.**

- `backup=yes` est une **sécurité indispensable** pour des fichiers sensibles.

- Après vos tests, supprimez aussi les fichiers backup pour garder le système propre.

---

# ✅ Bilan

Nous avons maintenant **30 exercices complets** :

- **1 à 5** → bases (ping, installation, utilisateurs, fichiers simples).

- **6 à 15** → services, paquets multiples, configuration, faits système, reboot.

- **16 à 25** → options avancées (`-f`, `--limit`, `--check`, `--diff`, `-o`, `-v`, `-e`, asynchrone, clés SSH, montage).

- **26 à 30** → sécurité et administration avancée (`--ask-become-pass`, `stat`, `cron`, `backup`).
