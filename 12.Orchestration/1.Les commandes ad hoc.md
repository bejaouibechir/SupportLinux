## Les commandes Ansible Ad-hoc

## **Exercice 1 â€“ VÃ©rifier la connectivitÃ© SSH et lâ€™utilisateur courant**

**Contexte.** Avant toute administration, il faut vÃ©rifier si les hÃ´tes rÃ©pondent et avec quel utilisateur on exÃ©cute les actions.

**Ã‰tape 1 â€“ VÃ©rifier la connectivitÃ©.**

```bash
ansible all -i inventory.ini -m ping
```

ğŸ‘‰ Le module `ping` ne fait quâ€™un Ã©change via SSH (pas ICMP). RÃ©sultat attendu : `pong`.

**Ã‰tape 2 â€“ VÃ©rifier lâ€™utilisateur courant.**

```bash
ansible all -i inventory.ini -m command -a "whoami"
```

ğŸ‘‰ Permet de savoir si vous Ãªtes en tant quâ€™utilisateur normal ou dÃ©jÃ  root.

**Astuce & piÃ¨ge.**

- âš ï¸ Ne pas confondre `ansible -m ping` avec la commande Linux `ping`.

- âš ï¸ Le module `ping` rÃ©ussit mÃªme si le pare-feu bloque ICMP.

**Nettoyage.** Pas nÃ©cessaire ici.

---

## **Exercice 2 â€“ Installer et dÃ©sinstaller `htop`**

**Contexte.** Les exercices suivants peuvent utiliser des utilitaires. On commence par installer un paquet simple (`htop`), puis on le retire aprÃ¨s.

**Ã‰tape 1 â€“ Installer le paquet.**

```bash
ansible all -i inventory.ini -b -m apt -a "name=htop state=present update_cache=yes"
```

ğŸ‘‰ `-b` est utilisÃ© car lâ€™installation dâ€™un logiciel modifie le systÃ¨me et nÃ©cessite des privilÃ¨ges root.

**Ã‰tape 2 â€“ VÃ©rifier lâ€™installation.**

```bash
ansible all -m command -a "htop --version"
```

**Ã‰tape 3 â€“ Nettoyer (dÃ©sinstaller).**

```bash
ansible all -b -m apt -a "name=htop state=absent"
```

**Astuce & piÃ¨ge.**

- âœ… Toujours `-b` pour les commandes qui Ã©crivent dans le systÃ¨me (installation, services, comptes systÃ¨meâ€¦).

- âš ï¸ Ne pas oublier `update_cache=yes` au premier run pour mettre Ã  jour la liste des paquets.

---

## **Exercice 3 â€“ CrÃ©er puis supprimer un utilisateur applicatif**

**Contexte.** CrÃ©er un utilisateur dÃ©diÃ© pour vos applications, puis le retirer aprÃ¨s usage.

**Ã‰tape 1 â€“ CrÃ©er lâ€™utilisateur.**

```bash
ansible web -i inventory.ini -b -m user -a "name=appuser shell=/bin/bash create_home=yes"
```

ğŸ‘‰ CrÃ©ation avec un home et un shell bash.

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible web -b -m command -a "id appuser"
```

**Ã‰tape 3 â€“ Supprimer lâ€™utilisateur et son rÃ©pertoire home.**

```bash
ansible web -b -m user -a "name=appuser state=absent remove=yes"
```

**Astuce & piÃ¨ge.**

- âœ… Utiliser `remove=yes` pour effacer aussi le dossier `/home/appuser`.

- âš ï¸ Sans `-b`, vous auriez une erreur `Permission denied` car la gestion des comptes exige root.

---

## **Exercice 4 â€“ DÃ©ployer un fichier de test puis le nettoyer**

**Contexte.** Tester la commande `copy` en plaÃ§ant un fichier dans `/tmp` (dossier accessible, pas besoin de dÃ©pendance externe).

**Ã‰tape 1 â€“ Copier le fichier.**

```bash
ansible all -m copy -a "content='Ceci est un test Ansible' dest=/tmp/testfile.txt mode=0644"
```

**Ã‰tape 2 â€“ VÃ©rifier le contenu.**

```bash
ansible all -m command -a "cat /tmp/testfile.txt"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/testfile.txt state=absent"
```

**Astuce & piÃ¨ge.**

- âœ… `copy` permet de crÃ©er un fichier avec `content=` sans avoir de fichier source.

- âš ï¸ Attention aux chemins `/tmp` partagÃ©s par dâ€™autres services.

---

## **Exercice 5 â€“ Installer, tester et retirer nginx**

**Contexte.** Exemple classique de service, mais on assure ici que nginx soit installÃ© avant usage et retirÃ© aprÃ¨s.

**Ã‰tape 1 â€“ Installer nginx.**

```bash
ansible web -b -m apt -a "name=nginx state=present update_cache=yes"
```

**Ã‰tape 2 â€“ VÃ©rifier quâ€™il fonctionne (port 80).**

```bash
ansible web -m wait_for -a "port=80 timeout=15"
```

**Ã‰tape 3 â€“ Tester la page dâ€™accueil.**

```bash
ansible web -m command -a "curl -I http://localhost"
```

**Ã‰tape 4 â€“ Nettoyer (supprimer nginx).**

```bash
ansible web -b -m apt -a "name=nginx state=absent purge=yes"
```

**Astuce & piÃ¨ge.**

- âœ… `wait_for` permet dâ€™attendre que le service Ã©coute avant de tester.

- âš ï¸ Utiliser `purge=yes` pour retirer aussi les fichiers de configuration et repartir propre.

## **Exercice 6 â€“ VÃ©rifier et redÃ©marrer un service systemd**

**Contexte.** Les services peuvent tomber. Nous allons vÃ©rifier lâ€™Ã©tat de `cron` (dÃ©jÃ  installÃ© par dÃ©faut sur Debian/Ubuntu), puis le redÃ©marrer, et enfin revenir Ã  lâ€™Ã©tat initial.

**Ã‰tape 1 â€“ VÃ©rifier lâ€™Ã©tat.**

```bash
ansible all -b -m service -a "name=cron state=started"
```

**Ã‰tape 2 â€“ RedÃ©marrer.**

```bash
ansible all -b -m service -a "name=cron state=restarted"
```

**Ã‰tape 3 â€“ VÃ©rifier avec une commande.**

```bash
ansible all -b -m command -a "systemctl is-active cron"
```

**Astuce & piÃ¨ge.**

- âœ… Le module `service` est idempotent : si le service tourne dÃ©jÃ , rien ne change.

- âš ï¸ Certains services diffÃ¨rent selon OS (ex. `sshd` sur RHEL au lieu de `ssh`).

---

## **Exercice 7 â€“ Gestion de fichiers temporaires**

**Contexte.** CrÃ©er un dossier temporaire pour stocker des donnÃ©es puis le supprimer.

**Ã‰tape 1 â€“ CrÃ©er un dossier.**

```bash
ansible all -b -m file -a "path=/tmp/testdir state=directory mode=0755"
```

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "ls -ld /tmp/testdir"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -b -m file -a "path=/tmp/testdir state=absent"
```

**Astuce & piÃ¨ge.**

- âœ… Utiliser `state=directory` pour crÃ©er un rÃ©pertoire.

- âš ï¸ Ã‰viter `/tmp` pour des donnÃ©es sensibles : tout le monde peut y Ã©crire.

---

## **Exercice 8 â€“ DÃ©ployer un fichier de configuration simulÃ©**

**Contexte.** Simuler un fichier de configuration gÃ©nÃ©rique (pas nginx).

**Ã‰tape 1 â€“ Copier un fichier de configuration.**

```bash
ansible all -m copy -a "content='CONFIG=1\nDEBUG=true' dest=/tmp/app.conf mode=0644"
```

**Ã‰tape 2 â€“ VÃ©rifier le contenu.**

```bash
ansible all -m command -a "cat /tmp/app.conf"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/app.conf state=absent"
```

**Astuce & piÃ¨ge.**

- âœ… `content=` Ã©vite de prÃ©parer un fichier externe.

- âš ï¸ Attention Ã  lâ€™Ã©chappement des retours Ã  la ligne (`\n`).

---

## **Exercice 9 â€“ Gestion de packages multiples**

**Contexte.** Installer deux utilitaires (`tree` et `zip`) puis les retirer.

**Ã‰tape 1 â€“ Installer.**

```bash
ansible all -b -m apt -a "name=tree,zip state=present update_cache=yes"
```

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "tree --version"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -b -m apt -a "name=tree,zip state=absent purge=yes"
```

**Astuce & piÃ¨ge.**

- âœ… On peut installer plusieurs paquets en une commande.

- âš ï¸ `purge=yes` efface aussi les fichiers de config.

---

## **Exercice 10 â€“ Modifier une ligne dans un fichier**

**Contexte.** Simuler une configuration dans `/tmp/app.conf`.

**Ã‰tape 1 â€“ CrÃ©er le fichier.**

```bash
ansible all -m copy -a "content='DEBUG=false' dest=/tmp/app.conf"
```

**Ã‰tape 2 â€“ Modifier la valeur.**

```bash
ansible all -m lineinfile -a "path=/tmp/app.conf regexp='^DEBUG=' line='DEBUG=true'"
```

**Ã‰tape 3 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "cat /tmp/app.conf"
```

**Ã‰tape 4 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/app.conf state=absent"
```

**Astuce & piÃ¨ge.**

- âœ… `regexp` permet dâ€™Ã©diter sans dupliquer la ligne.

- âš ï¸ Si le fichier nâ€™existe pas, `lineinfile` peut lâ€™ignorer : utilisez `create=yes` si besoin.

---

## **Exercice 11 â€“ Collecter des faits systÃ¨me**

**Contexte.** Obtenir lâ€™espace disque de chaque serveur.

**Ã‰tape 1 â€“ RÃ©cupÃ©rer uniquement les facts disque.**

```bash
ansible all -m setup -a "filter=ansible_mounts"
```

**Ã‰tape 2 â€“ VÃ©rifier.**  
Sortie JSON affichant les partitions et lâ€™espace disponible.

**Astuce & piÃ¨ge.**

- âœ… `filter=` rÃ©duit la sortie et accÃ©lÃ¨re la commande.

- âš ï¸ La collecte complÃ¨te `setup` est trÃ¨s verbeuse : toujours filtrer.

---

## **Exercice 12 â€“ VÃ©rifier un port rÃ©seau**

**Contexte.** VÃ©rifier si le port 22 (SSH) est ouvert.

**Ã‰tape 1 â€“ Attendre que SSH soit disponible.**

```bash
ansible all -m wait_for -a "port=22 timeout=5"
```

**Astuce & piÃ¨ge.**

- âœ… Utile aprÃ¨s un reboot ou un redÃ©marrage de service SSH.

- âš ï¸ `wait_for` vÃ©rifie du point de vue de la machine cible, pas depuis votre contrÃ´leur.

---

## **Exercice 13 â€“ RÃ©cupÃ©rer un fichier distant**

**Contexte.** RÃ©cupÃ©rer `/etc/hosts` pour audit.

**Ã‰tape 1 â€“ Copier le fichier localement.**

```bash
ansible all -b -m fetch -a "src=/etc/hosts dest=./hosts_audit/ flat=yes"
```

**Ã‰tape 2 â€“ VÃ©rifier cÃ´tÃ© contrÃ´leur.**

```bash
ls ./hosts_audit/
```

**Astuce & piÃ¨ge.**

- âœ… `flat=yes` Ã©vite dâ€™avoir un sous-dossier par hÃ´te.

- âš ï¸ Les fichiers sont rÃ©cupÃ©rÃ©s avec leurs permissions originales.

---

## **Exercice 14 â€“ Modifier plusieurs lignes dâ€™un fichier**

**Contexte.** Ajouter un bloc de configuration Ã  `/tmp/app.conf`.

**Ã‰tape 1 â€“ CrÃ©er le fichier.**

```bash
ansible all -m copy -a "content='CONFIG=1' dest=/tmp/app.conf"
```

**Ã‰tape 2 â€“ Ajouter un bloc.**

```bash
ansible all -m blockinfile -a "path=/tmp/app.conf block='
[section]
VAR1=ok
VAR2=ok
'"
```

**Ã‰tape 3 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "cat /tmp/app.conf"
```

**Ã‰tape 4 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/app.conf state=absent"
```

**Astuce & piÃ¨ge.**

- âœ… `blockinfile` ajoute un bloc entier avec des marqueurs.

- âš ï¸ VÃ©rifiez que les marqueurs ne perturbent pas lâ€™application (vous pouvez les dÃ©sactiver avec `marker=`).

---

## **Exercice 15 â€“ RedÃ©marrage contrÃ´lÃ©**

**Contexte.** Appliquer des mises Ã  jour systÃ¨me nÃ©cessite un reboot.

**Ã‰tape 1 â€“ RedÃ©marrer les machines.**

```bash
ansible all -b -m reboot -a "reboot_timeout=600"
```

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible all -m ping
```

**Astuce & piÃ¨ge.**

- âœ… Le module `reboot` attend automatiquement que SSH revienne.

- âš ï¸ Ajustez `reboot_timeout` pour des machines lentes (VM, cloud).

## **Exercice 16 â€“ ExÃ©cuter une commande en parallÃ¨le contrÃ´lÃ©e**

**Contexte.** Vous avez 10 machines et vous voulez limiter la charge SSH.

**Ã‰tape 1 â€“ Ping avec parallÃ©lisation limitÃ©e.**

```bash
ansible all -i inventory.ini -m ping -f 2
```

ğŸ‘‰ `-f 2` signifie quâ€™Ansible exÃ©cute seulement 2 connexions simultanÃ©es.

**Ã‰tape 2 â€“ VÃ©rifier avec une commande simple.**

```bash
ansible all -m command -a "hostname" -f 2
```

**Astuce & conseil.**

- Lâ€™option `-f` ajuste le **nombre de forks (connexions simultanÃ©es)**.

- Une valeur trop basse = exÃ©cution trÃ¨s lente. Trop Ã©levÃ©e = risque de surcharger le contrÃ´leur ou le rÃ©seau.

---

## **Exercice 17 â€“ Limiter lâ€™exÃ©cution Ã  un seul hÃ´te**

**Contexte.** Vous ne voulez pas impacter toute lâ€™infrastructure.

**Ã‰tape 1 â€“ Installer `tree` seulement sur un hÃ´te.**

```bash
ansible all --limit web01 -b -m apt -a "name=tree state=present"
```

ğŸ‘‰ `--limit web01` cible uniquement `web01` dans le groupe `all`.

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible web01 -m command -a "tree --version"
```

**Ã‰tape 3 â€“ Nettoyer (dÃ©sinstaller).**

```bash
ansible web01 -b -m apt -a "name=tree state=absent"
```

**Astuce & conseil.**

- Lâ€™option `--limit` est trÃ¨s utile pour tester une action sur **un sous-ensemble dâ€™hÃ´tes** avant de lâ€™appliquer globalement.

---

## **Exercice 18 â€“ Mode simulation avec `--check`**

**Contexte.** Vous voulez savoir ce quâ€™Ansible ferait sans rien changer.

**Ã‰tape 1 â€“ Simuler lâ€™installation de `htop`.**

```bash
ansible all -b -m apt -a "name=htop state=present" --check
```

**Ã‰tape 2 â€“ Appliquer rÃ©ellement.**

```bash
ansible all -b -m apt -a "name=htop state=present"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -b -m apt -a "name=htop state=absent"
```

**Astuce & conseil.**

- `--check` = **mode simulation** (aussi appelÃ© â€œdry-runâ€). TrÃ¨s utile pour Ã©viter les surprises.

- Si vous voyez `changed=0` en mode normal, câ€™est que lâ€™action Ã©tait dÃ©jÃ  appliquÃ©e.

---

## **Exercice 19 â€“ Voir les diffÃ©rences avec `--diff`**

**Contexte.** Vous voulez comparer les fichiers avant/aprÃ¨s modification.

**Ã‰tape 1 â€“ CrÃ©er un fichier.**

```bash
ansible all -m copy -a "content='DEBUG=false' dest=/tmp/conf.ini"
```

**Ã‰tape 2 â€“ Modifier avec affichage de la diffÃ©rence.**

```bash
ansible all -m lineinfile -a "path=/tmp/conf.ini regexp='^DEBUG=' line='DEBUG=true'" --diff
```

**Ã‰tape 3 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "cat /tmp/conf.ini"
```

**Ã‰tape 4 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/conf.ini state=absent"
```

**Astuce & conseil.**

- `--diff` montre **ce qui a Ã©tÃ© changÃ© ligne par ligne**, comme un `git diff`.

- TrÃ¨s pratique pour valider des changements de configuration.

---

## **Exercice 20 â€“ Format sortie compacte avec `-o`**

**Contexte.** La sortie Ansible est verbeuse. Vous voulez un rÃ©sumÃ©.

**Ã‰tape 1 â€“ Lister les utilisateurs actifs en mode compact.**

```bash
ansible all -m command -a "whoami" -o
```

**Astuce & conseil.**

- `-o` (`--one-line`) affiche **une seule ligne par hÃ´te**, idÃ©al pour un aperÃ§u rapide.

- TrÃ¨s utile avec des inventaires de dizaines de machines.

---

## **Exercice 21 â€“ Augmenter la verbositÃ© avec `-v`**

**Contexte.** Vous avez une erreur et vous voulez comprendre pourquoi.

**Ã‰tape 1 â€“ Lancer une commande normale.**

```bash
ansible all -m command -a "hostname"
```

**Ã‰tape 2 â€“ Relancer avec plus de dÃ©tails.**

```bash
ansible all -m command -a "hostname" -vvv
```

**Astuce & conseil.**

- `-v`, `-vv`, `-vvv` ajoutent des niveaux de **dÃ©tails supplÃ©mentaires**.

- `-vvv` montre les paramÃ¨tres SSH, trÃ¨s utile pour dÃ©boguer une connexion.

---

## **Exercice 22 â€“ Utiliser une variable avec `-e`**

**Contexte.** Vous voulez injecter un paramÃ¨tre dynamique.

**Ã‰tape 1 â€“ CrÃ©er un fichier paramÃ©trÃ©.**

```bash
ansible all -m copy -a "content='APP_ENV={{ env }}' dest=/tmp/env.conf" -e "env=production"
```

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "cat /tmp/env.conf"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/env.conf state=absent"
```

**Astuce & conseil.**

- `-e` permet de passer une **variable Ã  la volÃ©e**.

- Câ€™est une bonne pratique pour Ã©viter de coder en dur des valeurs (ex : mot de passe, chemin).

---

## **Exercice 23 â€“ Lancer une commande longue en asynchrone**

**Contexte.** Une tÃ¢che peut prendre du temps (ex : backup).

**Ã‰tape 1 â€“ Lancer une commande avec un dÃ©lai.**

```bash
ansible all -m shell -a "sleep 20 && echo 'done'" -B 30 -P 0
```

ğŸ‘‰ `-B 30` = job autorisÃ© Ã  durer 30 secondes, `-P 0` = exÃ©cution en arriÃ¨re-plan.

**Ã‰tape 2 â€“ VÃ©rifier le statut.**

```bash
ansible all -m async_status -a "jid=<JOB_ID>"
```

**Astuce & conseil.**

- Lâ€™asynchrone permet de ne pas bloquer votre terminal.

- Notez le `jid` (job id) pour suivre lâ€™exÃ©cution.

---

## **Exercice 24 â€“ DÃ©ployer une clÃ© SSH utilisateur**

**Contexte.** Autoriser un utilisateur Ã  se connecter par clÃ© publique.

**Ã‰tape 1 â€“ CrÃ©er lâ€™utilisateur.**

```bash
ansible all -b -m user -a "name=devuser shell=/bin/bash create_home=yes"
```

**Ã‰tape 2 â€“ Ajouter une clÃ© SSH publique.**

```bash
ansible all -b -m authorized_key -a "user=devuser key='ssh-rsa AAAAB3Nza... test@example'"
```

**Ã‰tape 3 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "cat /home/devuser/.ssh/authorized_keys" -u devuser
```

**Ã‰tape 4 â€“ Nettoyer (supprimer lâ€™utilisateur).**

```bash
ansible all -b -m user -a "name=devuser state=absent remove=yes"
```

**Astuce & conseil.**

- `authorized_key` Ã©vite dâ€™Ã©diter manuellement `~/.ssh/authorized_keys`.

- Toujours vÃ©rifier les permissions de `~/.ssh` (700) et `authorized_keys` (600).

---

## **Exercice 25 â€“ Monter un rÃ©pertoire temporaire avec le module `mount`**

**Contexte.** Vous voulez tester un montage sans affecter le systÃ¨me.

**Ã‰tape 1 â€“ CrÃ©er un rÃ©pertoire local.**

```bash
ansible all -b -m file -a "path=/mnt/testdir state=directory"
```

**Ã‰tape 2 â€“ Monter un tmpfs.**

```bash
ansible all -b -m mount -a "path=/mnt/testdir src=tmpfs fstype=tmpfs opts=size=64m state=mounted"
```

**Ã‰tape 3 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "mount | grep /mnt/testdir"
```

**Ã‰tape 4 â€“ Nettoyer (dÃ©monter et retirer).**

```bash
ansible all -b -m mount -a "path=/mnt/testdir state=absent"
ansible all -b -m file -a "path=/mnt/testdir state=absent"
```

**Astuce & conseil.**

- Monter un `tmpfs` permet de tester sans toucher aux disques.

- Toujours dÃ©monter avant de supprimer le rÃ©pertoire.

## **Exercice 26 â€“ VÃ©rifier la disponibilitÃ© mÃ©moire (facts filtrÃ©s)**

**Contexte.** Avant de dÃ©ployer une application, il faut vÃ©rifier que la machine a suffisamment de RAM.

**Ã‰tape 1 â€“ Collecter uniquement la mÃ©moire totale.**

```bash
ansible all -m setup -a "filter=ansible_memtotal_mb"
```

**Ã‰tape 2 â€“ VÃ©rifier manuellement en exÃ©cutant `free -m`.**

```bash
ansible all -m command -a "free -m"
```

**Astuce & conseil.**

- Le module `setup` fournit **des faits systÃ¨me**.

- Avec `filter=`, on rÃ©duit la sortie et on Ã©vite de se perdre dans trop dâ€™informations.

---

## **Exercice 27 â€“ Mode interactif avec `--ask-become-pass`**

**Contexte.** Parfois le mot de passe sudo nâ€™est pas configurÃ© en SSH sans mot de passe.

**Ã‰tape 1 â€“ Lancer une installation en demandant le mot de passe sudo.**

```bash
ansible all -m apt -a "name=htop state=present" -b --ask-become-pass
```

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible all -m command -a "htop --version"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -b -m apt -a "name=htop state=absent"
```

**Astuce & conseil.**

- `--ask-become-pass` est nÃ©cessaire si `sudo` demande un mot de passe.

- Pour un environnement automatisÃ©, configurez `NOPASSWD:` dans `/etc/sudoers`.

---

## **Exercice 28 â€“ ContrÃ´ler un fichier avec `stat`**

**Contexte.** VÃ©rifier lâ€™existence et les permissions dâ€™un fichier critique.

**Ã‰tape 1 â€“ CrÃ©er un fichier de test.**

```bash
ansible all -m copy -a "content='SECURE=1' dest=/tmp/secure.conf mode=0600"
```

**Ã‰tape 2 â€“ VÃ©rifier ses propriÃ©tÃ©s.**

```bash
ansible all -m stat -a "path=/tmp/secure.conf"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -m file -a "path=/tmp/secure.conf state=absent"
```

**Astuce & conseil.**

- `stat` renvoie des dÃ©tails (taille, permissions, propriÃ©taire).

- TrÃ¨s utile pour Ã©crire des conditions dans des playbooks (ex. exÃ©cuter une tÃ¢che seulement si un fichier existe).

---

## **Exercice 29 â€“ GÃ©rer un job cron utilisateur**

**Contexte.** Automatiser une tÃ¢che de sauvegarde pour un utilisateur.

**Ã‰tape 1 â€“ CrÃ©er un job cron.**

```bash
ansible all -b -m cron -a "name='backup job' user=root minute=0 hour=3 job='/usr/bin/tar -czf /tmp/backup.tgz /etc'"
```

**Ã‰tape 2 â€“ VÃ©rifier.**

```bash
ansible all -b -m command -a "crontab -l -u root | grep 'backup job'"
```

**Ã‰tape 3 â€“ Nettoyer.**

```bash
ansible all -b -m cron -a "name='backup job' user=root state=absent"
```

**Astuce & conseil.**

- Le module `cron` permet de gÃ©rer des tÃ¢ches planifiÃ©es sans Ã©diter le fichier `/etc/crontab` Ã  la main.

- Attention Ã  toujours prÃ©ciser lâ€™utilisateur, sinon la tÃ¢che sâ€™ajoute Ã  `root` par dÃ©faut.

---

## **Exercice 30 â€“ DÃ©ployer et restaurer un fichier avec `backup`**

**Contexte.** Vous modifiez un fichier systÃ¨me, mais vous voulez Ãªtre sÃ»r de pouvoir revenir en arriÃ¨re.

**Ã‰tape 1 â€“ Modifier un fichier avec sauvegarde.**

```bash
ansible all -b -m lineinfile -a "path=/etc/hosts line='127.0.0.1 test.local' backup=yes"
```

**Ã‰tape 2 â€“ VÃ©rifier lâ€™ajout.**

```bash
ansible all -b -m command -a "grep test.local /etc/hosts"
```

**Ã‰tape 3 â€“ Restaurer le fichier depuis la sauvegarde.**  
ğŸ‘‰ Le fichier sauvegardÃ© est placÃ© par dÃ©faut dans le mÃªme rÃ©pertoire (`/etc/hosts.XXXXXX`).

```bash
ansible all -b -m copy -a "src=/etc/hosts.* dest=/etc/hosts backup=no"
```

*(le `src` doit Ãªtre ajustÃ© selon le nom exact du fichier backup crÃ©Ã©)*

**Astuce & conseil.**

- `backup=yes` est une **sÃ©curitÃ© indispensable** pour des fichiers sensibles.

- AprÃ¨s vos tests, supprimez aussi les fichiers backup pour garder le systÃ¨me propre.

---

# âœ… Bilan

Nous avons maintenant **30 exercices complets** :

- **1 Ã  5** â†’ bases (ping, installation, utilisateurs, fichiers simples).

- **6 Ã  15** â†’ services, paquets multiples, configuration, faits systÃ¨me, reboot.

- **16 Ã  25** â†’ options avancÃ©es (`-f`, `--limit`, `--check`, `--diff`, `-o`, `-v`, `-e`, asynchrone, clÃ©s SSH, montage).

- **26 Ã  30** â†’ sÃ©curitÃ© et administration avancÃ©e (`--ask-become-pass`, `stat`, `cron`, `backup`).
