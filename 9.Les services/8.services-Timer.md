# 

# Atelier : 2 timers systemd simples (myapp & otherapp)

## Objectifs

- Deux petits scripts Python qui écrivent un horodatage.

- Deux services **oneshot** déclenchés par des **timers** à fréquences différentes.

- Procédure simple, fiable, avec vérifs et nettoyage.

---

## 0) Préparation

```bash
sudo apt update
sudo apt install -y python3

# Utilisateur de service sans shell
sudo useradd --system --home /opt/timerapps --shell /usr/sbin/nologin timerapps

# Arborescence
sudo mkdir -p /opt/timerapps/myapp /opt/timerapps/otherapp
sudo chown -R timerapps:timerapps /opt/timerapps
```

---

## 1) Applications Python

### 1.a — `/opt/timerapps/myapp/app.py` (explications)

- Écrit une ligne dans `/var/tmp/myapp_timer.log` à chaque exécution.

- Aucune dépendance externe, tourne en une fraction de seconde.

**Fichier (sans commentaires) :**

```python
from datetime import datetime
import os

LOG = os.getenv("LOGFILE", "/var/tmp/myapp_timer.log")

def main():
    with open(LOG, "a", encoding="utf-8") as f:
        f.write(f"[myapp] executed at {datetime.now()}\n")
    print(f"[myapp] wrote to {LOG}")

if __name__ == "__main__":
    main()
```

### 1.b — `/opt/timerapps/otherapp/app.py` (explications)

- Même principe, log distinct : `/var/tmp/otherapp_timer.log`.

**Fichier (sans commentaires) :**

```python
from datetime import datetime
import os

LOG = os.getenv("LOGFILE", "/var/tmp/otherapp_timer.log")

def main():
    with open(LOG, "a", encoding="utf-8") as f:
        f.write(f"[otherapp] executed at {datetime.now()}\n")
    print(f"[otherapp] wrote to {LOG}")

if __name__ == "__main__":
    main()
```

**Droits :**

```bash
sudo chown -R timerapps:timerapps /opt/timerapps
```

---

## 2) Services systemd (oneshot)

### 2.a — `/etc/systemd/system/myapp.service` (explications)

- `[Unit]/Description` : description courte.

- `[Service]/Type=oneshot` : exécution unique à chaque déclenchement.

- `User`/`Group` : exécution sous `timerapps`.

- `WorkingDirectory` : dossier de l’app.

- `ExecStart` : lance Python sur le script.

**Fichier (sans commentaires) :**

```ini
[Unit]
Description=MyApp timer unit (oneshot)

[Service]
Type=oneshot
User=timerapps
Group=timerapps
WorkingDirectory=/opt/timerapps/myapp
ExecStart=/usr/bin/python3 /opt/timerapps/myapp/app.py
```

### 2.b — `/etc/systemd/system/otherapp.service` (explications)

- Même logique, dossier/chemin adaptés.

**Fichier (sans commentaires) :**

```ini
[Unit]
Description=OtherApp timer unit (oneshot)

[Service]
Type=oneshot
User=timerapps
Group=timerapps
WorkingDirectory=/opt/timerapps/otherapp
ExecStart=/usr/bin/python3 /opt/timerapps/otherapp/app.py
```

> *Facultatif (si tu veux changer les chemins de log sans éditer le code)* :  
> créer `/etc/default/myapp` avec `LOGFILE=/var/tmp/myapp_timer.log` puis ajouter `EnvironmentFile=-/etc/default/myapp` dans le service. Idem pour `otherapp`. (Omis ici pour rester minimal.)

---

## 3) Timers systemd

### 3.a — `/etc/systemd/system/myapp.timer` (explications)

- `[Timer]/Unit=myapp.service` : ce timer déclenche **ce** service.

- `OnActiveSec=5s` : premier run 5 s après activation (pratique en démo).

- `OnUnitActiveSec=5min` : cadence toutes les 5 minutes.

- `Persistent=true` : rattrape les exécutions manquées (machine éteinte).

- `AccuracySec=1s` : précision à 1 seconde.

- `RandomizedDelaySec=10s` : décale légèrement pour éviter l’effet “troupeau”.

**Fichier (sans commentaires) :**

```ini
[Unit]
Description=Run myapp.service every 5 minutes

[Timer]
Unit=myapp.service
OnActiveSec=5s
OnUnitActiveSec=5min
Persistent=true
AccuracySec=1s
RandomizedDelaySec=10s

[Install]
WantedBy=timers.target
```

### 3.b — `/etc/systemd/system/otherapp.timer` (explications)

- Même logique, période différente (10 minutes) et décalage différent.

**Fichier (sans commentaires) :**

```ini
[Unit]
Description=Run otherapp.service every 10 minutes

[Timer]
Unit=otherapp.service
OnActiveSec=5s
OnUnitActiveSec=10min
Persistent=true
AccuracySec=1s
RandomizedDelaySec=20s

[Install]
WantedBy=timers.target
```

---

## 4) Mise en route & vérifications

```bash
sudo systemctl daemon-reload

# Vérification syntaxe (utile pour repérer une ligne invalide)
sudo systemd-analyze verify /etc/systemd/system/myapp.timer /etc/systemd/system/otherapp.timer \
                           /etc/systemd/system/myapp.service /etc/systemd/system/otherapp.service

# Activer + démarrer les timers
sudo systemctl enable --now myapp.timer
sudo systemctl enable --now otherapp.timer

# Voir la planification
systemctl list-timers --all | grep -E 'myapp|otherapp'

# Attendre ~5–10 s (premier run), puis vérifier les logs
cat /var/tmp/myapp_timer.log
cat /var/tmp/otherapp_timer.log

# Journaux du dernier run
journalctl -u myapp.service -n 20 --no-pager
journalctl -u otherapp.service -n 20 --no-pager

# Déclenchement manuel (test à la demande)
sudo systemctl start myapp.service
sudo systemctl start otherapp.service
```

---

## 5) Variante “horaire lisible” (option)

### 5.a — myapp chaque heure pile

**Explications :** remplace la section `[Timer]` de `myapp.timer` par `OnCalendar=*:00` au lieu de l’intervalle.  
**Bloc (sans commentaires) :**

```ini
[Timer]
Unit=myapp.service
OnCalendar=*:00
Persistent=true
AccuracySec=1s
RandomizedDelaySec=10s
```

### 5.b — otherapp 2× par heure (:15 et :45)

**Bloc (sans commentaires) :**

```ini
[Timer]
Unit=otherapp.service
OnCalendar=*:15,*:45
Persistent=true
AccuracySec=1s
RandomizedDelaySec=10s
```

Astuce : voir les prochaines occurrences

```bash
systemd-analyze calendar "*:15,*:45"
```

---

## 6) Dépannage rapide

- **“Unit … has a bad unit file setting”** → il reste souvent un commentaire ou un caractère parasite **sur la même ligne** qu’une clé `clé=valeur`. Reprendre le fichier, **aucun commentaire inline**.

- **Timer ne lance rien** → vérifier le lien : `systemctl cat myapp.timer` (doit contenir `Unit=myapp.service`).

- **Chemin Python différent** → `command -v python3` et adapter `ExecStart`.

- **Voir la prochaine exécution exacte** :
  
  ```bash
  systemctl show -p NextElapseUSecRealtime myapp.timer
  systemctl list-timers --all | grep myapp
  ```

---

## 7) Nettoyage (rollback complet)

```bash
# Stop + disable
sudo systemctl disable --now myapp.timer otherapp.timer

# Supprimer timers + services
sudo rm -f /etc/systemd/system/myapp.timer /etc/systemd/system/otherapp.timer
sudo rm -f /etc/systemd/system/myapp.service /etc/systemd/system/otherapp.service
sudo systemctl daemon-reload

# Supprimer apps + logs
sudo rm -rf /opt/timerapps
sudo rm -f /var/tmp/myapp_timer.log /var/tmp/otherapp_timer.log

# Supprimer l’utilisateur
sudo userdel timerapps 2>/dev/null || true
```

---

### Résumé

- **Aucune** annotation dans les `.service/.timer` → explications **au-dessus** des fichiers.

- Deux scripts Python **simples**, deux services **oneshot**, deux timers avec **Unit=**, **OnActiveSec** + **OnUnitActiveSec**, **Persistent**, **AccuracySec**, **RandomizedDelaySec**.

- Vérifs (`list-timers`, `journalctl`) et **nettoyage** inclus.
