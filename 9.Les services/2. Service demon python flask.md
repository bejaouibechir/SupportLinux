# Service type Forking

---

## Objectif

- Démarrer un serveur Flask minimal.

- Le gérer via `systemd` avec un service **`Type=forking`** (PID file).

- Comprendre où se trouve le PID, comment démarrer/arrêter proprement.

- Nettoyer tout à la fin.

> Fonctionne tel quel sur **Debian/Ubuntu**.

---

## 1) Préparation (paquets, utilisateur, dossier)

```bash
# Flask via les paquets (pas de pip)
sudo apt update
sudo apt install -y python3 python3-flask

# Crée un compte de service non-login
sudo useradd --system --home /opt/flaskdemo --shell /usr/sbin/nologin flaskdemo

# Dossier de l’appli
sudo mkdir -p /opt/flaskdemo
sudo chown -R flaskdemo:flaskdemo /opt/flaskdemo
```

---

## 2) Application Flask (ultra-minimale)

Créer le fichier **/opt/flaskdemo/app.py**  puis configurer les droits.

```python
# /opt/flaskdemo/app.py
# Mini serveur Flask : renvoie juste un texte sur /
# Reste en avant-plan (pas de daemon ici) : c’est start-stop-daemon qui fera le fork.

from flask import Flask
app = Flask(__name__)

@app.get("/")
def hello():
    return "Hello from Flask (forking via start-stop-daemon)!\n"

if __name__ == "__main__":
    # 0.0.0.0 pour écouter sur toutes les interfaces, port 5000 par défaut
    app.run(host="0.0.0.0", port=5000)
```

```bash
sudo chown flaskdemo:flaskdemo /opt/flaskdemo/app.py
```

> Test facultatif (en manuel, avant systemd) :
> 
> ```bash
> sudo -u flaskdemo python3 /opt/flaskdemo/app.py
> # Ctrl+C pour quitter
> ```

---

## 3) Unité systemd **Type=forking** (simple et commentée)

Créer le fichier **/etc/systemd/system/flaskdemo.service** :

```ini
# /etc/systemd/system/flaskdemo.service
[Unit]
Description=Flask demo (forking via start-stop-daemon)
After=network.target

[Service]
Type=forking
User=flaskdemo
Group=flaskdemo
WorkingDirectory=/opt/flaskdemo
RuntimeDirectory=flaskdemo
PIDFile=/run/flaskdemo/flaskdemo.pid

ExecStart=/usr/sbin/start-stop-daemon \
  --start \
  --background \
  --make-pidfile \
  --pidfile /run/flaskdemo/flaskdemo.pid \
  --exec /usr/bin/python3 -- /opt/flaskdemo/app.py

ExecStop=/usr/sbin/start-stop-daemon --stop --pidfile /run/flaskdemo/flaskdemo.pid --retry 5
Restart=on-failure
RestartSec=2

[Install]
WantedBy=multi-user.target

```

### Informations associées

- **Type=forking** → indique à systemd que le processus se détache (daemonize).

- **User= / Group=** → lance le service sous un compte dédié (`flaskdemo`).

- **WorkingDirectory=** → répertoire de travail de l’application.

- **RuntimeDirectory=** → crée `/run/flaskdemo/` automatiquement, avec les bons droits.

- **PIDFile=** → permet à systemd de suivre le processus via son fichier PID.

- **ExecStart=** → `start-stop-daemon` démarre le script Python en arrière-plan.

- **ExecStop=** → arrête proprement en lisant le `PIDFile`.

- **Restart=on-failure** + **RestartSec=2** → redémarre après un crash, avec un délai de 2s.

- **WantedBy=multi-user.target** → active le service au boot dans le runlevel multi-utilisateur.



> ℹ️ Si `command -v start-stop-daemon` te renvoie `/sbin/start-stop-daemon`, ajuste ce chemin dans `ExecStart`/`ExecStop`.

---

## 4) Activer, démarrer, vérifier

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now flaskdemo
sudo systemctl status flaskdemo
```

Tests rapides :

```bash
# Depuis la machine
curl -s http://127.0.0.1:5000

# Vérifier l’écoute sur le port
sudo ss -ltnp | grep :5000

# Voir le PID utilisé par systemd (issu du PIDFile)
systemctl status flaskdemo | sed -n '1,20p'

# Logs (stdout/stderr de l'appli passent dans le journal via start-stop-daemon)
journalctl -u flaskdemo -b -e
```

---

## 5) Ce que tu viens d’illustrer (en 1 phrase)

- **`Type=forking`** : systemd considère que le **processus parent** (ici `start-stop-daemon`) **forke** en arrière-plan et **écrit un PID file** ; systemd **suit alors le PID** indiqué par `PIDFile=` pour gérer le service.

---

## 6) Nettoyage (rollback complet)

```bash
# Arrêt + désactivation
sudo systemctl disable --now flaskdemo

# Retirer l’unité et recharger systemd
sudo rm -f /etc/systemd/system/flaskdemo.service
sudo systemctl daemon-reload

# Supprimer l’appli
sudo rm -rf /opt/flaskdemo

# (Optionnel) supprimer l’utilisateur de service
sudo userdel flaskdemo

# (Optionnel) retirer le paquet Flask si tu l'avais installé uniquement pour le test
sudo apt purge -y python3-flask
sudo apt autoremove -y
```

---

## Variantes très proches (au choix)

- **Changer de port** : dans `app.py`, remplace `port=5000` par `port=8080` (ou autre), redémarre le service.

- **PHP à la place** : le serveur PHP intégré (`php -S`) tourne en avant-plan ; tu peux reprendre **exactement la même unité** en remplaçant `--exec /usr/bin/python3 -- /opt/flaskdemo/app.py` par `--exec /usr/bin/php -- -S 0.0.0.0:8000 -t /opt/phpsite` (et ajuster `WorkingDirectory`, `PIDFile`, etc.). Start-stop-daemon fera toujours le fork.
