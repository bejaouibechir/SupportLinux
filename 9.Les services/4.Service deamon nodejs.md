Voici la version **Node.js** de votre atelier, structurée comme votre exemple Flask, avec **arborescence**, **fichiers à créer**, **préparation**, **service `Type=forking`**, **tests** et **nettoyage**. Les scripts sont commentés et les informations explicatives des unités systemd sont placées **en dehors** des lignes sensibles.

---

# Service type Forking — Node.js

## Objectif

- Démarrer un serveur HTTP Node.js minimal.

- Le gérer via `systemd` avec un service **`Type=forking`** (PID file via `start-stop-daemon`).

- Comprendre où se trouve le PID, comment démarrer/arrêter proprement.

- Nettoyer tout à la fin.

> Fonctionne tel quel sur **Debian/Ubuntu**.

---

## Arborescence cible

```
/opt/nodefork/
├── app.js
└── package.json   (facultatif, utile pour référencer le projet)
```

**Fichiers à créer :**

- `/opt/nodefork/app.js` : serveur HTTP minimal, reste au **premier plan** (le fork sera fait par `start-stop-daemon`).

- `/opt/nodefork/package.json` : métadonnées simples du projet (optionnel mais conseillé).

---

## 1) Préparation (paquets, utilisateur, dossier)

```bash
# Node.js depuis les dépôts (version suffisante pour l'atelier)
sudo apt update
sudo apt install -y nodejs npm

# Crée un compte de service non-login
sudo useradd --system --home /opt/nodefork --shell /usr/sbin/nologin nodefork

# Dossier de l’appli
sudo mkdir -p /opt/nodefork
sudo chown -R nodefork:nodefork /opt/nodefork
```

---

## 2) Application Node.js (ultra-minimale)

**/opt/nodefork/app.js**

```javascript
// /opt/nodefork/app.js
// Serveur HTTP minimal. Pas de "daemonize" ici : le détachement (fork) sera assuré
// par start-stop-daemon côté systemd. Le process reste donc en avant-plan.
//
// Ce choix permet à systemd de suivre correctement le PID créé dans le pidfile.

const http = require('http');
const PORT = process.env.PORT ? parseInt(process.env.PORT, 10) : 5000;
const HOST = '0.0.0.0';

const server = http.createServer((req, res) => {
  if (req.url === '/health') {
    // Point de contrôle simple
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    return res.end('OK\n');
  }
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Hello from Node.js (forking via start-stop-daemon)!\n');
});

// Gestion élégante de l’arrêt (SIGINT/SIGTERM)
function shutdown(signal) {
  console.log(`[${new Date().toISOString()}] Received ${signal}, closing server...`);
  server.close(() => {
    console.log('Server closed. Bye.');
    process.exit(0);
  });

  // Sécurité : si ça traîne, on coupe fort après 8s
  setTimeout(() => process.exit(1), 8000).unref();
}

process.on('SIGINT',  () => shutdown('SIGINT'));
process.on('SIGTERM', () => shutdown('SIGTERM'));

server.listen(PORT, HOST, () => {
  console.log(`Listening on http://${HOST}:${PORT}`);
});
```

**/opt/nodefork/package.json** (facultatif)

```json
{
  "name": "nodefork-demo",
  "version": "1.0.0",
  "private": true,
  "description": "Demo Node.js managed by systemd Type=forking via start-stop-daemon",
  "main": "app.js",
  "license": "UNLICENSED"
}
```

```bash
sudo chown nodefork:nodefork /opt/nodefork/app.js /opt/nodefork/package.json
```

> Test facultatif (en manuel, avant systemd) :
> 
> ```bash
> sudo -u nodefork node /opt/nodefork/app.js
> # Ctrl+C pour quitter
> ```

---

## 3) Unité systemd **Type=forking**

Créer le fichier **/etc/systemd/system/nodefork.service** :

```ini
# /etc/systemd/system/nodefork.service
[Unit]
Description=Node.js demo (forking via start-stop-daemon)
After=network.target

[Service]
Type=forking
User=nodefork
Group=nodefork
WorkingDirectory=/opt/nodefork
RuntimeDirectory=nodefork
PIDFile=/run/nodefork/nodefork.pid

ExecStart=/usr/sbin/start-stop-daemon \
  --start \
  --background \
  --make-pidfile \
  --pidfile /run/nodefork/nodefork.pid \
  --exec /usr/bin/node -- /opt/nodefork/app.js

ExecStop=/usr/sbin/start-stop-daemon --stop --pidfile /run/nodefork/nodefork.pid --retry 5
Restart=on-failure
RestartSec=2

[Install]
WantedBy=multi-user.target
```

### Informations associées (hors bloc)

- **Type=forking** : `start-stop-daemon` détache le process et écrit le **PIDFile**.

- **RuntimeDirectory=nodefork** : crée `/run/nodefork/` avec les bons droits.

- **PIDFile=…** : systemd suit le PID réel du serveur Node.

- **ExecStart** : lance Node en arrière-plan via `start-stop-daemon`.

- **ExecStop** : arrêt propre basé sur le pidfile.

- **Restart=on-failure** : relance si crash.

> ℹ️ Si `command -v start-stop-daemon` renvoie `/sbin/start-stop-daemon`, adaptez le chemin dans `ExecStart`/`ExecStop`.

---

## 4) Activer, démarrer, vérifier

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now nodefork
sudo systemctl status nodefork
```

Tests rapides :

```bash
# Depuis la machine
curl -s http://127.0.0.1:5000
curl -s http://127.0.0.1:5000/health

# Vérifier l’écoute sur le port
sudo ss -ltnp | grep :5000

# Logs et PID
journalctl -u nodefork -b -e
systemctl status nodefork | sed -n '1,20p'
```

---

## 5) Nettoyage (rollback complet)

```bash
# Arrêt + désactivation
sudo systemctl disable --now nodefork

# Retirer l’unité et recharger systemd
sudo rm -f /etc/systemd/system/nodefork.service
sudo systemctl daemon-reload

# Supprimer l’appli
sudo rm -rf /opt/nodefork

# (Optionnel) supprimer l’utilisateur de service
sudo userdel nodefork

# (Optionnel) retirer npm/node si installés uniquement pour le test
# ATTENTION: cela peut supprimer des dépendances utiles à d'autres applis.
# sudo apt purge -y nodejs npm
# sudo apt autoremove -y
```

---

## Variantes proches (au choix)

- **Changer le port** : dans `app.js`, définir `PORT` via une variable d’environnement (`Environment=PORT=8080` dans l’unité) et relancer le service.

- **Journalisation** : ajouter dans l’unité `StandardOutput=journal` et `StandardError=journal` si vous souhaitez être explicite (par défaut, c’est déjà le journal).

- **Arrêt soigné** : `--retry 5` en `ExecStop` laisse jusqu’à 5 s avant un `SIGKILL`; ajustez si besoin.
