# Tr√®s bien üëç je vais vous proposer un **tutoriel pratique** pour illustrer l‚Äôusage d‚Äôun service **`Type=oneshot`** sous Linux, avec un sc√©nario **r√©aliste et p√©dagogique**.

---

# Tutoriel : Cas pratique avec un service **systemd Type=oneshot**

---

## üéØ Objectif

- D√©couvrir le type **`oneshot`**, utilis√© pour ex√©cuter une commande unique qui **ne tourne pas en continu**.

- Exemple concret : **sauvegarde manuelle d‚Äôun dossier vers /var/backups**.

- Montrer que le service s‚Äôex√©cute puis se termine.

- Activer le lancement automatique avec un **timer systemd** (bonus).

---

## 1) Pr√©paration du terrain

Cr√©er un dossier avec des fichiers de test :

```bash
mkdir -p ~/demo_data
echo "Fichier 1" > ~/demo_data/f1.txt
echo "Fichier 2" > ~/demo_data/f2.txt
sudo mkdir -p /var/backups/demo
```

---

## 2) Script de sauvegarde

Cr√©er le fichier **/usr/local/bin/demo-backup.sh** :

```bash
#!/bin/bash
# /usr/local/bin/demo-backup.sh
# Script de sauvegarde simple
# Copie ~/demo_data vers /var/backups/demo avec timestamp

set -euo pipefail

TS=$(date +%F_%H-%M-%S)
DEST="/var/backups/demo/backup_$TS"

mkdir -p "$DEST"
cp -a ~/demo_data/* "$DEST"

echo "Sauvegarde r√©alis√©e dans $DEST"
```

Rendre ex√©cutable :

```bash
sudo chmod +x /usr/local/bin/demo-backup.sh
```

---

## 3) Service systemd Type=oneshot

Cr√©er le fichier **/etc/systemd/system/demo-backup.service** :

```ini
[Unit]
Description=Sauvegarde ponctuelle du dossier demo_data
Wants=demo-backup.timer

[Service]
Type=oneshot
ExecStart=/usr/local/bin/demo-backup.sh

[Install]
WantedBy=multi-user.target
```

### Explication rapide

- **Type=oneshot** : le service s‚Äôex√©cute **une seule fois** et s‚Äôarr√™te.

- **ExecStart** : la commande de sauvegarde.

- **WantedBy=multi-user.target** : permet de l‚Äôappeler manuellement ou via un timer.

---

## 4) Tester le service

Rechargez systemd et lancez :

```bash
sudo systemctl daemon-reload
sudo systemctl start demo-backup.service
sudo systemctl status demo-backup.service
```

V√©rifier la sauvegarde :

```bash
ls -l /var/backups/demo
```

---

## 5) Bonus : Automatiser avec un timer

Cr√©er le fichier **/etc/systemd/system/demo-backup.timer** :

```ini
[Unit]
Description=Lancer la sauvegarde demo chaque jour √† minuit

[Timer]
OnCalendar=*-*-* 00:00:00
Persistent=true

[Install]
WantedBy=timers.target
```

Activer le timer :

```bash
sudo systemctl enable --now demo-backup.timer
```

V√©rifier les timers actifs :

```bash
systemctl list-timers --all
```

---

## 6) Nettoyage

Pour supprimer l‚Äôexercice :

```bash
sudo systemctl disable --now demo-backup.timer demo-backup.service
sudo rm -f /etc/systemd/system/demo-backup.{service,timer}
sudo rm -f /usr/local/bin/demo-backup.sh
sudo rm -rf /var/backups/demo
rm -rf ~/demo_data
sudo systemctl daemon-reload
```

---

## En r√©sum√©

- `Type=oneshot` est utile pour les **t√¢ches ponctuelles** (scripts de configuration, sauvegarde, initialisation).

- Un service oneshot **ne reste pas actif** : il ex√©cute sa t√¢che puis s‚Äôarr√™te.

- On peut combiner avec un **timer systemd** pour automatiser.

---

## Etude de cas N 2 Initialiser une base SQLite (table + ligne de test)

### (D√©pendance)

```bash
sudo apt update && sudo apt install -y sqlite3
```

### Script : `/usr/local/sbin/sqlite-init.sh`

```bash
#!/bin/bash
# Cr√©e /var/lib/demo.db, ajoute une table 'notes' si absente, ins√®re une ligne
set -euo pipefail
db=/var/lib/demo.db
sql=$(mktemp)
cat > "$sql" <<'EOF'
CREATE TABLE IF NOT EXISTS notes(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  msg TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO notes(msg) VALUES('hello from oneshot');
EOF
install -d -m 0755 /var/lib
/usr/bin/sqlite3 "$db" < "$sql"
rm -f "$sql"
echo "[OK] SQLite pr√™t : $db"
```

```bash
sudo chmod +x /usr/local/sbin/sqlite-init.sh
```

### Unit√© : `/etc/systemd/system/sqlite-init.service`

```ini
[Unit]
Description=SQLite initial bootstrap (oneshot)
After=local-fs.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/sqlite-init.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

### Ex√©cuter & v√©rifier

```bash
sudo systemctl daemon-reload
sudo systemctl start sqlite-init
sudo systemctl status sqlite-init
sqlite3 /var/lib/demo.db 'SELECT id,msg,created_at FROM notes;'
```

### Nettoyage

```bash
sudo systemctl disable --now sqlite-init
sudo rm -f /etc/systemd/system/sqlite-init.service
sudo systemctl daemon-reload
sudo rm -f /usr/local/sbin/sqlite-init.sh /var/lib/demo.db
```

---

## Atelier 5 ‚Äî Snapshot de configuration (backup rapide /etc ‚Üí /var/backups)

### Script : `/usr/local/sbin/etc-snapshot.sh`

```bash
#!/bin/bash
# Archive de /etc (l√©g√®re) dans /var/backups/etc-YYYYmmddHHMM.tar.gz
set -euo pipefail
ts=$(date +%Y%m%d%H%M)
dest=/var/backups
file=$dest/etc-$ts.tar.gz
mkdir -p "$dest"
# Exemples d'exclusions pour limiter la taille
tar -czf "$file" \
  --exclude='/etc/ssl/private' \
  --exclude='/etc/.git' \
  /etc
echo "[OK] Snapshot cr√©√© : $file"
```

```bash
sudo chmod +x /usr/local/sbin/etc-snapshot.sh
```

### Unit√© : `/etc/systemd/system/etc-snapshot.service`

```ini
[Unit]
Description=Quick /etc snapshot (oneshot)
After=local-fs.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/etc-snapshot.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

### Ex√©cuter & v√©rifier

```bash
sudo systemctl daemon-reload
sudo systemctl start etc-snapshot
sudo systemctl status etc-snapshot
ls -lh /var/backups/etc-*.tar.gz | tail -n 1
```

### Nettoyage

```bash
sudo systemctl disable --now etc-snapshot
sudo rm -f /etc/systemd/system/etc-snapshot.service
sudo systemctl daemon-reload
sudo rm -f /usr/local/sbin/etc-snapshot.sh /var/backups/etc-*.tar.gz
```

---

### Astuces g√©n√©rales (oneshot)

- **Idempotence** : faites que le script puisse √™tre relanc√© sans casser l‚Äô√©tat (ex. ‚Äúsi existe, ne rien faire‚Äù).

- **Logs** : tout `echo` appara√Æt dans `journalctl -u <service>`.

- **Cha√Ænage** : pour pr√©parer un autre service, ajoutez dans `[Unit]` : `Before=monservice.service` et `Wants=monservice.service`.

- **√âtat** : `RemainAfterExit=yes` garde l‚Äôunit√© *active (exited)* apr√®s succ√®s ; enlevez-le si vous pr√©f√©rez qu‚Äôelle repasse √† *inactive*.

- ```bash
  sudo systemctl enable myapp.service
  ```

- D√©marrez le service :

```bash
sudo systemctl start myapp.service
```

#### c. **V√©rifier le statut du service**

V√©rifiez que le service est bien en cours d'ex√©cution :

```bash
sudo systemctl status myapp.service
```

**

-**

#### a. **√âcrire un script de surveillance**

Cr√©ez un script qui v√©rifie si l‚Äôapplication fonctionne en arri√®re-plan et red√©marre le service si n√©cessaire.

- Cr√©ez le fichier `/usr/local/bin/check_myapp.sh` :

```bash
#!/bin/bash
if ! pgrep -f "pm2: myapp" > /dev/null
then
    echo "myapp is down, restarting it..."
    systemctl restart myapp.service
else
    echo "myapp is running"
fi
```

- Rendez le script ex√©cutable :

```bash
sudo chmod +x /usr/local/bin/check_myapp.sh
```

#### b. **Cr√©er un service `systemd` pour surveiller l'application**

Cr√©ez un fichier de service `systemd` pour ex√©cuter ce script de surveillance r√©guli√®rement.

- Cr√©ez le fichier `/etc/systemd/system/check-myapp.service` :

```ini
[Unit]
Description=Monitor and restart myapp if it crashes
After=network.target

[Service]
ExecStart=/usr/local/bin/check_myapp.sh
Restart=always  # Red√©marre le service si le script √©choue
Type=simple
User=<user>  # Remplacez <user> par l'utilisateur ad√©quat

[Install]
WantedBy=multi-user.target
```

#### c. **Configurer un timer pour surveiller r√©guli√®rement l'application**

Nous allons configurer un timer pour ex√©cuter le script de surveillance √† des intervalles r√©guliers (par exemple toutes les 5 minutes).

- Cr√©ez le fichier `/etc/systemd/system/check-myapp.timer` :

```ini
[Unit]
Description=Run check-myapp.service every 5 minutes

[Timer]
OnBootSec=2min  # Attendre 2 minutes apr√®s le d√©marrage
OnUnitActiveSec=5min  # Ex√©cuter toutes les 5 minutes

[Install]
WantedBy=timers.target
```

#### d. **Activer et d√©marrer le service et le timer**

- Rechargez `systemd` :

```bash
sudo systemctl daemon-reload
```

- Activez et d√©marrez le service et le timer de surveillance :

```bash
sudo systemctl enable check-myapp.service
sudo systemctl start check-myapp.service

sudo systemctl enable check-myapp.timer
sudo systemctl start check-myapp.timer
```

#### e. **V√©rifier le bon fonctionnement**

V√©rifiez que le service de surveillance fonctionne correctement :

```bash
sudo systemctl status check-myapp.service
sudo systemctl status check-myapp.timer
```

---

### Conclusion

Vous avez maintenant un **syst√®me complet** pour :

1. **Lancer une application Node.js** en mode *forking* √† l‚Äôaide de `pm2` et g√©r√© par `systemd`.
2. **Superviser cette application** en utilisant un second service `systemd` qui v√©rifie si l‚Äôapplication est en cours d‚Äôex√©cution toutes les 5 minutes et la red√©marre si n√©cessaire.
3. **Red√©marrer automatiquement l'application** en cas d‚Äô√©chec, assurant ainsi une haute disponibilit√©.
