excellent ğŸ‘Œ â€” on entre maintenant dans la **Partie III : Docker Compose**, cÅ“ur pratique de lâ€™**Atelier 11 â€“ Docker avancÃ©**.  
cette section va montrer **deux cas concrets** :

- ğŸ§± **Cas 1 :** usage dâ€™une **image standard** (Nginx officiel) ;

- ğŸ§° **Cas 2 :** usage dâ€™une **image personnalisÃ©e construite via Dockerfile** (application Flask).

chaque cas est complet : crÃ©ation de fichiers, explications, test, et nettoyage.

---

## DÃ©ploiement multi-conteneurs automatisÃ©

---

## ğŸ¯ Objectif

Apprendre Ã  :

- dÃ©crire un dÃ©ploiement dans un fichier `compose.yaml`,

- lancer, arrÃªter et inspecter une stack complÃ¨te avec `docker compose`,

- diffÃ©rencier les notions : *image standard* vs *image personnalisÃ©e (build)*.

---

## ğŸ§° PrÃ©-requis

- Docker Engine â‰¥ 24

- Plugin **Docker Compose v2** (inclus nativement)

- RÃ©pertoires de travail distincts :
  
  - `~/compose_nginx/`
  
  - `~/compose_flask/`

---

## ğŸªœ Cas 1 : Image standard â€” Nginx officiel

### 1ï¸âƒ£ PrÃ©parer lâ€™arborescence

```bash
mkdir -p ~/compose_nginx/html && cd ~/compose_nginx
```

CrÃ©er le fichier **`html/index.html`** :

```html
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Docker Compose Nginx</title></head>
<body>
  <h2>âœ… Nginx standard dÃ©ployÃ© via Docker Compose</h2>
</body>
</html>
```

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

services:
  web:
    image: nginx:latest
    container_name: web_nginx
    ports:
      - "8080:80"
    volumes:
      - ./html:/usr/share/nginx/html:ro
```

---

### 2ï¸âƒ£ Lancer la stack

```bash
docker compose up -d
```

VÃ©rifier :

```bash
docker ps
```

et tester dans le navigateur :

```
http://localhost:8080
```

RÃ©sultat attendu : la page *â€œâœ… Nginx standardâ€¦â€* sâ€™affiche.

---

### 3ï¸âƒ£ Analyse rapide

- `image:` â†’ on utilise directement lâ€™image `nginx:latest`.

- `ports:` â†’ mappe 8080 (local) â†’ 80 (conteneur).

- `volumes:` â†’ monte le dossier `html` local dans Nginx.

---

### 4ï¸âƒ£ Nettoyage du cas 1

```bash
docker compose down
docker volume prune -f
```

---

## ğŸªœ Cas 2 : Image personnalisÃ©e â€” Application Flask

### 1ï¸âƒ£ PrÃ©parer le projet

```bash
mkdir -p ~/compose_flask && cd ~/compose_flask
```

CrÃ©er le fichier **`app.py`** :

```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def index():
    return "<h2>ğŸš€ Application Flask dÃ©ployÃ©e via Docker Compose (image custom)</h2>"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

CrÃ©er le fichier **`requirements.txt`** :

```
flask==3.0.2
```

CrÃ©er le fichier **`Dockerfile`** :

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 5000
CMD ["python", "app.py"]
```

---

### 2ï¸âƒ£ CrÃ©er le fichier **`compose.yaml`**

```yaml
version: "3.9"

services:
  flaskapp:
    build: .
    container_name: flask_compose
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
```

---

### 3ï¸âƒ£ Construire et exÃ©cuter

```bash
docker compose up -d --build
```

VÃ©rifier :

```bash
docker ps
curl http://localhost:5000
```

RÃ©sultat attendu :

```
ğŸš€ Application Flask dÃ©ployÃ©e via Docker Compose (image custom)
```

---

### 4ï¸âƒ£ Observation

- `build: .` â†’ Compose construit lâ€™image Ã  partir du `Dockerfile` local.

- `environment:` â†’ injecte les variables dans le conteneur.

- `ports:` â†’ rend lâ€™application accessible sur le port 5000.

- `depends_on:` (non utilisÃ© ici) permettrait de gÃ©rer des dÃ©pendances (ex. DB).

---

### 5ï¸âƒ£ Nettoyage du cas 2

```bash
docker compose down
docker image prune -f
```

---

## âœ… RÃ©sumÃ© pÃ©dagogique

| Ã‰lÃ©ment       | Cas 1 (Nginx)                | Cas 2 (Flask)                |
| ------------- | ---------------------------- | ---------------------------- |
| Type dâ€™image  | Standard                     | PersonnalisÃ©e (Dockerfile)   |
| Directive clÃ© | `image:`                     | `build:`                     |
| Ports exposÃ©s | 8080 â†’ 80                    | 5000 â†’ 5000                  |
| Objectif      | Servir un contenu statique   | ExÃ©cuter une app Python      |
| VÃ©rif         | `curl http://localhost:8080` | `curl http://localhost:5000` |

---

## bonnes pratiques Docker Compose



## ğŸ¯ Objectif

Ã€ la fin de cette section, le participant saura :

- nettoyer proprement tous les conteneurs, images, volumes et rÃ©seaux crÃ©Ã©s par Compose,

- gÃ©rer les rÃ©seaux et volumes nommÃ©s pour des stacks persistantes,

- comprendre les mÃ©canismes `depends_on`, `restart`, `environment`,

- suivre de bonnes pratiques de maintenance et de debug.

---

## ğŸªœ Ã‰tape 1 â€” Visualiser les stacks actives

Lister toutes les stacks Compose :

```bash
docker compose ls
```

Lister tous les conteneurs actifs :

```bash
docker ps -a
```

Lister les images locales :

```bash
docker images
```

Lister rÃ©seaux & volumes :

```bash
docker network ls
docker volume ls
```

> ğŸ§  *Astuce :* chaque projet Compose crÃ©e **son propre rÃ©seau isolÃ©** nommÃ© `<dossier>_default` et parfois des volumes nommÃ©s si spÃ©cifiÃ©s.

---

## ğŸªœ Ã‰tape 2 â€” Nettoyage standard dâ€™un projet Compose

Depuis le dossier du projet (`~/compose_nginx` ou `~/compose_flask`) :

```bash
docker compose down
```

> Par dÃ©faut :
> 
> - supprime les conteneurs liÃ©s,
> 
> - mais garde les images et volumes.

Si tu veux tout supprimer (conteneurs + volumes + rÃ©seaux + images orphelines) :

```bash
docker compose down --volumes --rmi all
```

---

## ğŸªœ Ã‰tape 3 â€” Nettoyage global de lâ€™environnement Docker

Pour un environnement propre avant un autre atelier :

```bash
docker container prune -f
docker image prune -a -f
docker volume prune -f
docker network prune -f
docker system prune -a -f
```

> âš ï¸ `system prune -a` supprime *toutes* les images non utilisÃ©es par des conteneurs â€” idÃ©al pour un environnement de formation mais Ã  Ã©viter en production.

---

## ğŸªœ Ã‰tape 4 â€” Bonnes pratiques `docker compose`

### 4.1 Structurer un projet Compose

```
myapp/
â”œâ”€â”€ compose.yaml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ app/
â”‚   â””â”€â”€ ...
â””â”€â”€ data/
```

> - Place toujours `compose.yaml` Ã  la racine.
> 
> - Ne mets pas de fichiers secrets dans le dossier build.
> 
> - Utilise `.dockerignore` pour exclure ce qui nâ€™est pas nÃ©cessaire.

---

### 4.2 DÃ©finir un rÃ©seau dÃ©diÃ© (bon isolement)

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

networks:
  backend_net:

services:
  db:
    image: mariadb:11
    environment:
      - MYSQL_ROOT_PASSWORD=admin
    networks:
      - backend_net

  app:
    build: .
    depends_on:
      - db
    networks:
      - backend_net
```

> ğŸ”¹ `networks:` permet dâ€™Ã©viter les interfÃ©rences avec dâ€™autres stacks Compose.  
> ğŸ”¹ `depends_on:` garantit que `db` dÃ©marre avant `app`.

---

### 4.3 Utiliser des volumes nommÃ©s pour la persistance

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

volumes:
  db_data:

services:
  mariadb:
    image: mariadb:11
    environment:
      - MYSQL_ROOT_PASSWORD=admin
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"
```

> Le volume `db_data` conserve les donnÃ©es mÃªme aprÃ¨s un `docker compose down`.

VÃ©rifier :

```bash
docker volume inspect db_data
```

---

### 4.4 Ajouter une politique de redÃ©marrage

```yaml
services:
  web:
    image: nginx
    restart: always
```

> Options disponibles :
> 
> - `no` (par dÃ©faut),
> 
> - `always`,
> 
> - `on-failure`,
> 
> - `unless-stopped`.

---

### 4.5 GÃ©rer les variables dâ€™environnement

CrÃ©er le fichier **`.env`** :

```
MYSQL_ROOT_PASSWORD=admin
MYSQL_DATABASE=labdb
```

Puis dans `compose.yaml` :

```yaml
services:
  mariadb:
    image: mariadb
    env_file:
      - .env
```

> Avantage : sÃ©parer la configuration sensible du code versionnÃ©.  
> `.env` nâ€™est pas transmis dans le conteneur, mais injectÃ© comme variables dâ€™environnement au lancement.

---

## ğŸªœ Ã‰tape 5 â€” DÃ©bogage Compose

Afficher les logs de tous les services :

```bash
docker compose logs -f
```

Inspecter un service :

```bash
docker compose exec web bash
```

Lister les conteneurs gÃ©rÃ©s par Compose :

```bash
docker compose ps
```

> ğŸ§  Bon rÃ©flexe : utiliser `docker compose logs -f` pour suivre un service lors du dÃ©veloppement.

---

## ğŸ§¹ Ã‰tape 6 â€” Nettoyage final de tous les ateliers Docker

```bash
docker compose down --volumes --rmi all
docker system prune -a -f
```

excellent ğŸ‘Œ â€” câ€™est une idÃ©e trÃ¨s pÃ©dagogique : montrer **plusieurs variantes concrÃ¨tes de fichiers `docker-compose.yaml`**, chacune illustrant un mot-clÃ© ou une configuration typique diffÃ©rente.

je te propose ci-dessous **6 exemples progressifs**, chacun axÃ© sur un **concept clÃ©** du format Compose (`build`, `image`, `depends_on`, `volumes`, `networks`, `env_file`, `restart`, etc.)  
â€” tous testables indÃ©pendamment et rÃ©utilisables dans ton atelier principal.

---



## Exemples de docker compose

# 

## ğŸ§± Exemple 1 â€“ DÃ©ploiement dâ€™une image simple (cas minimal)

**Concepts illustrÃ©s :** `image`, `ports`, `container_name`

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

services:
  web:
    image: nginx:latest
    container_name: nginx_simple
    ports:
      - "8080:80"
```

ğŸ“˜ **Explications :**

- `image:` â†’ utilise directement une image existante du Docker Hub.

- `ports:` â†’ mappe le port 8080 (machine hÃ´te) vers le port 80 (conteneur).

- `container_name:` â†’ remplace le nom alÃ©atoire par un nom explicite.

---

## ğŸ§± Exemple 2 â€“ Build local dâ€™une image personnalisÃ©e

**Concepts illustrÃ©s :** `build`, `context`, `dockerfile`

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: myflask:1.0
    ports:
      - "5000:5000"
```

ğŸ“˜ **Explications :**

- `build:` â†’ indique Ã  Compose de construire lâ€™image depuis le dossier courant (`context: .`).

- `dockerfile:` â†’ permet de prÃ©ciser un fichier Dockerfile spÃ©cifique.

- `image:` â†’ nom optionnel attribuÃ© Ã  lâ€™image gÃ©nÃ©rÃ©e.

---

## ğŸ§± Exemple 3 â€“ Multi-services avec dÃ©pendance

**Concepts illustrÃ©s :** `depends_on`, `environment`, `restart`

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

services:
  db:
    image: mariadb:11
    environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_DATABASE=labdb
    restart: always

  web:
    build: .
    ports:
      - "5000:5000"
    depends_on:
      - db
```

ğŸ“˜ **Explications :**

- `depends_on:` â†’ garantit que `db` dÃ©marre avant `web`.

- `environment:` â†’ dÃ©finit les variables dâ€™environnement passÃ©es au conteneur.

- `restart: always` â†’ redÃ©marre automatiquement le conteneur en cas dâ€™arrÃªt.

---

## ğŸ§± Exemple 4 â€“ Gestion de volumes (persistance)

**Concepts illustrÃ©s :** `volumes`, `volumes:` (racine)

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

volumes:
  db_data:

services:
  mariadb:
    image: mariadb:11
    environment:
      - MYSQL_ROOT_PASSWORD=admin
    volumes:
      - db_data:/var/lib/mysql
```

ğŸ“˜ **Explications :**

- la clÃ© `volumes:` Ã  la racine dÃ©finit un volume nommÃ© (`db_data`).

- la section `volumes:` du service monte ce volume dans le conteneur.

- le volume persiste mÃªme aprÃ¨s suppression du conteneur (`docker volume ls`).

---

## ğŸ§± Exemple 5 â€“ RÃ©seaux personnalisÃ©s

**Concepts illustrÃ©s :** `networks`, `driver`, `networks:` (service)

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

networks:
  backend_net:
    driver: bridge

services:
  redis:
    image: redis:alpine
    networks:
      - backend_net

  web:
    build: .
    networks:
      - backend_net
```

ğŸ“˜ **Explications :**

- la clÃ© `networks:` crÃ©e un rÃ©seau personnalisÃ© (`backend_net`).

- chaque service qui sâ€™y connecte peut communiquer via le **nom du service** comme DNS (`redis:6379`).

- utile pour isoler des environnements (par ex. `frontend_net`, `backend_net`).

---

## ğŸ§± Exemple 6 â€“ Variables dâ€™environnement externes

**Concepts illustrÃ©s :** `.env`, `env_file`, substitution `${VAR}`

CrÃ©er le fichier **`.env`** :

```
MYSQL_ROOT_PASSWORD=admin
MYSQL_DATABASE=labdb
PORT=3306
```

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

services:
  mariadb:
    image: mariadb:11
    env_file:
      - .env
    ports:
      - "${PORT}:3306"
```

ğŸ“˜ **Explications :**

- `env_file:` â†’ charge toutes les variables du fichier `.env`.

- `${VAR}` â†’ permet de substituer des variables dans le YAML (ports, volumes, etc.).

- pratique pour **sÃ©parer la configuration du code**.

---

## ğŸ§± Exemple 7 â€“ Stack complÃ¨te Nginx + Flask + Redis

**Concepts illustrÃ©s :** composition multi-services, rÃ©seau partagÃ©, dÃ©pendances, build + image.

CrÃ©er le fichier **`compose.yaml`** :

```yaml
version: "3.9"

networks:
  app_net:

services:
  redis:
    image: redis:alpine
    networks:
      - app_net

  flaskapp:
    build: ./flask_app
    ports:
      - "5000:5000"
    depends_on:
      - redis
    networks:
      - app_net

  nginx:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - flaskapp
    networks:
      - app_net
```

ğŸ“˜ **Explications :**

- `flaskapp` communique avec `redis` via le rÃ©seau `app_net`.

- `nginx` fait office de reverse proxy frontal vers `flaskapp`.

- chaque service est isolÃ© mais reliÃ© logiquement au sein du mÃªme rÃ©seau virtuel.

---

## ğŸ§¹ Nettoyage de tous les exemples

```bash
docker compose down --volumes --rmi all
docker system prune -f
```

---

## âœ… RÃ©sumÃ© synthÃ©tique

| Mot-clÃ©                      | RÃ´le                                 | Exemple clÃ©       |
| ---------------------------- | ------------------------------------ | ----------------- |
| `image:`                     | utilise une image existante          | Ex. 1             |
| `build:`                     | construit une image locale           | Ex. 2             |
| `depends_on:`                | contrÃ´le lâ€™ordre de dÃ©marrage        | Ex. 3             |
| `environment:` / `env_file:` | variables dâ€™environnement            | Ex. 3 / 6         |
| `volumes:`                   | persistance de donnÃ©es               | Ex. 4             |
| `networks:`                  | communication interne entre services | Ex. 5 / 7         |
| `restart:`                   | politique de redÃ©marrage             | Ex. 3             |
| `ports:`                     | publication de port                  | tous les exemples |
| `${VAR}`                     | substitution dynamique               | Ex. 6             |


