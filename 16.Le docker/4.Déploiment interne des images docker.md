

# 🧱  Publication d’une image Docker personnalisée sur un serveur Nginx interne (Docker Registry privé)

---

## 🎯 Objectif

Déployer un **registre Docker interne** (privé, simple, sans cloud) hébergé sur **Nginx**,  
puis y **pousser et tirer une image personnalisée**.

Cet atelier permet de comprendre :

- le fonctionnement d’un *Docker Registry* basique,

- la structure `/v2/` utilisée par Docker,

- la configuration Nginx pour servir un dépôt local,

- et comment interagir avec ce registre via `docker push` / `docker pull`.

---

## 🧰 Pré-requis

- Debian 12 ou Ubuntu 22.04

- Paquets nécessaires :
  
  ```bash
  sudo apt update
  sudo apt install -y docker.io nginx curl
  ```

- Accès root ou sudo

- Deux machines possibles :
  
  - **serveur** (héberge Nginx + registre)
  
  - **client** (pour tester le `pull`)

> 💡 Tu peux aussi faire tout localement avec des ports différents.

---

## 🪜 Étape 1 — Créer une image personnalisée

Créer le dossier :

```bash
mkdir -p ~/mywebapp && cd ~/mywebapp
```

Créer le fichier **`index.html`** :

```html
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Image Custom Docker Registry</title></head>
<body><h2>✅ Image Docker personnalisée publiée dans un registre interne</h2></body>
</html>
```

Créer le fichier **`Dockerfile`** :

```dockerfile
FROM nginx:latest
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 8080
```

Construire l’image :

```bash
sudo docker build -t mynginx:1.0 .
```

Vérifier :

```bash
sudo docker run -d -p 8080:80 mynginx:1.0
curl http://localhost:8080
```

Résultat attendu :

```
✅ Image Docker personnalisée publiée dans un registre interne
```

---

## 🪜 Étape 2 — Préparer le répertoire du registre local

Créer le dossier :

```bash
sudo mkdir -p /var/www/html/registry/v2
```

Ce dossier va servir de dépôt accessible via HTTP.

---

## 🪜 Étape 3 — Configurer Nginx comme registre web

Créer le fichier **`/etc/nginx/sites-available/registry.conf`** :

```bash
server {
    listen 5000;
    server_name localhost;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

Activer et recharger :

```bash
sudo ln -s /etc/nginx/sites-available/registry.conf /etc/nginx/sites-enabled/
sudo systemctl restart nginx
sudo systemctl status nginx --no-pager
```

Tester l’accès :

```bash
curl http://localhost:5000/v2/
```

> ✅ Si tout va bien → `{}`  
> (Docker attend toujours une réponse JSON vide du registre `/v2/`)

---

## 🪜 Étape 4 — Taguer l’image pour le registre interne

Docker a besoin d’un *endpoint* au format `hôte:port/image:tag`.

```bash
sudo docker tag mynginx:1.0 localhost:5000/mynginx:1.0
```

Vérifie :

```bash
sudo docker images
```

---

## 🪜 Étape 5 — Autoriser les registres non sécurisés

Docker refusera le `push` HTTP par défaut.  
Il faut le déclarer comme **insecure registry** :

Modifier le fichier **`/etc/docker/daemon.json`** :

```json
{
  "insecure-registries": ["localhost:5000"]
}
```

Puis redémarrer le service Docker :

```bash
sudo systemctl restart docker
```

Vérifie :

```bash
sudo systemctl status docker --no-pager
```

---

## 🪜 Étape 6 — Publier l’image dans le registre

Pousser l’image :

```bash
sudo docker push localhost:5000/mynginx:1.0
```

> Si tout est correct :
> 
> ```
> Pushing image to localhost:5000/mynginx:1.0
> The push refers to repository [localhost:5000/mynginx]
> latest: digest: sha256:... size: ...
> ```

Tu peux vérifier sur le serveur :

```bash
sudo ls /var/www/html/registry/v2/
```

---

## 🪜 Étape 7 — Tester le téléchargement depuis une autre machine

Sur une autre machine du réseau (ou sur la même) :  
ajoute dans `/etc/docker/daemon.json` :

```json
{
  "insecure-registries": ["192.168.56.10:5000"]
}
```

(replace par l’IP de ton serveur)

Redémarre Docker :

```bash
sudo systemctl restart docker
```

Puis tire l’image :

```bash
sudo docker pull 192.168.56.10:5000/mynginx:1.0
```

Lancer :

```bash
sudo docker run -d -p 8081:80 192.168.56.10:5000/mynginx:1.0
```

Vérifie :

```bash
curl http://localhost:8081
```

✅ Résultat attendu : même page web.

---

## 🪜 Étape 8 — Option : sécuriser le registre avec HTTPS et login

### 8.1 Générer un certificat autosigné

```bash
sudo mkdir -p /etc/nginx/certs
cd /etc/nginx/certs
sudo openssl req -newkey rsa:4096 -nodes -sha256 -x509 -days 365 \
  -keyout registry.key -out registry.crt -subj "/CN=registry.local"
```

Modifier **`registry.conf`** :

```nginx
server {
    listen 5000 ssl;
    server_name registry.local;
    ssl_certificate /etc/nginx/certs/registry.crt;
    ssl_certificate_key /etc/nginx/certs/registry.key;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

### 8.2 Créer un utilisateur HTTP Basic

```bash
sudo apt install -y apache2-utils
sudo mkdir -p /etc/nginx/auth
sudo htpasswd -Bc /etc/nginx/auth/registry.passwd admin
```

Ajouter à la section `location` :

```nginx
auth_basic "Docker Registry";
auth_basic_user_file /etc/nginx/auth/registry.passwd;
```

Redémarrer Nginx :

```bash
sudo systemctl restart nginx
```

Tester :

```bash
curl -u admin:motdepasse -k https://registry.local:5000/v2/
```

✅ tu as maintenant un registre privé sécurisé et authentifié.

---

## 🧹 Étape 9 — Nettoyage du lab

```bash
sudo docker rm -f $(docker ps -aq)
sudo docker rmi -f $(docker images -q)
sudo rm -rf /var/www/html/registry
sudo rm -f /etc/docker/daemon.json
sudo systemctl restart docker
sudo rm /etc/nginx/sites-enabled/registry.conf
sudo systemctl restart nginx
```


