

# ğŸ§±  Publication dâ€™une image Docker personnalisÃ©e sur un serveur Nginx interne (Docker Registry privÃ©)

---

## ğŸ¯ Objectif

DÃ©ployer un **registre Docker interne** (privÃ©, simple, sans cloud) hÃ©bergÃ© sur **Nginx**,  
puis y **pousser et tirer une image personnalisÃ©e**.

Cet atelier permet de comprendre :

- le fonctionnement dâ€™un *Docker Registry* basique,

- la structure `/v2/` utilisÃ©e par Docker,

- la configuration Nginx pour servir un dÃ©pÃ´t local,

- et comment interagir avec ce registre via `docker push` / `docker pull`.

---

## ğŸ§° PrÃ©-requis

- Debian 12 ou Ubuntu 22.04

- Paquets nÃ©cessaires :
  
  ```bash
  sudo apt update
  sudo apt install -y docker.io nginx curl
  ```

- AccÃ¨s root ou sudo

- Deux machines possibles :
  
  - **serveur** (hÃ©berge Nginx + registre)
  
  - **client** (pour tester le `pull`)

> ğŸ’¡ Tu peux aussi faire tout localement avec des ports diffÃ©rents.

---

## ğŸªœ Ã‰tape 1 â€” CrÃ©er une image personnalisÃ©e

CrÃ©er le dossier :

```bash
mkdir -p ~/mywebapp && cd ~/mywebapp
```

CrÃ©er le fichier **`index.html`** :

```html
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Image Custom Docker Registry</title></head>
<body><h2>âœ… Image Docker personnalisÃ©e publiÃ©e dans un registre interne</h2></body>
</html>
```

CrÃ©er le fichier **`Dockerfile`** :

```dockerfile
FROM nginx:latest
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 8080
```

Construire lâ€™image :

```bash
sudo docker build -t mynginx:1.0 .
```

VÃ©rifier :

```bash
sudo docker run -d -p 8080:80 mynginx:1.0
curl http://localhost:8080
```

RÃ©sultat attendu :

```
âœ… Image Docker personnalisÃ©e publiÃ©e dans un registre interne
```

---

## ğŸªœ Ã‰tape 2 â€” PrÃ©parer le rÃ©pertoire du registre local

CrÃ©er le dossier :

```bash
sudo mkdir -p /var/www/html/registry/v2
```

Ce dossier va servir de dÃ©pÃ´t accessible via HTTP.

---

## ğŸªœ Ã‰tape 3 â€” Configurer Nginx comme registre web

CrÃ©er le fichier **`/etc/nginx/sites-available/registry.conf`** :

```bash
server {
    listen 5000;
    server_name localhost;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

Activer et recharger :

```bash
sudo ln -s /etc/nginx/sites-available/registry.conf /etc/nginx/sites-enabled/
sudo systemctl restart nginx
sudo systemctl status nginx --no-pager
```

Tester lâ€™accÃ¨s :

```bash
curl http://localhost:5000/v2/
```

> âœ… Si tout va bien â†’ `{}`  
> (Docker attend toujours une rÃ©ponse JSON vide du registre `/v2/`)

---

## ğŸªœ Ã‰tape 4 â€” Taguer lâ€™image pour le registre interne

Docker a besoin dâ€™un *endpoint* au format `hÃ´te:port/image:tag`.

```bash
sudo docker tag mynginx:1.0 localhost:5000/mynginx:1.0
```

VÃ©rifie :

```bash
sudo docker images
```

---

## ğŸªœ Ã‰tape 5 â€” Autoriser les registres non sÃ©curisÃ©s

Docker refusera le `push` HTTP par dÃ©faut.  
Il faut le dÃ©clarer comme **insecure registry** :

Modifier le fichier **`/etc/docker/daemon.json`** :

```json
{
  "insecure-registries": ["localhost:5000"]
}
```

Puis redÃ©marrer le service Docker :

```bash
sudo systemctl restart docker
```

VÃ©rifie :

```bash
sudo systemctl status docker --no-pager
```

---

## ğŸªœ Ã‰tape 6 â€” Publier lâ€™image dans le registre

Pousser lâ€™image :

```bash
sudo docker push localhost:5000/mynginx:1.0
```

> Si tout est correct :
> 
> ```
> Pushing image to localhost:5000/mynginx:1.0
> The push refers to repository [localhost:5000/mynginx]
> latest: digest: sha256:... size: ...
> ```

Tu peux vÃ©rifier sur le serveur :

```bash
sudo ls /var/www/html/registry/v2/
```

---

## ğŸªœ Ã‰tape 7 â€” Tester le tÃ©lÃ©chargement depuis une autre machine

Sur une autre machine du rÃ©seau (ou sur la mÃªme) :  
ajoute dans `/etc/docker/daemon.json` :

```json
{
  "insecure-registries": ["192.168.56.10:5000"]
}
```

(replace par lâ€™IP de ton serveur)

RedÃ©marre Docker :

```bash
sudo systemctl restart docker
```

Puis tire lâ€™image :

```bash
sudo docker pull 192.168.56.10:5000/mynginx:1.0
```

Lancer :

```bash
sudo docker run -d -p 8081:80 192.168.56.10:5000/mynginx:1.0
```

VÃ©rifie :

```bash
curl http://localhost:8081
```

âœ… RÃ©sultat attendu : mÃªme page web.

---

## ğŸªœ Ã‰tape 8 â€” Option : sÃ©curiser le registre avec HTTPS et login

### 8.1 GÃ©nÃ©rer un certificat autosignÃ©

```bash
sudo mkdir -p /etc/nginx/certs
cd /etc/nginx/certs
sudo openssl req -newkey rsa:4096 -nodes -sha256 -x509 -days 365 \
  -keyout registry.key -out registry.crt -subj "/CN=registry.local"
```

Modifier **`registry.conf`** :

```nginx
server {
    listen 5000 ssl;
    server_name registry.local;
    ssl_certificate /etc/nginx/certs/registry.crt;
    ssl_certificate_key /etc/nginx/certs/registry.key;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

### 8.2 CrÃ©er un utilisateur HTTP Basic

```bash
sudo apt install -y apache2-utils
sudo mkdir -p /etc/nginx/auth
sudo htpasswd -Bc /etc/nginx/auth/registry.passwd admin
```

Ajouter Ã  la section `location` :

```nginx
auth_basic "Docker Registry";
auth_basic_user_file /etc/nginx/auth/registry.passwd;
```

RedÃ©marrer Nginx :

```bash
sudo systemctl restart nginx
```

Tester :

```bash
curl -u admin:motdepasse -k https://registry.local:5000/v2/
```

âœ… tu as maintenant un registre privÃ© sÃ©curisÃ© et authentifiÃ©.

---

## ğŸ§¹ Ã‰tape 9 â€” Nettoyage du lab

```bash
sudo docker rm -f $(docker ps -aq)
sudo docker rmi -f $(docker images -q)
sudo rm -rf /var/www/html/registry
sudo rm -f /etc/docker/daemon.json
sudo systemctl restart docker
sudo rm /etc/nginx/sites-enabled/registry.conf
sudo systemctl restart nginx
```


