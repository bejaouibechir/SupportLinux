# üß±  Publication d‚Äôune image Docker personnalis√©e sur un serveur Nginx interne (Docker Registry priv√©)

---

## üéØ Objectif

D√©ployer un **registre Docker interne** (priv√©, simple, sans cloud) h√©berg√© sur **Nginx**,  
puis y **pousser et tirer une image personnalis√©e**.

Cet atelier permet de comprendre :

- le fonctionnement d‚Äôun *Docker Registry* basique,

- la structure `/v2/` utilis√©e par Docker,

- la configuration Nginx pour servir un d√©p√¥t local,

- et comment interagir avec ce registre via `docker push` / `docker pull`.

---

## üß∞ Pr√©-requis

- Debian 12 ou Ubuntu 22.04

- Paquets n√©cessaires :
  
  ```bash
  sudo apt update
  sudo apt install -y docker.io nginx curl
  ```

- Acc√®s root ou sudo

- Deux machines possibles :
  
  - **serveur** (h√©berge Nginx + registre)
  
  - **client** (pour tester le `pull`)

> üí° Tu peux aussi faire tout localement avec des ports diff√©rents.

- Vous avez une image locale (ex. `myapp:1.0.0`). Sinon, construisez-la :

```bash
# Construire une image locale nomm√©e myapp:1.0.0 (Dockerfile dans le r√©pertoire courant)
docker build -t myapp:1.0.0 .
```

- Vous disposez d‚Äôun **token/Personal Access Token (PAT)** sur chaque plateforme (droits ‚Äúpush/pull packages‚Äù).



## ü™ú √âtape 1 ‚Äî Cr√©er une image personnalis√©e

Cr√©er le dossier :

```bash
mkdir -p ~/mywebapp && cd ~/mywebapp
```

Cr√©er le fichier **`index.html`** :

```html
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Image Custom Docker Registry</title></head>
<body><h2>‚úÖ Image Docker personnalis√©e publi√©e dans un registre interne</h2></body>
</html>
```

Cr√©er le fichier **`Dockerfile`** :

```dockerfile
FROM nginx:latest
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 8080
```

Construire l‚Äôimage :

```bash
sudo docker build -t mynginx:1.0 .
```

V√©rifier :

```bash
sudo docker run -d -p 8080:80 mynginx:1.0
curl http://localhost:8080
```

R√©sultat attendu :

```
‚úÖ Image Docker personnalis√©e publi√©e dans un registre interne
```

---

## ü™ú √âtape 2 ‚Äî Pr√©parer le r√©pertoire du registre local

Cr√©er le dossier :

```bash
sudo mkdir -p /var/www/html/registry/v2
```

Ce dossier va servir de d√©p√¥t accessible via HTTP.

---

## ü™ú √âtape 3 ‚Äî Configurer Nginx comme registre web

Cr√©er le fichier **`/etc/nginx/sites-available/registry.conf`** :

```bash
server {
    listen 5000;
    server_name localhost;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

Activer et recharger :

```bash
sudo ln -s /etc/nginx/sites-available/registry.conf /etc/nginx/sites-enabled/
sudo systemctl restart nginx
sudo systemctl status nginx --no-pager
```

Tester l‚Äôacc√®s :

```bash
curl http://localhost:5000/v2/
```

> ‚úÖ Si tout va bien ‚Üí `{}`  
> (Docker attend toujours une r√©ponse JSON vide du registre `/v2/`)

---

## ü™ú √âtape 4 ‚Äî Taguer l‚Äôimage pour le registre interne

Docker a besoin d‚Äôun *endpoint* au format `h√¥te:port/image:tag`.

```bash
sudo docker tag mynginx:1.0 localhost:5000/mynginx:1.0
```

V√©rifie :

```bash
sudo docker images
```

---

## ü™ú √âtape 5 ‚Äî Autoriser les registres non s√©curis√©s

Docker refusera le `push` HTTP par d√©faut.  
Il faut le d√©clarer comme **insecure registry** :

Modifier le fichier **`/etc/docker/daemon.json`** :

```json
{
  "insecure-registries": ["localhost:5000"]
}
```

Puis red√©marrer le service Docker :

```bash
sudo systemctl restart docker
```

V√©rifie :

```bash
sudo systemctl status docker --no-pager
```

---

## ü™ú √âtape 6 ‚Äî Publier l‚Äôimage dans le registre

Pousser l‚Äôimage :

```bash
sudo docker push localhost:5000/mynginx:1.0
```

> Si tout est correct :
> 
> ```
> Pushing image to localhost:5000/mynginx:1.0
> The push refers to repository [localhost:5000/mynginx]
> latest: digest: sha256:... size: ...
> ```

Tu peux v√©rifier sur le serveur :

```bash
sudo ls /var/www/html/registry/v2/
```

---

## ü™ú √âtape 7 ‚Äî Tester le t√©l√©chargement depuis une autre machine

Sur une autre machine du r√©seau (ou sur la m√™me) :  
ajoute dans `/etc/docker/daemon.json` :

```json
{
  "insecure-registries": ["192.168.56.10:5000"]
}
```

(replace par l‚ÄôIP de ton serveur)

Red√©marre Docker :

```bash
sudo systemctl restart docker
```

Puis tire l‚Äôimage :

```bash
sudo docker pull 192.168.56.10:5000/mynginx:1.0
```

Lancer :

```bash
sudo docker run -d -p 8081:80 192.168.56.10:5000/mynginx:1.0
```

V√©rifie :

```bash
curl http://localhost:8081
```

‚úÖ R√©sultat attendu : m√™me page web.

---

## ü™ú √âtape 8 ‚Äî Option : s√©curiser le registre avec HTTPS et login

### 8.1 G√©n√©rer un certificat autosign√©

```bash
sudo mkdir -p /etc/nginx/certs
cd /etc/nginx/certs
sudo openssl req -newkey rsa:4096 -nodes -sha256 -x509 -days 365 \
  -keyout registry.key -out registry.crt -subj "/CN=registry.local"
```

Modifier **`registry.conf`** :

```nginx
server {
    listen 5000 ssl;
    server_name registry.local;
    ssl_certificate /etc/nginx/certs/registry.crt;
    ssl_certificate_key /etc/nginx/certs/registry.key;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

### 8.2 Cr√©er un utilisateur HTTP Basic

```bash
sudo apt install -y apache2-utils
sudo mkdir -p /etc/nginx/auth
sudo htpasswd -Bc /etc/nginx/auth/registry.passwd admin
```

Ajouter √† la section `location` :

```nginx
auth_basic "Docker Registry";
auth_basic_user_file /etc/nginx/auth/registry.passwd;
```

Red√©marrer Nginx :

```bash
sudo systemctl restart nginx
```

Tester :

```bash
curl -u admin:motdepasse -k https://registry.local:5000/v2/
```

‚úÖ tu as maintenant un registre priv√© s√©curis√© et authentifi√©.

---

## üßπ √âtape 9 ‚Äî Nettoyage du lab

```bash
sudo docker rm -f $(docker ps -aq)
sudo docker rmi -f $(docker images -q)
sudo rm -rf /var/www/html/registry
sudo rm -f /etc/docker/daemon.json
sudo systemctl restart docker
sudo rm /etc/nginx/sites-enabled/registry.conf
sudo systemctl restart nginx
```



# Docker Hub (avec token)

## 1.1 Connexion (token)

```bash
# Se connecter √† Docker Hub avec un token
# Remplacez <DOCKERHUB_USERNAME> et collez le token quand demand√©
docker login -u <DOCKERHUB_USERNAME>
# Password: <PASTE_DOCKERHUB_TOKEN>
```

## 1.2 Publication (tag + push)

```bash
# Taguer l‚Äôimage locale avec le registre Docker Hub (docker.io est implicite)
docker tag myapp:1.0.0 <DOCKERHUB_USERNAME>/myapp:1.0.0

# Pousser l‚Äôimage
docker push <DOCKERHUB_USERNAME>/myapp:1.0.0
```

## 1.3 Consommation (pull + run)

```bash
# (Optionnel) login si priv√©
docker login -u <DOCKERHUB_USERNAME>
# Pull
docker pull <DOCKERHUB_USERNAME>/myapp:1.0.0
# Ex√©cuter
docker run --rm -p 8080:8080 <DOCKERHUB_USERNAME>/myapp:1.0.0
```

---

# GitLab Container Registry (avec token)

**Nom d‚Äôimage** : `registry.gitlab.com/<NAMESPACE>/<PROJECT>/<IMAGE>:<TAG>`

## 2.1 Connexion (token)

```bash
# Username GitLab (souvent votre login GitLab)
# Le password est votre Personal Access Token (avec scope read_registry/write_registry)
docker login registry.gitlab.com -u <GITLAB_USERNAME>
# Password: <PASTE_GITLAB_TOKEN>
```

## 2.2 Publication

```bash
# Taguer pour GitLab
docker tag myapp:1.0.0 registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0

# Push
docker push registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0
```

## 2.3 Consommation

```bash
# (Si priv√©) login
docker login registry.gitlab.com -u <GITLAB_USERNAME>
# Pull
docker pull registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0
# Run
docker run --rm -p 8080:8080 registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0
```

---

# GitHub Container Registry (GHCR) (avec token)

**Nom d‚Äôimage** : `ghcr.io/<OWNER>/<IMAGE>:<TAG>`  
Le **token** doit avoir au minimum `write:packages` (push) et `read:packages` (pull).  
Le **username** est votre **compte GitHub**.

## 3.1 Connexion (token)

```bash
docker login ghcr.io -u <GITHUB_USERNAME>
# Password: <PASTE_GITHUB_PAT_WITH_PACKAGES_SCOPE>
```

## 3.2 Publication

```bash
# Tag GHCR (OWNER = user ou org GitHub)
docker tag myapp:1.0.0 ghcr.io/<OWNER>/myapp:1.0.0

# Push
docker push ghcr.io/<OWNER>/myapp:1.0.0
```

## 3.3 Consommation

```bash
# (Si priv√©) login
docker login ghcr.io -u <GITHUB_USERNAME>
# Pull
docker pull ghcr.io/<OWNER>/myapp:1.0.0
# Run
docker run --rm -p 8080:8080 ghcr.io/<OWNER>/myapp:1.0.0
```

---

# Nexus Repository Manager 3 (Docker hosted) ‚Äî proc√©dure la plus simple

Hypoth√®ses : vous avez un **repository Docker ‚Äúhosted‚Äù** configur√© sur Nexus, accessible √† l‚Äôadresse  
`nexus.example.com:5000` (port couramment utilis√© pour Docker-hosted).  
(V√©rifiez c√¥t√© Nexus : activer *Docker Bearer Token Realm*, cr√©er un repo ‚Äúdocker (hosted)‚Äù, d√©finir le **port**.)

## 4.1 Connexion

```bash
# Username = compte Nexus autoris√© (ex: deployer), Password = token/pwd Nexus
docker login nexus.example.com:5000 -u <NEXUS_USER>
# Password: <PASTE_NEXUS_TOKEN_OR_PASSWORD>
```

## 4.2 Publication

```bash
# Taguer pour votre registre Nexus
docker tag myapp:1.0.0 nexus.example.com:5000/myorg/myapp:1.0.0

# Push
docker push nexus.example.com:5000/myorg/myapp:1.0.0
```

## 4.3 Consommation

```bash
# (Si priv√©) login
docker login nexus.example.com:5000 -u <NEXUS_USER>
# Pull
docker pull nexus.example.com:5000/myorg/myapp:1.0.0
# Run
docker run --rm -p 8080:8080 nexus.example.com:5000/myorg/myapp:1.0.0
```

> üîé Si le port d√©di√© Docker hosted est diff√©rent (ex. 8082), ajustez l‚ÄôURL en cons√©quence.

---

# 5) Serveur web Nginx (distribution par archive .tar)

Ici on **ne pousse pas** dans un **registre**. On **publie** une **archive d‚Äôimage** (`docker save`) sur un **serveur web Nginx**, et les consommateurs **t√©l√©chargent** puis **chargent** l‚Äôimage (`docker load`).  
C‚Äôest pratique pour des environnements **d√©connect√©s** ou **ultra-simples**.

## 5.1 Cr√©ation de l‚Äôarchive c√¥t√© producteur

```bash
# Sauver l'image locale en archive tar
docker save myapp:1.0.0 -o myapp-1.0.0.tar

# Copier l'archive sur le serveur Nginx (ex: /usr/share/nginx/html/)
# Exemple avec scp :
scp myapp-1.0.0.tar user@nginx-host:/usr/share/nginx/html/
```

> Le fichier sera servi via `http://nginx-host/myapp-1.0.0.tar`

## 5.2 Consommation c√¥t√© client

```bash
# T√©l√©charger l‚Äôarchive
curl -fSL -o myapp-1.0.0.tar http://nginx-host/myapp-1.0.0.tar

# Charger l'image dans Docker local
docker load -i myapp-1.0.0.tar

# V√©rifier qu'elle est disponible
docker images | grep myapp

# Ex√©cuter
docker run --rm -p 8080:8080 myapp:1.0.0
```

> ‚úÖ Avantage : aucun registre requis.  
> ‚ùó Limite : pas de gestion de tags distants, pas d‚Äôauth/permissions int√©gr√©es comme un vrai registry.

---

### Astuces pro (optionnelles mais utiles)

- **D√©finir le nom complet d√®s le build** (√©conomise un `docker tag`) :
  
  ```bash
  docker build -t ghcr.io/<OWNER>/myapp:1.0.0 .
  docker push ghcr.io/<OWNER>/myapp:1.0.0
  ```

- **Stocker proprement vos identifiants** : apr√®s `docker login`, Docker √©crit un **token** dans `~/.docker/config.json`. √âvitez de partager ce fichier.

- **R√©voquer un token** (s√©curit√©) : faites-le **sur la plateforme** (Docker Hub / GitLab / GitHub / Nexus) lorsque vous n‚Äôen avez plus besoin.

- **Nettoyer local** :
  
  ```bash
  docker image prune -f     # images dangling
  docker system prune -f    # attention: supprime aussi r√©seaux non utilis√©s, caches
  ```
