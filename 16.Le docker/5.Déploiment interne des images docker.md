# 🧱  Publication d’une image Docker personnalisée sur un serveur Nginx interne (Docker Registry privé)

---

## 🎯 Objectif

Déployer un **registre Docker interne** (privé, simple, sans cloud) hébergé sur **Nginx**,  
puis y **pousser et tirer une image personnalisée**.

Cet atelier permet de comprendre :

- le fonctionnement d’un *Docker Registry* basique,

- la structure `/v2/` utilisée par Docker,

- la configuration Nginx pour servir un dépôt local,

- et comment interagir avec ce registre via `docker push` / `docker pull`.

---

## 🧰 Pré-requis

- Debian 12 ou Ubuntu 22.04

- Paquets nécessaires :
  
  ```bash
  sudo apt update
  sudo apt install -y docker.io nginx curl
  ```

- Accès root ou sudo

- Deux machines possibles :
  
  - **serveur** (héberge Nginx + registre)
  
  - **client** (pour tester le `pull`)

> 💡 Tu peux aussi faire tout localement avec des ports différents.

- Vous avez une image locale (ex. `myapp:1.0.0`). Sinon, construisez-la :

```bash
# Construire une image locale nommée myapp:1.0.0 (Dockerfile dans le répertoire courant)
docker build -t myapp:1.0.0 .
```

- Vous disposez d’un **token/Personal Access Token (PAT)** sur chaque plateforme (droits “push/pull packages”).



## 🪜 Étape 1 — Créer une image personnalisée

Créer le dossier :

```bash
mkdir -p ~/mywebapp && cd ~/mywebapp
```

Créer le fichier **`index.html`** :

```html
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Image Custom Docker Registry</title></head>
<body><h2>✅ Image Docker personnalisée publiée dans un registre interne</h2></body>
</html>
```

Créer le fichier **`Dockerfile`** :

```dockerfile
FROM nginx:latest
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 8080
```

Construire l’image :

```bash
sudo docker build -t mynginx:1.0 .
```

Vérifier :

```bash
sudo docker run -d -p 8080:80 mynginx:1.0
curl http://localhost:8080
```

Résultat attendu :

```
✅ Image Docker personnalisée publiée dans un registre interne
```

---

## 🪜 Étape 2 — Préparer le répertoire du registre local

Créer le dossier :

```bash
sudo mkdir -p /var/www/html/registry/v2
```

Ce dossier va servir de dépôt accessible via HTTP.

---

## 🪜 Étape 3 — Configurer Nginx comme registre web

Créer le fichier **`/etc/nginx/sites-available/registry.conf`** :

```bash
server {
    listen 5000;
    server_name localhost;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

Activer et recharger :

```bash
sudo ln -s /etc/nginx/sites-available/registry.conf /etc/nginx/sites-enabled/
sudo systemctl restart nginx
sudo systemctl status nginx --no-pager
```

Tester l’accès :

```bash
curl http://localhost:5000/v2/
```

> ✅ Si tout va bien → `{}`  
> (Docker attend toujours une réponse JSON vide du registre `/v2/`)

---

## 🪜 Étape 4 — Taguer l’image pour le registre interne

Docker a besoin d’un *endpoint* au format `hôte:port/image:tag`.

```bash
sudo docker tag mynginx:1.0 localhost:5000/mynginx:1.0
```

Vérifie :

```bash
sudo docker images
```

---

## 🪜 Étape 5 — Autoriser les registres non sécurisés

Docker refusera le `push` HTTP par défaut.  
Il faut le déclarer comme **insecure registry** :

Modifier le fichier **`/etc/docker/daemon.json`** :

```json
{
  "insecure-registries": ["localhost:5000"]
}
```

Puis redémarrer le service Docker :

```bash
sudo systemctl restart docker
```

Vérifie :

```bash
sudo systemctl status docker --no-pager
```

---

## 🪜 Étape 6 — Publier l’image dans le registre

Pousser l’image :

```bash
sudo docker push localhost:5000/mynginx:1.0
```

> Si tout est correct :
> 
> ```
> Pushing image to localhost:5000/mynginx:1.0
> The push refers to repository [localhost:5000/mynginx]
> latest: digest: sha256:... size: ...
> ```

Tu peux vérifier sur le serveur :

```bash
sudo ls /var/www/html/registry/v2/
```

---

## 🪜 Étape 7 — Tester le téléchargement depuis une autre machine

Sur une autre machine du réseau (ou sur la même) :  
ajoute dans `/etc/docker/daemon.json` :

```json
{
  "insecure-registries": ["192.168.56.10:5000"]
}
```

(replace par l’IP de ton serveur)

Redémarre Docker :

```bash
sudo systemctl restart docker
```

Puis tire l’image :

```bash
sudo docker pull 192.168.56.10:5000/mynginx:1.0
```

Lancer :

```bash
sudo docker run -d -p 8081:80 192.168.56.10:5000/mynginx:1.0
```

Vérifie :

```bash
curl http://localhost:8081
```

✅ Résultat attendu : même page web.

---

## 🪜 Étape 8 — Option : sécuriser le registre avec HTTPS et login

### 8.1 Générer un certificat autosigné

```bash
sudo mkdir -p /etc/nginx/certs
cd /etc/nginx/certs
sudo openssl req -newkey rsa:4096 -nodes -sha256 -x509 -days 365 \
  -keyout registry.key -out registry.crt -subj "/CN=registry.local"
```

Modifier **`registry.conf`** :

```nginx
server {
    listen 5000 ssl;
    server_name registry.local;
    ssl_certificate /etc/nginx/certs/registry.crt;
    ssl_certificate_key /etc/nginx/certs/registry.key;

    location /v2/ {
        root /var/www/html/registry;
        autoindex on;
    }
}
```

### 8.2 Créer un utilisateur HTTP Basic

```bash
sudo apt install -y apache2-utils
sudo mkdir -p /etc/nginx/auth
sudo htpasswd -Bc /etc/nginx/auth/registry.passwd admin
```

Ajouter à la section `location` :

```nginx
auth_basic "Docker Registry";
auth_basic_user_file /etc/nginx/auth/registry.passwd;
```

Redémarrer Nginx :

```bash
sudo systemctl restart nginx
```

Tester :

```bash
curl -u admin:motdepasse -k https://registry.local:5000/v2/
```

✅ tu as maintenant un registre privé sécurisé et authentifié.

---

## 🧹 Étape 9 — Nettoyage du lab

```bash
sudo docker rm -f $(docker ps -aq)
sudo docker rmi -f $(docker images -q)
sudo rm -rf /var/www/html/registry
sudo rm -f /etc/docker/daemon.json
sudo systemctl restart docker
sudo rm /etc/nginx/sites-enabled/registry.conf
sudo systemctl restart nginx
```



# Docker Hub (avec token)

## 1.1 Connexion (token)

```bash
# Se connecter à Docker Hub avec un token
# Remplacez <DOCKERHUB_USERNAME> et collez le token quand demandé
docker login -u <DOCKERHUB_USERNAME>
# Password: <PASTE_DOCKERHUB_TOKEN>
```

## 1.2 Publication (tag + push)

```bash
# Taguer l’image locale avec le registre Docker Hub (docker.io est implicite)
docker tag myapp:1.0.0 <DOCKERHUB_USERNAME>/myapp:1.0.0

# Pousser l’image
docker push <DOCKERHUB_USERNAME>/myapp:1.0.0
```

## 1.3 Consommation (pull + run)

```bash
# (Optionnel) login si privé
docker login -u <DOCKERHUB_USERNAME>
# Pull
docker pull <DOCKERHUB_USERNAME>/myapp:1.0.0
# Exécuter
docker run --rm -p 8080:8080 <DOCKERHUB_USERNAME>/myapp:1.0.0
```

---

# GitLab Container Registry (avec token)

**Nom d’image** : `registry.gitlab.com/<NAMESPACE>/<PROJECT>/<IMAGE>:<TAG>`

## 2.1 Connexion (token)

```bash
# Username GitLab (souvent votre login GitLab)
# Le password est votre Personal Access Token (avec scope read_registry/write_registry)
docker login registry.gitlab.com -u <GITLAB_USERNAME>
# Password: <PASTE_GITLAB_TOKEN>
```

## 2.2 Publication

```bash
# Taguer pour GitLab
docker tag myapp:1.0.0 registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0

# Push
docker push registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0
```

## 2.3 Consommation

```bash
# (Si privé) login
docker login registry.gitlab.com -u <GITLAB_USERNAME>
# Pull
docker pull registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0
# Run
docker run --rm -p 8080:8080 registry.gitlab.com/<NAMESPACE>/<PROJECT>/myapp:1.0.0
```

---

# GitHub Container Registry (GHCR) (avec token)

**Nom d’image** : `ghcr.io/<OWNER>/<IMAGE>:<TAG>`  
Le **token** doit avoir au minimum `write:packages` (push) et `read:packages` (pull).  
Le **username** est votre **compte GitHub**.

## 3.1 Connexion (token)

```bash
docker login ghcr.io -u <GITHUB_USERNAME>
# Password: <PASTE_GITHUB_PAT_WITH_PACKAGES_SCOPE>
```

## 3.2 Publication

```bash
# Tag GHCR (OWNER = user ou org GitHub)
docker tag myapp:1.0.0 ghcr.io/<OWNER>/myapp:1.0.0

# Push
docker push ghcr.io/<OWNER>/myapp:1.0.0
```

## 3.3 Consommation

```bash
# (Si privé) login
docker login ghcr.io -u <GITHUB_USERNAME>
# Pull
docker pull ghcr.io/<OWNER>/myapp:1.0.0
# Run
docker run --rm -p 8080:8080 ghcr.io/<OWNER>/myapp:1.0.0
```

---

# Nexus Repository Manager 3 (Docker hosted) — procédure la plus simple

Hypothèses : vous avez un **repository Docker “hosted”** configuré sur Nexus, accessible à l’adresse  
`nexus.example.com:5000` (port couramment utilisé pour Docker-hosted).  
(Vérifiez côté Nexus : activer *Docker Bearer Token Realm*, créer un repo “docker (hosted)”, définir le **port**.)

## 4.1 Connexion

```bash
# Username = compte Nexus autorisé (ex: deployer), Password = token/pwd Nexus
docker login nexus.example.com:5000 -u <NEXUS_USER>
# Password: <PASTE_NEXUS_TOKEN_OR_PASSWORD>
```

## 4.2 Publication

```bash
# Taguer pour votre registre Nexus
docker tag myapp:1.0.0 nexus.example.com:5000/myorg/myapp:1.0.0

# Push
docker push nexus.example.com:5000/myorg/myapp:1.0.0
```

## 4.3 Consommation

```bash
# (Si privé) login
docker login nexus.example.com:5000 -u <NEXUS_USER>
# Pull
docker pull nexus.example.com:5000/myorg/myapp:1.0.0
# Run
docker run --rm -p 8080:8080 nexus.example.com:5000/myorg/myapp:1.0.0
```

> 🔎 Si le port dédié Docker hosted est différent (ex. 8082), ajustez l’URL en conséquence.

---

# 5) Serveur web Nginx (distribution par archive .tar)

Ici on **ne pousse pas** dans un **registre**. On **publie** une **archive d’image** (`docker save`) sur un **serveur web Nginx**, et les consommateurs **téléchargent** puis **chargent** l’image (`docker load`).  
C’est pratique pour des environnements **déconnectés** ou **ultra-simples**.

## 5.1 Création de l’archive côté producteur

```bash
# Sauver l'image locale en archive tar
docker save myapp:1.0.0 -o myapp-1.0.0.tar

# Copier l'archive sur le serveur Nginx (ex: /usr/share/nginx/html/)
# Exemple avec scp :
scp myapp-1.0.0.tar user@nginx-host:/usr/share/nginx/html/
```

> Le fichier sera servi via `http://nginx-host/myapp-1.0.0.tar`

## 5.2 Consommation côté client

```bash
# Télécharger l’archive
curl -fSL -o myapp-1.0.0.tar http://nginx-host/myapp-1.0.0.tar

# Charger l'image dans Docker local
docker load -i myapp-1.0.0.tar

# Vérifier qu'elle est disponible
docker images | grep myapp

# Exécuter
docker run --rm -p 8080:8080 myapp:1.0.0
```

> ✅ Avantage : aucun registre requis.  
> ❗ Limite : pas de gestion de tags distants, pas d’auth/permissions intégrées comme un vrai registry.

---

### Astuces pro (optionnelles mais utiles)

- **Définir le nom complet dès le build** (économise un `docker tag`) :
  
  ```bash
  docker build -t ghcr.io/<OWNER>/myapp:1.0.0 .
  docker push ghcr.io/<OWNER>/myapp:1.0.0
  ```

- **Stocker proprement vos identifiants** : après `docker login`, Docker écrit un **token** dans `~/.docker/config.json`. Évitez de partager ce fichier.

- **Révoquer un token** (sécurité) : faites-le **sur la plateforme** (Docker Hub / GitLab / GitHub / Nexus) lorsque vous n’en avez plus besoin.

- **Nettoyer local** :
  
  ```bash
  docker image prune -f     # images dangling
  docker system prune -f    # attention: supprime aussi réseaux non utilisés, caches
  ```
